<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Build: AIMain.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_3179ea33d55a76dc38212d9eab798728.html">export</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e5664b4b56927c8728eb3192fa60e338.html">hdc2</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_1eb12a41a47efb9efcd82fa98f4f4dbd.html">FTP</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_80cc1f21a78ab7941088ea567f236150.html">ja2src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_994ab287602efefceafe55287a3657d6.html">Build</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_44103419c8ed76f1d39ea891be619902.html">TacticalAI</a></div>
<h1>AIMain.cpp</h1><a href="AIMain_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifdef PRECOMPILEDHEADERS</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">      #include "<a class="code" href="AI_01All_8h.html">AI All.h</a>"</span>
<a name="l00003"></a>00003 <span class="preprocessor">  #include "sound control.h"</span>
<a name="l00004"></a>00004 <span class="preprocessor">      #include "<a class="code" href="Debug_01Control_8h.html">Debug Control.h</a>"</span>
<a name="l00005"></a>00005 <span class="preprocessor">#else</span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor">      #include "wcheck.h"</span>
<a name="l00007"></a>00007 <span class="preprocessor">      #include "<a class="code" href="sgp_8h.html">sgp.h</a>"</span>
<a name="l00008"></a>00008 <span class="preprocessor">      #include "<a class="code" href="ai_8h.html">ai.h</a>"</span>
<a name="l00009"></a>00009 <span class="preprocessor">      #include "<a class="code" href="Isometric_01Utils_8h.html">Isometric Utils.h</a>"</span>
<a name="l00010"></a>00010 <span class="preprocessor">      #include "overhead.h"</span>
<a name="l00011"></a>00011 <span class="preprocessor">      #include "math.h"</span>
<a name="l00012"></a>00012 <span class="preprocessor">      #include "<a class="code" href="Event_01Pump_8h.html">Event Pump.h</a>"</span>
<a name="l00013"></a>00013 <span class="preprocessor">      #include "<a class="code" href="Overhead_01Types_8h.html">Overhead Types.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">      #include "sys globals.h"</span>
<a name="l00015"></a>00015 <span class="preprocessor">      #include "<a class="code" href="opplist_8h.html">opplist.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">      #include "animation control.h"</span>
<a name="l00017"></a>00017 <span class="preprocessor">      #include "font control.h"</span>
<a name="l00018"></a>00018 <span class="preprocessor">      #include "interface.h"</span>
<a name="l00019"></a>00019 <span class="preprocessor">      #include "<a class="code" href="screenids_8h.html">screenids.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">      #include "<a class="code" href="worldman_8h.html">worldman.h</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">      #include "pathai.h"</span>
<a name="l00022"></a>00022 <span class="preprocessor">      #include "points.h"</span>
<a name="l00023"></a>00023 <span class="preprocessor">      #include "weapons.h"</span>
<a name="l00024"></a>00024 <span class="preprocessor">      #include "items.h"</span>
<a name="l00025"></a>00025 <span class="preprocessor">      #include "<a class="code" href="Handle_01Items_8h.html">Handle Items.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">      #include "<a class="code" href="AIInternals_8h.html">AIInternals.h</a>"</span>
<a name="l00027"></a>00027 <span class="preprocessor">      #include "animation data.h"</span>
<a name="l00028"></a>00028 <span class="preprocessor">      #include "los.h"</span>
<a name="l00029"></a>00029 <span class="preprocessor">      #include "<a class="code" href="message_8h.html">message.h</a>"</span>
<a name="l00030"></a>00030 <span class="preprocessor">      #include "<a class="code" href="TeamTurns_8h.html">TeamTurns.h</a>"</span>
<a name="l00031"></a>00031 <span class="preprocessor">      #include "<a class="code" href="NPC_8h.html">NPC.h</a>"</span>
<a name="l00032"></a>00032 <span class="preprocessor">      #include "<a class="code" href="Dialogue_01Control_8h.html">Dialogue Control.h</a>"</span>
<a name="l00033"></a>00033 <span class="preprocessor">      #include "<a class="code" href="Soldier_01Profile_8h.html">Soldier Profile.h</a>"</span>
<a name="l00034"></a>00034 <span class="preprocessor">      #include "<a class="code" href="strategicmap_8h.html">strategicmap.h</a>"</span>
<a name="l00035"></a>00035 <span class="preprocessor">      #include "<a class="code" href="Tactical_01Save_8h.html">Tactical Save.h</a>"</span>
<a name="l00036"></a>00036 <span class="preprocessor">      #include "<a class="code" href="Soldier_01Create_8h.html">Soldier Create.h</a>"</span>
<a name="l00037"></a>00037 <span class="preprocessor">      #include "<a class="code" href="Explosion_01Control_8h.html">Explosion Control.h</a>"</span>
<a name="l00038"></a>00038 <span class="preprocessor">      #include "<a class="code" href="Interactive_01Tiles_8h.html">Interactive Tiles.h</a>"</span>
<a name="l00039"></a>00039 <span class="preprocessor">      #include "interface dialogue.h"</span>
<a name="l00040"></a>00040 <span class="preprocessor">      #include "<a class="code" href="Vehicles_8h.html">Vehicles.h</a>"</span>
<a name="l00041"></a>00041 <span class="preprocessor">      #include "<a class="code" href="renderworld_8h.html">renderworld.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">      #include "<a class="code" href="AIList_8h.html">AIList.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#endif</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a>00045 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="Overhead_8cpp.html#07ee8f5d04f5e3183ee5fa90526caffb">PauseAITemporarily</a>( <span class="keywordtype">void</span> );
<a name="l00046"></a>00046 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="Interface_8cpp.html#7f99a29ee0b61ef3341ea9696af75147">UpdateEnemyUIBar</a>( <span class="keywordtype">void</span> );
<a name="l00047"></a>00047 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="TeamTurns_8cpp.html#02da951e111db983c8215f4c726bdc65">DisplayHiddenTurnbased</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * pActingSoldier );
<a name="l00048"></a>00048 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="Soldier_01Control_8cpp.html#11fd19e17adc39731d2b3688a028a833">AdjustNoAPToFinishMove</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fSet );
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="keywordtype">void</span> <a class="code" href="AIMain_8cpp.html#b74f0a00fbbdbb3d888d7ad7f5a65466">TurnBasedHandleNPCAI</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l00051"></a>00051 <span class="keywordtype">void</span> <a class="code" href="AIMain_8cpp.html#b8b92563a3ad0716fede67c6bdae2c13">HandleAITacticalTraversal</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> <a class="code" href="AIMain_8cpp.html#bcdbe0cbaa0cf51dc6d31a595e9540f0">gubElementsOnExplosionQueue</a>;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Dialogue_01Control_8cpp.html#8b16a3303a3401e6f2a48f5652258ee7">gfWaitingForTriggerTimer</a>;
<a name="l00056"></a>00056 
<a name="l00057"></a><a class="code" href="FindLocations_8cpp.html#fb230b373eb74a81318db04b75477535">00057</a> <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> <a class="code" href="Overhead_8cpp.html#fb230b373eb74a81318db04b75477535">gubAICounter</a>;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">//</span>
<a name="l00060"></a>00060 <span class="comment">// Commented out/ to fix:</span>
<a name="l00061"></a>00061 <span class="comment">// lots of other stuff, I think</span>
<a name="l00062"></a>00062 <span class="comment">//</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="comment">//extern UINT8 gubDeadLockDelay;</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="comment">//#define DEADLOCK_DELAY                                          10000 //Madd - let's see what this does -- orig: 15000</span>
<a name="l00067"></a>00067 <span class="comment">//#define DEADLOCK_DELAY                                          ( gGameExternalOptions.gubDeadLockDelay * 1000 )</span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment">// Very representing if this computer is the host, therefore controlling the ai</span>
<a name="l00070"></a>00070 <span class="keyword">extern</span>      <a class="code" href="DbMan_8h.html#7f198a4ec02dba18942d78b7bc065e06">BYTE</a>              <a class="code" href="Overhead_8cpp.html#18804ce8d998e9748d7518f42669d7a2">gfAmIHost</a>;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="comment">//#define TESTAI</span>
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="AIMain_8cpp.html#f83ddc1e6fe6885e39eff2192a9bb4a0">00074</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="AIInternals_8h.html#f83ddc1e6fe6885e39eff2192a9bb4a0">GameOption</a>[MAXGAMEOPTIONS] = {0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0};
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="preprocessor">#define AI_LIMIT_PER_UPDATE         1</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>
<a name="l00078"></a><a class="code" href="FindLocations_8cpp.html#25c5537230a9ec6af357c7e3ddadb97b">00078</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>;
<a name="l00079"></a>00079 
<a name="l00080"></a><a class="code" href="AIMain_8cpp.html#71440b56c1b498cae809e64152b7d65e">00080</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="ai_8h.html#71440b56c1b498cae809e64152b7d65e">gbDiff</a>[MAX_DIFF_PARMS][5] =
<a name="l00081"></a>00081  {
<a name="l00082"></a>00082   <span class="comment">//       AI DIFFICULTY SETTING</span>
<a name="l00083"></a>00083   <span class="comment">// WIMPY  EASY  NORMAL  TOUGH  ELITE</span>
<a name="l00084"></a>00084    {  -20,  -10,     0,    10,     20  },     <span class="comment">// DIFF_ENEMY_EQUIP_MOD</span>
<a name="l00085"></a>00085    {  -10,   -5,     0,     5,     10  },     <span class="comment">// DIFF_ENEMY_TO_HIT_MOD</span>
<a name="l00086"></a>00086    {   -2,   -1,     0,     1,      2  },     <span class="comment">// DIFF_ENEMY_INTERRUPT_MOD</span>
<a name="l00087"></a>00087    {   50,   65,    80,    90,     95  },     <span class="comment">// DIFF_RADIO_RED_ALERT</span>
<a name="l00088"></a>00088    {    4,    6,     8,    10,     13  }      <span class="comment">// DIFF_MAX_COVER_RANGE</span>
<a name="l00089"></a>00089  };
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00095"></a>00095 
<a name="l00096"></a><a class="code" href="AIMain_8cpp.html#67640c28ffcaa1eb59c6780ea4bb2e23">00096</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( <a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a> szOutput )
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span>      <span class="comment">// Send regular debug msg AND AI debug message</span>
<a name="l00100"></a>00100       FILE *            DebugFile;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102       DebugMsg( <a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>, DBG_LEVEL_3, szOutput );   
<a name="l00103"></a>00103       <span class="keywordflow">if</span> ((DebugFile = fopen( <span class="stringliteral">"aidebug.txt"</span>, <span class="stringliteral">"a+t"</span> )) != NULL)
<a name="l00104"></a>00104       {
<a name="l00105"></a>00105             fputs( reinterpret_cast&lt;const char *&gt;(szOutput), DebugFile );
<a name="l00106"></a>00106             fputs( <span class="stringliteral">"\n"</span>, DebugFile );
<a name="l00107"></a>00107             fclose( DebugFile );
<a name="l00108"></a>00108       }
<a name="l00109"></a>00109 <span class="preprocessor">#endif</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span>}
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="AIMain_8cpp.html#31867621a2778451e1dd099c3f7c5702">00113</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="ai_8h.html#31867621a2778451e1dd099c3f7c5702">InitAI</a>( <span class="keywordtype">void</span> )
<a name="l00114"></a>00114 {
<a name="l00115"></a>00115 <span class="preprocessor">#ifdef JA2TESTVERSION</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>      FILE *            DebugFile;
<a name="l00117"></a>00117 <span class="preprocessor">#endif</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span>
<a name="l00119"></a>00119 <span class="preprocessor">#ifdef _DEBUG</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="PATHAI_8cpp.html#727bdb0c03d1013085970be1a0b41aed">gfDisplayCoverValues</a>)
<a name="l00121"></a>00121       {
<a name="l00122"></a>00122             memset( <a class="code" href="PATHAI_8cpp.html#35d66289719d16da61ee6a2b67dc76e6">gsCoverValue</a>, 0x7F, <span class="keyword">sizeof</span>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> ) * WORLD_MAX );
<a name="l00123"></a>00123       }
<a name="l00124"></a>00124 <span class="preprocessor">#endif</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span>
<a name="l00126"></a>00126       <span class="comment">//If we are not loading a saved game ( if we are, this has already been called )</span>
<a name="l00127"></a>00127       <span class="keywordflow">if</span>( !( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; LOADING_SAVED_GAME ) )
<a name="l00128"></a>00128       {
<a name="l00129"></a>00129             <span class="comment">//init the panic system</span>
<a name="l00130"></a>00130             <a class="code" href="ai_8h.html#24424e3b30cd6974adf2732122e8128a">InitPanicSystem</a>();
<a name="l00131"></a>00131       }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="preprocessor">#ifdef JA2TESTVERSION</span>
<a name="l00134"></a>00134 <span class="preprocessor"></span>      <span class="comment">// Clear the AI debug txt file to prevent it from getting huge</span>
<a name="l00135"></a>00135       <span class="keywordflow">if</span> ((DebugFile = fopen( <span class="stringliteral">"aidebug.txt"</span>, <span class="stringliteral">"w"</span> )) != NULL)
<a name="l00136"></a>00136       {
<a name="l00137"></a>00137             fputs( <span class="stringliteral">"\n"</span>, DebugFile );
<a name="l00138"></a>00138             fclose( DebugFile );
<a name="l00139"></a>00139       }
<a name="l00140"></a>00140 <span class="preprocessor">#endif</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>
<a name="l00142"></a>00142       <span class="keywordflow">return</span>( TRUE );
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 
<a name="l00147"></a><a class="code" href="AIMain_8cpp.html#69a199d83bedd1ae4b00152576c0aa4a">00147</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="AIInternals_8h.html#69a199d83bedd1ae4b00152576c0aa4a">AimingGun</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149       <span class="keywordflow">return</span>(FALSE);
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 
<a name="l00152"></a><a class="code" href="AIMain_8cpp.html#fd4213631456d830bf92aeec9ba05103">00152</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#fd4213631456d830bf92aeec9ba05103">HandleSoldierAI</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00153"></a>00153 {
<a name="l00154"></a>00154       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiCurrTime = GetJA2Clock();
<a name="l00155"></a>00155 
<a name="l00156"></a>00156       <span class="comment">// ATE</span>
<a name="l00157"></a>00157       <span class="comment">// Bail if we are engaged in a NPC conversation/ and/or sequence ... or we have a pause because </span>
<a name="l00158"></a>00158       <span class="comment">// we just saw someone... or if there are bombs on the bomb queue</span>
<a name="l00159"></a>00159       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_ENGAGEDINACTION || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#227f41b02d7f76a01fa264b7b40347d1">fEnemySightingOnTheirTurn</a> || (<a class="code" href="AIMain_8cpp.html#bcdbe0cbaa0cf51dc6d31a595e9540f0">gubElementsOnExplosionQueue</a> != 0) )
<a name="l00160"></a>00160       {
<a name="l00161"></a>00161             <span class="keywordflow">return</span>;
<a name="l00162"></a>00162       }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164   <span class="keywordflow">if</span> ( <a class="code" href="Explosion_01Control_8cpp.html#67101a9b64da3506404fc64aed28c910">gfExplosionQueueActive</a> )
<a name="l00165"></a>00165   {
<a name="l00166"></a>00166     <span class="keywordflow">return</span>;
<a name="l00167"></a>00167   }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_PC)
<a name="l00170"></a>00170       {
<a name="l00171"></a>00171             <span class="comment">// if we're in autobandage, or the AI control flag is set and the player has a quote record to perform, or is a boxer,</span>
<a name="l00172"></a>00172             <span class="comment">// let AI process this merc; otherwise abort</span>
<a name="l00173"></a>00173             <span class="keywordflow">if</span> ( !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#1aa7fa93044da366b9072c35e0a9b297">fAutoBandageMode</a>) &amp;&amp; !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_PCUNDERAICONTROL &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#30114897a2229659bda75e47c604b742">ubQuoteRecord</a> != 0 || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_BOXER) ) )
<a name="l00174"></a>00174             {
<a name="l00175"></a>00175                   <span class="comment">// patch...</span>
<a name="l00176"></a>00176                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp; AI_HANDLE_EVERY_FRAME )
<a name="l00177"></a>00177                   {
<a name="l00178"></a>00178                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp;= ~AI_HANDLE_EVERY_FRAME;
<a name="l00179"></a>00179                   }
<a name="l00180"></a>00180                   <span class="keywordflow">return</span>;
<a name="l00181"></a>00181             }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183       }
<a name="l00184"></a>00184       <span class="comment">/*</span>
<a name="l00185"></a>00185 <span class="comment">      else</span>
<a name="l00186"></a>00186 <span class="comment">      {           </span>
<a name="l00187"></a>00187 <span class="comment">            // AI is run on all PCs except the one who is selected</span>
<a name="l00188"></a>00188 <span class="comment">            if (pSoldier-&gt;uiStatusFlags &amp; SOLDIER_PC )</span>
<a name="l00189"></a>00189 <span class="comment">            {</span>
<a name="l00190"></a>00190 <span class="comment">                  // if this soldier is "selected" then only let user give orders!</span>
<a name="l00191"></a>00191 <span class="comment">                  if ((pSoldier-&gt;ubID == gusSelectedSoldier) &amp;&amp; !(gTacticalStatus.uiFlags &amp; DEMOMODE))</span>
<a name="l00192"></a>00192 <span class="comment">                  {</span>
<a name="l00193"></a>00193 <span class="comment">                        return;</span>
<a name="l00194"></a>00194 <span class="comment">                  }</span>
<a name="l00195"></a>00195 <span class="comment">            }</span>
<a name="l00196"></a>00196 <span class="comment">      }</span>
<a name="l00197"></a>00197 <span class="comment">      */</span>
<a name="l00198"></a>00198 
<a name="l00199"></a>00199       <span class="comment">// determine what sort of AI to use</span>
<a name="l00200"></a>00200       <span class="keywordflow">if</span> ( (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; TURNBASED) &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) )
<a name="l00201"></a>00201       {
<a name="l00202"></a>00202             <a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> = TRUE;
<a name="l00203"></a>00203       }
<a name="l00204"></a>00204       <span class="keywordflow">else</span>
<a name="l00205"></a>00205       {
<a name="l00206"></a>00206             <a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> = FALSE;
<a name="l00207"></a>00207       }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209       <span class="comment">// If TURN BASED and NOT NPC's turn, or realtime and not our chance to think, bail...</span>
<a name="l00210"></a>00210       <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00211"></a>00211       {
<a name="l00212"></a>00212             <span class="keywordflow">if</span> ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != OUR_TEAM) &amp;&amp; <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#d4322ac2c70a18b5aa84c2041e08c9b1">ubCurrentTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> )
<a name="l00213"></a>00213             {
<a name="l00214"></a>00214                   <span class="keywordflow">return</span>;
<a name="l00215"></a>00215             }
<a name="l00216"></a>00216             <span class="comment">// why do we let the quote record thing be in here?  we're in turnbased the quote record doesn't matter,</span>
<a name="l00217"></a>00217             <span class="comment">// we can't act out of turn!</span>
<a name="l00218"></a>00218             <span class="keywordflow">if</span> ( !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_UNDERAICONTROL) )
<a name="l00219"></a>00219             <span class="comment">//if ( !(pSoldier-&gt;uiStatusFlags &amp; SOLDIER_UNDERAICONTROL) &amp;&amp; (pSoldier-&gt;ubQuoteRecord == 0))</span>
<a name="l00220"></a>00220             {
<a name="l00221"></a>00221                   <span class="keywordflow">return</span>;
<a name="l00222"></a>00222             }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#d4322ac2c70a18b5aa84c2041e08c9b1">ubCurrentTeam</a> )
<a name="l00225"></a>00225             {
<a name="l00226"></a>00226 <span class="preprocessor">                  #ifdef JA2BETAVERSION</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span>                        <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_ERROR, L<span class="stringliteral">"Turning off AI flag for %d because trying to act out of turn"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l00228"></a>00228 <span class="preprocessor">                  #endif</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>                  <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp;= ~SOLDIER_UNDERAICONTROL;
<a name="l00230"></a>00230                   <span class="keywordflow">return</span>;
<a name="l00231"></a>00231             }
<a name="l00232"></a>00232             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#3f58b0f6efbd23c543ea12258a2f9ef3">bMoved</a> )
<a name="l00233"></a>00233             {
<a name="l00234"></a>00234 <span class="preprocessor">                  #ifdef TESTAICONTROL</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00236"></a>00236                         {
<a name="l00237"></a>00237                               <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because set to moved"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00238"></a>00238                         }
<a name="l00239"></a>00239 <span class="preprocessor">                  #endif</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span>                  <span class="comment">// this guy doesn't get to act!</span>
<a name="l00241"></a>00241                   <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00242"></a>00242                   <span class="keywordflow">return</span>;
<a name="l00243"></a>00243             }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245       }
<a name="l00246"></a>00246       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp; AI_HANDLE_EVERY_FRAME) ) <span class="comment">// if set to handle every frame, ignore delay!</span>
<a name="l00247"></a>00247       {
<a name="l00248"></a>00248       <span class="comment">//#ifndef AI_PROFILING</span>
<a name="l00249"></a>00249             <span class="comment">//Time to handle guys in realtime (either combat or not )</span>
<a name="l00250"></a>00250             <span class="keywordflow">if</span> ( !TIMECOUNTERDONE( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#67be2d37d159d78626d798f77351b8f5">AICounter</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#ec9d29da5d42b79d53721abd28e6583a">uiAIDelay</a> ) )
<a name="l00251"></a>00251             {
<a name="l00252"></a>00252                   <span class="comment">// CAMFIELD, LOOK HERE!</span>
<a name="l00253"></a>00253                   <span class="keywordflow">return</span>;
<a name="l00254"></a>00254             }
<a name="l00255"></a>00255             <span class="keywordflow">else</span>
<a name="l00256"></a>00256             {
<a name="l00257"></a>00257                   <span class="comment">//Reset counter!</span>
<a name="l00258"></a>00258                   RESETTIMECOUNTER( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#67be2d37d159d78626d798f77351b8f5">AICounter</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#ec9d29da5d42b79d53721abd28e6583a">uiAIDelay</a> );
<a name="l00259"></a>00259             <span class="comment">//DebugMsg( TOPIC_JA2, DBG_LEVEL_0, String( "%s waiting %d from %d", pSoldier-&gt;name, pSoldier-&gt;AICounter, uiCurrTime ) );</span>
<a name="l00260"></a>00260             }
<a name="l00261"></a>00261             <span class="comment">//#endif</span>
<a name="l00262"></a>00262       }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp; AI_HANDLE_EVERY_FRAME ) <span class="comment">// if set to handle every frame, ignore delay!</span>
<a name="l00265"></a>00265       {
<a name="l00266"></a>00266             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> != <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831efea629a205d096e73d539fa987a4ec77f">QUOTE_ACTION_ID_TURNTOWARDSPLAYER</a>)
<a name="l00267"></a>00267             {
<a name="l00268"></a>00268                   <span class="comment">// turn off flag!</span>
<a name="l00269"></a>00269                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp;= (~AI_HANDLE_EVERY_FRAME);
<a name="l00270"></a>00270             }
<a name="l00271"></a>00271       }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273       <span class="comment">// if this NPC is getting hit, abort</span>
<a name="l00274"></a>00274       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d20eefbafd8613a5772ddb8eb384fc71">fGettingHit</a>)
<a name="l00275"></a>00275       {
<a name="l00276"></a>00276             <span class="keywordflow">return</span>;     
<a name="l00277"></a>00277       }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279       <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#32021b7251048d8c62ea0c2e26b7a021">bBoxingState</a> == <a class="code" href="Overhead_01Types_8h.html#60ed5bd8e4835b98d48cf7afb819b4e55fac2cdafaeb730644fb13980a1fa22c">PRE_BOXING</a> || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#32021b7251048d8c62ea0c2e26b7a021">bBoxingState</a> == <a class="code" href="Overhead_01Types_8h.html#60ed5bd8e4835b98d48cf7afb819b4e57afcbf140adcf1ab9068be7ec414b3b1">BOXING</a> || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#32021b7251048d8c62ea0c2e26b7a021">bBoxingState</a> == <a class="code" href="Overhead_01Types_8h.html#60ed5bd8e4835b98d48cf7afb819b4e56fe9c7948d3b1a13d422f7c49b7b4d76">WON_ROUND</a> || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#32021b7251048d8c62ea0c2e26b7a021">bBoxingState</a> == <a class="code" href="Overhead_01Types_8h.html#60ed5bd8e4835b98d48cf7afb819b4e5e1a5b31aec8340458acd3ae62d223850">LOST_ROUND</a> )
<a name="l00280"></a>00280       {
<a name="l00281"></a>00281             <span class="keywordflow">if</span> ( ! ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_BOXER ) )
<a name="l00282"></a>00282             {
<a name="l00283"></a>00283                   <span class="comment">// do nothing!</span>
<a name="l00284"></a>00284 <span class="preprocessor">                  #ifdef TESTAICONTROL</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00286"></a>00286                         {
<a name="l00287"></a>00287                               <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because not a boxer"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00288"></a>00288                         }
<a name="l00289"></a>00289 <span class="preprocessor">                  #endif</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span>                  <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00291"></a>00291                   <span class="keywordflow">return</span>;
<a name="l00292"></a>00292             }
<a name="l00293"></a>00293       }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295       <span class="comment">// if this NPC is dying, bail</span>
<a name="l00296"></a>00296       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a> &lt; OKLIFE || !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#653dad4e2520784e293eca9f948b8532">bActive</a> )
<a name="l00297"></a>00297       {
<a name="l00298"></a>00298             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#653dad4e2520784e293eca9f948b8532">bActive</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e39bbecc66c2b6b8df1ef4d98ed6feab">fMuzzleFlash</a> )
<a name="l00299"></a>00299             {
<a name="l00300"></a>00300                   <a class="code" href="opplist_8cpp.html#99fca0847f39df3a86cbab0974c4bb24">EndMuzzleFlash</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00301"></a>00301             }
<a name="l00302"></a>00302 <span class="preprocessor">            #ifdef TESTAICONTROL</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00304"></a>00304                   {
<a name="l00305"></a>00305                         <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because bad life/inactive"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00306"></a>00306                   }
<a name="l00307"></a>00307 <span class="preprocessor">            #endif</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span>            
<a name="l00309"></a>00309             <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00310"></a>00310             <span class="keywordflow">return</span>;
<a name="l00311"></a>00311       }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp; AI_ASLEEP )
<a name="l00314"></a>00314       {
<a name="l00315"></a>00315             <span class="keywordflow">if</span> ( <a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#73246323764393ce2a5ece7fcb7b7cf8">bVisible</a> )
<a name="l00316"></a>00316             {
<a name="l00317"></a>00317                   <span class="comment">// turn off sleep flag, guy's got to be able to do stuff in turnbased</span>
<a name="l00318"></a>00318                   <span class="comment">// if he's visible</span>
<a name="l00319"></a>00319                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp;= ~AI_ASLEEP;
<a name="l00320"></a>00320             }
<a name="l00321"></a>00321             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp; AI_CHECK_SCHEDULE) )
<a name="l00322"></a>00322             {
<a name="l00323"></a>00323                   <span class="comment">// don't do anything!</span>
<a name="l00324"></a>00324 <span class="preprocessor">                  #ifdef TESTAICONTROL</span>
<a name="l00325"></a>00325 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00326"></a>00326                         {
<a name="l00327"></a>00327                               <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because asleep and no scheduled action"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00328"></a>00328                         }
<a name="l00329"></a>00329 <span class="preprocessor">                  #endif</span>
<a name="l00330"></a>00330 <span class="preprocessor"></span>
<a name="l00331"></a>00331                   <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00332"></a>00332                   <span class="keywordflow">return</span>;
<a name="l00333"></a>00333             }
<a name="l00334"></a>00334       }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b0096f321a0de4f0617283f7b3212aa0">bInSector</a> == FALSE &amp;&amp; !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp; AI_CHECK_SCHEDULE) )
<a name="l00337"></a>00337       {
<a name="l00338"></a>00338             <span class="comment">// don't do anything!</span>
<a name="l00339"></a>00339 <span class="preprocessor">            #ifdef TESTAICONTROL</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00341"></a>00341                   {
<a name="l00342"></a>00342                         <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because out of sector and no scheduled action"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00343"></a>00343                   }
<a name="l00344"></a>00344 <span class="preprocessor">            #endif</span>
<a name="l00345"></a>00345 <span class="preprocessor"></span>
<a name="l00346"></a>00346             <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00347"></a>00347             <span class="keywordflow">return</span>;
<a name="l00348"></a>00348       }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350       <span class="keywordflow">if</span> ( ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_VEHICLE) &amp;&amp; !TANK( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) ) || AM_A_ROBOT( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l00351"></a>00351       {
<a name="l00352"></a>00352             <span class="comment">// bail out!</span>
<a name="l00353"></a>00353 <span class="preprocessor">            #ifdef TESTAICONTROL</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00355"></a>00355                   {
<a name="l00356"></a>00356                         <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because is vehicle or robot"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00357"></a>00357                   }
<a name="l00358"></a>00358 <span class="preprocessor">            #endif</span>
<a name="l00359"></a>00359 <span class="preprocessor"></span>
<a name="l00360"></a>00360             <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00361"></a>00361             <span class="keywordflow">return</span>;
<a name="l00362"></a>00362       }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e7deba64e58676518e5d31bb7657da01">bCollapsed</a>)
<a name="l00365"></a>00365       {
<a name="l00366"></a>00366             <span class="comment">// being handled so turn off muzzle flash</span>
<a name="l00367"></a>00367             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e39bbecc66c2b6b8df1ef4d98ed6feab">fMuzzleFlash</a> )
<a name="l00368"></a>00368             {
<a name="l00369"></a>00369                   <a class="code" href="opplist_8cpp.html#99fca0847f39df3a86cbab0974c4bb24">EndMuzzleFlash</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00370"></a>00370             }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 <span class="preprocessor">            #ifdef TESTAICONTROL</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00374"></a>00374                   {
<a name="l00375"></a>00375                         <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because unconscious"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00376"></a>00376                   }
<a name="l00377"></a>00377 <span class="preprocessor">            #endif</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span>
<a name="l00379"></a>00379             <span class="comment">// stunned/collapsed!</span>
<a name="l00380"></a>00380             <a class="code" href="ai_8h.html#6cced4c42ca3081db5b89f6a584e549f">CancelAIAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, FORCE );
<a name="l00381"></a>00381             <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00382"></a>00382             <span class="keywordflow">return</span>;
<a name="l00383"></a>00383       }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385       <span class="comment">// in the unlikely situation (Sgt Krott et al) that we have a quote trigger going on</span>
<a name="l00386"></a>00386       <span class="comment">// during turnbased, don't do any AI</span>
<a name="l00387"></a>00387       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1af0a0823fd8811b3ab96c24988f08eed">SERGEANT</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1cd6fa1414157427517c57868ba12741d">MIKE</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa192316e5a46397f20e0a7d967488a290a">JOE</a>) &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) &amp;&amp; (<a class="code" href="Interface_01Dialogue_8cpp.html#b341ced3aaefe419e0cc1e62711da1de">gfInTalkPanel</a> || <a class="code" href="Dialogue_01Control_8cpp.html#8b16a3303a3401e6f2a48f5652258ee7">gfWaitingForTriggerTimer</a> || !<a class="code" href="Dialogue_01Control_8cpp.html#2894d563f5d3d56a3debfaeb1e7c8878">DialogueQueueIsEmpty</a>() ) )
<a name="l00388"></a>00388       {
<a name="l00389"></a>00389             <span class="keywordflow">return</span>;
<a name="l00390"></a>00390       }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392       <span class="comment">// ATE: Did some changes here </span>
<a name="l00393"></a>00393       <span class="comment">// DON'T rethink if we are determined to get somewhere....</span>
<a name="l00394"></a>00394       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1897f6330181ea58e948eaa23a5fd75c">bNewSituation</a> == IS_NEW_SITUATION )
<a name="l00395"></a>00395       {
<a name="l00396"></a>00396             <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fProcessNewSituation;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398             <span class="comment">// if this happens during an attack then do nothing... wait for the A.B.C.</span>
<a name="l00399"></a>00399             <span class="comment">// to be reduced to 0 first -- CJC December 13th</span>
<a name="l00400"></a>00400             <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a> &gt; 0 )
<a name="l00401"></a>00401             {
<a name="l00402"></a>00402                   fProcessNewSituation = FALSE;
<a name="l00403"></a>00403                   <span class="comment">// HACK!!</span>
<a name="l00404"></a>00404                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6247fbdbad71e877e20dc79b610060b8">AI_ACTION_FIRE_GUN</a> )
<a name="l00405"></a>00405                   {
<a name="l00406"></a>00406                         <span class="keywordflow">if</span> ( <a class="code" href="bullets_8cpp.html#7f3a192faf5f9ad5c12748e36d6db8b5">guiNumBullets</a> == 0 )
<a name="l00407"></a>00407                         {
<a name="l00408"></a>00408                               <span class="comment">// abort attack!</span>
<a name="l00409"></a>00409                               <span class="comment">//DebugMsg( TOPIC_JA2, DBG_LEVEL_3, String("&gt;&gt;&gt;&gt;&gt;&gt; Attack busy count lobotomized due to new situation for %d", pSoldier-&gt;ubID ) );</span>
<a name="l00410"></a>00410                               <span class="comment">//gTacticalStatus.ubAttackBusyCount = 0;</span>
<a name="l00411"></a>00411                               fProcessNewSituation = TRUE;
<a name="l00412"></a>00412                         }
<a name="l00413"></a>00413                   }
<a name="l00414"></a>00414                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b260e54a79dd8e6db573a8216c3a63efc">AI_ACTION_TOSS_PROJECTILE</a> )
<a name="l00415"></a>00415                   {
<a name="l00416"></a>00416                         <span class="keywordflow">if</span> ( <a class="code" href="physics_8cpp.html#f3de8c3073334468c0e9c214c8dc078e">guiNumObjectSlots</a> == 0 )
<a name="l00417"></a>00417                         {
<a name="l00418"></a>00418                               <span class="comment">// abort attack!</span>
<a name="l00419"></a>00419                               DebugMsg( <a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>, DBG_LEVEL_3, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"&gt;&gt;&gt;&gt;&gt;&gt; Attack busy count lobotomized due to new situation for %d"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00420"></a>00420                               <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a> = 0;
<a name="l00421"></a>00421                               fProcessNewSituation = TRUE;
<a name="l00422"></a>00422                         }
<a name="l00423"></a>00423                   }
<a name="l00424"></a>00424             }           
<a name="l00425"></a>00425             <span class="keywordflow">else</span>
<a name="l00426"></a>00426             {
<a name="l00427"></a>00427                   fProcessNewSituation = TRUE;
<a name="l00428"></a>00428             }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430             <span class="keywordflow">if</span> ( fProcessNewSituation )
<a name="l00431"></a>00431             {
<a name="l00432"></a>00432                   <span class="keywordflow">if</span> ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_UNDERAICONTROL) &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> &gt;= <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831efe48f9c2ccb282afc7ed0f779fe67c4b1">QUOTE_ACTION_ID_TRAVERSE_EAST</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> &lt;= <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831ef0c9f3f8fb8f374c02f97081c2caa71c7">QUOTE_ACTION_ID_TRAVERSE_NORTH</a> &amp;&amp; !<a class="code" href="Isometric_01Utils_8cpp.html#d847f316e46ad7cba6d1e7f2d103e56e">GridNoOnVisibleWorldTile</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ) )
<a name="l00433"></a>00433                   {
<a name="l00434"></a>00434                         <span class="comment">// traversing offmap, ignore new situations</span>
<a name="l00435"></a>00435                   }
<a name="l00436"></a>00436                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#30114897a2229659bda75e47c604b742">ubQuoteRecord</a> == 0 &amp;&amp; !<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#1aa7fa93044da366b9072c35e0a9b297">fAutoBandageMode</a>  )
<a name="l00437"></a>00437                   {
<a name="l00438"></a>00438                         <span class="comment">// don't force, don't want escorted mercs reacting to new opponents, etc.</span>
<a name="l00439"></a>00439                         <span class="comment">// now we don't have AI controlled escorted mercs though - CJC</span>
<a name="l00440"></a>00440                         <a class="code" href="ai_8h.html#6cced4c42ca3081db5b89f6a584e549f">CancelAIAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, FORCE );
<a name="l00441"></a>00441                         <span class="comment">// zap any next action too</span>
<a name="l00442"></a>00442                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b476d7b194a22733be5841a8af2ccde4d">AI_ACTION_END_COWER_AND_MOVE</a> )
<a name="l00443"></a>00443                         {
<a name="l00444"></a>00444                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l00445"></a>00445                         }
<a name="l00446"></a>00446                         <a class="code" href="AIInternals_8h.html#deb4b27c776d12c422d88811706807fe">DecideAlertStatus</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00447"></a>00447                   }
<a name="l00448"></a>00448                   <span class="keywordflow">else</span> 
<a name="l00449"></a>00449                   {
<a name="l00450"></a>00450                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#30114897a2229659bda75e47c604b742">ubQuoteRecord</a> )
<a name="l00451"></a>00451                         {
<a name="l00452"></a>00452                               <span class="comment">// make sure we're not using combat AI</span>
<a name="l00453"></a>00453                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532f91de342fc2584dd731cfe5d47271c6">STATUS_GREEN</a>;
<a name="l00454"></a>00454                         }
<a name="l00455"></a>00455                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1897f6330181ea58e948eaa23a5fd75c">bNewSituation</a> = WAS_NEW_SITUATION;
<a name="l00456"></a>00456                   }
<a name="l00457"></a>00457             }
<a name="l00458"></a>00458       }
<a name="l00459"></a>00459       <span class="keywordflow">else</span>
<a name="l00460"></a>00460       {
<a name="l00461"></a>00461             <span class="comment">// might have been in 'was' state; no longer so...</span>
<a name="l00462"></a>00462             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1897f6330181ea58e948eaa23a5fd75c">bNewSituation</a> = NOT_NEW_SITUATION;
<a name="l00463"></a>00463       }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465 <span class="preprocessor">#ifdef TESTAI</span>
<a name="l00466"></a>00466 <span class="preprocessor"></span>            DebugMsg( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>, DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>( <span class="stringliteral">".... HANDLING AI FOR %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>));
<a name="l00467"></a>00467 <span class="preprocessor">#endif</span>
<a name="l00468"></a>00468 <span class="preprocessor"></span>
<a name="l00469"></a>00469 <span class="comment">/*********</span>
<a name="l00470"></a>00470 <span class="comment">      Start of new overall AI system</span>
<a name="l00471"></a>00471 <span class="comment">      ********/</span>
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 
<a name="l00475"></a>00475       <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00476"></a>00476       {
<a name="l00477"></a>00477             <span class="keywordflow">if</span> ( ( GetJA2Clock() - <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#a1b7eae915048f8deb7376f3ea5bc920">uiTimeSinceMercAIStart</a>     ) &gt; ( (<a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)<a class="code" href="GameSettings_8cpp.html#5c32f930e2fef384505c4b91803a92c2">gGameExternalOptions</a>.<a class="code" href="structGAME__EXTERNAL__OPTIONS.html#8341a2dedd537862c4cbfbccf4f9f690">gubDeadLockDelay</a> * 1000 ) &amp;&amp; !<a class="code" href="Handle_01UI_8cpp.html#99598dfb258d41f5162c1bbe02fd48f0">gfUIInDeadlock</a> )
<a name="l00478"></a>00478             {
<a name="l00479"></a>00479       <span class="comment">// ATE: Display message that deadlock occured...</span>
<a name="l00480"></a>00480       <a class="code" href="Debug_01Control_8cpp.html#a9ab39dd73454c08d01450558f6ac523">LiveMessage</a>( <span class="stringliteral">"Breaking Deadlock"</span> );
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="preprocessor">#ifdef JA2TESTVERSION         </span>
<a name="l00483"></a>00483 <span class="preprocessor"></span>                  <span class="comment">// display deadlock message</span>
<a name="l00484"></a>00484                   <a class="code" href="Handle_01UI_8cpp.html#99598dfb258d41f5162c1bbe02fd48f0">gfUIInDeadlock</a> = TRUE;
<a name="l00485"></a>00485                   <a class="code" href="Handle_01UI_8cpp.html#19b8bd563b7d783ddd502457a5e08ff8">gUIDeadlockedSoldier</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>;
<a name="l00486"></a>00486                   <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>) <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DEADLOCK soldier %d action %s ABC %d"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>, <a class="code" href="Overhead_8cpp.html#bdcb5e390c584c20a06add9797073d71">gzActionStr</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a>], <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a> ) );
<a name="l00487"></a>00487 <span class="preprocessor">#else</span>
<a name="l00488"></a>00488 <span class="preprocessor"></span>
<a name="l00489"></a>00489                   <span class="comment">// If we are in beta version, also report message!</span>
<a name="l00490"></a>00490 <span class="preprocessor">#ifdef JA2BETAVERSION</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span>                  <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_ERROR, L<span class="stringliteral">"Aborting AI deadlock for %d. Please sent DEBUG.TXT file and SAVE."</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l00492"></a>00492 <span class="preprocessor">#endif</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span>                  <span class="comment">// just abort</span>
<a name="l00494"></a>00494                   <a class="code" href="ai_8h.html#624d598a02eae414c8811207d28166bc">EndAIDeadlock</a>();
<a name="l00495"></a>00495                   <span class="keywordflow">if</span> ( !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_UNDERAICONTROL) )
<a name="l00496"></a>00496                   {
<a name="l00497"></a>00497                         <span class="keywordflow">return</span>;
<a name="l00498"></a>00498                   }
<a name="l00499"></a>00499 <span class="preprocessor">#endif</span>
<a name="l00500"></a>00500 <span class="preprocessor"></span>            }
<a name="l00501"></a>00501       }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>)
<a name="l00504"></a>00504       { 
<a name="l00505"></a>00505             <span class="comment">// being handled so turn off muzzle flash</span>
<a name="l00506"></a>00506             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e39bbecc66c2b6b8df1ef4d98ed6feab">fMuzzleFlash</a> )
<a name="l00507"></a>00507             {
<a name="l00508"></a>00508                   <a class="code" href="opplist_8cpp.html#99fca0847f39df3a86cbab0974c4bb24">EndMuzzleFlash</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00509"></a>00509             }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511             <a class="code" href="Overhead_8cpp.html#fb230b373eb74a81318db04b75477535">gubAICounter</a>++;
<a name="l00512"></a>00512             <span class="comment">// figure out what to do!</span>
<a name="l00513"></a>00513             <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00514"></a>00514             {
<a name="l00515"></a>00515                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#90c338d417f334343a465928692ddb7a">fNoAPToFinishMove</a>)
<a name="l00516"></a>00516                   {
<a name="l00517"></a>00517                         <span class="comment">// well that move must have been cancelled because we're thinking now!</span>
<a name="l00518"></a>00518                         <span class="comment">//pSoldier-&gt;fNoAPToFinishMove = FALSE;</span>
<a name="l00519"></a>00519                   }
<a name="l00520"></a>00520                   <a class="code" href="AIMain_8cpp.html#b74f0a00fbbdbb3d888d7ad7f5a65466">TurnBasedHandleNPCAI</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00521"></a>00521             }
<a name="l00522"></a>00522             <span class="keywordflow">else</span>
<a name="l00523"></a>00523             {
<a name="l00524"></a>00524                   <a class="code" href="AIInternals_8h.html#0c32862f20fba04e681de870f1077418">RTHandleAI</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00525"></a>00525             }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527       }
<a name="l00528"></a>00528       <span class="keywordflow">else</span>
<a name="l00529"></a>00529       {
<a name="l00530"></a>00530 
<a name="l00531"></a>00531             <span class="comment">// an old action was in progress; continue it</span>
<a name="l00532"></a>00532             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> &gt;= FIRST_MOVEMENT_ACTION &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> &lt;= LAST_MOVEMENT_ACTION &amp;&amp; !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#164c7dfcffafdfa1fbaf7b1b61c07472">fDelayedMovement</a>)
<a name="l00533"></a>00533             {
<a name="l00534"></a>00534                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#00c7a9c8c241030433c6d931326a02cc">usPathIndex</a> == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#fe684651c0a5c70874383cc13a660ee8">usPathDataSize</a>)
<a name="l00535"></a>00535                   {
<a name="l00536"></a>00536                         <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> != NOWHERE)
<a name="l00537"></a>00537                         {
<a name="l00538"></a>00538                               <span class="keywordflow">if</span> ( !ACTING_ON_SCHEDULE( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &amp;&amp;  <a class="code" href="Isometric_01Utils_8cpp.html#94dc29a40d3702f9d4d8ad35dc8e457c">SpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> ) &lt; 4 )
<a name="l00539"></a>00539                               {
<a name="l00540"></a>00540                                     <span class="comment">// This is close enough... reached final destination for NPC system move                        </span>
<a name="l00541"></a>00541                                     <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> )
<a name="l00542"></a>00542                                     {
<a name="l00543"></a>00543                                           <span class="comment">// update NPC records to replace our final dest with this location</span>
<a name="l00544"></a>00544                                           <a class="code" href="NPC_8cpp.html#52b7ebb29b826ef67bf9213a06c9d6bb">ReplaceLocationInNPCDataFromProfileID</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> );
<a name="l00545"></a>00545                                     }
<a name="l00546"></a>00546                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l00547"></a>00547                                     <span class="comment">// change action data so that we consider this our final destination below</span>
<a name="l00548"></a>00548                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l00549"></a>00549                               }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> )
<a name="l00552"></a>00552                               {
<a name="l00553"></a>00553                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = NOWHERE;
<a name="l00554"></a>00554 
<a name="l00555"></a>00555                                     <span class="keywordflow">if</span> ( !ACTING_ON_SCHEDULE( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#30114897a2229659bda75e47c604b742">ubQuoteRecord</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> == <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831efe4a001cae7f1a97391ca0d3ec3a7e8c8">QUOTE_ACTION_ID_CHECKFORDEST</a> )
<a name="l00556"></a>00556                                     {
<a name="l00557"></a>00557                                           <a class="code" href="NPC_8cpp.html#0b88bb88fc41d691d2f8da285c8d780e">NPCReachedDestination</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, FALSE );
<a name="l00558"></a>00558                                           <span class="comment">// wait just a little bit so the queue can be processed</span>
<a name="l00559"></a>00559                                           pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a>;
<a name="l00560"></a>00560                                           pSoldier-&gt;usNextActionData = 500;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562                                     }
<a name="l00563"></a>00563                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> &gt;= <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831efe48f9c2ccb282afc7ed0f779fe67c4b1">QUOTE_ACTION_ID_TRAVERSE_EAST</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> &lt;= <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831ef0c9f3f8fb8f374c02f97081c2caa71c7">QUOTE_ACTION_ID_TRAVERSE_NORTH</a>)
<a name="l00564"></a>00564                                     {
<a name="l00565"></a>00565                                           <a class="code" href="AIMain_8cpp.html#b8b92563a3ad0716fede67c6bdae2c13">HandleAITacticalTraversal</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00566"></a>00566                                           <span class="keywordflow">return</span>;
<a name="l00567"></a>00567                                     }
<a name="l00568"></a>00568                               }
<a name="l00569"></a>00569                               <span class="keywordflow">else</span>
<a name="l00570"></a>00570                               {
<a name="l00571"></a>00571                                     <span class="comment">// make sure this guy is handled next frame!</span>
<a name="l00572"></a>00572                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> |= AI_HANDLE_EVERY_FRAME; 
<a name="l00573"></a>00573                               }
<a name="l00574"></a>00574                         }
<a name="l00575"></a>00575                         <span class="comment">// for regular guys still have to check for leaving the map</span>
<a name="l00576"></a>00576                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> &gt;= <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831efe48f9c2ccb282afc7ed0f779fe67c4b1">QUOTE_ACTION_ID_TRAVERSE_EAST</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> &lt;= <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831ef0c9f3f8fb8f374c02f97081c2caa71c7">QUOTE_ACTION_ID_TRAVERSE_NORTH</a>)
<a name="l00577"></a>00577                         {
<a name="l00578"></a>00578                               <a class="code" href="AIMain_8cpp.html#b8b92563a3ad0716fede67c6bdae2c13">HandleAITacticalTraversal</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00579"></a>00579                               <span class="keywordflow">return</span>;
<a name="l00580"></a>00580                         }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582                         <span class="comment">// reached destination</span>
<a name="l00583"></a>00583 <span class="preprocessor">                        #ifdef TESTAI</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span>                              DebugMsg( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>, DBG_LEVEL_0, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"OPPONENT %d REACHES DEST - ACTION DONE"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00585"></a>00585 <span class="preprocessor">                        #endif</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span>      
<a name="l00587"></a>00587                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13569e868936f0aabb70ab73640be218">sFinalDestination</a> )
<a name="l00588"></a>00588                         {
<a name="l00589"></a>00589                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4ca31547c6e6eeadec11ea94b7a9fd07">AI_ACTION_MOVE_TO_CLIMB</a> )
<a name="l00590"></a>00590                               {
<a name="l00591"></a>00591                                     <span class="comment">// successfully moved to roof!</span>
<a name="l00592"></a>00592 
<a name="l00593"></a>00593                                     <span class="comment">// fake setting action to climb roof and see if we can afford this</span>
<a name="l00594"></a>00594                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bf0d31a9fac3e900acf35ca5832cd876e">AI_ACTION_CLIMB_ROOF</a>;
<a name="l00595"></a>00595                                     <span class="keywordflow">if</span> (<a class="code" href="ai_8h.html#dd5730a3e85127b7590031d7580277b0">IsActionAffordable</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>))
<a name="l00596"></a>00596                                     {
<a name="l00597"></a>00597                                           <span class="comment">// set action to none and next action to climb roof so we do that next</span>
<a name="l00598"></a>00598                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l00599"></a>00599                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bf0d31a9fac3e900acf35ca5832cd876e">AI_ACTION_CLIMB_ROOF</a>;
<a name="l00600"></a>00600                                     }
<a name="l00601"></a>00601                                     
<a name="l00602"></a>00602                               }
<a name="l00603"></a>00603                         }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605                         <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l00606"></a>00606                   }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608                   <span class="comment">//*** TRICK- TAKE INTO ACCOUNT PAUSED FOR NO TIME ( FOR NOW )</span>
<a name="l00609"></a>00609                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#90c338d417f334343a465928692ddb7a">fNoAPToFinishMove</a> )
<a name="l00610"></a>00610                   {
<a name="l00611"></a>00611                         <a class="code" href="ai_8h.html#1e3dd4fd06741d94058c25d28bad44d9">SoldierTriesToContinueAlongPath</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l00612"></a>00612                   }
<a name="l00613"></a>00613                   <span class="comment">// ATE: Let's also test if we are in any stationary animation...</span>
<a name="l00614"></a>00614                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].uiFlags &amp; ANIM_STATIONARY ) )
<a name="l00615"></a>00615                   {
<a name="l00616"></a>00616                         <span class="comment">// ATE: Put some ( MORE ) refinements on here....</span>
<a name="l00617"></a>00617                         <span class="comment">// If we are trying to open door, or jump fence  don't continue until done...</span>
<a name="l00618"></a>00618                         <span class="keywordflow">if</span> ( !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#906350017de01732cd79495d831a9ee1">fContinueMoveAfterStanceChange</a> &amp;&amp; !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cbb347ca87fea92c26a4fef7a1b27025">bEndDoorOpenCode</a> )
<a name="l00619"></a>00619                         {
<a name="l00620"></a>00620                               <span class="comment">//ATE: just a few more.....</span>
<a name="l00621"></a>00621                               <span class="comment">// If we have ANY pending aninmation that is movement.....</span>
<a name="l00622"></a>00622                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#10dcc042f40b20751530663b0bbbe289">usPendingAnimation</a> != NO_PENDING_ANIMATION &amp;&amp; ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#10dcc042f40b20751530663b0bbbe289">usPendingAnimation</a> ].uiFlags &amp; ANIM_MOVING ) )
<a name="l00623"></a>00623                               {
<a name="l00624"></a>00624                                     <span class="comment">// Don't do anything, we're waiting on a pending animation....</span>
<a name="l00625"></a>00625                               }
<a name="l00626"></a>00626                               <span class="keywordflow">else</span>
<a name="l00627"></a>00627                               {
<a name="l00628"></a>00628                                     <span class="comment">// OK, we have a move to finish...</span>
<a name="l00629"></a>00629 <span class="preprocessor">                                    #ifdef TESTAI</span>
<a name="l00630"></a>00630 <span class="preprocessor"></span>                                          DebugMsg( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>, DBG_LEVEL_0, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"GONNA TRY TO CONTINUE PATH FOR %d"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00631"></a>00631 <span class="preprocessor">                                    #endif</span>
<a name="l00632"></a>00632 <span class="preprocessor"></span>
<a name="l00633"></a>00633                                     <a class="code" href="ai_8h.html#1e3dd4fd06741d94058c25d28bad44d9">SoldierTriesToContinueAlongPath</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l00634"></a>00634                               }
<a name="l00635"></a>00635                         }
<a name="l00636"></a>00636                   }
<a name="l00637"></a>00637             }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639       }
<a name="l00640"></a>00640 
<a name="l00641"></a>00641 <span class="comment">/*********</span>
<a name="l00642"></a>00642 <span class="comment">      End of new overall AI system</span>
<a name="l00643"></a>00643 <span class="comment">      ********/</span>
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647 <span class="preprocessor">#define NOSCORE 99</span>
<a name="l00648"></a>00648 <span class="preprocessor"></span>
<a name="l00649"></a><a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">00649</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00650"></a>00650 {
<a name="l00651"></a>00651       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                         <a class="code" href="structAILIST.html#06c6e800918fcfdf552c241d16fc32a7">ubID</a>;
<a name="l00652"></a>00652 
<a name="l00653"></a>00653       <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00654"></a>00654       {
<a name="l00655"></a>00655             <span class="keywordflow">if</span> (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; PLAYER_TEAM_DEAD)
<a name="l00656"></a>00656             {
<a name="l00657"></a>00657                   <a class="code" href="TeamTurns_8cpp.html#7c0aba67737ac957ec85869f31b1e898">EndAITurn</a>();
<a name="l00658"></a>00658                   <span class="keywordflow">return</span>;
<a name="l00659"></a>00659             }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661             <span class="comment">// search for any player merc to say close call quote</span>
<a name="l00662"></a>00662             <span class="keywordflow">for</span> ( ubID = <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> ].bFirstID; ubID &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> ].bLastID; ubID++ )
<a name="l00663"></a>00663             {
<a name="l00664"></a>00664                   <span class="keywordflow">if</span> ( OK_INSECTOR_MERC( <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubID ] ) )
<a name="l00665"></a>00665                   {
<a name="l00666"></a>00666                         <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubID ]-&gt;fCloseCall )
<a name="l00667"></a>00667                         {
<a name="l00668"></a>00668                               <span class="keywordflow">if</span> ( !<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#400a8410b311f238d9cae2d5fe02f835">fSomeoneHit</a> &amp;&amp; <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubID ]-&gt;<a class="code" href="structSOLDIERTYPE.html#8ee76efd23926a599ad87be63f386403">bNumHitsThisTurn</a> == 0 &amp;&amp; !(<a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubID ]-&gt;<a class="code" href="structSOLDIERTYPE.html#7e63debe882783fb2cb8641f3b3e8214">usQuoteSaidExtFlags</a> &amp; SOLDIER_QUOTE_SAID_EXT_CLOSE_CALL) &amp;&amp; <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 3 ) == 0 )
<a name="l00669"></a>00669                               {
<a name="l00670"></a>00670                                     <span class="comment">// say close call quote!</span>
<a name="l00671"></a>00671                                     <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubID ], <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a29ec56245cb043c59dbcaa9a91b68d76d9">QUOTE_CLOSE_CALL</a> );
<a name="l00672"></a>00672                                     <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubID ]-&gt;<a class="code" href="structSOLDIERTYPE.html#7e63debe882783fb2cb8641f3b3e8214">usQuoteSaidExtFlags</a> |= SOLDIER_QUOTE_SAID_EXT_CLOSE_CALL;
<a name="l00673"></a>00673                               }
<a name="l00674"></a>00674                               <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubID ]-&gt;<a class="code" href="structSOLDIERTYPE.html#f42230b2347185f74e37b268f4cc8012">fCloseCall</a> = FALSE;
<a name="l00675"></a>00675                         }
<a name="l00676"></a>00676                   }
<a name="l00677"></a>00677             }
<a name="l00678"></a>00678             <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#400a8410b311f238d9cae2d5fe02f835">fSomeoneHit</a> = FALSE;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680             <span class="comment">// if civ in civ group and hostile, try to change nearby guys to hostile</span>
<a name="l00681"></a>00681             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> != <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a078524cb5f7573455bdacd2b87a051da610c97">NON_CIV_GROUP</a> &amp;&amp; !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a> )
<a name="l00682"></a>00682             {
<a name="l00683"></a>00683 
<a name="l00684"></a>00684                   <span class="keywordflow">if</span> ( !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_BOXER) || !( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#32021b7251048d8c62ea0c2e26b7a021">bBoxingState</a> == <a class="code" href="Overhead_01Types_8h.html#60ed5bd8e4835b98d48cf7afb819b4e55fac2cdafaeb730644fb13980a1fa22c">PRE_BOXING</a> || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#32021b7251048d8c62ea0c2e26b7a021">bBoxingState</a> == <a class="code" href="Overhead_01Types_8h.html#60ed5bd8e4835b98d48cf7afb819b4e57afcbf140adcf1ab9068be7ec414b3b1">BOXING</a> ) )
<a name="l00685"></a>00685                   {
<a name="l00686"></a>00686                         <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubFirstProfile;
<a name="l00687"></a>00687 
<a name="l00688"></a>00688                         ubFirstProfile = <a class="code" href="Overhead_8cpp.html#1f7b3d751ae8b658fbd9c20ee1d21a44">CivilianGroupMembersChangeSidesWithinProximity</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00689"></a>00689                         <span class="keywordflow">if</span> ( ubFirstProfile != NO_PROFILE )
<a name="l00690"></a>00690                         {
<a name="l00691"></a>00691                               <a class="code" href="NPC_8cpp.html#2702f7477f44ce6cc8bff348cc899fec">TriggerFriendWithHostileQuote</a>( ubFirstProfile );
<a name="l00692"></a>00692                         }
<a name="l00693"></a>00693                   }
<a name="l00694"></a>00694             }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696             <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; SHOW_ALL_ROOFS &amp;&amp; ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT ) )
<a name="l00697"></a>00697             {
<a name="l00698"></a>00698                   <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>( RENDER_FLAG_FULL );
<a name="l00699"></a>00699                   <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp;= (~SHOW_ALL_ROOFS );
<a name="l00700"></a>00700                   <a class="code" href="renderworld_8cpp.html#1e1ddb2858063ee68614cd6c221369bb">InvalidateWorldRedundency</a>( );
<a name="l00701"></a>00701             }
<a name="l00702"></a>00702 
<a name="l00703"></a>00703             <span class="comment">// End this NPC's control, move to next dude</span>
<a name="l00704"></a>00704             <a class="code" href="Interface_01Panels_8cpp.html#fcc373775787481e51db888e2cb2c1f6">EndRadioLocator</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l00705"></a>00705             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp;= ( ~SOLDIER_UNDERAICONTROL );
<a name="l00706"></a>00706             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#87feaf9475b90143652df19829930b96">fTurnInProgress</a> = FALSE;
<a name="l00707"></a>00707             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#3f58b0f6efbd23c543ea12258a2f9ef3">bMoved</a> = TRUE;
<a name="l00708"></a>00708             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f72e7e4bdc35542eca5402ce5329de32">bBypassToGreen</a> = FALSE;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710 <span class="preprocessor">      #ifdef TESTAICONTROL</span>
<a name="l00711"></a>00711 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; DEMOMODE))
<a name="l00712"></a>00712                   <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending control for %d"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00713"></a>00713 <span class="preprocessor">      #endif</span>
<a name="l00714"></a>00714 <span class="preprocessor"></span>
<a name="l00715"></a>00715             <span class="comment">// find the next AI guy</span>
<a name="l00716"></a>00716             ubID = <a class="code" href="AIList_8cpp.html#3e00e7c335cc3bf9c339fe250eae28cd">RemoveFirstAIListEntry</a>();
<a name="l00717"></a>00717             <span class="keywordflow">if</span> (ubID != NOBODY)
<a name="l00718"></a>00718             {
<a name="l00719"></a>00719                   <a class="code" href="ai_8h.html#6354d7a432959d5262c2d8ea5cde06c4">StartNPCAI</a>( <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubID ] );                 
<a name="l00720"></a>00720                   <span class="keywordflow">return</span>;
<a name="l00721"></a>00721             }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723             <span class="comment">// We are at the end, return control to next team</span>
<a name="l00724"></a>00724             <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (STR)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending AI turn\n"</span> ) );
<a name="l00725"></a>00725             <a class="code" href="TeamTurns_8cpp.html#7c0aba67737ac957ec85869f31b1e898">EndAITurn</a>();
<a name="l00726"></a>00726 
<a name="l00727"></a>00727       }
<a name="l00728"></a>00728       <span class="keywordflow">else</span>
<a name="l00729"></a>00729       {
<a name="l00730"></a>00730             <span class="comment">// realtime</span>
<a name="l00731"></a>00731       }
<a name="l00732"></a>00732 }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734 
<a name="l00735"></a>00735 
<a name="l00736"></a><a class="code" href="AIMain_8cpp.html#624d598a02eae414c8811207d28166bc">00736</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#624d598a02eae414c8811207d28166bc">EndAIDeadlock</a>(<span class="keywordtype">void</span>)
<a name="l00737"></a>00737 {
<a name="l00738"></a>00738       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> cnt;
<a name="l00739"></a>00739       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l00740"></a>00740       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bFound=FALSE;
<a name="l00741"></a>00741       
<a name="l00742"></a>00742       <span class="comment">// ESCAPE ENEMY'S TURN              </span>
<a name="l00743"></a>00743       
<a name="l00744"></a>00744       <span class="comment">// find enemy with problem and free him up...</span>
<a name="l00745"></a>00745       <span class="keywordflow">for</span> (cnt=0,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>=<a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>; cnt &lt; MAXMERCS; cnt++,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>++)
<a name="l00746"></a>00746       {
<a name="l00747"></a>00747             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#653dad4e2520784e293eca9f948b8532">bActive</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b0096f321a0de4f0617283f7b3212aa0">bInSector</a> )
<a name="l00748"></a>00748             {
<a name="l00749"></a>00749                   <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_UNDERAICONTROL)
<a name="l00750"></a>00750                   {
<a name="l00751"></a>00751                         <a class="code" href="ai_8h.html#6cced4c42ca3081db5b89f6a584e549f">CancelAIAction</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,FORCE);
<a name="l00752"></a>00752 <span class="preprocessor">                        #ifdef TESTAICONTROL</span>
<a name="l00753"></a>00753 <span class="preprocessor"></span>                              <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00754"></a>00754                               {
<a name="l00755"></a>00755                                     <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because breaking deadlock"</span>, pSoldier-&gt;ubID ) );
<a name="l00756"></a>00756                               }
<a name="l00757"></a>00757 <span class="preprocessor">                        #endif</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span>
<a name="l00759"></a>00759                         DebugMsg( <a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>, DBG_LEVEL_3, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>( <span class="stringliteral">"Number of bullets in the air is %ld"</span>, <a class="code" href="bullets_8cpp.html#7f3a192faf5f9ad5c12748e36d6db8b5">guiNumBullets</a> ) );
<a name="l00760"></a>00760 
<a name="l00761"></a>00761                         DebugMsg( <a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>, DBG_LEVEL_3, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Setting attack busy count to 0 from deadlock break"</span> ) );
<a name="l00762"></a>00762                         <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a> = 0;
<a name="l00763"></a>00763       
<a name="l00764"></a>00764                         <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>(pSoldier);
<a name="l00765"></a>00765                         bFound = TRUE;
<a name="l00766"></a>00766                         <span class="keywordflow">break</span>;
<a name="l00767"></a>00767                   }
<a name="l00768"></a>00768             }
<a name="l00769"></a>00769       }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771 
<a name="l00772"></a>00772       <span class="keywordflow">if</span> (!bFound)
<a name="l00773"></a>00773       {
<a name="l00774"></a>00774             <a class="code" href="Overhead_8h.html#60bb10cf0b59f54af4a7d17da9049fc3">StartPlayerTeamTurn</a>( TRUE, FALSE );
<a name="l00775"></a>00775       }
<a name="l00776"></a>00776 }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778 
<a name="l00779"></a><a class="code" href="AIMain_8cpp.html#6354d7a432959d5262c2d8ea5cde06c4">00779</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#6354d7a432959d5262c2d8ea5cde06c4">StartNPCAI</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l00780"></a>00780 {
<a name="l00781"></a>00781 
<a name="l00782"></a>00782       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fInValidSoldier = FALSE;
<a name="l00783"></a>00783 
<a name="l00784"></a>00784             <span class="comment">// Only the host should do this</span>
<a name="l00785"></a>00785 <span class="preprocessor">#ifdef NETWORKED</span>
<a name="l00786"></a>00786 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(!<a class="code" href="Overhead_8cpp.html#18804ce8d998e9748d7518f42669d7a2">gfAmIHost</a>)
<a name="l00787"></a>00787                   <span class="keywordflow">return</span>;
<a name="l00788"></a>00788 <span class="preprocessor">#endif</span>
<a name="l00789"></a>00789 <span class="preprocessor"></span>            <span class="comment">//pSoldier-&gt;uiStatusFlags |= SOLDIER_UNDERAICONTROL;</span>
<a name="l00790"></a>00790             <a class="code" href="Soldier_01Control_8cpp.html#ed4e321e06fac73dcc6c3cabb4a1f1f5">SetSoldierAsUnderAiControl</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00791"></a>00791 
<a name="l00792"></a>00792             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#87feaf9475b90143652df19829930b96">fTurnInProgress</a> = TRUE;
<a name="l00793"></a>00793 
<a name="l00794"></a>00794             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#37b888c013168474b11d3ab515695f09">sLastTwoLocations</a>[0] = NOWHERE;
<a name="l00795"></a>00795             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#37b888c013168474b11d3ab515695f09">sLastTwoLocations</a>[1] = NOWHERE;
<a name="l00796"></a>00796 
<a name="l00797"></a>00797             <a class="code" href="AIInternals_8h.html#ae28a86711cdd71702115912c232f563">RefreshAI</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l00798"></a>00798 
<a name="l00799"></a>00799 <span class="preprocessor">#ifdef TESTAICONTROL</span>
<a name="l00800"></a>00800 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; DEMOMODE))
<a name="l00801"></a>00801                   <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Giving control to %d"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l00802"></a>00802 <span class="preprocessor">#endif</span>
<a name="l00803"></a>00803 <span class="preprocessor"></span>
<a name="l00804"></a>00804             <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#a1b7eae915048f8deb7376f3ea5bc920">uiTimeSinceMercAIStart</a> = GetJA2Clock();
<a name="l00805"></a>00805 
<a name="l00806"></a>00806             DebugMsg( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>, DBG_LEVEL_3 , <span class="stringliteral">"Clock set"</span> );
<a name="l00807"></a>00807 
<a name="l00808"></a>00808             <span class="comment">// important: if "fPausedAnimation" is TRUE, then we have to turn it off else</span>
<a name="l00809"></a>00809             <span class="comment">// HandleSoldierAI() will not be called!</span>
<a name="l00810"></a>00810 
<a name="l00811"></a>00811             <span class="keywordflow">if</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_VEHICLE )
<a name="l00812"></a>00812             {
<a name="l00813"></a>00813                   <span class="keywordflow">if</span> ( <a class="code" href="Vehicles_8cpp.html#ca5adf32b566416b56461f974cfdc605">GetNumberInVehicle</a>(  <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6b49c64abec6b8363ffa83c9cc308dd6">bVehicleID</a> ) == 0 )
<a name="l00814"></a>00814                   {
<a name="l00815"></a>00815                         fInValidSoldier = TRUE;
<a name="l00816"></a>00816                   }
<a name="l00817"></a>00817             }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819             <span class="comment">// Locate to soldier</span>
<a name="l00820"></a>00820             <span class="comment">// If we are not in an interrupt situation!</span>
<a name="l00821"></a>00821             <span class="keywordflow">if</span> ( (( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; TURNBASED ) &amp;&amp; ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT )) &amp;&amp; <a class="code" href="TeamTurns_8cpp.html#bba49c23835b863c536a9796e4461183">gubOutOfTurnPersons</a> == 0 )
<a name="l00822"></a>00822             {
<a name="l00823"></a>00823                   <span class="keywordflow">if</span>( ( ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#73246323764393ce2a5ece7fcb7b7cf8">bVisible</a> != -1 &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a>) || ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; SHOW_ALL_MERCS ) ) &amp;&amp; ( fInValidSoldier == FALSE ) )
<a name="l00824"></a>00824                   {
<a name="l00825"></a>00825                         <span class="comment">// If we are on a roof, set flag for rendering...</span>
<a name="l00826"></a>00826                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> != 0 &amp;&amp; ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT ) )
<a name="l00827"></a>00827                         {
<a name="l00828"></a>00828                               <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> |= SHOW_ALL_ROOFS;
<a name="l00829"></a>00829                               <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>( RENDER_FLAG_FULL );
<a name="l00830"></a>00830                               <a class="code" href="renderworld_8cpp.html#1e1ddb2858063ee68614cd6c221369bb">InvalidateWorldRedundency</a>( );
<a name="l00831"></a>00831                         }
<a name="l00832"></a>00832                         
<a name="l00833"></a>00833 
<a name="l00834"></a>00834                         <span class="comment">//ATE: Changed to show locator</span>
<a name="l00835"></a>00835 
<a name="l00836"></a>00836                         <span class="comment">// Skip locator for green friendly militia</span>
<a name="l00837"></a>00837                         <span class="keywordflow">if</span> ( !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == MILITIA_TEAM &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1e61c0006bacccf9457c3f6c43607578">bSide</a> == 0 &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> == <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532f91de342fc2584dd731cfe5d47271c6">STATUS_GREEN</a>) )
<a name="l00838"></a>00838                         {
<a name="l00839"></a>00839                               <a class="code" href="Overhead_8cpp.html#c813c6ef53a718cac0170274abda7593">LocateSoldier</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>, SETLOCATORFAST );
<a name="l00840"></a>00840                         }
<a name="l00841"></a>00841                         
<a name="l00842"></a>00842                         <span class="comment">// try commenting this out altogether</span>
<a name="l00843"></a>00843                         <span class="comment">/*</span>
<a name="l00844"></a>00844 <span class="comment">                        // so long as he's not a neutral civ or a militia friendly to the player</span>
<a name="l00845"></a>00845 <span class="comment">                        if ( !(pSoldier-&gt;bNeutral || (pSoldier-&gt;bTeam == MILITIA_TEAM &amp;&amp; pSoldier-&gt;bSide == 0) ) )</span>
<a name="l00846"></a>00846 <span class="comment">                        {</span>
<a name="l00847"></a>00847 <span class="comment">                              PauseAITemporarily();</span>
<a name="l00848"></a>00848 <span class="comment">                        }</span>
<a name="l00849"></a>00849 <span class="comment">                        */</span>
<a name="l00850"></a>00850                   }
<a name="l00851"></a>00851 
<a name="l00852"></a>00852                   <a class="code" href="Interface_8cpp.html#7f99a29ee0b61ef3341ea9696af75147">UpdateEnemyUIBar</a>( );
<a name="l00853"></a>00853 
<a name="l00854"></a>00854             }           
<a name="l00855"></a>00855 
<a name="l00856"></a>00856             <span class="comment">// Remove deadlock message</span>
<a name="l00857"></a>00857             DebugMsg( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>, DBG_LEVEL_3 , <span class="stringliteral">"About to remove deadlock message"</span> );
<a name="l00858"></a>00858             <a class="code" href="Interface_8cpp.html#0728ce1dc7dcaea64a98f2d25bcf556d">EndDeadlockMsg</a>( );
<a name="l00859"></a>00859             DebugMsg( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>, DBG_LEVEL_3 , <span class="stringliteral">"About to decide alert status"</span> );
<a name="l00860"></a>00860             <a class="code" href="AIInternals_8h.html#deb4b27c776d12c422d88811706807fe">DecideAlertStatus</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00861"></a>00861             DebugMsg( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>, DBG_LEVEL_3 , <span class="stringliteral">"Alert status decided - startnpcai done"</span> );
<a name="l00862"></a>00862 }
<a name="l00863"></a>00863 
<a name="l00864"></a>00864 
<a name="l00865"></a>00865 
<a name="l00866"></a><a class="code" href="AIMain_8cpp.html#c81fbfd47790eac95ce94d0ec6980833">00866</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="AIMain_8cpp.html#c81fbfd47790eac95ce94d0ec6980833">DestNotSpokenFor</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridno)
<a name="l00867"></a>00867 {
<a name="l00868"></a>00868       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> cnt;
<a name="l00869"></a>00869       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pOurTeam;
<a name="l00870"></a>00870 
<a name="l00871"></a>00871       cnt = <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].<a class="code" href="structTacticalTeamType.html#f8fe819ad07b242f5dbf97fd4c69b00d">bFirstID</a>;
<a name="l00872"></a>00872 
<a name="l00873"></a>00873       <span class="comment">// make a list of all of our team's mercs</span>
<a name="l00874"></a>00874       <span class="keywordflow">for</span> (pOurTeam = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[cnt]; cnt &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].<a class="code" href="structTacticalTeamType.html#6a887279dad735dc302f21c1e559d5ce">bLastID</a>; cnt++,pOurTeam++)
<a name="l00875"></a>00875       {
<a name="l00876"></a>00876             <span class="keywordflow">if</span> ( pOurTeam-&gt;<a class="code" href="structSOLDIERTYPE.html#653dad4e2520784e293eca9f948b8532">bActive</a> )
<a name="l00877"></a>00877             {
<a name="l00878"></a>00878                   <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> (pOurTeam-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == sGridno || pOurTeam-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> == sGridno)
<a name="l00879"></a>00879                         <span class="keywordflow">return</span>(FALSE);
<a name="l00880"></a>00880             }
<a name="l00881"></a>00881       }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883       <span class="keywordflow">return</span>(TRUE);     <span class="comment">// dest is free to go to...</span>
<a name="l00884"></a>00884 }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886 
<a name="l00887"></a><a class="code" href="AIMain_8cpp.html#920e366617fc05ff1cbceb05e0c33649">00887</a> <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> <a class="code" href="ai_8h.html#920e366617fc05ff1cbceb05e0c33649">FindAdjacentSpotBeside</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridno)
<a name="l00888"></a>00888 {
<a name="l00889"></a>00889       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> cnt;
<a name="l00890"></a>00890       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> mods[4] = {-1,-MAPWIDTH,1,MAPWIDTH};
<a name="l00891"></a>00891       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sTempGridno,sCheapestCost=500,sMovementCost,sCheapestDest=NOWHERE;
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 
<a name="l00894"></a>00894       <span class="keywordflow">for</span> (cnt=0; cnt &lt; 4; cnt++)
<a name="l00895"></a>00895       {
<a name="l00896"></a>00896             sTempGridno = sGridno + mods[cnt];
<a name="l00897"></a>00897             <span class="keywordflow">if</span> (!<a class="code" href="Isometric_01Utils_8cpp.html#3840ffd547b1a82a0806e3aac7171d79">OutOfBounds</a>(sGridno,sTempGridno))
<a name="l00898"></a>00898             {
<a name="l00899"></a>00899                   <span class="keywordflow">if</span> (<a class="code" href="Overhead_8cpp.html#1b42cba58f5984a3d0b0d0ec0d3def8c">NewOKDestination</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,sTempGridno,PEOPLETOO, pSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> ) &amp;&amp; <a class="code" href="AIMain_8cpp.html#c81fbfd47790eac95ce94d0ec6980833">DestNotSpokenFor</a>(pSoldier,sTempGridno))
<a name="l00900"></a>00900                   {
<a name="l00901"></a>00901                         sMovementCost = <a class="code" href="PATHAI_8cpp.html#21b55ed2d493e5333f2236ada229ac7f">PlotPath</a>(pSoldier,sTempGridno,FALSE,FALSE,FALSE,<a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb7f92908f6f669259d971b608823d2ebb">WALKING</a>,FALSE,FALSE,0);
<a name="l00902"></a>00902                         <span class="keywordflow">if</span> (sMovementCost &lt; sCheapestCost)
<a name="l00903"></a>00903                         {
<a name="l00904"></a>00904                               sCheapestCost     = sMovementCost;  
<a name="l00905"></a>00905                               sCheapestDest = sTempGridno;
<a name="l00906"></a>00906                         }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908                   }
<a name="l00909"></a>00909             }
<a name="l00910"></a>00910                         
<a name="l00911"></a>00911       }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913       <span class="keywordflow">return</span>(sCheapestDest);
<a name="l00914"></a>00914 }
<a name="l00915"></a>00915 
<a name="l00916"></a><a class="code" href="AIMain_8cpp.html#9d9a8b1ea77d5b2baf54c8b6355d72d1">00916</a> <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> <a class="code" href="ai_8h.html#9d9a8b1ea77d5b2baf54c8b6355d72d1">GetMostThreateningOpponent</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00917"></a>00917 {
<a name="l00918"></a>00918       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>                        uiLoop;
<a name="l00919"></a>00919       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                         iThreatVal,iMinThreat = 30000;
<a name="l00920"></a>00920       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a>       *pTargetSoldier;
<a name="l00921"></a>00921       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                         ubTargetSoldier = NO_SOLDIER;
<a name="l00922"></a>00922 
<a name="l00923"></a>00923       <span class="comment">// Loop through all mercs </span>
<a name="l00924"></a>00924 
<a name="l00925"></a>00925       <span class="keywordflow">for</span> (uiLoop = 0; uiLoop &lt; <a class="code" href="Overhead_8cpp.html#d627c552ede524c66140f3410174d3d4">guiNumMercSlots</a>; uiLoop++)
<a name="l00926"></a>00926       {
<a name="l00927"></a>00927             pTargetSoldier = <a class="code" href="Overhead_8cpp.html#b139938f6b836645dd67972944d21bf3">MercSlots</a>[ uiLoop ];
<a name="l00928"></a>00928 
<a name="l00929"></a>00929             <span class="keywordflow">if</span> (!pTargetSoldier)
<a name="l00930"></a>00930             {
<a name="l00931"></a>00931                   <span class="keywordflow">continue</span>;
<a name="l00932"></a>00932             }
<a name="l00933"></a>00933 
<a name="l00934"></a>00934             <span class="comment">// if this soldier is on same team as me, skip him</span>
<a name="l00935"></a>00935             <span class="keywordflow">if</span> (pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> || pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#1e61c0006bacccf9457c3f6c43607578">bSide</a> == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1e61c0006bacccf9457c3f6c43607578">bSide</a>)
<a name="l00936"></a>00936             {
<a name="l00937"></a>00937                   <span class="keywordflow">continue</span>;         
<a name="l00938"></a>00938             }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940             <span class="comment">// if potential opponent is dead, skip him</span>
<a name="l00941"></a>00941             <span class="keywordflow">if</span> (!pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a>)
<a name="l00942"></a>00942             {
<a name="l00943"></a>00943                   <span class="keywordflow">continue</span>;
<a name="l00944"></a>00944             }
<a name="l00945"></a>00945 
<a name="l00946"></a>00946             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d0a0bdddaeb7bbea617b4294b539ef32">bOppList</a>[pTargetSoldier-&gt;ubID] != SEEN_CURRENTLY)
<a name="l00947"></a>00947               <span class="keywordflow">continue</span>;
<a name="l00948"></a>00948 
<a name="l00949"></a>00949             <span class="comment">// Special stuff for Carmen the bounty hunter</span>
<a name="l00950"></a>00950             <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a> == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a> &amp;&amp; pTargetSoldier-&gt;ubProfile != 64)
<a name="l00951"></a>00951             {
<a name="l00952"></a>00952                   <span class="keywordflow">continue</span>;  <span class="comment">// next opponent</span>
<a name="l00953"></a>00953             }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955             iThreatVal = <a class="code" href="AIInternals_8h.html#40ed7f95a21fb08493e0dac8127b035d">CalcManThreatValue</a>(pTargetSoldier, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, TRUE, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l00956"></a>00956             <span class="keywordflow">if</span> (iThreatVal &lt; iMinThreat)
<a name="l00957"></a>00957             {
<a name="l00958"></a>00958                   iMinThreat              = iThreatVal;
<a name="l00959"></a>00959                   ubTargetSoldier   = pTargetSoldier-&gt;ubID;
<a name="l00960"></a>00960             }
<a name="l00961"></a>00961             
<a name="l00962"></a>00962       }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964       <span class="keywordflow">return</span>( ubTargetSoldier );
<a name="l00965"></a>00965 }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967 
<a name="l00968"></a>00968 
<a name="l00969"></a><a class="code" href="AIMain_8cpp.html#89c2c8ed81ca4440c5ab50db64614288">00969</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#89c2c8ed81ca4440c5ab50db64614288">FreeUpNPCFromPendingAction</a>(    <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00970"></a>00970 {
<a name="l00971"></a>00971       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00972"></a>00972       {
<a name="l00973"></a>00973             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b1221b04fcc67d664066e467da8a5ffbe">AI_ACTION_PENDING_ACTION</a>
<a name="l00974"></a>00974                   || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b65e8af0fc83447730cc2b8d86372bcaf">AI_ACTION_OPEN_OR_CLOSE_DOOR</a>
<a name="l00975"></a>00975                   || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b33f47e42fd1375b937fa9cfb14d36bf9">AI_ACTION_CREATURE_CALL</a>
<a name="l00976"></a>00976                   || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b040215f06027cab6536b687b79df4633">AI_ACTION_YELLOW_ALERT</a>
<a name="l00977"></a>00977                   || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b32a0d931f53db4ddf96ac82a3b52484a">AI_ACTION_RED_ALERT</a>
<a name="l00978"></a>00978                   || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950ba5497fc0ba7a574720d7e7fc9b6acadf">AI_ACTION_UNLOCK_DOOR</a>
<a name="l00979"></a>00979                   || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b7e203d40eac46d173b3d04252291e713">AI_ACTION_PULL_TRIGGER</a>
<a name="l00980"></a>00980                   || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8d52b4109959d549093a3709f0a0a39c">AI_ACTION_LOCK_DOOR</a>     )
<a name="l00981"></a>00981             {
<a name="l00982"></a>00982                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE )
<a name="l00983"></a>00983                   {
<a name="l00984"></a>00984                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#30114897a2229659bda75e47c604b742">ubQuoteRecord</a> == <a class="code" href="interface_01Dialogue_8h.html#2ae95ea8e60178fe99580d5142f0ec7e019f5584e55c49783e3d8077c4d9d884">NPC_ACTION_KYLE_GETS_MONEY</a> )
<a name="l00985"></a>00985                         {
<a name="l00986"></a>00986                               <span class="comment">// Kyle after getting money</span>
<a name="l00987"></a>00987                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#30114897a2229659bda75e47c604b742">ubQuoteRecord</a> = 0;
<a name="l00988"></a>00988                               <a class="code" href="NPC_8cpp.html#83d84c9096b10dafd853138a5492552d">TriggerNPCRecord</a>( <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1ade2c5dbfa8e32bf14802b8a827e5d61">KYLE</a>, 11 );
<a name="l00989"></a>00989                         }
<a name="l00990"></a>00990                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> == <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb3a0e36f7ce66e717ac9d4d2939668f94">END_OPENSTRUCT</a>)
<a name="l00991"></a>00991                         {
<a name="l00992"></a>00992                               <a class="code" href="NPC_8cpp.html#d7f92a649ae364cf3c2b7b69c4806bd0">TriggerNPCWithGivenApproach</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>, <a class="code" href="NPC_8h.html#fe4ba80db4eca5533465fe913160a13af96584640f38488099177f3dfb8c86f2">APPROACH_DONE_OPEN_STRUCTURE</a>, TRUE );
<a name="l00993"></a>00993                               <span class="comment">//TriggerNPCWithGivenApproach( pSoldier-&gt;ubProfile, APPROACH_DONE_OPEN_STRUCTURE, FALSE );</span>
<a name="l00994"></a>00994                         }
<a name="l00995"></a>00995                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> == <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb1e0f04351d55f1ce472daf304a9b02dc">PICKUP_ITEM</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> == <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb7c2f4455243d6e11c866f25bd7c542fb">ADJACENT_GET_ITEM</a> )
<a name="l00996"></a>00996                         {
<a name="l00997"></a>00997                               <a class="code" href="NPC_8cpp.html#d7f92a649ae364cf3c2b7b69c4806bd0">TriggerNPCWithGivenApproach</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>, <a class="code" href="NPC_8h.html#fe4ba80db4eca5533465fe913160a13a34c773fb9879c7937e497113414c1d68">APPROACH_DONE_GET_ITEM</a>, TRUE );
<a name="l00998"></a>00998                         }
<a name="l00999"></a>00999                   }
<a name="l01000"></a>01000                   <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01001"></a>01001             }
<a name="l01002"></a>01002       }
<a name="l01003"></a>01003 }
<a name="l01004"></a>01004 
<a name="l01005"></a><a class="code" href="AIMain_8cpp.html#90bd1b66274f118f10ecb429045e05a1">01005</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#90bd1b66274f118f10ecb429045e05a1">FreeUpNPCFromAttacking</a>(<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> <a class="code" href="structAILIST.html#06c6e800918fcfdf552c241d16fc32a7">ubID</a>)
<a name="l01006"></a>01006 {
<a name="l01007"></a>01007       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l01008"></a>01008 
<a name="l01009"></a>01009       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ubID];
<a name="l01010"></a>01010       <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01011"></a>01011       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#3a6fe14f56915df15716ea088f2251e4">bNeedToLook</a> = TRUE;
<a name="l01012"></a>01012 
<a name="l01013"></a>01013 <span class="comment">/*</span>
<a name="l01014"></a>01014 <span class="comment">      if (pSoldier-&gt;bActionInProgress)</span>
<a name="l01015"></a>01015 <span class="comment">      { </span>
<a name="l01016"></a>01016 <span class="comment">#ifdef TESTAI</span>
<a name="l01017"></a>01017 <span class="comment">            DebugMsg( TOPIC_JA2AI, DBG_LEVEL_0, String( "FreeUpNPCFromAttacking for %d", pSoldier-&gt;ubID ) );</span>
<a name="l01018"></a>01018 <span class="comment">#endif</span>
<a name="l01019"></a>01019 <span class="comment">            if (pSoldier-&gt;bAction == AI_ACTION_FIRE_GUN)</span>
<a name="l01020"></a>01020 <span class="comment">            {</span>
<a name="l01021"></a>01021 <span class="comment">                  if (pSoldier-&gt;bDoBurst)</span>
<a name="l01022"></a>01022 <span class="comment">                  {</span>
<a name="l01023"></a>01023 <span class="comment">                        if (pSoldier-&gt;bBulletsLeft == 0)</span>
<a name="l01024"></a>01024 <span class="comment">                        {</span>
<a name="l01025"></a>01025 <span class="comment">                              // now find the target and have them say "close call" quote if</span>
<a name="l01026"></a>01026 <span class="comment">                              // applicable</span>
<a name="l01027"></a>01027 <span class="comment">                              pTarget = SimpleFindSoldier( pSoldier-&gt;sTargetGridNo, pSoldier-&gt;bTargetLevel );</span>
<a name="l01028"></a>01028 <span class="comment">                              if (pTarget &amp;&amp; pTarget-&gt;bTeam == OUR_TEAM &amp;&amp; pTarget-&gt;fCloseCall &amp;&amp; pTarget-&gt;bShock == 0)</span>
<a name="l01029"></a>01029 <span class="comment">                              {</span>
<a name="l01030"></a>01030 <span class="comment">                                    // say close call quote!</span>
<a name="l01031"></a>01031 <span class="comment">                                    TacticalCharacterDialogue( pTarget, QUOTE_CLOSE_CALL );</span>
<a name="l01032"></a>01032 <span class="comment">                                    pTarget-&gt;fCloseCall = FALSE;</span>
<a name="l01033"></a>01033 <span class="comment">                              }</span>
<a name="l01034"></a>01034 <span class="comment">                              ActionDone(pSoldier);</span>
<a name="l01035"></a>01035 <span class="comment">                              pSoldier-&gt;bDoBurst = FALSE;</span>
<a name="l01036"></a>01036 <span class="comment">                        }           </span>
<a name="l01037"></a>01037 <span class="comment">                  }</span>
<a name="l01038"></a>01038 <span class="comment">                  else</span>
<a name="l01039"></a>01039 <span class="comment">                  {</span>
<a name="l01040"></a>01040 <span class="comment">                        pTarget = SimpleFindSoldier( pSoldier-&gt;sTargetGridNo, pSoldier-&gt;bTargetLevel );</span>
<a name="l01041"></a>01041 <span class="comment">                        if (pTarget &amp;&amp; pTarget-&gt;bTeam == OUR_TEAM &amp;&amp; pTarget-&gt;fCloseCall &amp;&amp; pTarget-&gt;bShock == 0)</span>
<a name="l01042"></a>01042 <span class="comment">                        {</span>
<a name="l01043"></a>01043 <span class="comment">                              // say close call quote!</span>
<a name="l01044"></a>01044 <span class="comment">                              TacticalCharacterDialogue( pTarget, QUOTE_CLOSE_CALL );</span>
<a name="l01045"></a>01045 <span class="comment">                              pTarget-&gt;fCloseCall = FALSE;</span>
<a name="l01046"></a>01046 <span class="comment">                        }</span>
<a name="l01047"></a>01047 <span class="comment">                        ActionDone(pSoldier);   </span>
<a name="l01048"></a>01048 <span class="comment">                  }</span>
<a name="l01049"></a>01049 <span class="comment">            }</span>
<a name="l01050"></a>01050 <span class="comment">            else if ((pSoldier-&gt;bAction == AI_ACTION_TOSS_PROJECTILE) || (pSoldier-&gt;bAction == AI_ACTION_KNIFE_STAB))</span>
<a name="l01051"></a>01051 <span class="comment">            {</span>
<a name="l01052"></a>01052 <span class="comment">                  ActionDone(pSoldier);</span>
<a name="l01053"></a>01053 <span class="comment">            }</span>
<a name="l01054"></a>01054 <span class="comment">      }</span>
<a name="l01055"></a>01055 <span class="comment"></span>
<a name="l01056"></a>01056 <span class="comment">      // DO WE NEED THIS???</span>
<a name="l01057"></a>01057 <span class="comment">      //pSoldier-&gt;sTarget = NOWHERE;</span>
<a name="l01058"></a>01058 <span class="comment"></span>
<a name="l01059"></a>01059 <span class="comment">      // make him look in case he turns to face a new direction</span>
<a name="l01060"></a>01060 <span class="comment">      pSoldier-&gt;bNeedToLook = TRUE;</span>
<a name="l01061"></a>01061 <span class="comment"></span>
<a name="l01062"></a>01062 <span class="comment">      // This is here to speed up resolution of interrupts that have already been</span>
<a name="l01063"></a>01063 <span class="comment">      // delayed while AttackingPerson was still set (causing ChangeControl to</span>
<a name="l01064"></a>01064 <span class="comment">      // bail).  Without it, an interrupt would have to wait until next ani frame!</span>
<a name="l01065"></a>01065 <span class="comment">      //if (SwitchTo &gt; -1)</span>
<a name="l01066"></a>01066 <span class="comment">      //  ChangeControl();</span>
<a name="l01067"></a>01067 <span class="comment">      */</span>
<a name="l01068"></a>01068 }
<a name="l01069"></a>01069 
<a name="l01070"></a><a class="code" href="AIMain_8cpp.html#76734f95cd846d8b4ceca998f231cfa0">01070</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#76734f95cd846d8b4ceca998f231cfa0">FreeUpNPCFromLoweringGun</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l01071"></a>01071 {
<a name="l01072"></a>01072       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b762f725b03742451680676278e51b862">AI_ACTION_LOWER_GUN</a> )
<a name="l01073"></a>01073       {
<a name="l01074"></a>01074             <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01075"></a>01075       }
<a name="l01076"></a>01076 }
<a name="l01077"></a>01077 
<a name="l01078"></a><a class="code" href="AIMain_8cpp.html#f36931c881ca02315e0a881d296f5ba8">01078</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#f36931c881ca02315e0a881d296f5ba8">FreeUpNPCFromTurning</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bLook)
<a name="l01079"></a>01079 {
<a name="l01080"></a>01080  
<a name="l01081"></a>01081       <span class="comment">// if NPC is in the process of changing facing, mark him as being done!</span>
<a name="l01082"></a>01082  <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>) &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e9fecf31042005f1ae06517e13309c22">bActionInProgress</a>)
<a name="l01083"></a>01083   {
<a name="l01084"></a>01084 <span class="preprocessor">#ifdef TESTAI</span>
<a name="l01085"></a>01085 <span class="preprocessor"></span>            DebugMsg( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>, DBG_LEVEL_3, 
<a name="l01086"></a>01086                                     <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"FREEUPNPCFROMTURNING: our action %d, desdir %d dir %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d2defbf893cfe6135722921bef9bd94">bDesiredDirection</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a>) );
<a name="l01087"></a>01087 <span class="preprocessor">#endif</span>
<a name="l01088"></a>01088 <span class="preprocessor"></span>
<a name="l01089"></a>01089 
<a name="l01090"></a>01090        <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01091"></a>01091 
<a name="l01092"></a>01092    <span class="keywordflow">if</span> ( bLook )
<a name="l01093"></a>01093     {
<a name="l01094"></a>01094             <span class="comment">//HandleSight(pSoldier,SIGHT_LOOK | SIGHT_RADIO); // no interrupt possible</span>
<a name="l01095"></a>01095     }
<a name="l01096"></a>01096 
<a name="l01097"></a>01097   }
<a name="l01098"></a>01098 }
<a name="l01099"></a>01099 
<a name="l01100"></a>01100 
<a name="l01101"></a><a class="code" href="AIMain_8cpp.html#2ed6d39632fda65e2ea46014e2ad0d76">01101</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#2ed6d39632fda65e2ea46014e2ad0d76">FreeUpNPCFromStanceChange</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l01102"></a>01102 {
<a name="l01103"></a>01103       <span class="comment">// are we/were we doing something?</span>
<a name="l01104"></a>01104       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e9fecf31042005f1ae06517e13309c22">bActionInProgress</a>)
<a name="l01105"></a>01105   {
<a name="l01106"></a>01106             <span class="comment">// check and see if we were changing stance</span>
<a name="l01107"></a>01107             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b0e1477dcf1592283b53b8027ff3ae20a">AI_ACTION_COWER</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6f46584addd5e876d03eef0b47c41003">AI_ACTION_STOP_COWERING</a>)
<a name="l01108"></a>01108             {
<a name="l01109"></a>01109                   <span class="comment">// yes we were - are we finished?</span>
<a name="l01110"></a>01110                   <span class="keywordflow">if</span> ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubHeight == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> )
<a name="l01111"></a>01111                   {
<a name="l01112"></a>01112                         <span class="comment">// yes! Free us up to do other fun things</span>
<a name="l01113"></a>01113                         <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01114"></a>01114                   }
<a name="l01115"></a>01115             }
<a name="l01116"></a>01116       }
<a name="l01117"></a>01117 }
<a name="l01118"></a>01118 
<a name="l01119"></a><a class="code" href="AIMain_8cpp.html#59f9eb61704be305dd8baa7c476a359e">01119</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#59f9eb61704be305dd8baa7c476a359e">FreeUpNPCFromRoofClimb</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l01120"></a>01120 {
<a name="l01121"></a>01121       <span class="comment">// are we/were we doing something?</span>
<a name="l01122"></a>01122       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e9fecf31042005f1ae06517e13309c22">bActionInProgress</a>)
<a name="l01123"></a>01123   {
<a name="l01124"></a>01124             <span class="comment">// check and see if we were climbing</span>
<a name="l01125"></a>01125             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bf0d31a9fac3e900acf35ca5832cd876e">AI_ACTION_CLIMB_ROOF</a>)
<a name="l01126"></a>01126             {
<a name="l01127"></a>01127                   <span class="comment">// yes! Free us up to do other fun things</span>
<a name="l01128"></a>01128                   <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01129"></a>01129             }
<a name="l01130"></a>01130       }
<a name="l01131"></a>01131 }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133 
<a name="l01134"></a>01134 
<a name="l01135"></a>01135 
<a name="l01136"></a><a class="code" href="AIMain_8cpp.html#2d2dfafa627e9e83dd1b60f538138f7e">01136</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l01137"></a>01137 {
<a name="l01138"></a>01138       <span class="comment">// if an action is currently selected</span>
<a name="l01139"></a>01139       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>)
<a name="l01140"></a>01140       {
<a name="l01141"></a>01141             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_MONSTER)
<a name="l01142"></a>01142             {
<a name="l01143"></a>01143 <span class="preprocessor">#ifdef TESTAI</span>
<a name="l01144"></a>01144 <span class="preprocessor"></span>                  DebugMsg( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>, DBG_LEVEL_3, 
<a name="l01145"></a>01145                                     <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Cancelling actiondone: our action %d, desdir %d dir %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d2defbf893cfe6135722921bef9bd94">bDesiredDirection</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a>) );
<a name="l01146"></a>01146 <span class="preprocessor">#endif</span>
<a name="l01147"></a>01147 <span class="preprocessor"></span>            }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149             <span class="comment">// If doing an attack, reset attack busy count and # of bullets</span>
<a name="l01150"></a>01150             <span class="comment">//if ( gTacticalStatus.ubAttackBusyCount )</span>
<a name="l01151"></a>01151             <span class="comment">//{</span>
<a name="l01152"></a>01152             <span class="comment">//    gTacticalStatus.ubAttackBusyCount = 0;</span>
<a name="l01153"></a>01153             <span class="comment">//    DebugMsg( TOPIC_JA2, DBG_LEVEL_3, String( "Setting attack busy count to 0 due to Action Done" ) );</span>
<a name="l01154"></a>01154             <span class="comment">//    pSoldier-&gt;bBulletsLeft = 0;</span>
<a name="l01155"></a>01155             <span class="comment">//}</span>
<a name="l01156"></a>01156 
<a name="l01157"></a>01157             <span class="comment">// cancel any turning &amp; movement by making current settings desired ones</span>
<a name="l01158"></a>01158             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13569e868936f0aabb70ab73640be218">sFinalDestination</a>   = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     <span class="keywordflow">if</span> ( !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#90c338d417f334343a465928692ddb7a">fNoAPToFinishMove</a> )
<a name="l01161"></a>01161     {
<a name="l01162"></a>01162               <a class="code" href="Soldier_01Control_8cpp.html#e90db6b8cf63e148848cf9fe9bbe56cf">EVENT_StopMerc</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> );
<a name="l01163"></a>01163               <a class="code" href="Soldier_01Control_8cpp.html#11fd19e17adc39731d2b3688a028a833">AdjustNoAPToFinishMove</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, FALSE );
<a name="l01164"></a>01164     }
<a name="l01165"></a>01165 
<a name="l01166"></a>01166             <span class="comment">// cancel current action</span>
<a name="l01167"></a>01167             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a>                     = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a>;
<a name="l01168"></a>01168             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a>                               = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l01169"></a>01169             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>              = NOWHERE;
<a name="l01170"></a>01170             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e9fecf31042005f1ae06517e13309c22">bActionInProgress</a>   = FALSE;
<a name="l01171"></a>01171             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#164c7dfcffafdfa1fbaf7b1b61c07472">fDelayedMovement</a>    = FALSE;
<a name="l01172"></a>01172 
<a name="l01173"></a>01173 <span class="comment">/*</span>
<a name="l01174"></a>01174 <span class="comment">            if ( pSoldier-&gt;bLastAction == AI_ACTION_CHANGE_STANCE || pSoldier-&gt;bLastAction == AI_ACTION_COWER || pSoldier-&gt;bLastAction == AI_ACTION_STOP_COWERING )</span>
<a name="l01175"></a>01175 <span class="comment">            {</span>
<a name="l01176"></a>01176 <span class="comment">                  SoldierGotoStationaryStance( pSoldier );</span>
<a name="l01177"></a>01177 <span class="comment">            }</span>
<a name="l01178"></a>01178 <span class="comment">            */</span>
<a name="l01179"></a>01179 
<a name="l01180"></a>01180 
<a name="l01181"></a>01181             <span class="comment">// make sure pathStored is not left TRUE by accident.</span>
<a name="l01182"></a>01182             <span class="comment">// This is possible if we decide on an action that we have no points for</span>
<a name="l01183"></a>01183             <span class="comment">// (but which set pathStored).  The action is retained until next turn,</span>
<a name="l01184"></a>01184             <span class="comment">// although NewDest isn't called.  A newSit. could cancel it before then!</span>
<a name="l01185"></a>01185             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0133c330db71283c8ccf4e4f6dd5a4ad">bPathStored</a> = FALSE;
<a name="l01186"></a>01186       }
<a name="l01187"></a>01187 }
<a name="l01188"></a>01188 
<a name="l01189"></a>01189 
<a name="l01190"></a>01190 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01191"></a>01191 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01192"></a>01192 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01193"></a>01193 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01194"></a>01194 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01195"></a>01195 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01196"></a>01196 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01197"></a>01197 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01198"></a>01198 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01199"></a>01199 
<a name="l01200"></a>01200 <span class="comment">//    O L D    D G    A I    C O D E</span>
<a name="l01201"></a>01201 
<a name="l01202"></a>01202 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01203"></a>01203 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01204"></a>01204 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01205"></a>01205 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01206"></a>01206 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01207"></a>01207 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01208"></a>01208 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01209"></a>01209 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01210"></a>01210 <span class="comment">// ////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 
<a name="l01213"></a>01213 <span class="comment">// GLOBALS:</span>
<a name="l01214"></a>01214 
<a name="l01215"></a><a class="code" href="AIMain_8cpp.html#73a8d5c2a31d1969d497d7daf60b16f3">01215</a> <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> <a class="code" href="AIInternals_8h.html#73a8d5c2a31d1969d497d7daf60b16f3">SkipCoverCheck</a> = FALSE;
<a name="l01216"></a><a class="code" href="AIMain_8cpp.html#579e85ae47114aa344920d58b0324498">01216</a> <a class="code" href="structTHREATTYPE.html">THREATTYPE</a> <a class="code" href="AIInternals_8h.html#579e85ae47114aa344920d58b0324498">Threat</a>[MAXMERCS];
<a name="l01217"></a>01217 
<a name="l01218"></a>01218 
<a name="l01219"></a>01219 <span class="comment">// threat percentage is based on the certainty of opponent knowledge:</span>
<a name="l01220"></a>01220 <span class="comment">// opplist value:        -4  -3  -2  -1 SEEN  1    2   3   4   5</span>
<a name="l01221"></a><a class="code" href="AIMain_8cpp.html#85005394ffd7e285aab862a0184c6457">01221</a> <span class="keywordtype">int</span> <a class="code" href="AIInternals_8h.html#85005394ffd7e285aab862a0184c6457">ThreatPercent</a>[10] = { 20, 40, 60, 80, 25, 100, 90, 75, 60, 45 };
<a name="l01222"></a>01222 
<a name="l01223"></a>01223 
<a name="l01224"></a>01224 
<a name="l01225"></a><a class="code" href="AIMain_8cpp.html#1dc658ff228f7a3273f69cd2a842fb3d">01225</a> <span class="keywordtype">void</span> <a class="code" href="AIInternals_8h.html#1dc658ff228f7a3273f69cd2a842fb3d">NPCDoesAct</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l01226"></a>01226 {
<a name="l01227"></a>01227       DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"NPCDoesAct"</span>);
<a name="l01228"></a>01228 
<a name="l01229"></a>01229       <span class="comment">// if the action is visible and we're in a hidden turnbased mode, go to turnbased</span>
<a name="l01230"></a>01230       <span class="keywordflow">if</span> (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; TURNBASED &amp;&amp; !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6247fbdbad71e877e20dc79b610060b8">AI_ACTION_FIRE_GUN</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b260e54a79dd8e6db573a8216c3a63efc">AI_ACTION_TOSS_PROJECTILE</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bcc74cedcb5afbd32c5b21b1ecc59b9ec">AI_ACTION_KNIFE_MOVE</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b7169eb6a928d5fcf0e201335ea935b1a">AI_ACTION_KNIFE_STAB</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b48a1dee24335dcbf15fd2d883fc6e243">AI_ACTION_THROW_KNIFE</a>) )
<a name="l01231"></a>01231       {
<a name="l01232"></a>01232             <a class="code" href="TeamTurns_8cpp.html#02da951e111db983c8215f4c726bdc65">DisplayHiddenTurnbased</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01233"></a>01233       }
<a name="l01234"></a>01234              
<a name="l01235"></a>01235       <span class="keywordflow">if</span> (<a class="code" href="TeamTurns_8cpp.html#782955f80e251720a735649d4e8a5987">gfHiddenInterrupt</a>)
<a name="l01236"></a>01236       {
<a name="l01237"></a>01237             <a class="code" href="TeamTurns_8cpp.html#53df607eaa81957124edb5cb22743d25">DisplayHiddenInterrupt</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01238"></a>01238       }
<a name="l01239"></a>01239  <span class="comment">//StartInterruptVisually(pSoldier-&gt;ubID);</span>
<a name="l01240"></a>01240  <span class="comment">// *** IAN deleted lots of interrupt related code here to simplify JA2 development</span>
<a name="l01241"></a>01241 
<a name="l01242"></a>01242  <span class="comment">// CJC Feb 18 99: make sure that soldier is not in the middle of a turn due to visual crap to make enemies</span>
<a name="l01243"></a>01243  <span class="comment">// face and point their guns at us</span>
<a name="l01244"></a>01244  <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d2defbf893cfe6135722921bef9bd94">bDesiredDirection</a> != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> )
<a name="l01245"></a>01245  {
<a name="l01246"></a>01246       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d2defbf893cfe6135722921bef9bd94">bDesiredDirection</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a>;
<a name="l01247"></a>01247  }
<a name="l01248"></a>01248 
<a name="l01249"></a>01249       DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"NPCDoesAct done"</span>);
<a name="l01250"></a>01250 }
<a name="l01251"></a>01251 
<a name="l01252"></a>01252 
<a name="l01253"></a>01253 
<a name="l01254"></a><a class="code" href="AIMain_8cpp.html#834ad5f7bf7d38a06631fc0c40de63cb">01254</a> <span class="keywordtype">void</span> <a class="code" href="AIInternals_8h.html#834ad5f7bf7d38a06631fc0c40de63cb">NPCDoesNothing</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l01255"></a>01255 {
<a name="l01256"></a>01256       <span class="comment">// NPC, for whatever reason, did/could not start an action, so end his turn</span>
<a name="l01257"></a>01257       <span class="comment">//pSoldier-&gt;moved = TRUE;</span>
<a name="l01258"></a>01258 
<a name="l01259"></a>01259 <span class="preprocessor">      #ifdef TESTAICONTROL</span>
<a name="l01260"></a>01260 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l01261"></a>01261             {
<a name="l01262"></a>01262                   <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because doing no-action"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l01263"></a>01263             }
<a name="l01264"></a>01264 <span class="preprocessor">      #endif</span>
<a name="l01265"></a>01265 <span class="preprocessor"></span>
<a name="l01266"></a>01266       <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01267"></a>01267 
<a name="l01268"></a>01268       <span class="comment">// *** IAN deleted lots of interrupt related code here to simplify JA2  development</span>
<a name="l01269"></a>01269 }
<a name="l01270"></a>01270 
<a name="l01271"></a>01271 
<a name="l01272"></a>01272 
<a name="l01273"></a>01273 
<a name="l01274"></a><a class="code" href="AIMain_8cpp.html#6cced4c42ca3081db5b89f6a584e549f">01274</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#6cced4c42ca3081db5b89f6a584e549f">CancelAIAction</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubForce)
<a name="l01275"></a>01275 {
<a name="l01276"></a>01276 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l01277"></a>01277 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (SkipCoverCheck)
<a name="l01278"></a>01278       {
<a name="l01279"></a>01279             <a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a> tempstr;
<a name="l01280"></a>01280             sprintf((CHAR *) tempstr, <span class="stringliteral">"CancelAIAction: SkipCoverCheck turned OFF\n"</span>,0 );
<a name="l01281"></a>01281             <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a> (tempstr);
<a name="l01282"></a>01282       }
<a name="l01283"></a>01283 <span class="preprocessor">#endif</span>
<a name="l01284"></a>01284 <span class="preprocessor"></span>
<a name="l01285"></a>01285       <span class="comment">// re-enable cover checking, something is new or something strange happened</span>
<a name="l01286"></a>01286       SkipCoverCheck = FALSE;
<a name="l01287"></a>01287 
<a name="l01288"></a>01288       <span class="comment">// turn off new situation flag to stop this from repeating all the time!</span>
<a name="l01289"></a>01289       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1897f6330181ea58e948eaa23a5fd75c">bNewSituation</a> == IS_NEW_SITUATION )
<a name="l01290"></a>01290       {
<a name="l01291"></a>01291             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1897f6330181ea58e948eaa23a5fd75c">bNewSituation</a> = WAS_NEW_SITUATION;
<a name="l01292"></a>01292       }
<a name="l01293"></a>01293 
<a name="l01294"></a>01294       <span class="comment">// NPCs getting escorted do NOT react to new situations, unless forced!</span>
<a name="l01295"></a>01295       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#bf9485d30ef04e8b908b3614e050c7d0">bUnderEscort</a> &amp;&amp; !ubForce)
<a name="l01296"></a>01296             <span class="keywordflow">return</span>;
<a name="l01297"></a>01297 
<a name="l01298"></a>01298       <span class="comment">// turn off RED/YELLOW status "bypass to Green", to re-check all actions</span>
<a name="l01299"></a>01299       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f72e7e4bdc35542eca5402ce5329de32">bBypassToGreen</a> = FALSE;
<a name="l01300"></a>01300 
<a name="l01301"></a>01301       <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01302"></a>01302 }
<a name="l01303"></a>01303 
<a name="l01304"></a>01304 
<a name="l01305"></a>01305 
<a name="l01306"></a>01306 
<a name="l01307"></a>01307 <span class="comment">/*</span>
<a name="l01308"></a>01308 <span class="comment">void ActionTimeoutExceeded(SOLDIERTYPE *pSoldier, UCHAR alreadyFreedUp)</span>
<a name="l01309"></a>01309 <span class="comment">{</span>
<a name="l01310"></a>01310 <span class="comment"> int cnt;</span>
<a name="l01311"></a>01311 <span class="comment"> UCHAR attackAction = FALSE;</span>
<a name="l01312"></a>01312 <span class="comment"></span>
<a name="l01313"></a>01313 <span class="comment"></span>
<a name="l01314"></a>01314 <span class="comment">#ifdef BETAVERSION</span>
<a name="l01315"></a>01315 <span class="comment"> if (ConvertedMultiSave)</span>
<a name="l01316"></a>01316 <span class="comment">  {</span>
<a name="l01317"></a>01317 <span class="comment">   // re-start real-time NPC action timer</span>
<a name="l01318"></a>01318 <span class="comment">   EnemyTimedOut = FALSE;</span>
<a name="l01319"></a>01319 <span class="comment">   EnemyTimerCnt = ENEMYWAITTOLERANCE;</span>
<a name="l01320"></a>01320 <span class="comment">   return;</span>
<a name="l01321"></a>01321 <span class="comment">  }</span>
<a name="l01322"></a>01322 <span class="comment">#endif</span>
<a name="l01323"></a>01323 <span class="comment"></span>
<a name="l01324"></a>01324 <span class="comment"></span>
<a name="l01325"></a>01325 <span class="comment"> // check if it's a problem with a offensive combat action</span>
<a name="l01326"></a>01326 <span class="comment"> if ((pSoldier-&gt;bAction == AI_ACTION_FIRE_GUN) ||</span>
<a name="l01327"></a>01327 <span class="comment">     (pSoldier-&gt;bAction == AI_ACTION_TOSS_PROJECTILE) ||</span>
<a name="l01328"></a>01328 <span class="comment">     (pSoldier-&gt;bAction == AI_ACTION_KNIFE_STAB))</span>
<a name="l01329"></a>01329 <span class="comment">  {</span>
<a name="l01330"></a>01330 <span class="comment">   // THESE ARE LESS SERIOUS, SINCE THEY LIKELY WON'T REPEAT THEMSELVES</span>
<a name="l01331"></a>01331 <span class="comment">   attackAction = TRUE;</span>
<a name="l01332"></a>01332 <span class="comment">  }</span>
<a name="l01333"></a>01333 <span class="comment">   // OTHERS ARE VERY SERIOUS, SINCE THEY ARE LIKELY TO REPEAT THEMSELVES</span>
<a name="l01334"></a>01334 <span class="comment"></span>
<a name="l01335"></a>01335 <span class="comment"></span>
<a name="l01336"></a>01336 <span class="comment">#ifdef BETAVERSION</span>
<a name="l01337"></a>01337 <span class="comment"> sprintf((CHAR *)tempstr,"ActionInProgress - ERROR: %s's timeout limit exceeded.  Action #%d (%d)",</span>
<a name="l01338"></a>01338 <span class="comment">            pSoldier-&gt;name,pSoldier-&gt;bAction,pSoldier-&gt;usActionData);</span>
<a name="l01339"></a>01339 <span class="comment"></span>
<a name="l01340"></a>01340 <span class="comment">#ifdef RECORDNET</span>
<a name="l01341"></a>01341 <span class="comment"> fprintf(NetDebugFile,"\n%s\n\n",tempstr);</span>
<a name="l01342"></a>01342 <span class="comment">#endif</span>
<a name="l01343"></a>01343 <span class="comment"></span>
<a name="l01344"></a>01344 <span class="comment"> PopMessage(tempstr);</span>
<a name="l01345"></a>01345 <span class="comment"> SaveGame(ERROR_SAVE);</span>
<a name="l01346"></a>01346 <span class="comment">#endif</span>
<a name="l01347"></a>01347 <span class="comment"></span>
<a name="l01348"></a>01348 <span class="comment">#ifdef TESTVERSION</span>
<a name="l01349"></a>01349 <span class="comment"> PopMessage("FULL SOLDIER INFORMATION DUMP COMING UP, BRACE THYSELF!");</span>
<a name="l01350"></a>01350 <span class="comment"> DumpSoldierInfo(pSoldier);</span>
<a name="l01351"></a>01351 <span class="comment">#endif</span>
<a name="l01352"></a>01352 <span class="comment"></span>
<a name="l01353"></a>01353 <span class="comment"></span>
<a name="l01354"></a>01354 <span class="comment"> // re-start real-time NPC action timer</span>
<a name="l01355"></a>01355 <span class="comment"> EnemyTimedOut = FALSE;</span>
<a name="l01356"></a>01356 <span class="comment"> EnemyTimerCnt = ENEMYWAITTOLERANCE;</span>
<a name="l01357"></a>01357 <span class="comment"></span>
<a name="l01358"></a>01358 <span class="comment"> if (attackAction)</span>
<a name="l01359"></a>01359 <span class="comment">  {</span>
<a name="l01360"></a>01360 <span class="comment">#ifdef BETAVERSION</span>
<a name="l01361"></a>01361 <span class="comment">   NameMessage(pSoldier,"will now be freed up from attacking...",2000);</span>
<a name="l01362"></a>01362 <span class="comment">#endif</span>
<a name="l01363"></a>01363 <span class="comment"></span>
<a name="l01364"></a>01364 <span class="comment"></span>
<a name="l01365"></a>01365 <span class="comment">   // free up ONLY players from whom we haven't received an AI_ACTION_DONE yet</span>
<a name="l01366"></a>01366 <span class="comment">   // we can all agree the action is DONE and we can continue...</span>
<a name="l01367"></a>01367 <span class="comment">   // (otherwise they'll be calling FreeUp... twice and get REAL screwed up)</span>
<a name="l01368"></a>01368 <span class="comment">   NetSend.msgType = NET_FREE_UP_ATTACK;</span>
<a name="l01369"></a>01369 <span class="comment">   NetSend.ubID  = pSoldier-&gt;ubID;</span>
<a name="l01370"></a>01370 <span class="comment"></span>
<a name="l01371"></a>01371 <span class="comment">   for (cnt = 0; cnt &lt; MAXPLAYERS; cnt++)</span>
<a name="l01372"></a>01372 <span class="comment">    {</span>
<a name="l01373"></a>01373 <span class="comment">     if ((cnt != Net.pnum) &amp;&amp; Net.player[cnt].playerActive &amp;&amp;</span>
<a name="l01374"></a>01374 <span class="comment">       (Net.player[cnt].actionDone != pSoldier-&gt;ubID))</span>
<a name="l01375"></a>01375 <span class="comment">       SendNetData(cnt);</span>
<a name="l01376"></a>01376 <span class="comment">    }</span>
<a name="l01377"></a>01377 <span class="comment"></span>
<a name="l01378"></a>01378 <span class="comment">   if (!alreadyFreedUp)</span>
<a name="l01379"></a>01379 <span class="comment">     FreeUpManFromAttacking(pSoldier-&gt;ubID,COMMUNICATE);</span>
<a name="l01380"></a>01380 <span class="comment">  }</span>
<a name="l01381"></a>01381 <span class="comment"> else if (pSoldier-&gt;bAction == AI_ACTION_CHANGE_FACING)</span>
<a name="l01382"></a>01382 <span class="comment">  {</span>
<a name="l01383"></a>01383 <span class="comment">#ifdef BETAVERSION</span>
<a name="l01384"></a>01384 <span class="comment">   NameMessage(pSoldier,"will now be freed up from turning...",2000);</span>
<a name="l01385"></a>01385 <span class="comment">#endif</span>
<a name="l01386"></a>01386 <span class="comment"></span>
<a name="l01387"></a>01387 <span class="comment">   // force him to face in the right direction (as long as it's legal)</span>
<a name="l01388"></a>01388 <span class="comment">   if ((pSoldier-&gt;bDesiredDirection &gt;= 1) &amp;&amp; (pSoldier-&gt;bDesiredDirection &lt;= 8))</span>
<a name="l01389"></a>01389 <span class="comment">     pSoldier-&gt;bDirection = pSoldier-&gt;bDesiredDirection;</span>
<a name="l01390"></a>01390 <span class="comment">   else</span>
<a name="l01391"></a>01391 <span class="comment">     pSoldier-&gt;bDesiredDirection = pSoldier-&gt;bDirection;</span>
<a name="l01392"></a>01392 <span class="comment"></span>
<a name="l01393"></a>01393 <span class="comment">   // free up ONLY players from whom we haven't received an AI_ACTION_DONE yet</span>
<a name="l01394"></a>01394 <span class="comment">   // we can all agree the action is DONE and we can continue...</span>
<a name="l01395"></a>01395 <span class="comment">   // (otherwise they'll be calling FreeUp... twice and get REAL screwed up)</span>
<a name="l01396"></a>01396 <span class="comment">   NetSend.msgType    = NET_FREE_UP_TURN;</span>
<a name="l01397"></a>01397 <span class="comment">   NetSend.ubID     = pSoldier-&gt;ubID;</span>
<a name="l01398"></a>01398 <span class="comment">   NetSend.misc_UCHAR = pSoldier-&gt;bDirection;</span>
<a name="l01399"></a>01399 <span class="comment">   NetSend.answer     = pSoldier-&gt;bDesiredDirection;</span>
<a name="l01400"></a>01400 <span class="comment"></span>
<a name="l01401"></a>01401 <span class="comment">   for (cnt = 0; cnt &lt; MAXPLAYERS; cnt++)</span>
<a name="l01402"></a>01402 <span class="comment">    {</span>
<a name="l01403"></a>01403 <span class="comment">     if ((cnt != Net.pnum) &amp;&amp; Net.player[cnt].playerActive &amp;&amp;</span>
<a name="l01404"></a>01404 <span class="comment">       (Net.player[cnt].actionDone != pSoldier-&gt;ubID))</span>
<a name="l01405"></a>01405 <span class="comment">       SendNetData(cnt);</span>
<a name="l01406"></a>01406 <span class="comment">    }</span>
<a name="l01407"></a>01407 <span class="comment"></span>
<a name="l01408"></a>01408 <span class="comment">   if (!alreadyFreedUp)</span>
<a name="l01409"></a>01409 <span class="comment">     // this calls FreeUpManFromTurning()</span>
<a name="l01410"></a>01410 <span class="comment">     NowFacingRightWay(pSoldier,COMMUNICATE);</span>
<a name="l01411"></a>01411 <span class="comment">  }</span>
<a name="l01412"></a>01412 <span class="comment"> else</span>
<a name="l01413"></a>01413 <span class="comment">  {</span>
<a name="l01414"></a>01414 <span class="comment">#ifdef BETAVERSION</span>
<a name="l01415"></a>01415 <span class="comment">   NameMessage(pSoldier,"is having the remainder of his turn canceled...",1000);</span>
<a name="l01416"></a>01416 <span class="comment">#endif</span>
<a name="l01417"></a>01417 <span class="comment"></span>
<a name="l01418"></a>01418 <span class="comment">   // cancel the remainder of the offender's turn as a penalty!</span>
<a name="l01419"></a>01419 <span class="comment">   pSoldier-&gt;bActionPoints = 0;</span>
<a name="l01420"></a>01420 <span class="comment">   NPCDoesNothing(pSoldier);</span>
<a name="l01421"></a>01421 <span class="comment">  }</span>
<a name="l01422"></a>01422 <span class="comment"></span>
<a name="l01423"></a>01423 <span class="comment"></span>
<a name="l01424"></a>01424 <span class="comment"> // cancel whatever the current action is, force this even for escorted NPCs</span>
<a name="l01425"></a>01425 <span class="comment"> CancelAIAction(pSoldier,FORCE);</span>
<a name="l01426"></a>01426 <span class="comment"></span>
<a name="l01427"></a>01427 <span class="comment"></span>
<a name="l01428"></a>01428 <span class="comment"> // reset the timeout counter for next time</span>
<a name="l01429"></a>01429 <span class="comment"> pSoldier-&gt;bActionTimeout = 0;</span>
<a name="l01430"></a>01430 <span class="comment">}</span>
<a name="l01431"></a>01431 <span class="comment">*/</span>
<a name="l01432"></a>01432 
<a name="l01433"></a>01433 
<a name="l01434"></a>01434 
<a name="l01435"></a>01435 
<a name="l01436"></a><a class="code" href="AIMain_8cpp.html#b57d109dc74dab8daf5900de0663f14e">01436</a> <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> <a class="code" href="ai_8h.html#b57d109dc74dab8daf5900de0663f14e">ActionInProgress</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l01437"></a>01437 {
<a name="l01438"></a>01438  <span class="comment">// if NPC has a desired destination, but isn't currently going there</span>
<a name="l01439"></a>01439  <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13569e868936f0aabb70ab73640be218">sFinalDestination</a> != NOWHERE) &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6329e2759db6e8b30ee233cab423588e">sDestination</a> != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13569e868936f0aabb70ab73640be218">sFinalDestination</a>))
<a name="l01440"></a>01440   {
<a name="l01441"></a>01441    <span class="comment">// return success (TRUE) if we successfully resume the movement</span>
<a name="l01442"></a>01442    <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#59af503b47255d14b00bac19f80c1f68">TryToResumeMovement</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13569e868936f0aabb70ab73640be218">sFinalDestination</a>));
<a name="l01443"></a>01443   }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445 
<a name="l01446"></a>01446  <span class="comment">// this here should never happen, but it seems to (turns sometimes hang!)</span>
<a name="l01447"></a>01447  <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>) &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d2defbf893cfe6135722921bef9bd94">bDesiredDirection</a> != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>))
<a name="l01448"></a>01448   {
<a name="l01449"></a>01449 <span class="preprocessor">#ifdef TESTVERSION</span>
<a name="l01450"></a>01450 <span class="preprocessor"></span>   PopMessage(<span class="stringliteral">"ActionInProgress: WARNING - CONTINUING FACING CHANGE..."</span>);
<a name="l01451"></a>01451 <span class="preprocessor">#endif</span>
<a name="l01452"></a>01452 <span class="preprocessor"></span>
<a name="l01453"></a>01453    <span class="comment">// don't try to pay any more APs for this, it was paid for once already!</span>
<a name="l01454"></a>01454    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d2defbf893cfe6135722921bef9bd94">bDesiredDirection</a> = (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;   <span class="comment">// turn to face direction in actionData</span>
<a name="l01455"></a>01455    <span class="keywordflow">return</span>(TRUE);
<a name="l01456"></a>01456   }
<a name="l01457"></a>01457 
<a name="l01458"></a>01458 
<a name="l01459"></a>01459   <span class="comment">// needs more time to complete action</span>
<a name="l01460"></a>01460   <span class="keywordflow">return</span>(TRUE);
<a name="l01461"></a>01461 }
<a name="l01462"></a>01462 
<a name="l01463"></a>01463 
<a name="l01464"></a>01464 
<a name="l01465"></a>01465 
<a name="l01466"></a>01466 
<a name="l01467"></a>01467 <span class="comment">/*</span>
<a name="l01468"></a>01468 <span class="comment">void RestoreMarkedMines()</span>
<a name="l01469"></a>01469 <span class="comment">{</span>
<a name="l01470"></a>01470 <span class="comment"> int gridno;</span>
<a name="l01471"></a>01471 <span class="comment"></span>
<a name="l01472"></a>01472 <span class="comment"> // all tiles marked with the special NPC mine cost value must be restored</span>
<a name="l01473"></a>01473 <span class="comment"> for (gridno = 0; gridno &lt; GRIDSIZE; gridno++)</span>
<a name="l01474"></a>01474 <span class="comment">  {</span>
<a name="l01475"></a>01475 <span class="comment">   if (GridCost[gridno] == NPCMINECOST)</span>
<a name="l01476"></a>01476 <span class="comment">    {</span>
<a name="l01477"></a>01477 <span class="comment">     GridCost[gridno] = BackupGridCost[gridno];</span>
<a name="l01478"></a>01478 <span class="comment"></span>
<a name="l01479"></a>01479 <span class="comment">#ifdef TESTMINEMARKING</span>
<a name="l01480"></a>01480 <span class="comment">     fprintf(NetDebugFile,"\tRestoring marked mine at gridno %d back to gridCost %d\n",gridno,BackupGridCost[gridno]);</span>
<a name="l01481"></a>01481 <span class="comment">#endif</span>
<a name="l01482"></a>01482 <span class="comment">    }</span>
<a name="l01483"></a>01483 <span class="comment">  }</span>
<a name="l01484"></a>01484 <span class="comment"></span>
<a name="l01485"></a>01485 <span class="comment"> MarkedNPCMines = FALSE;</span>
<a name="l01486"></a>01486 <span class="comment">}</span>
<a name="l01487"></a>01487 <span class="comment"></span>
<a name="l01488"></a>01488 <span class="comment"></span>
<a name="l01489"></a>01489 <span class="comment"></span>
<a name="l01490"></a>01490 <span class="comment">void MarkDetectableMines(SOLDIERTYPE *pSoldier)</span>
<a name="l01491"></a>01491 <span class="comment">{</span>
<a name="l01492"></a>01492 <span class="comment"> int gridno,detectLevel;</span>
<a name="l01493"></a>01493 <span class="comment"> GRIDINFO *gpSoldier;</span>
<a name="l01494"></a>01494 <span class="comment"></span>
<a name="l01495"></a>01495 <span class="comment"></span>
<a name="l01496"></a>01496 <span class="comment"> // this should happen, means we missed a clean-up cycle last time!</span>
<a name="l01497"></a>01497 <span class="comment"> if (MarkedNPCMines)</span>
<a name="l01498"></a>01498 <span class="comment">  {</span>
<a name="l01499"></a>01499 <span class="comment">#ifdef BETAVERSION</span>
<a name="l01500"></a>01500 <span class="comment">   sprintf((CHAR *)tempstr,"MarkDetectableMines: ERROR - mines still marked!  Guynum %d",pSoldier-&gt;ubID);</span>
<a name="l01501"></a>01501 <span class="comment"></span>
<a name="l01502"></a>01502 <span class="comment">#ifdef RECORDNET</span>
<a name="l01503"></a>01503 <span class="comment">   fprintf(NetDebugFile,"\n\t%s\n\n",tempstr);</span>
<a name="l01504"></a>01504 <span class="comment">#endif</span>
<a name="l01505"></a>01505 <span class="comment"></span>
<a name="l01506"></a>01506 <span class="comment">   PopMessage(tempstr);</span>
<a name="l01507"></a>01507 <span class="comment">#endif</span>
<a name="l01508"></a>01508 <span class="comment"></span>
<a name="l01509"></a>01509 <span class="comment">   RestoreMarkedMines();</span>
<a name="l01510"></a>01510 <span class="comment">  }</span>
<a name="l01511"></a>01511 <span class="comment"></span>
<a name="l01512"></a>01512 <span class="comment"></span>
<a name="l01513"></a>01513 <span class="comment"> // make a backup of the current gridcosts</span>
<a name="l01514"></a>01514 <span class="comment"> memcpy(BackupGridCost,GridCost,sizeof(GridCost));</span>
<a name="l01515"></a>01515 <span class="comment"></span>
<a name="l01516"></a>01516 <span class="comment"> // calculate what "level" of mines we are able to detect</span>
<a name="l01517"></a>01517 <span class="comment"> detectLevel = CalcMineDetectLevel(pSoldier);</span>
<a name="l01518"></a>01518 <span class="comment"></span>
<a name="l01519"></a>01519 <span class="comment"></span>
<a name="l01520"></a>01520 <span class="comment"> // check every tile, looking for BURIED mines only</span>
<a name="l01521"></a>01521 <span class="comment"> for (gridno = 0,gpSoldier = &amp;Grid[0]; gridno &lt; GRIDSIZE; gridno++,gpSoldier++)</span>
<a name="l01522"></a>01522 <span class="comment">  {</span>
<a name="l01523"></a>01523 <span class="comment">   // if there's a valid object there, and it is still "buried"</span>
<a name="l01524"></a>01524 <span class="comment">   if ((gpSoldier-&gt;object &lt; 255) &amp;&amp;</span>
<a name="l01525"></a>01525 <span class="comment">       (ObjList[gpSoldier-&gt;object].visible == BURIED) &amp;&amp;</span>
<a name="l01526"></a>01526 <span class="comment">       (ObjList[gpSoldier-&gt;object].item == MINE))</span>
<a name="l01527"></a>01527 <span class="comment">    {</span>
<a name="l01528"></a>01528 <span class="comment">     // are we bright enough to detect it (should we get there) ?</span>
<a name="l01529"></a>01529 <span class="comment">     if (detectLevel &gt;= ObjList[gpSoldier-&gt;object].trap)</span>
<a name="l01530"></a>01530 <span class="comment">      {</span>
<a name="l01531"></a>01531 <span class="comment">       // bingo!  Mark it as "unpassable" for the purposes of the path AI</span>
<a name="l01532"></a>01532 <span class="comment">       GridCost[gridno] = NPCMINECOST;</span>
<a name="l01533"></a>01533 <span class="comment">       MarkedNPCMines = TRUE;</span>
<a name="l01534"></a>01534 <span class="comment"></span>
<a name="l01535"></a>01535 <span class="comment">#ifdef TESTMINEMARKING</span>
<a name="l01536"></a>01536 <span class="comment">       fprintf(NetDebugFile,"\tNPC %d, dtctLvl %d, marking mine at gridno %d, gridCost was %d\n",pSoldier-&gt;ubID,detectLevel,gridno,BackupGridCost[gridno]);</span>
<a name="l01537"></a>01537 <span class="comment">#endif</span>
<a name="l01538"></a>01538 <span class="comment">      }</span>
<a name="l01539"></a>01539 <span class="comment">    }</span>
<a name="l01540"></a>01540 <span class="comment">  }</span>
<a name="l01541"></a>01541 <span class="comment">}</span>
<a name="l01542"></a>01542 <span class="comment"></span>
<a name="l01543"></a>01543 <span class="comment">*/</span>
<a name="l01544"></a>01544 
<a name="l01545"></a>01545 
<a name="l01546"></a>01546 
<a name="l01547"></a>01547 
<a name="l01548"></a><a class="code" href="AIMain_8cpp.html#b74f0a00fbbdbb3d888d7ad7f5a65466">01548</a> <span class="keywordtype">void</span> <a class="code" href="AIMain_8cpp.html#b74f0a00fbbdbb3d888d7ad7f5a65466">TurnBasedHandleNPCAI</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l01549"></a>01549 {
<a name="l01550"></a>01550 
<a name="l01551"></a>01551 
<a name="l01552"></a>01552 <span class="comment">/*</span>
<a name="l01553"></a>01553 <span class="comment"> if (Status.gamePaused)</span>
<a name="l01554"></a>01554 <span class="comment">  {</span>
<a name="l01555"></a>01555 <span class="comment">#ifdef DEBUGBUSY</span>
<a name="l01556"></a>01556 <span class="comment">   DebugAI("HandleManAI - Skipping %d, the game is paused\n",pSoldier-&gt;ubID);</span>
<a name="l01557"></a>01557 <span class="comment">#endif</span>
<a name="l01558"></a>01558 <span class="comment"></span>
<a name="l01559"></a>01559 <span class="comment">   return;</span>
<a name="l01560"></a>01560 <span class="comment">  }</span>
<a name="l01561"></a>01561 <span class="comment">//</span>
<a name="l01562"></a>01562 <span class="comment"></span>
<a name="l01563"></a>01563 <span class="comment"> // If man is inactive/at base/dead/unconscious</span>
<a name="l01564"></a>01564 <span class="comment"> if (!pSoldier-&gt;bActive || !pSoldier-&gt;bInSector || (pSoldier-&gt;bLife &lt; OKLIFE))</span>
<a name="l01565"></a>01565 <span class="comment">  {</span>
<a name="l01566"></a>01566 <span class="comment">#ifdef DEBUGDECISIONS</span>
<a name="l01567"></a>01567 <span class="comment">   AINumMessage("HandleManAI - Unavailable man, skipping guy#",pSoldier-&gt;ubID);</span>
<a name="l01568"></a>01568 <span class="comment">#endif</span>
<a name="l01569"></a>01569 <span class="comment"></span>
<a name="l01570"></a>01570 <span class="comment">   NPCDoesNothing(pSoldier);</span>
<a name="l01571"></a>01571 <span class="comment">   return;</span>
<a name="l01572"></a>01572 <span class="comment">  }</span>
<a name="l01573"></a>01573 <span class="comment"></span>
<a name="l01574"></a>01574 <span class="comment"> if (PTR_CIVILIAN &amp;&amp; pSoldier-&gt;service &amp;&amp;</span>
<a name="l01575"></a>01575 <span class="comment">     (pSoldier-&gt;bNeutral || MedicsMissionIsEscort(pSoldier)))</span>
<a name="l01576"></a>01576 <span class="comment">  {</span>
<a name="l01577"></a>01577 <span class="comment">#ifdef DEBUGDECISIONS</span>
<a name="l01578"></a>01578 <span class="comment">   AINumMessage("HandleManAI - Civilian is being serviced, skipping guy#",pSoldier-&gt;ubID);</span>
<a name="l01579"></a>01579 <span class="comment">#endif</span>
<a name="l01580"></a>01580 <span class="comment"></span>
<a name="l01581"></a>01581 <span class="comment">   NPCDoesNothing(pSoldier);</span>
<a name="l01582"></a>01582 <span class="comment">   return;</span>
<a name="l01583"></a>01583 <span class="comment">  }</span>
<a name="l01584"></a>01584 <span class="comment">*/</span>
<a name="l01585"></a>01585 
<a name="l01586"></a>01586 
<a name="l01587"></a>01587 
<a name="l01588"></a>01588  <span class="comment">/*</span>
<a name="l01589"></a>01589 <span class="comment"> anim = pSoldier-&gt;anitype[pSoldier-&gt;anim];</span>
<a name="l01590"></a>01590 <span class="comment"></span>
<a name="l01591"></a>01591 <span class="comment"> // If man is down on the ground</span>
<a name="l01592"></a>01592 <span class="comment"> if (anim &lt; BREATHING)</span>
<a name="l01593"></a>01593 <span class="comment">  {</span>
<a name="l01594"></a>01594 <span class="comment">   // if he lacks the breath, or APs to get up this turn (life checked above)</span>
<a name="l01595"></a>01595 <span class="comment">   // OR... (new June 13/96 Ian) he's getting first aid...</span>
<a name="l01596"></a>01596 <span class="comment">   if ((pSoldier-&gt;bBreath &lt; OKBREATH) || (pSoldier-&gt;bActionPoints &lt; (AP_GET_UP + AP_ROLL_OVER))</span>
<a name="l01597"></a>01597 <span class="comment">       || pSoldier-&gt;service)</span>
<a name="l01598"></a>01598 <span class="comment">    {</span>
<a name="l01599"></a>01599 <span class="comment">#ifdef RECORDNET</span>
<a name="l01600"></a>01600 <span class="comment">     fprintf(NetDebugFile,"\tAI: %d can't get up (breath %d, AP %d), ending his turn\n",</span>
<a name="l01601"></a>01601 <span class="comment">            pSoldier-&gt;ubID,pSoldier-&gt;bBreath,pSoldier-&gt;bActionPoints);</span>
<a name="l01602"></a>01602 <span class="comment">#endif</span>
<a name="l01603"></a>01603 <span class="comment">#ifdef DEBUGDECISIONS</span>
<a name="l01604"></a>01604 <span class="comment">     AINumMessage("HandleManAI - CAN'T GET UP, skipping guy #",pSoldier-&gt;ubID);</span>
<a name="l01605"></a>01605 <span class="comment">#endif</span>
<a name="l01606"></a>01606 <span class="comment"></span>
<a name="l01607"></a>01607 <span class="comment">     NPCDoesNothing(pSoldier);</span>
<a name="l01608"></a>01608 <span class="comment">     return;</span>
<a name="l01609"></a>01609 <span class="comment">    }</span>
<a name="l01610"></a>01610 <span class="comment">   else</span>
<a name="l01611"></a>01611 <span class="comment">    {</span>
<a name="l01612"></a>01612 <span class="comment">     // wait until he gets up first, only then worry about deciding his AI</span>
<a name="l01613"></a>01613 <span class="comment"></span>
<a name="l01614"></a>01614 <span class="comment">#ifdef RECORDNET</span>
<a name="l01615"></a>01615 <span class="comment">     fprintf(NetDebugFile,"\tAI: waiting for %d to GET UP (breath %d, AP %d)\n",</span>
<a name="l01616"></a>01616 <span class="comment">            pSoldier-&gt;ubID,pSoldier-&gt;bBreath,pSoldier-&gt;bActionPoints);</span>
<a name="l01617"></a>01617 <span class="comment">#endif</span>
<a name="l01618"></a>01618 <span class="comment"></span>
<a name="l01619"></a>01619 <span class="comment">#ifdef DEBUGBUSY</span>
<a name="l01620"></a>01620 <span class="comment">     AINumMessage("HandleManAI - About to get up, skipping guy#",pSoldier-&gt;ubID);</span>
<a name="l01621"></a>01621 <span class="comment">#endif</span>
<a name="l01622"></a>01622 <span class="comment"></span>
<a name="l01623"></a>01623 <span class="comment">     return;</span>
<a name="l01624"></a>01624 <span class="comment">    }</span>
<a name="l01625"></a>01625 <span class="comment">  }</span>
<a name="l01626"></a>01626 <span class="comment"></span>
<a name="l01627"></a>01627 <span class="comment"></span>
<a name="l01628"></a>01628 <span class="comment"> // if NPC's has been forced to stop by an opponent's interrupt or similar</span>
<a name="l01629"></a>01629 <span class="comment"> if (pSoldier-&gt;forcedToStop)</span>
<a name="l01630"></a>01630 <span class="comment">  {</span>
<a name="l01631"></a>01631 <span class="comment">#ifdef DEBUGBUSY</span>
<a name="l01632"></a>01632 <span class="comment">   AINumMessage("HandleManAI - Forced to stop, skipping guy #",pSoldier-&gt;ubID);</span>
<a name="l01633"></a>01633 <span class="comment">#endif</span>
<a name="l01634"></a>01634 <span class="comment"></span>
<a name="l01635"></a>01635 <span class="comment">   return;</span>
<a name="l01636"></a>01636 <span class="comment">  }</span>
<a name="l01637"></a>01637 <span class="comment"></span>
<a name="l01638"></a>01638 <span class="comment"> // if we are still in the midst in an uninterruptable animation</span>
<a name="l01639"></a>01639 <span class="comment"> if (!AnimControl[anim].interruptable)</span>
<a name="l01640"></a>01640 <span class="comment">  {</span>
<a name="l01641"></a>01641 <span class="comment">#ifdef DEBUGBUSY</span>
<a name="l01642"></a>01642 <span class="comment">   AINumMessage("HandleManAI - uninterruptable animation, skipping guy #",pSoldier-&gt;ubID);</span>
<a name="l01643"></a>01643 <span class="comment">#endif</span>
<a name="l01644"></a>01644 <span class="comment"></span>
<a name="l01645"></a>01645 <span class="comment">   return;      // wait a while, let the animation finish first</span>
<a name="l01646"></a>01646 <span class="comment">  }</span>
<a name="l01647"></a>01647 <span class="comment"></span>
<a name="l01648"></a>01648 <span class="comment">*/</span>
<a name="l01649"></a>01649 
<a name="l01650"></a>01650       <span class="comment">// yikes, this shouldn't occur! we should be trying to finish our move!</span>
<a name="l01651"></a>01651       <span class="comment">// pSoldier-&gt;fNoAPToFinishMove = FALSE;</span>
<a name="l01652"></a>01652 
<a name="l01653"></a>01653  <span class="comment">// unless in mid-move, get an up-to-date alert status for this guy</span>
<a name="l01654"></a>01654       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1de17670f16fd40a3d4d8ea1fd9c09a2">bStopped</a>)
<a name="l01655"></a>01655       {
<a name="l01656"></a>01656             <span class="comment">// if active team is waiting for oppChanceToDecide, that means we have NOT</span>
<a name="l01657"></a>01657             <span class="comment">// had a chance to go through NewSelectedNPC(), so do the refresh here</span>
<a name="l01658"></a>01658             <span class="comment">/* </span>
<a name="l01659"></a>01659 <span class="comment">            ???</span>
<a name="l01660"></a>01660 <span class="comment">            if (gTacticalStatus.team[Net.turnActive].allowOppChanceToDecide)</span>
<a name="l01661"></a>01661 <span class="comment">            {</span>
<a name="l01662"></a>01662 <span class="comment">                  // if mines are still marked (this could happen if we also control the</span>
<a name="l01663"></a>01663 <span class="comment">                  // active team that's potentially BEING interrupted), unmark them</span>
<a name="l01664"></a>01664 <span class="comment">                  //RestoreMarkedMines();</span>
<a name="l01665"></a>01665 <span class="comment"></span>
<a name="l01666"></a>01666 <span class="comment">                  RefreshAI(pSoldier);</span>
<a name="l01667"></a>01667 <span class="comment">            }</span>
<a name="l01668"></a>01668 <span class="comment">            else</span>
<a name="l01669"></a>01669 <span class="comment">            {</span>
<a name="l01670"></a>01670 <span class="comment">                  DecideAlertStatus(pSoldier);</span>
<a name="l01671"></a>01671 <span class="comment">            }</span>
<a name="l01672"></a>01672 <span class="comment">            */</span>
<a name="l01673"></a>01673   }
<a name="l01674"></a>01674 
<a name="l01675"></a>01675 <span class="comment">/*</span>
<a name="l01676"></a>01676 <span class="comment">      // move this clause outside of the function...</span>
<a name="l01677"></a>01677 <span class="comment">      if (pSoldier-&gt;bNewSituation)</span>
<a name="l01678"></a>01678 <span class="comment">            // don't force, don't want escorted mercs reacting to new opponents, etc.</span>
<a name="l01679"></a>01679 <span class="comment">            CancelAIAction(pSoldier,DONTFORCE);</span>
<a name="l01680"></a>01680 <span class="comment"></span>
<a name="l01681"></a>01681 <span class="comment">*/</span>
<a name="l01682"></a>01682 
<a name="l01683"></a>01683 
<a name="l01684"></a>01684  <span class="comment">/*</span>
<a name="l01685"></a>01685 <span class="comment"> if (!pSoldier-&gt;stopped)</span>
<a name="l01686"></a>01686 <span class="comment">  {</span>
<a name="l01687"></a>01687 <span class="comment">#ifdef DEBUGBUSY</span>
<a name="l01688"></a>01688 <span class="comment">   AINumMessage("HandleManAI - Moving, skipping guy#",pSoldier-&gt;ubID);</span>
<a name="l01689"></a>01689 <span class="comment">#endif</span>
<a name="l01690"></a>01690 <span class="comment"></span>
<a name="l01691"></a>01691 <span class="comment">   return;</span>
<a name="l01692"></a>01692 <span class="comment">  }</span>
<a name="l01693"></a>01693 <span class="comment">*/</span>
<a name="l01694"></a>01694 
<a name="l01695"></a>01695 
<a name="l01696"></a>01696 
<a name="l01697"></a>01697       <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>) &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e9fecf31042005f1ae06517e13309c22">bActionInProgress</a>)
<a name="l01698"></a>01698       {
<a name="l01699"></a>01699 <span class="comment">/*</span>
<a name="l01700"></a>01700 <span class="comment">                  if (pSoldier-&gt;bAction == AI_ACTION_RANDOM_PATROL)</span>
<a name="l01701"></a>01701 <span class="comment">                  {</span>
<a name="l01702"></a>01702 <span class="comment">                        if (pSoldier-&gt;usPathIndex == pSoldier-&gt;usPathDataSize)</span>
<a name="l01703"></a>01703 <span class="comment">                        //if (pSoldier-&gt;usActionData == pSoldier-&gt;sGridNo )</span>
<a name="l01704"></a>01704 <span class="comment">                        //(IC?) if (pSoldier-&gt;bAction == AI_ACTION_RANDOM_PATROL &amp;&amp; ( pSoldier-&gt;usPathIndex == pSoldier-&gt;usPathDataSize ) )</span>
<a name="l01705"></a>01705 <span class="comment">                        //(old?) if (pSoldier-&gt;bAction == AI_ACTION_RANDOM_PATROL &amp;&amp; ( pSoldier-&gt;usActionData == pSoldier-&gt;sGridNo ) )</span>
<a name="l01706"></a>01706 <span class="comment">                        {</span>
<a name="l01707"></a>01707 <span class="comment">      #ifdef TESTAI</span>
<a name="l01708"></a>01708 <span class="comment">                              DebugMsg( TOPIC_JA2AI, DBG_LEVEL_0, String("OPPONENT %d REACHES DEST - ACTION DONE",pSoldier-&gt;ubID ) );</span>
<a name="l01709"></a>01709 <span class="comment">      #endif</span>
<a name="l01710"></a>01710 <span class="comment">                              ActionDone(pSoldier);</span>
<a name="l01711"></a>01711 <span class="comment">                        }</span>
<a name="l01712"></a>01712 <span class="comment"></span>
<a name="l01713"></a>01713 <span class="comment">                        //*** TRICK- TAKE INTO ACCOUNT PAUSED FOR NO TIME ( FOR NOW )</span>
<a name="l01714"></a>01714 <span class="comment">                        if (pSoldier-&gt;fNoAPToFinishMove)</span>
<a name="l01715"></a>01715 <span class="comment">                        //if (pSoldier-&gt;bAction == AI_ACTION_RANDOM_PATROL &amp;&amp; pSoldier-&gt;fNoAPToFinishMove)</span>
<a name="l01716"></a>01716 <span class="comment">                        {</span>
<a name="l01717"></a>01717 <span class="comment">                              // OK, we have a move to finish...</span>
<a name="l01718"></a>01718 <span class="comment"></span>
<a name="l01719"></a>01719 <span class="comment">      #ifdef TESTAI</span>
<a name="l01720"></a>01720 <span class="comment">                              DebugMsg( TOPIC_JA2AI, DBG_LEVEL_0, String("GONNA TRY TO CONTINUE PATH FOR %d", pSoldier-&gt;ubID ) );</span>
<a name="l01721"></a>01721 <span class="comment">      #endif</span>
<a name="l01722"></a>01722 <span class="comment"></span>
<a name="l01723"></a>01723 <span class="comment">                              SoldierTriesToContinueAlongPath(pSoldier);</span>
<a name="l01724"></a>01724 <span class="comment"></span>
<a name="l01725"></a>01725 <span class="comment">                              // since we just gave up on our action due to running out of points, better end our turn</span>
<a name="l01726"></a>01726 <span class="comment">                              //EndAIGuysTurn(pSoldier);</span>
<a name="l01727"></a>01727 <span class="comment">                        }</span>
<a name="l01728"></a>01728 <span class="comment">                  }</span>
<a name="l01729"></a>01729 <span class="comment">*/</span>
<a name="l01730"></a>01730 
<a name="l01731"></a>01731    <span class="comment">// if action should remain in progress</span>
<a name="l01732"></a>01732             <span class="keywordflow">if</span> (<a class="code" href="ai_8h.html#b57d109dc74dab8daf5900de0663f14e">ActionInProgress</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>))
<a name="l01733"></a>01733             {
<a name="l01734"></a>01734 <span class="preprocessor">                  #ifdef DEBUGBUSY</span>
<a name="l01735"></a>01735 <span class="preprocessor"></span>                        <a class="code" href="AIUtils_8cpp.html#88d13d659f1890049d17af096cc37432">AINumMessage</a>(<span class="stringliteral">"Busy with action, skipping guy#"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>);
<a name="l01736"></a>01736 <span class="preprocessor">                  #endif</span>
<a name="l01737"></a>01737 <span class="preprocessor"></span>
<a name="l01738"></a>01738                   <span class="comment">// let it continue</span>
<a name="l01739"></a>01739                   <span class="keywordflow">return</span>;
<a name="l01740"></a>01740             }
<a name="l01741"></a>01741       }
<a name="l01742"></a>01742 
<a name="l01743"></a>01743 
<a name="l01744"></a>01744 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l01745"></a>01745 <span class="preprocessor"></span>      <a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a> tempstr;
<a name="l01746"></a>01746       sprintf((CHAR *) tempstr, <span class="stringliteral">"HandleManAI - DECIDING for guynum %d(%s) at gridno %d, APs %d\n"</span>,
<a name="l01747"></a>01747             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> );
<a name="l01748"></a>01748       <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a> ( tempstr );
<a name="l01749"></a>01749 <span class="preprocessor">#endif</span>
<a name="l01750"></a>01750 <span class="preprocessor"></span>
<a name="l01751"></a>01751 
<a name="l01752"></a>01752       <span class="comment">// if man has nothing to do</span>
<a name="l01753"></a>01753       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>)
<a name="l01754"></a>01754       {
<a name="l01755"></a>01755             <span class="comment">// make sure this flag is turned off (it already should be!)</span>
<a name="l01756"></a>01756             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e9fecf31042005f1ae06517e13309c22">bActionInProgress</a> = FALSE;
<a name="l01757"></a>01757 
<a name="l01758"></a>01758             <span class="comment">// Since we're NEVER going to "continue" along an old path at this point,</span>
<a name="l01759"></a>01759             <span class="comment">// then it would be nice place to reinitialize "pathStored" flag for</span>
<a name="l01760"></a>01760             <span class="comment">// insurance purposes.</span>
<a name="l01761"></a>01761             <span class="comment">//</span>
<a name="l01762"></a>01762             <span class="comment">// The "pathStored" variable controls whether it's necessary to call</span>
<a name="l01763"></a>01763             <span class="comment">// findNewPath() after you've called NewDest(). Since the AI calls</span>
<a name="l01764"></a>01764             <span class="comment">// findNewPath() itself, a speed gain can be obtained by avoiding</span>
<a name="l01765"></a>01765             <span class="comment">// redundancy.</span>
<a name="l01766"></a>01766             <span class="comment">//</span>
<a name="l01767"></a>01767             <span class="comment">// The "normal" way for pathStored to be reset is inside</span>
<a name="l01768"></a>01768             <span class="comment">// SetNewCourse() [which gets called after NewDest()].</span>
<a name="l01769"></a>01769             <span class="comment">//</span>
<a name="l01770"></a>01770             <span class="comment">// The only reason we would NEED to reinitialize it here is if I've</span>
<a name="l01771"></a>01771             <span class="comment">// incorrectly set pathStored to TRUE in a process that doesn't end up</span>
<a name="l01772"></a>01772             <span class="comment">// calling NewDest()</span>
<a name="l01773"></a>01773             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0133c330db71283c8ccf4e4f6dd5a4ad">bPathStored</a> = FALSE;
<a name="l01774"></a>01774 
<a name="l01775"></a>01775             <span class="comment">// decide on the next action</span>
<a name="l01776"></a>01776             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>)
<a name="l01777"></a>01777             {
<a name="l01778"></a>01778                   <span class="comment">// do the next thing we have to do...</span>
<a name="l01779"></a>01779                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b476d7b194a22733be5841a8af2ccde4d">AI_ACTION_END_COWER_AND_MOVE</a> )
<a name="l01780"></a>01780                   {
<a name="l01781"></a>01781                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_COWERING )
<a name="l01782"></a>01782                         {
<a name="l01783"></a>01783                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6f46584addd5e876d03eef0b47c41003">AI_ACTION_STOP_COWERING</a>;
<a name="l01784"></a>01784                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_STAND;
<a name="l01785"></a>01785                         }
<a name="l01786"></a>01786                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight &lt; ANIM_STAND )
<a name="l01787"></a>01787                         {
<a name="l01788"></a>01788                               <span class="comment">// stand up!</span>
<a name="l01789"></a>01789                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a>;
<a name="l01790"></a>01790                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_STAND;
<a name="l01791"></a>01791                         }
<a name="l01792"></a>01792                         <span class="keywordflow">else</span>
<a name="l01793"></a>01793                         {
<a name="l01794"></a>01794                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l01795"></a>01795                         }
<a name="l01796"></a>01796                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> )
<a name="l01797"></a>01797                         {
<a name="l01798"></a>01798                               <span class="comment">// no need to walk after this</span>
<a name="l01799"></a>01799                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l01800"></a>01800                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = NOWHERE;
<a name="l01801"></a>01801                         }
<a name="l01802"></a>01802                         <span class="keywordflow">else</span>
<a name="l01803"></a>01803                         {
<a name="l01804"></a>01804                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b5a4cdc97564cafbc4ce6b8a11eec0ce4">AI_ACTION_WALK</a>;                     
<a name="l01805"></a>01805                               <span class="comment">// leave next-action-data as is since that's where we want to go</span>
<a name="l01806"></a>01806                         }
<a name="l01807"></a>01807                   }
<a name="l01808"></a>01808                   <span class="keywordflow">else</span>
<a name="l01809"></a>01809                   {
<a name="l01810"></a>01810                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a>;
<a name="l01811"></a>01811                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a>;
<a name="l01812"></a>01812                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e29f2821a7f319ffe6405848dabb4c6b">bTargetLevel</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#84a4b7065ddc3045b3844262f382d84f">bNextTargetLevel</a>;
<a name="l01813"></a>01813                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l01814"></a>01814                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = 0;
<a name="l01815"></a>01815                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#84a4b7065ddc3045b3844262f382d84f">bNextTargetLevel</a> = 0;
<a name="l01816"></a>01816                   }
<a name="l01817"></a>01817                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b43786c664a8b0ee0b98c83ef8b2b9d8d">AI_ACTION_PICKUP_ITEM</a>)
<a name="l01818"></a>01818                   {
<a name="l01819"></a>01819                         <span class="comment">// the item pool index was stored in the special data field</span>
<a name="l01820"></a>01820                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#a69215f405f59c8085b3bb27f76893c3">uiPendingActionData1</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#ef0b5040f579c55031efc3214477ac35">iNextActionSpecialData</a>;
<a name="l01821"></a>01821                   }
<a name="l01822"></a>01822             }
<a name="l01823"></a>01823             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> != NOWHERE )
<a name="l01824"></a>01824             {
<a name="l01825"></a>01825                   <span class="keywordflow">if</span> ( ACTING_ON_SCHEDULE( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l01826"></a>01826                   {
<a name="l01827"></a>01827                         pSoldier-&gt;bAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a>;
<a name="l01828"></a>01828                   }
<a name="l01829"></a>01829                   <span class="keywordflow">else</span>
<a name="l01830"></a>01830                   {
<a name="l01831"></a>01831                         pSoldier-&gt;bAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b5a4cdc97564cafbc4ce6b8a11eec0ce4">AI_ACTION_WALK</a>;
<a name="l01832"></a>01832                   }
<a name="l01833"></a>01833                   pSoldier-&gt;usActionData = pSoldier-&gt;sAbsoluteFinalDestination;
<a name="l01834"></a>01834             }
<a name="l01835"></a>01835             <span class="keywordflow">else</span>
<a name="l01836"></a>01836             {
<a name="l01837"></a>01837                   <span class="keywordflow">if</span> (!(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; ENGAGED_IN_CONV))
<a name="l01838"></a>01838                   {
<a name="l01839"></a>01839                         <span class="keywordflow">if</span> (CREATURE_OR_BLOODCAT( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ))
<a name="l01840"></a>01840                         {
<a name="l01841"></a>01841                               pSoldier-&gt;bAction = <a class="code" href="AIInternals_8h.html#1a9094ee044d30e809322c4de80cd0ca">CreatureDecideAction</a>( pSoldier );
<a name="l01842"></a>01842                         }
<a name="l01843"></a>01843                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pSoldier-&gt;ubBodyType == <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a7143fbbb5aa867c244f7cf6a230545002">CROW</a>)
<a name="l01844"></a>01844                         {
<a name="l01845"></a>01845                               pSoldier-&gt;bAction = <a class="code" href="AIInternals_8h.html#52f1c269f2badd6c4954408d382abdb7">CrowDecideAction</a>( pSoldier );
<a name="l01846"></a>01846                         }
<a name="l01847"></a>01847                         <span class="keywordflow">else</span>
<a name="l01848"></a>01848                         {
<a name="l01849"></a>01849                               pSoldier-&gt;bAction = <a class="code" href="ai_8h.html#ae225f94edccc85265839e43ebeba7cb">DecideAction</a>(pSoldier);
<a name="l01850"></a>01850                         }
<a name="l01851"></a>01851                   }
<a name="l01852"></a>01852             }
<a name="l01853"></a>01853 
<a name="l01854"></a>01854             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b261c7b45743ebd70c5901566c1c275ca">AI_ACTION_ABSOLUTELY_NONE</a>)
<a name="l01855"></a>01855             {
<a name="l01856"></a>01856                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l01857"></a>01857             }
<a name="l01858"></a>01858 
<a name="l01859"></a>01859             <span class="comment">// if he chose to continue doing nothing</span>
<a name="l01860"></a>01860             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>)
<a name="l01861"></a>01861             {
<a name="l01862"></a>01862 <span class="preprocessor">                  #ifdef RECORDNET</span>
<a name="l01863"></a>01863 <span class="preprocessor"></span>                        fprintf(NetDebugFile,<span class="stringliteral">"\tMOVED BECOMING TRUE: Chose to do nothing, guynum %d\n"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>);
<a name="l01864"></a>01864 <span class="preprocessor">                  #endif</span>
<a name="l01865"></a>01865 <span class="preprocessor"></span>
<a name="l01866"></a>01866                   DebugMsg (<a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>,DBG_LEVEL_3,<span class="stringliteral">"NPC has no action assigned"</span>);
<a name="l01867"></a>01867                   <a class="code" href="AIInternals_8h.html#834ad5f7bf7d38a06631fc0c40de63cb">NPCDoesNothing</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);  <span class="comment">// sets pSoldier-&gt;moved to TRUE</span>
<a name="l01868"></a>01868                   <span class="keywordflow">return</span>;
<a name="l01869"></a>01869             }
<a name="l01870"></a>01870 
<a name="l01871"></a>01871 
<a name="l01872"></a>01872 
<a name="l01873"></a>01873  <span class="comment">/*</span>
<a name="l01874"></a>01874 <span class="comment"> // if we somehow just caused an uninterruptable animation to occur</span>
<a name="l01875"></a>01875 <span class="comment"> // This is mainly to finish a weapon_AWAY anim that preceeds a TOSS attack</span>
<a name="l01876"></a>01876 <span class="comment"> if (!AnimControl[ pSoldier-&gt;anitype[pSoldier-&gt;anim] ].interruptable)</span>
<a name="l01877"></a>01877 <span class="comment">  {</span>
<a name="l01878"></a>01878 <span class="comment">#ifdef DEBUGBUSY</span>
<a name="l01879"></a>01879 <span class="comment">   DebugAI( String( "Uninterruptable animation %d, skipping guy %d",pSoldier-&gt;anitype[pSoldier-&gt;anim],pSoldier-&gt;ubID ) );</span>
<a name="l01880"></a>01880 <span class="comment">#endif</span>
<a name="l01881"></a>01881 <span class="comment"></span>
<a name="l01882"></a>01882 <span class="comment">   return;      // wait a while, let the animation finish first</span>
<a name="l01883"></a>01883 <span class="comment">  }</span>
<a name="l01884"></a>01884 <span class="comment">      */</span>
<a name="l01885"></a>01885 
<a name="l01886"></a>01886             <span class="comment">// to get here, we MUST have an action selected, but not in progress...</span>
<a name="l01887"></a>01887 
<a name="l01888"></a>01888             <span class="comment">// see if we can afford to do this action</span>
<a name="l01889"></a>01889             <span class="keywordflow">if</span> (<a class="code" href="ai_8h.html#dd5730a3e85127b7590031d7580277b0">IsActionAffordable</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>))
<a name="l01890"></a>01890             {
<a name="l01891"></a>01891                   <a class="code" href="AIInternals_8h.html#1dc658ff228f7a3273f69cd2a842fb3d">NPCDoesAct</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01892"></a>01892 
<a name="l01893"></a>01893                   <span class="comment">// perform the chosen action</span>
<a name="l01894"></a>01894                   pSoldier-&gt;bActionInProgress = <a class="code" href="ai_8h.html#3de5cffc7ce75484cc9efb8bcab754b6">ExecuteAction</a>(pSoldier); <span class="comment">// if started, mark us as busy</span>
<a name="l01895"></a>01895 
<a name="l01896"></a>01896                   <span class="keywordflow">if</span> ( !pSoldier-&gt;bActionInProgress &amp;&amp; pSoldier-&gt;sAbsoluteFinalDestination != NOWHERE )
<a name="l01897"></a>01897                   {
<a name="l01898"></a>01898                         <span class="comment">// turn based... abort this guy's turn</span>
<a name="l01899"></a>01899                         <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( pSoldier );
<a name="l01900"></a>01900                   }
<a name="l01901"></a>01901             }
<a name="l01902"></a>01902             <span class="keywordflow">else</span>
<a name="l01903"></a>01903             {
<a name="l01904"></a>01904 <span class="preprocessor">                  #ifdef DEBUGDECISIONS</span>
<a name="l01905"></a>01905 <span class="preprocessor"></span>                        <a class="code" href="AIUtils_8cpp.html#88d13d659f1890049d17af096cc37432">AINumMessage</a>(<span class="stringliteral">"HandleManAI - Not enough APs, skipping guy#"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>);
<a name="l01906"></a>01906 <span class="preprocessor">                  #endif</span>
<a name="l01907"></a>01907 <span class="preprocessor"></span>                  <a class="code" href="ai_8h.html#912129a36b43117c1936fd514850d518">HaltMoveForSoldierOutOfPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01908"></a>01908                   <span class="keywordflow">return</span>;
<a name="l01909"></a>01909             }
<a name="l01910"></a>01910       }
<a name="l01911"></a>01911 }
<a name="l01912"></a>01912 
<a name="l01913"></a>01913 
<a name="l01914"></a><a class="code" href="AIMain_8cpp.html#ae28a86711cdd71702115912c232f563">01914</a> <span class="keywordtype">void</span> <a class="code" href="AIInternals_8h.html#ae28a86711cdd71702115912c232f563">RefreshAI</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l01915"></a>01915 {
<a name="l01916"></a>01916  <span class="comment">// produce our own private "mine map" so we can avoid the ones we can detect</span>
<a name="l01917"></a>01917 <span class="comment">// MarkDetectableMines(pSoldier);</span>
<a name="l01918"></a>01918 
<a name="l01919"></a>01919  <span class="comment">// whether last attack hit or not doesn't matter once control has been lost</span>
<a name="l01920"></a>01920  <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#657bbd7f43de0a9f3d1bff0cb350c024">bLastAttackHit</a> = FALSE;
<a name="l01921"></a>01921 
<a name="l01922"></a>01922  <span class="comment">// get an up-to-date alert status for this guy</span>
<a name="l01923"></a>01923  <a class="code" href="AIInternals_8h.html#deb4b27c776d12c422d88811706807fe">DecideAlertStatus</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01924"></a>01924 
<a name="l01925"></a>01925  <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> == <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726530ecf4468b8fd828fc47998fef0f857fd">STATUS_YELLOW</a>)
<a name="l01926"></a>01926    SkipCoverCheck = FALSE;
<a name="l01927"></a>01927 
<a name="l01928"></a>01928  <span class="comment">// if he's in battle or knows opponents are here</span>
<a name="l01929"></a>01929  <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l01930"></a>01930  {
<a name="l01931"></a>01931        <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> == <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532cb7890b45734e38021cf4022c1f24e2">STATUS_BLACK</a>) || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> == <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>))
<a name="l01932"></a>01932             {
<a name="l01933"></a>01933              <span class="comment">// always freshly rethink things at start of his turn</span>
<a name="l01934"></a>01934              <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1897f6330181ea58e948eaa23a5fd75c">bNewSituation</a> = IS_NEW_SITUATION;
<a name="l01935"></a>01935             }
<a name="l01936"></a>01936        <span class="keywordflow">else</span>
<a name="l01937"></a>01937             {
<a name="l01938"></a>01938              <span class="comment">// make sure any paths stored during out last AI decision but not reacted</span>
<a name="l01939"></a>01939              <span class="comment">// to (probably due to lack of APs) get re-tested by the ExecuteAction()</span>
<a name="l01940"></a>01940              <span class="comment">// function in AI, since the -&gt;sDestination may no longer be legal now!</span>
<a name="l01941"></a>01941              <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0133c330db71283c8ccf4e4f6dd5a4ad">bPathStored</a> = FALSE;
<a name="l01942"></a>01942 
<a name="l01943"></a>01943              <span class="comment">// if not currently engaged, or even alerted</span>
<a name="l01944"></a>01944              <span class="comment">// take a quick look around to see if any friends seem to be in trouble</span>
<a name="l01945"></a>01945              <a class="code" href="ai_8h.html#d74e64649076c7ccf1f7e8c48012877e">ManChecksOnFriends</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01946"></a>01946 
<a name="l01947"></a>01947              <span class="comment">// allow stationary GREEN Civilians to turn again at least 1/turn!</span>
<a name="l01948"></a>01948             }
<a name="l01949"></a>01949              <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l01950"></a>01950 
<a name="l01951"></a>01951       }
<a name="l01952"></a>01952 }
<a name="l01953"></a>01953 
<a name="l01954"></a>01954 
<a name="l01955"></a><a class="code" href="AIMain_8cpp.html#f7e247034cf364626a491e569cdd3fb3">01955</a> <span class="keywordtype">void</span> <a class="code" href="AIMain_8cpp.html#f7e247034cf364626a491e569cdd3fb3">AIDecideRadioAnimation</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l01956"></a>01956 {
<a name="l01957"></a>01957       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> != <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a788083a907978249a0160b5b1dd9ee4a4">REGMALE</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> != <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a7e6eac15857ce481c9ed507f7459a3507">BIGMALE</a> )
<a name="l01958"></a>01958       {
<a name="l01959"></a>01959             <span class="comment">// no animation available</span>
<a name="l01960"></a>01960             <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01961"></a>01961             <span class="keywordflow">return</span>;
<a name="l01962"></a>01962       }
<a name="l01963"></a>01963 
<a name="l01964"></a>01964       <span class="keywordflow">if</span> ( PTR_CIVILIAN &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> != <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a0785249cebb97519ab2d7c94dabe2509bef978">KINGPIN_CIV_GROUP</a> )
<a name="l01965"></a>01965       {
<a name="l01966"></a>01966             <span class="comment">// don't play anim</span>
<a name="l01967"></a>01967             <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01968"></a>01968             <span class="keywordflow">return</span>;
<a name="l01969"></a>01969       }
<a name="l01970"></a>01970 
<a name="l01971"></a>01971       <span class="keywordflow">switch</span>( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight )
<a name="l01972"></a>01972       {
<a name="l01973"></a>01973             <span class="keywordflow">case</span> ANIM_STAND:
<a name="l01974"></a>01974 
<a name="l01975"></a>01975                   <a class="code" href="Soldier_01Control_8cpp.html#2f98bd1e4ef2f55b4124a6cfa69a00e3">EVENT_InitNewSoldierAnim</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2ebc12c06cad6fcf15402eacfe0202d6684">AI_RADIO</a>, 0 , FALSE );
<a name="l01976"></a>01976                   <span class="keywordflow">break</span>;
<a name="l01977"></a>01977 
<a name="l01978"></a>01978             <span class="keywordflow">case</span> ANIM_CROUCH:
<a name="l01979"></a>01979 
<a name="l01980"></a>01980                   <a class="code" href="Soldier_01Control_8cpp.html#2f98bd1e4ef2f55b4124a6cfa69a00e3">EVENT_InitNewSoldierAnim</a>( pSoldier, <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb3d334e16a7ebd6abfb3e1b544f1579b1">AI_CR_RADIO</a>, 0 , FALSE );
<a name="l01981"></a>01981                   <span class="keywordflow">break</span>;
<a name="l01982"></a>01982 
<a name="l01983"></a>01983             <span class="keywordflow">case</span> ANIM_PRONE:
<a name="l01984"></a>01984 
<a name="l01985"></a>01985                   <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>( pSoldier );
<a name="l01986"></a>01986                   <span class="keywordflow">break</span>;
<a name="l01987"></a>01987       }
<a name="l01988"></a>01988 }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990 
<a name="l01991"></a><a class="code" href="AIMain_8cpp.html#3de5cffc7ce75484cc9efb8bcab754b6">01991</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="ai_8h.html#3de5cffc7ce75484cc9efb8bcab754b6">ExecuteAction</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l01992"></a>01992 {
<a name="l01993"></a>01993       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iRetCode;
<a name="l01994"></a>01994       <span class="comment">//NumMessage("ExecuteAction - Guy#",pSoldier-&gt;ubID);</span>
<a name="l01995"></a>01995 
<a name="l01996"></a>01996       <span class="comment">// in most cases, merc will change location, or may cause damage to opponents,</span>
<a name="l01997"></a>01997       <span class="comment">// so a new cover check will be necessary.  Exceptions handled individually.</span>
<a name="l01998"></a>01998       SkipCoverCheck = FALSE;
<a name="l01999"></a>01999 
<a name="l02000"></a>02000       <span class="comment">// reset this field, too</span>
<a name="l02001"></a>02001       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#657bbd7f43de0a9f3d1bff0cb350c024">bLastAttackHit</a> = FALSE;
<a name="l02002"></a>02002 
<a name="l02003"></a>02003       <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> usHandItem = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>;
<a name="l02004"></a>02004 
<a name="l02005"></a>02005 <span class="preprocessor">      #ifdef TESTAICONTROL</span>
<a name="l02006"></a>02006 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#1aa7fa93044da366b9072c35e0a9b297">fAutoBandageMode</a>)
<a name="l02007"></a>02007       {
<a name="l02008"></a>02008             <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>( <span class="stringliteral">"%d does %s (a.d. %d) in %d with %d APs left"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>, <a class="code" href="Overhead_8cpp.html#bdcb5e390c584c20a06add9797073d71">gzActionStr</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a>], <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> ) );
<a name="l02009"></a>02009       }
<a name="l02010"></a>02010 <span class="preprocessor">      #endif</span>
<a name="l02011"></a>02011 <span class="preprocessor"></span>
<a name="l02012"></a>02012       <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>( <span class="stringliteral">"%d does %s (a.d. %d) at time %ld"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>, <a class="code" href="Overhead_8cpp.html#bdcb5e390c584c20a06add9797073d71">gzActionStr</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a>], <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>, GetJA2Clock() ) );
<a name="l02013"></a>02013   
<a name="l02014"></a>02014       <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a>)
<a name="l02015"></a>02015       {
<a name="l02016"></a>02016             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>:                  <span class="comment">// maintain current position &amp; facing</span>
<a name="l02017"></a>02017                   <span class="comment">// do nothing</span>
<a name="l02018"></a>02018                   <span class="keywordflow">break</span>;
<a name="l02019"></a>02019 
<a name="l02020"></a>02020             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a>:                                                     <span class="comment">// hold AI_ACTION_NONE for a specified time</span>
<a name="l02021"></a>02021                   <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l02022"></a>02022                   {
<a name="l02023"></a>02023                         <span class="comment">// probably an action set as a next-action in the realtime prior to combat</span>
<a name="l02024"></a>02024                         <span class="comment">// do nothing</span>
<a name="l02025"></a>02025                   }
<a name="l02026"></a>02026                   <span class="keywordflow">else</span>
<a name="l02027"></a>02027                   {
<a name="l02028"></a>02028                         RESETTIMECOUNTER( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#67be2d37d159d78626d798f77351b8f5">AICounter</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> ); 
<a name="l02029"></a>02029                         <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE)
<a name="l02030"></a>02030                         {
<a name="l02031"></a>02031                               <span class="comment">//DebugMsg( TOPIC_JA2, DBG_LEVEL_0, String( "%s waiting %d from %d", pSoldier-&gt;name, pSoldier-&gt;AICounter, GetJA2Clock() ) );</span>
<a name="l02032"></a>02032                         }
<a name="l02033"></a>02033                   }
<a name="l02034"></a>02034                   <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l02035"></a>02035                   <span class="keywordflow">break</span>;
<a name="l02036"></a>02036 
<a name="l02037"></a>02037             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>:         <span class="comment">// turn this way &amp; that to look</span>
<a name="l02038"></a>02038                   <span class="comment">// as long as we don't see anyone new, cover won't have changed</span>
<a name="l02039"></a>02039                   <span class="comment">// if we see someone new, it will cause a new situation &amp; remove this</span>
<a name="l02040"></a>02040                   SkipCoverCheck = TRUE;
<a name="l02041"></a>02041 
<a name="l02042"></a>02042 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l02043"></a>02043 <span class="preprocessor"></span>                  <a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a> tempstr;
<a name="l02044"></a>02044                   sprintf((CHAR *) tempstr, <span class="stringliteral">"ExecuteAction: SkipCoverCheck ON\n"</span> );
<a name="l02045"></a>02045                   <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a> (tempstr);
<a name="l02046"></a>02046 <span class="preprocessor">#endif</span>
<a name="l02047"></a>02047 <span class="preprocessor"></span>
<a name="l02048"></a>02048 <span class="comment">//                pSoldier-&gt;bDesiredDirection = (UINT8) ;   // turn to face direction in actionData</span>
<a name="l02049"></a>02049                   <a class="code" href="Soldier_01Control_8cpp.html#2c1be1fe86bcb126a4c3ece8955d464f">SendSoldierSetDesiredDirectionEvent</a>( pSoldier, pSoldier-&gt;usActionData );
<a name="l02050"></a>02050                   <span class="comment">// now we'll have to wait for the turning to finish; no need to call TurnSoldier here</span>
<a name="l02051"></a>02051                   <span class="comment">//TurnSoldier( pSoldier );</span>
<a name="l02052"></a>02052 <span class="comment">/*</span>
<a name="l02053"></a>02053 <span class="comment">                  if (!StartTurn(pSoldier,pSoldier-&gt;usActionData,FASTTURN))</span>
<a name="l02054"></a>02054 <span class="comment">                  {</span>
<a name="l02055"></a>02055 <span class="comment">#ifdef BETAVERSION</span>
<a name="l02056"></a>02056 <span class="comment">                        sprintf((CHAR *)tempstr,"ERROR: %s tried TURN to direction %d, StartTurn failed, action %d CANCELED",</span>
<a name="l02057"></a>02057 <span class="comment">                                    pSoldier-&gt;name,pSoldier-&gt;usActionData,pSoldier-&gt;bAction);</span>
<a name="l02058"></a>02058 <span class="comment">                        PopMessage(tempstr);</span>
<a name="l02059"></a>02059 <span class="comment">#endif</span>
<a name="l02060"></a>02060 <span class="comment"></span>
<a name="l02061"></a>02061 <span class="comment">                        // ZAP NPC's remaining action points so this isn't likely to repeat</span>
<a name="l02062"></a>02062 <span class="comment">                        pSoldier-&gt;bActionPoints = 0;</span>
<a name="l02063"></a>02063 <span class="comment"></span>
<a name="l02064"></a>02064 <span class="comment">                        CancelAIAction(pSoldier,FORCE);</span>
<a name="l02065"></a>02065 <span class="comment">                        return(FALSE);         // nothing is in progress</span>
<a name="l02066"></a>02066 <span class="comment">                  }</span>
<a name="l02067"></a>02067 <span class="comment">                  else</span>
<a name="l02068"></a>02068 <span class="comment">                  {</span>
<a name="l02069"></a>02069 <span class="comment">#ifdef RECORDNET</span>
<a name="l02070"></a>02070 <span class="comment">                        fprintf(NetDebugFile,"\tAI decides to turn guynum %d to dir %d\n",pSoldier-&gt;ubID,pSoldier-&gt;usActionData);</span>
<a name="l02071"></a>02071 <span class="comment">#endif</span>
<a name="l02072"></a>02072 <span class="comment">                        NetLookTowardsDir(pSoldier,pSoldier-&gt;usActionData);</span>
<a name="l02073"></a>02073 <span class="comment">                  }</span>
<a name="l02074"></a>02074 <span class="comment">                  */</span>
<a name="l02075"></a>02075                   <span class="keywordflow">break</span>;
<a name="l02076"></a>02076 
<a name="l02077"></a>02077             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b43786c664a8b0ee0b98c83ef8b2b9d8d">AI_ACTION_PICKUP_ITEM</a>:                            <span class="comment">// grab something!</span>
<a name="l02078"></a>02078                   <a class="code" href="Handle_01Items_8cpp.html#728ea1023712f480f0da436aa99be631">SoldierPickupItem</a>( pSoldier, pSoldier-&gt;uiPendingActionData1, pSoldier-&gt;usActionData, 0 );
<a name="l02079"></a>02079                   <span class="keywordflow">break</span>;
<a name="l02080"></a>02080 
<a name="l02081"></a>02081             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8320292f8039994bd01173541e63cef9">AI_ACTION_DROP_ITEM</a>:                              <span class="comment">// drop item in hand</span>
<a name="l02082"></a>02082                   <a class="code" href="Handle_01Items_8cpp.html#111790bb92964b77cc5bfe36df277cc7">SoldierDropItem</a>( pSoldier, &amp;(pSoldier-&gt;inv[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>]) );
<a name="l02083"></a>02083                   <a class="code" href="Items_8cpp.html#5950d1252d479c6f8c5a25d86b06d889">DeleteObj</a>( &amp;(pSoldier-&gt;inv[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>]) );
<a name="l02084"></a>02084                   pSoldier-&gt;bAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b1221b04fcc67d664066e467da8a5ffbe">AI_ACTION_PENDING_ACTION</a>;
<a name="l02085"></a>02085                   <span class="keywordflow">break</span>;
<a name="l02086"></a>02086 
<a name="l02087"></a>02087             <span class="comment">//case AI_ACTION_MOVE_TO_CLIMB:</span>
<a name="l02088"></a>02088             <span class="comment">//    if ( pSoldier-&gt;usActionData == pSoldier-&gt;sGridNo )</span>
<a name="l02089"></a>02089             <span class="comment">//    {</span>
<a name="l02090"></a>02090             <span class="comment">//          // change action to climb now and try that.</span>
<a name="l02091"></a>02091             <span class="comment">//          pSoldier-&gt;bAction = AI_ACTION_CLIMB_ROOF;</span>
<a name="l02092"></a>02092             <span class="comment">//          if (IsActionAffordable(pSoldier))</span>
<a name="l02093"></a>02093             <span class="comment">//          {</span>
<a name="l02094"></a>02094             <span class="comment">//                return( ExecuteAction( pSoldier ) );</span>
<a name="l02095"></a>02095             <span class="comment">//          }</span>
<a name="l02096"></a>02096             <span class="comment">//          else</span>
<a name="l02097"></a>02097             <span class="comment">//          {     </span>
<a name="l02098"></a>02098             <span class="comment">//                // no action started</span>
<a name="l02099"></a>02099             <span class="comment">//                return( FALSE );</span>
<a name="l02100"></a>02100             <span class="comment">//          }</span>
<a name="l02101"></a>02101             <span class="comment">//    }</span>
<a name="l02102"></a>02102 
<a name="l02103"></a>02103                   <span class="comment">// fall through               </span>
<a name="l02104"></a>02104             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bbf193832f320fa99e574d622b4fc391d">AI_ACTION_RANDOM_PATROL</a>:         <span class="comment">// move towards a particular location</span>
<a name="l02105"></a>02105             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b42b12b1204c797182c2f7c35dbf84fc3">AI_ACTION_SEEK_FRIEND</a>:           <span class="comment">// move towards friend in trouble</span>
<a name="l02106"></a>02106             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>:         <span class="comment">// move towards a reported opponent</span>
<a name="l02107"></a>02107             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bd2358f4f3b1cd379c943855df803496d">AI_ACTION_TAKE_COVER</a>:            <span class="comment">// run for nearest cover from threat</span>
<a name="l02108"></a>02108             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bedcd6be18202cbd0df633b0017f571f1">AI_ACTION_GET_CLOSER</a>:            <span class="comment">// move closer to a strategic location</span>
<a name="l02109"></a>02109 
<a name="l02110"></a>02110             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b89a5e43473f884b6e3957c03128115d5">AI_ACTION_POINT_PATROL</a>:          <span class="comment">// move towards next patrol point</span>
<a name="l02111"></a>02111             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bbbe6b4d8c4937c66e39880b4df436182">AI_ACTION_LEAVE_WATER_GAS</a>:       <span class="comment">// seek nearest spot of ungassed land</span>
<a name="l02112"></a>02112             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b69da0507d724596d4763a66492e793b7">AI_ACTION_SEEK_NOISE</a>:            <span class="comment">// seek most important noise heard</span>
<a name="l02113"></a>02113             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950be1338b9c498abc9dd4b86d1b22291b12">AI_ACTION_RUN_AWAY</a>:              <span class="comment">// run away from nearby opponent(s)</span>
<a name="l02114"></a>02114 
<a name="l02115"></a>02115             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bc343a7ff6dd2ba930ea933f2063e09ea">AI_ACTION_APPROACH_MERC</a>:                    <span class="comment">// walk up to someone to talk</span>
<a name="l02116"></a>02116             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b76ec912a07f1c30ff680be01f84610fd">AI_ACTION_TRACK</a>:                                              <span class="comment">// track by ground scent</span>
<a name="l02117"></a>02117             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bce6343160e28febced697cddd65c7132">AI_ACTION_EAT</a>:                                                      <span class="comment">// monster approaching corpse</span>
<a name="l02118"></a>02118             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a>:
<a name="l02119"></a>02119             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b5a4cdc97564cafbc4ce6b8a11eec0ce4">AI_ACTION_WALK</a>:
<a name="l02120"></a>02120             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bfe427c47c08c1233b842858a427837d0">AI_ACTION_WITHDRAW</a>:
<a name="l02121"></a>02121             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a>:
<a name="l02122"></a>02122             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b10a5bb7993a15bb15134edd4a78384cd">AI_ACTION_FLANK_RIGHT</a>:
<a name="l02123"></a>02123             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b9fedcc063c7b27f024bca6c0b419ac34">AI_ACTION_RUN</a>:
<a name="l02124"></a>02124             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4ca31547c6e6eeadec11ea94b7a9fd07">AI_ACTION_MOVE_TO_CLIMB</a>:
<a name="l02125"></a>02125                   <span class="keywordflow">if</span> ( pSoldier-&gt;bAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4ca31547c6e6eeadec11ea94b7a9fd07">AI_ACTION_MOVE_TO_CLIMB</a> )
<a name="l02126"></a>02126                   {
<a name="l02127"></a>02127                         DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"Executing: AI_ACTION_MOVE_TO_CLIMB"</span>);
<a name="l02128"></a>02128                         DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Soldier GridNo = %d, action data = %d "</span>, pSoldier-&gt;sGridNo , pSoldier-&gt;usActionData));
<a name="l02129"></a>02129                   }
<a name="l02130"></a>02130 
<a name="l02131"></a>02131                   <span class="keywordflow">if</span> ( <a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> &amp;&amp; pSoldier-&gt;bAlertStatus &lt; <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532cb7890b45734e38021cf4022c1f24e2">STATUS_BLACK</a> )
<a name="l02132"></a>02132                   {
<a name="l02133"></a>02133                         <span class="keywordflow">if</span> ( pSoldier-&gt;sLastTwoLocations[0] == NOWHERE )
<a name="l02134"></a>02134                         {
<a name="l02135"></a>02135                               pSoldier-&gt;sLastTwoLocations[0] = pSoldier-&gt;sGridNo;
<a name="l02136"></a>02136                         }
<a name="l02137"></a>02137                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( pSoldier-&gt;sLastTwoLocations[1] == NOWHERE )
<a name="l02138"></a>02138                         {
<a name="l02139"></a>02139                               pSoldier-&gt;sLastTwoLocations[1] = pSoldier-&gt;sGridNo;
<a name="l02140"></a>02140                         }
<a name="l02141"></a>02141                         <span class="comment">// check for loop</span>
<a name="l02142"></a>02142                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( pSoldier-&gt;usActionData == pSoldier-&gt;sLastTwoLocations[1] &amp;&amp; pSoldier-&gt;sGridNo == pSoldier-&gt;sLastTwoLocations[0] )
<a name="l02143"></a>02143                         {
<a name="l02144"></a>02144                               <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>( <span class="stringliteral">"%d in movement loop, aborting turn"</span>, pSoldier-&gt;ubID ) );
<a name="l02145"></a>02145 
<a name="l02146"></a>02146                               <span class="comment">// loop found!</span>
<a name="l02147"></a>02147                               <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>( pSoldier );
<a name="l02148"></a>02148                               <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( pSoldier );
<a name="l02149"></a>02149                         }
<a name="l02150"></a>02150                         <span class="keywordflow">else</span>
<a name="l02151"></a>02151                         {
<a name="l02152"></a>02152                               pSoldier-&gt;sLastTwoLocations[0] = pSoldier-&gt;sLastTwoLocations[1];
<a name="l02153"></a>02153                               pSoldier-&gt;sLastTwoLocations[1] = pSoldier-&gt;sGridNo;
<a name="l02154"></a>02154                         }
<a name="l02155"></a>02155                   }
<a name="l02156"></a>02156 
<a name="l02157"></a>02157       <span class="comment">// Randomly do growl...</span>
<a name="l02158"></a>02158       <span class="keywordflow">if</span> ( pSoldier-&gt;ubBodyType == <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a7fa470b7d78ba43f21bfd04c49f02a70b">BLOODCAT</a> )
<a name="l02159"></a>02159       {
<a name="l02160"></a>02160         <span class="keywordflow">if</span> ( ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT ) )
<a name="l02161"></a>02161         {
<a name="l02162"></a>02162           <span class="keywordflow">if</span> ( <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 2 ) == 0 )
<a name="l02163"></a>02163           {
<a name="l02164"></a>02164             <a class="code" href="Sound_01Control_8cpp.html#fde31c808018dd666dbd51cd26c6eb6e">PlaySoldierJA2Sample</a>( pSoldier-&gt;ubID, ( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b56cc0ec5c29da281660d8e7e4eec61a8d">BLOODCAT_GROWL_1</a> + <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 4 ) ), RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( HIGHVOLUME, pSoldier-&gt;sGridNo ), 1, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( pSoldier-&gt;sGridNo ), TRUE );             
<a name="l02165"></a>02165           }
<a name="l02166"></a>02166         }
<a name="l02167"></a>02167       }
<a name="l02168"></a>02168 
<a name="l02169"></a>02169                   <span class="comment">// on YELLOW/GREEN status, NPCs keep the actions from turn to turn</span>
<a name="l02170"></a>02170                   <span class="comment">// (newSituation is intentionally NOT set in NewSelectedNPC()), so the</span>
<a name="l02171"></a>02171                   <span class="comment">// possibility exists that NOW the actionData is no longer a valid</span>
<a name="l02172"></a>02172                   <span class="comment">// NPC -&gt;sDestination (path got blocked, someone is now standing at that</span>
<a name="l02173"></a>02173                   <span class="comment">// gridno, etc.)  So we gotta check again that the -&gt;sDestination's legal!</span>
<a name="l02174"></a>02174 
<a name="l02175"></a>02175                   <span class="comment">// optimization - Ian (if up-to-date path is known, do not check again)</span>
<a name="l02176"></a>02176                   <span class="keywordflow">if</span> (!pSoldier-&gt;bPathStored)
<a name="l02177"></a>02177                   {
<a name="l02178"></a>02178                         <span class="keywordflow">if</span> ( (pSoldier-&gt;sAbsoluteFinalDestination != NOWHERE || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#1aa7fa93044da366b9072c35e0a9b297">fAutoBandageMode</a>) &amp;&amp; !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) )
<a name="l02179"></a>02179                         {
<a name="l02180"></a>02180                               <span class="comment">// NPC system move, allow path through</span>
<a name="l02181"></a>02181                               <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25b5963f027fa0a7c12f815dbcf2739e">LegalNPCDestination</a>(pSoldier,pSoldier-&gt;usActionData,ENSURE_PATH,WATEROK, PATH_THROUGH_PEOPLE ))
<a name="l02182"></a>02182                               {
<a name="l02183"></a>02183                                     <span class="comment">// optimization - Ian: prevent another path call in SetNewCourse()</span>
<a name="l02184"></a>02184                                     pSoldier-&gt;bPathStored = TRUE;
<a name="l02185"></a>02185                               }
<a name="l02186"></a>02186                         }
<a name="l02187"></a>02187                         <span class="keywordflow">else</span>
<a name="l02188"></a>02188                         {
<a name="l02189"></a>02189                               <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25b5963f027fa0a7c12f815dbcf2739e">LegalNPCDestination</a>(pSoldier,pSoldier-&gt;usActionData,ENSURE_PATH,WATEROK, 0))
<a name="l02190"></a>02190                               {
<a name="l02191"></a>02191                                     <span class="comment">// optimization - Ian: prevent another path call in SetNewCourse()</span>
<a name="l02192"></a>02192                                     pSoldier-&gt;bPathStored = TRUE;
<a name="l02193"></a>02193                               }
<a name="l02194"></a>02194                         }
<a name="l02195"></a>02195 
<a name="l02196"></a>02196                         <span class="comment">// if we STILL don't have a path</span>
<a name="l02197"></a>02197                         <span class="keywordflow">if</span> ( !pSoldier-&gt;bPathStored )
<a name="l02198"></a>02198                         {
<a name="l02199"></a>02199                               <span class="comment">// Check if we were told to move by NPC stuff</span>
<a name="l02200"></a>02200                               <span class="keywordflow">if</span> ( pSoldier-&gt;sAbsoluteFinalDestination != NOWHERE &amp;&amp; !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) )
<a name="l02201"></a>02201                               {
<a name="l02202"></a>02202                                     <span class="comment">//ScreenMsg( FONT_MCOLOR_LTYELLOW, MSG_ERROR, L"AI %s failed to get path for dialogue-related move!", pSoldier-&gt;name );</span>
<a name="l02203"></a>02203 
<a name="l02204"></a>02204                                     <span class="comment">// Are we close enough?</span>
<a name="l02205"></a>02205                                     <span class="keywordflow">if</span> ( !ACTING_ON_SCHEDULE( pSoldier ) &amp;&amp; <a class="code" href="Isometric_01Utils_8cpp.html#94dc29a40d3702f9d4d8ad35dc8e457c">SpacesAway</a>( pSoldier-&gt;sGridNo, pSoldier-&gt;sAbsoluteFinalDestination ) &lt; 4 )
<a name="l02206"></a>02206                                     {
<a name="l02207"></a>02207                                           <span class="comment">// This is close enough...</span>
<a name="l02208"></a>02208                                           <a class="code" href="NPC_8cpp.html#52b7ebb29b826ef67bf9213a06c9d6bb">ReplaceLocationInNPCDataFromProfileID</a>( pSoldier-&gt;ubProfile, pSoldier-&gt;sAbsoluteFinalDestination, pSoldier-&gt;sGridNo );
<a name="l02209"></a>02209                                           <a class="code" href="Interface_01Dialogue_8cpp.html#8ea7e105db399b4d11158e0e5e84f074">NPCGotoGridNo</a>( pSoldier-&gt;ubProfile, pSoldier-&gt;sGridNo, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) (pSoldier-&gt;ubQuoteRecord - 1) );
<a name="l02210"></a>02210                                     }
<a name="l02211"></a>02211                                     <span class="keywordflow">else</span>
<a name="l02212"></a>02212                                     {
<a name="l02213"></a>02213                                           <span class="comment">// This is important, so try taking a path through people (and bumping them aside)</span>
<a name="l02214"></a>02214                                           <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25b5963f027fa0a7c12f815dbcf2739e">LegalNPCDestination</a>(pSoldier,pSoldier-&gt;usActionData,ENSURE_PATH,WATEROK, PATH_THROUGH_PEOPLE))
<a name="l02215"></a>02215                                           {
<a name="l02216"></a>02216                                                 <span class="comment">// optimization - Ian: prevent another path call in SetNewCourse()</span>
<a name="l02217"></a>02217                                                 pSoldier-&gt;bPathStored = TRUE;
<a name="l02218"></a>02218                                           }                                   
<a name="l02219"></a>02219                                           <span class="keywordflow">else</span>
<a name="l02220"></a>02220                                           {
<a name="l02221"></a>02221                                                 <span class="comment">// Have buddy wait a while...</span>
<a name="l02222"></a>02222                                                 pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a>;
<a name="l02223"></a>02223                                                 pSoldier-&gt;usNextActionData = (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)REALTIME_AI_DELAY;                                   
<a name="l02224"></a>02224                                           }
<a name="l02225"></a>02225                                     }
<a name="l02226"></a>02226 
<a name="l02227"></a>02227                                     <span class="keywordflow">if</span> (!pSoldier-&gt;bPathStored)
<a name="l02228"></a>02228                                     {
<a name="l02229"></a>02229                                           <a class="code" href="ai_8h.html#6cced4c42ca3081db5b89f6a584e549f">CancelAIAction</a>(pSoldier,FORCE);
<a name="l02230"></a>02230                                           <span class="keywordflow">return</span>(FALSE);         <span class="comment">// nothing is in progress</span>
<a name="l02231"></a>02231                                     }
<a name="l02232"></a>02232                               }
<a name="l02233"></a>02233                               <span class="keywordflow">else</span>
<a name="l02234"></a>02234                               {
<a name="l02235"></a>02235                                     <a class="code" href="ai_8h.html#6cced4c42ca3081db5b89f6a584e549f">CancelAIAction</a>(pSoldier,FORCE);
<a name="l02236"></a>02236                                     <span class="keywordflow">return</span>(FALSE);         <span class="comment">// nothing is in progress</span>
<a name="l02237"></a>02237                               }
<a name="l02238"></a>02238                         }
<a name="l02239"></a>02239                   }
<a name="l02240"></a>02240 
<a name="l02241"></a>02241                   <span class="comment">// add on anything necessary to traverse off map edge</span>
<a name="l02242"></a>02242                   <span class="keywordflow">switch</span>( pSoldier-&gt;ubQuoteActionID )
<a name="l02243"></a>02243                   {
<a name="l02244"></a>02244                         <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831efe48f9c2ccb282afc7ed0f779fe67c4b1">QUOTE_ACTION_ID_TRAVERSE_EAST</a>:
<a name="l02245"></a>02245                               pSoldier-&gt;sOffWorldGridNo = pSoldier-&gt;usActionData;
<a name="l02246"></a>02246                               <a class="code" href="strategicmap_8cpp.html#b01b7657843aba7cf8670512485d20fd">AdjustSoldierPathToGoOffEdge</a>( pSoldier, pSoldier-&gt;usActionData, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7b5b3793b961949c817c7c0d99c05dad7">EAST</a> );
<a name="l02247"></a>02247                               <span class="keywordflow">break</span>;
<a name="l02248"></a>02248                         <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831effbbd245a12fc9d6872c26ef221f11939">QUOTE_ACTION_ID_TRAVERSE_SOUTH</a>:
<a name="l02249"></a>02249                               pSoldier-&gt;sOffWorldGridNo = pSoldier-&gt;usActionData;
<a name="l02250"></a>02250                               <a class="code" href="strategicmap_8cpp.html#b01b7657843aba7cf8670512485d20fd">AdjustSoldierPathToGoOffEdge</a>( pSoldier, pSoldier-&gt;usActionData, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b78ef5c0bce69283a9986011a63eea8a6b">SOUTH</a> );
<a name="l02251"></a>02251                               <span class="keywordflow">break</span>;
<a name="l02252"></a>02252                         <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831ef970250cece3c0655b08575de2d5cb4f0">QUOTE_ACTION_ID_TRAVERSE_WEST</a>:
<a name="l02253"></a>02253                               pSoldier-&gt;sOffWorldGridNo = pSoldier-&gt;usActionData;
<a name="l02254"></a>02254                               <a class="code" href="strategicmap_8cpp.html#b01b7657843aba7cf8670512485d20fd">AdjustSoldierPathToGoOffEdge</a>( pSoldier, pSoldier-&gt;usActionData, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7e9449e8683a8199dad36b07a63b2f523">WEST</a> );
<a name="l02255"></a>02255                               <span class="keywordflow">break</span>;
<a name="l02256"></a>02256                         <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831ef0c9f3f8fb8f374c02f97081c2caa71c7">QUOTE_ACTION_ID_TRAVERSE_NORTH</a>:
<a name="l02257"></a>02257                               pSoldier-&gt;sOffWorldGridNo = pSoldier-&gt;usActionData;
<a name="l02258"></a>02258                               <a class="code" href="strategicmap_8cpp.html#b01b7657843aba7cf8670512485d20fd">AdjustSoldierPathToGoOffEdge</a>( pSoldier, pSoldier-&gt;usActionData, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7d0611de6f28d4a9c9eac959f5344698e">NORTH</a> );
<a name="l02259"></a>02259                               <span class="keywordflow">break</span>;
<a name="l02260"></a>02260                         <span class="keywordflow">default</span>:
<a name="l02261"></a>02261                               <span class="keywordflow">break</span>;
<a name="l02262"></a>02262                   }
<a name="l02263"></a>02263 
<a name="l02264"></a>02264                   <a class="code" href="ai_8h.html#030f329f87a56854da2a4fb2c5ff62e3">NewDest</a>(pSoldier,pSoldier-&gt;usActionData);    <span class="comment">// set new -&gt;sDestination to actionData</span>
<a name="l02265"></a>02265 
<a name="l02266"></a>02266                   <span class="comment">// make sure it worked (check that pSoldier-&gt;sDestination == pSoldier-&gt;usActionData)</span>
<a name="l02267"></a>02267                   <span class="keywordflow">if</span> (pSoldier-&gt;sFinalDestination != pSoldier-&gt;usActionData)
<a name="l02268"></a>02268                   {
<a name="l02269"></a>02269 <span class="preprocessor">#ifdef BETAVERSION</span>
<a name="l02270"></a>02270 <span class="preprocessor"></span>                        <span class="comment">// this should NEVER happen, indicates AI picked an illegal spot!</span>
<a name="l02271"></a>02271                         sprintf((CHAR *)tempstr,<span class="stringliteral">"ExecuteAction: ERROR - %s tried MOVE to gridno %d, NewDest failed, action %d CANCELED"</span>,
<a name="l02272"></a>02272                               pSoldier-&gt;name,pSoldier-&gt;usActionData,pSoldier-&gt;bAction);
<a name="l02273"></a>02273 
<a name="l02274"></a>02274 <span class="preprocessor">#ifdef RECORDNET</span>
<a name="l02275"></a>02275 <span class="preprocessor"></span>                        fprintf(NetDebugFile,<span class="stringliteral">"\n%s\n\n"</span>,tempstr);
<a name="l02276"></a>02276 <span class="preprocessor">#endif</span>
<a name="l02277"></a>02277 <span class="preprocessor"></span>
<a name="l02278"></a>02278                         PopMessage(tempstr);
<a name="l02279"></a>02279 
<a name="l02280"></a>02280                         sprintf((CHAR *)tempstr,<span class="stringliteral">"BLACK-LISTING gridno %d for %s"</span>,pSoldier-&gt;usActionData,pSoldier-&gt;name);
<a name="l02281"></a>02281                         PopMessage(tempstr);
<a name="l02282"></a>02282 
<a name="l02283"></a>02283                         <a class="code" href="SaveLoadGame_8cpp.html#0784b87f72abd069066a23754b254302">SaveGame</a>(ERROR_SAVE);
<a name="l02284"></a>02284 <span class="preprocessor">#endif</span>
<a name="l02285"></a>02285 <span class="preprocessor"></span>                        <span class="comment">// temporarily black list this gridno to stop enemy from going there</span>
<a name="l02286"></a>02286                         pSoldier-&gt;sBlackList = (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) pSoldier-&gt;usActionData;
<a name="l02287"></a>02287 
<a name="l02288"></a>02288                         <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>( <span class="stringliteral">"Setting blacklist for %d to %d"</span>, pSoldier-&gt;ubID, pSoldier-&gt;sBlackList ) );
<a name="l02289"></a>02289 
<a name="l02290"></a>02290                         <a class="code" href="ai_8h.html#6cced4c42ca3081db5b89f6a584e549f">CancelAIAction</a>(pSoldier,FORCE);
<a name="l02291"></a>02291                         <span class="keywordflow">return</span>(FALSE);         <span class="comment">// nothing is in progress</span>
<a name="l02292"></a>02292                   }
<a name="l02293"></a>02293 
<a name="l02294"></a>02294                   <span class="comment">// cancel any old black-listed gridno, got a valid new -&gt;sDestination</span>
<a name="l02295"></a>02295                   pSoldier-&gt;sBlackList = NOWHERE;
<a name="l02296"></a>02296                   <span class="keywordflow">break</span>;
<a name="l02297"></a>02297 
<a name="l02298"></a>02298             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bd6ec85ce1f2d875bf6957fb46e63b70c">AI_ACTION_ESCORTED_MOVE</a>:         <span class="comment">// go where told to by escortPlayer</span>
<a name="l02299"></a>02299                   <span class="comment">// since this is a delayed move, gotta make sure that it hasn't become</span>
<a name="l02300"></a>02300                   <span class="comment">// illegal since escort orders were issued (-&gt;sDestination/route blocked).</span>
<a name="l02301"></a>02301                   <span class="comment">// So treat it like a CONTINUE movement, and handle errors that way</span>
<a name="l02302"></a>02302                   <span class="keywordflow">if</span> (!<a class="code" href="ai_8h.html#59af503b47255d14b00bac19f80c1f68">TryToResumeMovement</a>(pSoldier,pSoldier-&gt;usActionData))
<a name="l02303"></a>02303                   {
<a name="l02304"></a>02304                         <span class="comment">// don't black-list anything here, and action already got canceled</span>
<a name="l02305"></a>02305                         <span class="keywordflow">return</span>(FALSE);         <span class="comment">// nothing is in progress</span>
<a name="l02306"></a>02306                   }
<a name="l02307"></a>02307 
<a name="l02308"></a>02308                   <span class="comment">// cancel any old black-listed gridno, got a valid new -&gt;sDestination</span>
<a name="l02309"></a>02309                   pSoldier-&gt;sBlackList = NOWHERE;
<a name="l02310"></a>02310                   <span class="keywordflow">break</span>;
<a name="l02311"></a>02311 
<a name="l02312"></a>02312             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b260e54a79dd8e6db573a8216c3a63efc">AI_ACTION_TOSS_PROJECTILE</a>:       <span class="comment">// throw grenade at/near opponent(s)</span>
<a name="l02313"></a>02313                   <a class="code" href="AIInternals_8h.html#54c405ab1017daba01bbdcb0d51a7ee2">LoadWeaponIfNeeded</a>(pSoldier);
<a name="l02314"></a>02314                   <span class="comment">// drop through here...</span>
<a name="l02315"></a>02315 
<a name="l02316"></a>02316             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bcc74cedcb5afbd32c5b21b1ecc59b9ec">AI_ACTION_KNIFE_MOVE</a>:            <span class="comment">// preparing to stab opponent</span>
<a name="l02317"></a>02317                   <span class="keywordflow">if</span> (pSoldier-&gt;bAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bcc74cedcb5afbd32c5b21b1ecc59b9ec">AI_ACTION_KNIFE_MOVE</a>) <span class="comment">// if statement because toss falls through</span>
<a name="l02318"></a>02318                   {
<a name="l02319"></a>02319                         pSoldier-&gt;usUIMovementMode = <a class="code" href="AIInternals_8h.html#468eb52bb4265820478677d9c93d0b20">DetermineMovementMode</a>( pSoldier, <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bcc74cedcb5afbd32c5b21b1ecc59b9ec">AI_ACTION_KNIFE_MOVE</a> );
<a name="l02320"></a>02320                   }
<a name="l02321"></a>02321 
<a name="l02322"></a>02322                   <span class="comment">// fall through</span>
<a name="l02323"></a>02323             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6247fbdbad71e877e20dc79b610060b8">AI_ACTION_FIRE_GUN</a>:              <span class="comment">// shoot at nearby opponent</span>
<a name="l02324"></a>02324             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b48a1dee24335dcbf15fd2d883fc6e243">AI_ACTION_THROW_KNIFE</a>:                                 <span class="comment">// throw knife at nearby opponent</span>
<a name="l02325"></a>02325                   <span class="comment">// randomly decide whether to say civ quote</span>
<a name="l02326"></a>02326                   <span class="keywordflow">if</span> ( pSoldier-&gt;bVisible != -1 &amp;&amp; pSoldier-&gt;bTeam != MILITIA_TEAM )
<a name="l02327"></a>02327                   {
<a name="l02328"></a>02328         <span class="comment">// ATE: Make sure it's a person :)</span>
<a name="l02329"></a>02329         <span class="keywordflow">if</span> ( IS_MERC_BODY_TYPE( pSoldier ) &amp;&amp; pSoldier-&gt;ubProfile == NO_PROFILE )
<a name="l02330"></a>02330         {
<a name="l02331"></a>02331                           <span class="comment">// CC, ATE here - I put in some TEMP randomness...</span>
<a name="l02332"></a>02332                           <span class="keywordflow">if</span> ( <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 50 ) == 0 )
<a name="l02333"></a>02333                           {
<a name="l02334"></a>02334                                 <a class="code" href="Civ_01Quotes_8cpp.html#bafe61642969c6a2185749fe92cd9375">StartCivQuote</a>( pSoldier );
<a name="l02335"></a>02335                           }
<a name="l02336"></a>02336         }
<a name="l02337"></a>02337                   }
<a name="l02338"></a>02338 <span class="preprocessor">#ifdef RECORDNET</span>
<a name="l02339"></a>02339 <span class="preprocessor"></span>                  fprintf(NetDebugFile,<span class="stringliteral">"\tExecuteAction: %d calling HandleItem(), inHand %d, actionData %d, anitype %d, oldani %d\n"</span>,
<a name="l02340"></a>02340                         pSoldier-&gt;ubID,pSoldier-&gt;inv[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].item,pSoldier-&gt;usActionData,pSoldier-&gt;anitype[pSoldier-&gt;anim],pSoldier-&gt;oldani);
<a name="l02341"></a>02341 <span class="preprocessor">#endif</span>
<a name="l02342"></a>02342 <span class="preprocessor"></span>
<a name="l02343"></a>02343 <span class="preprocessor">#ifdef TESTVERSION</span>
<a name="l02344"></a>02344 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (pSoldier-&gt;bAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bcc74cedcb5afbd32c5b21b1ecc59b9ec">AI_ACTION_KNIFE_MOVE</a>)
<a name="l02345"></a>02345                   {
<a name="l02346"></a>02346                         sprintf((CHAR *)tempstr,<span class="stringliteral">"TEST MSG: %s is about to go stab %s. MAKE SURE HE DOES!"</span>,
<a name="l02347"></a>02347                               pSoldier-&gt;name,
<a name="l02348"></a>02348                         ExtMen[WhoIsThere(pSoldier-&gt;usActionData)].name);
<a name="l02349"></a>02349 
<a name="l02350"></a>02350                         SimulMessage(tempstr,3000,NODECRYPT);
<a name="l02351"></a>02351                   }
<a name="l02352"></a>02352 <span class="preprocessor">#endif</span>
<a name="l02353"></a>02353 <span class="preprocessor"></span>                  
<a name="l02354"></a>02354                   <span class="keywordflow">if</span> ( pSoldier-&gt;bAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b260e54a79dd8e6db573a8216c3a63efc">AI_ACTION_TOSS_PROJECTILE</a> &amp;&amp; <a class="code" href="Items_8cpp.html#a71edef11b5b44ceeaa1030c3a758db2">IsGrenadeLauncherAttached</a>(&amp;pSoldier-&gt;inv[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>]) )
<a name="l02355"></a>02355                         usHandItem = <a class="code" href="Items_8cpp.html#7cb1bfb4454c9fec31dc641a715f6756">GetAttachedGrenadeLauncher</a>(&amp;pSoldier-&gt;inv[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>]);
<a name="l02356"></a>02356 
<a name="l02357"></a>02357                   iRetCode = <a class="code" href="Handle_01Items_8cpp.html#81366bee57d86f5258547f14ca646619">HandleItem</a>( pSoldier, pSoldier-&gt;usActionData, pSoldier-&gt;bTargetLevel, usHandItem, FALSE );
<a name="l02358"></a>02358                   <span class="keywordflow">if</span> ( iRetCode != ITEM_HANDLE_OK)
<a name="l02359"></a>02359                   {
<a name="l02360"></a>02360                         <span class="keywordflow">if</span> ( iRetCode != ITEM_HANDLE_BROKEN ) <span class="comment">// if the item broke, this is 'legal' and doesn't need reporting</span>
<a name="l02361"></a>02361                         {
<a name="l02362"></a>02362                               <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>( <span class="stringliteral">"AI %d got error code %ld from HandleItem, doing action %d, has %d APs... aborting deadlock!"</span>, pSoldier-&gt;ubID, iRetCode, pSoldier-&gt;bAction, pSoldier-&gt;bActionPoints ) );
<a name="l02363"></a>02363                               <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L<span class="stringliteral">"AI %d got error code %ld from HandleItem, doing action %d... aborting deadlock!"</span>, pSoldier-&gt;ubID, iRetCode, pSoldier-&gt;bAction );
<a name="l02364"></a>02364                         }
<a name="l02365"></a>02365                         <a class="code" href="ai_8h.html#6cced4c42ca3081db5b89f6a584e549f">CancelAIAction</a>( pSoldier, FORCE);
<a name="l02366"></a>02366 <span class="preprocessor">                        #ifdef TESTAICONTROL</span>
<a name="l02367"></a>02367 <span class="preprocessor"></span>                              <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l02368"></a>02368                               {
<a name="l02369"></a>02369                                     <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because of error from HandleItem"</span>, pSoldier-&gt;ubID ) );
<a name="l02370"></a>02370                               }
<a name="l02371"></a>02371 <span class="preprocessor">                        #endif</span>
<a name="l02372"></a>02372 <span class="preprocessor"></span>                        <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( pSoldier );
<a name="l02373"></a>02373                   }           
<a name="l02374"></a>02374                   <span class="keywordflow">break</span>;
<a name="l02375"></a>02375 
<a name="l02376"></a>02376             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b7e203d40eac46d173b3d04252291e713">AI_ACTION_PULL_TRIGGER</a>:          <span class="comment">// activate an adjacent panic trigger</span>
<a name="l02377"></a>02377 
<a name="l02378"></a>02378                   <span class="comment">// turn to face trigger first</span>
<a name="l02379"></a>02379                   <span class="keywordflow">if</span> ( <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)(pSoldier-&gt;sGridNo + <a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7d0611de6f28d4a9c9eac959f5344698e">NORTH</a> )), STRUCTURE_SWITCH ) )
<a name="l02380"></a>02380                   {
<a name="l02381"></a>02381                         <a class="code" href="Soldier_01Control_8cpp.html#2c1be1fe86bcb126a4c3ece8955d464f">SendSoldierSetDesiredDirectionEvent</a>( pSoldier, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7d0611de6f28d4a9c9eac959f5344698e">NORTH</a> );
<a name="l02382"></a>02382                   }
<a name="l02383"></a>02383                   <span class="keywordflow">else</span>
<a name="l02384"></a>02384                   {
<a name="l02385"></a>02385                         <a class="code" href="Soldier_01Control_8cpp.html#2c1be1fe86bcb126a4c3ece8955d464f">SendSoldierSetDesiredDirectionEvent</a>( pSoldier, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7e9449e8683a8199dad36b07a63b2f523">WEST</a> );
<a name="l02386"></a>02386                   }
<a name="l02387"></a>02387                   
<a name="l02388"></a>02388                   <a class="code" href="Soldier_01Control_8cpp.html#2f98bd1e4ef2f55b4124a6cfa69a00e3">EVENT_InitNewSoldierAnim</a>( pSoldier, <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb291b0dcceeb3055bf1788e21548b9f24">AI_PULL_SWITCH</a>, 0 , FALSE );
<a name="l02389"></a>02389 
<a name="l02390"></a>02390                   <a class="code" href="Points_8cpp.html#2443da2dcce8326e972d806fbc4eaff8">DeductPoints</a>( pSoldier, AP_PULL_TRIGGER, 0 );
<a name="l02391"></a>02391 
<a name="l02392"></a>02392                   <span class="comment">//gTacticalStatus.fPanicFlags                         = 0; // turn all flags off</span>
<a name="l02393"></a>02393                   <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#08542070e86ace3d6254642057e2cf00">ubTheChosenOne</a>                  = NOBODY;
<a name="l02394"></a>02394                   <span class="keywordflow">break</span>;
<a name="l02395"></a>02395 
<a name="l02396"></a>02396             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bebbb4904c42ddf440c9c898aca2ffeed">AI_ACTION_USE_DETONATOR</a>: 
<a name="l02397"></a>02397                   <span class="comment">//gTacticalStatus.fPanicFlags                         = 0; // turn all flags off</span>
<a name="l02398"></a>02398                   <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#08542070e86ace3d6254642057e2cf00">ubTheChosenOne</a>                  = NOBODY;
<a name="l02399"></a>02399                   <span class="comment">//gTacticalStatus.sPanicTriggerGridno     = NOWHERE;</span>
<a name="l02400"></a>02400 
<a name="l02401"></a>02401               <span class="comment">// grab detonator and set off bomb(s)</span>
<a name="l02402"></a>02402                   <a class="code" href="Points_8cpp.html#2443da2dcce8326e972d806fbc4eaff8">DeductPoints</a>( pSoldier, AP_USE_REMOTE, BP_USE_DETONATOR);<span class="comment">// pay for it!</span>
<a name="l02403"></a>02403                   <span class="comment">//SetOffPanicBombs(1000,COMMUNICATE);    // BOOOOOOOOOOOOOOOOOOOOM!!!!!</span>
<a name="l02404"></a>02404                   <a class="code" href="Explosion_01Control_8cpp.html#d8bc4ed51c714aaa300ef23e9207e088">SetOffPanicBombs</a>( pSoldier-&gt;ubID, 0 );
<a name="l02405"></a>02405 
<a name="l02406"></a>02406                   <span class="comment">// action completed immediately, cancel it right away</span>
<a name="l02407"></a>02407                   pSoldier-&gt;usActionData = NOWHERE;
<a name="l02408"></a>02408                   pSoldier-&gt;bLastAction = pSoldier-&gt;bAction;
<a name="l02409"></a>02409                   pSoldier-&gt;bAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l02410"></a>02410                   <span class="keywordflow">return</span>(FALSE);           <span class="comment">// no longer in progress</span>
<a name="l02411"></a>02411 
<a name="l02412"></a>02412                   <span class="keywordflow">break</span>;
<a name="l02413"></a>02413 
<a name="l02414"></a>02414             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b32a0d931f53db4ddf96ac82a3b52484a">AI_ACTION_RED_ALERT</a>:             <span class="comment">// tell friends opponent(s) seen</span>
<a name="l02415"></a>02415                   <span class="comment">// if a computer merc, and up to now they didn't know you're here</span>
<a name="l02416"></a>02416                   <span class="keywordflow">if</span> (!(pSoldier-&gt;uiStatusFlags &amp; SOLDIER_PC) &amp;&amp; ( !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[pSoldier-&gt;bTeam].<a class="code" href="structTacticalTeamType.html#38333ae5abadbdccc9ca26e3edefe942">bAwareOfOpposition</a>) || ( ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#965c762739e2731d1af1bb56e3485d0f">fPanicFlags</a> &amp; PANIC_TRIGGERS_HERE ) &amp;&amp; <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#08542070e86ace3d6254642057e2cf00">ubTheChosenOne</a> == NOBODY ) ) )
<a name="l02417"></a>02417                   {
<a name="l02418"></a>02418                         <a class="code" href="ai_8h.html#a62be813aac8f8417cf3a0f3ea2059c5">HandleInitialRedAlert</a>(pSoldier-&gt;bTeam, TRUE);
<a name="l02419"></a>02419                   }
<a name="l02420"></a>02420                   <span class="comment">//ScreenMsg( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L"Debug: AI radios your position!" );</span>
<a name="l02421"></a>02421                   <span class="comment">// DROP THROUGH HERE!</span>
<a name="l02422"></a>02422             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b040215f06027cab6536b687b79df4633">AI_ACTION_YELLOW_ALERT</a>:          <span class="comment">// tell friends opponent(s) heard</span>
<a name="l02423"></a>02423                   <span class="comment">//ScreenMsg( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L"Debug: AI radios about a noise!" );</span>
<a name="l02424"></a>02424 <span class="comment">/*</span>
<a name="l02425"></a>02425 <span class="comment">                  NetSend.msgType = NET_RADIO_SIGHTINGS;</span>
<a name="l02426"></a>02426 <span class="comment">                  NetSend.ubID  = pSoldier-&gt;ubID;</span>
<a name="l02427"></a>02427 <span class="comment"></span>
<a name="l02428"></a>02428 <span class="comment">                  SendNetData(ALL_NODES);</span>
<a name="l02429"></a>02429 <span class="comment">*/</span>
<a name="l02430"></a>02430                   <a class="code" href="Points_8cpp.html#2443da2dcce8326e972d806fbc4eaff8">DeductPoints</a>(pSoldier,AP_RADIO,BP_RADIO);<span class="comment">// pay for it!</span>
<a name="l02431"></a>02431                   <a class="code" href="opplist_8cpp.html#c03ab89191201cdfd14d1039033d9f55">RadioSightings</a>(pSoldier,EVERYBODY,pSoldier-&gt;bTeam);      <span class="comment">// about everybody</span>
<a name="l02432"></a>02432                   <span class="comment">// action completed immediately, cancel it right away</span>
<a name="l02433"></a>02433 
<a name="l02434"></a>02434                   <span class="comment">// ATE: Change to an animation!</span>
<a name="l02435"></a>02435                   <a class="code" href="AIMain_8cpp.html#f7e247034cf364626a491e569cdd3fb3">AIDecideRadioAnimation</a>( pSoldier );
<a name="l02436"></a>02436                   <span class="comment">//return(FALSE);           // no longer in progress</span>
<a name="l02437"></a>02437                   <span class="keywordflow">break</span>;
<a name="l02438"></a>02438 
<a name="l02439"></a>02439             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b33f47e42fd1375b937fa9cfb14d36bf9">AI_ACTION_CREATURE_CALL</a>:                                                 <span class="comment">// creature calling to others</span>
<a name="l02440"></a>02440                   <a class="code" href="Points_8cpp.html#2443da2dcce8326e972d806fbc4eaff8">DeductPoints</a>(pSoldier,AP_RADIO,BP_RADIO);<span class="comment">// pay for it!</span>
<a name="l02441"></a>02441                   <a class="code" href="AIInternals_8h.html#2e70acbbe3db26f355a74b6fe0bb5c0f">CreatureCall</a>( pSoldier );
<a name="l02442"></a>02442                   <span class="comment">//return( FALSE ); // no longer in progress</span>
<a name="l02443"></a>02443                   <span class="keywordflow">break</span>;
<a name="l02444"></a>02444 
<a name="l02445"></a>02445             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a>:                <span class="comment">// crouch</span>
<a name="l02446"></a>02446                   <span class="keywordflow">if</span> ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ pSoldier-&gt;usAnimState ].<a class="code" href="structANIMCONTROLTYPE.html#b9157ed02712719a4e7c4317370cd498">ubHeight</a> == pSoldier-&gt;usActionData )
<a name="l02447"></a>02447                   {
<a name="l02448"></a>02448                         <span class="comment">// abort!</span>
<a name="l02449"></a>02449                         <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>( pSoldier );
<a name="l02450"></a>02450                         <span class="keywordflow">return</span>( FALSE );
<a name="l02451"></a>02451                   }
<a name="l02452"></a>02452 
<a name="l02453"></a>02453                   SkipCoverCheck = TRUE;
<a name="l02454"></a>02454 
<a name="l02455"></a>02455 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l02456"></a>02456 <span class="preprocessor"></span>                  sprintf((CHAR *) tempstr, <span class="stringliteral">"ExecuteAction: SkipCoverCheck ON\n"</span> );
<a name="l02457"></a>02457                   <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a> (tempstr);
<a name="l02458"></a>02458 <span class="preprocessor">#endif</span>
<a name="l02459"></a>02459 <span class="preprocessor"></span>                  <a class="code" href="Soldier_01Control_8cpp.html#84e3a78b45e32e523782c253a4addd3b">SendChangeSoldierStanceEvent</a>( pSoldier, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) pSoldier-&gt;usActionData );
<a name="l02460"></a>02460                   <span class="keywordflow">break</span>;
<a name="l02461"></a>02461 
<a name="l02462"></a>02462             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b0e1477dcf1592283b53b8027ff3ae20a">AI_ACTION_COWER</a>:
<a name="l02463"></a>02463                   <span class="comment">// make sure action data is set right</span>
<a name="l02464"></a>02464                   <span class="keywordflow">if</span> ( pSoldier-&gt;uiStatusFlags &amp; SOLDIER_COWERING )
<a name="l02465"></a>02465                   {
<a name="l02466"></a>02466                         <span class="comment">// nothing to do!</span>
<a name="l02467"></a>02467                         <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>( pSoldier );
<a name="l02468"></a>02468                         <span class="keywordflow">return</span>( FALSE );
<a name="l02469"></a>02469                   }
<a name="l02470"></a>02470                   <span class="keywordflow">else</span>
<a name="l02471"></a>02471                   {
<a name="l02472"></a>02472                         pSoldier-&gt;usActionData = ANIM_CROUCH;
<a name="l02473"></a>02473                         <a class="code" href="Soldier_01Control_8cpp.html#30dd9dfe62a8c77d8c0320754dd5d734">SetSoldierCowerState</a>( pSoldier, TRUE );
<a name="l02474"></a>02474                   }
<a name="l02475"></a>02475                   <span class="keywordflow">break</span>;
<a name="l02476"></a>02476 
<a name="l02477"></a>02477             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6f46584addd5e876d03eef0b47c41003">AI_ACTION_STOP_COWERING</a>:
<a name="l02478"></a>02478                   <span class="comment">// make sure action data is set right</span>
<a name="l02479"></a>02479                   <span class="keywordflow">if</span> ( pSoldier-&gt;uiStatusFlags &amp; SOLDIER_COWERING )
<a name="l02480"></a>02480                   {
<a name="l02481"></a>02481                         pSoldier-&gt;usActionData = ANIM_STAND;
<a name="l02482"></a>02482                         <a class="code" href="Soldier_01Control_8cpp.html#30dd9dfe62a8c77d8c0320754dd5d734">SetSoldierCowerState</a>( pSoldier, FALSE );
<a name="l02483"></a>02483                   }
<a name="l02484"></a>02484                   <span class="keywordflow">else</span>
<a name="l02485"></a>02485                   {
<a name="l02486"></a>02486                         <span class="comment">// nothing to do!</span>
<a name="l02487"></a>02487                         <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>( pSoldier );
<a name="l02488"></a>02488                         <span class="keywordflow">return</span>( FALSE );
<a name="l02489"></a>02489                   }
<a name="l02490"></a>02490                   <span class="keywordflow">break</span>;
<a name="l02491"></a>02491 
<a name="l02492"></a>02492             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b1696eedab3d185241ea45ac32affcf0d">AI_ACTION_GIVE_AID</a>:              <span class="comment">// help injured/dying friend</span>
<a name="l02493"></a>02493                   <span class="comment">//pSoldier-&gt;usUIMovementMode = RUNNING;</span>
<a name="l02494"></a>02494                   iRetCode = <a class="code" href="Handle_01Items_8cpp.html#81366bee57d86f5258547f14ca646619">HandleItem</a>( pSoldier, pSoldier-&gt;usActionData, 0, pSoldier-&gt;inv[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].usItem, FALSE );
<a name="l02495"></a>02495                   <span class="keywordflow">if</span> ( iRetCode != ITEM_HANDLE_OK)
<a name="l02496"></a>02496                   {
<a name="l02497"></a>02497 <span class="preprocessor">#ifdef JA2BETAVERSION</span>
<a name="l02498"></a>02498 <span class="preprocessor"></span>                        <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_ERROR, L<span class="stringliteral">"AI %d got error code %ld from HandleItem, doing action %d... aborting deadlock!"</span>, pSoldier-&gt;ubID, iRetCode, pSoldier-&gt;bAction );
<a name="l02499"></a>02499 <span class="preprocessor">#endif</span>
<a name="l02500"></a>02500 <span class="preprocessor"></span>                        <a class="code" href="ai_8h.html#6cced4c42ca3081db5b89f6a584e549f">CancelAIAction</a>( pSoldier, FORCE);
<a name="l02501"></a>02501 <span class="preprocessor">                        #ifdef TESTAICONTROL</span>
<a name="l02502"></a>02502 <span class="preprocessor"></span>                              <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l02503"></a>02503                               {
<a name="l02504"></a>02504                                     <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because of error from HandleItem"</span>, pSoldier-&gt;ubID ) );
<a name="l02505"></a>02505                               }
<a name="l02506"></a>02506 <span class="preprocessor">                        #endif</span>
<a name="l02507"></a>02507 <span class="preprocessor"></span>                        <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( pSoldier );
<a name="l02508"></a>02508                   }           
<a name="l02509"></a>02509                   <span class="keywordflow">break</span>;
<a name="l02510"></a>02510 
<a name="l02511"></a>02511             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b65e8af0fc83447730cc2b8d86372bcaf">AI_ACTION_OPEN_OR_CLOSE_DOOR</a>:
<a name="l02512"></a>02512             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950ba5497fc0ba7a574720d7e7fc9b6acadf">AI_ACTION_UNLOCK_DOOR</a>:
<a name="l02513"></a>02513             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8d52b4109959d549093a3709f0a0a39c">AI_ACTION_LOCK_DOOR</a>:
<a name="l02514"></a>02514                   {
<a name="l02515"></a>02515                         <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a> *       pStructure;
<a name="l02516"></a>02516                         <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                          bDirection;
<a name="l02517"></a>02517                         <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                         sDoorGridNo;
<a name="l02518"></a>02518 
<a name="l02519"></a>02519                         bDirection = (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) <a class="code" href="Soldier_01Control_8cpp.html#1d7b6c103ede7e551e76eef2ef173f9b">GetDirectionFromGridNo</a>( pSoldier-&gt;usActionData, pSoldier );
<a name="l02520"></a>02520                         <span class="keywordflow">if</span> (bDirection == <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7b5b3793b961949c817c7c0d99c05dad7">EAST</a> || bDirection == <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b78ef5c0bce69283a9986011a63eea8a6b">SOUTH</a>)
<a name="l02521"></a>02521                         {
<a name="l02522"></a>02522                               sDoorGridNo = pSoldier-&gt;sGridNo;
<a name="l02523"></a>02523                         }
<a name="l02524"></a>02524                         <span class="keywordflow">else</span>
<a name="l02525"></a>02525                         {
<a name="l02526"></a>02526                               sDoorGridNo = pSoldier-&gt;sGridNo + <a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( bDirection );
<a name="l02527"></a>02527                         }
<a name="l02528"></a>02528 
<a name="l02529"></a>02529                         pStructure = <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( sDoorGridNo, STRUCTURE_ANYDOOR );
<a name="l02530"></a>02530                         <span class="keywordflow">if</span> (pStructure == NULL)
<a name="l02531"></a>02531                         {
<a name="l02532"></a>02532 <span class="preprocessor">#ifdef JA2TESTVERSION</span>
<a name="l02533"></a>02533 <span class="preprocessor"></span>                              <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_ERROR, L<span class="stringliteral">"AI %d tried to open door it could not then find in %d"</span>, pSoldier-&gt;ubID, sDoorGridNo );
<a name="l02534"></a>02534 <span class="preprocessor">#endif</span>
<a name="l02535"></a>02535 <span class="preprocessor"></span>                              <a class="code" href="ai_8h.html#6cced4c42ca3081db5b89f6a584e549f">CancelAIAction</a>( pSoldier, FORCE);
<a name="l02536"></a>02536 <span class="preprocessor">                              #ifdef TESTAICONTROL</span>
<a name="l02537"></a>02537 <span class="preprocessor"></span>                                    <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l02538"></a>02538                                     {
<a name="l02539"></a>02539                                           <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because of error opening door"</span>, pSoldier-&gt;ubID ) );
<a name="l02540"></a>02540                                     }
<a name="l02541"></a>02541 <span class="preprocessor">                              #endif</span>
<a name="l02542"></a>02542 <span class="preprocessor"></span>                              <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( pSoldier );                      
<a name="l02543"></a>02543                         }
<a name="l02544"></a>02544 
<a name="l02545"></a>02545                         <a class="code" href="Interactive_01Tiles_8cpp.html#64dd8629aa5ab938544edbec25047a57">StartInteractiveObject</a>( sDoorGridNo, pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#2de3f71726e31b77bdaf2d45bc9eda30">usStructureID</a>, pSoldier, bDirection );
<a name="l02546"></a>02546                         <a class="code" href="Interactive_01Tiles_8cpp.html#9003c2f8e8ad700096f9c4f5acbcfd9c">InteractWithInteractiveObject</a>( pSoldier, pStructure, bDirection );
<a name="l02547"></a>02547                   }
<a name="l02548"></a>02548                   <span class="keywordflow">break</span>;
<a name="l02549"></a>02549 
<a name="l02550"></a>02550             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b762f725b03742451680676278e51b862">AI_ACTION_LOWER_GUN</a>:
<a name="l02551"></a>02551                   <span class="comment">// for now, just do "action done"</span>
<a name="l02552"></a>02552                   <a class="code" href="Soldier_01Control_8cpp.html#a0bf5d6769a62a4eef60702c78d13915">InternalSoldierReadyWeapon</a>(pSoldier,pSoldier-&gt;bDirection,TRUE);
<a name="l02553"></a>02553                   <a class="code" href="opplist_8cpp.html#84caab6b3c04128593b43316bfdfdf43">HandleSight</a>(pSoldier, SIGHT_LOOK );
<a name="l02554"></a>02554                   <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>( pSoldier );
<a name="l02555"></a>02555                   <span class="keywordflow">break</span>;
<a name="l02556"></a>02556 
<a name="l02557"></a>02557             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950ba91f358173f4ebb4c9d9c071642b8159">AI_ACTION_RAISE_GUN</a>: <span class="comment">//Madd: action added for snipers to ready weapon and use vision range bonuses</span>
<a name="l02558"></a>02558                   <a class="code" href="Soldier_01Control_8cpp.html#2d5d882aab80848de1a88ca58109c4bc">SoldierReadyWeapon</a>(pSoldier);
<a name="l02559"></a>02559                   <a class="code" href="opplist_8cpp.html#84caab6b3c04128593b43316bfdfdf43">HandleSight</a>(pSoldier, SIGHT_LOOK | SIGHT_RADIO);
<a name="l02560"></a>02560                   <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>( pSoldier );
<a name="l02561"></a>02561                   <span class="keywordflow">break</span>;
<a name="l02562"></a>02562 
<a name="l02563"></a>02563             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bf0d31a9fac3e900acf35ca5832cd876e">AI_ACTION_CLIMB_ROOF</a>:
<a name="l02564"></a>02564                   DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"Executing: AI_ACTION_CLIMB_ROOF"</span>);
<a name="l02565"></a>02565 
<a name="l02566"></a>02566                   <span class="keywordflow">if</span> (pSoldier-&gt;bLevel == 0)
<a name="l02567"></a>02567                   {
<a name="l02568"></a>02568                         <a class="code" href="Soldier_01Control_8cpp.html#6f76fabd0e1537ba84b3b92b46ef4dea">BeginSoldierClimbUpRoof</a>( pSoldier );
<a name="l02569"></a>02569                   }
<a name="l02570"></a>02570                   <span class="keywordflow">else</span>
<a name="l02571"></a>02571                   {
<a name="l02572"></a>02572                         <a class="code" href="Soldier_01Control_8cpp.html#54032ff03c62d983b320f87b1d215c59">BeginSoldierClimbDownRoof</a>( pSoldier );
<a name="l02573"></a>02573                   }                 
<a name="l02574"></a>02574                   <span class="keywordflow">break</span>;
<a name="l02575"></a>02575 
<a name="l02576"></a>02576             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>:
<a name="l02577"></a>02577                   <a class="code" href="ai_8h.html#2d2dfafa627e9e83dd1b60f538138f7e">ActionDone</a>( pSoldier );
<a name="l02578"></a>02578                   <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l02579"></a>02579                   {
<a name="l02580"></a>02580                         <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( pSoldier );
<a name="l02581"></a>02581                   }
<a name="l02582"></a>02582                   <span class="keywordflow">return</span>( FALSE );         <span class="comment">// nothing is in progress</span>
<a name="l02583"></a>02583 
<a name="l02584"></a>02584             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bddc225e694b4dd637debcf7c6e2a14d6">AI_ACTION_TRAVERSE_DOWN</a>:
<a name="l02585"></a>02585                   <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l02586"></a>02586                   {
<a name="l02587"></a>02587                         <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( pSoldier );
<a name="l02588"></a>02588                   }
<a name="l02589"></a>02589                   <span class="keywordflow">if</span> ( pSoldier-&gt;ubProfile != NO_PROFILE )
<a name="l02590"></a>02590                   {
<a name="l02591"></a>02591                         <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ pSoldier-&gt;ubProfile ].<a class="code" href="structMERCPROFILESTRUCT.html#9dfd2271b790d94f55f142e71ab18065">bSectorZ</a>++;
<a name="l02592"></a>02592                         <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ pSoldier-&gt;ubProfile ].<a class="code" href="structMERCPROFILESTRUCT.html#125ec7e3aa89a6f65e8cdb438a917c78">fUseProfileInsertionInfo</a> = FALSE;
<a name="l02593"></a>02593                   }
<a name="l02594"></a>02594                   <a class="code" href="Soldier_01Create_8cpp.html#5761f369bb132d093e5ce84db76fd7cf">TacticalRemoveSoldier</a>( pSoldier-&gt;ubID );
<a name="l02595"></a>02595                   <a class="code" href="Overhead_8cpp.html#56ffc3d04b07d68a0f1af946454f861c">CheckForEndOfBattle</a>( TRUE );
<a name="l02596"></a>02596 
<a name="l02597"></a>02597                   <span class="keywordflow">return</span>( FALSE );         <span class="comment">// nothing is in progress</span>
<a name="l02598"></a>02598 
<a name="l02599"></a>02599             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950be0a0afbead0db144e6da11231dbf9199">AI_ACTION_OFFER_SURRENDER</a>:
<a name="l02600"></a>02600                   <span class="comment">// start the offer of surrender!</span>
<a name="l02601"></a>02601                   <a class="code" href="Civ_01Quotes_8cpp.html#bafe61642969c6a2185749fe92cd9375">StartCivQuote</a>( pSoldier );
<a name="l02602"></a>02602                   <span class="keywordflow">break</span>;
<a name="l02603"></a>02603 
<a name="l02604"></a>02604             <span class="keywordflow">default</span>:
<a name="l02605"></a>02605 <span class="preprocessor">#ifdef BETAVERSION</span>
<a name="l02606"></a>02606 <span class="preprocessor"></span>                  NumMessage(<span class="stringliteral">"ExecuteAction - Illegal action type = "</span>,pSoldier-&gt;bAction);
<a name="l02607"></a>02607 <span class="preprocessor">#endif</span>
<a name="l02608"></a>02608 <span class="preprocessor"></span>                  <span class="keywordflow">return</span>(FALSE);
<a name="l02609"></a>02609       }
<a name="l02610"></a>02610 
<a name="l02611"></a>02611       <span class="comment">// return status indicating execution of action was properly started</span>
<a name="l02612"></a>02612       <span class="keywordflow">return</span>(TRUE);
<a name="l02613"></a>02613 }
<a name="l02614"></a>02614 
<a name="l02615"></a><a class="code" href="AIMain_8cpp.html#7753064f76c879dd64430c27c5b259ff">02615</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#7753064f76c879dd64430c27c5b259ff">CheckForChangingOrders</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l02616"></a>02616 { 
<a name="l02617"></a>02617       <span class="keywordflow">switch</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> )
<a name="l02618"></a>02618       {
<a name="l02619"></a>02619             <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532f91de342fc2584dd731cfe5d47271c6">STATUS_GREEN</a>:
<a name="l02620"></a>02620                   <span class="keywordflow">if</span> ( !CREATURE_OR_BLOODCAT( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l02621"></a>02621                   {
<a name="l02622"></a>02622                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == CIV_TEAM &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a> &amp;&amp; <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].sPreCombatGridNo != NOWHERE &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> != <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a0785247679564253ec7a0de30253ec664e67b4">QUEENS_CIV_GROUP</a> )
<a name="l02623"></a>02623                         {
<a name="l02624"></a>02624                               <span class="comment">// must make them uncower first, then return to start location</span>
<a name="l02625"></a>02625                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b476d7b194a22733be5841a8af2ccde4d">AI_ACTION_END_COWER_AND_MOVE</a>;
<a name="l02626"></a>02626                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].<a class="code" href="structMERCPROFILESTRUCT.html#f1d3dfd685f061c3ed2c4c47cf3f7a12">sPreCombatGridNo</a>;
<a name="l02627"></a>02627                               <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].<a class="code" href="structMERCPROFILESTRUCT.html#f1d3dfd685f061c3ed2c4c47cf3f7a12">sPreCombatGridNo</a> = NOWHERE;
<a name="l02628"></a>02628                         }
<a name="l02629"></a>02629                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_COWERING )
<a name="l02630"></a>02630                         {
<a name="l02631"></a>02631                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6f46584addd5e876d03eef0b47c41003">AI_ACTION_STOP_COWERING</a>;
<a name="l02632"></a>02632                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = ANIM_STAND;
<a name="l02633"></a>02633                         }
<a name="l02634"></a>02634                         <span class="keywordflow">else</span>
<a name="l02635"></a>02635                         {
<a name="l02636"></a>02636                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a>;
<a name="l02637"></a>02637                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = ANIM_STAND;
<a name="l02638"></a>02638                         }
<a name="l02639"></a>02639                   }
<a name="l02640"></a>02640                   <span class="keywordflow">break</span>;
<a name="l02641"></a>02641             <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726530ecf4468b8fd828fc47998fef0f857fd">STATUS_YELLOW</a>:
<a name="l02642"></a>02642                   <span class="keywordflow">break</span>;
<a name="l02643"></a>02643             <span class="keywordflow">default</span>:
<a name="l02644"></a>02644                   <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>) || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>))
<a name="l02645"></a>02645                   {
<a name="l02646"></a>02646                         <span class="comment">// crank up ONGUARD to CLOSEPATROL, and CLOSEPATROL to FARPATROL</span>
<a name="l02647"></a>02647                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>++;       <span class="comment">// increase roaming range by 1 category</span>
<a name="l02648"></a>02648                   }
<a name="l02649"></a>02649                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == MILITIA_TEAM &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> != <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> )
<a name="l02650"></a>02650                   {
<a name="l02651"></a>02651                         <span class="comment">// go on alert!</span>
<a name="l02652"></a>02652                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> = <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>;
<a name="l02653"></a>02653                   }
<a name="l02654"></a>02654                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( CREATURE_OR_BLOODCAT( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l02655"></a>02655                   {
<a name="l02656"></a>02656                         <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> != <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> != <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffbc5202d0fef4bcd4a4625750d02a724">ONCALL</a>)
<a name="l02657"></a>02657                         {
<a name="l02658"></a>02658                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> = <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>;
<a name="l02659"></a>02659                         }
<a name="l02660"></a>02660                   }     
<a name="l02661"></a>02661 
<a name="l02662"></a>02662                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1b5483f377943cd6d7fb1589d0d391321">WARDEN</a> )
<a name="l02663"></a>02663                   {
<a name="l02664"></a>02664                         <span class="comment">// Tixa</span>
<a name="l02665"></a>02665                         <a class="code" href="ai_8h.html#786a820cc1cb9dc15d5b67e4cfb8623c">MakeClosestEnemyChosenOne</a>();
<a name="l02666"></a>02666                   }
<a name="l02667"></a>02667                   <span class="keywordflow">break</span>;
<a name="l02668"></a>02668       }
<a name="l02669"></a>02669 }
<a name="l02670"></a>02670 
<a name="l02671"></a><a class="code" href="AIMain_8cpp.html#b36bf5fba41996d41bde7f0de4e11beb">02671</a> <span class="keywordtype">void</span> <a class="code" href="AIInternals_8h.html#b36bf5fba41996d41bde7f0de4e11beb">InitAttackType</a>(<a class="code" href="structATTACKTYPE.html">ATTACKTYPE</a> *pAttack)
<a name="l02672"></a>02672 {
<a name="l02673"></a>02673  <span class="comment">// initialize the given bestAttack structure fields to their default values</span>
<a name="l02674"></a>02674  pAttack-&gt;<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a>          = FALSE;
<a name="l02675"></a>02675  pAttack-&gt;<a class="code" href="structATTACKTYPE.html#4a3c834866b912b3fa371ac855e7be42">ubOpponent</a>          = NOBODY;
<a name="l02676"></a>02676  pAttack-&gt;<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a>           = 0;
<a name="l02677"></a>02677  pAttack-&gt;<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a> = 0;
<a name="l02678"></a>02678  pAttack-&gt;<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>                                     = NOWHERE;
<a name="l02679"></a>02679  pAttack-&gt;<a class="code" href="structATTACKTYPE.html#cdf5e73b5e726219882c6aec55364a30">iAttackValue</a>                    = 0;
<a name="l02680"></a>02680  pAttack-&gt;<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a>            = 0;
<a name="l02681"></a>02681 }
<a name="l02682"></a>02682 
<a name="l02683"></a><a class="code" href="AIMain_8cpp.html#a62be813aac8f8417cf3a0f3ea2059c5">02683</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#a62be813aac8f8417cf3a0f3ea2059c5">HandleInitialRedAlert</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTeam, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubCommunicate)
<a name="l02684"></a>02684 {
<a name="l02685"></a>02685 <span class="comment">/*</span>
<a name="l02686"></a>02686 <span class="comment"> if (ubCommunicate)</span>
<a name="l02687"></a>02687 <span class="comment">  {</span>
<a name="l02688"></a>02688 <span class="comment">   NetSend.msgType = NET_RED_ALERT;</span>
<a name="l02689"></a>02689 <span class="comment">   SendNetData(ALL_NODES);</span>
<a name="l02690"></a>02690 <span class="comment">  }*/</span>
<a name="l02691"></a>02691 
<a name="l02692"></a>02692  <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[bTeam].<a class="code" href="structTacticalTeamType.html#38333ae5abadbdccc9ca26e3edefe942">bAwareOfOpposition</a> == FALSE )
<a name="l02693"></a>02693  {
<a name="l02694"></a>02694 <span class="preprocessor">      #ifdef JA2TESTVERSION</span>
<a name="l02695"></a>02695 <span class="preprocessor"></span>            <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_RED, MSG_ERROR, L<span class="stringliteral">"Enemies on team %d prompted to go on RED ALERT!"</span>, bTeam );
<a name="l02696"></a>02696 <span class="preprocessor">      #endif</span>
<a name="l02697"></a>02697 <span class="preprocessor"></span> }
<a name="l02698"></a>02698 
<a name="l02699"></a>02699       <span class="comment">// if there is a stealth mission in progress here, and a panic trigger exists</span>
<a name="l02700"></a>02700       <span class="keywordflow">if</span> ( bTeam == ENEMY_TEAM &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#965c762739e2731d1af1bb56e3485d0f">fPanicFlags</a> &amp; PANIC_TRIGGERS_HERE) )
<a name="l02701"></a>02701       {
<a name="l02702"></a>02702             <span class="comment">// they're going to be aware of us now!</span>
<a name="l02703"></a>02703             <a class="code" href="ai_8h.html#786a820cc1cb9dc15d5b67e4cfb8623c">MakeClosestEnemyChosenOne</a>();
<a name="l02704"></a>02704       }
<a name="l02705"></a>02705 
<a name="l02706"></a>02706       <span class="keywordflow">if</span> ( bTeam == ENEMY_TEAM &amp;&amp; <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a> == 3 &amp;&amp; <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a> == MAP_ROW_P &amp;&amp; <a class="code" href="strategicmap_8cpp.html#da715721a8ceedd42acf6ddb33e63ce0">gbWorldSectorZ</a> == 0 )
<a name="l02707"></a>02707       {
<a name="l02708"></a>02708             <span class="comment">// alert Queen and Joe if they are around</span>
<a name="l02709"></a>02709             <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *                 <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l02710"></a>02710             
<a name="l02711"></a>02711             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Soldier_01Profile_8cpp.html#2a54c4a06df8ed61529646f23682ef9d">FindSoldierByProfileID</a>( <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa158561257be7e2f96f82c0fdb51d7f964">QUEEN</a>, FALSE );
<a name="l02712"></a>02712             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l02713"></a>02713             {
<a name="l02714"></a>02714                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>;
<a name="l02715"></a>02715             }
<a name="l02716"></a>02716 
<a name="l02717"></a>02717             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Soldier_01Profile_8cpp.html#2a54c4a06df8ed61529646f23682ef9d">FindSoldierByProfileID</a>( <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa192316e5a46397f20e0a7d967488a290a">JOE</a>, FALSE );
<a name="l02718"></a>02718             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l02719"></a>02719             {
<a name="l02720"></a>02720                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>;
<a name="l02721"></a>02721             }
<a name="l02722"></a>02722       }
<a name="l02723"></a>02723 
<a name="l02724"></a>02724  <span class="comment">// open and close certain doors when this happens</span>
<a name="l02725"></a>02725  <span class="comment">//AffectDoors(OPENDOORS, MapExt[Status.cur_sector].opendoors);</span>
<a name="l02726"></a>02726  <span class="comment">//AffectDoors(CLOSEDOORS,MapExt[Status.cur_sector].closedoors);</span>
<a name="l02727"></a>02727 
<a name="l02728"></a>02728  <span class="comment">// remember enemies are alerted, prevent another red alert from happening</span>
<a name="l02729"></a>02729  <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ bTeam ].<a class="code" href="structTacticalTeamType.html#38333ae5abadbdccc9ca26e3edefe942">bAwareOfOpposition</a> = TRUE;
<a name="l02730"></a>02730 
<a name="l02731"></a>02731 }
<a name="l02732"></a>02732 
<a name="l02733"></a><a class="code" href="AIMain_8cpp.html#d74e64649076c7ccf1f7e8c48012877e">02733</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#d74e64649076c7ccf1f7e8c48012877e">ManChecksOnFriends</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l02734"></a>02734 {
<a name="l02735"></a>02735  <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiLoop;
<a name="l02736"></a>02736  <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pFriend;
<a name="l02737"></a>02737  <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sDistVisible;
<a name="l02738"></a>02738 
<a name="l02739"></a>02739  <span class="comment">// THIS ROUTINE SHOULD ONLY BE CALLED FOR SOLDIERS ON STATUS GREEN or YELLOW</span>
<a name="l02740"></a>02740 
<a name="l02741"></a>02741  <span class="comment">// go through each soldier, looking for "friends" (soldiers on same side)</span>
<a name="l02742"></a>02742  <span class="keywordflow">for</span> (uiLoop = 0; uiLoop &lt; <a class="code" href="Overhead_8cpp.html#d627c552ede524c66140f3410174d3d4">guiNumMercSlots</a>; uiLoop++)
<a name="l02743"></a>02743   {
<a name="l02744"></a>02744    pFriend = <a class="code" href="Overhead_8cpp.html#b139938f6b836645dd67972944d21bf3">MercSlots</a>[ uiLoop ];
<a name="l02745"></a>02745 
<a name="l02746"></a>02746        <span class="keywordflow">if</span> (!pFriend)
<a name="l02747"></a>02747        {
<a name="l02748"></a>02748             <span class="keywordflow">continue</span>;
<a name="l02749"></a>02749        }
<a name="l02750"></a>02750 
<a name="l02751"></a>02751    <span class="comment">// if this man is neutral / NOT on my side, he's not my friend</span>
<a name="l02752"></a>02752    <span class="keywordflow">if</span> (pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a> || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1e61c0006bacccf9457c3f6c43607578">bSide</a> != pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#1e61c0006bacccf9457c3f6c43607578">bSide</a>))
<a name="l02753"></a>02753      <span class="keywordflow">continue</span>;  <span class="comment">// next merc</span>
<a name="l02754"></a>02754 
<a name="l02755"></a>02755    <span class="comment">// if this merc is actually ME</span>
<a name="l02756"></a>02756    <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> (pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>)
<a name="l02757"></a>02757      <span class="keywordflow">continue</span>;  <span class="comment">// next merc</span>
<a name="l02758"></a>02758 
<a name="l02759"></a>02759    sDistVisible = <a class="code" href="opplist_8cpp.html#3024b66f9b450ab359bf03734c3aad9b">DistanceVisible</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7680b9f541cb30851967400ce4b0f2807">DIRECTION_IRRELEVANT</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7680b9f541cb30851967400ce4b0f2807">DIRECTION_IRRELEVANT</a>, pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, pFriend );
<a name="l02760"></a>02760    <span class="comment">// if we can see far enough to see this friend</span>
<a name="l02761"></a>02761    <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> (<a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>,pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>) &lt;= sDistVisible)
<a name="l02762"></a>02762     {
<a name="l02763"></a>02763      <span class="comment">// and can trace a line of sight to his x,y coordinates</span>
<a name="l02764"></a>02764      <span class="comment">//if (1) //*** SoldierToSoldierLineOfSightTest(pSoldier,pFriend,STRAIGHT,TRUE))</span>
<a name="l02765"></a>02765              <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> (<a class="code" href="LOS_8cpp.html#1687abe11a81ed4e42b9d83f7510304c">SoldierToSoldierLineOfSightTest</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, pFriend, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)sDistVisible, TRUE))
<a name="l02766"></a>02766               {
<a name="l02767"></a>02767                         <span class="comment">// if my friend is in battle or something is clearly happening there</span>
<a name="l02768"></a>02768                         <span class="keywordflow">if</span> ((pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> &gt;= <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>) || pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#4d7d451394eccbed289b3276bc325722">bUnderFire</a> || (pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a> &lt; OKLIFE))
<a name="l02769"></a>02769                         {
<a name="l02770"></a>02770                         #ifdef DEBUGDECISIONS
<a name="l02771"></a>02771                               <a class="code" href="Types_8h.html#94ebfccc6e846c28751f8d616371f1e5">STR16</a> tempstr;
<a name="l02772"></a>02772                               sprintf((CHAR *)tempstr,<span class="stringliteral">"%s sees %s on alert, goes to RED ALERT!"</span>,pSoldier-&gt;name,pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a> );
<a name="l02773"></a>02773                               <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l02774"></a>02774 <span class="preprocessor">                        #endif</span>
<a name="l02775"></a>02775 <span class="preprocessor"></span>
<a name="l02776"></a>02776                               pSoldier-&gt;bAlertStatus = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>;
<a name="l02777"></a>02777                               <a class="code" href="ai_8h.html#7753064f76c879dd64430c27c5b259ff">CheckForChangingOrders</a>(pSoldier);
<a name="l02778"></a>02778                               <a class="code" href="ai_8h.html#af2540c1459f467488884f02b709c0ae">SetNewSituation</a>( pSoldier );
<a name="l02779"></a>02779                               <span class="keywordflow">break</span>;         <span class="comment">// don't bother checking on any other friends</span>
<a name="l02780"></a>02780                         }
<a name="l02781"></a>02781                         <span class="keywordflow">else</span>
<a name="l02782"></a>02782                         {
<a name="l02783"></a>02783                               <span class="comment">// if he seems suspicious or acts like he thought he heard something</span>
<a name="l02784"></a>02784                               <span class="comment">// and I'm still on status GREEN</span>
<a name="l02785"></a>02785                               <span class="keywordflow">if</span> ((pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> == <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726530ecf4468b8fd828fc47998fef0f857fd">STATUS_YELLOW</a>) &amp;&amp;
<a name="l02786"></a>02786                                     (pSoldier-&gt;bAlertStatus &lt; <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726530ecf4468b8fd828fc47998fef0f857fd">STATUS_YELLOW</a>))
<a name="l02787"></a>02787                               {
<a name="l02788"></a>02788 <span class="preprocessor">                              #ifdef TESTVERSION</span>
<a name="l02789"></a>02789 <span class="preprocessor"></span>                                    sprintf((CHAR *)tempstr,<span class="stringliteral">"TEST MSG: %s sees %s listening, goes to YELLOW ALERT!"</span>,pSoldier-&gt;name,ExtMen[pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>].name);
<a name="l02790"></a>02790                                     PopMessage(tempstr);
<a name="l02791"></a>02791 <span class="preprocessor">                              #endif</span>
<a name="l02792"></a>02792 <span class="preprocessor"></span>                                    pSoldier-&gt;bAlertStatus = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726530ecf4468b8fd828fc47998fef0f857fd">STATUS_YELLOW</a>;    <span class="comment">// also get suspicious</span>
<a name="l02793"></a>02793                                     <a class="code" href="ai_8h.html#af2540c1459f467488884f02b709c0ae">SetNewSituation</a>( pSoldier );
<a name="l02794"></a>02794                                     pSoldier-&gt;sNoiseGridno = pFriend-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;  <span class="comment">// pretend FRIEND made noise</span>
<a name="l02795"></a>02795                                     pSoldier-&gt;ubNoiseVolume = 3;                <span class="comment">// remember this for 3 turns</span>
<a name="l02796"></a>02796                                     <span class="comment">// keep check other friends, too, in case any are already on RED</span>
<a name="l02797"></a>02797                               }
<a name="l02798"></a>02798                         }
<a name="l02799"></a>02799       }
<a name="l02800"></a>02800     }
<a name="l02801"></a>02801   }
<a name="l02802"></a>02802 }
<a name="l02803"></a>02803 
<a name="l02804"></a>02804 
<a name="l02805"></a><a class="code" href="AIMain_8cpp.html#af2540c1459f467488884f02b709c0ae">02805</a> <span class="keywordtype">void</span> <a class="code" href="ai_8h.html#af2540c1459f467488884f02b709c0ae">SetNewSituation</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l02806"></a>02806 {
<a name="l02807"></a>02807       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> )
<a name="l02808"></a>02808       {
<a name="l02809"></a>02809             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#30114897a2229659bda75e47c604b742">ubQuoteRecord</a> == 0 &amp;&amp; !<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#1aa7fa93044da366b9072c35e0a9b297">fAutoBandageMode</a> &amp;&amp; !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a> &amp;&amp; <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; ENGAGED_IN_CONV) )
<a name="l02810"></a>02810             {
<a name="l02811"></a>02811                   <span class="comment">// allow new situation to be set</span>
<a name="l02812"></a>02812                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1897f6330181ea58e948eaa23a5fd75c">bNewSituation</a> = IS_NEW_SITUATION;
<a name="l02813"></a>02813 
<a name="l02814"></a>02814       <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a> != 0 )
<a name="l02815"></a>02815       {
<a name="l02816"></a>02816                 DebugMsg( <a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>, DBG_LEVEL_3, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"BBBBBB bNewSituation is set for %d when ABC !=0."</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l02817"></a>02817       }
<a name="l02818"></a>02818 
<a name="l02819"></a>02819                   <span class="keywordflow">if</span> ( !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) || (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; REALTIME) )
<a name="l02820"></a>02820                   {
<a name="l02821"></a>02821                         <span class="comment">// reset delay if necessary!</span>
<a name="l02822"></a>02822                         RESETTIMECOUNTER( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#67be2d37d159d78626d798f77351b8f5">AICounter</a>, <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 1000 ) );
<a name="l02823"></a>02823                   }
<a name="l02824"></a>02824             }
<a name="l02825"></a>02825       }
<a name="l02826"></a>02826 }
<a name="l02827"></a>02827 
<a name="l02828"></a>02828 
<a name="l02829"></a><a class="code" href="AIMain_8cpp.html#b8b92563a3ad0716fede67c6bdae2c13">02829</a> <span class="keywordtype">void</span> <a class="code" href="AIMain_8cpp.html#b8b92563a3ad0716fede67c6bdae2c13">HandleAITacticalTraversal</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l02830"></a>02830 {
<a name="l02831"></a>02831       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubQuoteActionID = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a>;
<a name="l02832"></a>02832 
<a name="l02833"></a>02833       <a class="code" href="NPC_8cpp.html#797b0481f3e86fbf50a944373b428d20">HandleNPCChangesForTacticalTraversal</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l02834"></a>02834 
<a name="l02835"></a>02835       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE &amp;&amp; <a class="code" href="NPC_8cpp.html#3d3de240eb5512c19bec3004309efc90">NPCHasUnusedRecordWithGivenApproach</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>, <a class="code" href="NPC_8h.html#fe4ba80db4eca5533465fe913160a13a26b714fd97a5c458f9cb317858a5da89">APPROACH_DONE_TRAVERSAL</a> ) )
<a name="l02836"></a>02836       {
<a name="l02837"></a>02837             <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].<a class="code" href="structMERCPROFILESTRUCT.html#ef69000d93333be8514a29b0ad500888">ubMiscFlags3</a> |= PROFILE_MISC_FLAG3_HANDLE_DONE_TRAVERSAL;
<a name="l02838"></a>02838       }
<a name="l02839"></a>02839       <span class="keywordflow">else</span>
<a name="l02840"></a>02840       {
<a name="l02841"></a>02841             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> = 0;
<a name="l02842"></a>02842       }
<a name="l02843"></a>02843 
<a name="l02844"></a>02844 <span class="preprocessor">      #ifdef TESTAICONTROL</span>
<a name="l02845"></a>02845 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l02846"></a>02846             {
<a name="l02847"></a>02847                   <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( (<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>)<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Ending turn for %d because traversing out"</span>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) );
<a name="l02848"></a>02848             }
<a name="l02849"></a>02849 <span class="preprocessor">      #endif</span>
<a name="l02850"></a>02850 <span class="preprocessor"></span>
<a name="l02851"></a>02851       <a class="code" href="ai_8h.html#3becef04af81cd1aacc647b0523b9aba">EndAIGuysTurn</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l02852"></a>02852       <a class="code" href="opplist_8cpp.html#e2c160d5301f86846dcf6242345152aa">RemoveManAsTarget</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l02853"></a>02853       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == CIV_TEAM &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp; AI_CHECK_SCHEDULE)
<a name="l02854"></a>02854       {
<a name="l02855"></a>02855             <a class="code" href="Overhead_8cpp.html#abefef640578b24609759889f2048ce1">MoveSoldierFromMercToAwaySlot</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l02856"></a>02856             pSoldier-&gt;bInSector = FALSE;
<a name="l02857"></a>02857       }
<a name="l02858"></a>02858       <span class="keywordflow">else</span>
<a name="l02859"></a>02859       {                                               
<a name="l02860"></a>02860             <span class="keywordtype">int</span> iMapX = <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a>;
<a name="l02861"></a>02861             <span class="keywordtype">int</span> iMapY = <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a>;
<a name="l02862"></a>02862 
<a name="l02863"></a>02863             <span class="keywordflow">switch</span>( ubQuoteActionID )
<a name="l02864"></a>02864             {
<a name="l02865"></a>02865             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831efe48f9c2ccb282afc7ed0f779fe67c4b1">QUOTE_ACTION_ID_TRAVERSE_EAST</a>:
<a name="l02866"></a>02866                   ++iMapX;
<a name="l02867"></a>02867                   <span class="keywordflow">break</span>;
<a name="l02868"></a>02868             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831ef970250cece3c0655b08575de2d5cb4f0">QUOTE_ACTION_ID_TRAVERSE_WEST</a>:
<a name="l02869"></a>02869                   --iMapX;
<a name="l02870"></a>02870                   <span class="keywordflow">break</span>;
<a name="l02871"></a>02871             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831effbbd245a12fc9d6872c26ef221f11939">QUOTE_ACTION_ID_TRAVERSE_SOUTH</a>:
<a name="l02872"></a>02872                   ++iMapY;
<a name="l02873"></a>02873                   <span class="keywordflow">break</span>;
<a name="l02874"></a>02874             <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831ef0c9f3f8fb8f374c02f97081c2caa71c7">QUOTE_ACTION_ID_TRAVERSE_NORTH</a>:
<a name="l02875"></a>02875                   --iMapY;
<a name="l02876"></a>02876                   <span class="keywordflow">break</span>;
<a name="l02877"></a>02877             }
<a name="l02878"></a>02878       
<a name="l02879"></a>02879             <a class="code" href="structSECTORINFO.html">SECTORINFO</a> *pSectorInfo = &amp;( <a class="code" href="Campaign_01Types_8h.html#d83c6f699f17a47cf6a662c91d959126">SectorInfo</a>[ SECTOR( iMapX, iMapY ) ] );
<a name="l02880"></a>02880 
<a name="l02881"></a>02881             <span class="keywordflow">switch</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#44fa01e0e2eef538a2566810626be040">ubSoldierClass</a> )
<a name="l02882"></a>02882             {
<a name="l02883"></a>02883             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Control_8h.html#d559b3ed307be626eacea8b56942de61a3398ebdb00774b852a6dc6a1ba38764">SOLDIER_CLASS_ELITE</a>:
<a name="l02884"></a>02884                   ++pSectorInfo-&gt;<a class="code" href="structSECTORINFO.html#3c5312672399c40ec5a395e8bcfb0104">ubNumElites</a>;
<a name="l02885"></a>02885                   <span class="keywordflow">break</span>;
<a name="l02886"></a>02886 
<a name="l02887"></a>02887             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Control_8h.html#d559b3ed307be626eacea8b56942de61e155251ca19fc71034c52119253642b8">SOLDIER_CLASS_ARMY</a>:
<a name="l02888"></a>02888                   ++pSectorInfo-&gt;<a class="code" href="structSECTORINFO.html#e36540b93256cfa71e45382f133d3696">ubNumTroops</a>;
<a name="l02889"></a>02889                   <span class="keywordflow">break</span>;
<a name="l02890"></a>02890 
<a name="l02891"></a>02891             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Control_8h.html#d559b3ed307be626eacea8b56942de61b149e8fdf658384dd176ef9e706f10dd">SOLDIER_CLASS_ADMINISTRATOR</a>:
<a name="l02892"></a>02892                   ++pSectorInfo-&gt;<a class="code" href="structSECTORINFO.html#d7d5ee63c0dc2ad3164c83541bd80906">ubNumAdmins</a>;
<a name="l02893"></a>02893                   <span class="keywordflow">break</span>;
<a name="l02894"></a>02894 
<a name="l02895"></a>02895             }
<a name="l02896"></a>02896 
<a name="l02897"></a>02897             <a class="code" href="Queen_01Command_8cpp.html#1772190a0a0c19dfb080e209c6911bf3">ProcessQueenCmdImplicationsOfDeath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );       
<a name="l02898"></a>02898             <a class="code" href="Soldier_01Create_8cpp.html#5761f369bb132d093e5ce84db76fd7cf">TacticalRemoveSoldier</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l02899"></a>02899       }
<a name="l02900"></a>02900       <a class="code" href="Overhead_8cpp.html#56ffc3d04b07d68a0f1af946454f861c">CheckForEndOfBattle</a>( TRUE );
<a name="l02901"></a>02901 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Sep 9 13:47:50 2006 for Build by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
