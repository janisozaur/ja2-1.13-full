<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Build: DecideAction.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_3179ea33d55a76dc38212d9eab798728.html">export</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e5664b4b56927c8728eb3192fa60e338.html">hdc2</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_1eb12a41a47efb9efcd82fa98f4f4dbd.html">FTP</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_80cc1f21a78ab7941088ea567f236150.html">ja2src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_994ab287602efefceafe55287a3657d6.html">Build</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_44103419c8ed76f1d39ea891be619902.html">TacticalAI</a></div>
<h1>DecideAction.cpp</h1><a href="DecideAction_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifdef PRECOMPILEDHEADERS</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">      #include "<a class="code" href="AI_01All_8h.html">AI All.h</a>"</span>
<a name="l00003"></a>00003 <span class="preprocessor">  #include "strategic status.h"</span>
<a name="l00004"></a>00004 <span class="preprocessor">#else</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor">      #include "<a class="code" href="ai_8h.html">ai.h</a>"</span>
<a name="l00006"></a>00006 <span class="preprocessor">      #include "<a class="code" href="AIInternals_8h.html">AIInternals.h</a>"</span>
<a name="l00007"></a>00007 <span class="preprocessor">      #include "Isometric utils.h"</span>
<a name="l00008"></a>00008 <span class="preprocessor">      #include "<a class="code" href="Points_8h.html">Points.h</a>"</span>
<a name="l00009"></a>00009 <span class="preprocessor">      #include "overhead.h"</span>
<a name="l00010"></a>00010 <span class="preprocessor">      #include "<a class="code" href="opplist_8h.html">opplist.h</a>"</span>
<a name="l00011"></a>00011 <span class="preprocessor">      #include "items.h"</span>
<a name="l00012"></a>00012 <span class="preprocessor">      #include "<a class="code" href="Weapons_8h.html">Weapons.h</a>"</span>
<a name="l00013"></a>00013 <span class="preprocessor">      #include "<a class="code" href="NPC_8h.html">NPC.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">      #include "<a class="code" href="Soldier_01Functions_8h.html">Soldier Functions.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">      #include "<a class="code" href="worldman_8h.html">worldman.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">      #include "<a class="code" href="Scheduling_8h.html">Scheduling.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">      #include "Message.h"</span>
<a name="l00018"></a>00018 <span class="preprocessor">      #include "<a class="code" href="Structure_01Wrap_8h.html">Structure Wrap.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">      #include "<a class="code" href="Keys_8h.html">Keys.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">      #include "pathai.h"</span>
<a name="l00021"></a>00021 <span class="preprocessor">      #include "<a class="code" href="Render_01Fun_8h.html">Render Fun.h</a>"</span>
<a name="l00022"></a>00022 <span class="preprocessor">      #include "<a class="code" href="Boxing_8h.html">Boxing.h</a>"</span>
<a name="l00023"></a>00023 <span class="comment">//    #include "Air Raid.h"</span>
<a name="l00024"></a>00024 <span class="preprocessor">#endif</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span>
<a name="l00026"></a>00026 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bDirection, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bNewStance );
<a name="l00027"></a>00027 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="TeamTurns_8cpp.html#782955f80e251720a735649d4e8a5987">gfHiddenInterrupt</a>;
<a name="l00028"></a>00028 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Strategic_01AI_8cpp.html#8029ae4e0579eaec31822e170536fe40">gfUseAlternateQueenPosition</a>;
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="comment">// global status time counters to determine what takes the most time</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#ifdef AI_TIMING_TESTS</span>
<a name="l00033"></a><a class="code" href="DecideAction_8cpp.html#fd1fe6002b1a67e42007e9d57edfe1c3">00033</a> <span class="preprocessor"></span><a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> <a class="code" href="Items_8cpp.html#560f288a33343e5714f7190dd73532f5">guiGreenTimeTotal</a> = 0, <a class="code" href="Items_8cpp.html#fd1fe6002b1a67e42007e9d57edfe1c3">guiYellowTimeTotal</a> = 0, <a class="code" href="Items_8cpp.html#188ca4816426ac56fb709cf23b35d31c">guiRedTimeTotal</a> = 0, <a class="code" href="Items_8cpp.html#defec480a0ddf33c9ace05ab1478ed1b">guiBlackTimeTotal</a> = 0;
<a name="l00034"></a><a class="code" href="DecideAction_8cpp.html#714829a7f2d911a0994dcf951fca197f">00034</a> <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> <a class="code" href="Items_8cpp.html#6274f991f4dd82f3a1852fe99ec3c2ad">guiGreenCounter</a> = 0, <a class="code" href="Items_8cpp.html#714829a7f2d911a0994dcf951fca197f">guiYellowCounter</a> = 0, <a class="code" href="Items_8cpp.html#7188e6c7639fc54414157c7dfbc0fc97">guiRedCounter</a> = 0, <a class="code" href="Items_8cpp.html#3400808251577fa392a76aae9bdf9338">guiBlackCounter</a> = 0;
<a name="l00035"></a><a class="code" href="DecideAction_8cpp.html#777a80923e90745695ebccfb6cadfdcb">00035</a> <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> <a class="code" href="Items_8cpp.html#777a80923e90745695ebccfb6cadfdcb">guiRedSeekTimeTotal</a> = 0, <a class="code" href="Items_8cpp.html#f98f048b9ccbbf94ea276e610dcd8a97">guiRedHelpTimeTotal</a> = 0, <a class="code" href="Items_8cpp.html#f284d07c6ff0aade0111b945a808cd7e">guiRedHideTimeTotal</a> = 0;
<a name="l00036"></a><a class="code" href="DecideAction_8cpp.html#479723c5f3ddc48634f3bf7801a8e0c7">00036</a> <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> <a class="code" href="Items_8cpp.html#479723c5f3ddc48634f3bf7801a8e0c7">guiRedSeekCounter</a> = 0, <a class="code" href="Items_8cpp.html#5a9e2216edcc54e5c22b8fb35f816a25">guiRedHelpCounter</a> = 0; <a class="code" href="Items_8cpp.html#a045a781ee61a69bbdf9eb56e1ff9721">guiRedHideCounter</a> = 0;
<a name="l00037"></a>00037 <span class="preprocessor">#endif</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span>
<a name="l00039"></a>00039 <span class="preprocessor">#define CENTER_OF_RING 11237</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a>00041 <span class="preprocessor">#define MAX_FLANKS_RED 15</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="preprocessor">#define MAX_FLANKS_YELLOW 25</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span>
<a name="l00044"></a>00044 <span class="preprocessor">#define MIN_FLANK_DIST_YELLOW 10 * STRAIGHT_RATIO</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#define MAX_FLANK_DIST_YELLOW 50 * STRAIGHT_RATIO</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="preprocessor">#define MIN_FLANK_DIST_RED 10 * STRAIGHT_RATIO</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#define MAX_FLANK_DIST_RED 40 * STRAIGHT_RATIO</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span>
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">00051</a> <span class="keywordtype">void</span> <a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">DoneScheduleAction</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00052"></a>00052 {
<a name="l00053"></a>00053       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp;= (~AI_CHECK_SCHEDULE);
<a name="l00054"></a>00054       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a> = 0;
<a name="l00055"></a>00055       <a class="code" href="Scheduling_8cpp.html#d7306e88717d933af446f96d37b112af">PostNextSchedule</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="DecideAction_8cpp.html#c1877b5eee7838388d280333756d0d01">00058</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="DecideAction_8cpp.html#c1877b5eee7838388d280333756d0d01">DecideActionSchedule</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060       <a class="code" href="structSCHEDULENODE.html">SCHEDULENODE</a> *          pSchedule;
<a name="l00061"></a>00061       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                                     iScheduleIndex;
<a name="l00062"></a>00062       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                                     ubScheduleAction;
<a name="l00063"></a>00063       <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>                                    usGridNo1, usGridNo2;
<a name="l00064"></a>00064       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                     sX, sY;
<a name="l00065"></a>00065       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                                      bDirection;
<a name="l00066"></a>00066       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a> *                   pStructure;
<a name="l00067"></a>00067       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                                   fDoUseDoor;
<a name="l00068"></a>00068       <a class="code" href="structDOOR__STATUS.html">DOOR_STATUS</a> *                 pDoorStatus;
<a name="l00069"></a>00069       
<a name="l00070"></a>00070       pSchedule = <a class="code" href="Scheduling_8cpp.html#442c74f764c0c17e57725967a7515cff">GetSchedule</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f42305317ffec1fd9d924ffc592896b6">ubScheduleID</a> );
<a name="l00071"></a>00071       <span class="keywordflow">if</span> (!pSchedule)
<a name="l00072"></a>00072       {
<a name="l00073"></a>00073             <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00074"></a>00074       }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076       <span class="keywordflow">if</span> (pSchedule-&gt;<a class="code" href="structSCHEDULENODE.html#3b102ddd2d03ba6da887bbf39015f821">usFlags</a> &amp; SCHEDULE_FLAGS_ACTIVE1)
<a name="l00077"></a>00077       {
<a name="l00078"></a>00078             iScheduleIndex = 0;
<a name="l00079"></a>00079       }
<a name="l00080"></a>00080       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pSchedule-&gt;<a class="code" href="structSCHEDULENODE.html#3b102ddd2d03ba6da887bbf39015f821">usFlags</a> &amp; SCHEDULE_FLAGS_ACTIVE2)
<a name="l00081"></a>00081       {
<a name="l00082"></a>00082             iScheduleIndex = 1;
<a name="l00083"></a>00083       }
<a name="l00084"></a>00084       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pSchedule-&gt;<a class="code" href="structSCHEDULENODE.html#3b102ddd2d03ba6da887bbf39015f821">usFlags</a> &amp; SCHEDULE_FLAGS_ACTIVE3)
<a name="l00085"></a>00085       {
<a name="l00086"></a>00086             iScheduleIndex = 2;
<a name="l00087"></a>00087       }
<a name="l00088"></a>00088       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pSchedule-&gt;<a class="code" href="structSCHEDULENODE.html#3b102ddd2d03ba6da887bbf39015f821">usFlags</a> &amp; SCHEDULE_FLAGS_ACTIVE4)
<a name="l00089"></a>00089       {
<a name="l00090"></a>00090             iScheduleIndex = 3;
<a name="l00091"></a>00091       }
<a name="l00092"></a>00092       <span class="keywordflow">else</span>
<a name="l00093"></a>00093       {
<a name="l00094"></a>00094             <span class="comment">// error!</span>
<a name="l00095"></a>00095             <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00096"></a>00096       }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098       ubScheduleAction = pSchedule-&gt;<a class="code" href="structSCHEDULENODE.html#7254a407b8916738ea5e706b6b503b7b">ubAction</a>[ iScheduleIndex ];
<a name="l00099"></a>00099       usGridNo1 = pSchedule-&gt;<a class="code" href="structSCHEDULENODE.html#475c9bc0353131ecaceb1b9f31b3ff31">usData1</a>[ iScheduleIndex ];
<a name="l00100"></a>00100       usGridNo2 = pSchedule-&gt;<a class="code" href="structSCHEDULENODE.html#6606765a168cbb9f8d84094f6726d960">usData2</a>[ iScheduleIndex ];
<a name="l00101"></a>00101 
<a name="l00102"></a>00102       <span class="comment">// assume soldier is awake unless the action is a sleep</span>
<a name="l00103"></a>00103       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp;= ~(AI_ASLEEP);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105       <span class="keywordflow">switch</span>( ubScheduleAction )
<a name="l00106"></a>00106       {
<a name="l00107"></a>00107             <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e423e5ee19f521d74b55669c1f2dae0fc2">SCHEDULE_ACTION_LOCKDOOR</a>:
<a name="l00108"></a>00108                   <span class="comment">//Uses first gridno for locking door, then second to move to after door is locked.</span>
<a name="l00109"></a>00109                   <span class="comment">//It is possible that the second gridno will border the edge of the map, meaning that</span>
<a name="l00110"></a>00110                   <span class="comment">//the individual will walk off of the map.</span>
<a name="l00111"></a>00111                   <span class="comment">//If this is a "merchant", make sure that nobody occupies the building/room.</span>
<a name="l00112"></a>00112 
<a name="l00113"></a>00113                   <span class="keywordflow">switch</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a> )
<a name="l00114"></a>00114                   {
<a name="l00115"></a>00115                         <span class="keywordflow">case</span> 0: <span class="comment">// move to gridno specified</span>
<a name="l00116"></a>00116                               <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == usGridNo1)
<a name="l00117"></a>00117                               {
<a name="l00118"></a>00118                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a>++;
<a name="l00119"></a>00119                                     <span class="comment">// fall through</span>
<a name="l00120"></a>00120                               }
<a name="l00121"></a>00121                               <span class="keywordflow">else</span>
<a name="l00122"></a>00122                               {
<a name="l00123"></a>00123                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = usGridNo1;
<a name="l00124"></a>00124                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l00125"></a>00125                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a> );
<a name="l00126"></a>00126                               }
<a name="l00127"></a>00127                               <span class="comment">// fall through</span>
<a name="l00128"></a>00128                         <span class="keywordflow">case</span> 1:
<a name="l00129"></a>00129                               <span class="comment">// start the door open: find the door...</span>
<a name="l00130"></a>00130                               usGridNo1 = <a class="code" href="Structure_01Wrap_8cpp.html#67173e35912aa91a496f9befd256e8aa">FindDoorAtGridNoOrAdjacent</a>( usGridNo1 );                          
<a name="l00131"></a>00131 
<a name="l00132"></a>00132                               <span class="keywordflow">if</span> ( usGridNo1 == NOWHERE )
<a name="l00133"></a>00133                               {
<a name="l00134"></a>00134                                     <span class="comment">// do nothing right now!</span>
<a name="l00135"></a>00135                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00136"></a>00136                               }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138                               pDoorStatus = <a class="code" href="Keys_8cpp.html#baeda4a8cbd53f6a4a750a15101bdeb2">GetDoorStatus</a>( usGridNo1 );
<a name="l00139"></a>00139                               <span class="keywordflow">if</span> (pDoorStatus &amp;&amp; pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_BUSY)
<a name="l00140"></a>00140                               {
<a name="l00141"></a>00141                                     <span class="comment">// do nothing right now!</span>
<a name="l00142"></a>00142                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00143"></a>00143                               }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145                               pStructure = <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( usGridNo1, STRUCTURE_ANYDOOR );
<a name="l00146"></a>00146                               <span class="keywordflow">if</span> (pStructure == NULL)
<a name="l00147"></a>00147                               {
<a name="l00148"></a>00148                                     fDoUseDoor = FALSE;
<a name="l00149"></a>00149                               }
<a name="l00150"></a>00150                               <span class="keywordflow">else</span>
<a name="l00151"></a>00151                               {
<a name="l00152"></a>00152                                     <span class="comment">// action-specific tests to not handle the door</span>
<a name="l00153"></a>00153                                     fDoUseDoor = TRUE;
<a name="l00154"></a>00154                               
<a name="l00155"></a>00155                                     <span class="keywordflow">if</span> (pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#5a803a00d8769236709b4f0665951383">fFlags</a> &amp; STRUCTURE_OPEN)
<a name="l00156"></a>00156                                     {
<a name="l00157"></a>00157                                           <span class="comment">// not only do we have to lock the door but </span>
<a name="l00158"></a>00158                                           <span class="comment">// close it too!</span>
<a name="l00159"></a>00159                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> |= AI_LOCK_DOOR_INCLUDES_CLOSE;
<a name="l00160"></a>00160                                     }
<a name="l00161"></a>00161                                     <span class="keywordflow">else</span>
<a name="l00162"></a>00162                                     {
<a name="l00163"></a>00163                                           <a class="code" href="structDOOR.html">DOOR</a> * pDoor;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165                                           pDoor = <a class="code" href="Keys_8cpp.html#19a7eb42b15e1c0a749124960b84e972">FindDoorInfoAtGridNo</a>( usGridNo1 );
<a name="l00166"></a>00166                                           <span class="keywordflow">if</span> (pDoor)
<a name="l00167"></a>00167                                           {
<a name="l00168"></a>00168                                                 <span class="keywordflow">if</span> (pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a>)
<a name="l00169"></a>00169                                                 {
<a name="l00170"></a>00170                                                       <span class="comment">// door already locked!</span>
<a name="l00171"></a>00171                                                       fDoUseDoor = FALSE;
<a name="l00172"></a>00172                                                 }
<a name="l00173"></a>00173                                                 <span class="keywordflow">else</span>
<a name="l00174"></a>00174                                                 {
<a name="l00175"></a>00175                                                       pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a> = TRUE;
<a name="l00176"></a>00176                                                 }
<a name="l00177"></a>00177                                           }
<a name="l00178"></a>00178                                           <span class="keywordflow">else</span>
<a name="l00179"></a>00179                                           {
<a name="l00180"></a>00180                                                 <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L<span class="stringliteral">"Schedule involved locked door at %d but there's no lock there!"</span>, usGridNo1 );
<a name="l00181"></a>00181                                                 fDoUseDoor = FALSE;
<a name="l00182"></a>00182                                           }
<a name="l00183"></a>00183                                     }
<a name="l00184"></a>00184                               }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186                               <span class="keywordflow">if</span> (fDoUseDoor)
<a name="l00187"></a>00187                               {
<a name="l00188"></a>00188                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = usGridNo1;
<a name="l00189"></a>00189                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8d52b4109959d549093a3709f0a0a39c">AI_ACTION_LOCK_DOOR</a> );
<a name="l00190"></a>00190                               }
<a name="l00191"></a>00191                               
<a name="l00192"></a>00192                               <span class="comment">// the door is already in the desired state, or it doesn't exist!</span>
<a name="l00193"></a>00193                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a>++;
<a name="l00194"></a>00194                               <span class="comment">// fall through</span>
<a name="l00195"></a>00195 
<a name="l00196"></a>00196                         <span class="keywordflow">case</span> 2:
<a name="l00197"></a>00197                               <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == usGridNo2 || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == NOWHERE)
<a name="l00198"></a>00198                               {
<a name="l00199"></a>00199                                     <span class="comment">// NOWHERE indicates we were supposed to go off map and have done so</span>
<a name="l00200"></a>00200                                     <a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">DoneScheduleAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00201"></a>00201 
<a name="l00202"></a>00202                                     <span class="keywordflow">if</span> ( pSoldier-&gt;sGridNo != NOWHERE )
<a name="l00203"></a>00203                                     {
<a name="l00204"></a>00204                                           pSoldier-&gt;usPatrolGrid[0] = pSoldier-&gt;sGridNo;
<a name="l00205"></a>00205                                     }
<a name="l00206"></a>00206                               }
<a name="l00207"></a>00207                               <span class="keywordflow">else</span>
<a name="l00208"></a>00208                               {
<a name="l00209"></a>00209                                     <span class="keywordflow">if</span> ( <a class="code" href="Isometric_01Utils_8cpp.html#83fbae6637fd2201d6f9cbb4477d4e73">GridNoOnEdgeOfMap</a>( usGridNo2, &amp;bDirection ) )
<a name="l00210"></a>00210                                     {
<a name="l00211"></a>00211                                           <span class="comment">// told to go to edge of map, so go off at that point!</span>
<a name="l00212"></a>00212                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> = <a class="code" href="AIInternals_8h.html#571514cff7694032571ca5e2b74101c1">GetTraversalQuoteActionID</a>( bDirection );
<a name="l00213"></a>00213                                     }
<a name="l00214"></a>00214                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = usGridNo2;
<a name="l00215"></a>00215                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l00216"></a>00216                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a> );
<a name="l00217"></a>00217                               }
<a name="l00218"></a>00218                               <span class="keywordflow">break</span>;
<a name="l00219"></a>00219                   }
<a name="l00220"></a>00220                   <span class="keywordflow">break</span>;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 
<a name="l00223"></a>00223             <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e4dd9a7da2cf3e0d23fd16e026b3ed3556">SCHEDULE_ACTION_UNLOCKDOOR</a>:
<a name="l00224"></a>00224             <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e46b07b5a8f9415aeeefd8696b54cdb463">SCHEDULE_ACTION_OPENDOOR</a>:
<a name="l00225"></a>00225             <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e4faa15a022490b37b5083048b0734a8a4">SCHEDULE_ACTION_CLOSEDOOR</a>:
<a name="l00226"></a>00226                   <span class="comment">//Uses first gridno for opening/closing/unlocking door, then second to move to after door is opened.</span>
<a name="l00227"></a>00227                   <span class="comment">//It is possible that the second gridno will border the edge of the map, meaning that</span>
<a name="l00228"></a>00228                   <span class="comment">//the individual will walk off of the map.</span>
<a name="l00229"></a>00229                   <span class="keywordflow">switch</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a> )
<a name="l00230"></a>00230                   {
<a name="l00231"></a>00231                         <span class="keywordflow">case</span> 0: <span class="comment">// move to gridno specified</span>
<a name="l00232"></a>00232                               <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == usGridNo1)
<a name="l00233"></a>00233                               {
<a name="l00234"></a>00234                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a>++;
<a name="l00235"></a>00235                                     <span class="comment">// fall through</span>
<a name="l00236"></a>00236                               }
<a name="l00237"></a>00237                               <span class="keywordflow">else</span>
<a name="l00238"></a>00238                               {
<a name="l00239"></a>00239                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = usGridNo1;
<a name="l00240"></a>00240                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l00241"></a>00241                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a> );
<a name="l00242"></a>00242                               }
<a name="l00243"></a>00243                               <span class="comment">// fall through</span>
<a name="l00244"></a>00244                         <span class="keywordflow">case</span> 1:
<a name="l00245"></a>00245                               <span class="comment">// start the door open: find the door...</span>
<a name="l00246"></a>00246                               usGridNo1 = <a class="code" href="Structure_01Wrap_8cpp.html#67173e35912aa91a496f9befd256e8aa">FindDoorAtGridNoOrAdjacent</a>( usGridNo1 );                          
<a name="l00247"></a>00247 
<a name="l00248"></a>00248                               <span class="keywordflow">if</span> ( usGridNo1 == NOWHERE )
<a name="l00249"></a>00249                               {
<a name="l00250"></a>00250                                     <span class="comment">// do nothing right now!</span>
<a name="l00251"></a>00251                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00252"></a>00252                               }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254                               pDoorStatus = <a class="code" href="Keys_8cpp.html#baeda4a8cbd53f6a4a750a15101bdeb2">GetDoorStatus</a>( usGridNo1 );
<a name="l00255"></a>00255                               <span class="keywordflow">if</span> (pDoorStatus &amp;&amp; pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_BUSY)
<a name="l00256"></a>00256                               {
<a name="l00257"></a>00257                                     <span class="comment">// do nothing right now!</span>
<a name="l00258"></a>00258                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00259"></a>00259                               }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261                               pStructure = <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( usGridNo1, STRUCTURE_ANYDOOR );
<a name="l00262"></a>00262                               <span class="keywordflow">if</span> (pStructure == NULL)
<a name="l00263"></a>00263                               {
<a name="l00264"></a>00264                                     fDoUseDoor = FALSE;
<a name="l00265"></a>00265                               }
<a name="l00266"></a>00266                               <span class="keywordflow">else</span>
<a name="l00267"></a>00267                               {
<a name="l00268"></a>00268                                     fDoUseDoor = TRUE;
<a name="l00269"></a>00269                                     
<a name="l00270"></a>00270                                     <span class="comment">// action-specific tests to not handle the door</span>
<a name="l00271"></a>00271                                     <span class="keywordflow">switch</span>( ubScheduleAction )
<a name="l00272"></a>00272                                     {
<a name="l00273"></a>00273                                           <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e4dd9a7da2cf3e0d23fd16e026b3ed3556">SCHEDULE_ACTION_UNLOCKDOOR</a>:
<a name="l00274"></a>00274                                                 <span class="keywordflow">if</span> (pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#5a803a00d8769236709b4f0665951383">fFlags</a> &amp; STRUCTURE_OPEN)
<a name="l00275"></a>00275                                                 {
<a name="l00276"></a>00276                                                       <span class="comment">// door is already open!</span>
<a name="l00277"></a>00277                                                       fDoUseDoor = FALSE;
<a name="l00278"></a>00278                                                 }
<a name="l00279"></a>00279                                                 <span class="keywordflow">else</span>
<a name="l00280"></a>00280                                                 {
<a name="l00281"></a>00281                                                       <span class="comment">// set the door to unlocked</span>
<a name="l00282"></a>00282                                                       <a class="code" href="structDOOR.html">DOOR</a> * pDoor;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284                                                       pDoor = <a class="code" href="Keys_8cpp.html#19a7eb42b15e1c0a749124960b84e972">FindDoorInfoAtGridNo</a>( usGridNo1 );
<a name="l00285"></a>00285                                                       <span class="keywordflow">if</span> (pDoor)
<a name="l00286"></a>00286                                                       {
<a name="l00287"></a>00287                                                             <span class="keywordflow">if</span> (pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a>)
<a name="l00288"></a>00288                                                             {
<a name="l00289"></a>00289                                                                   pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a> = FALSE;
<a name="l00290"></a>00290                                                             }
<a name="l00291"></a>00291                                                             <span class="keywordflow">else</span>
<a name="l00292"></a>00292                                                             {
<a name="l00293"></a>00293                                                                   <span class="comment">// door already unlocked!</span>
<a name="l00294"></a>00294                                                                   fDoUseDoor = FALSE;
<a name="l00295"></a>00295                                                             }
<a name="l00296"></a>00296                                                       }
<a name="l00297"></a>00297                                                       <span class="keywordflow">else</span>
<a name="l00298"></a>00298                                                       {
<a name="l00299"></a>00299                                                             <span class="comment">// WTF?  Warning time! </span>
<a name="l00300"></a>00300                                                             <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L<span class="stringliteral">"Schedule involved locked door at %d but there's no lock there!"</span>, usGridNo1 );
<a name="l00301"></a>00301                                                             fDoUseDoor = FALSE;
<a name="l00302"></a>00302                                                       }
<a name="l00303"></a>00303                                                 }
<a name="l00304"></a>00304                                                 <span class="keywordflow">break</span>;
<a name="l00305"></a>00305                                           <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e46b07b5a8f9415aeeefd8696b54cdb463">SCHEDULE_ACTION_OPENDOOR</a>:
<a name="l00306"></a>00306                                                 <span class="keywordflow">if</span> (pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#5a803a00d8769236709b4f0665951383">fFlags</a> &amp; STRUCTURE_OPEN)
<a name="l00307"></a>00307                                                 {
<a name="l00308"></a>00308                                                       <span class="comment">// door is already open!</span>
<a name="l00309"></a>00309                                                       fDoUseDoor = FALSE;
<a name="l00310"></a>00310                                                 }
<a name="l00311"></a>00311                                                 <span class="keywordflow">break</span>;
<a name="l00312"></a>00312                                           <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e4faa15a022490b37b5083048b0734a8a4">SCHEDULE_ACTION_CLOSEDOOR</a>:
<a name="l00313"></a>00313                                                 <span class="keywordflow">if</span> ( !(pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#5a803a00d8769236709b4f0665951383">fFlags</a> &amp; STRUCTURE_OPEN) )
<a name="l00314"></a>00314                                                 {
<a name="l00315"></a>00315                                                       <span class="comment">// door is already closed!</span>
<a name="l00316"></a>00316                                                       fDoUseDoor = FALSE;
<a name="l00317"></a>00317                                                 }
<a name="l00318"></a>00318                                                 <span class="keywordflow">break</span>;
<a name="l00319"></a>00319                                           <span class="keywordflow">default</span>:
<a name="l00320"></a>00320                                                 <span class="keywordflow">break</span>;
<a name="l00321"></a>00321                                     }
<a name="l00322"></a>00322                               }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324                               <span class="keywordflow">if</span> (fDoUseDoor)
<a name="l00325"></a>00325                               {
<a name="l00326"></a>00326                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = usGridNo1;
<a name="l00327"></a>00327                                     <span class="keywordflow">if</span> (ubScheduleAction == <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e4dd9a7da2cf3e0d23fd16e026b3ed3556">SCHEDULE_ACTION_UNLOCKDOOR</a>)
<a name="l00328"></a>00328                                     {
<a name="l00329"></a>00329                                           <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950ba5497fc0ba7a574720d7e7fc9b6acadf">AI_ACTION_UNLOCK_DOOR</a> );
<a name="l00330"></a>00330                                     }
<a name="l00331"></a>00331                                     <span class="keywordflow">else</span>
<a name="l00332"></a>00332                                     {
<a name="l00333"></a>00333                                           <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b65e8af0fc83447730cc2b8d86372bcaf">AI_ACTION_OPEN_OR_CLOSE_DOOR</a> );
<a name="l00334"></a>00334                                     }
<a name="l00335"></a>00335                               }
<a name="l00336"></a>00336                               
<a name="l00337"></a>00337                               <span class="comment">// the door is already in the desired state, or it doesn't exist!</span>
<a name="l00338"></a>00338                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a>++;
<a name="l00339"></a>00339                               <span class="comment">// fall through</span>
<a name="l00340"></a>00340 
<a name="l00341"></a>00341                         <span class="keywordflow">case</span> 2:
<a name="l00342"></a>00342                               <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == usGridNo2 || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == NOWHERE)
<a name="l00343"></a>00343                               {
<a name="l00344"></a>00344                                     <span class="comment">// NOWHERE indicates we were supposed to go off map and have done so</span>
<a name="l00345"></a>00345                                     <a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">DoneScheduleAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00346"></a>00346                                     <span class="keywordflow">if</span> ( pSoldier-&gt;sGridNo != NOWHERE )
<a name="l00347"></a>00347                                     {
<a name="l00348"></a>00348                                           pSoldier-&gt;usPatrolGrid[0] = pSoldier-&gt;sGridNo;
<a name="l00349"></a>00349                                     }
<a name="l00350"></a>00350                               }
<a name="l00351"></a>00351                               <span class="keywordflow">else</span>
<a name="l00352"></a>00352                               {
<a name="l00353"></a>00353                                     <span class="keywordflow">if</span> ( <a class="code" href="Isometric_01Utils_8cpp.html#83fbae6637fd2201d6f9cbb4477d4e73">GridNoOnEdgeOfMap</a>( usGridNo2, &amp;bDirection ) )
<a name="l00354"></a>00354                                     {
<a name="l00355"></a>00355                                           <span class="comment">// told to go to edge of map, so go off at that point!</span>
<a name="l00356"></a>00356                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> = <a class="code" href="AIInternals_8h.html#571514cff7694032571ca5e2b74101c1">GetTraversalQuoteActionID</a>( bDirection );
<a name="l00357"></a>00357                                     }
<a name="l00358"></a>00358                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = usGridNo2;
<a name="l00359"></a>00359                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l00360"></a>00360                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a> );
<a name="l00361"></a>00361                               }
<a name="l00362"></a>00362                               <span class="keywordflow">break</span>;
<a name="l00363"></a>00363                   }
<a name="l00364"></a>00364                   <span class="keywordflow">break</span>;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366             <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e4a190b1ac60466d94d259433f8ad8c8ce">SCHEDULE_ACTION_GRIDNO</a>:
<a name="l00367"></a>00367                   <span class="comment">// Only uses the first gridno</span>
<a name="l00368"></a>00368                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == usGridNo1 )
<a name="l00369"></a>00369                   {
<a name="l00370"></a>00370                         <span class="comment">// done!</span>
<a name="l00371"></a>00371                         <a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">DoneScheduleAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00372"></a>00372                         <span class="keywordflow">if</span> ( pSoldier-&gt;sGridNo != NOWHERE )
<a name="l00373"></a>00373                         {
<a name="l00374"></a>00374                               pSoldier-&gt;usPatrolGrid[0] = pSoldier-&gt;sGridNo;
<a name="l00375"></a>00375                         }
<a name="l00376"></a>00376                   }
<a name="l00377"></a>00377                   <span class="keywordflow">else</span>
<a name="l00378"></a>00378                   {
<a name="l00379"></a>00379                         <span class="comment">// move!</span>
<a name="l00380"></a>00380                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = usGridNo1;
<a name="l00381"></a>00381                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l00382"></a>00382                         <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a> );
<a name="l00383"></a>00383                   }
<a name="l00384"></a>00384                   <span class="keywordflow">break</span>;
<a name="l00385"></a>00385             <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e48684b9c6b6fbc854be685ed3d66354b5">SCHEDULE_ACTION_LEAVESECTOR</a>:
<a name="l00386"></a>00386                   <span class="comment">//Doesn't use any gridno data</span>
<a name="l00387"></a>00387                   <span class="keywordflow">switch</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a> )
<a name="l00388"></a>00388                   {
<a name="l00389"></a>00389                         <span class="keywordflow">case</span> 0: <span class="comment">// start the action</span>
<a name="l00390"></a>00390 
<a name="l00391"></a>00391                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#3c2abf6b022cf08971f4fb0c5daf3e87">FindNearestEdgePoint</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> );
<a name="l00392"></a>00392 
<a name="l00393"></a>00393                               <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> == NOWHERE)
<a name="l00394"></a>00394                               {
<a name="l00395"></a>00395 <span class="preprocessor">#ifdef JA2BETAVERSION</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>                                    <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L<span class="stringliteral">"Civilian could not find path to map edge!"</span> );
<a name="l00397"></a>00397 <span class="preprocessor">#endif</span>
<a name="l00398"></a>00398 <span class="preprocessor"></span>                                    <a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">DoneScheduleAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00399"></a>00399                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00400"></a>00400                               }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> )
<a name="l00403"></a>00403                               {
<a name="l00404"></a>00404                                     <span class="comment">// time to go off the map</span>
<a name="l00405"></a>00405                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a>++;
<a name="l00406"></a>00406                               }
<a name="l00407"></a>00407                               <span class="keywordflow">else</span>
<a name="l00408"></a>00408                               {
<a name="l00409"></a>00409                                     <span class="comment">// move!</span>
<a name="l00410"></a>00410                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l00411"></a>00411                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a> );
<a name="l00412"></a>00412                               }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414                               <span class="comment">// fall through</span>
<a name="l00415"></a>00415 
<a name="l00416"></a>00416                         <span class="keywordflow">case</span> 1: <span class="comment">// near edge</span>
<a name="l00417"></a>00417 
<a name="l00418"></a>00418                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#0ae264c365bf934ff94a3ead3aa410bb">FindNearbyPointOnEdgeOfMap</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;bDirection );
<a name="l00419"></a>00419                               <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> == NOWHERE)
<a name="l00420"></a>00420                               {
<a name="l00421"></a>00421                                     <span class="comment">// what the heck??</span>
<a name="l00422"></a>00422                                     <span class="comment">// ABORT!</span>
<a name="l00423"></a>00423                                     <a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">DoneScheduleAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00424"></a>00424                               }
<a name="l00425"></a>00425                               <span class="keywordflow">else</span>
<a name="l00426"></a>00426                               {
<a name="l00427"></a>00427                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> = <a class="code" href="AIInternals_8h.html#571514cff7694032571ca5e2b74101c1">GetTraversalQuoteActionID</a>( bDirection );
<a name="l00428"></a>00428                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a>++;
<a name="l00429"></a>00429                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l00430"></a>00430                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a> );
<a name="l00431"></a>00431                               }
<a name="l00432"></a>00432                               <span class="keywordflow">break</span>;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434                         <span class="keywordflow">case</span> 2: <span class="comment">// should now be done!</span>
<a name="l00435"></a>00435                               <a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">DoneScheduleAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00436"></a>00436                               <span class="keywordflow">break</span>;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438                         <span class="keywordflow">default</span>:
<a name="l00439"></a>00439                               <span class="keywordflow">break</span>;
<a name="l00440"></a>00440                   }
<a name="l00441"></a>00441                   <span class="keywordflow">break</span>;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443             <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e4172cb1d471fc65e9e6619666132c483b">SCHEDULE_ACTION_ENTERSECTOR</a>:
<a name="l00444"></a>00444                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE &amp;&amp; <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].ubMiscFlags &amp; PROFILE_MISC_FLAG2_DONT_ADD_TO_SECTOR )
<a name="l00445"></a>00445                   {
<a name="l00446"></a>00446                         <span class="comment">// ignore.</span>
<a name="l00447"></a>00447                         <a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">DoneScheduleAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00448"></a>00448                         <span class="keywordflow">break</span>;
<a name="l00449"></a>00449                   }
<a name="l00450"></a>00450                   <span class="keywordflow">switch</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a> )
<a name="l00451"></a>00451                   {
<a name="l00452"></a>00452                         <span class="keywordflow">case</span> 0:
<a name="l00453"></a>00453                               sX = <a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c185dc10bf4af55b3780b28a19d78477">sOffWorldGridNo</a> );
<a name="l00454"></a>00454                               sY = <a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c185dc10bf4af55b3780b28a19d78477">sOffWorldGridNo</a> );
<a name="l00455"></a>00455                               <a class="code" href="Soldier_01Control_8cpp.html#265ef31340bc30f973e4fd89d56c1c32">EVENT_SetSoldierPosition</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sX, sY );
<a name="l00456"></a>00456                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b0096f321a0de4f0617283f7b3212aa0">bInSector</a> = TRUE;
<a name="l00457"></a>00457                               <a class="code" href="Overhead_8cpp.html#416125ae34e7f4d5d6f3d7dae6d14e0f">MoveSoldierFromAwayToMercSlot</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00458"></a>00458                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = usGridNo1;
<a name="l00459"></a>00459                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#58dd47edf001f8d4d121eb40fa1a4938">bAIScheduleProgress</a>++;
<a name="l00460"></a>00460                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l00461"></a>00461                               <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a> );
<a name="l00462"></a>00462                         <span class="keywordflow">case</span> 1:
<a name="l00463"></a>00463                               <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == usGridNo1)
<a name="l00464"></a>00464                               {
<a name="l00465"></a>00465                                     <a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">DoneScheduleAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00466"></a>00466                                     <span class="keywordflow">if</span> ( pSoldier-&gt;sGridNo != NOWHERE )
<a name="l00467"></a>00467                                     {
<a name="l00468"></a>00468                                           pSoldier-&gt;usPatrolGrid[0] = pSoldier-&gt;sGridNo;
<a name="l00469"></a>00469                                     }
<a name="l00470"></a>00470                               }
<a name="l00471"></a>00471                               <span class="keywordflow">else</span>
<a name="l00472"></a>00472                               {
<a name="l00473"></a>00473                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = usGridNo1;
<a name="l00474"></a>00474                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l00475"></a>00475                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a> );
<a name="l00476"></a>00476                               }
<a name="l00477"></a>00477                               <span class="keywordflow">break</span>;
<a name="l00478"></a>00478                   }
<a name="l00479"></a>00479                   <span class="keywordflow">break</span>;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481             <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e4b66d67a6a4e1ace264ccaff8f28bc47f">SCHEDULE_ACTION_WAKE</a>:
<a name="l00482"></a>00482                   <span class="comment">// Go to this position </span>
<a name="l00483"></a>00483                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#51447f3682efa6541df7c607f8e36e78">sInitialGridNo</a>)
<a name="l00484"></a>00484                   {
<a name="l00485"></a>00485                         <span class="comment">// th-th-th-that's it!</span>
<a name="l00486"></a>00486                         <a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">DoneScheduleAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00487"></a>00487                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8fdd768fde52511d085402060c856cf5">usPatrolGrid</a>[0] = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l00488"></a>00488                   }
<a name="l00489"></a>00489                   <span class="keywordflow">else</span>
<a name="l00490"></a>00490                   {
<a name="l00491"></a>00491                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#51447f3682efa6541df7c607f8e36e78">sInitialGridNo</a>;
<a name="l00492"></a>00492                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l00493"></a>00493                         <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a> );
<a name="l00494"></a>00494                   }
<a name="l00495"></a>00495                   <span class="keywordflow">break</span>;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497             <span class="keywordflow">case</span> <a class="code" href="Scheduling_8h.html#9e9505a91a84992d04ba4e85217fb4e48c5c747492f34c4cc8480539c7500bb5">SCHEDULE_ACTION_SLEEP</a>:
<a name="l00498"></a>00498                   <span class="comment">// Go to this position </span>
<a name="l00499"></a>00499                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> == usGridNo1)
<a name="l00500"></a>00500                   {
<a name="l00501"></a>00501                         <span class="comment">// Sleep</span>
<a name="l00502"></a>00502                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> |= AI_ASLEEP;
<a name="l00503"></a>00503                         <a class="code" href="DecideAction_8cpp.html#cab66da45c94ee4a834fe56dd936f328">DoneScheduleAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00504"></a>00504                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != NOWHERE )
<a name="l00505"></a>00505                         {
<a name="l00506"></a>00506                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8fdd768fde52511d085402060c856cf5">usPatrolGrid</a>[0] = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l00507"></a>00507                         }
<a name="l00508"></a>00508                   }
<a name="l00509"></a>00509                   <span class="keywordflow">else</span>
<a name="l00510"></a>00510                   {
<a name="l00511"></a>00511                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = usGridNo1;
<a name="l00512"></a>00512                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e565cc6eb4167b009fc2dd1b99c824d3">sAbsoluteFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l00513"></a>00513                         <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b80612487f5d207f3a7280cab30895fde">AI_ACTION_SCHEDULE_MOVE</a> );
<a name="l00514"></a>00514                   }
<a name="l00515"></a>00515                   <span class="keywordflow">break</span>;
<a name="l00516"></a>00516       }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518 
<a name="l00519"></a>00519       <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00520"></a>00520 }
<a name="l00521"></a>00521 
<a name="l00522"></a><a class="code" href="DecideAction_8cpp.html#958b1f66cb502f3e46a04cb9c799c86c">00522</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="DecideAction_8cpp.html#958b1f66cb502f3e46a04cb9c799c86c">DecideActionBoxerEnteringRing</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l00523"></a>00523 {
<a name="l00524"></a>00524       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubRoom;
<a name="l00525"></a>00525       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sDesiredMercLoc;
<a name="l00526"></a>00526       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubDesiredMercDir;
<a name="l00527"></a>00527 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l00528"></a>00528 <span class="preprocessor"></span>            <a class="code" href="Types_8h.html#94ebfccc6e846c28751f8d616371f1e5">STR16</a> tempstr;
<a name="l00529"></a>00529 <span class="preprocessor">      #endif</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span>      <span class="comment">// boxer, should move into ring!</span>
<a name="l00531"></a>00531       <span class="keywordflow">if</span> ( <a class="code" href="Render_01Fun_8cpp.html#8df6498b7334d324ca92136572bba261">InARoom</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, &amp;ubRoom ))
<a name="l00532"></a>00532       {
<a name="l00533"></a>00533             <span class="keywordflow">if</span> (ubRoom == BOXING_RING)
<a name="l00534"></a>00534             {
<a name="l00535"></a>00535                   <span class="comment">// look towards nearest player</span>
<a name="l00536"></a>00536                   sDesiredMercLoc = <a class="code" href="ai_8h.html#ba347a58d51f325ce0b739aedf1feeaa">ClosestPC</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, NULL );
<a name="l00537"></a>00537                   <span class="keywordflow">if</span> ( sDesiredMercLoc != NOWHERE )
<a name="l00538"></a>00538                   {
<a name="l00539"></a>00539                         <span class="comment">// see if we are facing this person</span>
<a name="l00540"></a>00540                         ubDesiredMercDir = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>(<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(sDesiredMercLoc),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(sDesiredMercLoc));
<a name="l00541"></a>00541 
<a name="l00542"></a>00542                         <span class="comment">// if not already facing in that direction,</span>
<a name="l00543"></a>00543                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> != ubDesiredMercDir &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubDesiredMercDir, <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight ) )
<a name="l00544"></a>00544                         {
<a name="l00545"></a>00545 
<a name="l00546"></a>00546                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ubDesiredMercDir;
<a name="l00547"></a>00547 
<a name="l00548"></a>00548 <span class="preprocessor">                              #ifdef DEBUGDECISIONS</span>
<a name="l00549"></a>00549 <span class="preprocessor"></span>                              sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - TURNS TOWARDS CLOSEST PC to face direction %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l00550"></a>00550                               <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l00551"></a>00551 <span class="preprocessor">                              #endif</span>
<a name="l00552"></a>00552 <span class="preprocessor"></span>
<a name="l00553"></a>00553                               <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a> );
<a name="l00554"></a>00554                         }
<a name="l00555"></a>00555                   }
<a name="l00556"></a>00556                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b261c7b45743ebd70c5901566c1c275ca">AI_ACTION_ABSOLUTELY_NONE</a> );
<a name="l00557"></a>00557             }
<a name="l00558"></a>00558             <span class="keywordflow">else</span>
<a name="l00559"></a>00559             {
<a name="l00560"></a>00560                   <span class="comment">// move to starting spot</span>
<a name="l00561"></a>00561                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#bae11bc81b4e61d63eeebeea6cbabcd4">FindClosestBoxingRingSpot</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, TRUE );
<a name="l00562"></a>00562                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bedcd6be18202cbd0df633b0017f571f1">AI_ACTION_GET_CLOSER</a> );
<a name="l00563"></a>00563             }
<a name="l00564"></a>00564       }
<a name="l00565"></a>00565 
<a name="l00566"></a>00566       <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b261c7b45743ebd70c5901566c1c275ca">AI_ACTION_ABSOLUTELY_NONE</a> );
<a name="l00567"></a>00567 }
<a name="l00568"></a>00568 
<a name="l00569"></a><a class="code" href="DecideAction_8cpp.html#e58c74788082cdac54a75c65707310aa">00569</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="DecideAction_8cpp.html#e58c74788082cdac54a75c65707310aa">DecideActionNamedNPC</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00570"></a>00570 {
<a name="l00571"></a>00571       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sDesiredMercLoc;
<a name="l00572"></a>00572       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubDesiredMercDir;
<a name="l00573"></a>00573       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubDesiredMerc;
<a name="l00574"></a>00574       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sDesiredMercDist;
<a name="l00575"></a>00575 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l00576"></a>00576 <span class="preprocessor"></span>            <a class="code" href="Types_8h.html#94ebfccc6e846c28751f8d616371f1e5">STR16</a> tempstr;
<a name="l00577"></a>00577 <span class="preprocessor">      #endif</span>
<a name="l00578"></a>00578 <span class="preprocessor"></span>
<a name="l00579"></a>00579       <span class="comment">// if a quote record has been set and we're not doing movement, then</span>
<a name="l00580"></a>00580       <span class="comment">// it means we have to wait until someone is nearby and then see</span>
<a name="l00581"></a>00581       <span class="comment">// to do...</span>
<a name="l00582"></a>00582 
<a name="l00583"></a>00583       <span class="comment">// is this person close enough to trigger event?</span>
<a name="l00584"></a>00584       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#30114897a2229659bda75e47c604b742">ubQuoteRecord</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cfa0ce96a08fd67bfa7bc50694da4eb8">ubQuoteActionID</a> == <a class="code" href="ai_8h.html#a2f138582d21f3b861c65826c0e831efea629a205d096e73d539fa987a4ec77f">QUOTE_ACTION_ID_TURNTOWARDSPLAYER</a> )
<a name="l00585"></a>00585       {
<a name="l00586"></a>00586             sDesiredMercLoc = <a class="code" href="ai_8h.html#ba347a58d51f325ce0b739aedf1feeaa">ClosestPC</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;sDesiredMercDist );
<a name="l00587"></a>00587             <span class="keywordflow">if</span> (sDesiredMercLoc != NOWHERE )
<a name="l00588"></a>00588             {
<a name="l00589"></a>00589                   <span class="keywordflow">if</span> ( sDesiredMercDist &lt;= NPC_TALK_RADIUS * 2)
<a name="l00590"></a>00590                   {
<a name="l00591"></a>00591                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#30114897a2229659bda75e47c604b742">ubQuoteRecord</a> = 0;
<a name="l00592"></a>00592                         <span class="comment">// see if this triggers a conversation/NPC record</span>
<a name="l00593"></a>00593                         <a class="code" href="NPC_8cpp.html#0ab77b6fc4eb5727f3e2c04a041b4301">PCsNearNPC</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> );
<a name="l00594"></a>00594                         <span class="comment">// clear "handle every frame" flag</span>
<a name="l00595"></a>00595                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp;= (~AI_HANDLE_EVERY_FRAME);
<a name="l00596"></a>00596                         <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b261c7b45743ebd70c5901566c1c275ca">AI_ACTION_ABSOLUTELY_NONE</a> );
<a name="l00597"></a>00597                   }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599                   <span class="comment">// see if we are facing this person</span>
<a name="l00600"></a>00600                   ubDesiredMercDir = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>(<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(sDesiredMercLoc),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(sDesiredMercLoc));
<a name="l00601"></a>00601 
<a name="l00602"></a>00602                   <span class="comment">// if not already facing in that direction,</span>
<a name="l00603"></a>00603                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> != ubDesiredMercDir &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubDesiredMercDir, <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight ) )
<a name="l00604"></a>00604                   {
<a name="l00605"></a>00605 
<a name="l00606"></a>00606                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ubDesiredMercDir;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608 <span class="preprocessor">                        #ifdef DEBUGDECISIONS</span>
<a name="l00609"></a>00609 <span class="preprocessor"></span>                        sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - TURNS TOWARDS CLOSEST PC to face direction %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l00610"></a>00610                         <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l00611"></a>00611 <span class="preprocessor">                        #endif</span>
<a name="l00612"></a>00612 <span class="preprocessor"></span>
<a name="l00613"></a>00613                         <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a> );
<a name="l00614"></a>00614                   }
<a name="l00615"></a>00615             }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617             <span class="comment">// do nothing; we're looking at the PC or the NPC is far away</span>
<a name="l00618"></a>00618             <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b261c7b45743ebd70c5901566c1c275ca">AI_ACTION_ABSOLUTELY_NONE</a> );
<a name="l00619"></a>00619 
<a name="l00620"></a>00620       }
<a name="l00621"></a>00621       <span class="keywordflow">else</span>
<a name="l00622"></a>00622       {<span class="comment"></span>
<a name="l00623"></a>00623 <span class="comment">            ///////////////</span>
<a name="l00624"></a>00624 <span class="comment"></span>            <span class="comment">// CHECK TO SEE IF WE WANT TO GO UP TO PERSON AND SAY SOMETHING</span><span class="comment"></span>
<a name="l00625"></a>00625 <span class="comment">            ///////////////</span>
<a name="l00626"></a>00626 <span class="comment"></span>            <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#bb67ca40bf2e4597d816838382a3a232">NPCConsiderInitiatingConv</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;ubDesiredMerc );
<a name="l00627"></a>00627             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l00628"></a>00628             {
<a name="l00629"></a>00629                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bc343a7ff6dd2ba930ea933f2063e09ea">AI_ACTION_APPROACH_MERC</a> );
<a name="l00630"></a>00630             }
<a name="l00631"></a>00631       }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633       <span class="keywordflow">switch</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ) 
<a name="l00634"></a>00634       {
<a name="l00635"></a>00635             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1f4f194a325f7ec57b1a89fddca849ac4">JIM</a>:
<a name="l00636"></a>00636             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1701917e3b6bc2c89c9e13f090c6627be">JACK</a>:
<a name="l00637"></a>00637             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa108f287eea188fe13488b37dcb43c5130">OLAF</a>:
<a name="l00638"></a>00638             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1e9cf68856c8eb96d8738c14880278f69">RAY</a>:
<a name="l00639"></a>00639             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa19afe3ebbc5adde8a3f614beab534ff0f">OLGA</a>:
<a name="l00640"></a>00640             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa192e84033e0b83e724d448d18aacad96b">TYRONE</a>:
<a name="l00641"></a>00641                   sDesiredMercLoc = <a class="code" href="ai_8h.html#ba347a58d51f325ce0b739aedf1feeaa">ClosestPC</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;sDesiredMercDist );
<a name="l00642"></a>00642                   <span class="keywordflow">if</span> (sDesiredMercLoc != NOWHERE )
<a name="l00643"></a>00643                   {
<a name="l00644"></a>00644                         <span class="keywordflow">if</span> ( sDesiredMercDist &lt;= NPC_TALK_RADIUS * 2 )
<a name="l00645"></a>00645                         {
<a name="l00646"></a>00646                               <a class="code" href="opplist_8cpp.html#b6c342881dfbb260b8b708f3ab5f2f38">AddToShouldBecomeHostileOrSayQuoteList</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l00647"></a>00647                               <span class="comment">// now wait a bit!</span>
<a name="l00648"></a>00648                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = 5000;
<a name="l00649"></a>00649                               <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a> );
<a name="l00650"></a>00650                         }
<a name="l00651"></a>00651                         <span class="keywordflow">else</span>
<a name="l00652"></a>00652                         {
<a name="l00653"></a>00653                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#8058d9871f438da8f6f5ed91da85e559">GoAsFarAsPossibleTowards</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sDesiredMercLoc, <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bc343a7ff6dd2ba930ea933f2063e09ea">AI_ACTION_APPROACH_MERC</a> );
<a name="l00654"></a>00654                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE )
<a name="l00655"></a>00655                               {
<a name="l00656"></a>00656                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bc343a7ff6dd2ba930ea933f2063e09ea">AI_ACTION_APPROACH_MERC</a> );
<a name="l00657"></a>00657                               }
<a name="l00658"></a>00658                         }
<a name="l00659"></a>00659                   }
<a name="l00660"></a>00660                   <span class="keywordflow">break</span>;
<a name="l00661"></a>00661             <span class="keywordflow">default</span>:
<a name="l00662"></a>00662                   <span class="keywordflow">break</span>;
<a name="l00663"></a>00663       }
<a name="l00664"></a>00664 
<a name="l00665"></a>00665       <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00666"></a>00666 }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668 
<a name="l00669"></a><a class="code" href="DecideAction_8cpp.html#ace6b78fb0a875c61b79ba65193f0d04">00669</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="ai_8h.html#ace6b78fb0a875c61b79ba65193f0d04">DecideActionGreen</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)
<a name="l00670"></a>00670 {
<a name="l00671"></a>00671       <a class="code" href="Types_8h.html#eb90fd78c942591ef3a935cf98baf4f8">DOUBLE</a> iChance, iSneaky = 10;
<a name="l00672"></a>00672       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>  bInWater,bInGas;
<a name="l00673"></a>00673 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l00674"></a>00674 <span class="preprocessor"></span>            <a class="code" href="Types_8h.html#94ebfccc6e846c28751f8d616371f1e5">STR16</a> tempstr;
<a name="l00675"></a>00675 <span class="preprocessor">      #endif</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span> 
<a name="l00677"></a>00677 DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionGreen, orders = %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>));
<a name="l00678"></a>00678 
<a name="l00679"></a>00679 <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fCivilian = (PTR_CIVILIAN &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> == <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a078524cb5f7573455bdacd2b87a051da610c97">NON_CIV_GROUP</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a> || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> &gt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a72254b6f06629056dd86be50df5347676">FATCIV</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> &lt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a75db4e8d299d195df30798a12cd332f5a">CRIPPLECIV</a>) ) );
<a name="l00680"></a>00680  <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fCivilianOrMilitia = PTR_CIV_OR_MILITIA;
<a name="l00681"></a>00681 
<a name="l00682"></a>00682       <a class="code" href="PATHAI_8cpp.html#1006624ded2cb2698d6a41ed8c88f875">gubNPCPathCount</a> = 0;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684       <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#32021b7251048d8c62ea0c2e26b7a021">bBoxingState</a> != <a class="code" href="Overhead_01Types_8h.html#60ed5bd8e4835b98d48cf7afb819b4e5f2caf361bed5cf6236018fbb59ecded2">NOT_BOXING</a> )
<a name="l00685"></a>00685       {
<a name="l00686"></a>00686             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_BOXER)
<a name="l00687"></a>00687             {
<a name="l00688"></a>00688                   <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#32021b7251048d8c62ea0c2e26b7a021">bBoxingState</a> == <a class="code" href="Overhead_01Types_8h.html#60ed5bd8e4835b98d48cf7afb819b4e55fac2cdafaeb730644fb13980a1fa22c">PRE_BOXING</a> )
<a name="l00689"></a>00689                   {
<a name="l00690"></a>00690                         <span class="keywordflow">return</span>( <a class="code" href="DecideAction_8cpp.html#958b1f66cb502f3e46a04cb9c799c86c">DecideActionBoxerEnteringRing</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) );
<a name="l00691"></a>00691                   }
<a name="l00692"></a>00692                   <span class="keywordflow">else</span>
<a name="l00693"></a>00693                   {
<a name="l00694"></a>00694                         <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubRoom;
<a name="l00695"></a>00695                         <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLoop;
<a name="l00696"></a>00696 
<a name="l00697"></a>00697                         <span class="comment">// boxer... but since in status green, it's time to leave the ring!</span>
<a name="l00698"></a>00698                         <span class="keywordflow">if</span> ( <a class="code" href="Render_01Fun_8cpp.html#8df6498b7334d324ca92136572bba261">InARoom</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, &amp;ubRoom ))
<a name="l00699"></a>00699                         {
<a name="l00700"></a>00700                               <span class="keywordflow">if</span> (ubRoom == BOXING_RING)
<a name="l00701"></a>00701                               {
<a name="l00702"></a>00702                                     <span class="keywordflow">for</span> ( ubLoop = 0; ubLoop &lt; NUM_BOXERS; ubLoop++ )
<a name="l00703"></a>00703                                     {
<a name="l00704"></a>00704                                           <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> == <a class="code" href="Boxing_8cpp.html#47a1eaab56e087cbfdb4ec76964ae21e">gubBoxerID</a>[ ubLoop ])
<a name="l00705"></a>00705                                           {
<a name="l00706"></a>00706                                                 <span class="comment">// we should go back where we started</span>
<a name="l00707"></a>00707                                                 <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="Boxing_8cpp.html#daaae190d1d943acf669fe7864f289af">gsBoxerGridNo</a>[ ubLoop ];
<a name="l00708"></a>00708                                                 <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bedcd6be18202cbd0df633b0017f571f1">AI_ACTION_GET_CLOSER</a> );
<a name="l00709"></a>00709                                           }
<a name="l00710"></a>00710                                     }
<a name="l00711"></a>00711                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#bae11bc81b4e61d63eeebeea6cbabcd4">FindClosestBoxingRingSpot</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, FALSE );
<a name="l00712"></a>00712                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bedcd6be18202cbd0df633b0017f571f1">AI_ACTION_GET_CLOSER</a> );
<a name="l00713"></a>00713                               }
<a name="l00714"></a>00714                               <span class="keywordflow">else</span>
<a name="l00715"></a>00715                               {
<a name="l00716"></a>00716                                     <span class="comment">// done!</span>
<a name="l00717"></a>00717                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp;= ~(SOLDIER_BOXER);
<a name="l00718"></a>00718                                     <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a>)
<a name="l00719"></a>00719                                     {
<a name="l00720"></a>00720                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp;= (~SOLDIER_PCUNDERAICONTROL);
<a name="l00721"></a>00721                                           <a class="code" href="Boxing_8cpp.html#12ba40b9d5cc756f55d5e45d1d25b038">TriggerEndOfBoxingRecord</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00722"></a>00722                                     }
<a name="l00723"></a>00723                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="Boxing_8cpp.html#90b796b2502723a9c4d7807328abb483">CountPeopleInBoxingRing</a>() == 0 )
<a name="l00724"></a>00724                                     {
<a name="l00725"></a>00725                                           <span class="comment">// Probably disqualified by jumping out of ring; the player</span>
<a name="l00726"></a>00726                                           <span class="comment">// character then didn't trigger the end of boxing record</span>
<a name="l00727"></a>00727                                           <span class="comment">// (and we know from the if statement above that we're</span>
<a name="l00728"></a>00728                                           <span class="comment">// still in a boxing state of some sort...)</span>
<a name="l00729"></a>00729                                           <a class="code" href="Boxing_8cpp.html#12ba40b9d5cc756f55d5e45d1d25b038">TriggerEndOfBoxingRecord</a>( NULL );
<a name="l00730"></a>00730 
<a name="l00731"></a>00731                                     }
<a name="l00732"></a>00732                               }
<a name="l00733"></a>00733                         }
<a name="l00734"></a>00734 
<a name="l00735"></a>00735                         <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b261c7b45743ebd70c5901566c1c275ca">AI_ACTION_ABSOLUTELY_NONE</a> );
<a name="l00736"></a>00736                   }
<a name="l00737"></a>00737             }
<a name="l00738"></a>00738             <span class="comment">//else if ( (gTacticalStatus.bBoxingState == PRE_BOXING || gTacticalStatus.bBoxingState == BOXING) &amp;&amp; ( PythSpacesAway( pSoldier-&gt;sGridNo, CENTER_OF_RING ) &lt;= MaxDistanceVisible() ) )</span>
<a name="l00739"></a>00739             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, CENTER_OF_RING ) &lt;= <a class="code" href="opplist_8cpp.html#ce89c9f1017d9a6e473df03acb6f1a2a">MaxDistanceVisible</a>() )
<a name="l00740"></a>00740             {
<a name="l00741"></a>00741                   <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubRingDir;
<a name="l00742"></a>00742                   <span class="comment">// face ring!</span>
<a name="l00743"></a>00743 
<a name="l00744"></a>00744                   ubRingDir = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>(<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(CENTER_OF_RING),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(CENTER_OF_RING));
<a name="l00745"></a>00745                   <span class="keywordflow">if</span> ( <a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#9f252be6995e21dcbda09f03c7cf5253">GetAPsToLook</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> )
<a name="l00746"></a>00746                   {
<a name="l00747"></a>00747                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> != ubRingDir )
<a name="l00748"></a>00748                         {
<a name="l00749"></a>00749                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ubRingDir;
<a name="l00750"></a>00750                               <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a> );
<a name="l00751"></a>00751                         }
<a name="l00752"></a>00752                   }
<a name="l00753"></a>00753                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00754"></a>00754             }
<a name="l00755"></a>00755       }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757       <span class="keywordflow">if</span> ( TANK( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l00758"></a>00758       {
<a name="l00759"></a>00759             <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00760"></a>00760       }
<a name="l00761"></a>00761 
<a name="l00762"></a>00762 
<a name="l00763"></a>00763  bInWater = <a class="code" href="worldman_8cpp.html#2307250bab3e458d3dedf063a5ce2433">Water</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> );
<a name="l00764"></a>00764 
<a name="l00765"></a>00765  <span class="comment">// check if standing in tear gas without a gas mask on, or in smoke</span>
<a name="l00766"></a>00766  bInGas = <a class="code" href="AIInternals_8h.html#57193b78fcaf32a2ca34e9e7ec021c1c">InGasOrSmoke</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ); 
<a name="l00767"></a>00767 
<a name="l00768"></a>00768  <span class="comment">// if real-time, and not in the way, do nothing 90% of the time (for GUARDS!)</span>
<a name="l00769"></a>00769  <span class="comment">// unless in water (could've started there), then we better swim to shore!</span>
<a name="l00770"></a>00770 
<a name="l00771"></a>00771       <span class="keywordflow">if</span> (fCivilian)
<a name="l00772"></a>00772       {
<a name="l00773"></a>00773             <span class="comment">// special stuff for civs</span>
<a name="l00774"></a>00774 
<a name="l00775"></a>00775             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_COWERING)
<a name="l00776"></a>00776             {
<a name="l00777"></a>00777                   <span class="comment">// everything's peaceful again, stop cowering!!</span>
<a name="l00778"></a>00778                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_STAND;
<a name="l00779"></a>00779                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6f46584addd5e876d03eef0b47c41003">AI_ACTION_STOP_COWERING</a> );
<a name="l00780"></a>00780             }
<a name="l00781"></a>00781 
<a name="l00782"></a>00782             <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00783"></a>00783             {
<a name="l00784"></a>00784                   <span class="comment">// ******************</span>
<a name="l00785"></a>00785                   <span class="comment">// REAL TIME NPC CODE</span>
<a name="l00786"></a>00786                   <span class="comment">// ******************</span>
<a name="l00787"></a>00787                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp; AI_CHECK_SCHEDULE)
<a name="l00788"></a>00788                   {
<a name="l00789"></a>00789                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="DecideAction_8cpp.html#c1877b5eee7838388d280333756d0d01">DecideActionSchedule</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00790"></a>00790                         <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>)
<a name="l00791"></a>00791                         {
<a name="l00792"></a>00792                               <span class="keywordflow">return</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> );
<a name="l00793"></a>00793                         }
<a name="l00794"></a>00794                   }
<a name="l00795"></a>00795 
<a name="l00796"></a>00796                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE)
<a name="l00797"></a>00797                   {
<a name="l00798"></a>00798                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="DecideAction_8cpp.html#e58c74788082cdac54a75c65707310aa">DecideActionNamedNPC</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00799"></a>00799                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> )
<a name="l00800"></a>00800                         {
<a name="l00801"></a>00801                               <span class="keywordflow">return</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> );
<a name="l00802"></a>00802                         }
<a name="l00803"></a>00803                         <span class="comment">// can we act again? not for a minute since we were last spoken to/triggered a record</span>
<a name="l00804"></a>00804                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#3d3c648e779c78068fd38b2d31e282ec">uiTimeSinceLastSpoke</a> &amp;&amp; (GetJA2Clock() &lt; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#3d3c648e779c78068fd38b2d31e282ec">uiTimeSinceLastSpoke</a> + 60000) )
<a name="l00805"></a>00805                         {
<a name="l00806"></a>00806                               <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00807"></a>00807                         }
<a name="l00808"></a>00808                         <span class="comment">// turn off counter so we don't check it again</span>
<a name="l00809"></a>00809                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#3d3c648e779c78068fd38b2d31e282ec">uiTimeSinceLastSpoke</a> = 0;
<a name="l00810"></a>00810 
<a name="l00811"></a>00811                   }
<a name="l00812"></a>00812 
<a name="l00813"></a>00813             }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815             <span class="comment">// if not in the way, do nothing most of the time</span>
<a name="l00816"></a>00816             <span class="comment">// unless in water (could've started there), then we better swim to shore!</span>
<a name="l00817"></a>00817 
<a name="l00818"></a>00818             <span class="keywordflow">if</span> (!(bInWater) &amp;&amp; <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 5 ) )
<a name="l00819"></a>00819             {
<a name="l00820"></a>00820                   <span class="comment">// don't do nuttin!</span>
<a name="l00821"></a>00821                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l00822"></a>00822             }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824       }
<a name="l00825"></a>00825 
<a name="l00826"></a>00826 
<a name="l00827"></a>00827       
<a name="l00828"></a>00828       
<a name="l00829"></a>00829       <span class="comment"></span>
<a name="l00830"></a>00830 <span class="comment">////////////////////////////////////////////////////////////////////////////</span>
<a name="l00831"></a>00831 <span class="comment"></span> <span class="comment">// POINT PATROL: move towards next point unless getting a bit winded</span><span class="comment"></span>
<a name="l00832"></a>00832 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l00833"></a>00833 <span class="comment"></span>
<a name="l00834"></a>00834  <span class="comment">// this takes priority over water/gas checks, so that point patrol WILL work</span>
<a name="l00835"></a>00835  <span class="comment">// from island to island, and through gas covered areas, too</span>
<a name="l00836"></a>00836  <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f7dc5dd2cff7953315a832e7a457deb9d">POINTPATROL</a>) &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a> &gt;= 75))
<a name="l00837"></a>00837   {
<a name="l00838"></a>00838    <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#49b4bb905b3b1a1a32cb8709166d6d37">PointPatrolAI</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>))
<a name="l00839"></a>00839        {
<a name="l00840"></a>00840                   <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00841"></a>00841                   {
<a name="l00842"></a>00842                         <span class="comment">// wait after this...</span>
<a name="l00843"></a>00843                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a>;
<a name="l00844"></a>00844                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = <a class="code" href="AIInternals_8h.html#3be60e41ccfb8673c4cc11312ab48298">RealtimeDelay</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00845"></a>00845                   }
<a name="l00846"></a>00846                  <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b89a5e43473f884b6e3957c03128115d5">AI_ACTION_POINT_PATROL</a>);
<a name="l00847"></a>00847        }
<a name="l00848"></a>00848        <span class="keywordflow">else</span>
<a name="l00849"></a>00849        {
<a name="l00850"></a>00850               <span class="comment">// Reset path count to avoid dedlok</span>
<a name="l00851"></a>00851                   <a class="code" href="PATHAI_8cpp.html#1006624ded2cb2698d6a41ed8c88f875">gubNPCPathCount</a> = 0;
<a name="l00852"></a>00852        }
<a name="l00853"></a>00853   }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855  <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f4f7b012e8cbd1e2cc2b3fa9e1b5c9f9f">RNDPTPATROL</a>) &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a> &gt;=75))
<a name="l00856"></a>00856  {
<a name="l00857"></a>00857    <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#325620044694b495691187c1fb7542c7">RandomPointPatrolAI</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>))
<a name="l00858"></a>00858             {
<a name="l00859"></a>00859                   <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l00860"></a>00860                   {
<a name="l00861"></a>00861                         <span class="comment">// wait after this...</span>
<a name="l00862"></a>00862                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a>;
<a name="l00863"></a>00863                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = <a class="code" href="AIInternals_8h.html#3be60e41ccfb8673c4cc11312ab48298">RealtimeDelay</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00864"></a>00864                   }
<a name="l00865"></a>00865      <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b89a5e43473f884b6e3957c03128115d5">AI_ACTION_POINT_PATROL</a>);
<a name="l00866"></a>00866        }
<a name="l00867"></a>00867        <span class="keywordflow">else</span>
<a name="l00868"></a>00868        {
<a name="l00869"></a>00869               <span class="comment">// Reset path count to avoid dedlok</span>
<a name="l00870"></a>00870                   <a class="code" href="PATHAI_8cpp.html#1006624ded2cb2698d6a41ed8c88f875">gubNPCPathCount</a> = 0;
<a name="l00871"></a>00871        }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873  }
<a name="l00874"></a>00874 <span class="comment"></span>
<a name="l00875"></a>00875 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l00876"></a>00876 <span class="comment"></span> <span class="comment">// WHEN LEFT IN WATER OR GAS, GO TO NEAREST REACHABLE SPOT OF UNGASSED LAND</span><span class="comment"></span>
<a name="l00877"></a>00877 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l00878"></a>00878 <span class="comment"></span>
<a name="l00879"></a>00879  DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionGreen: get out of water and gas"</span>));
<a name="l00880"></a>00880 
<a name="l00881"></a>00881  <span class="keywordflow">if</span> (bInWater || bInGas)
<a name="l00882"></a>00882   {
<a name="l00883"></a>00883    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#c5f60b8768fb9f3fc244df46e31c1299">FindNearestUngassedLand</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l00884"></a>00884 
<a name="l00885"></a>00885    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l00886"></a>00886     {
<a name="l00887"></a>00887 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l00888"></a>00888 <span class="preprocessor"></span>     sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - SEEKING NEAREST UNGASSED LAND at grid %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l00889"></a>00889      <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l00890"></a>00890 <span class="preprocessor">#endif</span>
<a name="l00891"></a>00891 <span class="preprocessor"></span>
<a name="l00892"></a>00892      <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bbbe6b4d8c4937c66e39880b4df436182">AI_ACTION_LEAVE_WATER_GAS</a>);
<a name="l00893"></a>00893     }
<a name="l00894"></a>00894   }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 
<a name="l00897"></a>00897 <span class="comment"></span>
<a name="l00898"></a>00898 <span class="comment">      ////////////////////////////////////////////////////////////////////////</span>
<a name="l00899"></a>00899 <span class="comment"></span>      <span class="comment">// REST IF RUNNING OUT OF BREATH</span><span class="comment"></span>
<a name="l00900"></a>00900 <span class="comment">      ////////////////////////////////////////////////////////////////////////</span>
<a name="l00901"></a>00901 <span class="comment"></span>
<a name="l00902"></a>00902   DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionGreen: rest if running out of breath"</span>));
<a name="l00903"></a>00903       <span class="comment">// if our breath is running a bit low, and we're not in the way or in water</span>
<a name="l00904"></a>00904       <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a> &lt; 75) &amp;&amp; !bInWater)
<a name="l00905"></a>00905       {
<a name="l00906"></a>00906             <span class="comment">// take a breather for gods sake!</span>
<a name="l00907"></a>00907             <span class="comment">// for realtime, AI will use a standard wait set outside of here</span>
<a name="l00908"></a>00908             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l00909"></a>00909             <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l00910"></a>00910       }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912 <span class="comment"></span>
<a name="l00913"></a>00913 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l00914"></a>00914 <span class="comment"></span> <span class="comment">// CLIMB A BUILDING</span><span class="comment"></span>
<a name="l00915"></a>00915 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l00916"></a>00916 <span class="comment"></span>
<a name="l00917"></a>00917       <span class="keywordflow">if</span> (!fCivilian)
<a name="l00918"></a>00918       {
<a name="l00919"></a>00919             iChance = 10 + <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f72e7e4bdc35542eca5402ce5329de32">bBypassToGreen</a>;
<a name="l00920"></a>00920 
<a name="l00921"></a>00921             <span class="comment">// set base chance and maximum seeking distance according to orders</span>
<a name="l00922"></a>00922             <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>)
<a name="l00923"></a>00923                   {
<a name="l00924"></a>00924                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>:     iChance *= 0; <span class="keywordflow">break</span>;
<a name="l00925"></a>00925                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>:        iChance += 10; <span class="keywordflow">break</span>;
<a name="l00926"></a>00926                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffbc5202d0fef4bcd4a4625750d02a724">ONCALL</a>:                         <span class="keywordflow">break</span>;
<a name="l00927"></a>00927                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>:    iChance += -20; <span class="keywordflow">break</span>;
<a name="l00928"></a>00928                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f4f7b012e8cbd1e2cc2b3fa9e1b5c9f9f">RNDPTPATROL</a>:
<a name="l00929"></a>00929                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f7dc5dd2cff7953315a832e7a457deb9d">POINTPATROL</a>:    iChance  = -30; <span class="keywordflow">break</span>;
<a name="l00930"></a>00930                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fddbbeee5695e4be7e9f148315873ce2b">FARPATROL</a>:      iChance += -40; <span class="keywordflow">break</span>;
<a name="l00931"></a>00931                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>:      iChance += -30; <span class="keywordflow">break</span>;
<a name="l00932"></a>00932                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a>:             iChance += 70; <span class="keywordflow">break</span>;
<a name="l00933"></a>00933                   }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935             <span class="comment">// modify for attitude</span>
<a name="l00936"></a>00936             <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>)
<a name="l00937"></a>00937                   {
<a name="l00938"></a>00938                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:      iChance *= 1.5;  <span class="keywordflow">break</span>;
<a name="l00939"></a>00939                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:      iChance /= 2;    <span class="keywordflow">break</span>;  
<a name="l00940"></a>00940                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:       iChance /= 2;   <span class="keywordflow">break</span>;  
<a name="l00941"></a>00941                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:    iChance *= 1;    <span class="keywordflow">break</span>;  
<a name="l00942"></a>00942                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:     iChance /= 1;   <span class="keywordflow">break</span>;  
<a name="l00943"></a>00943                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:     iChance /= 3;    <span class="keywordflow">break</span>;
<a name="l00944"></a>00944                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>:                                                     <span class="keywordflow">break</span>;
<a name="l00945"></a>00945                   }
<a name="l00946"></a>00946 
<a name="l00947"></a>00947 
<a name="l00948"></a>00948             <span class="comment">//hide those suicidal militia on the roofs for better defensive positions</span>
<a name="l00949"></a>00949             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == MILITIA_TEAM )
<a name="l00950"></a>00950                   iChance += 20;
<a name="l00951"></a>00951 
<a name="l00952"></a>00952             <span class="comment">// reduce chance for any injury, less likely to hop up if hurt</span>
<a name="l00953"></a>00953             iChance -= (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#600d382f89a391cdeb7bfe2580776866">bLifeMax</a> - <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a>);
<a name="l00954"></a>00954 
<a name="l00955"></a>00955             <span class="comment">// reduce chance if breath is down</span>
<a name="l00956"></a>00956             <span class="comment">//iChance -= (100 - pSoldier-&gt;bBreath);         // don't care</span>
<a name="l00957"></a>00957 
<a name="l00958"></a>00958             <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance)
<a name="l00959"></a>00959                   {
<a name="l00960"></a>00960                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> == 0 )
<a name="l00961"></a>00961                         {
<a name="l00962"></a>00962                               <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fUp = TRUE;
<a name="l00963"></a>00963                               <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> &gt; 0 )
<a name="l00964"></a>00964                                     fUp = FALSE;
<a name="l00965"></a>00965 
<a name="l00966"></a>00966                               <span class="keywordflow">if</span> ( <a class="code" href="ai_8h.html#c0ab3ab9291c1447f10a520aeb33cbd5">CanClimbFromHere</a> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, fUp ) )
<a name="l00967"></a>00967                               {
<a name="l00968"></a>00968                                           DebugMsg ( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a> , DBG_LEVEL_3 , <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Soldier %d is climbing roof"</span>,pSoldier-&gt;ubID) );
<a name="l00969"></a>00969                                           <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bf0d31a9fac3e900acf35ca5832cd876e">AI_ACTION_CLIMB_ROOF</a> );
<a name="l00970"></a>00970                               }
<a name="l00971"></a>00971                               <span class="keywordflow">else</span>
<a name="l00972"></a>00972                               {
<a name="l00973"></a>00973                                     pSoldier-&gt;usActionData = <a class="code" href="ai_8h.html#c3a9539676bbf7e786da9f3bec8406da">FindClosestClimbPoint</a>(pSoldier, fUp );
<a name="l00974"></a>00974                                     <span class="keywordflow">if</span> ( pSoldier-&gt;usActionData != NOWHERE )
<a name="l00975"></a>00975                                     {
<a name="l00976"></a>00976                                           <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4ca31547c6e6eeadec11ea94b7a9fd07">AI_ACTION_MOVE_TO_CLIMB</a>  );
<a name="l00977"></a>00977                                     }
<a name="l00978"></a>00978                               }
<a name="l00979"></a>00979                         }
<a name="l00980"></a>00980                   }
<a name="l00981"></a>00981       }     
<a name="l00982"></a>00982 
<a name="l00983"></a>00983       <span class="comment"></span>
<a name="l00984"></a>00984 <span class="comment">////////////////////////////////////////////////////////////////////////////</span>
<a name="l00985"></a>00985 <span class="comment"></span> <span class="comment">// RANDOM PATROL:  determine % chance to start a new patrol route</span><span class="comment"></span>
<a name="l00986"></a>00986 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l00987"></a>00987 <span class="comment"></span>            <span class="keywordflow">if</span> (!<a class="code" href="PATHAI_8cpp.html#1006624ded2cb2698d6a41ed8c88f875">gubNPCPathCount</a>) <span class="comment">// try to limit pathing in Green AI</span>
<a name="l00988"></a>00988             {
<a name="l00989"></a>00989 
<a name="l00990"></a>00990             iChance = 25 + pSoldier-&gt;bBypassToGreen;
<a name="l00991"></a>00991 
<a name="l00992"></a>00992             <span class="comment">// set base chance according to orders</span>
<a name="l00993"></a>00993             <span class="keywordflow">switch</span> (pSoldier-&gt;bOrders)
<a name="l00994"></a>00994                   {
<a name="l00995"></a>00995                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>:     iChance += -20;  <span class="keywordflow">break</span>;
<a name="l00996"></a>00996                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>:        iChance += -15;  <span class="keywordflow">break</span>;
<a name="l00997"></a>00997                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffbc5202d0fef4bcd4a4625750d02a724">ONCALL</a>:                          <span class="keywordflow">break</span>;
<a name="l00998"></a>00998                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>:    iChance += +15;  <span class="keywordflow">break</span>;
<a name="l00999"></a>00999                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f4f7b012e8cbd1e2cc2b3fa9e1b5c9f9f">RNDPTPATROL</a>:
<a name="l01000"></a>01000                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f7dc5dd2cff7953315a832e7a457deb9d">POINTPATROL</a>:       iChance = 0; <span class="keywordflow">break</span>;
<a name="l01001"></a>01001                   <span class="comment">/*</span>
<a name="l01002"></a>01002 <span class="comment">                  if ( !gfTurnBasedAI )</span>
<a name="l01003"></a>01003 <span class="comment">                                                                                    {</span>
<a name="l01004"></a>01004 <span class="comment">                                                                                          // realtime deadlock... increase chance!</span>
<a name="l01005"></a>01005 <span class="comment">                                                                                          iChance = 110;// more than 100 in case person is defensive</span>
<a name="l01006"></a>01006 <span class="comment">                                                                                    }</span>
<a name="l01007"></a>01007 <span class="comment">                                                                                    else if ( pSoldier-&gt;bInitialActionPoints &lt; pSoldier-&gt;bActionPoints ) // could be less because of carried-over points</span>
<a name="l01008"></a>01008 <span class="comment">                                                                                    { </span>
<a name="l01009"></a>01009 <span class="comment">                                                                                          // CJC: allow pt patrol guys to do a random move in case </span>
<a name="l01010"></a>01010 <span class="comment">                                                                                          // of a deadlock provided they haven't done anything yet this turn</span>
<a name="l01011"></a>01011 <span class="comment">                                                                                          iChance=   0;</span>
<a name="l01012"></a>01012 <span class="comment">                                                                                    }</span>
<a name="l01013"></a>01013 <span class="comment">                                                                                    break;</span>
<a name="l01014"></a>01014 <span class="comment">                                                                                    */</span>
<a name="l01015"></a>01015                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fddbbeee5695e4be7e9f148315873ce2b">FARPATROL</a>:      iChance += +25;  <span class="keywordflow">break</span>;
<a name="l01016"></a>01016                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>:      iChance += -10;  <span class="keywordflow">break</span>;
<a name="l01017"></a>01017                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a>:            iChance += -10;  <span class="keywordflow">break</span>;
<a name="l01018"></a>01018                   }
<a name="l01019"></a>01019 
<a name="l01020"></a>01020             <span class="comment">// modify chance of patrol (and whether it's a sneaky one) by attitude</span>
<a name="l01021"></a>01021             <span class="keywordflow">switch</span> (pSoldier-&gt;bAttitude)
<a name="l01022"></a>01022                   {
<a name="l01023"></a>01023                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:      iChance += -10;                 <span class="keywordflow">break</span>;
<a name="l01024"></a>01024                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:      iChance +=   5;                 <span class="keywordflow">break</span>;
<a name="l01025"></a>01025                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:                                       <span class="keywordflow">break</span>;
<a name="l01026"></a>01026                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:    iChance +=   5;  iSneaky += 10; <span class="keywordflow">break</span>;
<a name="l01027"></a>01027                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:                      iSneaky +=  5; <span class="keywordflow">break</span>;
<a name="l01028"></a>01028                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:     iChance +=  10;  iSneaky += -5; <span class="keywordflow">break</span>;
<a name="l01029"></a>01029                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>: iChance +=  10;  iSneaky += -5; <span class="keywordflow">break</span>;
<a name="l01030"></a>01030                   }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032             <span class="comment">// reduce chance for any injury, less likely to wander around when hurt</span>
<a name="l01033"></a>01033             iChance -= (pSoldier-&gt;bLifeMax - pSoldier-&gt;bLife);
<a name="l01034"></a>01034 
<a name="l01035"></a>01035             <span class="comment">// reduce chance if breath is down, less likely to wander around when tired</span>
<a name="l01036"></a>01036             iChance -= (100 - pSoldier-&gt;bBreath);
<a name="l01037"></a>01037 
<a name="l01038"></a>01038 
<a name="l01039"></a>01039             <span class="comment">// if we're in water with land miles (&gt; 25 tiles) away,</span>
<a name="l01040"></a>01040             <span class="comment">// OR if we roll under the chance calculated</span>
<a name="l01041"></a>01041             <span class="keywordflow">if</span> (bInWater || ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance))
<a name="l01042"></a>01042                   {
<a name="l01043"></a>01043                   pSoldier-&gt;usActionData = <a class="code" href="ai_8h.html#7cc62b556d98d53ddde253832844ad37">RandDestWithinRange</a>(pSoldier);
<a name="l01044"></a>01044 
<a name="l01045"></a>01045                   <span class="keywordflow">if</span> (pSoldier-&gt;usActionData != NOWHERE)
<a name="l01046"></a>01046                   {                 
<a name="l01047"></a>01047                         pSoldier-&gt;usActionData = <a class="code" href="AIInternals_8h.html#8058d9871f438da8f6f5ed91da85e559">GoAsFarAsPossibleTowards</a>( pSoldier, pSoldier-&gt;usActionData, <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bbf193832f320fa99e574d622b4fc391d">AI_ACTION_RANDOM_PATROL</a> );
<a name="l01048"></a>01048                   }
<a name="l01049"></a>01049 
<a name="l01050"></a>01050                   <span class="keywordflow">if</span> (pSoldier-&gt;usActionData != NOWHERE)
<a name="l01051"></a>01051                         {
<a name="l01052"></a>01052 <span class="preprocessor">            #ifdef DEBUGDECISIONS</span>
<a name="l01053"></a>01053 <span class="preprocessor"></span>                        sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - RANDOM PATROL to grid %d"</span>,pSoldier-&gt;name,pSoldier-&gt;usActionData);
<a name="l01054"></a>01054                         <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l01055"></a>01055 <span class="preprocessor">            #endif</span>
<a name="l01056"></a>01056 <span class="preprocessor"></span>                              
<a name="l01057"></a>01057                               <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l01058"></a>01058                               {
<a name="l01059"></a>01059                                     <span class="comment">// wait after this...</span>
<a name="l01060"></a>01060                                     pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a>;
<a name="l01061"></a>01061                                     pSoldier-&gt;usNextActionData = <a class="code" href="AIInternals_8h.html#3be60e41ccfb8673c4cc11312ab48298">RealtimeDelay</a>( pSoldier );
<a name="l01062"></a>01062                               }
<a name="l01063"></a>01063                         <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bbf193832f320fa99e574d622b4fc391d">AI_ACTION_RANDOM_PATROL</a>);
<a name="l01064"></a>01064                         }
<a name="l01065"></a>01065                   }
<a name="l01066"></a>01066             }
<a name="l01067"></a>01067 
<a name="l01068"></a>01068             <span class="keywordflow">if</span> (!<a class="code" href="PATHAI_8cpp.html#1006624ded2cb2698d6a41ed8c88f875">gubNPCPathCount</a>) <span class="comment">// try to limit pathing in Green AI</span>
<a name="l01069"></a>01069             {<span class="comment"></span>
<a name="l01070"></a>01070 <span class="comment">            ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01071"></a>01071 <span class="comment"></span>            <span class="comment">// SEEK FRIEND: determine %chance for man to pay a friendly visit</span><span class="comment"></span>
<a name="l01072"></a>01072 <span class="comment">            ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01073"></a>01073 <span class="comment"></span>
<a name="l01074"></a>01074             iChance = 25 + pSoldier-&gt;bBypassToGreen;
<a name="l01075"></a>01075 
<a name="l01076"></a>01076             <span class="comment">// set base chance and maximum seeking distance according to orders</span>
<a name="l01077"></a>01077             <span class="keywordflow">switch</span> (pSoldier-&gt;bOrders)
<a name="l01078"></a>01078                   {
<a name="l01079"></a>01079                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>:     iChance += -20; <span class="keywordflow">break</span>;
<a name="l01080"></a>01080                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>:        iChance += -15; <span class="keywordflow">break</span>;
<a name="l01081"></a>01081                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffbc5202d0fef4bcd4a4625750d02a724">ONCALL</a>:                         <span class="keywordflow">break</span>;
<a name="l01082"></a>01082                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>:    iChance += +10; <span class="keywordflow">break</span>;
<a name="l01083"></a>01083                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f4f7b012e8cbd1e2cc2b3fa9e1b5c9f9f">RNDPTPATROL</a>:
<a name="l01084"></a>01084                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f7dc5dd2cff7953315a832e7a457deb9d">POINTPATROL</a>:    iChance  = -10; <span class="keywordflow">break</span>;
<a name="l01085"></a>01085                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fddbbeee5695e4be7e9f148315873ce2b">FARPATROL</a>:      iChance += +20; <span class="keywordflow">break</span>;
<a name="l01086"></a>01086                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>:      iChance += -10; <span class="keywordflow">break</span>;
<a name="l01087"></a>01087                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a>:              iChance += -10; <span class="keywordflow">break</span>; 
<a name="l01088"></a>01088                   }
<a name="l01089"></a>01089 
<a name="l01090"></a>01090             <span class="comment">// modify for attitude</span>
<a name="l01091"></a>01091             <span class="keywordflow">switch</span> (pSoldier-&gt;bAttitude)
<a name="l01092"></a>01092                   {
<a name="l01093"></a>01093                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:                       <span class="keywordflow">break</span>;
<a name="l01094"></a>01094                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:      iChance /= 2;    <span class="keywordflow">break</span>;  <span class="comment">// loners</span>
<a name="l01095"></a>01095                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:       iChance += 10;   <span class="keywordflow">break</span>;  <span class="comment">// friendly</span>
<a name="l01096"></a>01096                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:    iChance /= 2;    <span class="keywordflow">break</span>;  <span class="comment">// loners</span>
<a name="l01097"></a>01097                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:     iChance += 10;   <span class="keywordflow">break</span>;  <span class="comment">// friendly</span>
<a name="l01098"></a>01098                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:                      <span class="keywordflow">break</span>;
<a name="l01099"></a>01099                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>:                                                     <span class="keywordflow">break</span>;
<a name="l01100"></a>01100                   }
<a name="l01101"></a>01101 
<a name="l01102"></a>01102             <span class="comment">// reduce chance for any injury, less likely to wander around when hurt</span>
<a name="l01103"></a>01103             iChance -= (pSoldier-&gt;bLifeMax - pSoldier-&gt;bLife);
<a name="l01104"></a>01104 
<a name="l01105"></a>01105             <span class="comment">// reduce chance if breath is down</span>
<a name="l01106"></a>01106             iChance -= (100 - pSoldier-&gt;bBreath);         <span class="comment">// very likely to wait when exhausted</span>
<a name="l01107"></a>01107 
<a name="l01108"></a>01108 
<a name="l01109"></a>01109             <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance)
<a name="l01110"></a>01110                   {
<a name="l01111"></a>01111                   <span class="keywordflow">if</span> (<a class="code" href="ai_8h.html#8793109cf51b08331254d2d59e6ee23d">RandomFriendWithin</a>(pSoldier))
<a name="l01112"></a>01112                         {
<a name="l01113"></a>01113                               <span class="keywordflow">if</span> ( pSoldier-&gt;usActionData == <a class="code" href="AIInternals_8h.html#8058d9871f438da8f6f5ed91da85e559">GoAsFarAsPossibleTowards</a>( pSoldier, pSoldier-&gt;usActionData, <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b42b12b1204c797182c2f7c35dbf84fc3">AI_ACTION_SEEK_FRIEND</a> ) )
<a name="l01114"></a>01114                               {       
<a name="l01115"></a>01115 
<a name="l01116"></a>01116 <span class="preprocessor">                              #ifdef DEBUGDECISIONS</span>
<a name="l01117"></a>01117 <span class="preprocessor"></span>                                          sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - SEEK FRIEND at grid %d"</span>,pSoldier-&gt;name,pSoldier-&gt;usActionData);
<a name="l01118"></a>01118                                           <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l01119"></a>01119 <span class="preprocessor">                              #endif</span>
<a name="l01120"></a>01120 <span class="preprocessor"></span>
<a name="l01121"></a>01121                                     <span class="keywordflow">if</span> (fCivilianOrMilitia &amp;&amp; !<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l01122"></a>01122                                     {
<a name="l01123"></a>01123                                           <span class="comment">// pause at the end of the walk!</span>
<a name="l01124"></a>01124                                           pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a>;
<a name="l01125"></a>01125                                           pSoldier-&gt;usNextActionData = (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) REALTIME_CIV_AI_DELAY;
<a name="l01126"></a>01126                                     }
<a name="l01127"></a>01127 
<a name="l01128"></a>01128                               <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b42b12b1204c797182c2f7c35dbf84fc3">AI_ACTION_SEEK_FRIEND</a>);
<a name="l01129"></a>01129                               }
<a name="l01130"></a>01130                         }
<a name="l01131"></a>01131                   }
<a name="l01132"></a>01132             }
<a name="l01133"></a>01133 
<a name="l01134"></a>01134             <span class="comment"></span>
<a name="l01135"></a>01135 <span class="comment">////////////////////////////////////////////////////////////////////////////</span>
<a name="l01136"></a>01136 <span class="comment"></span> <span class="comment">// SNIPERS LIKE TO CROUCH (on roofs)</span><span class="comment"></span>
<a name="l01137"></a>01137 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01138"></a>01138 <span class="comment"></span>
<a name="l01139"></a>01139       DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionGreen: Snipers like to crouch, sniper = %d"</span>,pSoldier-&gt;sniper));
<a name="l01140"></a>01140  <span class="comment">// if not in water and not already crouched, try to crouch down first</span>
<a name="l01141"></a>01141  <span class="keywordflow">if</span> (pSoldier-&gt;bOrders == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> &amp;&amp; !PTR_CROUCHED &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#419164836f72332cc058fa70ace03b47">IsValidStance</a>( pSoldier, ANIM_CROUCH ) &amp;&amp; pSoldier-&gt;bLevel == 1 )
<a name="l01142"></a>01142   {
<a name="l01143"></a>01143       <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || (<a class="code" href="Points_8cpp.html#69f88541b84e4d9890e0b786199e9a3a">GetAPsToChangeStance</a>( pSoldier, ANIM_CROUCH ) &lt;= pSoldier-&gt;bActionPoints))
<a name="l01144"></a>01144       {
<a name="l01145"></a>01145             DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionGreen: Sniper is crouching"</span>));
<a name="l01146"></a>01146             pSoldier-&gt;usActionData = ANIM_CROUCH;
<a name="l01147"></a>01147             pSoldier-&gt;sniper = 0;
<a name="l01148"></a>01148             <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a>);
<a name="l01149"></a>01149       }
<a name="l01150"></a>01150   }
<a name="l01151"></a>01151 <span class="comment"></span>
<a name="l01152"></a>01152 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01153"></a>01153 <span class="comment"></span> <span class="comment">// SNIPER - RAISE WEAPON TO SCAN AREA</span><span class="comment"></span>
<a name="l01154"></a>01154 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01155"></a>01155 <span class="comment"></span>
<a name="l01156"></a>01156 DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionGreen: Snipers like to raise weapons, sniper = %d"</span>,pSoldier-&gt;sniper));
<a name="l01157"></a>01157  <span class="keywordflow">if</span> ( pSoldier-&gt;bOrders == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> &amp;&amp; pSoldier-&gt;sniper == 0 &amp;&amp; ( pSoldier-&gt;bLevel == 1 || <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>(100) &lt; 40 ) ) 
<a name="l01158"></a>01158  {
<a name="l01159"></a>01159       <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#79d7f90b12d50906a6f34bee3ac1d28d">GetAPsToReadyWeapon</a>( pSoldier, <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb1b732af1789afff77e503d30253b84d6">READY_RIFLE_CROUCH</a> ) &lt;= pSoldier-&gt;bActionPoints)
<a name="l01160"></a>01160       {
<a name="l01161"></a>01161             DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionGreen: Sniper is raising weapon, soldier = %d, sniper = %d"</span>,pSoldier-&gt;ubID,pSoldier-&gt;sniper));
<a name="l01162"></a>01162             pSoldier-&gt;sniper = 1;
<a name="l01163"></a>01163             DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionGreen: Sniper = %d"</span>,pSoldier-&gt;sniper));
<a name="l01164"></a>01164             <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950ba91f358173f4ebb4c9d9c071642b8159">AI_ACTION_RAISE_GUN</a>);
<a name="l01165"></a>01165       }
<a name="l01166"></a>01166  }
<a name="l01167"></a>01167  <span class="comment">//else if ( pSoldier-&gt;sniper == 1 )</span>
<a name="l01168"></a>01168  <span class="comment">//{</span>
<a name="l01169"></a>01169       <span class="comment">//    DebugMsg(TOPIC_JA2,DBG_LEVEL_3,String("DecideActionGreen: Sniper is lowering weapon, sniper = %d",pSoldier-&gt;sniper));</span>
<a name="l01170"></a>01170       <span class="comment">//    pSoldier-&gt;sniper = 0;</span>
<a name="l01171"></a>01171       <span class="comment">//    DebugMsg(TOPIC_JA2,DBG_LEVEL_3,String("DecideActionGreen: Sniper = %d",pSoldier-&gt;sniper));</span>
<a name="l01172"></a>01172       <span class="comment">//    return(AI_ACTION_LOWER_GUN);</span>
<a name="l01173"></a>01173  <span class="comment">//}</span>
<a name="l01174"></a>01174 
<a name="l01175"></a>01175 <span class="comment"></span>
<a name="l01176"></a>01176 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01177"></a>01177 <span class="comment"></span> <span class="comment">// LOOK AROUND: determine %chance for man to turn in place</span><span class="comment"></span>
<a name="l01178"></a>01178 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01179"></a>01179 <span class="comment"></span>
<a name="l01180"></a>01180       DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionGreen: Soldier deciding to turn"</span>));
<a name="l01181"></a>01181       <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#9f252be6995e21dcbda09f03c7cf5253">GetAPsToLook</a>( pSoldier ) &lt;= pSoldier-&gt;bActionPoints)
<a name="l01182"></a>01182       {
<a name="l01183"></a>01183        <span class="comment">// avoid 2 consecutive random turns in a row</span>
<a name="l01184"></a>01184             <span class="keywordflow">if</span> (pSoldier-&gt;bLastAction != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>)
<a name="l01185"></a>01185             {
<a name="l01186"></a>01186              iChance = 25 + pSoldier-&gt;bBypassToGreen;
<a name="l01187"></a>01187 
<a name="l01188"></a>01188              <span class="comment">// set base chance according to orders</span>
<a name="l01189"></a>01189              <span class="keywordflow">if</span> (pSoldier-&gt;bOrders == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a> || pSoldier-&gt;bOrders == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a>)
<a name="l01190"></a>01190                    iChance += 25;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192              <span class="keywordflow">if</span> (pSoldier-&gt;bOrders == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>)
<a name="l01193"></a>01193                    iChance += 20;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195              <span class="keywordflow">if</span> (pSoldier-&gt;bAttitude == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>)
<a name="l01196"></a>01196                    iChance += 25;
<a name="l01197"></a>01197 
<a name="l01198"></a>01198              <span class="keywordflow">if</span> ( pSoldier-&gt;bOrders == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> &amp;&amp; pSoldier-&gt;bLevel == 1)
<a name="l01199"></a>01199                    iChance += 35;
<a name="l01200"></a>01200 
<a name="l01201"></a>01201              <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance)
<a name="l01202"></a>01202                   {
<a name="l01203"></a>01203                    <span class="comment">// roll random directions (stored in actionData) until different from current</span>
<a name="l01204"></a>01204                    <span class="keywordflow">do</span>
<a name="l01205"></a>01205                         {
<a name="l01206"></a>01206                               <span class="comment">// if man has a LEGAL dominant facing, and isn't facing it, he will turn</span>
<a name="l01207"></a>01207                               <span class="comment">// back towards that facing 50% of the time here (normally just enemies)</span>
<a name="l01208"></a>01208                               <span class="keywordflow">if</span> ((pSoldier-&gt;bDominantDir &gt;= 0) &amp;&amp; (pSoldier-&gt;bDominantDir &lt;= 8) &amp;&amp;
<a name="l01209"></a>01209                                     (pSoldier-&gt;bDirection != pSoldier-&gt;bDominantDir) &amp;&amp; <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(2) &amp;&amp; pSoldier-&gt;bOrders != <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> )
<a name="l01210"></a>01210                               {
<a name="l01211"></a>01211                                     pSoldier-&gt;usActionData = pSoldier-&gt;bDominantDir;
<a name="l01212"></a>01212                               }
<a name="l01213"></a>01213                          <span class="keywordflow">else</span>
<a name="l01214"></a>01214                               {
<a name="l01215"></a>01215                                     <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iNoiseValue;
<a name="l01216"></a>01216                                     <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fClimb;
<a name="l01217"></a>01217                                     <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fReachable;
<a name="l01218"></a>01218                                     <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sNoiseGridNo = <a class="code" href="AIInternals_8h.html#774611f6beecaa6455887e3b463833c4">MostImportantNoiseHeard</a>(pSoldier,&amp;iNoiseValue, &amp;fClimb, &amp;fReachable);
<a name="l01219"></a>01219                                     <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubNoiseDir;
<a name="l01220"></a>01220 
<a name="l01221"></a>01221                                     <span class="keywordflow">if</span> (sNoiseGridNo != NOWHERE)
<a name="l01222"></a>01222                                           ubNoiseDir = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>(<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(pSoldier-&gt;sGridNo),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(pSoldier-&gt;sGridNo),<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(sNoiseGridNo),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(sNoiseGridNo));
<a name="l01223"></a>01223       
<a name="l01224"></a>01224                                     <span class="keywordflow">if</span> ( sNoiseGridNo != NOWHERE &amp;&amp; pSoldier-&gt;bDirection != ubNoiseDir )
<a name="l01225"></a>01225                                           pSoldier-&gt;usActionData = ubNoiseDir; 
<a name="l01226"></a>01226                                     <span class="keywordflow">else</span>
<a name="l01227"></a>01227                                           pSoldier-&gt;usActionData = (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(8); 
<a name="l01228"></a>01228                               }
<a name="l01229"></a>01229                         } <span class="keywordflow">while</span> (pSoldier-&gt;usActionData == pSoldier-&gt;bDirection);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231 
<a name="l01232"></a>01232 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l01233"></a>01233 <span class="preprocessor"></span>                   sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - TURNS to face direction %d"</span>,pSoldier-&gt;name,pSoldier-&gt;usActionData);
<a name="l01234"></a>01234                    <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l01235"></a>01235 <span class="preprocessor">      #endif</span>
<a name="l01236"></a>01236 <span class="preprocessor"></span>
<a name="l01237"></a>01237                         DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionGreen: Trying to turn - checking stance validity, sniper = %d"</span>,pSoldier-&gt;sniper));
<a name="l01238"></a>01238                         <span class="keywordflow">if</span> ( <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( pSoldier, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) pSoldier-&gt;usActionData, <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ pSoldier-&gt;usAnimState ].<a class="code" href="structANIMCONTROLTYPE.html#fccdca6006bf66a4193a83b4f87dec10">ubEndHeight</a> ) )
<a name="l01239"></a>01239                         {
<a name="l01240"></a>01240                               
<a name="l01241"></a>01241                               <span class="keywordflow">if</span> ( !<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> )
<a name="l01242"></a>01242                               {
<a name="l01243"></a>01243                                     <span class="comment">// wait after this...</span>
<a name="l01244"></a>01244                                     pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a>;
<a name="l01245"></a>01245                                     pSoldier-&gt;usNextActionData = <a class="code" href="AIInternals_8h.html#3be60e41ccfb8673c4cc11312ab48298">RealtimeDelay</a>( pSoldier );
<a name="l01246"></a>01246                               }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248                               DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionGreen: Soldier is turning"</span>));
<a name="l01249"></a>01249                               <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>);
<a name="l01250"></a>01250                         }
<a name="l01251"></a>01251                   }
<a name="l01252"></a>01252             }
<a name="l01253"></a>01253       }
<a name="l01254"></a>01254             
<a name="l01255"></a>01255 <span class="comment"></span>
<a name="l01256"></a>01256 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01257"></a>01257 <span class="comment"></span>      <span class="comment">// NONE:</span><span class="comment"></span>
<a name="l01258"></a>01258 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01259"></a>01259 <span class="comment"></span>
<a name="l01260"></a>01260       <span class="comment">// by default, if everything else fails, just stands in place without turning</span>
<a name="l01261"></a>01261       <span class="comment">// for realtime, regular AI guys will use a standard wait set outside of here</span>
<a name="l01262"></a>01262       pSoldier-&gt;usActionData = NOWHERE;
<a name="l01263"></a>01263       <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l01264"></a>01264 }
<a name="l01265"></a>01265 
<a name="l01266"></a><a class="code" href="DecideAction_8cpp.html#7fea9db0a1bd960433cc4801e0881ab0">01266</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="ai_8h.html#7fea9db0a1bd960433cc4801e0881ab0">DecideActionYellow</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pSoldier)
<a name="l01267"></a>01267 {
<a name="l01268"></a>01268  <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iDummy;
<a name="l01269"></a>01269  <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubNoiseDir;
<a name="l01270"></a>01270  <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sNoiseGridNo;
<a name="l01271"></a>01271  <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iNoiseValue;
<a name="l01272"></a>01272  <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iChance, iSneaky;
<a name="l01273"></a>01273  <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sClosestFriend;
<a name="l01274"></a>01274  <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fCivilian = (PTR_CIVILIAN &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> == <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a078524cb5f7573455bdacd2b87a051da610c97">NON_CIV_GROUP</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a> || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> &gt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a72254b6f06629056dd86be50df5347676">FATCIV</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> &lt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a75db4e8d299d195df30798a12cd332f5a">CRIPPLECIV</a>) ) );
<a name="l01275"></a>01275  <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fClimb;
<a name="l01276"></a>01276  <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fReachable;
<a name="l01277"></a>01277 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l01278"></a>01278 <span class="preprocessor"></span>            <a class="code" href="Types_8h.html#94ebfccc6e846c28751f8d616371f1e5">STR16</a> tempstr;
<a name="l01279"></a>01279 <span class="preprocessor">      #endif</span>
<a name="l01280"></a>01280 <span class="preprocessor"></span>
<a name="l01281"></a>01281 
<a name="l01282"></a>01282       <span class="keywordflow">if</span> (fCivilian)
<a name="l01283"></a>01283       {
<a name="l01284"></a>01284             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_COWERING)
<a name="l01285"></a>01285             {
<a name="l01286"></a>01286                   <span class="comment">// everything's peaceful again, stop cowering!!</span>
<a name="l01287"></a>01287                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_STAND;
<a name="l01288"></a>01288                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6f46584addd5e876d03eef0b47c41003">AI_ACTION_STOP_COWERING</a> );
<a name="l01289"></a>01289             }
<a name="l01290"></a>01290             <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l01291"></a>01291             {
<a name="l01292"></a>01292                   <span class="comment">// ******************</span>
<a name="l01293"></a>01293                   <span class="comment">// REAL TIME NPC CODE</span>
<a name="l01294"></a>01294                   <span class="comment">// ******************</span>
<a name="l01295"></a>01295                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE)
<a name="l01296"></a>01296                   {
<a name="l01297"></a>01297                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="DecideAction_8cpp.html#e58c74788082cdac54a75c65707310aa">DecideActionNamedNPC</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01298"></a>01298                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> )
<a name="l01299"></a>01299                         {
<a name="l01300"></a>01300                               <span class="keywordflow">return</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> );
<a name="l01301"></a>01301                         }
<a name="l01302"></a>01302 
<a name="l01303"></a>01303                   }
<a name="l01304"></a>01304 
<a name="l01305"></a>01305             }
<a name="l01306"></a>01306 
<a name="l01307"></a>01307       }
<a name="l01308"></a>01308 
<a name="l01309"></a>01309  <span class="comment">// determine the most important noise heard, and its relative value</span>
<a name="l01310"></a>01310  sNoiseGridNo = <a class="code" href="AIInternals_8h.html#774611f6beecaa6455887e3b463833c4">MostImportantNoiseHeard</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,&amp;iNoiseValue, &amp;fClimb, &amp;fReachable);
<a name="l01311"></a>01311  <span class="comment">//NumMessage("iNoiseValue = ",iNoiseValue);</span>
<a name="l01312"></a>01312 
<a name="l01313"></a>01313       <span class="keywordflow">if</span> (sNoiseGridNo == NOWHERE)
<a name="l01314"></a>01314       {
<a name="l01315"></a>01315    <span class="comment">// then we have no business being under YELLOW status any more!</span>
<a name="l01316"></a>01316 <span class="preprocessor">#ifdef RECORDNET</span>
<a name="l01317"></a>01317 <span class="preprocessor"></span>   fprintf(NetDebugFile,<span class="stringliteral">"\nDecideActionYellow: ERROR - No important noise known by guynum %d\n\n"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>);
<a name="l01318"></a>01318 <span class="preprocessor">#endif</span>
<a name="l01319"></a>01319 <span class="preprocessor"></span>
<a name="l01320"></a>01320 <span class="preprocessor">#ifdef BETAVERSION</span>
<a name="l01321"></a>01321 <span class="preprocessor"></span>   NumMessage(<span class="stringliteral">"DecideActionYellow: ERROR - No important noise known by guynum "</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>);
<a name="l01322"></a>01322 <span class="preprocessor">#endif</span>
<a name="l01323"></a>01323 <span class="preprocessor"></span>            
<a name="l01324"></a>01324             <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l01325"></a>01325       }
<a name="l01326"></a>01326 
<a name="l01327"></a>01327 
<a name="l01328"></a>01328 <span class="comment"></span>
<a name="l01329"></a>01329 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01330"></a>01330 <span class="comment"></span> <span class="comment">// LOOK AROUND TOWARD NOISE: determine %chance for man to turn towards noise</span><span class="comment"></span>
<a name="l01331"></a>01331 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01332"></a>01332 <span class="comment"></span>
<a name="l01333"></a>01333  <span class="comment">// determine direction from this soldier in which the noise lies</span>
<a name="l01334"></a>01334  ubNoiseDir = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>(<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(sNoiseGridNo),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(sNoiseGridNo));
<a name="l01335"></a>01335 
<a name="l01336"></a>01336  <span class="comment">// if soldier is not already facing in that direction,</span>
<a name="l01337"></a>01337  <span class="comment">// and the noise source is close enough that it could possibly be seen</span>
<a name="l01338"></a>01338  <span class="keywordflow">if</span> ( !<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#9f252be6995e21dcbda09f03c7cf5253">GetAPsToLook</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> )
<a name="l01339"></a>01339  {
<a name="l01340"></a>01340        <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> != ubNoiseDir) &amp;&amp; <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>,sNoiseGridNo) &lt;= <a class="code" href="opplist_8cpp.html#ce89c9f1017d9a6e473df03acb6f1a2a">MaxDistanceVisible</a>() )
<a name="l01341"></a>01341             {
<a name="l01342"></a>01342              <span class="comment">// set base chance according to orders</span>
<a name="l01343"></a>01343              <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>) || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>) )
<a name="l01344"></a>01344                    iChance = 50;
<a name="l01345"></a>01345              <span class="keywordflow">else</span>           <span class="comment">// all other orders</span>
<a name="l01346"></a>01346                    iChance = 25;
<a name="l01347"></a>01347 
<a name="l01348"></a>01348              <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a> == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>)
<a name="l01349"></a>01349                    iChance += 15;
<a name="l01350"></a>01350 
<a name="l01351"></a>01351 
<a name="l01352"></a>01352              <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubNoiseDir, <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight ) )
<a name="l01353"></a>01353                   {
<a name="l01354"></a>01354                    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ubNoiseDir;
<a name="l01355"></a>01355 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l01356"></a>01356 <span class="preprocessor"></span>                   sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - TURNS TOWARDS NOISE to face direction %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l01357"></a>01357                    <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l01358"></a>01358 <span class="preprocessor">      #endif</span>
<a name="l01359"></a>01359 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> )
<a name="l01360"></a>01360                   {
<a name="l01361"></a>01361                         <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#79d7f90b12d50906a6f34bee3ac1d28d">GetAPsToReadyWeapon</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb1b732af1789afff77e503d30253b84d6">READY_RIFLE_CROUCH</a> ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l01362"></a>01362                         {
<a name="l01363"></a>01363                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950ba91f358173f4ebb4c9d9c071642b8159">AI_ACTION_RAISE_GUN</a>;
<a name="l01364"></a>01364                         }
<a name="l01365"></a>01365                   }
<a name="l01366"></a>01366                    <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>);
<a name="l01367"></a>01367                   }
<a name="l01368"></a>01368             }
<a name="l01369"></a>01369       }
<a name="l01370"></a>01370 
<a name="l01371"></a>01371 <span class="comment"></span>
<a name="l01372"></a>01372 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01373"></a>01373 <span class="comment"></span> <span class="comment">// RADIO YELLOW ALERT: determine %chance to call others and report noise</span><span class="comment"></span>
<a name="l01374"></a>01374 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01375"></a>01375 <span class="comment"></span>
<a name="l01376"></a>01376  <span class="comment">// if we have the action points remaining to RADIO</span>
<a name="l01377"></a>01377  <span class="comment">// (we never want NPCs to choose to radio if they would have to wait a turn)</span>
<a name="l01378"></a>01378  <span class="keywordflow">if</span> ( !fCivilian &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt;= AP_RADIO) &amp;&amp;
<a name="l01379"></a>01379      (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bMenInSector &gt; 1) )
<a name="l01380"></a>01380   {
<a name="l01381"></a>01381    <span class="comment">// base chance depends on how much new info we have to radio to the others</span>
<a name="l01382"></a>01382    iChance = 5 * <a class="code" href="ai_8h.html#b72f0daba2e93b7c9d9c2ba87426da07">WhatIKnowThatPublicDont</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,FALSE);   <span class="comment">// use 5 * for YELLOW alert</span>
<a name="l01383"></a>01383 
<a name="l01384"></a>01384    <span class="comment">// if I actually know something they don't and I ain't swimming (deep water)</span>
<a name="l01385"></a>01385    <span class="keywordflow">if</span> (iChance &amp;&amp; !<a class="code" href="worldman_8cpp.html#e1d4e84c8d63ec8cd98683c9a3f8d9d6">DeepWater</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ))
<a name="l01386"></a>01386     {
<a name="l01387"></a>01387 
<a name="l01388"></a>01388              <span class="comment">// CJC: this addition allows for varying difficulty levels for soldier types</span>
<a name="l01389"></a>01389              iChance += <a class="code" href="ai_8h.html#71440b56c1b498cae809e64152b7d65e">gbDiff</a>[ DIFF_RADIO_RED_ALERT ][ <a class="code" href="ai_8h.html#eb68d5bd7803b8c6d4637cf543b9372c">SoldierDifficultyLevel</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) ] / 2;
<a name="l01390"></a>01390 
<a name="l01391"></a>01391      <span class="comment">// Alex: this addition replaces the sectorValue/2 in original JA</span>
<a name="l01392"></a>01392      <span class="comment">//iChance += gsDiff[DIFF_RADIO_RED_ALERT][GameOption[ENEMYDIFFICULTY]] / 2;</span>
<a name="l01393"></a>01393 
<a name="l01394"></a>01394      <span class="comment">// modify base chance according to orders</span>
<a name="l01395"></a>01395      <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>)
<a name="l01396"></a>01396       {
<a name="l01397"></a>01397        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>: iChance +=  20;  <span class="keywordflow">break</span>;
<a name="l01398"></a>01398        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>:    iChance +=  15;  <span class="keywordflow">break</span>;
<a name="l01399"></a>01399        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffbc5202d0fef4bcd4a4625750d02a724">ONCALL</a>:     iChance +=  10;  <span class="keywordflow">break</span>;
<a name="l01400"></a>01400        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>:                 <span class="keywordflow">break</span>;
<a name="l01401"></a>01401                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f4f7b012e8cbd1e2cc2b3fa9e1b5c9f9f">RNDPTPATROL</a>:
<a name="l01402"></a>01402        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f7dc5dd2cff7953315a832e7a457deb9d">POINTPATROL</a>:                 <span class="keywordflow">break</span>;
<a name="l01403"></a>01403        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fddbbeee5695e4be7e9f148315873ce2b">FARPATROL</a>:  iChance += -10;  <span class="keywordflow">break</span>;
<a name="l01404"></a>01404        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>:  iChance += -20;  <span class="keywordflow">break</span>;
<a name="l01405"></a>01405        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a>:           iChance += -10; <span class="keywordflow">break</span>; <span class="comment">//Madd: sniper contacts are supposed to be automatically reported</span>
<a name="l01406"></a>01406       }
<a name="l01407"></a>01407 
<a name="l01408"></a>01408      <span class="comment">// modify base chance according to attitude</span>
<a name="l01409"></a>01409      <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>)
<a name="l01410"></a>01410       {
<a name="l01411"></a>01411        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:  iChance +=  20;  <span class="keywordflow">break</span>;
<a name="l01412"></a>01412        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:  iChance += -10;  <span class="keywordflow">break</span>;
<a name="l01413"></a>01413        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:                    <span class="keywordflow">break</span>;
<a name="l01414"></a>01414        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:iChance +=  -5;  <span class="keywordflow">break</span>;
<a name="l01415"></a>01415        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:                  <span class="keywordflow">break</span>;
<a name="l01416"></a>01416        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>: iChance += -20;  <span class="keywordflow">break</span>;
<a name="l01417"></a>01417                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>: iChance = 0; <span class="keywordflow">break</span>;
<a name="l01418"></a>01418       }
<a name="l01419"></a>01419 
<a name="l01420"></a>01420 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l01421"></a>01421 <span class="preprocessor"></span>     <a class="code" href="AIUtils_8cpp.html#88d13d659f1890049d17af096cc37432">AINumMessage</a>(<span class="stringliteral">"Chance to radio yellow alert = "</span>,iChance);
<a name="l01422"></a>01422 <span class="preprocessor">#endif</span>
<a name="l01423"></a>01423 <span class="preprocessor"></span>
<a name="l01424"></a>01424      <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance)
<a name="l01425"></a>01425       {
<a name="l01426"></a>01426 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l01427"></a>01427 <span class="preprocessor"></span>       <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"decides to radio a YELLOW alert!"</span>,1000);
<a name="l01428"></a>01428 <span class="preprocessor">#endif</span>
<a name="l01429"></a>01429 <span class="preprocessor"></span>
<a name="l01430"></a>01430        <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b040215f06027cab6536b687b79df4633">AI_ACTION_YELLOW_ALERT</a>);
<a name="l01431"></a>01431       }
<a name="l01432"></a>01432     }
<a name="l01433"></a>01433   }
<a name="l01434"></a>01434 
<a name="l01435"></a>01435       <span class="keywordflow">if</span> ( TANK( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l01436"></a>01436       {
<a name="l01437"></a>01437             <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l01438"></a>01438       }
<a name="l01439"></a>01439 <span class="comment"></span>
<a name="l01440"></a>01440 <span class="comment"> ////////////////////////////////////////////////////////////////////////</span>
<a name="l01441"></a>01441 <span class="comment"></span> <span class="comment">// REST IF RUNNING OUT OF BREATH</span><span class="comment"></span>
<a name="l01442"></a>01442 <span class="comment"> ////////////////////////////////////////////////////////////////////////</span>
<a name="l01443"></a>01443 <span class="comment"></span>
<a name="l01444"></a>01444  <span class="comment">// if our breath is running a bit low, and we're not in water</span>
<a name="l01445"></a>01445  <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a> &lt; 25) &amp;&amp; !<a class="code" href="Soldier_01Control_8cpp.html#136730f4d5bc849d712446b0b871205a">MercInWater</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>))
<a name="l01446"></a>01446   {
<a name="l01447"></a>01447    <span class="comment">// take a breather for gods sake!</span>
<a name="l01448"></a>01448    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l01449"></a>01449    <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l01450"></a>01450   }
<a name="l01451"></a>01451 
<a name="l01452"></a>01452 <span class="comment">//continue flanking</span>
<a name="l01453"></a>01453       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> tempGridNo;
<a name="l01454"></a>01454       <span class="keywordflow">if</span> ( sNoiseGridNo == NOWHERE )
<a name="l01455"></a>01455             tempGridNo = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4b05ad0162c2ca209e5a51fdbf9c4cde">lastFlankSpot</a>;
<a name="l01456"></a>01456       <span class="keywordflow">else</span>
<a name="l01457"></a>01457             tempGridNo = sNoiseGridNo;
<a name="l01458"></a>01458 
<a name="l01459"></a>01459       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> &gt; 0 &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> &lt; MAX_FLANKS_YELLOW )
<a name="l01460"></a>01460       {
<a name="l01461"></a>01461             <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> currDir = <a class="code" href="Soldier_01Control_8cpp.html#1d7b6c103ede7e551e76eef2ef173f9b">GetDirectionFromGridNo</a> ( tempGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01462"></a>01462             <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> origDir = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e2645c74e19c721ccca934e1f73ab1d0">origDir</a>;
<a name="l01463"></a>01463             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> += 1;
<a name="l01464"></a>01464             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5562d9bc4815ba4c0d02e60463ca48fa">lastFlankLeft</a> )
<a name="l01465"></a>01465             {
<a name="l01466"></a>01466                   <span class="keywordflow">if</span> ( origDir &gt; currDir )
<a name="l01467"></a>01467                         origDir -= 8;
<a name="l01468"></a>01468 
<a name="l01469"></a>01469                   <span class="keywordflow">if</span> ( (currDir - origDir) &gt;= 4 )
<a name="l01470"></a>01470                   {
<a name="l01471"></a>01471                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> = MAX_FLANKS_YELLOW;
<a name="l01472"></a>01472                   }
<a name="l01473"></a>01473                   <span class="keywordflow">else</span>
<a name="l01474"></a>01474                   {
<a name="l01475"></a>01475                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#eab088163bfe9e97370857eba0ab6629">FindFlankingSpot</a> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, tempGridNo , <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a>);
<a name="l01476"></a>01476                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE ) <span class="comment">//&amp;&amp; (currDir - origDir) &lt; 2 )</span>
<a name="l01477"></a>01477                               <span class="keywordflow">return</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a> ;
<a name="l01478"></a>01478                         <span class="keywordflow">else</span>
<a name="l01479"></a>01479                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> = MAX_FLANKS_YELLOW;
<a name="l01480"></a>01480                   }
<a name="l01481"></a>01481             }
<a name="l01482"></a>01482             <span class="keywordflow">else</span>
<a name="l01483"></a>01483             {
<a name="l01484"></a>01484                   <span class="keywordflow">if</span> ( origDir &lt; currDir )
<a name="l01485"></a>01485                         origDir += 8;
<a name="l01486"></a>01486 
<a name="l01487"></a>01487                   <span class="keywordflow">if</span> ( (origDir - currDir) &gt;= 4 )
<a name="l01488"></a>01488                   {
<a name="l01489"></a>01489                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> = MAX_FLANKS_YELLOW;
<a name="l01490"></a>01490                   }
<a name="l01491"></a>01491                   <span class="keywordflow">else</span>
<a name="l01492"></a>01492                   {
<a name="l01493"></a>01493                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#eab088163bfe9e97370857eba0ab6629">FindFlankingSpot</a> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, tempGridNo , <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b10a5bb7993a15bb15134edd4a78384cd">AI_ACTION_FLANK_RIGHT</a>);
<a name="l01494"></a>01494                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE )<span class="comment">//&amp;&amp; (origDir - currDir) &lt; 2 )</span>
<a name="l01495"></a>01495                               <span class="keywordflow">return</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b10a5bb7993a15bb15134edd4a78384cd">AI_ACTION_FLANK_RIGHT</a> ;
<a name="l01496"></a>01496                         <span class="keywordflow">else</span>
<a name="l01497"></a>01497                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> = MAX_FLANKS_YELLOW;
<a name="l01498"></a>01498                   }
<a name="l01499"></a>01499             }
<a name="l01500"></a>01500       }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> == MAX_FLANKS_YELLOW )
<a name="l01503"></a>01503       {
<a name="l01504"></a>01504             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> += 1;
<a name="l01505"></a>01505             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#8058d9871f438da8f6f5ed91da85e559">GoAsFarAsPossibleTowards</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,tempGridNo,<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b69da0507d724596d4763a66492e793b7">AI_ACTION_SEEK_NOISE</a>);
<a name="l01506"></a>01506             <span class="keywordflow">return</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b69da0507d724596d4763a66492e793b7">AI_ACTION_SEEK_NOISE</a> ;
<a name="l01507"></a>01507       }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509       
<a name="l01510"></a>01510  <span class="keywordflow">if</span> ( !( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == CIV_TEAM &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa124c23d7f7a7db6dc665eeeae17de5fbe">ELDIN</a> ) )
<a name="l01511"></a>01511  {
<a name="l01512"></a>01512        <span class="comment">// IF WE ARE MILITIA/CIV IN REALTIME, CLOSE TO NOISE, AND CAN SEE THE SPOT WHERE THE NOISE CAME FROM, FORGET IT</span>
<a name="l01513"></a>01513        <span class="keywordflow">if</span> ( fReachable &amp;&amp; !fClimb &amp;&amp; !<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == MILITIA_TEAM || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == CIV_TEAM )&amp;&amp; <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, sNoiseGridNo ) &lt; 5 )
<a name="l01514"></a>01514        {
<a name="l01515"></a>01515                   <span class="keywordflow">if</span> ( <a class="code" href="LOS_8cpp.html#7ccd0f206cf1c499fcb25349e20fd106">SoldierTo3DLocationLineOfSightTest</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sNoiseGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, 0, 6, TRUE ) )
<a name="l01516"></a>01516                   {
<a name="l01517"></a>01517                         <span class="comment">// set reachable to false so we don't investigate</span>
<a name="l01518"></a>01518                         fReachable = FALSE;
<a name="l01519"></a>01519                         <span class="comment">// forget about noise</span>
<a name="l01520"></a>01520                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0fdab3f65adc00474d2f67655f77c6b9">sNoiseGridno</a> = NOWHERE;
<a name="l01521"></a>01521                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#38db62a11e58e205b0c604fbf6278e2e">ubNoiseVolume</a> = 0;
<a name="l01522"></a>01522                   }
<a name="l01523"></a>01523        }
<a name="l01524"></a>01524 <span class="comment"></span>
<a name="l01525"></a>01525 <span class="comment">       ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01526"></a>01526 <span class="comment"></span>       <span class="comment">// SEEK NOISE</span><span class="comment"></span>
<a name="l01527"></a>01527 <span class="comment">       ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01528"></a>01528 <span class="comment"></span>
<a name="l01529"></a>01529        <span class="keywordflow">if</span> ( fReachable )
<a name="l01530"></a>01530        {
<a name="l01531"></a>01531              <span class="comment">// remember that noise value is negative, and closer to 0 =&gt; more important!</span>
<a name="l01532"></a>01532              iChance = 95 + (iNoiseValue / 3);
<a name="l01533"></a>01533              iSneaky = 30;
<a name="l01534"></a>01534 
<a name="l01535"></a>01535              <span class="comment">// increase </span>
<a name="l01536"></a>01536 
<a name="l01537"></a>01537              <span class="comment">// set base chance according to orders</span>
<a name="l01538"></a>01538              <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>)
<a name="l01539"></a>01539                   {
<a name="l01540"></a>01540                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>:     iChance += -20;  <span class="keywordflow">break</span>;
<a name="l01541"></a>01541                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>:        iChance += -15;  <span class="keywordflow">break</span>;
<a name="l01542"></a>01542                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffbc5202d0fef4bcd4a4625750d02a724">ONCALL</a>:                          <span class="keywordflow">break</span>;
<a name="l01543"></a>01543                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>:    iChance += -10;  <span class="keywordflow">break</span>;
<a name="l01544"></a>01544                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f4f7b012e8cbd1e2cc2b3fa9e1b5c9f9f">RNDPTPATROL</a>:
<a name="l01545"></a>01545                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f7dc5dd2cff7953315a832e7a457deb9d">POINTPATROL</a>:                     <span class="keywordflow">break</span>;
<a name="l01546"></a>01546                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fddbbeee5695e4be7e9f148315873ce2b">FARPATROL</a>:      iChance +=  10;  <span class="keywordflow">break</span>;
<a name="l01547"></a>01547                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>:      iChance +=  25;  <span class="keywordflow">break</span>;
<a name="l01548"></a>01548                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a>:             iChance += -10; <span class="keywordflow">break</span>;
<a name="l01549"></a>01549                   }
<a name="l01550"></a>01550 
<a name="l01551"></a>01551              <span class="comment">// modify chance of patrol (and whether it's a sneaky one) by attitude</span>
<a name="l01552"></a>01552              <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>)
<a name="l01553"></a>01553                   {
<a name="l01554"></a>01554                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:      iChance += -10;  iSneaky +=  15;  <span class="keywordflow">break</span>;
<a name="l01555"></a>01555                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:      iChance +=  10;                   <span class="keywordflow">break</span>;
<a name="l01556"></a>01556                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:       iChance +=   5;                   <span class="keywordflow">break</span>;
<a name="l01557"></a>01557                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:    iChance +=   5;  iSneaky +=  30;  <span class="keywordflow">break</span>;
<a name="l01558"></a>01558                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:                      iSneaky +=  30;  <span class="keywordflow">break</span>;
<a name="l01559"></a>01559                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:     iChance +=  20;  iSneaky += -10;  <span class="keywordflow">break</span>;
<a name="l01560"></a>01560                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>:   iChance +=  20;  iSneaky += -10;  <span class="keywordflow">break</span>;
<a name="l01561"></a>01561                   }
<a name="l01562"></a>01562 
<a name="l01563"></a>01563 
<a name="l01564"></a>01564              <span class="comment">// reduce chance if breath is down, less likely to wander around when tired</span>
<a name="l01565"></a>01565              iChance -= (100 - <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a>);
<a name="l01566"></a>01566 
<a name="l01567"></a>01567             <span class="comment">//Madd: make militia less likely to go running headlong into trouble</span>
<a name="l01568"></a>01568             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == MILITIA_TEAM )
<a name="l01569"></a>01569                   iChance -= 30;
<a name="l01570"></a>01570 
<a name="l01571"></a>01571              <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance  )
<a name="l01572"></a>01572                   {
<a name="l01573"></a>01573 
<a name="l01574"></a>01574                    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#8058d9871f438da8f6f5ed91da85e559">GoAsFarAsPossibleTowards</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,sNoiseGridNo,<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b69da0507d724596d4763a66492e793b7">AI_ACTION_SEEK_NOISE</a>);
<a name="l01575"></a>01575 
<a name="l01576"></a>01576                    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l01577"></a>01577                         {
<a name="l01578"></a>01578 <span class="preprocessor">            #ifdef DEBUGDECISIONS</span>
<a name="l01579"></a>01579 <span class="preprocessor"></span>                         sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - INVESTIGATING NOISE at grid %d, moving to %d"</span>,
<a name="l01580"></a>01580                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,sNoiseGridNo,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l01581"></a>01581                          <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l01582"></a>01582 <span class="preprocessor">            #endif</span>
<a name="l01583"></a>01583 <span class="preprocessor"></span>
<a name="l01584"></a>01584                               <span class="keywordflow">if</span> ( fClimb )<span class="comment">//&amp;&amp; pSoldier-&gt;usActionData == sNoiseGridNo)</span>
<a name="l01585"></a>01585                               {
<a name="l01586"></a>01586                                     <span class="comment">// need to climb AND have enough APs to get there this turn</span>
<a name="l01587"></a>01587                                     <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fUp = TRUE;
<a name="l01588"></a>01588                                     <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> &gt; 0 )
<a name="l01589"></a>01589                                           fUp = FALSE;
<a name="l01590"></a>01590       
<a name="l01591"></a>01591                                     <span class="keywordflow">if</span> (!fUp)
<a name="l01592"></a>01592                                           DebugMsg ( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a> , DBG_LEVEL_3 , <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Soldier %d, is climbing down"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>) );
<a name="l01593"></a>01593 
<a name="l01594"></a>01594                                     <span class="keywordflow">if</span> ( <a class="code" href="ai_8h.html#c0ab3ab9291c1447f10a520aeb33cbd5">CanClimbFromHere</a> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, fUp ) )
<a name="l01595"></a>01595                                     {
<a name="l01596"></a>01596                                           <span class="keywordflow">if</span> (<a class="code" href="ai_8h.html#dd5730a3e85127b7590031d7580277b0">IsActionAffordable</a>(pSoldier) &amp;&amp; pSoldier-&gt;bActionPoints &gt;= ( AP_CLIMBROOF + <a class="code" href="Points_8cpp.html#84f116b33524232723bfa74949877c21">MinAPsToAttack</a>( pSoldier, sNoiseGridNo, ADDTURNCOST)))
<a name="l01597"></a>01597                                           {
<a name="l01598"></a>01598                                                 <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bf0d31a9fac3e900acf35ca5832cd876e">AI_ACTION_CLIMB_ROOF</a> );
<a name="l01599"></a>01599                                           }
<a name="l01600"></a>01600                                     }
<a name="l01601"></a>01601                                     <span class="keywordflow">else</span>
<a name="l01602"></a>01602                                     {
<a name="l01603"></a>01603                                           pSoldier-&gt;usActionData = <a class="code" href="ai_8h.html#c3a9539676bbf7e786da9f3bec8406da">FindClosestClimbPoint</a>(pSoldier-&gt;sGridNo , sNoiseGridNo , fUp );
<a name="l01604"></a>01604                                           <span class="keywordflow">if</span> ( pSoldier-&gt;usActionData != NOWHERE )
<a name="l01605"></a>01605                                           {
<a name="l01606"></a>01606                                                 <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4ca31547c6e6eeadec11ea94b7a9fd07">AI_ACTION_MOVE_TO_CLIMB</a>  );
<a name="l01607"></a>01607                                           }
<a name="l01608"></a>01608                                     }
<a name="l01609"></a>01609                               }
<a name="l01610"></a>01610 
<a name="l01611"></a>01611                               <span class="keywordflow">if</span> ( ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a> == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a> == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a> == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a> ) )
<a name="l01612"></a>01612                               {
<a name="l01613"></a>01613                                     <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> action = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b69da0507d724596d4763a66492e793b7">AI_ACTION_SEEK_NOISE</a>; 
<a name="l01614"></a>01614                                     <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> dist = <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, sNoiseGridNo );
<a name="l01615"></a>01615                                     <span class="keywordflow">if</span> ( dist &gt; MIN_FLANK_DIST_YELLOW &amp;&amp; dist &lt; MAX_FLANK_DIST_YELLOW  )
<a name="l01616"></a>01616                                     {
<a name="l01617"></a>01617                                           <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> rdm = <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>(6);
<a name="l01618"></a>01618 
<a name="l01619"></a>01619                                           <span class="keywordflow">switch</span> (rdm)
<a name="l01620"></a>01620                                           {
<a name="l01621"></a>01621                                                 <span class="keywordflow">case</span> 1:                                   
<a name="l01622"></a>01622                                                 <span class="keywordflow">case</span> 2:                                   
<a name="l01623"></a>01623                                                 <span class="keywordflow">case</span> 3:
<a name="l01624"></a>01624                                                       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b10a5bb7993a15bb15134edd4a78384cd">AI_ACTION_FLANK_RIGHT</a> )
<a name="l01625"></a>01625                                                             action = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a> ;
<a name="l01626"></a>01626                                                       <span class="keywordflow">break</span>;
<a name="l01627"></a>01627                                                 <span class="keywordflow">default</span>:                                  
<a name="l01628"></a>01628                                                       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b10a5bb7993a15bb15134edd4a78384cd">AI_ACTION_FLANK_RIGHT</a> )
<a name="l01629"></a>01629                                                             action = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b10a5bb7993a15bb15134edd4a78384cd">AI_ACTION_FLANK_RIGHT</a> ;
<a name="l01630"></a>01630                                                       <span class="keywordflow">break</span>;
<a name="l01631"></a>01631                                           }     
<a name="l01632"></a>01632                                     }
<a name="l01633"></a>01633                                     <span class="keywordflow">else</span>
<a name="l01634"></a>01634                                           <span class="keywordflow">return</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b69da0507d724596d4763a66492e793b7">AI_ACTION_SEEK_NOISE</a> ;
<a name="l01635"></a>01635 
<a name="l01636"></a>01636                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#eab088163bfe9e97370857eba0ab6629">FindFlankingSpot</a> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sNoiseGridNo, action );
<a name="l01637"></a>01637 
<a name="l01638"></a>01638                                     <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> == NOWHERE || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> &gt;= MAX_FLANKS_YELLOW  )
<a name="l01639"></a>01639                                     {
<a name="l01640"></a>01640                                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#8058d9871f438da8f6f5ed91da85e559">GoAsFarAsPossibleTowards</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,sNoiseGridNo,<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b69da0507d724596d4763a66492e793b7">AI_ACTION_SEEK_NOISE</a>);
<a name="l01641"></a>01641                                           <span class="comment">//pSoldier-&gt;numFlanks = 0;</span>
<a name="l01642"></a>01642                                           <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b69da0507d724596d4763a66492e793b7">AI_ACTION_SEEK_NOISE</a>);
<a name="l01643"></a>01643                                     }
<a name="l01644"></a>01644                                     <span class="keywordflow">else</span>
<a name="l01645"></a>01645                                     {
<a name="l01646"></a>01646                                           <span class="keywordflow">if</span> ( action == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a> )
<a name="l01647"></a>01647                                                 <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5562d9bc4815ba4c0d02e60463ca48fa">lastFlankLeft</a> = TRUE;
<a name="l01648"></a>01648                                           <span class="keywordflow">else</span>
<a name="l01649"></a>01649                                                 <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5562d9bc4815ba4c0d02e60463ca48fa">lastFlankLeft</a> = FALSE;
<a name="l01650"></a>01650                                           
<a name="l01651"></a>01651                                           <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4b05ad0162c2ca209e5a51fdbf9c4cde">lastFlankSpot</a> != sNoiseGridNo)
<a name="l01652"></a>01652                                                 <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> = 0;
<a name="l01653"></a>01653                                           
<a name="l01654"></a>01654                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e2645c74e19c721ccca934e1f73ab1d0">origDir</a> = <a class="code" href="Soldier_01Control_8cpp.html#1d7b6c103ede7e551e76eef2ef173f9b">GetDirectionFromGridNo</a> ( sNoiseGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01655"></a>01655                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4b05ad0162c2ca209e5a51fdbf9c4cde">lastFlankSpot</a> = sNoiseGridNo;
<a name="l01656"></a>01656                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a>++;
<a name="l01657"></a>01657                                           <span class="keywordflow">return</span>(action);
<a name="l01658"></a>01658                                     }
<a name="l01659"></a>01659                               }
<a name="l01660"></a>01660                               <span class="keywordflow">else</span>
<a name="l01661"></a>01661                               {
<a name="l01662"></a>01662                                     <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b69da0507d724596d4763a66492e793b7">AI_ACTION_SEEK_NOISE</a>);
<a name="l01663"></a>01663                               }
<a name="l01664"></a>01664 
<a name="l01665"></a>01665                         }
<a name="l01666"></a>01666                   }
<a name="l01667"></a>01667             }
<a name="l01668"></a>01668 
<a name="l01669"></a>01669 <span class="comment"></span>
<a name="l01670"></a>01670 <span class="comment">       ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01671"></a>01671 <span class="comment"></span>       <span class="comment">// SEEK FRIEND WHO LAST RADIOED IN TO REPORT NOISE</span><span class="comment"></span>
<a name="l01672"></a>01672 <span class="comment">       ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01673"></a>01673 <span class="comment"></span>
<a name="l01674"></a>01674        sClosestFriend = <a class="code" href="AIInternals_8h.html#a912803bd2f2f094c178bab0d374120a">ClosestReachableFriendInTrouble</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;fClimb);
<a name="l01675"></a>01675 
<a name="l01676"></a>01676        <span class="comment">// if there is a friend alive &amp; reachable who last radioed in</span>
<a name="l01677"></a>01677        <span class="keywordflow">if</span> (sClosestFriend != NOWHERE)
<a name="l01678"></a>01678             {
<a name="l01679"></a>01679              <span class="comment">// there a chance enemy soldier choose to go "help" his friend</span>
<a name="l01680"></a>01680              iChance = 50 - <a class="code" href="Isometric_01Utils_8cpp.html#94dc29a40d3702f9d4d8ad35dc8e457c">SpacesAway</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>,sClosestFriend);
<a name="l01681"></a>01681              iSneaky = 10;
<a name="l01682"></a>01682 
<a name="l01683"></a>01683              <span class="comment">// set base chance according to orders</span>
<a name="l01684"></a>01684              <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>)
<a name="l01685"></a>01685                   {
<a name="l01686"></a>01686                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>:     iChance += -20;  <span class="keywordflow">break</span>;
<a name="l01687"></a>01687                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>:        iChance += -15;  <span class="keywordflow">break</span>;
<a name="l01688"></a>01688                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffbc5202d0fef4bcd4a4625750d02a724">ONCALL</a>:         iChance +=  20;  <span class="keywordflow">break</span>;
<a name="l01689"></a>01689                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>:    iChance += -10;  <span class="keywordflow">break</span>;
<a name="l01690"></a>01690                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f4f7b012e8cbd1e2cc2b3fa9e1b5c9f9f">RNDPTPATROL</a>:
<a name="l01691"></a>01691                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f7dc5dd2cff7953315a832e7a457deb9d">POINTPATROL</a>:    iChance += -10;  <span class="keywordflow">break</span>;
<a name="l01692"></a>01692                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fddbbeee5695e4be7e9f148315873ce2b">FARPATROL</a>:                       <span class="keywordflow">break</span>;
<a name="l01693"></a>01693                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>:      iChance +=  10;  <span class="keywordflow">break</span>;
<a name="l01694"></a>01694                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a>:             iChance += -10; <span class="keywordflow">break</span>;
<a name="l01695"></a>01695                   }
<a name="l01696"></a>01696 
<a name="l01697"></a>01697              <span class="comment">// modify chance of patrol (and whether it's a sneaky one) by attitude</span>
<a name="l01698"></a>01698              <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>)
<a name="l01699"></a>01699                   {
<a name="l01700"></a>01700                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:      iChance += -10;  iSneaky +=  15;        <span class="keywordflow">break</span>;
<a name="l01701"></a>01701                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:                                              <span class="keywordflow">break</span>;
<a name="l01702"></a>01702                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:       iChance +=  20;  iSneaky += -10;        <span class="keywordflow">break</span>;
<a name="l01703"></a>01703                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:                                 iSneaky +=  30;              <span class="keywordflow">break</span>;
<a name="l01704"></a>01704                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:     iChance +=  20;  iSneaky +=  20;        <span class="keywordflow">break</span>;
<a name="l01705"></a>01705                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:     iChance += -20;  iSneaky += -20;        <span class="keywordflow">break</span>;
<a name="l01706"></a>01706                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>: iChance += -20;  iSneaky += -20;        <span class="keywordflow">break</span>;
<a name="l01707"></a>01707                   }
<a name="l01708"></a>01708 
<a name="l01709"></a>01709              <span class="comment">// reduce chance if breath is down, less likely to wander around when tired</span>
<a name="l01710"></a>01710              iChance -= (100 - <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a>);
<a name="l01711"></a>01711 
<a name="l01712"></a>01712              <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance)
<a name="l01713"></a>01713                   {
<a name="l01714"></a>01714                    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#8058d9871f438da8f6f5ed91da85e559">GoAsFarAsPossibleTowards</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,sClosestFriend,<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b42b12b1204c797182c2f7c35dbf84fc3">AI_ACTION_SEEK_FRIEND</a>);
<a name="l01715"></a>01715 
<a name="l01716"></a>01716                    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l01717"></a>01717                         {
<a name="l01718"></a>01718 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l01719"></a>01719 <span class="preprocessor"></span>                         sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - SEEKING FRIEND at %d, MOVING to %d"</span>,
<a name="l01720"></a>01720                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,sClosestFriend,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l01721"></a>01721                          <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l01722"></a>01722 <span class="preprocessor">      #endif</span>
<a name="l01723"></a>01723 <span class="preprocessor"></span>
<a name="l01724"></a>01724                               <span class="keywordflow">if</span> ( fClimb )<span class="comment">//&amp;&amp; pSoldier-&gt;usActionData == sClosestFriend)</span>
<a name="l01725"></a>01725                               {
<a name="l01726"></a>01726                                     <span class="comment">// need to climb AND have enough APs to get there this turn</span>
<a name="l01727"></a>01727                                     <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fUp = TRUE;
<a name="l01728"></a>01728                                     <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> &gt; 0 )
<a name="l01729"></a>01729                                           fUp = FALSE;
<a name="l01730"></a>01730 
<a name="l01731"></a>01731                                     <span class="keywordflow">if</span> (!fUp)
<a name="l01732"></a>01732                                           DebugMsg ( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a> , DBG_LEVEL_3 , <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Soldier %d is climbing down"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>) );
<a name="l01733"></a>01733 
<a name="l01734"></a>01734                                     <span class="keywordflow">if</span> ( <a class="code" href="ai_8h.html#c0ab3ab9291c1447f10a520aeb33cbd5">CanClimbFromHere</a> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, fUp ) )
<a name="l01735"></a>01735                                     {
<a name="l01736"></a>01736                                           <span class="keywordflow">if</span> (<a class="code" href="ai_8h.html#dd5730a3e85127b7590031d7580277b0">IsActionAffordable</a>(pSoldier) )
<a name="l01737"></a>01737                                           {
<a name="l01738"></a>01738                                                 <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bf0d31a9fac3e900acf35ca5832cd876e">AI_ACTION_CLIMB_ROOF</a> );
<a name="l01739"></a>01739                                           }
<a name="l01740"></a>01740                                     }
<a name="l01741"></a>01741                                     <span class="keywordflow">else</span>
<a name="l01742"></a>01742                                     {
<a name="l01743"></a>01743                                           pSoldier-&gt;usActionData = <a class="code" href="ai_8h.html#c3a9539676bbf7e786da9f3bec8406da">FindClosestClimbPoint</a>(pSoldier-&gt;sGridNo , sClosestFriend , fUp );
<a name="l01744"></a>01744                                           <span class="keywordflow">if</span> ( pSoldier-&gt;usActionData != NOWHERE )
<a name="l01745"></a>01745                                           {
<a name="l01746"></a>01746                                                 <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4ca31547c6e6eeadec11ea94b7a9fd07">AI_ACTION_MOVE_TO_CLIMB</a>  );
<a name="l01747"></a>01747                                           }
<a name="l01748"></a>01748                                     }
<a name="l01749"></a>01749                               }
<a name="l01750"></a>01750 
<a name="l01751"></a>01751                               <span class="comment">//if (fClimb &amp;&amp; pSoldier-&gt;usActionData == sClosestFriend)</span>
<a name="l01752"></a>01752                          <span class="comment">//{</span><span class="comment"></span>
<a name="l01753"></a>01753 <span class="comment">                              //// need to climb AND have enough APs to get there this turn</span>
<a name="l01754"></a>01754 <span class="comment"></span>                              <span class="comment">//return( AI_ACTION_CLIMB_ROOF );</span>
<a name="l01755"></a>01755                          <span class="comment">//}</span>
<a name="l01756"></a>01756 
<a name="l01757"></a>01757                          <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b42b12b1204c797182c2f7c35dbf84fc3">AI_ACTION_SEEK_FRIEND</a>);
<a name="l01758"></a>01758                         }
<a name="l01759"></a>01759                   }
<a name="l01760"></a>01760             }
<a name="l01761"></a>01761 
<a name="l01762"></a>01762 <span class="comment"></span>
<a name="l01763"></a>01763 <span class="comment">       ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01764"></a>01764 <span class="comment"></span>       <span class="comment">// TAKE BEST NEARBY COVER FROM THE NOISE GENERATING GRIDNO</span><span class="comment"></span>
<a name="l01765"></a>01765 <span class="comment">       ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01766"></a>01766 <span class="comment"></span>
<a name="l01767"></a>01767        <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#73a8d5c2a31d1969d497d7daf60b16f3">SkipCoverCheck</a> ) <span class="comment">// &amp;&amp; gfTurnBasedAI) // only do in turnbased</span>
<a name="l01768"></a>01768             {
<a name="l01769"></a>01769              <span class="comment">// remember that noise value is negative, and closer to 0 =&gt; more important!</span>
<a name="l01770"></a>01770              iChance = 25;
<a name="l01771"></a>01771              iSneaky = 30;
<a name="l01772"></a>01772 
<a name="l01773"></a>01773              <span class="comment">// set base chance according to orders</span>
<a name="l01774"></a>01774              <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>)
<a name="l01775"></a>01775                   {
<a name="l01776"></a>01776                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>:     iChance +=  20;  <span class="keywordflow">break</span>;
<a name="l01777"></a>01777                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>:        iChance +=  15;  <span class="keywordflow">break</span>;
<a name="l01778"></a>01778                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffbc5202d0fef4bcd4a4625750d02a724">ONCALL</a>:                          <span class="keywordflow">break</span>;
<a name="l01779"></a>01779                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>:    iChance +=  10;  <span class="keywordflow">break</span>;
<a name="l01780"></a>01780                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f4f7b012e8cbd1e2cc2b3fa9e1b5c9f9f">RNDPTPATROL</a>:
<a name="l01781"></a>01781                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f7dc5dd2cff7953315a832e7a457deb9d">POINTPATROL</a>:                     <span class="keywordflow">break</span>;
<a name="l01782"></a>01782                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fddbbeee5695e4be7e9f148315873ce2b">FARPATROL</a>:      iChance +=  -5;  <span class="keywordflow">break</span>;
<a name="l01783"></a>01783                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>:      iChance += -20;  <span class="keywordflow">break</span>;
<a name="l01784"></a>01784                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a>:             iChance +=  20; <span class="keywordflow">break</span>;
<a name="l01785"></a>01785                   }
<a name="l01786"></a>01786 
<a name="l01787"></a>01787              <span class="comment">// modify chance (and whether it's sneaky) by attitude</span>
<a name="l01788"></a>01788              <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>)
<a name="l01789"></a>01789                   {
<a name="l01790"></a>01790                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:      iChance +=  10;  iSneaky +=  15;  <span class="keywordflow">break</span>;
<a name="l01791"></a>01791                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:      iChance += -15;  iSneaky += -20;  <span class="keywordflow">break</span>;
<a name="l01792"></a>01792                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:       iChance += -20;  iSneaky += -20;  <span class="keywordflow">break</span>;
<a name="l01793"></a>01793                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:    iChance +=  20;  iSneaky +=  30;  <span class="keywordflow">break</span>;
<a name="l01794"></a>01794                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:     iChance +=  15;  iSneaky +=  30;  <span class="keywordflow">break</span>;
<a name="l01795"></a>01795                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:     iChance += -10;  iSneaky += -10;  <span class="keywordflow">break</span>;
<a name="l01796"></a>01796                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>: iChance += -10;  iSneaky += -10;  <span class="keywordflow">break</span>;
<a name="l01797"></a>01797                   }
<a name="l01798"></a>01798 
<a name="l01799"></a>01799 
<a name="l01800"></a>01800             <span class="comment">//Madd: make militia more likely to take cover</span>
<a name="l01801"></a>01801             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == MILITIA_TEAM )
<a name="l01802"></a>01802                   iChance += 20;
<a name="l01803"></a>01803 
<a name="l01804"></a>01804             <span class="comment">// reduce chance if breath is down, less likely to wander around when tired</span>
<a name="l01805"></a>01805              iChance -= (100 - <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a>);
<a name="l01806"></a>01806 
<a name="l01807"></a>01807              <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance)
<a name="l01808"></a>01808                   {
<a name="l01809"></a>01809                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> = <a class="code" href="ai_8h.html#0594cdf20b72e9dc23dbe5ad101e6d64">CalcMorale</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01810"></a>01810                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#0b7c3b2ba83ca87cfa5a3ebc680471a2">FindBestNearbyCover</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a>,&amp;iDummy);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812                         <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l01813"></a>01813                         {
<a name="l01814"></a>01814 <span class="preprocessor">            #ifdef DEBUGDECISIONS</span>
<a name="l01815"></a>01815 <span class="preprocessor"></span>                              sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - TAKING COVER at grid %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l01816"></a>01816                               <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l01817"></a>01817 <span class="preprocessor">            #endif</span>
<a name="l01818"></a>01818 <span class="preprocessor"></span>
<a name="l01819"></a>01819                               <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bd2358f4f3b1cd379c943855df803496d">AI_ACTION_TAKE_COVER</a>);
<a name="l01820"></a>01820                         }
<a name="l01821"></a>01821                   }
<a name="l01822"></a>01822             }
<a name="l01823"></a>01823       }
<a name="l01824"></a>01824 <span class="comment"></span>
<a name="l01825"></a>01825 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01826"></a>01826 <span class="comment"></span> <span class="comment">// SWITCH TO GREEN: determine if soldier acts as if nothing at all was wrong</span><span class="comment"></span>
<a name="l01827"></a>01827 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01828"></a>01828 <span class="comment"></span> <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; 50 )
<a name="l01829"></a>01829   {
<a name="l01830"></a>01830 <span class="preprocessor">#ifdef RECORDNET</span>
<a name="l01831"></a>01831 <span class="preprocessor"></span>   fprintf(NetDebugFile,<span class="stringliteral">"\tDecideActionYellow: guynum %d ignores noise, switching to GREEN AI...\n"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>);
<a name="l01832"></a>01832 <span class="preprocessor">#endif</span>
<a name="l01833"></a>01833 <span class="preprocessor"></span>
<a name="l01834"></a>01834 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l01835"></a>01835 <span class="preprocessor"></span>   <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"ignores noise completely and BYPASSES to GREEN!"</span>,1000);
<a name="l01836"></a>01836 <span class="preprocessor">#endif</span>
<a name="l01837"></a>01837 <span class="preprocessor"></span>
<a name="l01838"></a>01838    <span class="comment">// Skip YELLOW until new situation, 15% extra chance to do GREEN actions</span>
<a name="l01839"></a>01839    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f72e7e4bdc35542eca5402ce5329de32">bBypassToGreen</a> = 15;
<a name="l01840"></a>01840    <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#ace6b78fb0a875c61b79ba65193f0d04">DecideActionGreen</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>));
<a name="l01841"></a>01841   }
<a name="l01842"></a>01842 
<a name="l01843"></a>01843 <span class="comment"></span>
<a name="l01844"></a>01844 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01845"></a>01845 <span class="comment"></span> <span class="comment">// CROUCH IF NOT CROUCHING ALREADY</span><span class="comment"></span>
<a name="l01846"></a>01846 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01847"></a>01847 <span class="comment"></span>
<a name="l01848"></a>01848  <span class="comment">// if not in water and not already crouched, try to crouch down first</span>
<a name="l01849"></a>01849  <span class="keywordflow">if</span> (!fCivilian &amp;&amp; !PTR_CROUCHED &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#419164836f72332cc058fa70ace03b47">IsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_CROUCH ) )
<a name="l01850"></a>01850   {
<a name="l01851"></a>01851 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l01852"></a>01852 <span class="preprocessor"></span>   sprintf((CHAR *)tempstr,<span class="stringliteral">"%s CROUCHES (STATUS YELLOW)"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>);
<a name="l01853"></a>01853    <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l01854"></a>01854 <span class="preprocessor">#endif</span>
<a name="l01855"></a>01855 <span class="preprocessor"></span>
<a name="l01856"></a>01856             <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#69f88541b84e4d9890e0b786199e9a3a">GetAPsToChangeStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_CROUCH ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l01857"></a>01857             {
<a name="l01858"></a>01858                    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_CROUCH;
<a name="l01859"></a>01859                    <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a>);
<a name="l01860"></a>01860             }
<a name="l01861"></a>01861   }
<a name="l01862"></a>01862 
<a name="l01863"></a>01863 <span class="comment"></span>
<a name="l01864"></a>01864 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01865"></a>01865 <span class="comment"></span> <span class="comment">// DO NOTHING: Not enough points left to move, so save them for next turn</span><span class="comment"></span>
<a name="l01866"></a>01866 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01867"></a>01867 <span class="comment"></span>
<a name="l01868"></a>01868 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l01869"></a>01869 <span class="preprocessor"></span> <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"- DOES NOTHING (YELLOW)"</span>,1000);
<a name="l01870"></a>01870 <span class="preprocessor">#endif</span>
<a name="l01871"></a>01871 <span class="preprocessor"></span>
<a name="l01872"></a>01872  <span class="comment">// by default, if everything else fails, just stands in place without turning</span>
<a name="l01873"></a>01873  <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l01874"></a>01874  <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l01875"></a>01875 }
<a name="l01876"></a>01876 
<a name="l01877"></a>01877 
<a name="l01878"></a><a class="code" href="DecideAction_8cpp.html#0a4ddf8062e33366cea57ebbeb597174">01878</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="ai_8h.html#0a4ddf8062e33366cea57ebbeb597174">DecideActionRed</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pSoldier, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubUnconsciousOK)
<a name="l01879"></a>01879 {
<a name="l01880"></a>01880  <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bActionReturned;
<a name="l01881"></a>01881  <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iDummy;
<a name="l01882"></a>01882  <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> iChance,sClosestOpponent,sClosestFriend;
<a name="l01883"></a>01883  <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sClosestDisturbance, sDistVisible, sCheckGridNo;
<a name="l01884"></a>01884  <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubCanMove,ubOpponentDir;
<a name="l01885"></a>01885  <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bInWater, bInDeepWater, bInGas;
<a name="l01886"></a>01886  <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bSeekPts = 0, bHelpPts = 0, bHidePts = 0, bWatchPts = 0;
<a name="l01887"></a>01887  <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bHighestWatchLoc;
<a name="l01888"></a>01888  <a class="code" href="structATTACKTYPE.html">ATTACKTYPE</a> BestThrow, BestShot;
<a name="l01889"></a>01889 <span class="preprocessor">#ifdef AI_TIMING_TEST</span>
<a name="l01890"></a>01890 <span class="preprocessor"></span> <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>     uiStartTime, uiEndTime;
<a name="l01891"></a>01891 <span class="preprocessor"> #endif</span>
<a name="l01892"></a>01892 <span class="preprocessor"></span><span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l01893"></a>01893 <span class="preprocessor"></span>            <a class="code" href="Types_8h.html#94ebfccc6e846c28751f8d616371f1e5">STR16</a> tempstr;
<a name="l01894"></a>01894 <span class="preprocessor">      #endif</span>
<a name="l01895"></a>01895 <span class="preprocessor"></span> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fClimb;
<a name="l01896"></a>01896  <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fCivilian = (PTR_CIVILIAN &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> == <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a078524cb5f7573455bdacd2b87a051da610c97">NON_CIV_GROUP</a> || 
<a name="l01897"></a>01897             (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a> &amp;&amp; <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#879449ac79e1f0135ef15c76469bc7a8">fCivGroupHostile</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a>] == CIV_GROUP_NEUTRAL) || 
<a name="l01898"></a>01898             (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> &gt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a72254b6f06629056dd86be50df5347676">FATCIV</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> &lt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a75db4e8d299d195df30798a12cd332f5a">CRIPPLECIV</a>) ) );
<a name="l01899"></a>01899 
<a name="l01900"></a>01900        DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionRed: soldier orders = %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>));
<a name="l01901"></a>01901 
<a name="l01902"></a>01902  <span class="comment">// if we have absolutely no action points, we can't do a thing under RED!</span>
<a name="l01903"></a>01903  <span class="keywordflow">if</span> (!<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l01904"></a>01904   {
<a name="l01905"></a>01905    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l01906"></a>01906    <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l01907"></a>01907   }
<a name="l01908"></a>01908 
<a name="l01909"></a>01909  <span class="comment">// can this guy move to any of the neighbouring squares ? (sets TRUE/FALSE)</span>
<a name="l01910"></a>01910  ubCanMove = (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt;= <a class="code" href="Points_8cpp.html#2d38f8d23814118ef8a616c4d28c2089">MinPtsToMove</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>));
<a name="l01911"></a>01911 
<a name="l01912"></a>01912  <span class="comment">// if we're an alerted enemy, and there are panic bombs or a trigger around</span>
<a name="l01913"></a>01913  <span class="keywordflow">if</span> ( (!PTR_CIVILIAN || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1b5483f377943cd6d7fb1589d0d391321">WARDEN</a>) &amp;&amp; ( ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bAwareOfOpposition || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> == <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#08542070e86ace3d6254642057e2cf00">ubTheChosenOne</a>) || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1b5483f377943cd6d7fb1589d0d391321">WARDEN</a>) ) &amp;&amp;
<a name="l01914"></a>01914      (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#965c762739e2731d1af1bb56e3485d0f">fPanicFlags</a> &amp; (PANIC_BOMBS_HERE | PANIC_TRIGGERS_HERE ) ) ) )
<a name="l01915"></a>01915   {
<a name="l01916"></a>01916             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1b5483f377943cd6d7fb1589d0d391321">WARDEN</a> &amp;&amp; <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#08542070e86ace3d6254642057e2cf00">ubTheChosenOne</a> == NOBODY )
<a name="l01917"></a>01917             {
<a name="l01918"></a>01918                   <a class="code" href="AIInternals_8h.html#f7541c62911743d05fcf4dc33a7edeed">PossiblyMakeThisEnemyChosenOne</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01919"></a>01919             }
<a name="l01920"></a>01920 
<a name="l01921"></a>01921    <span class="comment">// do some special panic AI decision making</span>
<a name="l01922"></a>01922    bActionReturned = <a class="code" href="ai_8h.html#90183e8d55f1f77dfb8ff60736dc75fb">PanicAI</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,ubCanMove);
<a name="l01923"></a>01923 
<a name="l01924"></a>01924    <span class="comment">// if we decided on an action while in there, we're done</span>
<a name="l01925"></a>01925    <span class="keywordflow">if</span> (bActionReturned != -1)
<a name="l01926"></a>01926      <span class="keywordflow">return</span>(bActionReturned);
<a name="l01927"></a>01927   }
<a name="l01928"></a>01928 
<a name="l01929"></a>01929       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE )
<a name="l01930"></a>01930       {
<a name="l01931"></a>01931             <span class="keywordflow">if</span> ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa158561257be7e2f96f82c0fdb51d7f964">QUEEN</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa192316e5a46397f20e0a7d967488a290a">JOE</a>) &amp;&amp; ubCanMove )
<a name="l01932"></a>01932             {
<a name="l01933"></a>01933                   <span class="keywordflow">if</span> ( <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a> == 3 &amp;&amp; <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a> == MAP_ROW_P &amp;&amp; <a class="code" href="strategicmap_8cpp.html#da715721a8ceedd42acf6ddb33e63ce0">gbWorldSectorZ</a> == 0 &amp;&amp; !<a class="code" href="Strategic_01AI_8cpp.html#8029ae4e0579eaec31822e170536fe40">gfUseAlternateQueenPosition</a> )
<a name="l01934"></a>01934                   {
<a name="l01935"></a>01935                         bActionReturned = <a class="code" href="AIInternals_8h.html#2fdd9d079e86c58e6b202a8a20d68eba">HeadForTheStairCase</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01936"></a>01936                         <span class="keywordflow">if</span> ( bActionReturned != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> )
<a name="l01937"></a>01937                         {
<a name="l01938"></a>01938                               <span class="keywordflow">return</span>( bActionReturned );
<a name="l01939"></a>01939                         }
<a name="l01940"></a>01940                   }
<a name="l01941"></a>01941             }
<a name="l01942"></a>01942       }
<a name="l01943"></a>01943 
<a name="l01944"></a>01944 
<a name="l01945"></a>01945  <span class="comment">// determine if we happen to be in water (in which case we're in BIG trouble!)</span>
<a name="l01946"></a>01946  bInWater = <a class="code" href="worldman_8cpp.html#2307250bab3e458d3dedf063a5ce2433">Water</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> );
<a name="l01947"></a>01947  bInDeepWater = <a class="code" href="worldman_8cpp.html#2307250bab3e458d3dedf063a5ce2433">Water</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> );
<a name="l01948"></a>01948 
<a name="l01949"></a>01949  <span class="comment">// check if standing in tear gas without a gas mask on</span>
<a name="l01950"></a>01950  bInGas = <a class="code" href="AIInternals_8h.html#57193b78fcaf32a2ca34e9e7ec021c1c">InGasOrSmoke</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> );
<a name="l01951"></a>01951 <span class="comment"></span>
<a name="l01952"></a>01952 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01953"></a>01953 <span class="comment"></span> <span class="comment">// WHEN LEFT IN GAS, WEAR GAS MASK IF AVAILABLE AND NOT WORN</span><span class="comment"></span>
<a name="l01954"></a>01954 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01955"></a>01955 <span class="comment"></span>
<a name="l01956"></a>01956       <span class="keywordflow">if</span> ( !bInGas &amp;&amp; (<a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a> == TIXA_SECTOR_X &amp;&amp; <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a> == TIXA_SECTOR_Y) )
<a name="l01957"></a>01957       {
<a name="l01958"></a>01958             <span class="comment">// only chance if we happen to be caught with our gas mask off</span>
<a name="l01959"></a>01959             <span class="keywordflow">if</span> ( <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 10 ) == 0 &amp;&amp; <a class="code" href="ai_8h.html#8c78be5dede6e209cbc4c4df6d9cc99f">WearGasMaskIfAvailable</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l01960"></a>01960             {
<a name="l01961"></a>01961                   <span class="comment">// reevaluate</span>
<a name="l01962"></a>01962                   bInGas = <a class="code" href="AIInternals_8h.html#57193b78fcaf32a2ca34e9e7ec021c1c">InGasOrSmoke</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> );
<a name="l01963"></a>01963             }
<a name="l01964"></a>01964       }
<a name="l01965"></a>01965 <span class="comment"></span>
<a name="l01966"></a>01966 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01967"></a>01967 <span class="comment"></span> <span class="comment">// WHEN IN GAS, GO TO NEAREST REACHABLE SPOT OF UNGASSED LAND</span><span class="comment"></span>
<a name="l01968"></a>01968 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l01969"></a>01969 <span class="comment"></span>
<a name="l01970"></a>01970  <span class="keywordflow">if</span> (bInGas &amp;&amp; ubCanMove)
<a name="l01971"></a>01971   {
<a name="l01972"></a>01972    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#c5f60b8768fb9f3fc244df46e31c1299">FindNearestUngassedLand</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l01973"></a>01973 
<a name="l01974"></a>01974    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l01975"></a>01975     {
<a name="l01976"></a>01976 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l01977"></a>01977 <span class="preprocessor"></span>     sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - SEEKING NEAREST UNGASSED LAND at grid %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l01978"></a>01978      <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l01979"></a>01979 <span class="preprocessor">#endif</span>
<a name="l01980"></a>01980 <span class="preprocessor"></span>
<a name="l01981"></a>01981      <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bbbe6b4d8c4937c66e39880b4df436182">AI_ACTION_LEAVE_WATER_GAS</a>);
<a name="l01982"></a>01982     }
<a name="l01983"></a>01983   }
<a name="l01984"></a>01984 
<a name="l01985"></a>01985       <span class="keywordflow">if</span> ( fCivilian &amp;&amp; !( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> == <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a748505ba252c1ec37e34d882e6f4a3ecf">COW</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> == <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a75db4e8d299d195df30798a12cd332f5a">CRIPPLECIV</a> ) )
<a name="l01986"></a>01986       {
<a name="l01987"></a>01987             <span class="keywordflow">if</span> ( <a class="code" href="Items_8cpp.html#4d7b6f8ecfa44d103eaf0b3e206edba4">FindAIUsableObjClass</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, IC_WEAPON ) == ITEM_NOT_FOUND )
<a name="l01988"></a>01988             {
<a name="l01989"></a>01989                   <span class="comment">// cower in fear!!</span>
<a name="l01990"></a>01990                   <span class="keywordflow">if</span> ( pSoldier-&gt;uiStatusFlags &amp; SOLDIER_COWERING )
<a name="l01991"></a>01991                   {     
<a name="l01992"></a>01992                         <span class="keywordflow">if</span> ( <a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#a921ee4fc79277889d9c1cec0985d3a3">fEnemyInSector</a> ) <span class="comment">// battle!</span>
<a name="l01993"></a>01993                         {
<a name="l01994"></a>01994                               <span class="comment">// in battle!</span>
<a name="l01995"></a>01995                               <span class="keywordflow">if</span> ( pSoldier-&gt;bLastAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b0e1477dcf1592283b53b8027ff3ae20a">AI_ACTION_COWER</a> )
<a name="l01996"></a>01996                               {
<a name="l01997"></a>01997                                     <span class="comment">// do nothing</span>
<a name="l01998"></a>01998                                     pSoldier-&gt;usActionData = NOWHERE;
<a name="l01999"></a>01999                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l02000"></a>02000                               }
<a name="l02001"></a>02001                               <span class="keywordflow">else</span>
<a name="l02002"></a>02002                               {
<a name="l02003"></a>02003                                     <span class="comment">// set up next action to run away</span>
<a name="l02004"></a>02004                                     pSoldier-&gt;usNextActionData = <a class="code" href="ai_8h.html#eb3ffb28e50d84917771661b9d91aa51">FindSpotMaxDistFromOpponents</a>( pSoldier );
<a name="l02005"></a>02005                                     <span class="keywordflow">if</span> ( pSoldier-&gt;usNextActionData != NOWHERE )
<a name="l02006"></a>02006                                     {
<a name="l02007"></a>02007                                           pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950be1338b9c498abc9dd4b86d1b22291b12">AI_ACTION_RUN_AWAY</a>;
<a name="l02008"></a>02008                                           pSoldier-&gt;usActionData = ANIM_STAND;
<a name="l02009"></a>02009                                           <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6f46584addd5e876d03eef0b47c41003">AI_ACTION_STOP_COWERING</a> );
<a name="l02010"></a>02010                                     }
<a name="l02011"></a>02011                                     <span class="keywordflow">else</span>
<a name="l02012"></a>02012                                     {
<a name="l02013"></a>02013                                           <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l02014"></a>02014                                     }
<a name="l02015"></a>02015                               }
<a name="l02016"></a>02016                         }
<a name="l02017"></a>02017                         <span class="keywordflow">else</span>
<a name="l02018"></a>02018                         {
<a name="l02019"></a>02019                               <span class="keywordflow">if</span> ( pSoldier-&gt;bNewSituation == NOT_NEW_SITUATION )
<a name="l02020"></a>02020                               {
<a name="l02021"></a>02021                                     <span class="comment">// stop cowering, not in battle, timer expired</span>
<a name="l02022"></a>02022                                     <span class="comment">// we have to turn off whatever is necessary to stop status red...</span>
<a name="l02023"></a>02023                                     pSoldier-&gt;bAlertStatus = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532f91de342fc2584dd731cfe5d47271c6">STATUS_GREEN</a>;
<a name="l02024"></a>02024                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6f46584addd5e876d03eef0b47c41003">AI_ACTION_STOP_COWERING</a> );
<a name="l02025"></a>02025                               }
<a name="l02026"></a>02026                               <span class="keywordflow">else</span>
<a name="l02027"></a>02027                               {
<a name="l02028"></a>02028                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l02029"></a>02029                               }
<a name="l02030"></a>02030                         }
<a name="l02031"></a>02031                   }
<a name="l02032"></a>02032                   <span class="keywordflow">else</span>
<a name="l02033"></a>02033                   {
<a name="l02034"></a>02034                         <span class="keywordflow">if</span> ( <a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#a921ee4fc79277889d9c1cec0985d3a3">fEnemyInSector</a> )
<a name="l02035"></a>02035                         {
<a name="l02036"></a>02036                               <span class="comment">// battle - cower!!!</span>
<a name="l02037"></a>02037                               pSoldier-&gt;usActionData = ANIM_CROUCH;
<a name="l02038"></a>02038                               <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b0e1477dcf1592283b53b8027ff3ae20a">AI_ACTION_COWER</a> );
<a name="l02039"></a>02039                         }
<a name="l02040"></a>02040                         <span class="keywordflow">else</span> <span class="comment">// not in battle, cower for a certain length of time</span>
<a name="l02041"></a>02041                         {
<a name="l02042"></a>02042                               pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a>;
<a name="l02043"></a>02043                               pSoldier-&gt;usNextActionData = (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) REALTIME_CIV_AI_DELAY;
<a name="l02044"></a>02044                               pSoldier-&gt;usActionData = ANIM_CROUCH;
<a name="l02045"></a>02045                               <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b0e1477dcf1592283b53b8027ff3ae20a">AI_ACTION_COWER</a> );                            
<a name="l02046"></a>02046                         }
<a name="l02047"></a>02047                   }
<a name="l02048"></a>02048             }
<a name="l02049"></a>02049       }
<a name="l02050"></a>02050 
<a name="l02051"></a>02051 
<a name="l02052"></a>02052       <span class="keywordflow">if</span> ( fCivilian &amp;&amp; !( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> == <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a748505ba252c1ec37e34d882e6f4a3ecf">COW</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> == <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a75db4e8d299d195df30798a12cd332f5a">CRIPPLECIV</a> ) )
<a name="l02053"></a>02053       {
<a name="l02054"></a>02054             <span class="keywordflow">if</span> ( <a class="code" href="Items_8cpp.html#4d7b6f8ecfa44d103eaf0b3e206edba4">FindAIUsableObjClass</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, IC_WEAPON ) == ITEM_NOT_FOUND )
<a name="l02055"></a>02055             {
<a name="l02056"></a>02056                   <span class="comment">// cower in fear!!</span>
<a name="l02057"></a>02057                   <span class="keywordflow">if</span> ( pSoldier-&gt;uiStatusFlags &amp; SOLDIER_COWERING )
<a name="l02058"></a>02058                   {     
<a name="l02059"></a>02059                         <span class="keywordflow">if</span> ( <a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#a921ee4fc79277889d9c1cec0985d3a3">fEnemyInSector</a> ) <span class="comment">// battle!</span>
<a name="l02060"></a>02060                         {
<a name="l02061"></a>02061                               <span class="comment">// in battle!</span>
<a name="l02062"></a>02062                               <span class="keywordflow">if</span> ( pSoldier-&gt;bLastAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b0e1477dcf1592283b53b8027ff3ae20a">AI_ACTION_COWER</a> )
<a name="l02063"></a>02063                               {
<a name="l02064"></a>02064                                     <span class="comment">// do nothing</span>
<a name="l02065"></a>02065                                     pSoldier-&gt;usActionData = NOWHERE;
<a name="l02066"></a>02066                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l02067"></a>02067                               }
<a name="l02068"></a>02068                               <span class="keywordflow">else</span>
<a name="l02069"></a>02069                               {
<a name="l02070"></a>02070                                     <span class="comment">// set up next action to run away</span>
<a name="l02071"></a>02071                                     pSoldier-&gt;usNextActionData = <a class="code" href="ai_8h.html#eb3ffb28e50d84917771661b9d91aa51">FindSpotMaxDistFromOpponents</a>( pSoldier );
<a name="l02072"></a>02072                                     <span class="keywordflow">if</span> ( pSoldier-&gt;usNextActionData != NOWHERE )
<a name="l02073"></a>02073                                     {
<a name="l02074"></a>02074                                           pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950be1338b9c498abc9dd4b86d1b22291b12">AI_ACTION_RUN_AWAY</a>;
<a name="l02075"></a>02075                                           pSoldier-&gt;usActionData = ANIM_STAND;
<a name="l02076"></a>02076                                           <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6f46584addd5e876d03eef0b47c41003">AI_ACTION_STOP_COWERING</a> );
<a name="l02077"></a>02077                                     }
<a name="l02078"></a>02078                                     <span class="keywordflow">else</span>
<a name="l02079"></a>02079                                     {
<a name="l02080"></a>02080                                           <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l02081"></a>02081                                     }
<a name="l02082"></a>02082                               }
<a name="l02083"></a>02083                         }
<a name="l02084"></a>02084                         <span class="keywordflow">else</span>
<a name="l02085"></a>02085                         {
<a name="l02086"></a>02086                               <span class="keywordflow">if</span> ( pSoldier-&gt;bNewSituation == NOT_NEW_SITUATION )
<a name="l02087"></a>02087                               {
<a name="l02088"></a>02088                                     <span class="comment">// stop cowering, not in battle, timer expired</span>
<a name="l02089"></a>02089                                     <span class="comment">// we have to turn off whatever is necessary to stop status red...</span>
<a name="l02090"></a>02090                                     pSoldier-&gt;bAlertStatus = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532f91de342fc2584dd731cfe5d47271c6">STATUS_GREEN</a>;
<a name="l02091"></a>02091                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6f46584addd5e876d03eef0b47c41003">AI_ACTION_STOP_COWERING</a> );
<a name="l02092"></a>02092                               }
<a name="l02093"></a>02093                               <span class="keywordflow">else</span>
<a name="l02094"></a>02094                               {
<a name="l02095"></a>02095                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l02096"></a>02096                               }
<a name="l02097"></a>02097                         }
<a name="l02098"></a>02098                   }
<a name="l02099"></a>02099                   <span class="keywordflow">else</span>
<a name="l02100"></a>02100                   {
<a name="l02101"></a>02101                         <span class="keywordflow">if</span> ( <a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#a921ee4fc79277889d9c1cec0985d3a3">fEnemyInSector</a> )
<a name="l02102"></a>02102                         {
<a name="l02103"></a>02103                               <span class="comment">// battle - cower!!!</span>
<a name="l02104"></a>02104                               pSoldier-&gt;usActionData = ANIM_CROUCH;
<a name="l02105"></a>02105                               <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b0e1477dcf1592283b53b8027ff3ae20a">AI_ACTION_COWER</a> );
<a name="l02106"></a>02106                         }
<a name="l02107"></a>02107                         <span class="keywordflow">else</span> <span class="comment">// not in battle, cower for a certain length of time</span>
<a name="l02108"></a>02108                         {
<a name="l02109"></a>02109                               pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a>;
<a name="l02110"></a>02110                               pSoldier-&gt;usNextActionData = (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) REALTIME_CIV_AI_DELAY;
<a name="l02111"></a>02111                               pSoldier-&gt;usActionData = ANIM_CROUCH;
<a name="l02112"></a>02112                               <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b0e1477dcf1592283b53b8027ff3ae20a">AI_ACTION_COWER</a> );                            
<a name="l02113"></a>02113                         }
<a name="l02114"></a>02114                   }
<a name="l02115"></a>02115             }
<a name="l02116"></a>02116       }
<a name="l02117"></a>02117 <span class="comment"></span>
<a name="l02118"></a>02118 <span class="comment"> ////////////////////////////////////////////////////////////////////////</span>
<a name="l02119"></a>02119 <span class="comment"></span> <span class="comment">// IF POSSIBLE, FIRE LONG RANGE WEAPONS AT TARGETS REPORTED BY RADIO</span><span class="comment"></span>
<a name="l02120"></a>02120 <span class="comment"> ////////////////////////////////////////////////////////////////////////</span>
<a name="l02121"></a>02121 <span class="comment"></span>
<a name="l02122"></a>02122       <span class="comment">// can't do this in realtime, because the player could be shooting a gun or whatever at the same time!</span>
<a name="l02123"></a>02123  <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> &amp;&amp; !fCivilian &amp;&amp; !bInWater &amp;&amp; !bInGas &amp;&amp; !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_BOXER) &amp;&amp; (<a class="code" href="AIInternals_8h.html#4a6dd2f3caa0b4f6caa74acd5ac465cd">CanNPCAttack</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>) == TRUE))
<a name="l02124"></a>02124   {
<a name="l02125"></a>02125    BestThrow.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a> = FALSE;    <span class="comment">// by default, assume Throwing isn't possible</span>
<a name="l02126"></a>02126 
<a name="l02127"></a>02127 
<a name="l02128"></a>02128    <a class="code" href="AIInternals_8h.html#63160d71d4c4fd2abcaf1e0596bf555d">CheckIfTossPossible</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,&amp;BestThrow);
<a name="l02129"></a>02129 
<a name="l02130"></a>02130    <span class="keywordflow">if</span> (BestThrow.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a>)
<a name="l02131"></a>02131     {
<a name="l02132"></a>02132                   <span class="comment">// if firing mortar make sure we have room</span>
<a name="l02133"></a>02133                   <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ BestThrow.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> ].usItem].mortar )
<a name="l02134"></a>02134                   {
<a name="l02135"></a>02135                         ubOpponentDir = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="Soldier_01Control_8cpp.html#1d7b6c103ede7e551e76eef2ef173f9b">GetDirectionFromGridNo</a>( BestThrow.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l02136"></a>02136 
<a name="l02137"></a>02137                         <span class="comment">// Get new gridno!</span>
<a name="l02138"></a>02138                         sCheckGridNo = <a class="code" href="Isometric_01Utils_8cpp.html#318d8410127e29bb232ab70363bc316e">NewGridNo</a>( (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( ubOpponentDir ) );
<a name="l02139"></a>02139 
<a name="l02140"></a>02140                         <span class="keywordflow">if</span> ( !<a class="code" href="Soldier_01Ani_8cpp.html#52dee080c40e99d978e145a7fd2f3a67">OKFallDirection</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sCheckGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, ubOpponentDir, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ) )
<a name="l02141"></a>02141                         {
<a name="l02142"></a>02142                               <span class="comment">// can't fire!</span>
<a name="l02143"></a>02143                               BestThrow.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a> = FALSE;
<a name="l02144"></a>02144 
<a name="l02145"></a>02145                               <span class="comment">// try behind us, see if there's room to move back          </span>
<a name="l02146"></a>02146                               sCheckGridNo = <a class="code" href="Isometric_01Utils_8cpp.html#318d8410127e29bb232ab70363bc316e">NewGridNo</a>( (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( <a class="code" href="Isometric_01Utils_8cpp.html#9591ab6c902758a420fd3d9f4e49ba2e">gOppositeDirection</a>[ ubOpponentDir ] ) );
<a name="l02147"></a>02147                               <span class="keywordflow">if</span> ( <a class="code" href="Soldier_01Ani_8cpp.html#52dee080c40e99d978e145a7fd2f3a67">OKFallDirection</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sCheckGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, <a class="code" href="Isometric_01Utils_8cpp.html#9591ab6c902758a420fd3d9f4e49ba2e">gOppositeDirection</a>[ ubOpponentDir ], <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ) )
<a name="l02148"></a>02148                               {
<a name="l02149"></a>02149                                <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = sCheckGridNo;
<a name="l02150"></a>02150 
<a name="l02151"></a>02151                                <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bedcd6be18202cbd0df633b0017f571f1">AI_ACTION_GET_CLOSER</a> );
<a name="l02152"></a>02152                               }
<a name="l02153"></a>02153                         }
<a name="l02154"></a>02154                   }
<a name="l02155"></a>02155 
<a name="l02156"></a>02156      <span class="comment">// then do it!  The functions have already made sure that we have a</span>
<a name="l02157"></a>02157      <span class="comment">// pair of worthy opponents, etc., so we're not just wasting our time</span>
<a name="l02158"></a>02158 
<a name="l02159"></a>02159      <span class="comment">// if necessary, swap the usItem from holster into the hand position</span>
<a name="l02160"></a>02160        DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: if necessary, swap the usItem from holster into the hand position"</span>);
<a name="l02161"></a>02161      <span class="keywordflow">if</span> (BestThrow.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> != <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>)
<a name="l02162"></a>02162        <a class="code" href="AIInternals_8h.html#8d7f0222069571f630a99342fa534afe">RearrangePocket</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>,BestThrow.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>,FOREVER);
<a name="l02163"></a>02163 
<a name="l02164"></a>02164      pSoldier-&gt;usActionData = BestThrow.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>;
<a name="l02165"></a>02165      pSoldier-&gt;bAimTime             = BestThrow.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a>;
<a name="l02166"></a>02166 
<a name="l02167"></a>02167      <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b260e54a79dd8e6db573a8216c3a63efc">AI_ACTION_TOSS_PROJECTILE</a>);
<a name="l02168"></a>02168     }
<a name="l02169"></a>02169    <span class="keywordflow">else</span>           <span class="comment">// toss/throw/launch not possible</span>
<a name="l02170"></a>02170     {
<a name="l02171"></a>02171      <span class="comment">// if this dude has a longe-range weapon on him (longer than normal</span>
<a name="l02172"></a>02172      <span class="comment">// sight range), and there's at least one other team-mate around, and</span>
<a name="l02173"></a>02173      <span class="comment">// spotters haven't already been called for, then DO SO!</span>
<a name="l02174"></a>02174  
<a name="l02175"></a>02175      <span class="keywordflow">if</span> ( ( <a class="code" href="Weapons_8cpp.html#ef0287fd6ecfdbdbc5242023c958da1c">CalcMaxTossRange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[BestThrow.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>].usItem, TRUE ) &gt; <a class="code" href="opplist_8cpp.html#ce89c9f1017d9a6e473df03acb6f1a2a">MaxDistanceVisible</a>() ) &amp;&amp;
<a name="l02176"></a>02176                          (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bMenInSector &gt; 1) &amp;&amp;
<a name="l02177"></a>02177                          (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#0d06ef8dafb831a45e5caa0c61c6d76b">ubSpottersCalledForBy</a> == NOBODY))
<a name="l02178"></a>02178       {
<a name="l02179"></a>02179        <span class="comment">// then call for spotters!  Uses up the rest of his turn (whatever</span>
<a name="l02180"></a>02180        <span class="comment">// that may be), but from now on, BLACK AI NPC may radio sightings!</span>
<a name="l02181"></a>02181        <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#0d06ef8dafb831a45e5caa0c61c6d76b">ubSpottersCalledForBy</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>;
<a name="l02182"></a>02182        <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> = 0;
<a name="l02183"></a>02183 
<a name="l02184"></a>02184 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l02185"></a>02185 <span class="preprocessor"></span>       <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"calls for spotters!"</span>,1000);
<a name="l02186"></a>02186 <span class="preprocessor">#endif</span>
<a name="l02187"></a>02187 <span class="preprocessor"></span>
<a name="l02188"></a>02188        <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l02189"></a>02189        <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l02190"></a>02190       }
<a name="l02191"></a>02191     }
<a name="l02192"></a>02192 
<a name="l02193"></a>02193 
<a name="l02194"></a>02194 
<a name="l02195"></a>02195 
<a name="l02196"></a>02196       <span class="comment">// SNIPER!</span>
<a name="l02197"></a>02197       <a class="code" href="AIInternals_8h.html#eabb22bb7b2b8a77a788a7a52bc08d2a">CheckIfShotPossible</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,&amp;BestShot,FALSE);
<a name="l02198"></a>02198       DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"decideactionred: is sniper shot possible? = %d, CTH = %d"</span>,BestShot.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a>,BestShot.<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a>));
<a name="l02199"></a>02199 
<a name="l02200"></a>02200    <span class="keywordflow">if</span> (BestShot.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a> &amp;&amp; BestShot.<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a> &gt; 50 )
<a name="l02201"></a>02201     {
<a name="l02202"></a>02202      <span class="comment">// then do it!  The functions have already made sure that we have a</span>
<a name="l02203"></a>02203      <span class="comment">// pair of worthy opponents, etc., so we're not just wasting our time</span>
<a name="l02204"></a>02204 
<a name="l02205"></a>02205      <span class="comment">// if necessary, swap the usItem from holster into the hand position</span>
<a name="l02206"></a>02206        DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: sniper shot possible!"</span>);
<a name="l02207"></a>02207      <span class="keywordflow">if</span> (BestShot.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> != <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>)
<a name="l02208"></a>02208        <a class="code" href="AIInternals_8h.html#8d7f0222069571f630a99342fa534afe">RearrangePocket</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>,BestShot.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>,FOREVER);
<a name="l02209"></a>02209 
<a name="l02210"></a>02210      pSoldier-&gt;usActionData = BestShot.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>;
<a name="l02211"></a>02211      pSoldier-&gt;bAimTime             = BestShot.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a>;
<a name="l02212"></a>02212        <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, L<span class="stringliteral">"Sniper!"</span> );
<a name="l02213"></a>02213      <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6247fbdbad71e877e20dc79b610060b8">AI_ACTION_FIRE_GUN</a> );
<a name="l02214"></a>02214     }
<a name="l02215"></a>02215    <span class="keywordflow">else</span>           <span class="comment">// snipe not possible</span>
<a name="l02216"></a>02216     {
<a name="l02217"></a>02217      <span class="comment">// if this dude has a longe-range weapon on him (longer than normal</span>
<a name="l02218"></a>02218      <span class="comment">// sight range), and there's at least one other team-mate around, and</span>
<a name="l02219"></a>02219      <span class="comment">// spotters haven't already been called for, then DO SO!</span>
<a name="l02220"></a>02220  
<a name="l02221"></a>02221              DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: sniper shot not possible"</span>);
<a name="l02222"></a>02222             DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"decideactionred: weapon in slot #%d"</span>,BestShot.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>));
<a name="l02223"></a>02223             <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> * gun = &amp;<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[BestShot.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>];
<a name="l02224"></a>02224             DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"decideactionred: men in sector %d, ubspotters called by %d, nobody %d"</span>,<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bMenInSector,<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#0d06ef8dafb831a45e5caa0c61c6d76b">ubSpottersCalledForBy</a>,NOBODY ));
<a name="l02225"></a>02225             <span class="keywordflow">if</span> ( ( ( <a class="code" href="Items_8cpp.html#b7014ddea7d8c7348c7a0bad7e707152">IsScoped</a>(gun) &amp;&amp; <a class="code" href="Weapons_8cpp.html#b73cec2c5b3b1f683e559be52c8fa535">GunRange</a>(gun) &gt; 30 ) || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> ) &amp;&amp;
<a name="l02226"></a>02226                          (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bMenInSector &gt; 1) &amp;&amp;
<a name="l02227"></a>02227                          (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#0d06ef8dafb831a45e5caa0c61c6d76b">ubSpottersCalledForBy</a> == NOBODY))
<a name="l02228"></a>02228 
<a name="l02229"></a>02229             {
<a name="l02230"></a>02230              <span class="comment">// then call for spotters!  Uses up the rest of his turn (whatever</span>
<a name="l02231"></a>02231                <span class="comment">// that may be), but from now on, BLACK AI NPC may radio sightings!</span>
<a name="l02232"></a>02232                   <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#0d06ef8dafb831a45e5caa0c61c6d76b">ubSpottersCalledForBy</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>;
<a name="l02233"></a>02233                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> = 0;
<a name="l02234"></a>02234 
<a name="l02235"></a>02235                   DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: calling for sniper spotters"</span>);
<a name="l02236"></a>02236 
<a name="l02237"></a>02237                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l02238"></a>02238                   <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l02239"></a>02239             }
<a name="l02240"></a>02240     }
<a name="l02241"></a>02241 
<a name="l02242"></a>02242       <span class="comment">//SUPPRESSION FIRE</span>
<a name="l02243"></a>02243 
<a name="l02244"></a>02244       <a class="code" href="AIInternals_8h.html#eabb22bb7b2b8a77a788a7a52bc08d2a">CheckIfShotPossible</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,&amp;BestShot,TRUE);
<a name="l02245"></a>02245 
<a name="l02246"></a>02246       <span class="comment">//must have a small chance to hit and the opponent must be on the ground (can't suppress guys on the roof)</span>
<a name="l02247"></a>02247    <span class="keywordflow">if</span> ( BestShot.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a> &amp;&amp; BestShot.<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a> &lt; 50 &amp;&amp; <a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[BestShot.<a class="code" href="structATTACKTYPE.html#4a3c834866b912b3fa371ac855e7be42">ubOpponent</a>].bLevel == 0 &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> != <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> )
<a name="l02248"></a>02248     {
<a name="l02249"></a>02249      <span class="comment">// then do it!  </span>
<a name="l02250"></a>02250 
<a name="l02251"></a>02251            <span class="comment">// if necessary, swap the usItem from holster into the hand position</span>
<a name="l02252"></a>02252              DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: suppression fire possible!"</span>);
<a name="l02253"></a>02253 
<a name="l02254"></a>02254                   <span class="keywordflow">if</span> (BestShot.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> != <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>)
<a name="l02255"></a>02255                         <a class="code" href="AIInternals_8h.html#8d7f0222069571f630a99342fa534afe">RearrangePocket</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>,BestShot.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>,FOREVER);
<a name="l02256"></a>02256        
<a name="l02257"></a>02257                   pSoldier-&gt;usActionData = BestShot.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>;
<a name="l02258"></a>02258                   <span class="comment">//pSoldier-&gt;bAimTime                = BestShot.ubAimTime;</span>
<a name="l02259"></a>02259                   <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubBurstAPs = 0;
<a name="l02260"></a>02260 
<a name="l02261"></a>02261                   pSoldier-&gt;bDoAutofire = 0;
<a name="l02262"></a>02262                   <span class="keywordflow">do</span>
<a name="l02263"></a>02263                   {
<a name="l02264"></a>02264                         pSoldier-&gt;bDoAutofire++;
<a name="l02265"></a>02265                         ubBurstAPs = <a class="code" href="Points_8cpp.html#5c543e8467258f9559f37c5380130c05">CalcAPsToAutofire</a>( <a class="code" href="Soldier_01Control_8cpp.html#567738f5c11e8c81fa661e6aff177224">CalcActionPoints</a>( pSoldier ), &amp;(pSoldier-&gt;inv[BestShot.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>]), pSoldier-&gt;bDoAutofire );
<a name="l02266"></a>02266                   }
<a name="l02267"></a>02267                   <span class="keywordflow">while</span>(      pSoldier-&gt;bActionPoints - (BestShot.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> - BestShot.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a>) &gt; ubBurstAPs &amp;&amp;
<a name="l02268"></a>02268                               pSoldier-&gt;inv[ pSoldier-&gt;ubAttackingHand ].ubGunShotsLeft &gt;= pSoldier-&gt;bDoAutofire &amp;&amp;
<a name="l02269"></a>02269                               <a class="code" href="Weapons_8cpp.html#96fc5621e834538c05f285ebcedebdaf">GetAutoPenalty</a>(&amp;pSoldier-&gt;inv[ pSoldier-&gt;ubAttackingHand ], <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ pSoldier-&gt;usAnimState ].<a class="code" href="structANIMCONTROLTYPE.html#fccdca6006bf66a4193a83b4f87dec10">ubEndHeight</a> == ANIM_PRONE)*pSoldier-&gt;bDoAutofire &lt;= 80 ); 
<a name="l02270"></a>02270                         
<a name="l02271"></a>02271                         
<a name="l02272"></a>02272                   pSoldier-&gt;bDoAutofire--;
<a name="l02273"></a>02273                   ubBurstAPs = <a class="code" href="Points_8cpp.html#5c543e8467258f9559f37c5380130c05">CalcAPsToAutofire</a>( <a class="code" href="Soldier_01Control_8cpp.html#567738f5c11e8c81fa661e6aff177224">CalcActionPoints</a>( pSoldier ), &amp;(pSoldier-&gt;inv[BestShot.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>]), pSoldier-&gt;bDoAutofire );
<a name="l02274"></a>02274 
<a name="l02275"></a>02275                   <span class="comment">// minimum 10 bullets</span>
<a name="l02276"></a>02276                   <span class="keywordflow">if</span> (pSoldier-&gt;bDoAutofire &gt;= 10 &amp;&amp;  pSoldier-&gt;bActionPoints - (BestShot.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> - BestShot.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a>) &gt;= ubBurstAPs )
<a name="l02277"></a>02277                   {
<a name="l02278"></a>02278                         pSoldier-&gt;bAimTime                  = 0;
<a name="l02279"></a>02279                         pSoldier-&gt;bDoBurst                  = 1;
<a name="l02280"></a>02280 
<a name="l02281"></a>02281                         <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, L<span class="stringliteral">"Suppression Fire!"</span> );
<a name="l02282"></a>02282                         <a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[BestShot.<a class="code" href="structATTACKTYPE.html#4a3c834866b912b3fa371ac855e7be42">ubOpponent</a>].<a class="code" href="structSOLDIERTYPE.html#84aa80442363abdeaacbb69cfc9558d9">ubSuppressionPoints</a> += pSoldier-&gt;bDoAutofire;
<a name="l02283"></a>02283                         <a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[BestShot.<a class="code" href="structATTACKTYPE.html#4a3c834866b912b3fa371ac855e7be42">ubOpponent</a>].<a class="code" href="structSOLDIERTYPE.html#6e5902fd9b458a232090bcb124cea3ac">ubSuppressorID</a> = pSoldier-&gt;ubID;
<a name="l02284"></a>02284                         <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6247fbdbad71e877e20dc79b610060b8">AI_ACTION_FIRE_GUN</a> );
<a name="l02285"></a>02285                   }
<a name="l02286"></a>02286                   <span class="keywordflow">else</span>
<a name="l02287"></a>02287                   {
<a name="l02288"></a>02288                         pSoldier-&gt;bAimTime                  = 0;
<a name="l02289"></a>02289                         pSoldier-&gt;bDoBurst                  = 0;
<a name="l02290"></a>02290                         pSoldier-&gt;bDoAutofire         = 0;
<a name="l02291"></a>02291                         <span class="comment">// not enough aps - do somthing else</span>
<a name="l02292"></a>02292                   }
<a name="l02293"></a>02293       }
<a name="l02294"></a>02294       <span class="comment">// suppression not possible, do something else</span>
<a name="l02295"></a>02295  }
<a name="l02296"></a>02296 <span class="comment">/*</span>
<a name="l02297"></a>02297 <span class="comment">// CALL IN AIR STRIKE &amp; RADIO RED ALERT</span>
<a name="l02298"></a>02298 <span class="comment">if ( !fCivilian &amp;&amp; pSoldier-&gt;bTeam != MILITIA_TEAM &amp;&amp; gGameOptions.fAirStrikes &amp;&amp; airstrikeavailable &amp;&amp; (pSoldier-&gt;bActionPoints &gt;= AP_RADIO) &amp;&amp; !WillAirRaidBeStopped(pSoldier-&gt;sSectorX,pSoldier-&gt;sSectorY))</span>
<a name="l02299"></a>02299 <span class="comment">  {</span>
<a name="l02300"></a>02300 <span class="comment"></span>
<a name="l02301"></a>02301 <span class="comment">      DebugMsg (TOPIC_JA2,DBG_LEVEL_3,"decideactionred: checking to call in an air strike");</span>
<a name="l02302"></a>02302 <span class="comment"></span>
<a name="l02303"></a>02303 <span class="comment">      iChance = Random(50);</span>
<a name="l02304"></a>02304 <span class="comment">   // if I ain't swimming (deep water)</span>
<a name="l02305"></a>02305 <span class="comment">   if ( !bInDeepWater )</span>
<a name="l02306"></a>02306 <span class="comment">    {</span>
<a name="l02307"></a>02307 <span class="comment">     // modify base chance according to orders</span>
<a name="l02308"></a>02308 <span class="comment">     switch (pSoldier-&gt;bOrders)</span>
<a name="l02309"></a>02309 <span class="comment">      {</span>
<a name="l02310"></a>02310 <span class="comment">       case STATIONARY:       iChance +=  20;  break;</span>
<a name="l02311"></a>02311 <span class="comment">       case ONGUARD:          iChance +=  15;  break;</span>
<a name="l02312"></a>02312 <span class="comment">       case ONCALL:           iChance +=  10;  break;</span>
<a name="l02313"></a>02313 <span class="comment">       case CLOSEPATROL:                       break;</span>
<a name="l02314"></a>02314 <span class="comment">                   case RNDPTPATROL:</span>
<a name="l02315"></a>02315 <span class="comment">       case POINTPATROL:      iChance +=  -5;  break;</span>
<a name="l02316"></a>02316 <span class="comment">       case FARPATROL:        iChance += -10;  break;</span>
<a name="l02317"></a>02317 <span class="comment">       case SEEKENEMY:        iChance += -20;  break;</span>
<a name="l02318"></a>02318 <span class="comment">      }</span>
<a name="l02319"></a>02319 <span class="comment"></span>
<a name="l02320"></a>02320 <span class="comment">     // modify base chance according to attitude</span>
<a name="l02321"></a>02321 <span class="comment">     switch (pSoldier-&gt;bAttitude)</span>
<a name="l02322"></a>02322 <span class="comment">      {</span>
<a name="l02323"></a>02323 <span class="comment">                  case DEFENSIVE:        iChance +=  20;  break;</span>
<a name="l02324"></a>02324 <span class="comment">                  case BRAVESOLO:        iChance += -10;  break;</span>
<a name="l02325"></a>02325 <span class="comment">                  case BRAVEAID:                          break;</span>
<a name="l02326"></a>02326 <span class="comment">                  case CUNNINGSOLO:      iChance +=  -5;  break;</span>
<a name="l02327"></a>02327 <span class="comment">                  case CUNNINGAID:                        break;</span>
<a name="l02328"></a>02328 <span class="comment">                  case AGGRESSIVE:       iChance += -20;  break;</span>
<a name="l02329"></a>02329 <span class="comment">                  case ATTACKSLAYONLY:          iChance = 0;</span>
<a name="l02330"></a>02330 <span class="comment">      }</span>
<a name="l02331"></a>02331 <span class="comment"></span>
<a name="l02332"></a>02332 <span class="comment">            // modify base chance according to morale</span>
<a name="l02333"></a>02333 <span class="comment">            switch (pSoldier-&gt;bAIMorale)</span>
<a name="l02334"></a>02334 <span class="comment">            {</span>
<a name="l02335"></a>02335 <span class="comment">                  case MORALE_HOPELESS:  iChance *= 3;    break;</span>
<a name="l02336"></a>02336 <span class="comment">                  case MORALE_WORRIED:   iChance *= 2;    break;</span>
<a name="l02337"></a>02337 <span class="comment">                  case MORALE_NORMAL:                     break;</span>
<a name="l02338"></a>02338 <span class="comment">                  case MORALE_CONFIDENT: iChance /= 2;    break;</span>
<a name="l02339"></a>02339 <span class="comment">                  case MORALE_FEARLESS:  iChance /= 3;    break;</span>
<a name="l02340"></a>02340 <span class="comment">            }</span>
<a name="l02341"></a>02341 <span class="comment"></span>
<a name="l02342"></a>02342 <span class="comment">     if ((INT16) Random(100) &lt; iChance)</span>
<a name="l02343"></a>02343 <span class="comment">      {</span>
<a name="l02344"></a>02344 <span class="comment">            DebugMsg (TOPIC_JA2,DBG_LEVEL_3,"decideactionred: decided to call in an air strike!");</span>
<a name="l02345"></a>02345 <span class="comment">            SayQuoteFromAnyBodyInSector( QUOTE_WEARY_SLASH_SUSPUCIOUS );</span>
<a name="l02346"></a>02346 <span class="comment">            EnemyCallInAirStrike ( pSoldier-&gt;sSectorX, pSoldier-&gt;sSectorY );</span>
<a name="l02347"></a>02347 <span class="comment">            airstrikeavailable = FALSE;</span>
<a name="l02348"></a>02348 <span class="comment"></span>
<a name="l02349"></a>02349 <span class="comment">            return(AI_ACTION_RED_ALERT);</span>
<a name="l02350"></a>02350 <span class="comment">      }</span>
<a name="l02351"></a>02351 <span class="comment">    }</span>
<a name="l02352"></a>02352 <span class="comment">  }</span>
<a name="l02353"></a>02353 <span class="comment">*/</span>
<a name="l02354"></a>02354 <span class="comment"></span>
<a name="l02355"></a>02355 <span class="comment">  ////////////////////////////////////////////////////////////////////////////</span>
<a name="l02356"></a>02356 <span class="comment"></span>  <span class="comment">// WHEN IN THE LIGHT, GET OUT OF THERE!</span><span class="comment"></span>
<a name="l02357"></a>02357 <span class="comment">  ////////////////////////////////////////////////////////////////////////////</span>
<a name="l02358"></a>02358 <span class="comment"></span>  <span class="keywordflow">if</span> ( ubCanMove &amp;&amp; <a class="code" href="AIInternals_8h.html#7e5d67ae058fd30113eb7f61d607b702">InLightAtNight</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> ) &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> != <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a> )
<a name="l02359"></a>02359       {
<a name="l02360"></a>02360             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#d4ccb36e0162d3548bec3e3e6e8c0b1f">FindNearbyDarkerSpot</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l02361"></a>02361             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE )
<a name="l02362"></a>02362             {
<a name="l02363"></a>02363                   <span class="comment">// move as if leaving water or gas</span>
<a name="l02364"></a>02364                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bbbe6b4d8c4937c66e39880b4df436182">AI_ACTION_LEAVE_WATER_GAS</a> );
<a name="l02365"></a>02365             }
<a name="l02366"></a>02366       }
<a name="l02367"></a>02367 
<a name="l02368"></a>02368 DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: crouch and rest if running out of breath"</span>);<span class="comment"></span>
<a name="l02369"></a>02369 <span class="comment"> ////////////////////////////////////////////////////////////////////////</span>
<a name="l02370"></a>02370 <span class="comment"></span> <span class="comment">// CROUCH &amp; REST IF RUNNING OUT OF BREATH</span><span class="comment"></span>
<a name="l02371"></a>02371 <span class="comment"> ////////////////////////////////////////////////////////////////////////</span>
<a name="l02372"></a>02372 <span class="comment"></span>
<a name="l02373"></a>02373  <span class="comment">// if our breath is running a bit low, and we're not in water or under fire</span>
<a name="l02374"></a>02374  <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a> &lt; 25) &amp;&amp; !bInWater &amp;&amp; !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4d7d451394eccbed289b3276bc325722">bUnderFire</a>)
<a name="l02375"></a>02375   {
<a name="l02376"></a>02376    <span class="comment">// if not already crouched, try to crouch down first</span>
<a name="l02377"></a>02377    <span class="keywordflow">if</span> (!fCivilian &amp;&amp; !PTR_CROUCHED &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#419164836f72332cc058fa70ace03b47">IsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_CROUCH ) &amp;&amp; <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubHeight != ANIM_PRONE)
<a name="l02378"></a>02378     {
<a name="l02379"></a>02379 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l02380"></a>02380 <span class="preprocessor"></span>     sprintf((CHAR *)tempstr,<span class="stringliteral">"%s CROUCHES, NEEDING REST (STATUS RED), breath = %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a>);
<a name="l02381"></a>02381      <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l02382"></a>02382 <span class="preprocessor">#endif</span>
<a name="l02383"></a>02383 <span class="preprocessor"></span>
<a name="l02384"></a>02384              <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#69f88541b84e4d9890e0b786199e9a3a">GetAPsToChangeStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_CROUCH ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l02385"></a>02385              {
<a name="l02386"></a>02386                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_CROUCH;
<a name="l02387"></a>02387 
<a name="l02388"></a>02388                   <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a>);
<a name="l02389"></a>02389              }
<a name="l02390"></a>02390     }
<a name="l02391"></a>02391 
<a name="l02392"></a>02392 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l02393"></a>02393 <span class="preprocessor"></span>   sprintf((CHAR *)tempstr,<span class="stringliteral">"%s RESTS (STATUS RED), breath = %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a>);
<a name="l02394"></a>02394    <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l02395"></a>02395 <span class="preprocessor">#endif</span>
<a name="l02396"></a>02396 <span class="preprocessor"></span>
<a name="l02397"></a>02397    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l02398"></a>02398    <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l02399"></a>02399   }
<a name="l02400"></a>02400 
<a name="l02401"></a>02401 
<a name="l02402"></a>02402 
<a name="l02403"></a>02403 DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: calculate morale"</span>);
<a name="l02404"></a>02404   <span class="comment">// calculate our morale</span>
<a name="l02405"></a>02405  <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> = <a class="code" href="ai_8h.html#0594cdf20b72e9dc23dbe5ad101e6d64">CalcMorale</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l02406"></a>02406 
<a name="l02407"></a>02407  <span class="comment">// if a guy is feeling REALLY discouraged, he may continue to run like hell</span>
<a name="l02408"></a>02408  <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> == <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e360129a915d611934bca8624d0ea8e21e">MORALE_HOPELESS</a>) &amp;&amp; ubCanMove)
<a name="l02409"></a>02409   {
<a name="l02410"></a>02410       DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: run away"</span>);<span class="comment"></span>
<a name="l02411"></a>02411 <span class="comment">   ////////////////////////////////////////////////////////////////////////</span>
<a name="l02412"></a>02412 <span class="comment"></span>   <span class="comment">// RUN AWAY TO SPOT FARTHEST FROM KNOWN THREATS (ONLY IF MORALE HOPELESS)</span><span class="comment"></span>
<a name="l02413"></a>02413 <span class="comment">   ////////////////////////////////////////////////////////////////////////</span>
<a name="l02414"></a>02414 <span class="comment"></span>
<a name="l02415"></a>02415    <span class="comment">// look for best place to RUN AWAY to (farthest from the closest threat)</span>
<a name="l02416"></a>02416    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#eb3ffb28e50d84917771661b9d91aa51">FindSpotMaxDistFromOpponents</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l02417"></a>02417 
<a name="l02418"></a>02418    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l02419"></a>02419     {
<a name="l02420"></a>02420 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l02421"></a>02421 <span class="preprocessor"></span>     sprintf((CHAR *)tempstr,<span class="stringliteral">"%s RUNNING AWAY to grid %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l02422"></a>02422      <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l02423"></a>02423 <span class="preprocessor">#endif</span>
<a name="l02424"></a>02424 <span class="preprocessor"></span>
<a name="l02425"></a>02425      <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950be1338b9c498abc9dd4b86d1b22291b12">AI_ACTION_RUN_AWAY</a>);
<a name="l02426"></a>02426     }
<a name="l02427"></a>02427   }
<a name="l02428"></a>02428 
<a name="l02429"></a>02429 
<a name="l02430"></a>02430 DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: radio red alert?"</span>);<span class="comment"></span>
<a name="l02431"></a>02431 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l02432"></a>02432 <span class="comment"></span> <span class="comment">// RADIO RED ALERT: determine %chance to call others and report contact</span><span class="comment"></span>
<a name="l02433"></a>02433 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l02434"></a>02434 <span class="comment"></span>
<a name="l02435"></a>02435  <span class="comment">// if we're a computer merc, and we have the action points remaining to RADIO</span>
<a name="l02436"></a>02436  <span class="comment">// (we never want NPCs to choose to radio if they would have to wait a turn)</span>
<a name="l02437"></a>02437  <span class="keywordflow">if</span> ( !fCivilian &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt;= AP_RADIO) &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bMenInSector &gt; 1) )
<a name="l02438"></a>02438   {
<a name="l02439"></a>02439 
<a name="l02440"></a>02440             DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: checking to radio red alert"</span>);
<a name="l02441"></a>02441 
<a name="l02442"></a>02442    <span class="comment">// if there hasn't been an initial RED ALERT yet in this sector</span>
<a name="l02443"></a>02443    <span class="keywordflow">if</span> ( !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bAwareOfOpposition) || <a class="code" href="AIInternals_8h.html#e64d9ad938275226f748780f4d93d3f4">NeedToRadioAboutPanicTrigger</a>() )
<a name="l02444"></a>02444      <span class="comment">// since I'm at STATUS RED, I obviously know we're being invaded!</span>
<a name="l02445"></a>02445      iChance = <a class="code" href="ai_8h.html#71440b56c1b498cae809e64152b7d65e">gbDiff</a>[DIFF_RADIO_RED_ALERT][ <a class="code" href="ai_8h.html#eb68d5bd7803b8c6d4637cf543b9372c">SoldierDifficultyLevel</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) ];
<a name="l02446"></a>02446    <span class="keywordflow">else</span> <span class="comment">// subsequent radioing (only to update enemy positions, request help)</span>
<a name="l02447"></a>02447      <span class="comment">// base chance depends on how much new info we have to radio to the others</span>
<a name="l02448"></a>02448      iChance = 10 * <a class="code" href="ai_8h.html#b72f0daba2e93b7c9d9c2ba87426da07">WhatIKnowThatPublicDont</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,FALSE);  <span class="comment">// use 10 * for RED alert</span>
<a name="l02449"></a>02449 
<a name="l02450"></a>02450    <span class="comment">// if I actually know something they don't and I ain't swimming (deep water)</span>
<a name="l02451"></a>02451    <span class="keywordflow">if</span> (iChance &amp;&amp; !bInDeepWater)
<a name="l02452"></a>02452     {
<a name="l02453"></a>02453      <span class="comment">// modify base chance according to orders</span>
<a name="l02454"></a>02454      <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>)
<a name="l02455"></a>02455       {
<a name="l02456"></a>02456        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>:       iChance +=  20;  <span class="keywordflow">break</span>;
<a name="l02457"></a>02457        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>:          iChance +=  15;  <span class="keywordflow">break</span>;
<a name="l02458"></a>02458        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffbc5202d0fef4bcd4a4625750d02a724">ONCALL</a>:           iChance +=  10;  <span class="keywordflow">break</span>;
<a name="l02459"></a>02459        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>:                       <span class="keywordflow">break</span>;
<a name="l02460"></a>02460                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f4f7b012e8cbd1e2cc2b3fa9e1b5c9f9f">RNDPTPATROL</a>:
<a name="l02461"></a>02461        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f7dc5dd2cff7953315a832e7a457deb9d">POINTPATROL</a>:      iChance +=  -5;  <span class="keywordflow">break</span>;
<a name="l02462"></a>02462        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fddbbeee5695e4be7e9f148315873ce2b">FARPATROL</a>:        iChance += -10;  <span class="keywordflow">break</span>;
<a name="l02463"></a>02463        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>:        iChance += -20;  <span class="keywordflow">break</span>;
<a name="l02464"></a>02464        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a>:                   iChance += -10;  <span class="keywordflow">break</span>; <span class="comment">// Sniper contacts should be reported automatically</span>
<a name="l02465"></a>02465       }
<a name="l02466"></a>02466 
<a name="l02467"></a>02467      <span class="comment">// modify base chance according to attitude</span>
<a name="l02468"></a>02468      <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>)
<a name="l02469"></a>02469       {
<a name="l02470"></a>02470        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:        iChance +=  20;  <span class="keywordflow">break</span>;
<a name="l02471"></a>02471        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:        iChance += -10;  <span class="keywordflow">break</span>;
<a name="l02472"></a>02472        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:                          <span class="keywordflow">break</span>;
<a name="l02473"></a>02473        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:      iChance +=  -5;  <span class="keywordflow">break</span>;
<a name="l02474"></a>02474        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:                        <span class="keywordflow">break</span>;
<a name="l02475"></a>02475        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:       iChance += -20;  <span class="keywordflow">break</span>;
<a name="l02476"></a>02476                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>:         iChance = 0;
<a name="l02477"></a>02477       }
<a name="l02478"></a>02478 
<a name="l02479"></a>02479                   <span class="keywordflow">if</span> ( (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#965c762739e2731d1af1bb56e3485d0f">fPanicFlags</a> &amp; PANIC_TRIGGERS_HERE) &amp;&amp; !<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bAwareOfOpposition)
<a name="l02480"></a>02480                   {
<a name="l02481"></a>02481                         <span class="comment">// ignore morale (which could be really high </span>
<a name="l02482"></a>02482                   }
<a name="l02483"></a>02483                   <span class="keywordflow">else</span>
<a name="l02484"></a>02484                   {
<a name="l02485"></a>02485                    <span class="comment">// modify base chance according to morale</span>
<a name="l02486"></a>02486                    <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a>)
<a name="l02487"></a>02487                         {
<a name="l02488"></a>02488                          <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e360129a915d611934bca8624d0ea8e21e">MORALE_HOPELESS</a>:  iChance *= 3;    <span class="keywordflow">break</span>;
<a name="l02489"></a>02489                          <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e3babad6ffb594c707f4cf71479ecac899">MORALE_WORRIED</a>:   iChance *= 2;    <span class="keywordflow">break</span>;
<a name="l02490"></a>02490                          <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e3ace720f60b0c5dd9ffeb0df82fa6b4e0">MORALE_NORMAL</a>:                     <span class="keywordflow">break</span>;
<a name="l02491"></a>02491                          <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e397b51ec5a452f3c4ebcddfd426c0485c">MORALE_CONFIDENT</a>: iChance /= 2;    <span class="keywordflow">break</span>;
<a name="l02492"></a>02492                          <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e34e0b5e2e2be99f4e43c1321cf58b19ad">MORALE_FEARLESS</a>:  iChance /= 3;    <span class="keywordflow">break</span>;
<a name="l02493"></a>02493                         }
<a name="l02494"></a>02494                   }
<a name="l02495"></a>02495 
<a name="l02496"></a>02496 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l02497"></a>02497 <span class="preprocessor"></span>     <a class="code" href="AIUtils_8cpp.html#88d13d659f1890049d17af096cc37432">AINumMessage</a>(<span class="stringliteral">"Chance to radio RED alert = "</span>,iChance);
<a name="l02498"></a>02498 <span class="preprocessor">#endif</span>
<a name="l02499"></a>02499 <span class="preprocessor"></span>
<a name="l02500"></a>02500      <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance)
<a name="l02501"></a>02501       {
<a name="l02502"></a>02502 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l02503"></a>02503 <span class="preprocessor"></span>       <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"decides to radio a RED alert!"</span>,1000);
<a name="l02504"></a>02504 <span class="preprocessor">#endif</span>
<a name="l02505"></a>02505 <span class="preprocessor"></span>
<a name="l02506"></a>02506             DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: decided to radio red alert"</span>);
<a name="l02507"></a>02507        <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b32a0d931f53db4ddf96ac82a3b52484a">AI_ACTION_RED_ALERT</a>);
<a name="l02508"></a>02508       }
<a name="l02509"></a>02509     }
<a name="l02510"></a>02510   }
<a name="l02511"></a>02511 
<a name="l02512"></a>02512       <span class="keywordflow">if</span> ( !TANK( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l02513"></a>02513       {
<a name="l02514"></a>02514             DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: main red ai"</span>);
<a name="l02515"></a>02515 <span class="comment"></span>
<a name="l02516"></a>02516 <span class="comment">             ////////////////////////////////////////////////////////////////////////////</span>
<a name="l02517"></a>02517 <span class="comment"></span>             <span class="comment">// MAIN RED AI: Decide soldier's preference between SEEKING,HELPING &amp; HIDING</span><span class="comment"></span>
<a name="l02518"></a>02518 <span class="comment">             ////////////////////////////////////////////////////////////////////////////</span>
<a name="l02519"></a>02519 <span class="comment"></span>
<a name="l02520"></a>02520                   <span class="comment">// get the location of the closest reachable opponent</span>
<a name="l02521"></a>02521                   sClosestDisturbance = <a class="code" href="AIInternals_8h.html#bdbd82cec2627ae4973f5e8e4f897451">ClosestReachableDisturbance</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,ubUnconsciousOK, &amp;fClimb);
<a name="l02522"></a>02522 
<a name="l02523"></a>02523                   DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: check to continue flanking"</span>);
<a name="l02524"></a>02524                   <span class="comment">// continue flanking                </span>
<a name="l02525"></a>02525                   <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> tempGridNo;
<a name="l02526"></a>02526                   <span class="keywordflow">if</span> ( sClosestDisturbance == NOWHERE )
<a name="l02527"></a>02527                         tempGridNo = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4b05ad0162c2ca209e5a51fdbf9c4cde">lastFlankSpot</a>;
<a name="l02528"></a>02528                   <span class="keywordflow">else</span>
<a name="l02529"></a>02529                         tempGridNo = sClosestDisturbance;
<a name="l02530"></a>02530 
<a name="l02531"></a>02531                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> &gt; 0 &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> &lt; MAX_FLANKS_RED  &amp;&amp; <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubHeight != ANIM_PRONE )
<a name="l02532"></a>02532                   {
<a name="l02533"></a>02533                         DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: continue flanking"</span>);
<a name="l02534"></a>02534                         <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> currDir = <a class="code" href="Soldier_01Control_8cpp.html#1d7b6c103ede7e551e76eef2ef173f9b">GetDirectionFromGridNo</a> ( tempGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l02535"></a>02535                         <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> origDir = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e2645c74e19c721ccca934e1f73ab1d0">origDir</a>;
<a name="l02536"></a>02536                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> += 1;
<a name="l02537"></a>02537                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5562d9bc4815ba4c0d02e60463ca48fa">lastFlankLeft</a> )
<a name="l02538"></a>02538                         {
<a name="l02539"></a>02539                               <span class="keywordflow">if</span> ( origDir &gt; currDir )
<a name="l02540"></a>02540                                     origDir -= 8;
<a name="l02541"></a>02541 
<a name="l02542"></a>02542                               <span class="keywordflow">if</span> ( (currDir - origDir) &gt;= 4 )
<a name="l02543"></a>02543                               {
<a name="l02544"></a>02544                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> = MAX_FLANKS_RED;
<a name="l02545"></a>02545                               }
<a name="l02546"></a>02546                               <span class="keywordflow">else</span>
<a name="l02547"></a>02547                               {
<a name="l02548"></a>02548                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#eab088163bfe9e97370857eba0ab6629">FindFlankingSpot</a> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, tempGridNo , <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a>);
<a name="l02549"></a>02549                                     <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE ) <span class="comment">//&amp;&amp; (currDir - origDir) &lt; 2 )</span>
<a name="l02550"></a>02550                                           <span class="keywordflow">return</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a> ;
<a name="l02551"></a>02551                                     <span class="keywordflow">else</span>
<a name="l02552"></a>02552                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> = MAX_FLANKS_RED;
<a name="l02553"></a>02553                               }
<a name="l02554"></a>02554                         }
<a name="l02555"></a>02555                         <span class="keywordflow">else</span>
<a name="l02556"></a>02556                         {
<a name="l02557"></a>02557                               <span class="keywordflow">if</span> ( origDir &lt; currDir )
<a name="l02558"></a>02558                                     origDir += 8;
<a name="l02559"></a>02559 
<a name="l02560"></a>02560                               <span class="keywordflow">if</span> ( (origDir - currDir) &gt;= 4 )
<a name="l02561"></a>02561                               {
<a name="l02562"></a>02562                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> = MAX_FLANKS_RED;
<a name="l02563"></a>02563                               }
<a name="l02564"></a>02564                               <span class="keywordflow">else</span>
<a name="l02565"></a>02565                               {
<a name="l02566"></a>02566                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#eab088163bfe9e97370857eba0ab6629">FindFlankingSpot</a> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, tempGridNo , <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b10a5bb7993a15bb15134edd4a78384cd">AI_ACTION_FLANK_RIGHT</a>);
<a name="l02567"></a>02567                                     <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE )<span class="comment">//&amp;&amp; (origDir - currDir) &lt; 2 )</span>
<a name="l02568"></a>02568                                           <span class="keywordflow">return</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b10a5bb7993a15bb15134edd4a78384cd">AI_ACTION_FLANK_RIGHT</a> ;
<a name="l02569"></a>02569                                     <span class="keywordflow">else</span>
<a name="l02570"></a>02570                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> = MAX_FLANKS_RED;
<a name="l02571"></a>02571                               }
<a name="l02572"></a>02572                         }
<a name="l02573"></a>02573                   }
<a name="l02574"></a>02574                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> == MAX_FLANKS_RED )
<a name="l02575"></a>02575                   {
<a name="l02576"></a>02576                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> += 1;
<a name="l02577"></a>02577                         DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: stop flanking"</span>);
<a name="l02578"></a>02578                         <span class="keywordflow">if</span> (<a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, tempGridNo ) &gt; MIN_FLANK_DIST_RED * 2 )
<a name="l02579"></a>02579                         {
<a name="l02580"></a>02580                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#4e5fb4413a1a185c794176c2311c4076">InternalGoAsFarAsPossibleTowards</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,tempGridNo,AP_PRONE,<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>,0);
<a name="l02581"></a>02581 
<a name="l02582"></a>02582                               <span class="keywordflow">if</span> ( <a class="code" href="LOS_8cpp.html#61eb3622c754f1753756a5ba09bcb1ce">LocationToLocationLineOfSightTest</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, tempGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) <a class="code" href="opplist_8cpp.html#ce89c9f1017d9a6e473df03acb6f1a2a">MaxDistanceVisible</a>(), TRUE ) )
<a name="l02583"></a>02583                               {
<a name="l02584"></a>02584                                     <span class="comment">// reserve APs for a possible crouch plus a shot</span>
<a name="l02585"></a>02585                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#4e5fb4413a1a185c794176c2311c4076">InternalGoAsFarAsPossibleTowards</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, tempGridNo, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (<a class="code" href="Points_8cpp.html#84f116b33524232723bfa74949877c21">MinAPsToAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, tempGridNo, ADDTURNCOST) + AP_CROUCH), <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>, FLAG_CAUTIOUS );
<a name="l02586"></a>02586                                     <span class="keywordflow">if</span> ( pSoldier-&gt;usActionData != NOWHERE )
<a name="l02587"></a>02587                                     {
<a name="l02588"></a>02588                                           pSoldier-&gt;fAIFlags |= AI_CAUTIOUS;
<a name="l02589"></a>02589                                           pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>;
<a name="l02590"></a>02590                                           <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>);
<a name="l02591"></a>02591                                     }
<a name="l02592"></a>02592                               }
<a name="l02593"></a>02593                               <span class="keywordflow">else</span>
<a name="l02594"></a>02594                               {
<a name="l02595"></a>02595                                     <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>);
<a name="l02596"></a>02596                               }
<a name="l02597"></a>02597                         }
<a name="l02598"></a>02598                         <span class="keywordflow">else</span>
<a name="l02599"></a>02599                         {
<a name="l02600"></a>02600                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#0b7c3b2ba83ca87cfa5a3ebc680471a2">FindBestNearbyCover</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a>,&amp;iDummy);
<a name="l02601"></a>02601                               <span class="keywordflow">return</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bd2358f4f3b1cd379c943855df803496d">AI_ACTION_TAKE_COVER</a> ;
<a name="l02602"></a>02602                         }
<a name="l02603"></a>02603                   }
<a name="l02604"></a>02604 
<a name="l02605"></a>02605 
<a name="l02606"></a>02606       <span class="comment">// if we can move at least 1 square's worth</span>
<a name="l02607"></a>02607              <span class="comment">// and have more APs than we want to reserve</span>
<a name="l02608"></a>02608                   DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"decideactionred: can we move? = %d, APs = %d"</span>,ubCanMove,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>));
<a name="l02609"></a>02609 
<a name="l02610"></a>02610              <span class="keywordflow">if</span> (ubCanMove &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt; MAX_AP_CARRIED)
<a name="l02611"></a>02611                   {
<a name="l02612"></a>02612                    <span class="keywordflow">if</span> (fCivilian)
<a name="l02613"></a>02613                         {
<a name="l02614"></a>02614                          <span class="comment">// only interested in hiding out...</span>
<a name="l02615"></a>02615                          bSeekPts = -99;
<a name="l02616"></a>02616                          bHelpPts = -99;
<a name="l02617"></a>02617                          bHidePts =  +1;
<a name="l02618"></a>02618                         }
<a name="l02619"></a>02619                    <span class="keywordflow">else</span>
<a name="l02620"></a>02620                         {
<a name="l02621"></a>02621 
<a name="l02622"></a>02622                         DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"decideactionred: checking hide/seek/help/watch points... orders = %d, attitude = %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>));
<a name="l02623"></a>02623                          <span class="comment">// calculate initial points for watch based on highest watch loc</span>
<a name="l02624"></a>02624 
<a name="l02625"></a>02625                          bWatchPts = <a class="code" href="opplist_8cpp.html#bbe772f1f57b044d948b9668d3bddfd4">GetHighestWatchedLocPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l02626"></a>02626                          <span class="keywordflow">if</span> ( bWatchPts &lt;= 0 )
<a name="l02627"></a>02627                          {
<a name="l02628"></a>02628                                <span class="comment">// no watching</span>
<a name="l02629"></a>02629                                bWatchPts = -99;
<a name="l02630"></a>02630                          }
<a name="l02631"></a>02631 
<a name="l02632"></a>02632                          <span class="comment">// modify RED movement tendencies according to morale</span>
<a name="l02633"></a>02633                          <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a>)
<a name="l02634"></a>02634                               {
<a name="l02635"></a>02635                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e360129a915d611934bca8624d0ea8e21e">MORALE_HOPELESS</a>:  bSeekPts = -99; bHelpPts = -99; bHidePts  = +2; bWatchPts = -99; <span class="keywordflow">break</span>;
<a name="l02636"></a>02636                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e3babad6ffb594c707f4cf71479ecac899">MORALE_WORRIED</a>:   bSeekPts += -2; bHelpPts +=  0; bHidePts += +2; bWatchPts +=      1; <span class="keywordflow">break</span>;
<a name="l02637"></a>02637                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e3ace720f60b0c5dd9ffeb0df82fa6b4e0">MORALE_NORMAL</a>:    bSeekPts +=  0; bHelpPts +=  0; bHidePts +=  0; bWatchPts +=      0; <span class="keywordflow">break</span>;
<a name="l02638"></a>02638                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e397b51ec5a452f3c4ebcddfd426c0485c">MORALE_CONFIDENT</a>: bSeekPts += +1; bHelpPts +=  0; bHidePts += -1; bWatchPts +=      0; <span class="keywordflow">break</span>;
<a name="l02639"></a>02639                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e34e0b5e2e2be99f4e43c1321cf58b19ad">MORALE_FEARLESS</a>:  bSeekPts += +1; bHelpPts +=  0; bHidePts =  -1; bWatchPts +=  0; <span class="keywordflow">break</span>;
<a name="l02640"></a>02640                               }
<a name="l02641"></a>02641 
<a name="l02642"></a>02642                          <span class="comment">// modify tendencies according to orders</span>
<a name="l02643"></a>02643                          <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>)
<a name="l02644"></a>02644                               {
<a name="l02645"></a>02645                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>:   bSeekPts += -1; bHelpPts += -1; bHidePts += +1; bWatchPts += +1; <span class="keywordflow">break</span>;
<a name="l02646"></a>02646                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>:      bSeekPts += -1; bHelpPts +=  0; bHidePts += +1; bWatchPts += +1; <span class="keywordflow">break</span>;
<a name="l02647"></a>02647                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>:  bSeekPts +=  0; bHelpPts +=  0; bHidePts +=  0; bWatchPts +=  0; <span class="keywordflow">break</span>;
<a name="l02648"></a>02648                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f4f7b012e8cbd1e2cc2b3fa9e1b5c9f9f">RNDPTPATROL</a>:  bSeekPts +=  0; bHelpPts +=  0; bHidePts +=  0; bWatchPts +=  0; <span class="keywordflow">break</span>;
<a name="l02649"></a>02649                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f7dc5dd2cff7953315a832e7a457deb9d">POINTPATROL</a>:  bSeekPts +=  0; bHelpPts +=  0; bHidePts +=  0; bWatchPts +=  0; <span class="keywordflow">break</span>;
<a name="l02650"></a>02650                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fddbbeee5695e4be7e9f148315873ce2b">FARPATROL</a>:    bSeekPts +=  0; bHelpPts +=  0; bHidePts +=  0; bWatchPts +=  0; <span class="keywordflow">break</span>;
<a name="l02651"></a>02651                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffbc5202d0fef4bcd4a4625750d02a724">ONCALL</a>:       bSeekPts +=  0; bHelpPts += +1; bHidePts += -1; bWatchPts +=  0; <span class="keywordflow">break</span>;
<a name="l02652"></a>02652                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>:    bSeekPts += +1; bHelpPts +=  0; bHidePts += -1; bWatchPts += -1; <span class="keywordflow">break</span>;
<a name="l02653"></a>02653                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a>:           bSeekPts += -1; bHelpPts +=  0; bHidePts += +1; bWatchPts += +1; <span class="keywordflow">break</span>;
<a name="l02654"></a>02654                               }
<a name="l02655"></a>02655 
<a name="l02656"></a>02656                          <span class="comment">// modify tendencies according to attitude</span>
<a name="l02657"></a>02657                          <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>)
<a name="l02658"></a>02658                               {
<a name="l02659"></a>02659                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:     bSeekPts += -1; bHelpPts +=  0; bHidePts += +2; bWatchPts += +1; <span class="keywordflow">break</span>;
<a name="l02660"></a>02660                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:     bSeekPts += +1; bHelpPts += -1; bHidePts += -1; bWatchPts += -1; <span class="keywordflow">break</span>;
<a name="l02661"></a>02661                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:      bSeekPts += +1; bHelpPts += +1; bHidePts += -1; bWatchPts += -1; <span class="keywordflow">break</span>;
<a name="l02662"></a>02662                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:   bSeekPts +=  1; bHelpPts += -1; bHidePts += +1; bWatchPts +=  0; <span class="keywordflow">break</span>;
<a name="l02663"></a>02663                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:    bSeekPts +=  1; bHelpPts += +1; bHidePts += +1; bWatchPts +=  0; <span class="keywordflow">break</span>;
<a name="l02664"></a>02664                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:    bSeekPts += +1; bHelpPts +=  0; bHidePts += -1; bWatchPts +=  0; <span class="keywordflow">break</span>;
<a name="l02665"></a>02665                                <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>:bSeekPts += +1; bHelpPts +=  0; bHidePts += -1; bWatchPts +=  0; <span class="keywordflow">break</span>;
<a name="l02666"></a>02666                               }
<a name="l02667"></a>02667 
<a name="l02668"></a>02668                               <span class="comment">//Madd: make militia less likely to go running headlong into trouble</span>
<a name="l02669"></a>02669                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == MILITIA_TEAM )
<a name="l02670"></a>02670                               {
<a name="l02671"></a>02671                                     bSeekPts += -1; bHelpPts +=  0; bHidePts += +1; bWatchPts += +0;
<a name="l02672"></a>02672                               }
<a name="l02673"></a>02673                         }
<a name="l02674"></a>02674 
<a name="l02675"></a>02675                         <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a>)
<a name="l02676"></a>02676                         {
<a name="l02677"></a>02677                               <span class="comment">// don't search for cover </span>
<a name="l02678"></a>02678                               bHidePts = -99;
<a name="l02679"></a>02679                         }
<a name="l02680"></a>02680 
<a name="l02681"></a>02681                         DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"decideactionred: hide = %d, seek = %d, watch = %d, help = %d"</span>,bHidePts,bSeekPts,bWatchPts,bHelpPts));
<a name="l02682"></a>02682                         <span class="comment">// while one of the three main RED REACTIONS remains viable</span>
<a name="l02683"></a>02683                         <span class="keywordflow">while</span> ((bSeekPts &gt; -90) || (bHelpPts &gt; -90) || (bHidePts &gt; -90) )
<a name="l02684"></a>02684                         {
<a name="l02685"></a>02685                               DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: checking to seek"</span>);
<a name="l02686"></a>02686                               <span class="comment">// if SEEKING is possible and at least as desirable as helping or hiding</span>
<a name="l02687"></a>02687                               <span class="keywordflow">if</span> ( ((bSeekPts &gt; -90) &amp;&amp; (bSeekPts &gt;= bHelpPts) &amp;&amp; (bSeekPts &gt;= bHidePts) &amp;&amp; (bSeekPts &gt;= bWatchPts )) )
<a name="l02688"></a>02688                               {
<a name="l02689"></a>02689 <span class="preprocessor">                                    #ifdef AI_TIMING_TESTS</span>
<a name="l02690"></a>02690 <span class="preprocessor"></span>                                    uiStartTime = GetJA2Clock();
<a name="l02691"></a>02691 <span class="preprocessor">                                    #endif</span>
<a name="l02692"></a>02692 <span class="preprocessor"></span>                                    
<a name="l02693"></a>02693 <span class="preprocessor">                                    #ifdef AI_TIMING_TESTS</span>
<a name="l02694"></a>02694 <span class="preprocessor"></span>                                    uiEndTime = GetJA2Clock();
<a name="l02695"></a>02695                                     <a class="code" href="Items_8cpp.html#777a80923e90745695ebccfb6cadfdcb">guiRedSeekTimeTotal</a> += (uiEndTime - uiStartTime);
<a name="l02696"></a>02696                                     <a class="code" href="Items_8cpp.html#479723c5f3ddc48634f3bf7801a8e0c7">guiRedSeekCounter</a>++;
<a name="l02697"></a>02697 <span class="preprocessor">                                    #endif</span>
<a name="l02698"></a>02698 <span class="preprocessor"></span>                                    <span class="comment">// if there is an opponent reachable</span>
<a name="l02699"></a>02699                                     <span class="keywordflow">if</span> (sClosestDisturbance != NOWHERE &amp;&amp; <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubHeight != ANIM_PRONE )
<a name="l02700"></a>02700                                     {
<a name="l02701"></a>02701                                           DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: seek opponent"</span>);<span class="comment"></span>
<a name="l02702"></a>02702 <span class="comment">                                          //////////////////////////////////////////////////////////////////////</span>
<a name="l02703"></a>02703 <span class="comment"></span>                                          <span class="comment">// SEEK CLOSEST DISTURBANCE: GO DIRECTLY TOWARDS CLOSEST KNOWN OPPONENT</span><span class="comment"></span>
<a name="l02704"></a>02704 <span class="comment">                                          //////////////////////////////////////////////////////////////////////</span>
<a name="l02705"></a>02705 <span class="comment"></span>
<a name="l02706"></a>02706                                           <span class="comment">// try to move towards him</span>
<a name="l02707"></a>02707                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#4e5fb4413a1a185c794176c2311c4076">InternalGoAsFarAsPossibleTowards</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,sClosestDisturbance,AP_CROUCH,<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>,0);
<a name="l02708"></a>02708 
<a name="l02709"></a>02709                                           <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l02710"></a>02710                                           {
<a name="l02711"></a>02711                                                 <span class="comment">// Check for a trap</span>
<a name="l02712"></a>02712                                                 <span class="keywordflow">if</span> ( !<a class="code" href="AIInternals_8h.html#5019ef7267bbbf961484119fdf8abea8">ArmySeesOpponents</a>() )
<a name="l02713"></a>02713                                                 {
<a name="l02714"></a>02714                                                       <span class="keywordflow">if</span> ( <a class="code" href="Rotting_01Corpses_8cpp.html#edbc0a9a88e5891e260b9862115ef667">GetNearestRottingCorpseAIWarning</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> ) &gt; 0 )
<a name="l02715"></a>02715                                                       {
<a name="l02716"></a>02716                                                             <span class="comment">// abort! abort!</span>
<a name="l02717"></a>02717                                                             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l02718"></a>02718                                                       }
<a name="l02719"></a>02719                                                 }
<a name="l02720"></a>02720                                           }
<a name="l02721"></a>02721 
<a name="l02722"></a>02722                                           <span class="comment">// if it's possible</span>
<a name="l02723"></a>02723                                           <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l02724"></a>02724                                           {
<a name="l02725"></a>02725 <span class="preprocessor">                                          #ifdef DEBUGDECISIONS</span>
<a name="l02726"></a>02726 <span class="preprocessor"></span>                                                <span class="comment">// do it!</span>
<a name="l02727"></a>02727                                                 sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - SEEKING OPPONENT at grid %d, MOVING to %d"</span>,
<a name="l02728"></a>02728                                                 <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,sClosestDisturbance,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l02729"></a>02729                                                 <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l02730"></a>02730 <span class="preprocessor">                                          #endif                                    </span>
<a name="l02731"></a>02731 <span class="preprocessor"></span>
<a name="l02732"></a>02732                                                 <span class="keywordflow">if</span> (fClimb)<span class="comment">//&amp;&amp; pSoldier-&gt;usActionData == sClosestDisturbance)</span>
<a name="l02733"></a>02733                                                 {
<a name="l02734"></a>02734                                                       <span class="comment">// need to climb AND have enough APs to get there this turn</span>
<a name="l02735"></a>02735                                                       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fUp = TRUE;
<a name="l02736"></a>02736                                                       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> &gt; 0 )
<a name="l02737"></a>02737                                                             fUp = FALSE;
<a name="l02738"></a>02738 
<a name="l02739"></a>02739                                                       <span class="keywordflow">if</span> (!fUp)
<a name="l02740"></a>02740                                                             DebugMsg ( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a> , DBG_LEVEL_3 , <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Soldier %d is climbing down"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>) );
<a name="l02741"></a>02741 
<a name="l02742"></a>02742                                                       <span class="keywordflow">if</span> ( <a class="code" href="ai_8h.html#c0ab3ab9291c1447f10a520aeb33cbd5">CanClimbFromHere</a> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, fUp ) )
<a name="l02743"></a>02743                                                       {
<a name="l02744"></a>02744                                                             <span class="keywordflow">if</span> (<a class="code" href="ai_8h.html#dd5730a3e85127b7590031d7580277b0">IsActionAffordable</a>(pSoldier) &amp;&amp; pSoldier-&gt;bActionPoints &gt;= ( AP_CLIMBROOF + <a class="code" href="Points_8cpp.html#84f116b33524232723bfa74949877c21">MinAPsToAttack</a>( pSoldier, sClosestDisturbance, ADDTURNCOST)))
<a name="l02745"></a>02745                                                             {
<a name="l02746"></a>02746                                                                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bf0d31a9fac3e900acf35ca5832cd876e">AI_ACTION_CLIMB_ROOF</a> );
<a name="l02747"></a>02747                                                             }
<a name="l02748"></a>02748                                                       }
<a name="l02749"></a>02749                                                       <span class="keywordflow">else</span>
<a name="l02750"></a>02750                                                       {
<a name="l02751"></a>02751                                                             pSoldier-&gt;usActionData = <a class="code" href="ai_8h.html#c3a9539676bbf7e786da9f3bec8406da">FindClosestClimbPoint</a>(pSoldier-&gt;sGridNo , sClosestDisturbance , fUp );
<a name="l02752"></a>02752                                                             <span class="keywordflow">if</span> ( pSoldier-&gt;usActionData != NOWHERE )
<a name="l02753"></a>02753                                                             {
<a name="l02754"></a>02754                                                                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4ca31547c6e6eeadec11ea94b7a9fd07">AI_ACTION_MOVE_TO_CLIMB</a>  );
<a name="l02755"></a>02755                                                             }
<a name="l02756"></a>02756                                                       }
<a name="l02757"></a>02757                                                 }
<a name="l02758"></a>02758                                                 <span class="comment">//if ( fClimb &amp;&amp; pSoldier-&gt;usActionData == sClosestDisturbance)</span>
<a name="l02759"></a>02759                                                 <span class="comment">//{</span>
<a name="l02760"></a>02760                                                 <span class="comment">//    return( AI_ACTION_CLIMB_ROOF );</span>
<a name="l02761"></a>02761                                                 <span class="comment">//}</span>
<a name="l02762"></a>02762 
<a name="l02763"></a>02763 
<a name="l02764"></a>02764                                                 <span class="keywordflow">if</span> ( ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a> == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a> == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>  || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a> == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a> )  &amp;&amp; <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubHeight != ANIM_PRONE )
<a name="l02765"></a>02765                                                 {
<a name="l02766"></a>02766                                                       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> action = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>; 
<a name="l02767"></a>02767                                                       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> dist = <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, sClosestDisturbance );
<a name="l02768"></a>02768                                                       <span class="keywordflow">if</span> ( dist &gt; MIN_FLANK_DIST_RED  &amp;&amp; dist &lt; MAX_FLANK_DIST_RED )
<a name="l02769"></a>02769                                                       {
<a name="l02770"></a>02770                                                             <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> rdm = <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>(6);
<a name="l02771"></a>02771 
<a name="l02772"></a>02772                                                             <span class="keywordflow">switch</span> (rdm)
<a name="l02773"></a>02773                                                             {
<a name="l02774"></a>02774                                                                   <span class="keywordflow">case</span> 1:                                   
<a name="l02775"></a>02775                                                                   <span class="keywordflow">case</span> 2:                                   
<a name="l02776"></a>02776                                                                   <span class="keywordflow">case</span> 3:
<a name="l02777"></a>02777                                                                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b10a5bb7993a15bb15134edd4a78384cd">AI_ACTION_FLANK_RIGHT</a> )
<a name="l02778"></a>02778                                                                               action = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a> ;
<a name="l02779"></a>02779                                                                         <span class="keywordflow">break</span>;
<a name="l02780"></a>02780                                                                   <span class="keywordflow">default</span>:                                  
<a name="l02781"></a>02781                                                                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b10a5bb7993a15bb15134edd4a78384cd">AI_ACTION_FLANK_RIGHT</a> )
<a name="l02782"></a>02782                                                                               action = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b10a5bb7993a15bb15134edd4a78384cd">AI_ACTION_FLANK_RIGHT</a> ;
<a name="l02783"></a>02783                                                                         <span class="keywordflow">break</span>;
<a name="l02784"></a>02784                                                             }     
<a name="l02785"></a>02785                                                       }
<a name="l02786"></a>02786                                                       <span class="keywordflow">else</span>
<a name="l02787"></a>02787                                                             <span class="keywordflow">return</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a> ;
<a name="l02788"></a>02788 
<a name="l02789"></a>02789                                                       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#eab088163bfe9e97370857eba0ab6629">FindFlankingSpot</a> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sClosestDisturbance, action );
<a name="l02790"></a>02790 
<a name="l02791"></a>02791                                                       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> == NOWHERE || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a> &gt;= MAX_FLANKS_RED )
<a name="l02792"></a>02792                                                       {
<a name="l02793"></a>02793                                                             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#4e5fb4413a1a185c794176c2311c4076">InternalGoAsFarAsPossibleTowards</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,sClosestDisturbance,AP_CROUCH, <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>,0);
<a name="l02794"></a>02794                                                             <span class="comment">//pSoldier-&gt;numFlanks = 0;</span>
<a name="l02795"></a>02795                                                             <span class="keywordflow">if</span> ( <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>, sClosestDisturbance ) &lt; 5 || <a class="code" href="LOS_8cpp.html#61eb3622c754f1753756a5ba09bcb1ce">LocationToLocationLineOfSightTest</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, sClosestDisturbance, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) <a class="code" href="opplist_8cpp.html#ce89c9f1017d9a6e473df03acb6f1a2a">MaxDistanceVisible</a>(), TRUE ) )
<a name="l02796"></a>02796                                                             {
<a name="l02797"></a>02797                                                                   <span class="comment">// reserve APs for a possible crouch plus a shot</span>
<a name="l02798"></a>02798                                                                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#4e5fb4413a1a185c794176c2311c4076">InternalGoAsFarAsPossibleTowards</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sClosestDisturbance, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (<a class="code" href="Points_8cpp.html#84f116b33524232723bfa74949877c21">MinAPsToAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sClosestDisturbance, ADDTURNCOST) + AP_CROUCH), <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>, FLAG_CAUTIOUS );
<a name="l02799"></a>02799                                                                   <span class="keywordflow">if</span> ( pSoldier-&gt;usActionData != NOWHERE )
<a name="l02800"></a>02800                                                                   {
<a name="l02801"></a>02801                                                                         pSoldier-&gt;fAIFlags |= AI_CAUTIOUS;
<a name="l02802"></a>02802                                                                         pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>;
<a name="l02803"></a>02803                                                                         <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>);
<a name="l02804"></a>02804                                                                   }
<a name="l02805"></a>02805                                                             }
<a name="l02806"></a>02806 
<a name="l02807"></a>02807                                                             <span class="keywordflow">else</span>
<a name="l02808"></a>02808                                                             {
<a name="l02809"></a>02809                                                                   <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>);
<a name="l02810"></a>02810                                                             }
<a name="l02811"></a>02811                                                       }
<a name="l02812"></a>02812                                                       <span class="keywordflow">else</span>
<a name="l02813"></a>02813                                                       {
<a name="l02814"></a>02814                                                             <span class="keywordflow">if</span> ( action == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bba5b17e88e8a05702bcb8540990fe8c2">AI_ACTION_FLANK_LEFT</a> )
<a name="l02815"></a>02815                                                                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5562d9bc4815ba4c0d02e60463ca48fa">lastFlankLeft</a> = TRUE;
<a name="l02816"></a>02816                                                             <span class="keywordflow">else</span>
<a name="l02817"></a>02817                                                                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5562d9bc4815ba4c0d02e60463ca48fa">lastFlankLeft</a> = FALSE;
<a name="l02818"></a>02818 
<a name="l02819"></a>02819                                                             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4b05ad0162c2ca209e5a51fdbf9c4cde">lastFlankSpot</a> != sClosestDisturbance)
<a name="l02820"></a>02820                                                                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a>=0;
<a name="l02821"></a>02821 
<a name="l02822"></a>02822                                           
<a name="l02823"></a>02823                                                             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e2645c74e19c721ccca934e1f73ab1d0">origDir</a> = <a class="code" href="Soldier_01Control_8cpp.html#1d7b6c103ede7e551e76eef2ef173f9b">GetDirectionFromGridNo</a> ( sClosestDisturbance, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l02824"></a>02824                                                             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4b05ad0162c2ca209e5a51fdbf9c4cde">lastFlankSpot</a> = sClosestDisturbance;
<a name="l02825"></a>02825                                                             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b2017bbe002b552f8a510e6f3ff0e788">numFlanks</a>++;
<a name="l02826"></a>02826                                                             <span class="keywordflow">return</span>(action);
<a name="l02827"></a>02827                                                       }
<a name="l02828"></a>02828                                                 }
<a name="l02829"></a>02829                                                 <span class="keywordflow">else</span>
<a name="l02830"></a>02830                                                 {
<a name="l02831"></a>02831                                                       <span class="comment">// let's be a bit cautious about going right up to a location without enough APs to shoot</span>
<a name="l02832"></a>02832                                                       <span class="keywordflow">if</span> ( <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>, sClosestDisturbance ) &lt; 5 || <a class="code" href="LOS_8cpp.html#61eb3622c754f1753756a5ba09bcb1ce">LocationToLocationLineOfSightTest</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, sClosestDisturbance, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) <a class="code" href="opplist_8cpp.html#ce89c9f1017d9a6e473df03acb6f1a2a">MaxDistanceVisible</a>(), TRUE ) )
<a name="l02833"></a>02833                                                       {
<a name="l02834"></a>02834                                                             <span class="comment">// reserve APs for a possible crouch plus a shot</span>
<a name="l02835"></a>02835                                                             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#4e5fb4413a1a185c794176c2311c4076">InternalGoAsFarAsPossibleTowards</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sClosestDisturbance, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (<a class="code" href="Points_8cpp.html#84f116b33524232723bfa74949877c21">MinAPsToAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sClosestDisturbance, ADDTURNCOST) + AP_CROUCH), <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>, FLAG_CAUTIOUS );
<a name="l02836"></a>02836                                                             <span class="keywordflow">if</span> ( pSoldier-&gt;usActionData != NOWHERE )
<a name="l02837"></a>02837                                                             {
<a name="l02838"></a>02838                                                                   pSoldier-&gt;fAIFlags |= AI_CAUTIOUS;
<a name="l02839"></a>02839                                                                   pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>;
<a name="l02840"></a>02840                                                                   <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>);
<a name="l02841"></a>02841                                                             }
<a name="l02842"></a>02842                                                       }
<a name="l02843"></a>02843                                                       <span class="keywordflow">else</span>
<a name="l02844"></a>02844                                                       {
<a name="l02845"></a>02845                                                             <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>);
<a name="l02846"></a>02846                                                       }
<a name="l02847"></a>02847                                                       <span class="keywordflow">break</span>;
<a name="l02848"></a>02848                                                 }
<a name="l02849"></a>02849                                           }
<a name="l02850"></a>02850                                     }
<a name="l02851"></a>02851 
<a name="l02852"></a>02852                                <span class="comment">// mark SEEKING as impossible for next time through while loop</span>
<a name="l02853"></a>02853 <span class="preprocessor">            #ifdef DEBUGDECISIONS</span>
<a name="l02854"></a>02854 <span class="preprocessor"></span>                               <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"couldn't SEEK..."</span>,1000);
<a name="l02855"></a>02855 <span class="preprocessor">            #endif</span>
<a name="l02856"></a>02856 <span class="preprocessor"></span>                               bSeekPts = -99;
<a name="l02857"></a>02857                               DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: couldn't seek"</span>);
<a name="l02858"></a>02858                               }
<a name="l02859"></a>02859 
<a name="l02860"></a>02860                               DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: checking to watch"</span>);
<a name="l02861"></a>02861                          <span class="comment">// if WATCHING is possible and at least as desirable as anything else</span>
<a name="l02862"></a>02862                          <span class="keywordflow">if</span> ((bWatchPts &gt; -90) &amp;&amp; (bWatchPts &gt;= bSeekPts) &amp;&amp; (bWatchPts &gt;= bHelpPts) &amp;&amp; (bWatchPts &gt;= bHidePts ))
<a name="l02863"></a>02863                               {
<a name="l02864"></a>02864                                     <span class="comment">// take a look at our highest watch point... if it's still visible, turn to face it and then wait</span>
<a name="l02865"></a>02865                                     bHighestWatchLoc = <a class="code" href="opplist_8cpp.html#6d74619b5548b5c984d5d9aa28ac0f9d">GetHighestVisibleWatchedLoc</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l02866"></a>02866                                     <span class="comment">//sDistVisible =  DistanceVisible( pSoldier, DIRECTION_IRRELEVANT, DIRECTION_IRRELEVANT, gsWatchedLoc[ pSoldier-&gt;ubID ][ bHighestWatchLoc ], gbWatchedLocLevel[ pSoldier-&gt;ubID ][ bHighestWatchLoc ] );</span>
<a name="l02867"></a>02867                                     <span class="keywordflow">if</span> ( bHighestWatchLoc != -1 )
<a name="l02868"></a>02868                                     {
<a name="l02869"></a>02869                                           <span class="comment">// see if we need turn to face that location</span>
<a name="l02870"></a>02870                                           ubOpponentDir = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>( <a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>( <a class="code" href="opplist_8cpp.html#58ebb31f3328682c61149a086225ae11">gsWatchedLoc</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ][ bHighestWatchLoc ] ),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>( <a class="code" href="opplist_8cpp.html#58ebb31f3328682c61149a086225ae11">gsWatchedLoc</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ][ bHighestWatchLoc ] ) );
<a name="l02871"></a>02871 
<a name="l02872"></a>02872                                           <span class="comment">// if soldier is not already facing in that direction,</span>
<a name="l02873"></a>02873                                           <span class="comment">// and the opponent is close enough that he could possibly be seen                               </span>
<a name="l02874"></a>02874                                           <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> != ubOpponentDir &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubOpponentDir, <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight ) )
<a name="l02875"></a>02875                                           {
<a name="l02876"></a>02876                                                 <span class="comment">// turn</span>
<a name="l02877"></a>02877                                                 <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ubOpponentDir;
<a name="l02878"></a>02878                                                 <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>;
<a name="l02879"></a>02879                                                 <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>);
<a name="l02880"></a>02880                                           }
<a name="l02881"></a>02881                                           <span class="keywordflow">else</span> 
<a name="l02882"></a>02882                                           {
<a name="l02883"></a>02883                                                 <span class="comment">// consider at least crouching</span>
<a name="l02884"></a>02884                                                 <span class="keywordflow">if</span> ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight == ANIM_STAND &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubOpponentDir, ANIM_CROUCH ) )
<a name="l02885"></a>02885                                                 {
<a name="l02886"></a>02886                                                       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_CROUCH;
<a name="l02887"></a>02887                                                       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>;
<a name="l02888"></a>02888                                                       <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a>);
<a name="l02889"></a>02889                                                 }
<a name="l02890"></a>02890                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubHeight != ANIM_PRONE )
<a name="l02891"></a>02891                                                 {
<a name="l02892"></a>02892                                                       <span class="comment">// maybe go prone</span>
<a name="l02893"></a>02893                                                       <span class="keywordflow">if</span> ( <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 2 ) == 0 &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubOpponentDir, ANIM_PRONE ) )
<a name="l02894"></a>02894                                                       {
<a name="l02895"></a>02895                                                             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_PRONE;
<a name="l02896"></a>02896                                                             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>;
<a name="l02897"></a>02897                                                             <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a> );
<a name="l02898"></a>02898                                                       }
<a name="l02899"></a>02899                                                       <span class="comment">// end turn</span>
<a name="l02900"></a>02900                                                       <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a> );
<a name="l02901"></a>02901                                                 }
<a name="l02902"></a>02902                                           }
<a name="l02903"></a>02903 
<a name="l02904"></a>02904                                     }
<a name="l02905"></a>02905 
<a name="l02906"></a>02906                               bWatchPts = -99;
<a name="l02907"></a>02907                               DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: couldn't watch"</span>);
<a name="l02908"></a>02908 
<a name="l02909"></a>02909                               }
<a name="l02910"></a>02910 
<a name="l02911"></a>02911 
<a name="l02912"></a>02912                         DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: checking to help"</span>);
<a name="l02913"></a>02913                          <span class="comment">// if HELPING is possible and at least as desirable as seeking or hiding</span>
<a name="l02914"></a>02914                          <span class="keywordflow">if</span> ((bHelpPts &gt; -90) &amp;&amp; (bHelpPts &gt;= bSeekPts) &amp;&amp; (bHelpPts &gt;= bHidePts) &amp;&amp; (bHelpPts &gt;= bWatchPts ))
<a name="l02915"></a>02915                               {
<a name="l02916"></a>02916 <span class="preprocessor">                               #ifdef AI_TIMING_TESTS</span>
<a name="l02917"></a>02917 <span class="preprocessor"></span>                               uiStartTime = GetJA2Clock();
<a name="l02918"></a>02918 <span class="preprocessor">                               #endif</span>
<a name="l02919"></a>02919 <span class="preprocessor"></span>                               sClosestFriend = <a class="code" href="AIInternals_8h.html#a912803bd2f2f094c178bab0d374120a">ClosestReachableFriendInTrouble</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;fClimb );
<a name="l02920"></a>02920 <span class="preprocessor">                               #ifdef AI_TIMING_TESTS</span>
<a name="l02921"></a>02921 <span class="preprocessor"></span>                               uiEndTime = GetJA2Clock();
<a name="l02922"></a>02922 
<a name="l02923"></a>02923                                     <a class="code" href="Items_8cpp.html#f98f048b9ccbbf94ea276e610dcd8a97">guiRedHelpTimeTotal</a> += (uiEndTime - uiStartTime);
<a name="l02924"></a>02924                                     <a class="code" href="Items_8cpp.html#5a9e2216edcc54e5c22b8fb35f816a25">guiRedHelpCounter</a>++;
<a name="l02925"></a>02925 <span class="preprocessor">                               #endif</span>
<a name="l02926"></a>02926 <span class="preprocessor"></span>
<a name="l02927"></a>02927                                <span class="keywordflow">if</span> (sClosestFriend != NOWHERE)
<a name="l02928"></a>02928                                     {<span class="comment"></span>
<a name="l02929"></a>02929 <span class="comment">                                     //////////////////////////////////////////////////////////////////////</span>
<a name="l02930"></a>02930 <span class="comment"></span>                                     <span class="comment">// GO DIRECTLY TOWARDS CLOSEST FRIEND UNDER FIRE OR WHO LAST RADIOED</span><span class="comment"></span>
<a name="l02931"></a>02931 <span class="comment">                                     //////////////////////////////////////////////////////////////////////</span>
<a name="l02932"></a>02932 <span class="comment"></span>                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#4e5fb4413a1a185c794176c2311c4076">InternalGoAsFarAsPossibleTowards</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,sClosestFriend,AP_CROUCH, <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b01292ef8325186441f8962aa82c84358">AI_ACTION_SEEK_OPPONENT</a>,0);
<a name="l02933"></a>02933 
<a name="l02934"></a>02934                                      <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l02935"></a>02935                                           {
<a name="l02936"></a>02936 <span class="preprocessor">                                                #ifdef DEBUGDECISIONS</span>
<a name="l02937"></a>02937 <span class="preprocessor"></span>                                                             sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - SEEKING FRIEND at %d, MOVING to %d"</span>,
<a name="l02938"></a>02938                                                                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,sClosestFriend,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l02939"></a>02939                                                              <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l02940"></a>02940 <span class="preprocessor">                                                #endif</span>
<a name="l02941"></a>02941 <span class="preprocessor"></span>
<a name="l02942"></a>02942                                                 <span class="keywordflow">if</span> ( fClimb )<span class="comment">//&amp;&amp; pSoldier-&gt;usActionData == sClosestFriend)</span>
<a name="l02943"></a>02943                                                 {
<a name="l02944"></a>02944                                                       <span class="comment">// need to climb AND have enough APs to get there this turn</span>
<a name="l02945"></a>02945                                                       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fUp = TRUE;
<a name="l02946"></a>02946                                                       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> &gt; 0 )
<a name="l02947"></a>02947                                                             fUp = FALSE;
<a name="l02948"></a>02948 
<a name="l02949"></a>02949                                                       <span class="keywordflow">if</span> (!fUp)
<a name="l02950"></a>02950                                                             DebugMsg ( <a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a> , DBG_LEVEL_3 , <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Soldier %d is climbing down"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>) );
<a name="l02951"></a>02951 
<a name="l02952"></a>02952                                                       <span class="keywordflow">if</span> ( <a class="code" href="ai_8h.html#c0ab3ab9291c1447f10a520aeb33cbd5">CanClimbFromHere</a> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, fUp ) )
<a name="l02953"></a>02953                                                       {
<a name="l02954"></a>02954                                                             <span class="keywordflow">if</span> (<a class="code" href="ai_8h.html#dd5730a3e85127b7590031d7580277b0">IsActionAffordable</a>(pSoldier) &amp;&amp; pSoldier-&gt;bActionPoints &gt;= ( AP_CLIMBROOF + <a class="code" href="Points_8cpp.html#84f116b33524232723bfa74949877c21">MinAPsToAttack</a>( pSoldier, sClosestFriend, ADDTURNCOST)))
<a name="l02955"></a>02955                                                             {
<a name="l02956"></a>02956                                                                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bf0d31a9fac3e900acf35ca5832cd876e">AI_ACTION_CLIMB_ROOF</a> );
<a name="l02957"></a>02957                                                             }
<a name="l02958"></a>02958                                                       }
<a name="l02959"></a>02959                                                       <span class="keywordflow">else</span>
<a name="l02960"></a>02960                                                       {
<a name="l02961"></a>02961                                                             pSoldier-&gt;usActionData = <a class="code" href="ai_8h.html#c3a9539676bbf7e786da9f3bec8406da">FindClosestClimbPoint</a>(pSoldier-&gt;sGridNo , sClosestFriend , fUp );
<a name="l02962"></a>02962                                                             <span class="keywordflow">if</span> ( pSoldier-&gt;usActionData != NOWHERE )
<a name="l02963"></a>02963                                                             {
<a name="l02964"></a>02964                                                                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4ca31547c6e6eeadec11ea94b7a9fd07">AI_ACTION_MOVE_TO_CLIMB</a>  );
<a name="l02965"></a>02965                                                             }
<a name="l02966"></a>02966                                                       }
<a name="l02967"></a>02967                                                 }
<a name="l02968"></a>02968                                                 <span class="comment">//if (fClimb &amp;&amp; pSoldier-&gt;usActionData == sClosestFriend)</span>
<a name="l02969"></a>02969                                                 <span class="comment">//{</span>
<a name="l02970"></a>02970                                                 <span class="comment">// return( AI_ACTION_CLIMB_ROOF );</span>
<a name="l02971"></a>02971                                                 <span class="comment">//}</span>
<a name="l02972"></a>02972                                                 <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b42b12b1204c797182c2f7c35dbf84fc3">AI_ACTION_SEEK_FRIEND</a>);
<a name="l02973"></a>02973                                           }
<a name="l02974"></a>02974                                     }
<a name="l02975"></a>02975 
<a name="l02976"></a>02976                          <span class="comment">// mark SEEKING as impossible for next time through while loop</span>
<a name="l02977"></a>02977 <span class="preprocessor">            #ifdef DEBUGDECISIONS</span>
<a name="l02978"></a>02978 <span class="preprocessor"></span>                               <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"couldn't HELP..."</span>,1000);
<a name="l02979"></a>02979 <span class="preprocessor">            #endif</span>
<a name="l02980"></a>02980 <span class="preprocessor"></span>
<a name="l02981"></a>02981                               DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: couldn't help"</span>);
<a name="l02982"></a>02982                                bHelpPts = -99;
<a name="l02983"></a>02983                               }
<a name="l02984"></a>02984 
<a name="l02985"></a>02985 
<a name="l02986"></a>02986                         DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: checking to hide"</span>);
<a name="l02987"></a>02987                          <span class="comment">// if HIDING is possible and at least as desirable as seeking or helping</span>
<a name="l02988"></a>02988                          <span class="keywordflow">if</span> ((bHidePts &gt; -90) &amp;&amp; (bHidePts &gt;= bSeekPts) &amp;&amp; (bHidePts &gt;= bHelpPts) &amp;&amp; (bHidePts &gt;= bWatchPts ))
<a name="l02989"></a>02989                               {
<a name="l02990"></a>02990                                     sClosestOpponent = <a class="code" href="ai_8h.html#447fb8df3bebba1c378077777fe98b8d">ClosestKnownOpponent</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, NULL, NULL );
<a name="l02991"></a>02991                                <span class="comment">// if an opponent is known (not necessarily reachable or conscious)</span>
<a name="l02992"></a>02992                                <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#73a8d5c2a31d1969d497d7daf60b16f3">SkipCoverCheck</a> &amp;&amp; sClosestOpponent != NOWHERE )
<a name="l02993"></a>02993                                     {<span class="comment"></span>
<a name="l02994"></a>02994 <span class="comment">                                           //////////////////////////////////////////////////////////////////////</span>
<a name="l02995"></a>02995 <span class="comment"></span>                                           <span class="comment">// TAKE BEST NEARBY COVER FROM ALL KNOWN OPPONENTS</span><span class="comment"></span>
<a name="l02996"></a>02996 <span class="comment">                                           //////////////////////////////////////////////////////////////////////</span>
<a name="l02997"></a>02997 <span class="comment"></span><span class="preprocessor">                                          #ifdef AI_TIMING_TESTS</span>
<a name="l02998"></a>02998 <span class="preprocessor"></span>                                          uiStartTime = GetJA2Clock();
<a name="l02999"></a>02999 <span class="preprocessor">                                          #endif</span>
<a name="l03000"></a>03000 <span class="preprocessor"></span>
<a name="l03001"></a>03001                                            <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#0b7c3b2ba83ca87cfa5a3ebc680471a2">FindBestNearbyCover</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a>,&amp;iDummy);
<a name="l03002"></a>03002 <span class="preprocessor">                                          #ifdef AI_TIMING_TESTS</span>
<a name="l03003"></a>03003 <span class="preprocessor"></span>                                          uiEndTime = GetJA2Clock();
<a name="l03004"></a>03004 
<a name="l03005"></a>03005                                           <a class="code" href="Items_8cpp.html#f284d07c6ff0aade0111b945a808cd7e">guiRedHideTimeTotal</a> += (uiEndTime - uiStartTime);
<a name="l03006"></a>03006                                           <a class="code" href="Items_8cpp.html#a045a781ee61a69bbdf9eb56e1ff9721">guiRedHideCounter</a>++;
<a name="l03007"></a>03007 <span class="preprocessor">                                          #endif</span>
<a name="l03008"></a>03008 <span class="preprocessor"></span>
<a name="l03009"></a>03009                                           <span class="comment">// let's be a bit cautious about going right up to a location without enough APs to shoot</span>
<a name="l03010"></a>03010                                           <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE )
<a name="l03011"></a>03011                                           {
<a name="l03012"></a>03012                                                 sClosestDisturbance = <a class="code" href="AIInternals_8h.html#bdbd82cec2627ae4973f5e8e4f897451">ClosestReachableDisturbance</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubUnconsciousOK, &amp;fClimb);
<a name="l03013"></a>03013                                                 <span class="keywordflow">if</span> ( sClosestDisturbance != NOWHERE &amp;&amp; ( <a class="code" href="Isometric_01Utils_8cpp.html#94dc29a40d3702f9d4d8ad35dc8e457c">SpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>, sClosestDisturbance ) &lt; 5 || <a class="code" href="Isometric_01Utils_8cpp.html#94dc29a40d3702f9d4d8ad35dc8e457c">SpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>, sClosestDisturbance ) + 5 &lt; <a class="code" href="Isometric_01Utils_8cpp.html#94dc29a40d3702f9d4d8ad35dc8e457c">SpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, sClosestDisturbance ) ) )
<a name="l03014"></a>03014                                                 {
<a name="l03015"></a>03015                                                       <span class="comment">// either moving significantly closer or into very close range</span>
<a name="l03016"></a>03016                                                       <span class="comment">// ensure will we have enough APs for a possible crouch plus a shot</span>
<a name="l03017"></a>03017                                                       <span class="keywordflow">if</span> ( <a class="code" href="AIInternals_8h.html#4e5fb4413a1a185c794176c2311c4076">InternalGoAsFarAsPossibleTowards</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, pSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (<a class="code" href="Points_8cpp.html#84f116b33524232723bfa74949877c21">MinAPsToAttack</a>( pSoldier, sClosestOpponent, ADDTURNCOST) + AP_CROUCH), <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bd2358f4f3b1cd379c943855df803496d">AI_ACTION_TAKE_COVER</a>, 0 ) == pSoldier-&gt;usActionData )
<a name="l03018"></a>03018                                                       {
<a name="l03019"></a>03019                                                             <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bd2358f4f3b1cd379c943855df803496d">AI_ACTION_TAKE_COVER</a>);
<a name="l03020"></a>03020                                                       }
<a name="l03021"></a>03021                                                 }
<a name="l03022"></a>03022                                                 <span class="keywordflow">else</span>
<a name="l03023"></a>03023                                                 {
<a name="l03024"></a>03024                                                       <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bd2358f4f3b1cd379c943855df803496d">AI_ACTION_TAKE_COVER</a>);
<a name="l03025"></a>03025                                                 }
<a name="l03026"></a>03026                                           }
<a name="l03027"></a>03027 
<a name="l03028"></a>03028                                     }
<a name="l03029"></a>03029 
<a name="l03030"></a>03030                                <span class="comment">// mark HIDING as impossible for next time through while loop</span>
<a name="l03031"></a>03031 <span class="preprocessor">            #ifdef DEBUGDECISIONS</span>
<a name="l03032"></a>03032 <span class="preprocessor"></span>                               <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"couldn't HIDE..."</span>,1000);
<a name="l03033"></a>03033 <span class="preprocessor">            #endif</span>
<a name="l03034"></a>03034 <span class="preprocessor"></span>
<a name="l03035"></a>03035                                bHidePts = -99;
<a name="l03036"></a>03036                               DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: couldn't hide"</span>);
<a name="l03037"></a>03037                               }
<a name="l03038"></a>03038                         }
<a name="l03039"></a>03039                   }
<a name="l03040"></a>03040             DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: nothing to do!"</span>);<span class="comment"></span>
<a name="l03041"></a>03041 <span class="comment">             ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03042"></a>03042 <span class="comment"></span>             <span class="comment">// NOTHING USEFUL POSSIBLE!  IF NPC IS CURRENTLY UNDER FIRE, TRY TO RUN AWAY</span><span class="comment"></span>
<a name="l03043"></a>03043 <span class="comment">             ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03044"></a>03044 <span class="comment"></span>
<a name="l03045"></a>03045              <span class="comment">// if we're currently under fire (presumably, attacker is hidden)</span>
<a name="l03046"></a>03046              <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4d7d451394eccbed289b3276bc325722">bUnderFire</a> || fCivilian)
<a name="l03047"></a>03047                   {
<a name="l03048"></a>03048                    <span class="comment">// only try to run if we've actually been hit recently &amp; noticably so</span>
<a name="l03049"></a>03049                    <span class="comment">// otherwise, presumably our current cover is pretty good &amp; sufficient</span>
<a name="l03050"></a>03050                    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f9d318c8e6c8f11cf39d8c039f24858a">bShock</a> &gt; 0 || fCivilian)
<a name="l03051"></a>03051                         {
<a name="l03052"></a>03052                          <span class="comment">// look for best place to RUN AWAY to (farthest from the closest threat)</span>
<a name="l03053"></a>03053                          <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#eb3ffb28e50d84917771661b9d91aa51">FindSpotMaxDistFromOpponents</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l03054"></a>03054 
<a name="l03055"></a>03055                          <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l03056"></a>03056                               {
<a name="l03057"></a>03057 <span class="preprocessor">            #ifdef DEBUGDECISIONS</span>
<a name="l03058"></a>03058 <span class="preprocessor"></span>                               sprintf((CHAR *)tempstr,<span class="stringliteral">"%s RUNNING AWAY to grid %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l03059"></a>03059                                <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l03060"></a>03060 <span class="preprocessor">            #endif</span>
<a name="l03061"></a>03061 <span class="preprocessor"></span>
<a name="l03062"></a>03062                               DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: run away!"</span>);
<a name="l03063"></a>03063                                <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950be1338b9c498abc9dd4b86d1b22291b12">AI_ACTION_RUN_AWAY</a>);
<a name="l03064"></a>03064                               }
<a name="l03065"></a>03065                         }
<a name="l03066"></a>03066 
<a name="l03067"></a>03067 <span class="comment"></span>
<a name="l03068"></a>03068 <span class="comment">                   ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03069"></a>03069 <span class="comment"></span>                   <span class="comment">// UNDER FIRE, DON'T WANNA/CAN'T RUN AWAY, SO CROUCH</span><span class="comment"></span>
<a name="l03070"></a>03070 <span class="comment">                   ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03071"></a>03071 <span class="comment"></span>
<a name="l03072"></a>03072 
<a name="l03073"></a>03073                   DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: crouch or go prone"</span>);
<a name="l03074"></a>03074                    <span class="comment">// if not in water and not already crouched</span>
<a name="l03075"></a>03075                    <span class="keywordflow">if</span> (!fCivilian )
<a name="l03076"></a>03076                    {
<a name="l03077"></a>03077                         <span class="keywordflow">if</span> ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubHeight == ANIM_STAND &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#419164836f72332cc058fa70ace03b47">IsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_CROUCH ) )
<a name="l03078"></a>03078                         {
<a name="l03079"></a>03079                               <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#69f88541b84e4d9890e0b786199e9a3a">GetAPsToChangeStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_CROUCH ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l03080"></a>03080                               {
<a name="l03081"></a>03081 
<a name="l03082"></a>03082 <span class="preprocessor">            #ifdef DEBUGDECISIONS</span>
<a name="l03083"></a>03083 <span class="preprocessor"></span>                         sprintf((CHAR *)tempstr,<span class="stringliteral">"%s CROUCHES (STATUS RED)"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>);
<a name="l03084"></a>03084                          <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l03085"></a>03085 <span class="preprocessor">            #endif</span>
<a name="l03086"></a>03086 <span class="preprocessor"></span>
<a name="l03087"></a>03087                                <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_CROUCH;
<a name="l03088"></a>03088                                <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a>);
<a name="l03089"></a>03089                               }
<a name="l03090"></a>03090                         }
<a name="l03091"></a>03091                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubHeight != ANIM_PRONE )
<a name="l03092"></a>03092                         {
<a name="l03093"></a>03093                               <span class="comment">// maybe go prone</span>
<a name="l03094"></a>03094                               <span class="keywordflow">if</span> ( <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 2 ) == 0 &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#419164836f72332cc058fa70ace03b47">IsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_PRONE ) )
<a name="l03095"></a>03095                               {
<a name="l03096"></a>03096                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_PRONE;
<a name="l03097"></a>03097                                     <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a> );
<a name="l03098"></a>03098                               }
<a name="l03099"></a>03099 
<a name="l03100"></a>03100                         }
<a name="l03101"></a>03101                    }
<a name="l03102"></a>03102                   }
<a name="l03103"></a>03103       }
<a name="l03104"></a>03104 
<a name="l03105"></a>03105 
<a name="l03106"></a>03106       DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionred: look around towards opponent"</span>);<span class="comment"></span>
<a name="l03107"></a>03107 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03108"></a>03108 <span class="comment"></span> <span class="comment">// LOOK AROUND TOWARD CLOSEST KNOWN OPPONENT, IF KNOWN</span><span class="comment"></span>
<a name="l03109"></a>03109 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03110"></a>03110 <span class="comment"></span>
<a name="l03111"></a>03111       <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#9f252be6995e21dcbda09f03c7cf5253">GetAPsToLook</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l03112"></a>03112       {
<a name="l03113"></a>03113        <span class="comment">// determine the location of the known closest opponent</span>
<a name="l03114"></a>03114        <span class="comment">// (don't care if he's conscious, don't care if he's reachable at all)</span>
<a name="l03115"></a>03115        sClosestOpponent = <a class="code" href="ai_8h.html#447fb8df3bebba1c378077777fe98b8d">ClosestKnownOpponent</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, NULL, NULL);
<a name="l03116"></a>03116 
<a name="l03117"></a>03117        <span class="keywordflow">if</span> (sClosestOpponent != NOWHERE)
<a name="l03118"></a>03118             {
<a name="l03119"></a>03119              <span class="comment">// determine direction from this soldier to the closest opponent</span>
<a name="l03120"></a>03120              ubOpponentDir = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>(<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(sClosestOpponent),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(sClosestOpponent));
<a name="l03121"></a>03121 
<a name="l03122"></a>03122              <span class="comment">// if soldier is not already facing in that direction,</span>
<a name="l03123"></a>03123              <span class="comment">// and the opponent is close enough that he could possibly be seen</span>
<a name="l03124"></a>03124              <span class="comment">// note, have to change this to use the level returned from ClosestKnownOpponent</span>
<a name="l03125"></a>03125              sDistVisible = <a class="code" href="opplist_8cpp.html#3024b66f9b450ab359bf03734c3aad9b">DistanceVisible</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7680b9f541cb30851967400ce4b0f2807">DIRECTION_IRRELEVANT</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7680b9f541cb30851967400ce4b0f2807">DIRECTION_IRRELEVANT</a>, sClosestOpponent, 0, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l03126"></a>03126 
<a name="l03127"></a>03127              <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> != ubOpponentDir) &amp;&amp; (<a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>,sClosestOpponent) &lt;= sDistVisible))
<a name="l03128"></a>03128                   {
<a name="l03129"></a>03129                    <span class="comment">// set base chance according to orders</span>
<a name="l03130"></a>03130                    <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>) || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>))
<a name="l03131"></a>03131                          iChance = 50;
<a name="l03132"></a>03132                    <span class="keywordflow">else</span>           <span class="comment">// all other orders</span>
<a name="l03133"></a>03133                          iChance = 25;
<a name="l03134"></a>03134 
<a name="l03135"></a>03135                    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a> == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>)
<a name="l03136"></a>03136                          iChance += 25;
<a name="l03137"></a>03137 
<a name="l03138"></a>03138                    <span class="keywordflow">if</span> ( TANK( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l03139"></a>03139                    {
<a name="l03140"></a>03140                         iChance += 50;
<a name="l03141"></a>03141                    }
<a name="l03142"></a>03142 
<a name="l03143"></a>03143                    <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubOpponentDir, <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight ) )
<a name="l03144"></a>03144                         {
<a name="l03145"></a>03145                          <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ubOpponentDir;
<a name="l03146"></a>03146 
<a name="l03147"></a>03147 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l03148"></a>03148 <span class="preprocessor"></span>                         sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - TURNS TOWARDS CLOSEST ENEMY to face direction %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l03149"></a>03149                          <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l03150"></a>03150 <span class="preprocessor">      #endif</span>
<a name="l03151"></a>03151 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> )
<a name="l03152"></a>03152                         {
<a name="l03153"></a>03153                               <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#79d7f90b12d50906a6f34bee3ac1d28d">GetAPsToReadyWeapon</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb1b732af1789afff77e503d30253b84d6">READY_RIFLE_CROUCH</a> ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l03154"></a>03154                               {
<a name="l03155"></a>03155                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950ba91f358173f4ebb4c9d9c071642b8159">AI_ACTION_RAISE_GUN</a>;
<a name="l03156"></a>03156                               }
<a name="l03157"></a>03157                         }
<a name="l03158"></a>03158 
<a name="l03159"></a>03159                          <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>);
<a name="l03160"></a>03160                         }
<a name="l03161"></a>03161                   }
<a name="l03162"></a>03162              <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> == ubOpponentDir &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> )
<a name="l03163"></a>03163              {
<a name="l03164"></a>03164                    <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#79d7f90b12d50906a6f34bee3ac1d28d">GetAPsToReadyWeapon</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb1b732af1789afff77e503d30253b84d6">READY_RIFLE_CROUCH</a> ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l03165"></a>03165                   {
<a name="l03166"></a>03166                         <span class="keywordflow">return</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950ba91f358173f4ebb4c9d9c071642b8159">AI_ACTION_RAISE_GUN</a>;
<a name="l03167"></a>03167                   }
<a name="l03168"></a>03168              }
<a name="l03169"></a>03169             }
<a name="l03170"></a>03170       }
<a name="l03171"></a>03171 
<a name="l03172"></a>03172       <span class="keywordflow">if</span> ( TANK( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l03173"></a>03173       {
<a name="l03174"></a>03174             <span class="comment">// try turning in a random direction as we still can't see anyone.</span>
<a name="l03175"></a>03175             <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#9f252be6995e21dcbda09f03c7cf5253">GetAPsToLook</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l03176"></a>03176             {
<a name="l03177"></a>03177                   sClosestDisturbance = <a class="code" href="AIInternals_8h.html#774611f6beecaa6455887e3b463833c4">MostImportantNoiseHeard</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, NULL, NULL, NULL );
<a name="l03178"></a>03178                   <span class="keywordflow">if</span> ( sClosestDisturbance != NOWHERE )
<a name="l03179"></a>03179                   {
<a name="l03180"></a>03180                         ubOpponentDir = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>( <a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ), <a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ), <a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>( sClosestDisturbance ), <a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>( sClosestDisturbance ) );
<a name="l03181"></a>03181                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> == ubOpponentDir )
<a name="l03182"></a>03182                         {
<a name="l03183"></a>03183                               ubOpponentDir = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b705a523f21006762cabafc28b9f36a34d">NUM_WORLD_DIRECTIONS</a> );
<a name="l03184"></a>03184                         }
<a name="l03185"></a>03185                   }
<a name="l03186"></a>03186                   <span class="keywordflow">else</span>
<a name="l03187"></a>03187                   {
<a name="l03188"></a>03188                         ubOpponentDir = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b705a523f21006762cabafc28b9f36a34d">NUM_WORLD_DIRECTIONS</a> );
<a name="l03189"></a>03189                   }
<a name="l03190"></a>03190 
<a name="l03191"></a>03191                   <span class="keywordflow">if</span> ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> != ubOpponentDir) )
<a name="l03192"></a>03192                   {
<a name="l03193"></a>03193                         <span class="keywordflow">if</span> ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7b0593c9a8052ede05e98cc24c2d9667">bInitialActionPoints</a> || (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; 60) &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubOpponentDir, <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight ) )
<a name="l03194"></a>03194                         {
<a name="l03195"></a>03195                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ubOpponentDir;
<a name="l03196"></a>03196 
<a name="l03197"></a>03197 <span class="preprocessor">                              #ifdef DEBUGDECISIONS</span>
<a name="l03198"></a>03198 <span class="preprocessor"></span>                              sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - TURNS TOWARDS CLOSEST ENEMY to face direction %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l03199"></a>03199                               <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l03200"></a>03200 <span class="preprocessor">                              #endif</span>
<a name="l03201"></a>03201 <span class="preprocessor"></span>
<a name="l03202"></a>03202                               <span class="comment">// limit turning a bit... if the last thing we did was also a turn, add a 60% chance of this being our last turn</span>
<a name="l03203"></a>03203                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a> &amp;&amp; <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 100 ) &lt; 60 )
<a name="l03204"></a>03204                               {
<a name="l03205"></a>03205                                     <span class="keywordflow">if</span> ( <a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> )
<a name="l03206"></a>03206                                     {
<a name="l03207"></a>03207                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>;
<a name="l03208"></a>03208                                     }
<a name="l03209"></a>03209                                     <span class="keywordflow">else</span>
<a name="l03210"></a>03210                                     {
<a name="l03211"></a>03211                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b950fcb4c5e905eec90567c3b751f2534">AI_ACTION_WAIT</a>;
<a name="l03212"></a>03212                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) REALTIME_AI_DELAY;
<a name="l03213"></a>03213                                     }                             
<a name="l03214"></a>03214                               }
<a name="l03215"></a>03215 
<a name="l03216"></a>03216                               <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>);
<a name="l03217"></a>03217                         }
<a name="l03218"></a>03218                   }
<a name="l03219"></a>03219             }
<a name="l03220"></a>03220 
<a name="l03221"></a>03221             <span class="comment">// that's it for tanks</span>
<a name="l03222"></a>03222             <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l03223"></a>03223       }
<a name="l03224"></a>03224 <span class="comment"></span>
<a name="l03225"></a>03225 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03226"></a>03226 <span class="comment"></span>      <span class="comment">// LEAVE THE SECTOR</span><span class="comment"></span>
<a name="l03227"></a>03227 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03228"></a>03228 <span class="comment"></span>
<a name="l03229"></a>03229       <span class="comment">// NOT IMPLEMENTED</span>
<a name="l03230"></a>03230 
<a name="l03231"></a>03231 <span class="comment"></span>
<a name="l03232"></a>03232 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03233"></a>03233 <span class="comment"></span>      <span class="comment">// PICKUP A NEARBY ITEM THAT'S USEFUL</span><span class="comment"></span>
<a name="l03234"></a>03234 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03235"></a>03235 <span class="comment"></span>
<a name="l03236"></a>03236       <span class="keywordflow">if</span> ( ubCanMove &amp;&amp; !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a> &amp;&amp; (<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == ENEMY_TEAM ) )
<a name="l03237"></a>03237       {
<a name="l03238"></a>03238 
<a name="l03239"></a>03239             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="Militia_01Control_8cpp.html#7ee7b5c7c05a10bfb5dfab1c9ee6685a">SearchForItems</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="AIInternals_8h.html#a9365ee5e8ef57a5b8a3365ecf7cefa8f4fad28355929b465b5b3874931b9ee6">SEARCH_GENERAL_ITEMS</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].usItem );
<a name="l03240"></a>03240 
<a name="l03241"></a>03241             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>)
<a name="l03242"></a>03242             {
<a name="l03243"></a>03243                   <span class="keywordflow">return</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> );
<a name="l03244"></a>03244             }
<a name="l03245"></a>03245       }
<a name="l03246"></a>03246 
<a name="l03247"></a>03247 
<a name="l03248"></a>03248 <span class="comment"></span>
<a name="l03249"></a>03249 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03250"></a>03250 <span class="comment"></span>      <span class="comment">// SEEK CLOSEST FRIENDLY MEDIC</span><span class="comment"></span>
<a name="l03251"></a>03251 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03252"></a>03252 <span class="comment"></span>
<a name="l03253"></a>03253       <span class="comment">// NOT IMPLEMENTED</span>
<a name="l03254"></a>03254 
<a name="l03255"></a>03255 <span class="comment"></span>
<a name="l03256"></a>03256 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03257"></a>03257 <span class="comment"></span>      <span class="comment">// GIVE FIRST AID TO A NEARBY INJURED/DYING FRIEND</span><span class="comment"></span>
<a name="l03258"></a>03258 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03259"></a>03259 <span class="comment"></span>      <span class="comment">// - must be BRAVEAID or CUNNINGAID (medic) ?</span>
<a name="l03260"></a>03260 
<a name="l03261"></a>03261       <span class="comment">// NOT IMPLEMENTED</span>
<a name="l03262"></a>03262 
<a name="l03263"></a>03263 <span class="comment">/* JULY 29, 1996 - Decided that this was a bad idea, after watching a civilian</span>
<a name="l03264"></a>03264 <span class="comment">   start a random patrol while 2 steps away from a hidden armed opponent...*/</span>
<a name="l03265"></a>03265 <span class="comment"></span>
<a name="l03266"></a>03266 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03267"></a>03267 <span class="comment"></span>      <span class="comment">// SWITCH TO GREEN: soldier does ordinary regular patrol, seeks friends</span><span class="comment"></span>
<a name="l03268"></a>03268 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03269"></a>03269 <span class="comment"></span>
<a name="l03270"></a>03270       <span class="comment">// if not in combat or under fire, and we COULD have moved, just chose not to</span>
<a name="l03271"></a>03271       <span class="keywordflow">if</span> ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> != <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532cb7890b45734e38021cf4022c1f24e2">STATUS_BLACK</a>) &amp;&amp; !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4d7d451394eccbed289b3276bc325722">bUnderFire</a> &amp;&amp; ubCanMove &amp;&amp; (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7b0593c9a8052ede05e98cc24c2d9667">bInitialActionPoints</a>) &amp;&amp; ( <a class="code" href="AIInternals_8h.html#bdbd82cec2627ae4973f5e8e4f897451">ClosestReachableDisturbance</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, TRUE, &amp;fClimb) == NOWHERE) )
<a name="l03272"></a>03272       {
<a name="l03273"></a>03273             <span class="comment">// addition:  if soldier is bleeding then reduce bleeding and do nothing</span>
<a name="l03274"></a>03274             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1db22145597bf0cc6ace573851b46164">bBleeding</a> &gt; MIN_BLEEDING_THRESHOLD )
<a name="l03275"></a>03275             {
<a name="l03276"></a>03276                   <span class="comment">// reduce bleeding by 1 point per AP (in RT, APs will get recalculated so it's okay)</span>
<a name="l03277"></a>03277                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1db22145597bf0cc6ace573851b46164">bBleeding</a> = __max( 0, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1db22145597bf0cc6ace573851b46164">bBleeding</a> - <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> );
<a name="l03278"></a>03278                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> ); <span class="comment">// will end-turn/wait depending on whether we're in TB or realtime</span>
<a name="l03279"></a>03279             }
<a name="l03280"></a>03280 <span class="preprocessor">#ifdef RECORDNET</span>
<a name="l03281"></a>03281 <span class="preprocessor"></span>            fprintf(NetDebugFile,<span class="stringliteral">"\tDecideActionRed: guynum %d switching to GREEN AI...\n"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>);
<a name="l03282"></a>03282 <span class="preprocessor">#endif</span>
<a name="l03283"></a>03283 <span class="preprocessor"></span>
<a name="l03284"></a>03284 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l03285"></a>03285 <span class="preprocessor"></span>            <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"- chose to SKIP all RED actions, BYPASSES to GREEN!"</span>,1000);
<a name="l03286"></a>03286 <span class="preprocessor">#endif</span>
<a name="l03287"></a>03287 <span class="preprocessor"></span>
<a name="l03288"></a>03288             <span class="comment">// Skip RED until new situation/next turn, 30% extra chance to do GREEN actions</span>
<a name="l03289"></a>03289             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f72e7e4bdc35542eca5402ce5329de32">bBypassToGreen</a> = 30;
<a name="l03290"></a>03290             <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#ace6b78fb0a875c61b79ba65193f0d04">DecideActionGreen</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>));
<a name="l03291"></a>03291       }
<a name="l03292"></a>03292 
<a name="l03293"></a>03293 <span class="comment"></span>
<a name="l03294"></a>03294 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03295"></a>03295 <span class="comment"></span>      <span class="comment">// CROUCH IF NOT CROUCHING ALREADY</span><span class="comment"></span>
<a name="l03296"></a>03296 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03297"></a>03297 <span class="comment"></span>
<a name="l03298"></a>03298       <span class="comment">// if not in water and not already crouched, try to crouch down first</span>
<a name="l03299"></a>03299       <span class="keywordflow">if</span> (!fCivilian &amp;&amp; !bInWater &amp;&amp; (<a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubHeight == ANIM_STAND) &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#419164836f72332cc058fa70ace03b47">IsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_CROUCH ) )
<a name="l03300"></a>03300       {
<a name="l03301"></a>03301             sClosestOpponent = <a class="code" href="ai_8h.html#447fb8df3bebba1c378077777fe98b8d">ClosestKnownOpponent</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, NULL, NULL);
<a name="l03302"></a>03302 
<a name="l03303"></a>03303             <span class="keywordflow">if</span> ( (sClosestOpponent != NOWHERE &amp;&amp; <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, sClosestOpponent ) &lt; (<a class="code" href="opplist_8cpp.html#ce89c9f1017d9a6e473df03acb6f1a2a">MaxDistanceVisible</a>() * 3) / 2 ) || <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 4 ) == 0 )
<a name="l03304"></a>03304             {
<a name="l03305"></a>03305                   <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#69f88541b84e4d9890e0b786199e9a3a">GetAPsToChangeStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_CROUCH ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l03306"></a>03306                   {
<a name="l03307"></a>03307       
<a name="l03308"></a>03308 <span class="preprocessor">                        #ifdef DEBUGDECISIONS</span>
<a name="l03309"></a>03309 <span class="preprocessor"></span>                        sprintf((CHAR *)tempstr,<span class="stringliteral">"%s CROUCHES (STATUS RED)"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a> );
<a name="l03310"></a>03310                         <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l03311"></a>03311 <span class="preprocessor">                        #endif</span>
<a name="l03312"></a>03312 <span class="preprocessor"></span>
<a name="l03313"></a>03313                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_CROUCH;
<a name="l03314"></a>03314                         <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a>);
<a name="l03315"></a>03315                   }
<a name="l03316"></a>03316             }
<a name="l03317"></a>03317       }
<a name="l03318"></a>03318 <span class="comment"></span>
<a name="l03319"></a>03319 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03320"></a>03320 <span class="comment"></span>      <span class="comment">// IF UNDER FIRE, FACE THE MOST IMPORTANT NOISE WE KNOW AND GO PRONE</span><span class="comment"></span>
<a name="l03321"></a>03321 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03322"></a>03322 <span class="comment"></span>
<a name="l03323"></a>03323       <span class="keywordflow">if</span> ( !fCivilian &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4d7d451394eccbed289b3276bc325722">bUnderFire</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt;= (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7b0593c9a8052ede05e98cc24c2d9667">bInitialActionPoints</a> - <a class="code" href="Points_8cpp.html#9f252be6995e21dcbda09f03c7cf5253">GetAPsToLook</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) ) &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#419164836f72332cc058fa70ace03b47">IsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_PRONE ) )
<a name="l03324"></a>03324       {
<a name="l03325"></a>03325             sClosestDisturbance = <a class="code" href="AIInternals_8h.html#774611f6beecaa6455887e3b463833c4">MostImportantNoiseHeard</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, NULL, NULL, NULL );
<a name="l03326"></a>03326             <span class="keywordflow">if</span> ( sClosestDisturbance != NOWHERE )
<a name="l03327"></a>03327             {
<a name="l03328"></a>03328                   ubOpponentDir = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>( <a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ), <a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ), <a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>( sClosestDisturbance ), <a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>( sClosestDisturbance ) );
<a name="l03329"></a>03329                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> != ubOpponentDir )
<a name="l03330"></a>03330                   {
<a name="l03331"></a>03331                         <span class="keywordflow">if</span> ( !<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#9f252be6995e21dcbda09f03c7cf5253">GetAPsToLook</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> )
<a name="l03332"></a>03332                         {
<a name="l03333"></a>03333                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ubOpponentDir;
<a name="l03334"></a>03334                               <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a> );
<a name="l03335"></a>03335                         }
<a name="l03336"></a>03336                   }
<a name="l03337"></a>03337                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#69f88541b84e4d9890e0b786199e9a3a">GetAPsToChangeStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_PRONE ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> ) &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubOpponentDir, ANIM_PRONE ) )
<a name="l03338"></a>03338                   {
<a name="l03339"></a>03339                         <span class="comment">// go prone, end turn</span>
<a name="l03340"></a>03340                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>;
<a name="l03341"></a>03341                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_PRONE;
<a name="l03342"></a>03342                         <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a> );
<a name="l03343"></a>03343                   }
<a name="l03344"></a>03344             }
<a name="l03345"></a>03345       }
<a name="l03346"></a>03346 
<a name="l03347"></a>03347 <span class="comment"></span>
<a name="l03348"></a>03348 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03349"></a>03349 <span class="comment"></span> <span class="comment">// If sniper and nothing else to do then raise gun, and if that doesn't find somebody then goto yellow</span><span class="comment"></span>
<a name="l03350"></a>03350 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03351"></a>03351 <span class="comment"></span>      <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> )
<a name="l03352"></a>03352       {
<a name="l03353"></a>03353             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d9314cf775d5c7173502d90a3f4b70e">sniper</a> == 0 )
<a name="l03354"></a>03354             {
<a name="l03355"></a>03355                   DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionRed: sniper raising gun..."</span>));
<a name="l03356"></a>03356                   <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#79d7f90b12d50906a6f34bee3ac1d28d">GetAPsToReadyWeapon</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb1b732af1789afff77e503d30253b84d6">READY_RIFLE_CROUCH</a> ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l03357"></a>03357                   {
<a name="l03358"></a>03358                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d9314cf775d5c7173502d90a3f4b70e">sniper</a> = 1;   
<a name="l03359"></a>03359                         <span class="keywordflow">return</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950ba91f358173f4ebb4c9d9c071642b8159">AI_ACTION_RAISE_GUN</a>;
<a name="l03360"></a>03360                   }
<a name="l03361"></a>03361             }
<a name="l03362"></a>03362             <span class="keywordflow">else</span> 
<a name="l03363"></a>03363             {
<a name="l03364"></a>03364                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d9314cf775d5c7173502d90a3f4b70e">sniper</a> = 0;
<a name="l03365"></a>03365                   <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#7fea9db0a1bd960433cc4801e0881ab0">DecideActionYellow</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>));
<a name="l03366"></a>03366             }
<a name="l03367"></a>03367       }
<a name="l03368"></a>03368       <span class="comment"></span>
<a name="l03369"></a>03369 <span class="comment">////////////////////////////////////////////////////////////////////////////</span>
<a name="l03370"></a>03370 <span class="comment"></span> <span class="comment">// DO NOTHING: Not enough points left to move, so save them for next turn</span><span class="comment"></span>
<a name="l03371"></a>03371 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03372"></a>03372 <span class="comment"></span>      DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionRed: do nothing at all..."</span>));
<a name="l03373"></a>03373 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l03374"></a>03374 <span class="preprocessor"></span>      <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"- DOES NOTHING (RED)"</span>,1000);
<a name="l03375"></a>03375 <span class="preprocessor">      #endif</span>
<a name="l03376"></a>03376 <span class="preprocessor"></span>
<a name="l03377"></a>03377       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l03378"></a>03378       <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l03379"></a>03379 }
<a name="l03380"></a>03380 
<a name="l03381"></a><a class="code" href="DecideAction_8cpp.html#80afb7150d57db68238ca93a590f90af">03381</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="ai_8h.html#80afb7150d57db68238ca93a590f90af">DecideActionBlack</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pSoldier)
<a name="l03382"></a>03382 {
<a name="l03383"></a>03383  <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>      iCoverPercentBetter, iOffense, iDefense, iChance;
<a name="l03384"></a>03384  <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>      sClosestOpponent,sBestCover = NOWHERE;
<a name="l03385"></a>03385  <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>      sClosestDisturbance;
<a name="l03386"></a>03386  <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>      ubMinAPCost,ubCanMove;
<a name="l03387"></a>03387  <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>       bInWater,bInDeepWater,bInGas;
<a name="l03388"></a>03388  <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>       bDirection;
<a name="l03389"></a>03389  <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>      ubBestAttackAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l03390"></a>03390  <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>       bCanAttack,bActionReturned;
<a name="l03391"></a>03391  <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>       bWeaponIn;
<a name="l03392"></a>03392  <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>    fTryPunching = FALSE;
<a name="l03393"></a>03393 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l03394"></a>03394 <span class="preprocessor"></span>            <a class="code" href="Types_8h.html#94ebfccc6e846c28751f8d616371f1e5">STR16</a> tempstr;
<a name="l03395"></a>03395 <span class="preprocessor">      #endif</span>
<a name="l03396"></a>03396 <span class="preprocessor"></span>      DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionBlack: soldier = %d, orders = %d, attitude = %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>));
<a name="l03397"></a>03397 
<a name="l03398"></a>03398  <a class="code" href="structATTACKTYPE.html">ATTACKTYPE</a> BestShot,BestThrow,BestStab,BestAttack;
<a name="l03399"></a>03399  <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fCivilian = (PTR_CIVILIAN &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> == <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a078524cb5f7573455bdacd2b87a051da610c97">NON_CIV_GROUP</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a> || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> &gt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a72254b6f06629056dd86be50df5347676">FATCIV</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> &lt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a75db4e8d299d195df30798a12cd332f5a">CRIPPLECIV</a>) ) );
<a name="l03400"></a>03400  <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>      ubBestStance, ubStanceCost;
<a name="l03401"></a>03401  <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fChangeStanceFirst; <span class="comment">// before firing</span>
<a name="l03402"></a>03402  <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fClimb;
<a name="l03403"></a>03403  <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>      ubBurstAPs;
<a name="l03404"></a>03404  <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>      ubOpponentDir;
<a name="l03405"></a>03405  <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>      sCheckGridNo;
<a name="l03406"></a>03406 
<a name="l03407"></a>03407  <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fAllowCoverCheck = FALSE;
<a name="l03408"></a>03408 
<a name="l03409"></a>03409       DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"DecideActionBlack"</span>);
<a name="l03410"></a>03410 
<a name="l03411"></a>03411       <span class="comment">// once we hit status black, reset flanking status</span>
<a name="l03412"></a>03412 <span class="comment">//pSoldier-&gt;numFlanks = 0;</span>
<a name="l03413"></a>03413 
<a name="l03414"></a>03414 
<a name="l03415"></a>03415  <span class="comment">// if we have absolutely no action points, we can't do a thing under BLACK!</span>
<a name="l03416"></a>03416  <span class="keywordflow">if</span> (!<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l03417"></a>03417   {
<a name="l03418"></a>03418    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l03419"></a>03419    <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l03420"></a>03420   }
<a name="l03421"></a>03421 
<a name="l03422"></a>03422  <span class="comment">// can this guy move to any of the neighbouring squares ? (sets TRUE/FALSE)</span>
<a name="l03423"></a>03423  ubCanMove = (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt;= <a class="code" href="Points_8cpp.html#2d38f8d23814118ef8a616c4d28c2089">MinPtsToMove</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>));
<a name="l03424"></a>03424 
<a name="l03425"></a>03425       <span class="keywordflow">if</span> ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == ENEMY_TEAM || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1b5483f377943cd6d7fb1589d0d391321">WARDEN</a>) &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#965c762739e2731d1af1bb56e3485d0f">fPanicFlags</a> &amp; PANIC_TRIGGERS_HERE) &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#08542070e86ace3d6254642057e2cf00">ubTheChosenOne</a> == NOBODY) )
<a name="l03426"></a>03426       {
<a name="l03427"></a>03427             <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bPanicTrigger;
<a name="l03428"></a>03428 
<a name="l03429"></a>03429             bPanicTrigger = <a class="code" href="ai_8h.html#3b35c9a19cdfec1ea7fd44a0eb15a0ae">ClosestPanicTrigger</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l03430"></a>03430             <span class="comment">// if it's an alarm trigger and team is alerted, ignore it</span>
<a name="l03431"></a>03431             <span class="keywordflow">if</span> ( !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#e7bb56c1234965917e8ce5850cc73106">bPanicTriggerIsAlarm</a>[ bPanicTrigger ] &amp;&amp; <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bAwareOfOpposition) &amp;&amp; <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#80f0216d3e6970aa6fc5b6757a03ae0c">sPanicTriggerGridNo</a>[ bPanicTrigger ] ) &lt; 10) 
<a name="l03432"></a>03432             {
<a name="l03433"></a>03433                   <a class="code" href="AIInternals_8h.html#f7541c62911743d05fcf4dc33a7edeed">PossiblyMakeThisEnemyChosenOne</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l03434"></a>03434             }
<a name="l03435"></a>03435       }
<a name="l03436"></a>03436 
<a name="l03437"></a>03437  <span class="comment">// if this soldier is the "Chosen One" (enemies only)</span>
<a name="l03438"></a>03438  <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> == <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#08542070e86ace3d6254642057e2cf00">ubTheChosenOne</a>)
<a name="l03439"></a>03439   {
<a name="l03440"></a>03440    <span class="comment">// do some special panic AI decision making</span>
<a name="l03441"></a>03441    bActionReturned = <a class="code" href="ai_8h.html#90183e8d55f1f77dfb8ff60736dc75fb">PanicAI</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,ubCanMove);
<a name="l03442"></a>03442 
<a name="l03443"></a>03443    <span class="comment">// if we decided on an action while in there, we're done</span>
<a name="l03444"></a>03444    <span class="keywordflow">if</span> (bActionReturned != -1)
<a name="l03445"></a>03445      <span class="keywordflow">return</span>(bActionReturned);
<a name="l03446"></a>03446   }
<a name="l03447"></a>03447 
<a name="l03448"></a>03448       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE )
<a name="l03449"></a>03449       {
<a name="l03450"></a>03450             <span class="comment">// if they see enemies, the Queen will keep going to the staircase, but Joe will fight</span>
<a name="l03451"></a>03451             <span class="keywordflow">if</span> ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa158561257be7e2f96f82c0fdb51d7f964">QUEEN</a>) &amp;&amp; ubCanMove )
<a name="l03452"></a>03452             {
<a name="l03453"></a>03453                   <span class="keywordflow">if</span> ( <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a> == 3 &amp;&amp; <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a> == MAP_ROW_P &amp;&amp; <a class="code" href="strategicmap_8cpp.html#da715721a8ceedd42acf6ddb33e63ce0">gbWorldSectorZ</a> == 0 &amp;&amp; !<a class="code" href="Strategic_01AI_8cpp.html#8029ae4e0579eaec31822e170536fe40">gfUseAlternateQueenPosition</a> )
<a name="l03454"></a>03454                   {
<a name="l03455"></a>03455                         bActionReturned = <a class="code" href="AIInternals_8h.html#2fdd9d079e86c58e6b202a8a20d68eba">HeadForTheStairCase</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l03456"></a>03456                         <span class="keywordflow">if</span> ( bActionReturned != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> )
<a name="l03457"></a>03457                         {
<a name="l03458"></a>03458                               <span class="keywordflow">return</span>( bActionReturned );
<a name="l03459"></a>03459                         }
<a name="l03460"></a>03460                   }
<a name="l03461"></a>03461             }
<a name="l03462"></a>03462       }
<a name="l03463"></a>03463 
<a name="l03464"></a>03464       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_BOXER )
<a name="l03465"></a>03465       {
<a name="l03466"></a>03466             <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#32021b7251048d8c62ea0c2e26b7a021">bBoxingState</a> == <a class="code" href="Overhead_01Types_8h.html#60ed5bd8e4835b98d48cf7afb819b4e55fac2cdafaeb730644fb13980a1fa22c">PRE_BOXING</a> )
<a name="l03467"></a>03467             {
<a name="l03468"></a>03468                   <span class="keywordflow">return</span>( <a class="code" href="DecideAction_8cpp.html#958b1f66cb502f3e46a04cb9c799c86c">DecideActionBoxerEnteringRing</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) );
<a name="l03469"></a>03469             }
<a name="l03470"></a>03470             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#32021b7251048d8c62ea0c2e26b7a021">bBoxingState</a> == <a class="code" href="Overhead_01Types_8h.html#60ed5bd8e4835b98d48cf7afb819b4e57afcbf140adcf1ab9068be7ec414b3b1">BOXING</a> )
<a name="l03471"></a>03471             {
<a name="l03472"></a>03472 
<a name="l03473"></a>03473                   bInWater = FALSE;
<a name="l03474"></a>03474                   bInDeepWater = FALSE;
<a name="l03475"></a>03475                   bInGas = FALSE;
<a name="l03476"></a>03476 
<a name="l03477"></a>03477                   <span class="comment">// calculate our morale</span>
<a name="l03478"></a>03478                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> = <a class="code" href="ai_8h.html#0594cdf20b72e9dc23dbe5ad101e6d64">CalcMorale</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l03479"></a>03479                   <span class="comment">// and continue on...</span>
<a name="l03480"></a>03480             }
<a name="l03481"></a>03481             <span class="keywordflow">else</span> <span class="comment">//????</span>
<a name="l03482"></a>03482             {
<a name="l03483"></a>03483                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l03484"></a>03484             }
<a name="l03485"></a>03485       }
<a name="l03486"></a>03486       <span class="keywordflow">else</span>
<a name="l03487"></a>03487       {
<a name="l03488"></a>03488 
<a name="l03489"></a>03489             <span class="comment">// determine if we happen to be in water (in which case we're in BIG trouble!)</span>
<a name="l03490"></a>03490             bInWater = <a class="code" href="worldman_8cpp.html#2307250bab3e458d3dedf063a5ce2433">Water</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> );
<a name="l03491"></a>03491             bInDeepWater = <a class="code" href="worldman_8cpp.html#539facfba7329a9fe9936735382493dd">WaterTooDeepForAttacks</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> );
<a name="l03492"></a>03492 
<a name="l03493"></a>03493             <span class="comment">// check if standing in tear gas without a gas mask on</span>
<a name="l03494"></a>03494             bInGas = <a class="code" href="AIInternals_8h.html#57193b78fcaf32a2ca34e9e7ec021c1c">InGasOrSmoke</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> );
<a name="l03495"></a>03495             
<a name="l03496"></a>03496             <span class="comment">// calculate our morale</span>
<a name="l03497"></a>03497             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> = <a class="code" href="ai_8h.html#0594cdf20b72e9dc23dbe5ad101e6d64">CalcMorale</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l03498"></a>03498 <span class="comment"></span>
<a name="l03499"></a>03499 <span class="comment">            ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03500"></a>03500 <span class="comment"></span>            <span class="comment">// WHEN LEFT IN GAS, WEAR GAS MASK IF AVAILABLE AND NOT WORN</span><span class="comment"></span>
<a name="l03501"></a>03501 <span class="comment">            ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03502"></a>03502 <span class="comment"></span>
<a name="l03503"></a>03503             <span class="keywordflow">if</span> ( !bInGas &amp;&amp; (<a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a> == TIXA_SECTOR_X &amp;&amp; <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a> == TIXA_SECTOR_Y) )
<a name="l03504"></a>03504             {
<a name="l03505"></a>03505                   <span class="comment">// only chance if we happen to be caught with our gas mask off</span>
<a name="l03506"></a>03506                   <span class="keywordflow">if</span> ( <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 10 ) == 0 &amp;&amp; <a class="code" href="ai_8h.html#8c78be5dede6e209cbc4c4df6d9cc99f">WearGasMaskIfAvailable</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l03507"></a>03507                   {
<a name="l03508"></a>03508                         bInGas = FALSE;
<a name="l03509"></a>03509                   }
<a name="l03510"></a>03510             }
<a name="l03511"></a>03511 <span class="comment"></span>
<a name="l03512"></a>03512 <span class="comment">            ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03513"></a>03513 <span class="comment"></span>            <span class="comment">// IF GASSED, OR REALLY TIRED (ON THE VERGE OF COLLAPSING), TRY TO RUN AWAY</span><span class="comment"></span>
<a name="l03514"></a>03514 <span class="comment">            ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03515"></a>03515 <span class="comment"></span>
<a name="l03516"></a>03516             <span class="comment">// if we're desperately short on breath (it's OK if we're in water, though!)</span>
<a name="l03517"></a>03517             <span class="keywordflow">if</span> (bInGas || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a> &lt; 5))
<a name="l03518"></a>03518             {
<a name="l03519"></a>03519                   <span class="comment">// if soldier has enough APs left to move at least 1 square's worth</span>
<a name="l03520"></a>03520                   <span class="keywordflow">if</span> (ubCanMove)
<a name="l03521"></a>03521                   {
<a name="l03522"></a>03522                         <span class="comment">// look for best place to RUN AWAY to (farthest from the closest threat)</span>
<a name="l03523"></a>03523                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#eb3ffb28e50d84917771661b9d91aa51">FindSpotMaxDistFromOpponents</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l03524"></a>03524 
<a name="l03525"></a>03525                         <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l03526"></a>03526                         {
<a name="l03527"></a>03527 <span class="preprocessor">                              #ifdef DEBUGDECISIONS</span>
<a name="l03528"></a>03528 <span class="preprocessor"></span>                                    sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - GASSED or LOW ON BREATH (%d), RUNNING AWAY to grid %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l03529"></a>03529                                     <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l03530"></a>03530 <span class="preprocessor">                              #endif</span>
<a name="l03531"></a>03531 <span class="preprocessor"></span>
<a name="l03532"></a>03532                               <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950be1338b9c498abc9dd4b86d1b22291b12">AI_ACTION_RUN_AWAY</a>);
<a name="l03533"></a>03533                         }
<a name="l03534"></a>03534                   }
<a name="l03535"></a>03535 
<a name="l03536"></a>03536                   <span class="comment">// REALLY tired, can't get away, force soldier's morale to hopeless state</span>
<a name="l03537"></a>03537                   <span class="keywordflow">if</span> ( <a class="code" href="GameSettings_8cpp.html#f9f2d5fd368ccadcc26bebc202d52ae7">gGameOptions</a>.<a class="code" href="structGAME__OPTIONS.html#4fb44167906152722f6af5cc9f7c1a99">ubDifficultyLevel</a> == <a class="code" href="GameSettings_8h.html#c205be2172292384dd687b5471a87eddc657c89fd754a6f20b3869250288a702">DIF_LEVEL_INSANE</a> )
<a name="l03538"></a>03538                   {
<a name="l03539"></a>03539                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1bcf825e550d7b1f2db4cbfe7a6782d3">bBreathMax</a>;  <span class="comment">//Madd: backed into a corner, so go crazy like a wild animal...</span>
<a name="l03540"></a>03540                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> = <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e34e0b5e2e2be99f4e43c1321cf58b19ad">MORALE_FEARLESS</a>; 
<a name="l03541"></a>03541                   }
<a name="l03542"></a>03542                   <span class="keywordflow">else</span>
<a name="l03543"></a>03543                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> = <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e360129a915d611934bca8624d0ea8e21e">MORALE_HOPELESS</a>;
<a name="l03544"></a>03544             }
<a name="l03545"></a>03545 
<a name="l03546"></a>03546       }
<a name="l03547"></a>03547 
<a name="l03548"></a>03548 
<a name="l03549"></a>03549 <span class="comment"></span>
<a name="l03550"></a>03550 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03551"></a>03551 <span class="comment"></span> <span class="comment">// STUCK IN WATER OR GAS, NO COVER, GO TO NEAREST SPOT OF UNGASSED LAND</span><span class="comment"></span>
<a name="l03552"></a>03552 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03553"></a>03553 <span class="comment"></span>
<a name="l03554"></a>03554  <span class="comment">// if soldier in water/gas has enough APs left to move at least 1 square</span>
<a name="l03555"></a>03555  <span class="keywordflow">if</span> ( ( bInDeepWater || bInGas ) &amp;&amp; ubCanMove)
<a name="l03556"></a>03556   {
<a name="l03557"></a>03557    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#c5f60b8768fb9f3fc244df46e31c1299">FindNearestUngassedLand</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l03558"></a>03558 
<a name="l03559"></a>03559    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l03560"></a>03560     {
<a name="l03561"></a>03561 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l03562"></a>03562 <span class="preprocessor"></span>     sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - SEEKING NEAREST UNGASSED LAND at grid %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l03563"></a>03563      <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l03564"></a>03564 <span class="preprocessor">#endif</span>
<a name="l03565"></a>03565 <span class="preprocessor"></span>
<a name="l03566"></a>03566      <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bbbe6b4d8c4937c66e39880b4df436182">AI_ACTION_LEAVE_WATER_GAS</a>);
<a name="l03567"></a>03567     }
<a name="l03568"></a>03568 
<a name="l03569"></a>03569    <span class="comment">// couldn't find ANY land within 25 tiles(!), this should never happen...</span>
<a name="l03570"></a>03570 
<a name="l03571"></a>03571    <span class="comment">// look for best place to RUN AWAY to (farthest from the closest threat)</span>
<a name="l03572"></a>03572    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#eb3ffb28e50d84917771661b9d91aa51">FindSpotMaxDistFromOpponents</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l03573"></a>03573 
<a name="l03574"></a>03574    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l03575"></a>03575     {
<a name="l03576"></a>03576 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l03577"></a>03577 <span class="preprocessor"></span>     sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - NO LAND NEAR, RUNNING AWAY to grid %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l03578"></a>03578      <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l03579"></a>03579 <span class="preprocessor">#endif</span>
<a name="l03580"></a>03580 <span class="preprocessor"></span>
<a name="l03581"></a>03581      <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950be1338b9c498abc9dd4b86d1b22291b12">AI_ACTION_RUN_AWAY</a>);
<a name="l03582"></a>03582     }
<a name="l03583"></a>03583 
<a name="l03584"></a>03584    <span class="comment">// GIVE UP ON LIFE!  MERCS MUST HAVE JUST CORNERED A HELPLESS ENEMY IN A</span>
<a name="l03585"></a>03585    <span class="comment">// GAS FILLED ROOM (OR IN WATER MORE THAN 25 TILES FROM NEAREST LAND...)</span>
<a name="l03586"></a>03586       <span class="keywordflow">if</span> ( bInGas &amp;&amp; <a class="code" href="GameSettings_8cpp.html#f9f2d5fd368ccadcc26bebc202d52ae7">gGameOptions</a>.<a class="code" href="structGAME__OPTIONS.html#4fb44167906152722f6af5cc9f7c1a99">ubDifficultyLevel</a> == <a class="code" href="GameSettings_8h.html#c205be2172292384dd687b5471a87eddc657c89fd754a6f20b3869250288a702">DIF_LEVEL_INSANE</a> )
<a name="l03587"></a>03587       {
<a name="l03588"></a>03588             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1bcf825e550d7b1f2db4cbfe7a6782d3">bBreathMax</a>;
<a name="l03589"></a>03589             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> = <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e34e0b5e2e2be99f4e43c1321cf58b19ad">MORALE_FEARLESS</a>;  <span class="comment">// Can't move, can't get away, go nuts instead...</span>
<a name="l03590"></a>03590       }
<a name="l03591"></a>03591       <span class="keywordflow">else</span>
<a name="l03592"></a>03592             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> = <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e360129a915d611934bca8624d0ea8e21e">MORALE_HOPELESS</a>;
<a name="l03593"></a>03593   }
<a name="l03594"></a>03594 
<a name="l03595"></a>03595       <span class="comment">// offer surrender?</span>
<a name="l03596"></a>03596       
<a name="l03597"></a>03597       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == ENEMY_TEAM &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#73246323764393ce2a5ece7fcb7b7cf8">bVisible</a> == TRUE &amp;&amp; !( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b532b07ae3e6c80bf3daff4d40b7cab5">fEnemyFlags</a> &amp; ENEMY_OFFERED_SURRENDER ) &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a> &gt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#600d382f89a391cdeb7bfe2580776866">bLifeMax</a> / 2 )
<a name="l03598"></a>03598   { 
<a name="l03599"></a>03599             <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ MILITIA_TEAM ].<a class="code" href="structTacticalTeamType.html#da091a4cdd23ae1d201305e0e9d4c046">bMenInSector</a> == 0 &amp;&amp; <a class="code" href="Overhead_8cpp.html#a04a9b3269fd99673d7e3885e4710a0a">NumPCsInSector</a>() &lt; 4 &amp;&amp; <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ ENEMY_TEAM ].<a class="code" href="structTacticalTeamType.html#da091a4cdd23ae1d201305e0e9d4c046">bMenInSector</a> &gt;= <a class="code" href="Overhead_8cpp.html#a04a9b3269fd99673d7e3885e4710a0a">NumPCsInSector</a>() * 3 )
<a name="l03600"></a>03600             {
<a name="l03601"></a>03601                   <span class="comment">//if( GetWorldDay() &gt; STARTDAY_ALLOW_PLAYER_CAPTURE_FOR_RESCUE &amp;&amp; !( gStrategicStatus.uiFlags &amp; STRATEGIC_PLAYER_CAPTURED_FOR_RESCUE ) )</span>
<a name="l03602"></a>03602                   {
<a name="l03603"></a>03603                         <span class="keywordflow">if</span> ( <a class="code" href="Quests_8cpp.html#b371f5479136d9c6e6debcb700a5c809">gubQuest</a>[ <a class="code" href="Quests_8h.html#2f2591166460d6d958c50f3317939e22c77563c3d5b69cdebbc8e0f063f634cb">QUEST_HELD_IN_ALMA</a> ] == QUESTNOTSTARTED || ( <a class="code" href="Quests_8cpp.html#b371f5479136d9c6e6debcb700a5c809">gubQuest</a>[ <a class="code" href="Quests_8h.html#2f2591166460d6d958c50f3317939e22c77563c3d5b69cdebbc8e0f063f634cb">QUEST_HELD_IN_ALMA</a> ] == QUESTDONE &amp;&amp; <a class="code" href="Quests_8cpp.html#b371f5479136d9c6e6debcb700a5c809">gubQuest</a>[ <a class="code" href="Quests_8h.html#2f2591166460d6d958c50f3317939e22019ff2f6611c9f5afce08f8f3ae0212f">QUEST_INTERROGATION</a> ] == QUESTNOTSTARTED ) )
<a name="l03604"></a>03604                         {
<a name="l03605"></a>03605                   <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b532b07ae3e6c80bf3daff4d40b7cab5">fEnemyFlags</a> |= ENEMY_OFFERED_SURRENDER;
<a name="l03606"></a>03606                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950be0a0afbead0db144e6da11231dbf9199">AI_ACTION_OFFER_SURRENDER</a> );
<a name="l03607"></a>03607         }
<a name="l03608"></a>03608       }
<a name="l03609"></a>03609             }
<a name="l03610"></a>03610       }
<a name="l03611"></a>03611 <span class="comment"></span>
<a name="l03612"></a>03612 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03613"></a>03613 <span class="comment"></span>      <span class="comment">// SOLDIER CAN ATTACK IF NOT IN WATER/GAS AND NOT DOING SOMETHING TOO FUNKY</span><span class="comment"></span>
<a name="l03614"></a>03614 <span class="comment">      ////////////////////////////////////////////////////////////////////////////</span>
<a name="l03615"></a>03615 <span class="comment"></span>
<a name="l03616"></a>03616 
<a name="l03617"></a>03617       <span class="comment">// NPCs in water/tear gas without masks are not permitted to shoot/stab/throw</span>
<a name="l03618"></a>03618       <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &lt; 2) || bInDeepWater || bInGas || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#632ca06a3de72d8deb1d7d1777955e4a">bRTPCombat</a> == RTP_COMBAT_REFRAIN)
<a name="l03619"></a>03619       {
<a name="l03620"></a>03620             bCanAttack = FALSE;
<a name="l03621"></a>03621       }
<a name="l03622"></a>03622       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_BOXER)
<a name="l03623"></a>03623       {
<a name="l03624"></a>03624             bCanAttack = TRUE;
<a name="l03625"></a>03625             fTryPunching = TRUE;
<a name="l03626"></a>03626       }
<a name="l03627"></a>03627       <span class="keywordflow">else</span>
<a name="l03628"></a>03628       {
<a name="l03629"></a>03629             <span class="keywordflow">do</span>
<a name="l03630"></a>03630             {
<a name="l03631"></a>03631 
<a name="l03632"></a>03632                   bCanAttack = <a class="code" href="AIInternals_8h.html#4a6dd2f3caa0b4f6caa74acd5ac465cd">CanNPCAttack</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l03633"></a>03633                   <span class="keywordflow">if</span> (bCanAttack != TRUE)
<a name="l03634"></a>03634                   {
<a name="l03635"></a>03635                         <span class="keywordflow">if</span> (fCivilian)
<a name="l03636"></a>03636                         {
<a name="l03637"></a>03637                               <span class="keywordflow">if</span> ( ( bCanAttack == NOSHOOT_NOWEAPON) &amp;&amp; !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_BOXER) &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> != <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a748505ba252c1ec37e34d882e6f4a3ecf">COW</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> != <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a75db4e8d299d195df30798a12cd332f5a">CRIPPLECIV</a> )
<a name="l03638"></a>03638                               {
<a name="l03639"></a>03639                                       <span class="comment">// cower in fear!!</span>
<a name="l03640"></a>03640                                       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_COWERING )
<a name="l03641"></a>03641                                       {
<a name="l03642"></a>03642                                             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9c0e11c8a59d5a7d254c7f08d91df398">bLastAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b0e1477dcf1592283b53b8027ff3ae20a">AI_ACTION_COWER</a> )
<a name="l03643"></a>03643                                             {
<a name="l03644"></a>03644                                                   <span class="comment">// do nothing</span>
<a name="l03645"></a>03645                                                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l03646"></a>03646                                                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l03647"></a>03647                                             }
<a name="l03648"></a>03648                                             <span class="keywordflow">else</span>
<a name="l03649"></a>03649                                             {
<a name="l03650"></a>03650                                                   <span class="comment">// set up next action to run away</span>
<a name="l03651"></a>03651                                                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = <a class="code" href="ai_8h.html#eb3ffb28e50d84917771661b9d91aa51">FindSpotMaxDistFromOpponents</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l03652"></a>03652                                                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> != NOWHERE )
<a name="l03653"></a>03653                                                   {
<a name="l03654"></a>03654                                                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950be1338b9c498abc9dd4b86d1b22291b12">AI_ACTION_RUN_AWAY</a>;
<a name="l03655"></a>03655                                                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_STAND;
<a name="l03656"></a>03656                                                         <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6f46584addd5e876d03eef0b47c41003">AI_ACTION_STOP_COWERING</a> );
<a name="l03657"></a>03657                                                   }
<a name="l03658"></a>03658                                                   <span class="keywordflow">else</span>
<a name="l03659"></a>03659                                                   {
<a name="l03660"></a>03660                                                         <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l03661"></a>03661                                                   }
<a name="l03662"></a>03662                                             }
<a name="l03663"></a>03663                                       }
<a name="l03664"></a>03664                                       <span class="keywordflow">else</span>
<a name="l03665"></a>03665                                       {
<a name="l03666"></a>03666                                             <span class="comment">// cower!!!</span>
<a name="l03667"></a>03667                                             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ANIM_CROUCH;
<a name="l03668"></a>03668                                             <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b0e1477dcf1592283b53b8027ff3ae20a">AI_ACTION_COWER</a> );
<a name="l03669"></a>03669                                       }
<a name="l03670"></a>03670                               }
<a name="l03671"></a>03671                         }
<a name="l03672"></a>03672                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCanAttack == NOSHOOT_NOAMMO &amp;&amp; ubCanMove &amp;&amp; !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a>)
<a name="l03673"></a>03673                         {
<a name="l03674"></a>03674                               <span class="comment">// try to find more ammo</span>
<a name="l03675"></a>03675                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="Militia_01Control_8cpp.html#7ee7b5c7c05a10bfb5dfab1c9ee6685a">SearchForItems</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="AIInternals_8h.html#a9365ee5e8ef57a5b8a3365ecf7cefa87754cc60ea4ca5c4ceafe3464c8d1761">SEARCH_AMMO</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].usItem );
<a name="l03676"></a>03676 
<a name="l03677"></a>03677                               <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>)
<a name="l03678"></a>03678                               {
<a name="l03679"></a>03679                                     <span class="comment">// the current weapon appears is useless right now!</span>
<a name="l03680"></a>03680                                     <span class="comment">// (since we got a return code of noammo, we know the hand usItem</span>
<a name="l03681"></a>03681                                     <span class="comment">// is our gun)</span>
<a name="l03682"></a>03682                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].<a class="code" href="structOBJECTTYPE.html#0f1e67bac22f1b89c4040ef8a5ea48c2">fFlags</a> |= OBJECT_AI_UNUSABLE;
<a name="l03683"></a>03683                                     <span class="comment">// move the gun into another pocket...</span>
<a name="l03684"></a>03684                                     <a class="code" href="Items_8cpp.html#b0cdccd7f510d5464ab386cb5b69c28f">AutoPlaceObject</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>]), FALSE );                            
<a name="l03685"></a>03685                               }
<a name="l03686"></a>03686                               <span class="keywordflow">else</span>
<a name="l03687"></a>03687                               {
<a name="l03688"></a>03688                                     <span class="keywordflow">return</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> );
<a name="l03689"></a>03689                               }
<a name="l03690"></a>03690                         }
<a name="l03691"></a>03691                         <span class="keywordflow">else</span>
<a name="l03692"></a>03692                         {
<a name="l03693"></a>03693                               bCanAttack = FALSE;
<a name="l03694"></a>03694                         }
<a name="l03695"></a>03695                   }
<a name="l03696"></a>03696             } <span class="keywordflow">while</span>( bCanAttack != TRUE &amp;&amp; bCanAttack != FALSE );
<a name="l03697"></a>03697 
<a name="l03698"></a>03698 <span class="preprocessor">#ifdef RETREAT_TESTING</span>
<a name="l03699"></a>03699 <span class="preprocessor"></span>bCanAttack = FALSE;
<a name="l03700"></a>03700 <span class="preprocessor">#endif</span>
<a name="l03701"></a>03701 <span class="preprocessor"></span>
<a name="l03702"></a>03702             <span class="keywordflow">if</span> (!bCanAttack)
<a name="l03703"></a>03703             {
<a name="l03704"></a>03704                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> &gt; <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e3babad6ffb594c707f4cf71479ecac899">MORALE_WORRIED</a>)
<a name="l03705"></a>03705                   {
<a name="l03706"></a>03706                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> = <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e3babad6ffb594c707f4cf71479ecac899">MORALE_WORRIED</a>;
<a name="l03707"></a>03707                   }
<a name="l03708"></a>03708 
<a name="l03709"></a>03709                   <span class="keywordflow">if</span> (!fCivilian)
<a name="l03710"></a>03710                   {
<a name="l03711"></a>03711                         <span class="comment">// can always attack with HTH as a last resort</span>
<a name="l03712"></a>03712                         bCanAttack = TRUE;
<a name="l03713"></a>03713                         fTryPunching = TRUE;
<a name="l03714"></a>03714                   }
<a name="l03715"></a>03715             }
<a name="l03716"></a>03716       }
<a name="l03717"></a>03717 
<a name="l03718"></a>03718       <span class="comment">// if we don't have a gun, look around for a weapon!</span>
<a name="l03719"></a>03719       <span class="keywordflow">if</span> (<a class="code" href="Items_8cpp.html#4d7b6f8ecfa44d103eaf0b3e206edba4">FindAIUsableObjClass</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, IC_GUN ) == ITEM_NOT_FOUND &amp;&amp; ubCanMove &amp;&amp; !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a>)
<a name="l03720"></a>03720       {
<a name="l03721"></a>03721             <span class="comment">// look around for a gun...</span>
<a name="l03722"></a>03722             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="Militia_01Control_8cpp.html#7ee7b5c7c05a10bfb5dfab1c9ee6685a">SearchForItems</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="AIInternals_8h.html#a9365ee5e8ef57a5b8a3365ecf7cefa81625bdba3bb8048b27e8a02dba8063b3">SEARCH_WEAPONS</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].usItem );
<a name="l03723"></a>03723             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> )
<a name="l03724"></a>03724             {
<a name="l03725"></a>03725                   <span class="keywordflow">return</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> );
<a name="l03726"></a>03726             }
<a name="l03727"></a>03727       }
<a name="l03728"></a>03728 
<a name="l03729"></a>03729 
<a name="l03730"></a>03730       BestShot.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a>  = FALSE; <span class="comment">// by default, assume Shooting isn't possible</span>
<a name="l03731"></a>03731       BestThrow.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a> = FALSE; <span class="comment">// by default, assume Throwing isn't possible</span>
<a name="l03732"></a>03732       BestStab.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a>  = FALSE; <span class="comment">// by default, assume Stabbing isn't possible</span>
<a name="l03733"></a>03733 
<a name="l03734"></a>03734       BestAttack.<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a> = 0;
<a name="l03735"></a>03735 
<a name="l03736"></a>03736 
<a name="l03737"></a>03737  <span class="comment">// if we are able attack</span>
<a name="l03738"></a>03738  <span class="keywordflow">if</span> (bCanAttack)
<a name="l03739"></a>03739  {
<a name="l03740"></a>03740             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#a2e765b8729e88a5e542a2e7852f0ccb">bAimShotLocation</a> = AIM_SHOT_RANDOM;
<a name="l03741"></a>03741 <span class="comment"></span>
<a name="l03742"></a>03742 <span class="comment">   //////////////////////////////////////////////////////////////////////////</span>
<a name="l03743"></a>03743 <span class="comment"></span>   <span class="comment">// FIRE A GUN AT AN OPPONENT</span><span class="comment"></span>
<a name="l03744"></a>03744 <span class="comment">   //////////////////////////////////////////////////////////////////////////</span>
<a name="l03745"></a>03745 <span class="comment"></span>                   DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"FIRE A GUN AT AN OPPONENT"</span>);
<a name="l03746"></a>03746 
<a name="l03747"></a>03747        bWeaponIn = <a class="code" href="Items_8cpp.html#4d7b6f8ecfa44d103eaf0b3e206edba4">FindAIUsableObjClass</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, IC_GUN );
<a name="l03748"></a>03748 
<a name="l03749"></a>03749    <span class="keywordflow">if</span> (bWeaponIn != NO_SLOT)
<a name="l03750"></a>03750    {
<a name="l03751"></a>03751              BestShot.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> = bWeaponIn;
<a name="l03752"></a>03752      <span class="comment">// if it's in another pocket, swap it into his hand temporarily</span>
<a name="l03753"></a>03753      <span class="keywordflow">if</span> (bWeaponIn != <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>)
<a name="l03754"></a>03754              {
<a name="l03755"></a>03755                    DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionblack: swap gun into hand"</span>);
<a name="l03756"></a>03756                   <a class="code" href="AIInternals_8h.html#8d7f0222069571f630a99342fa534afe">RearrangePocket</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>,bWeaponIn,TEMPORARILY);
<a name="l03757"></a>03757              }
<a name="l03758"></a>03758 
<a name="l03759"></a>03759              <span class="comment">// now it better be a gun, or the guy can't shoot (but has other attack(s))</span>
<a name="l03760"></a>03760              <span class="keywordflow">if</span> (<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].usItem].usItemClass == IC_GUN &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].bGunStatus &gt;= USABLE)
<a name="l03761"></a>03761              {
<a name="l03762"></a>03762                    <span class="comment">// get the minimum cost to attack the same target with this gun</span>
<a name="l03763"></a>03763                    ubMinAPCost = <a class="code" href="Points_8cpp.html#84f116b33524232723bfa74949877c21">MinAPsToAttack</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cd62bec1ef14927e4fb8ef7540273beb">sLastTarget</a>,DONTADDTURNCOST);
<a name="l03764"></a>03764 
<a name="l03765"></a>03765                    <span class="comment">// if we have enough action points to shoot with this gun</span>
<a name="l03766"></a>03766                    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt;= ubMinAPCost)
<a name="l03767"></a>03767                    {
<a name="l03768"></a>03768                         <span class="comment">// look around for a worthy target (which sets BestShot.ubPossible)</span>
<a name="l03769"></a>03769                         <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> shootUnseen = FALSE;
<a name="l03770"></a>03770                         <span class="keywordflow">if</span> (<a class="code" href="GameSettings_8cpp.html#f9f2d5fd368ccadcc26bebc202d52ae7">gGameOptions</a>.<a class="code" href="structGAME__OPTIONS.html#4fb44167906152722f6af5cc9f7c1a99">ubDifficultyLevel</a> &gt; <a class="code" href="GameSettings_8h.html#c205be2172292384dd687b5471a87edddd0259b09fef163c6aa62268574191cb">DIF_LEVEL_MEDIUM</a> )
<a name="l03771"></a>03771                               shootUnseen = TRUE;
<a name="l03772"></a>03772 
<a name="l03773"></a>03773                         <a class="code" href="AIInternals_8h.html#7282133f1f68ed6bcd129c1f71a92a69">CalcBestShot</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,&amp;BestShot,shootUnseen);
<a name="l03774"></a>03774 
<a name="l03775"></a>03775                         <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#632ca06a3de72d8deb1d7d1777955e4a">bRTPCombat</a> == RTP_COMBAT_CONSERVE)
<a name="l03776"></a>03776                         {
<a name="l03777"></a>03777                               <span class="keywordflow">if</span> (BestShot.<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a> &lt; 30)
<a name="l03778"></a>03778                               {
<a name="l03779"></a>03779                                     <span class="comment">// skip firing, our chance isn't good enough</span>
<a name="l03780"></a>03780                                     BestShot.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a> = FALSE;
<a name="l03781"></a>03781                               }
<a name="l03782"></a>03782                         }
<a name="l03783"></a>03783 
<a name="l03784"></a>03784                         <span class="keywordflow">if</span> (BestShot.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a>)
<a name="l03785"></a>03785                         {
<a name="l03786"></a>03786                               <span class="comment">// if the selected opponent is not a threat (unconscious &amp; !serviced)</span>
<a name="l03787"></a>03787                               <span class="comment">// (usually, this means all the guys we see are unconscious, but, on</span>
<a name="l03788"></a>03788                               <span class="comment">//  rare occasions, we may not be able to shoot a healthy guy, too)</span>
<a name="l03789"></a>03789                               <span class="keywordflow">if</span> ((<a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[BestShot.<a class="code" href="structATTACKTYPE.html#4a3c834866b912b3fa371ac855e7be42">ubOpponent</a>].bLife &lt; OKLIFE) &amp;&amp;
<a name="l03790"></a>03790                                      !<a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[BestShot.<a class="code" href="structATTACKTYPE.html#4a3c834866b912b3fa371ac855e7be42">ubOpponent</a>].bService)
<a name="l03791"></a>03791                               {
<a name="l03792"></a>03792                                     <span class="comment">// if our attitude is NOT aggressive</span>
<a name="l03793"></a>03793                                     <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a> != <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a> || BestShot.<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a> &lt; 60 )
<a name="l03794"></a>03794                                     {
<a name="l03795"></a>03795                                           <span class="comment">// get the location of the closest CONSCIOUS reachable opponent</span>
<a name="l03796"></a>03796                                           sClosestDisturbance = <a class="code" href="AIInternals_8h.html#bdbd82cec2627ae4973f5e8e4f897451">ClosestReachableDisturbance</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,FALSE, &amp;fClimb);
<a name="l03797"></a>03797 
<a name="l03798"></a>03798                                           <span class="comment">// if we found one</span>
<a name="l03799"></a>03799                                           <span class="keywordflow">if</span> (sClosestDisturbance != NOWHERE)
<a name="l03800"></a>03800                                           {
<a name="l03801"></a>03801                                                 <span class="comment">// don't bother checking GRENADES/KNIVES, he can't have conscious targets</span>
<a name="l03802"></a>03802 <span class="preprocessor">                                    #ifdef RECORDNET</span>
<a name="l03803"></a>03803 <span class="preprocessor"></span>                                                fprintf(NetDebugFile,<span class="stringliteral">"\tDecideActionBlack: all visible opponents unconscious, switching to RED AI...\n"</span>);
<a name="l03804"></a>03804 <span class="preprocessor">                                    #endif</span>
<a name="l03805"></a>03805 <span class="preprocessor"></span>                                                <span class="comment">// then make decision as if at alert status RED, but make sure</span>
<a name="l03806"></a>03806                                                 <span class="comment">// we don't try to SEEK OPPONENT the unconscious guy!</span>
<a name="l03807"></a>03807                                                 <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#0a4ddf8062e33366cea57ebbeb597174">DecideActionRed</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,FALSE));
<a name="l03808"></a>03808                                           }
<a name="l03809"></a>03809                                           <span class="comment">// else kill the guy, he could be the last opponent alive in this sector</span>
<a name="l03810"></a>03810                                     }
<a name="l03811"></a>03811                               <span class="comment">// else aggressive guys will ALWAYS finish off unconscious opponents</span>
<a name="l03812"></a>03812                               }
<a name="l03813"></a>03813 
<a name="l03814"></a>03814                               <span class="comment">// now we KNOW FOR SURE that we will do something (shoot, at least)</span>
<a name="l03815"></a>03815                               <a class="code" href="AIInternals_8h.html#1dc658ff228f7a3273f69cd2a842fb3d">NPCDoesAct</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l03816"></a>03816                               DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"NPC decided to shoot (or something)"</span>);
<a name="l03817"></a>03817 
<a name="l03818"></a>03818                         }
<a name="l03819"></a>03819                    }
<a name="l03820"></a>03820                    
<a name="l03821"></a>03821                    <span class="comment">// if it was in his holster, swap it back into his holster for now</span>
<a name="l03822"></a>03822                    <span class="keywordflow">if</span> (bWeaponIn != <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>)
<a name="l03823"></a>03823                    {
<a name="l03824"></a>03824                          DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionblack: swap gun into holster"</span>);
<a name="l03825"></a>03825                          <a class="code" href="AIInternals_8h.html#8d7f0222069571f630a99342fa534afe">RearrangePocket</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>,bWeaponIn,TEMPORARILY);
<a name="l03826"></a>03826                    }
<a name="l03827"></a>03827 
<a name="l03828"></a>03828              }
<a name="l03829"></a>03829    }
<a name="l03830"></a>03830 <span class="comment"></span>
<a name="l03831"></a>03831 <span class="comment">   //////////////////////////////////////////////////////////////////////////</span>
<a name="l03832"></a>03832 <span class="comment"></span>   <span class="comment">// THROW A TOSSABLE ITEM AT OPPONENT(S)</span>
<a name="l03833"></a>03833    <span class="comment">//       - HTH: THIS NOW INCLUDES FIRING THE GRENADE LAUNCHAR AND MORTAR!</span><span class="comment"></span>
<a name="l03834"></a>03834 <span class="comment">   //////////////////////////////////////////////////////////////////////////</span>
<a name="l03835"></a>03835 <span class="comment"></span>
<a name="l03836"></a>03836    <span class="comment">// this looks for throwables, and sets BestThrow.ubPossible if it can be done</span>
<a name="l03837"></a>03837        <span class="comment">//if ( !gfHiddenInterrupt )</span>
<a name="l03838"></a>03838       <span class="comment">// {</span>
<a name="l03839"></a>03839              <a class="code" href="AIInternals_8h.html#63160d71d4c4fd2abcaf1e0596bf555d">CheckIfTossPossible</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,&amp;BestThrow);
<a name="l03840"></a>03840 
<a name="l03841"></a>03841              <span class="keywordflow">if</span> (BestThrow.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a>)
<a name="l03842"></a>03842              {
<a name="l03843"></a>03843                   DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"good throw possible"</span>);
<a name="l03844"></a>03844                   <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ BestThrow.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> ].usItem].mortar )
<a name="l03845"></a>03845                   {
<a name="l03846"></a>03846                         ubOpponentDir = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="Soldier_01Control_8cpp.html#1d7b6c103ede7e551e76eef2ef173f9b">GetDirectionFromGridNo</a>( BestThrow.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l03847"></a>03847 
<a name="l03848"></a>03848                         <span class="comment">// Get new gridno!</span>
<a name="l03849"></a>03849                         sCheckGridNo = <a class="code" href="Isometric_01Utils_8cpp.html#318d8410127e29bb232ab70363bc316e">NewGridNo</a>( (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( ubOpponentDir ) );
<a name="l03850"></a>03850 
<a name="l03851"></a>03851                         <span class="keywordflow">if</span> ( !<a class="code" href="Soldier_01Ani_8cpp.html#52dee080c40e99d978e145a7fd2f3a67">OKFallDirection</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sCheckGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, ubOpponentDir, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ) )
<a name="l03852"></a>03852                         {
<a name="l03853"></a>03853                               <span class="comment">// can't fire!</span>
<a name="l03854"></a>03854                               BestThrow.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a> = FALSE;
<a name="l03855"></a>03855 
<a name="l03856"></a>03856                               <span class="comment">// try behind us, see if there's room to move back          </span>
<a name="l03857"></a>03857                               sCheckGridNo = <a class="code" href="Isometric_01Utils_8cpp.html#318d8410127e29bb232ab70363bc316e">NewGridNo</a>( (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( <a class="code" href="Isometric_01Utils_8cpp.html#9591ab6c902758a420fd3d9f4e49ba2e">gOppositeDirection</a>[ ubOpponentDir ] ) );
<a name="l03858"></a>03858                               <span class="keywordflow">if</span> ( <a class="code" href="Soldier_01Ani_8cpp.html#52dee080c40e99d978e145a7fd2f3a67">OKFallDirection</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sCheckGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, <a class="code" href="Isometric_01Utils_8cpp.html#9591ab6c902758a420fd3d9f4e49ba2e">gOppositeDirection</a>[ ubOpponentDir ], <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ) )
<a name="l03859"></a>03859                               {
<a name="l03860"></a>03860                                <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = sCheckGridNo;
<a name="l03861"></a>03861 
<a name="l03862"></a>03862                                <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bedcd6be18202cbd0df633b0017f571f1">AI_ACTION_GET_CLOSER</a> );
<a name="l03863"></a>03863                               }
<a name="l03864"></a>03864                         }
<a name="l03865"></a>03865                   }
<a name="l03866"></a>03866                   
<a name="l03867"></a>03867                    <span class="keywordflow">if</span> ( BestThrow.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a> )
<a name="l03868"></a>03868                    {
<a name="l03869"></a>03869                          <span class="comment">// now we KNOW FOR SURE that we will do something (throw, at least)</span>
<a name="l03870"></a>03870                          <a class="code" href="AIInternals_8h.html#1dc658ff228f7a3273f69cd2a842fb3d">NPCDoesAct</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l03871"></a>03871                    }
<a name="l03872"></a>03872              }
<a name="l03873"></a>03873 
<a name="l03874"></a>03874              
<a name="l03875"></a>03875              
<a name="l03876"></a>03876              
<a name="l03877"></a>03877              
<a name="l03878"></a>03878              
<a name="l03879"></a>03879              <span class="comment">//}</span>
<a name="l03880"></a>03880 <span class="comment"></span>
<a name="l03881"></a>03881 <span class="comment">   //////////////////////////////////////////////////////////////////////////</span>
<a name="l03882"></a>03882 <span class="comment"></span>   <span class="comment">// GO STAB AN OPPONENT WITH A KNIFE</span><span class="comment"></span>
<a name="l03883"></a>03883 <span class="comment">   //////////////////////////////////////////////////////////////////////////</span>
<a name="l03884"></a>03884 <span class="comment"></span>
<a name="l03885"></a>03885       DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"GO STAB AN OPPONENT WITH A KNIFE"</span>);
<a name="l03886"></a>03886    <span class="comment">// if soldier has a knife in his hand</span>
<a name="l03887"></a>03887        bWeaponIn = <a class="code" href="Items_8cpp.html#4d7b6f8ecfa44d103eaf0b3e206edba4">FindAIUsableObjClass</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, (IC_BLADE | IC_THROWING_KNIFE) );
<a name="l03888"></a>03888 
<a name="l03889"></a>03889    <span class="comment">// if the soldier does have a usable knife somewhere</span>
<a name="l03890"></a>03890        <span class="keywordflow">if</span> (bWeaponIn != NO_SLOT)
<a name="l03891"></a>03891    {
<a name="l03892"></a>03892             DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"try to stab"</span>);
<a name="l03893"></a>03893              BestStab.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> = bWeaponIn;
<a name="l03894"></a>03894              <span class="comment">// if it's in his holster, swap it into his hand temporarily</span>
<a name="l03895"></a>03895              <span class="keywordflow">if</span> (bWeaponIn != <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>)
<a name="l03896"></a>03896              {
<a name="l03897"></a>03897                    DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionblack: about to rearrange pocket before stab check"</span>);
<a name="l03898"></a>03898                    <a class="code" href="AIInternals_8h.html#8d7f0222069571f630a99342fa534afe">RearrangePocket</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>,bWeaponIn,TEMPORARILY);
<a name="l03899"></a>03899              }
<a name="l03900"></a>03900 
<a name="l03901"></a>03901              <span class="comment">// get the minimum cost to attack with this knife</span>
<a name="l03902"></a>03902              ubMinAPCost = <a class="code" href="Points_8cpp.html#84f116b33524232723bfa74949877c21">MinAPsToAttack</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cd62bec1ef14927e4fb8ef7540273beb">sLastTarget</a>,DONTADDTURNCOST);
<a name="l03903"></a>03903 
<a name="l03904"></a>03904              <span class="comment">// if we can afford the minimum AP cost to stab with/throw this knife weapon</span>
<a name="l03905"></a>03905              <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt;= ubMinAPCost)
<a name="l03906"></a>03906                   {
<a name="l03907"></a>03907                         <span class="comment">// NB throwing knife in hand now</span>
<a name="l03908"></a>03908                    <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].usItem ].usItemClass &amp; IC_THROWING_KNIFE )
<a name="l03909"></a>03909                    {
<a name="l03910"></a>03910                          <span class="comment">// throwing knife code works like shooting</span>
<a name="l03911"></a>03911 
<a name="l03912"></a>03912                          <span class="comment">// look around for a worthy target (which sets BestStab.ubPossible)</span>
<a name="l03913"></a>03913                               <a class="code" href="AIInternals_8h.html#7282133f1f68ed6bcd129c1f71a92a69">CalcBestShot</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,&amp;BestStab,FALSE);
<a name="l03914"></a>03914 
<a name="l03915"></a>03915                               <span class="keywordflow">if</span> (BestStab.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a>)
<a name="l03916"></a>03916                               {
<a name="l03917"></a>03917                                     <span class="comment">// if the selected opponent is not a threat (unconscious &amp; !serviced)</span>
<a name="l03918"></a>03918                                     <span class="comment">// (usually, this means all the guys we see are unconscious, but, on</span>
<a name="l03919"></a>03919                                     <span class="comment">//  rare occasions, we may not be able to shoot a healthy guy, too)</span>
<a name="l03920"></a>03920                                     <span class="keywordflow">if</span> ((<a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[BestStab.<a class="code" href="structATTACKTYPE.html#4a3c834866b912b3fa371ac855e7be42">ubOpponent</a>].bLife &lt; OKLIFE) &amp;&amp;
<a name="l03921"></a>03921                                            !<a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[BestStab.<a class="code" href="structATTACKTYPE.html#4a3c834866b912b3fa371ac855e7be42">ubOpponent</a>].bService)
<a name="l03922"></a>03922                                     {
<a name="l03923"></a>03923                                           <span class="comment">// don't throw a knife at him.</span>
<a name="l03924"></a>03924                                           BestStab.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a> = FALSE;
<a name="l03925"></a>03925                                     }
<a name="l03926"></a>03926 
<a name="l03927"></a>03927                                     <span class="comment">// now we KNOW FOR SURE that we will do something (shoot, at least)</span>
<a name="l03928"></a>03928                                     <a class="code" href="AIInternals_8h.html#1dc658ff228f7a3273f69cd2a842fb3d">NPCDoesAct</a>(pSoldier);
<a name="l03929"></a>03929                                     DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"NPC decided to shoot (2)"</span>);
<a name="l03930"></a>03930                               }
<a name="l03931"></a>03931                    }
<a name="l03932"></a>03932                    <span class="keywordflow">else</span>
<a name="l03933"></a>03933                    {
<a name="l03934"></a>03934                          <span class="comment">//sprintf((CHAR *)tempstr,"%s - ubMinAPCost = %d",pSoldier-&gt;name,ubMinAPCost);</span>
<a name="l03935"></a>03935                          <span class="comment">//PopMessage(tempstr);</span>
<a name="l03936"></a>03936                                <span class="comment">// then look around for a worthy target (which sets BestStab.ubPossible)</span>
<a name="l03937"></a>03937                                <a class="code" href="AIInternals_8h.html#9d71ee0fbccfb3469420913f45727a48">CalcBestStab</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,&amp;BestStab, TRUE);
<a name="l03938"></a>03938 
<a name="l03939"></a>03939                                <span class="keywordflow">if</span> (BestStab.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a>)
<a name="l03940"></a>03940                                {
<a name="l03941"></a>03941                                      <span class="comment">// now we KNOW FOR SURE that we will do something (stab, at least)</span>
<a name="l03942"></a>03942                                      <a class="code" href="AIInternals_8h.html#1dc658ff228f7a3273f69cd2a842fb3d">NPCDoesAct</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l03943"></a>03943                                     DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"NPC decided to stab"</span>);
<a name="l03944"></a>03944                                }
<a name="l03945"></a>03945                    }
<a name="l03946"></a>03946 
<a name="l03947"></a>03947                   }
<a name="l03948"></a>03948 
<a name="l03949"></a>03949              <span class="comment">// if it was in his holster, swap it back into his holster for now</span>
<a name="l03950"></a>03950              <span class="keywordflow">if</span> (bWeaponIn != <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>)
<a name="l03951"></a>03951              {
<a name="l03952"></a>03952                   DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"about to rearrange pocket after stab check"</span>);
<a name="l03953"></a>03953                    <a class="code" href="AIInternals_8h.html#8d7f0222069571f630a99342fa534afe">RearrangePocket</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>,bWeaponIn,TEMPORARILY);
<a name="l03954"></a>03954              }
<a name="l03955"></a>03955    }
<a name="l03956"></a>03956 <span class="comment"></span>
<a name="l03957"></a>03957 <span class="comment">   //////////////////////////////////////////////////////////////////////////</span>
<a name="l03958"></a>03958 <span class="comment"></span>   <span class="comment">// CHOOSE THE BEST TYPE OF ATTACK OUT OF THOSE FOUND TO BE POSSIBLE</span><span class="comment"></span>
<a name="l03959"></a>03959 <span class="comment">   //////////////////////////////////////////////////////////////////////////</span>
<a name="l03960"></a>03960 <span class="comment"></span>      DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"CHOOSE THE BEST TYPE OF ATTACK OUT OF THOSE FOUND TO BE POSSIBLE"</span>);
<a name="l03961"></a>03961        <span class="keywordflow">if</span> (BestShot.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a>)
<a name="l03962"></a>03962        {
<a name="l03963"></a>03963             BestAttack.<a class="code" href="structATTACKTYPE.html#cdf5e73b5e726219882c6aec55364a30">iAttackValue</a> = BestShot.<a class="code" href="structATTACKTYPE.html#cdf5e73b5e726219882c6aec55364a30">iAttackValue</a>;
<a name="l03964"></a>03964             ubBestAttackAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6247fbdbad71e877e20dc79b610060b8">AI_ACTION_FIRE_GUN</a>;
<a name="l03965"></a>03965             DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"best action = fire gun"</span>);
<a name="l03966"></a>03966        }
<a name="l03967"></a>03967        <span class="keywordflow">else</span>
<a name="l03968"></a>03968        {
<a name="l03969"></a>03969             BestAttack.<a class="code" href="structATTACKTYPE.html#cdf5e73b5e726219882c6aec55364a30">iAttackValue</a> = 0;
<a name="l03970"></a>03970        }
<a name="l03971"></a>03971        <span class="keywordflow">if</span> (BestStab.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a> &amp;&amp; ((BestStab.<a class="code" href="structATTACKTYPE.html#cdf5e73b5e726219882c6aec55364a30">iAttackValue</a> &gt; BestAttack.<a class="code" href="structATTACKTYPE.html#cdf5e73b5e726219882c6aec55364a30">iAttackValue</a>) || (ubBestAttackAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>)))
<a name="l03972"></a>03972        {
<a name="l03973"></a>03973             BestAttack.<a class="code" href="structATTACKTYPE.html#cdf5e73b5e726219882c6aec55364a30">iAttackValue</a> = BestStab.<a class="code" href="structATTACKTYPE.html#cdf5e73b5e726219882c6aec55364a30">iAttackValue</a>;
<a name="l03974"></a>03974             <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[BestStab.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>].usItem ].usItemClass &amp; IC_THROWING_KNIFE )
<a name="l03975"></a>03975             {
<a name="l03976"></a>03976                   ubBestAttackAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b48a1dee24335dcbf15fd2d883fc6e243">AI_ACTION_THROW_KNIFE</a>;
<a name="l03977"></a>03977                   DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"best action = throw knife"</span>);
<a name="l03978"></a>03978             }
<a name="l03979"></a>03979             <span class="keywordflow">else</span>
<a name="l03980"></a>03980             {
<a name="l03981"></a>03981                   ubBestAttackAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bcc74cedcb5afbd32c5b21b1ecc59b9ec">AI_ACTION_KNIFE_MOVE</a>;
<a name="l03982"></a>03982                   DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"best action = move to stab"</span>);
<a name="l03983"></a>03983             }
<a name="l03984"></a>03984        }
<a name="l03985"></a>03985        <span class="keywordflow">if</span> (BestThrow.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a> &amp;&amp; ((BestThrow.<a class="code" href="structATTACKTYPE.html#cdf5e73b5e726219882c6aec55364a30">iAttackValue</a> &gt; BestAttack.<a class="code" href="structATTACKTYPE.html#cdf5e73b5e726219882c6aec55364a30">iAttackValue</a>) || (ubBestAttackAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>)))
<a name="l03986"></a>03986        {
<a name="l03987"></a>03987             ubBestAttackAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b260e54a79dd8e6db573a8216c3a63efc">AI_ACTION_TOSS_PROJECTILE</a>;
<a name="l03988"></a>03988             DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"best action = throw something"</span>);
<a name="l03989"></a>03989        }
<a name="l03990"></a>03990 
<a name="l03991"></a>03991        <span class="keywordflow">if</span> ( ( ubBestAttackAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> ) &amp;&amp; fTryPunching )
<a name="l03992"></a>03992        {
<a name="l03993"></a>03993              <span class="comment">// nothing (else) to attack with so let's try hand-to-hand</span>
<a name="l03994"></a>03994              bWeaponIn = <a class="code" href="Items_8cpp.html#cf039d4426a0e9954cbb7ab45a90f157">FindObjWithin</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, NOTHING, <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>, <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855e7a9bbc37a973fe20ce49d9b0fade02e">SMALLPOCK8POS</a> );
<a name="l03995"></a>03995 
<a name="l03996"></a>03996              <span class="keywordflow">if</span> (bWeaponIn != NO_SLOT)
<a name="l03997"></a>03997              {
<a name="l03998"></a>03998                    BestStab.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> = bWeaponIn;
<a name="l03999"></a>03999                    <span class="comment">// if it's in his holster, swap it into his hand temporarily</span>
<a name="l04000"></a>04000                    <span class="keywordflow">if</span> (bWeaponIn != <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>)
<a name="l04001"></a>04001                    {
<a name="l04002"></a>04002                          DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionblack: swap knife into hand"</span>);
<a name="l04003"></a>04003                          <a class="code" href="AIInternals_8h.html#8d7f0222069571f630a99342fa534afe">RearrangePocket</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>,bWeaponIn,TEMPORARILY);
<a name="l04004"></a>04004                    }
<a name="l04005"></a>04005 
<a name="l04006"></a>04006                    <span class="comment">// get the minimum cost to attack by HTH</span>
<a name="l04007"></a>04007                    ubMinAPCost = <a class="code" href="Points_8cpp.html#84f116b33524232723bfa74949877c21">MinAPsToAttack</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#cd62bec1ef14927e4fb8ef7540273beb">sLastTarget</a>,DONTADDTURNCOST);
<a name="l04008"></a>04008 
<a name="l04009"></a>04009                    <span class="comment">// if we can afford the minimum AP cost to use HTH combat</span>
<a name="l04010"></a>04010                    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt;= ubMinAPCost)
<a name="l04011"></a>04011                         {
<a name="l04012"></a>04012                          <span class="comment">// then look around for a worthy target (which sets BestStab.ubPossible)</span>
<a name="l04013"></a>04013                          <a class="code" href="AIInternals_8h.html#9d71ee0fbccfb3469420913f45727a48">CalcBestStab</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,&amp;BestStab, FALSE);
<a name="l04014"></a>04014 
<a name="l04015"></a>04015                          <span class="keywordflow">if</span> (BestStab.<a class="code" href="structATTACKTYPE.html#091cb03c014f1260f743a2cdbc6da859">ubPossible</a>)
<a name="l04016"></a>04016                          {
<a name="l04017"></a>04017                                <span class="comment">// now we KNOW FOR SURE that we will do something (stab, at least)</span>
<a name="l04018"></a>04018                                <a class="code" href="AIInternals_8h.html#1dc658ff228f7a3273f69cd2a842fb3d">NPCDoesAct</a>(pSoldier);
<a name="l04019"></a>04019                                ubBestAttackAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bcc74cedcb5afbd32c5b21b1ecc59b9ec">AI_ACTION_KNIFE_MOVE</a>;
<a name="l04020"></a>04020                                DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"NPC decided to move to stab"</span>);
<a name="l04021"></a>04021                          }
<a name="l04022"></a>04022                         }
<a name="l04023"></a>04023 
<a name="l04024"></a>04024                    <span class="comment">// if it was in his holster, swap it back into his holster for now</span>
<a name="l04025"></a>04025                    <span class="keywordflow">if</span> (bWeaponIn != <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>)
<a name="l04026"></a>04026                    {
<a name="l04027"></a>04027                          DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"decideactionblack: about to put knife away"</span>);
<a name="l04028"></a>04028                          <a class="code" href="AIInternals_8h.html#8d7f0222069571f630a99342fa534afe">RearrangePocket</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>,bWeaponIn,TEMPORARILY);
<a name="l04029"></a>04029                    }
<a name="l04030"></a>04030              }
<a name="l04031"></a>04031        }
<a name="l04032"></a>04032 
<a name="l04033"></a>04033 
<a name="l04034"></a>04034 
<a name="l04035"></a>04035        <span class="comment">// copy the information on the best action selected into BestAttack struct</span>
<a name="l04036"></a>04036    DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"copy the information on the best action selected into BestAttack struct"</span>);
<a name="l04037"></a>04037    <span class="keywordflow">switch</span> (ubBestAttackAction)
<a name="l04038"></a>04038    {
<a name="l04039"></a>04039      <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6247fbdbad71e877e20dc79b610060b8">AI_ACTION_FIRE_GUN</a>:
<a name="l04040"></a>04040        memcpy(&amp;BestAttack,&amp;BestShot,<span class="keyword">sizeof</span>(BestAttack));
<a name="l04041"></a>04041          DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"DecideActionBlack: best attack = firing a gun"</span>);
<a name="l04042"></a>04042        <span class="keywordflow">break</span>;
<a name="l04043"></a>04043 
<a name="l04044"></a>04044      <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b260e54a79dd8e6db573a8216c3a63efc">AI_ACTION_TOSS_PROJECTILE</a>:
<a name="l04045"></a>04045        memcpy(&amp;BestAttack,&amp;BestThrow,<span class="keyword">sizeof</span>(BestAttack));
<a name="l04046"></a>04046          DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"DecideActionBlack: best attack = tossing a grenade"</span>);
<a name="l04047"></a>04047        <span class="keywordflow">break</span>;
<a name="l04048"></a>04048 
<a name="l04049"></a>04049              <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b48a1dee24335dcbf15fd2d883fc6e243">AI_ACTION_THROW_KNIFE</a>:
<a name="l04050"></a>04050      <span class="keywordflow">case</span> <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bcc74cedcb5afbd32c5b21b1ecc59b9ec">AI_ACTION_KNIFE_MOVE</a>:
<a name="l04051"></a>04051          DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"DecideActionBlack: best attack = stab with a knife"</span>);
<a name="l04052"></a>04052        memcpy(&amp;BestAttack,&amp;BestStab,<span class="keyword">sizeof</span>(BestAttack));
<a name="l04053"></a>04053        <span class="keywordflow">break</span>;
<a name="l04054"></a>04054 
<a name="l04055"></a>04055              <span class="keywordflow">default</span>:
<a name="l04056"></a>04056                    <span class="comment">// set to empty</span>
<a name="l04057"></a>04057                  DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"DecideActionBlack: best attack = no good attack"</span>);
<a name="l04058"></a>04058                    memset( &amp;BestAttack, 0, <span class="keyword">sizeof</span>( BestAttack ) );
<a name="l04059"></a>04059                    <span class="keywordflow">break</span>;
<a name="l04060"></a>04060        }
<a name="l04061"></a>04061  }
<a name="l04062"></a>04062 
<a name="l04063"></a>04063  <span class="comment">// NB a desire of 4 or more is only achievable by brave/aggressive guys with high morale</span>
<a name="l04064"></a>04064  <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7b0593c9a8052ede05e98cc24c2d9667">bInitialActionPoints</a> &amp;&amp; ubBestAttackAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6247fbdbad71e877e20dc79b610060b8">AI_ACTION_FIRE_GUN</a> &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f9d318c8e6c8f11cf39d8c039f24858a">bShock</a> == 0) &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a> &gt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#600d382f89a391cdeb7bfe2580776866">bLifeMax</a> / 2) &amp;&amp; BestAttack.<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a> &lt; 30 &amp;&amp; ( <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a> ) &gt; <a class="code" href="Weapons_8cpp.html#fac72e30bc7c36f55257eac0542ce51d">Weapon</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> ].usItem ].usRange / CELL_X_SIZE ) &amp;&amp; <a class="code" href="AIInternals_8h.html#d899dd2062422736f741cce6b456781d">RangeChangeDesire</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &gt;= 4 )
<a name="l04065"></a>04065  {
<a name="l04066"></a>04066        <span class="comment">// okay, really got to wonder about this... could taking cover be an option?</span>
<a name="l04067"></a>04067        <span class="keywordflow">if</span> (ubCanMove &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> != <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a> &amp;&amp; !<a class="code" href="TeamTurns_8cpp.html#782955f80e251720a735649d4e8a5987">gfHiddenInterrupt</a> &amp;&amp;
<a name="l04068"></a>04068                   !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_BOXER) )
<a name="l04069"></a>04069        {
<a name="l04070"></a>04070              <span class="comment">// make militia a bit more cautious</span>
<a name="l04071"></a>04071              <span class="keywordflow">if</span> ( ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == MILITIA_TEAM) &amp;&amp; (<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 20 ) &gt; BestAttack.<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a>) )
<a name="l04072"></a>04072                || ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != MILITIA_TEAM) &amp;&amp; (<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 40 ) &gt; BestAttack.<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a>) ) )
<a name="l04073"></a>04073              {
<a name="l04074"></a>04074               <span class="comment">//ScreenMsg( FONT_MCOLOR_LTYELLOW, MSG_TESTVERSION, L"AI %d allowing cover check, chance to hit is only %d, at range %d", BestAttack.ubChanceToReallyHit, PythSpacesAway( pSoldier-&gt;sGridNo, BestAttack.sTarget ) );</span>
<a name="l04075"></a>04075                   <span class="comment">// maybe taking cover would be better!</span>
<a name="l04076"></a>04076                   fAllowCoverCheck = TRUE;
<a name="l04077"></a>04077                   <span class="keywordflow">if</span> ( <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 10 ) &gt; BestAttack.<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a> )
<a name="l04078"></a>04078                   {
<a name="l04079"></a>04079                      DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"DecideActionBlack: can't hit so screw the attack"</span>);
<a name="l04080"></a>04080                         <span class="comment">// screw the attack!</span>
<a name="l04081"></a>04081                         ubBestAttackAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l04082"></a>04082                   }
<a name="l04083"></a>04083              }
<a name="l04084"></a>04084        }
<a name="l04085"></a>04085 
<a name="l04086"></a>04086  }
<a name="l04087"></a>04087 
<a name="l04088"></a>04088 
<a name="l04089"></a>04089    DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"LOOK FOR SOME KIND OF COVER BETTER THAN WHAT WE HAVE NOW"</span>);<span class="comment"></span>
<a name="l04090"></a>04090 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04091"></a>04091 <span class="comment"></span> <span class="comment">// LOOK FOR SOME KIND OF COVER BETTER THAN WHAT WE HAVE NOW</span><span class="comment"></span>
<a name="l04092"></a>04092 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04093"></a>04093 <span class="comment"></span>
<a name="l04094"></a>04094  <span class="comment">// if soldier has enough APs left to move at least 1 square's worth,</span>
<a name="l04095"></a>04095  <span class="comment">// and either he can't attack any more, or his attack did wound someone</span>
<a name="l04096"></a>04096  <span class="keywordflow">if</span> ( (ubCanMove &amp;&amp; !<a class="code" href="AIInternals_8h.html#73a8d5c2a31d1969d497d7daf60b16f3">SkipCoverCheck</a> &amp;&amp; !<a class="code" href="TeamTurns_8cpp.html#782955f80e251720a735649d4e8a5987">gfHiddenInterrupt</a> &amp;&amp;
<a name="l04097"></a>04097       ((ubBestAttackAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>) || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#657bbd7f43de0a9f3d1bff0cb350c024">bLastAttackHit</a>) &amp;&amp;
<a name="l04098"></a>04098             (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp; AI_RTP_OPTION_CAN_SEEK_COVER) &amp;&amp; 
<a name="l04099"></a>04099               !(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_BOXER) )
<a name="l04100"></a>04100                   || fAllowCoverCheck )
<a name="l04101"></a>04101  {
<a name="l04102"></a>04102       sBestCover = <a class="code" href="ai_8h.html#0b7c3b2ba83ca87cfa5a3ebc680471a2">FindBestNearbyCover</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a>,&amp;iCoverPercentBetter);
<a name="l04103"></a>04103  }
<a name="l04104"></a>04104 
<a name="l04105"></a>04105 
<a name="l04106"></a>04106 <span class="preprocessor">#ifdef RETREAT_TESTING</span>
<a name="l04107"></a>04107 <span class="preprocessor"></span>      sBestCover = NOWHERE;
<a name="l04108"></a>04108 <span class="preprocessor">#endif</span>
<a name="l04109"></a>04109 <span class="preprocessor"></span>
<a name="l04110"></a>04110   DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"DecideActionBlack: DECIDE BETWEEN ATTACKING AND DEFENDING (TAKING COVER)"</span>);<span class="comment"></span>
<a name="l04111"></a>04111 <span class="comment"> //////////////////////////////////////////////////////////////////////////</span>
<a name="l04112"></a>04112 <span class="comment"></span> <span class="comment">// IF NECESSARY, DECIDE BETWEEN ATTACKING AND DEFENDING (TAKING COVER)</span><span class="comment"></span>
<a name="l04113"></a>04113 <span class="comment"> //////////////////////////////////////////////////////////////////////////</span>
<a name="l04114"></a>04114 <span class="comment"></span>
<a name="l04115"></a>04115  <span class="comment">// if both are possible</span>
<a name="l04116"></a>04116  <span class="keywordflow">if</span> ((ubBestAttackAction != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>) &amp;&amp; (sBestCover != NOWHERE))
<a name="l04117"></a>04117  {
<a name="l04118"></a>04118    <span class="comment">// gotta compare their merits and select the more desirable option</span>
<a name="l04119"></a>04119    iOffense = BestAttack.<a class="code" href="structATTACKTYPE.html#a5ef0a9c5f06475a011ec0d4645b452f">ubChanceToReallyHit</a>;
<a name="l04120"></a>04120    iDefense = iCoverPercentBetter;
<a name="l04121"></a>04121 
<a name="l04122"></a>04122    <span class="comment">// based on how we feel about the situation, decide whether to attack first</span>
<a name="l04123"></a>04123    <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a>)
<a name="l04124"></a>04124    {
<a name="l04125"></a>04125      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e34e0b5e2e2be99f4e43c1321cf58b19ad">MORALE_FEARLESS</a>:
<a name="l04126"></a>04126        iOffense += iOffense / 2;    <span class="comment">// increase 50%</span>
<a name="l04127"></a>04127        <span class="keywordflow">break</span>;
<a name="l04128"></a>04128 
<a name="l04129"></a>04129      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e397b51ec5a452f3c4ebcddfd426c0485c">MORALE_CONFIDENT</a>:
<a name="l04130"></a>04130        iOffense += iOffense / 4;    <span class="comment">// increase 25%</span>
<a name="l04131"></a>04131        <span class="keywordflow">break</span>;
<a name="l04132"></a>04132 
<a name="l04133"></a>04133      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e3ace720f60b0c5dd9ffeb0df82fa6b4e0">MORALE_NORMAL</a>:
<a name="l04134"></a>04134        <span class="keywordflow">break</span>;
<a name="l04135"></a>04135 
<a name="l04136"></a>04136      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e3babad6ffb594c707f4cf71479ecac899">MORALE_WORRIED</a>:
<a name="l04137"></a>04137        iDefense += iDefense / 4;    <span class="comment">// increase 25%</span>
<a name="l04138"></a>04138        <span class="keywordflow">break</span>;
<a name="l04139"></a>04139 
<a name="l04140"></a>04140      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e360129a915d611934bca8624d0ea8e21e">MORALE_HOPELESS</a>:
<a name="l04141"></a>04141        iDefense += iDefense / 2;    <span class="comment">// increase 50%</span>
<a name="l04142"></a>04142        <span class="keywordflow">break</span>;
<a name="l04143"></a>04143        }
<a name="l04144"></a>04144 
<a name="l04145"></a>04145 
<a name="l04146"></a>04146    <span class="comment">// smart guys more likely to try to stay alive, dolts more likely to shoot!</span>
<a name="l04147"></a>04147    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4e9c2ad5d84963b9a6fc6f092bed8638">bWisdom</a> &gt;= 50) <span class="comment">//Madd: reduced the wisdom required to want to live...</span>
<a name="l04148"></a>04148      iDefense += 10;
<a name="l04149"></a>04149    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4e9c2ad5d84963b9a6fc6f092bed8638">bWisdom</a> &lt; 30)
<a name="l04150"></a>04150      iDefense -= 10;
<a name="l04151"></a>04151 
<a name="l04152"></a>04152    <span class="comment">// some orders are more offensive, others more defensive</span>
<a name="l04153"></a>04153    <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>)
<a name="l04154"></a>04154      iOffense += 10;
<a name="l04155"></a>04155    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>) || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>) || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> )
<a name="l04156"></a>04156      iDefense += 10;
<a name="l04157"></a>04157 
<a name="l04158"></a>04158    <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>)
<a name="l04159"></a>04159    {
<a name="l04160"></a>04160      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:          iDefense += 30; <span class="keywordflow">break</span>;
<a name="l04161"></a>04161      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:          iDefense -= 0; <span class="keywordflow">break</span>;
<a name="l04162"></a>04162      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:                 iDefense -= 0; <span class="keywordflow">break</span>;
<a name="l04163"></a>04163      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:  iDefense += 20; <span class="keywordflow">break</span>;
<a name="l04164"></a>04164      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:         iDefense += 20; <span class="keywordflow">break</span>;
<a name="l04165"></a>04165      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:         iOffense += 10; <span class="keywordflow">break</span>;
<a name="l04166"></a>04166              <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>:iOffense += 30; <span class="keywordflow">break</span>;
<a name="l04167"></a>04167    }
<a name="l04168"></a>04168 
<a name="l04169"></a>04169 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l04170"></a>04170 <span class="preprocessor"></span>      <a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a> tempstr=<span class="stringliteral">""</span>;
<a name="l04171"></a>04171       sprintf((CHAR *) tempstr, <span class="stringliteral">"%s - CHOICE: iOffense = %d, iDefense = %d\n"</span>,
<a name="l04172"></a>04172                            <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,iOffense,iDefense);
<a name="l04173"></a>04173       <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( tempstr );
<a name="l04174"></a>04174 <span class="preprocessor">#endif</span>
<a name="l04175"></a>04175 <span class="preprocessor"></span>
<a name="l04176"></a>04176   DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"DecideActionBlack: if his defensive instincts win out, forget all about the attack"</span>);
<a name="l04177"></a>04177    <span class="comment">// if his defensive instincts win out, forget all about the attack</span>
<a name="l04178"></a>04178    <span class="keywordflow">if</span> (iDefense &gt; iOffense)
<a name="l04179"></a>04179      ubBestAttackAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l04180"></a>04180  }
<a name="l04181"></a>04181 
<a name="l04182"></a>04182 
<a name="l04183"></a>04183   DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionBlack: is attack still desirable?  ubBestAttackAction = %d"</span>,ubBestAttackAction));
<a name="l04184"></a>04184 
<a name="l04185"></a>04185       <span class="comment">// if attack is still desirable (meaning it's also preferred to taking cover)</span>
<a name="l04186"></a>04186       <span class="keywordflow">if</span> (ubBestAttackAction != <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>)
<a name="l04187"></a>04187       {
<a name="l04188"></a>04188         DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"DecideActionBlack: attack is still desirable (meaning it's also preferred to taking cover)"</span>);
<a name="l04189"></a>04189             <span class="comment">// if we wanted to be REALLY mean, we could look at chance to hit and decide whether</span>
<a name="l04190"></a>04190             <span class="comment">// to shoot at the head...</span>
<a name="l04191"></a>04191 
<a name="l04192"></a>04192             fChangeStanceFirst = FALSE;
<a name="l04193"></a>04193 
<a name="l04194"></a>04194             <span class="comment">// default settings</span>
<a name="l04195"></a>04195             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f4d35b19eed93ae72b4bb54c4e6e8a3e">bAimTime</a>                  = BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a>;
<a name="l04196"></a>04196             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#dd307dffd553de4a1e01f74c050e6e07">bDoBurst</a>                  = 0;
<a name="l04197"></a>04197 
<a name="l04198"></a>04198             <span class="keywordflow">if</span> (ubBestAttackAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6247fbdbad71e877e20dc79b610060b8">AI_ACTION_FIRE_GUN</a>)
<a name="l04199"></a>04199             {
<a name="l04200"></a>04200                   <span class="comment">// Do we need to change stance?  NB We'll have to ready our gun again</span>
<a name="l04201"></a>04201                   <span class="keywordflow">if</span> ( !TANK( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &amp;&amp; ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> - (BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> - BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a>) ) &gt;= (AP_CROUCH + <a class="code" href="Points_8cpp.html#79d7f90b12d50906a6f34bee3ac1d28d">GetAPsToReadyWeapon</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ) ) )
<a name="l04202"></a>04202                   {     
<a name="l04203"></a>04203                         <span class="comment">// since the AI considers shooting chance from standing primarily, if we are not</span>
<a name="l04204"></a>04204                         <span class="comment">// standing we should always consider a stance change</span>
<a name="l04205"></a>04205                         <span class="keywordflow">if</span> ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight != ANIM_STAND )
<a name="l04206"></a>04206                         {
<a name="l04207"></a>04207                               iChance = 100;
<a name="l04208"></a>04208                         }
<a name="l04209"></a>04209                         <span class="keywordflow">else</span>
<a name="l04210"></a>04210                         {
<a name="l04211"></a>04211                               iChance = 50;
<a name="l04212"></a>04212                               <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>)
<a name="l04213"></a>04213                               {
<a name="l04214"></a>04214                                      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:        iChance += 20; <span class="keywordflow">break</span>;
<a name="l04215"></a>04215                                      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:        iChance -= 10; <span class="keywordflow">break</span>;
<a name="l04216"></a>04216                                      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:               iChance -= 10; <span class="keywordflow">break</span>;
<a name="l04217"></a>04217                                      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:      iChance += 10; <span class="keywordflow">break</span>;
<a name="l04218"></a>04218                                      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:       iChance += 10; <span class="keywordflow">break</span>;
<a name="l04219"></a>04219                                      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:       iChance -= 20; <span class="keywordflow">break</span>;
<a name="l04220"></a>04220                                      <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>: iChance -= 30; <span class="keywordflow">break</span>;
<a name="l04221"></a>04221                               }
<a name="l04222"></a>04222                         }
<a name="l04223"></a>04223 
<a name="l04224"></a>04224                         <span class="keywordflow">if</span> ( (<a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>)<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 100 ) &lt; iChance || <a class="code" href="Isometric_01Utils_8cpp.html#cec8f2eef3f8131c6e7f0077541ca470">GetRangeInCellCoordsFromGridNoDiff</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a> ) &lt;= MIN_PRONE_RANGE )
<a name="l04225"></a>04225                         {
<a name="l04226"></a>04226 
<a name="l04227"></a>04227                               <span class="comment">// first get the direction, as we will need to pass that in to ShootingStanceChange</span>
<a name="l04228"></a>04228                               bDirection = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>(<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>));
<a name="l04229"></a>04229 
<a name="l04230"></a>04230                               ubBestStance = <a class="code" href="AIInternals_8h.html#6a46acf8f9f70a1a5099eb30a20372cf">ShootingStanceChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;BestAttack, bDirection );
<a name="l04231"></a>04231                               <span class="keywordflow">if</span> (ubBestStance != 0)
<a name="l04232"></a>04232                               {
<a name="l04233"></a>04233                                     <span class="comment">// change stance first!</span>
<a name="l04234"></a>04234                                     <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> != bDirection &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, bDirection, <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight ) )
<a name="l04235"></a>04235                                     {
<a name="l04236"></a>04236                                           <span class="comment">// we're not facing towards him, so turn first!</span>
<a name="l04237"></a>04237                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = bDirection;
<a name="l04238"></a>04238 
<a name="l04239"></a>04239 <span class="preprocessor">                                          #ifdef DEBUGDECISIONS</span>
<a name="l04240"></a>04240 <span class="preprocessor"></span>                                                sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - TURNS to face CLOSEST OPPONENT in direction %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l04241"></a>04241                                                 <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l04242"></a>04242 <span class="preprocessor">                                          #endif</span>
<a name="l04243"></a>04243 <span class="preprocessor"></span>
<a name="l04244"></a>04244                                           <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>);
<a name="l04245"></a>04245                                     }
<a name="l04246"></a>04246 
<a name="l04247"></a>04247 <span class="comment">//                                  pSoldier-&gt;usActionData = ubBestStance;</span>
<a name="l04248"></a>04248 
<a name="l04249"></a>04249                                     <span class="comment">// attack after we change stance</span>
<a name="l04250"></a>04250                                     <span class="comment">// we don't just return here because we want to check whether to</span>
<a name="l04251"></a>04251                                     <span class="comment">// burst first</span>
<a name="l04252"></a>04252                                     fChangeStanceFirst = TRUE;
<a name="l04253"></a>04253 
<a name="l04254"></a>04254                                     <span class="comment">// account for increased AP cost</span>
<a name="l04255"></a>04255                                     ubStanceCost = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) <a class="code" href="Points_8cpp.html#69f88541b84e4d9890e0b786199e9a3a">GetAPsToChangeStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubBestStance );
<a name="l04256"></a>04256                                     <span class="keywordflow">if</span> ( BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> + ubStanceCost &gt; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> )
<a name="l04257"></a>04257                                     {
<a name="l04258"></a>04258                                           <span class="comment">// AP cost would balance (plus X, minus X) but aim time is reduced</span>
<a name="l04259"></a>04259                                           BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> -= (BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> - ubStanceCost);
<a name="l04260"></a>04260                                     }
<a name="l04261"></a>04261                                     <span class="keywordflow">else</span>
<a name="l04262"></a>04262                                     {
<a name="l04263"></a>04263                                           BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> += <a class="code" href="Points_8cpp.html#69f88541b84e4d9890e0b786199e9a3a">GetAPsToChangeStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubBestStance );
<a name="l04264"></a>04264                                     }
<a name="l04265"></a>04265 
<a name="l04266"></a>04266                               }
<a name="l04267"></a>04267                         }
<a name="l04268"></a>04268                   }
<a name="l04269"></a>04269 <span class="comment"></span>
<a name="l04270"></a>04270 <span class="comment">                  //////////////////////////////////////////////////////////////////////////</span>
<a name="l04271"></a>04271 <span class="comment"></span>                  <span class="comment">// IF ENOUGH APs TO BURST, RANDOM CHANCE OF DOING SO</span><span class="comment"></span>
<a name="l04272"></a>04272 <span class="comment">                  //////////////////////////////////////////////////////////////////////////</span>
<a name="l04273"></a>04273 <span class="comment"></span>      
<a name="l04274"></a>04274                   <span class="keywordflow">if</span> (<a class="code" href="Weapons_8cpp.html#127b65951598cb6031a8a2862d654bf9">IsGunBurstCapable</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>, FALSE ) &amp;&amp;
<a name="l04275"></a>04275                         !(<a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[BestShot.<a class="code" href="structATTACKTYPE.html#4a3c834866b912b3fa371ac855e7be42">ubOpponent</a>].bLife &lt; OKLIFE) &amp;&amp; <span class="comment">// don't burst at downed targets</span>
<a name="l04276"></a>04276                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>].ubGunShotsLeft &gt; 1 &amp;&amp;
<a name="l04277"></a>04277                         (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#632ca06a3de72d8deb1d7d1777955e4a">bRTPCombat</a> == RTP_COMBAT_AGGRESSIVE) )
<a name="l04278"></a>04278                   {
<a name="l04279"></a>04279                     DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"DecideActionBlack: ENOUGH APs TO BURST, RANDOM CHANCE OF DOING SO"</span>);
<a name="l04280"></a>04280 
<a name="l04281"></a>04281                         ubBurstAPs = <a class="code" href="Points_8cpp.html#e185748f40819bf798a0a3247a08e4d0">CalcAPsToBurst</a>( <a class="code" href="Soldier_01Control_8cpp.html#567738f5c11e8c81fa661e6aff177224">CalcActionPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ), &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>]) );
<a name="l04282"></a>04282 
<a name="l04283"></a>04283                         <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> - (BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> - BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a>) &gt;= ubBurstAPs )
<a name="l04284"></a>04284                         {
<a name="l04285"></a>04285                               <span class="comment">// Base chance of bursting is 25% if best shot was +0 aim, down to 8% at +4</span>
<a name="l04286"></a>04286                               <span class="keywordflow">if</span> ( TANK( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l04287"></a>04287                               {
<a name="l04288"></a>04288                                     iChance = 100;
<a name="l04289"></a>04289                               }
<a name="l04290"></a>04290                               <span class="keywordflow">else</span>
<a name="l04291"></a>04291                               {
<a name="l04292"></a>04292                                     iChance = (25 / max((BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> + 1),1));
<a name="l04293"></a>04293                                     <span class="keywordflow">switch</span> (pSoldier-&gt;bAttitude)
<a name="l04294"></a>04294                                     {
<a name="l04295"></a>04295                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:         iChance += -5; <span class="keywordflow">break</span>;
<a name="l04296"></a>04296                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:         iChance +=  5; <span class="keywordflow">break</span>;
<a name="l04297"></a>04297                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:          iChance +=  5; <span class="keywordflow">break</span>;
<a name="l04298"></a>04298                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>: iChance +=  0; <span class="keywordflow">break</span>;
<a name="l04299"></a>04299                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:  iChance +=  0; <span class="keywordflow">break</span>;
<a name="l04300"></a>04300                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:  iChance += 10; <span class="keywordflow">break</span>;
<a name="l04301"></a>04301                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>:iChance += 30; <span class="keywordflow">break</span>;
<a name="l04302"></a>04302                                     }
<a name="l04303"></a>04303 
<a name="l04304"></a>04304                                     <span class="keywordflow">if</span> ( pSoldier-&gt;inv[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>].ubGunShotsLeft &gt; 50 )
<a name="l04305"></a>04305                                           iChance += 20;
<a name="l04306"></a>04306 
<a name="l04307"></a>04307                                     <span class="comment">// increase chance based on proximity and difficulty of enemy</span>
<a name="l04308"></a>04308                                     <span class="keywordflow">if</span> ( <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( pSoldier-&gt;sGridNo, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a> ) &lt; 15 )
<a name="l04309"></a>04309                                     {
<a name="l04310"></a>04310                                           DebugMsg(<a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionBlack: check chance to burst"</span>));
<a name="l04311"></a>04311                                           iChance += ( 15 - <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( pSoldier-&gt;sGridNo, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a> ) ) * ( 1 + <a class="code" href="ai_8h.html#eb68d5bd7803b8c6d4637cf543b9372c">SoldierDifficultyLevel</a>( pSoldier ) );
<a name="l04312"></a>04312                                           <span class="keywordflow">if</span> ( pSoldier-&gt;bAttitude == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a> )
<a name="l04313"></a>04313                                           {
<a name="l04314"></a>04314                                                 <span class="comment">// increase it more!</span>
<a name="l04315"></a>04315                                                 iChance += 5 * ( 15 - <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( pSoldier-&gt;sGridNo, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a> ) );
<a name="l04316"></a>04316                                           }
<a name="l04317"></a>04317                                     }
<a name="l04318"></a>04318                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( pSoldier-&gt;sGridNo, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a> ) &lt; 10 &amp;&amp; <a class="code" href="GameSettings_8cpp.html#f9f2d5fd368ccadcc26bebc202d52ae7">gGameOptions</a>.<a class="code" href="structGAME__OPTIONS.html#4fb44167906152722f6af5cc9f7c1a99">ubDifficultyLevel</a> &gt; <a class="code" href="GameSettings_8h.html#c205be2172292384dd687b5471a87eddbd3b0d23f4dc30ef17b50a14c3f54589">DIF_LEVEL_EASY</a> )
<a name="l04319"></a>04319                                     {
<a name="l04320"></a>04320                                           iChance += 100;
<a name="l04321"></a>04321                                     }
<a name="l04322"></a>04322                               }
<a name="l04323"></a>04323 
<a name="l04324"></a>04324                               <span class="keywordflow">if</span> ( (<a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 100 ) &lt; iChance)
<a name="l04325"></a>04325                               {
<a name="l04326"></a>04326                                     BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> = BURSTING;
<a name="l04327"></a>04327                                     BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> = BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> - BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> + <a class="code" href="Points_8cpp.html#e185748f40819bf798a0a3247a08e4d0">CalcAPsToBurst</a>( <a class="code" href="Soldier_01Control_8cpp.html#567738f5c11e8c81fa661e6aff177224">CalcActionPoints</a>( pSoldier ), &amp;(pSoldier-&gt;inv[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>]) );
<a name="l04328"></a>04328                                     <span class="comment">// check for spread burst possibilities</span>
<a name="l04329"></a>04329                                     <span class="keywordflow">if</span> (pSoldier-&gt;bAttitude != <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>)
<a name="l04330"></a>04330                                     {
<a name="l04331"></a>04331                                           <a class="code" href="AIInternals_8h.html#be1adbccdd358afca93b507465956d39">CalcSpreadBurst</a>( pSoldier, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>, BestAttack.<a class="code" href="structATTACKTYPE.html#f32b20868939af7812b7d6329e128a0d">bTargetLevel</a> );
<a name="l04332"></a>04332                                     }
<a name="l04333"></a>04333                               }
<a name="l04334"></a>04334                         }
<a name="l04335"></a>04335                   }
<a name="l04336"></a>04336 
<a name="l04337"></a>04337                   <span class="keywordflow">if</span> (<a class="code" href="Weapons_8cpp.html#cef18bd30ec42870bea965f4bdc4e6ba">IsGunAutofireCapable</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> ) &amp;&amp;
<a name="l04338"></a>04338                         !(<a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[BestShot.<a class="code" href="structATTACKTYPE.html#4a3c834866b912b3fa371ac855e7be42">ubOpponent</a>].bLife &lt; OKLIFE) &amp;&amp; <span class="comment">// don't burst at downed targets</span>
<a name="l04339"></a>04339                         (( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>].ubGunShotsLeft &gt; 1 &amp;&amp;
<a name="l04340"></a>04340                         BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> != BURSTING ) || <a class="code" href="Weapons_8cpp.html#fac72e30bc7c36f55257eac0542ce51d">Weapon</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>].usItem].NoSemiAuto) )
<a name="l04341"></a>04341                   {
<a name="l04342"></a>04342                           DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"DecideActionBlack: ENOUGH APs TO AUTOFIRE, RANDOM CHANCE OF DOING SO"</span>);
<a name="l04343"></a>04343                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a> = 0;
<a name="l04344"></a>04344                         <span class="keywordflow">do</span>
<a name="l04345"></a>04345                         {
<a name="l04346"></a>04346                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a>++;
<a name="l04347"></a>04347                               ubBurstAPs = <a class="code" href="Points_8cpp.html#5c543e8467258f9559f37c5380130c05">CalcAPsToAutofire</a>( <a class="code" href="Soldier_01Control_8cpp.html#567738f5c11e8c81fa661e6aff177224">CalcActionPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ), &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>]), <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a> );
<a name="l04348"></a>04348                         }
<a name="l04349"></a>04349                         <span class="keywordflow">while</span>(      <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> - (BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> - BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a>) &gt; ubBurstAPs &amp;&amp;
<a name="l04350"></a>04350                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].ubGunShotsLeft &gt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a> &amp;&amp;
<a name="l04351"></a>04351                                     <a class="code" href="Weapons_8cpp.html#96fc5621e834538c05f285ebcedebdaf">GetAutoPenalty</a>(&amp;<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> ], <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight == ANIM_PRONE)*<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a> &lt;= 80);
<a name="l04352"></a>04352                         
<a name="l04353"></a>04353                         
<a name="l04354"></a>04354                         
<a name="l04355"></a>04355                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a>--;
<a name="l04356"></a>04356                         ubBurstAPs = <a class="code" href="Points_8cpp.html#5c543e8467258f9559f37c5380130c05">CalcAPsToAutofire</a>( <a class="code" href="Soldier_01Control_8cpp.html#567738f5c11e8c81fa661e6aff177224">CalcActionPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ), &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>]), <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a> );
<a name="l04357"></a>04357 
<a name="l04358"></a>04358                         <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> - (BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> - BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a>) &gt;= ubBurstAPs )
<a name="l04359"></a>04359                         {
<a name="l04360"></a>04360                               <span class="comment">// Base chance of bursting is 25% if best shot was +0 aim, down to 8% at +4</span>
<a name="l04361"></a>04361                               <span class="keywordflow">if</span> ( TANK( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l04362"></a>04362                               {
<a name="l04363"></a>04363                                     iChance = 100;
<a name="l04364"></a>04364                               }
<a name="l04365"></a>04365                               <span class="keywordflow">else</span>
<a name="l04366"></a>04366                               {
<a name="l04367"></a>04367                                     iChance = (100 / max((BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> + 1),1));
<a name="l04368"></a>04368                                     <span class="keywordflow">switch</span> (pSoldier-&gt;bAttitude)
<a name="l04369"></a>04369                                     {
<a name="l04370"></a>04370                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:         iChance += -5; <span class="keywordflow">break</span>;
<a name="l04371"></a>04371                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:         iChance +=  5; <span class="keywordflow">break</span>;
<a name="l04372"></a>04372                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:          iChance +=  5; <span class="keywordflow">break</span>;
<a name="l04373"></a>04373                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>: iChance +=  0; <span class="keywordflow">break</span>;
<a name="l04374"></a>04374                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:  iChance +=  0; <span class="keywordflow">break</span>;
<a name="l04375"></a>04375                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:  iChance += 10; <span class="keywordflow">break</span>;
<a name="l04376"></a>04376                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>:iChance += 30; <span class="keywordflow">break</span>;
<a name="l04377"></a>04377                                     }
<a name="l04378"></a>04378 
<a name="l04379"></a>04379 
<a name="l04380"></a>04380                                     <span class="keywordflow">if</span> ( pSoldier-&gt;inv[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>].ubGunShotsLeft &gt; 50 )
<a name="l04381"></a>04381                                           iChance += 30;
<a name="l04382"></a>04382 
<a name="l04383"></a>04383                                     <span class="keywordflow">if</span> ( bInGas )
<a name="l04384"></a>04384                                           iChance += 50; <span class="comment">//Madd: extra chance of going nuts and autofiring if stuck in gas</span>
<a name="l04385"></a>04385 
<a name="l04386"></a>04386                                     <span class="comment">// increase chance based on proximity and difficulty of enemy</span>
<a name="l04387"></a>04387                                     <span class="keywordflow">if</span> ( <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( pSoldier-&gt;sGridNo, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a> ) &lt; 15 )
<a name="l04388"></a>04388                                     {
<a name="l04389"></a>04389                                           DebugMsg(<a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionBlack: check chance to autofire"</span>));
<a name="l04390"></a>04390                                           iChance += ( 15 - <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( pSoldier-&gt;sGridNo, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a> ) ) * ( 1 + <a class="code" href="ai_8h.html#eb68d5bd7803b8c6d4637cf543b9372c">SoldierDifficultyLevel</a>( pSoldier ) );
<a name="l04391"></a>04391                                           <span class="keywordflow">if</span> ( pSoldier-&gt;bAttitude == <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a> )
<a name="l04392"></a>04392                                           {
<a name="l04393"></a>04393                                                 <span class="comment">// increase it more!</span>
<a name="l04394"></a>04394                                                 iChance += 5 * ( 15 - <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( pSoldier-&gt;sGridNo, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a> ) );
<a name="l04395"></a>04395                                           }
<a name="l04396"></a>04396                                     }
<a name="l04397"></a>04397                               }
<a name="l04398"></a>04398 
<a name="l04399"></a>04399                               <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 100 ) &lt; iChance || <a class="code" href="Weapons_8cpp.html#fac72e30bc7c36f55257eac0542ce51d">Weapon</a>[pSoldier-&gt;inv[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>].usItem].NoSemiAuto)
<a name="l04400"></a>04400                               {
<a name="l04401"></a>04401                                     BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> = AUTOFIRING + pSoldier-&gt;bDoAutofire;
<a name="l04402"></a>04402                                     BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> = BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> - BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> + <a class="code" href="Points_8cpp.html#5c543e8467258f9559f37c5380130c05">CalcAPsToAutofire</a>( <a class="code" href="Soldier_01Control_8cpp.html#567738f5c11e8c81fa661e6aff177224">CalcActionPoints</a>( pSoldier ), &amp;(pSoldier-&gt;inv[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>]), pSoldier-&gt;bDoAutofire );
<a name="l04403"></a>04403                               }
<a name="l04404"></a>04404                         }
<a name="l04405"></a>04405                         
<a name="l04406"></a>04406                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a> = 0;
<a name="l04407"></a>04407                   }
<a name="l04408"></a>04408 <span class="comment"></span>
<a name="l04409"></a>04409 <span class="comment">                  //////////////////////////////////////////////////////////////////////////</span>
<a name="l04410"></a>04410 <span class="comment"></span>                  <span class="comment">// IF NOT CROUCHED &amp; WILL STILL HAVE ENOUGH APs TO DO THIS SAME BEST</span>
<a name="l04411"></a>04411                   <span class="comment">// ATTACK AFTER A STANCE CHANGE, CONSIDER CHANGING STANCE</span><span class="comment"></span>
<a name="l04412"></a>04412 <span class="comment">                  //////////////////////////////////////////////////////////////////////////</span>
<a name="l04413"></a>04413 <span class="comment"></span>
<a name="l04414"></a>04414 
<a name="l04415"></a>04415 
<a name="l04416"></a>04416                   <span class="keywordflow">if</span> (BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> == BURSTING)
<a name="l04417"></a>04417                   {
<a name="l04418"></a>04418                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f4d35b19eed93ae72b4bb54c4e6e8a3e">bAimTime</a>                  = 0;
<a name="l04419"></a>04419                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#dd307dffd553de4a1e01f74c050e6e07">bDoBurst</a>                  = 1;
<a name="l04420"></a>04420                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a>         = 0;
<a name="l04421"></a>04421                   }
<a name="l04422"></a>04422                   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> &gt;= AUTOFIRING)
<a name="l04423"></a>04423                   {
<a name="l04424"></a>04424                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f4d35b19eed93ae72b4bb54c4e6e8a3e">bAimTime</a>                  = 0;
<a name="l04425"></a>04425                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#dd307dffd553de4a1e01f74c050e6e07">bDoBurst</a>                  = 1;
<a name="l04426"></a>04426                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a>         = BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a>-AUTOFIRING;
<a name="l04427"></a>04427 
<a name="l04428"></a>04428                         BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> = AUTOFIRING;
<a name="l04429"></a>04429                   }
<a name="l04430"></a>04430             
<a name="l04431"></a>04431                   <span class="comment">/*</span>
<a name="l04432"></a>04432 <span class="comment">                  else // defaults already set</span>
<a name="l04433"></a>04433 <span class="comment">                  {</span>
<a name="l04434"></a>04434 <span class="comment">                        pSoldier-&gt;bAimTime                  = BestAttack.ubAimTime;</span>
<a name="l04435"></a>04435 <span class="comment">                        pSoldier-&gt;bDoBurst                  = 0;</span>
<a name="l04436"></a>04436 <span class="comment">                  }</span>
<a name="l04437"></a>04437 <span class="comment">                  */</span>
<a name="l04438"></a>04438 
<a name="l04439"></a>04439             }
<a name="l04440"></a>04440             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ubBestAttackAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b48a1dee24335dcbf15fd2d883fc6e243">AI_ACTION_THROW_KNIFE</a>)
<a name="l04441"></a>04441             {
<a name="l04442"></a>04442                   <span class="keywordflow">if</span> (BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> != <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a> &amp;&amp; <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight == ANIM_STAND )
<a name="l04443"></a>04443                   {
<a name="l04444"></a>04444                         <span class="comment">// we had better make sure we lower our gun first!</span>
<a name="l04445"></a>04445 
<a name="l04446"></a>04446                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b762f725b03742451680676278e51b862">AI_ACTION_LOWER_GUN</a>;
<a name="l04447"></a>04447                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = 0;
<a name="l04448"></a>04448 
<a name="l04449"></a>04449                         <span class="comment">// queue up attack for after we lower weapon if any</span>
<a name="l04450"></a>04450                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b48a1dee24335dcbf15fd2d883fc6e243">AI_ACTION_THROW_KNIFE</a>;
<a name="l04451"></a>04451                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>;
<a name="l04452"></a>04452                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#84a4b7065ddc3045b3844262f382d84f">bNextTargetLevel</a> = BestAttack.<a class="code" href="structATTACKTYPE.html#f32b20868939af7812b7d6329e128a0d">bTargetLevel</a>;
<a name="l04453"></a>04453                   }
<a name="l04454"></a>04454             
<a name="l04455"></a>04455             }
<a name="l04456"></a>04456       <span class="comment"></span>
<a name="l04457"></a>04457 <span class="comment">            //////////////////////////////////////////////////////////////////////////</span>
<a name="l04458"></a>04458 <span class="comment"></span>            <span class="comment">// OTHERWISE, JUST GO AHEAD &amp; ATTACK!</span><span class="comment"></span>
<a name="l04459"></a>04459 <span class="comment">            //////////////////////////////////////////////////////////////////////////</span>
<a name="l04460"></a>04460 <span class="comment"></span>   DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"OTHERWISE, JUST GO AHEAD &amp; ATTACK!"</span>);
<a name="l04461"></a>04461 
<a name="l04462"></a>04462 
<a name="l04463"></a>04463             <span class="comment">// swap weapon to hand if necessary</span>
<a name="l04464"></a>04464             <span class="keywordflow">if</span> (BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a> != <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>)
<a name="l04465"></a>04465             {
<a name="l04466"></a>04466                    DebugMsg (TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"decideactionblack: swap weapon into hand"</span>);
<a name="l04467"></a>04467                   <a class="code" href="AIInternals_8h.html#8d7f0222069571f630a99342fa534afe">RearrangePocket</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>,BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>,FOREVER);
<a name="l04468"></a>04468             }
<a name="l04469"></a>04469 
<a name="l04470"></a>04470             <span class="keywordflow">if</span> (fChangeStanceFirst)
<a name="l04471"></a>04471             { <span class="comment">// currently only for guns...</span>
<a name="l04472"></a>04472                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6247fbdbad71e877e20dc79b610060b8">AI_ACTION_FIRE_GUN</a>;
<a name="l04473"></a>04473                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>;
<a name="l04474"></a>04474                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#84a4b7065ddc3045b3844262f382d84f">bNextTargetLevel</a> = BestAttack.<a class="code" href="structATTACKTYPE.html#f32b20868939af7812b7d6329e128a0d">bTargetLevel</a>;
<a name="l04475"></a>04475                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = ubBestStance;
<a name="l04476"></a>04476                   <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a> );
<a name="l04477"></a>04477             }
<a name="l04478"></a>04478             <span class="keywordflow">else</span>
<a name="l04479"></a>04479             {
<a name="l04480"></a>04480 
<a name="l04481"></a>04481                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>;
<a name="l04482"></a>04482                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e29f2821a7f319ffe6405848dabb4c6b">bTargetLevel</a> = BestAttack.<a class="code" href="structATTACKTYPE.html#f32b20868939af7812b7d6329e128a0d">bTargetLevel</a>;
<a name="l04483"></a>04483 
<a name="l04484"></a>04484 <span class="preprocessor">                  #ifdef DEBUGDECISIONS</span>
<a name="l04485"></a>04485 <span class="preprocessor"></span>                              <a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a> tempstr=<span class="stringliteral">""</span>;
<a name="l04486"></a>04486                               sprintf((CHAR *) tempstr,
<a name="l04487"></a>04487                                <span class="stringliteral">"%d(%s) %s %d(%s) at gridno %d (%d APs aim)\n"</span>,
<a name="l04488"></a>04488                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,
<a name="l04489"></a>04489                                     (ubBestAttackAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b6247fbdbad71e877e20dc79b610060b8">AI_ACTION_FIRE_GUN</a>)?<span class="stringliteral">"SHOOTS"</span>:((ubBestAttackAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b260e54a79dd8e6db573a8216c3a63efc">AI_ACTION_TOSS_PROJECTILE</a>)?<span class="stringliteral">"TOSSES AT"</span>:<span class="stringliteral">"STABS"</span>),
<a name="l04490"></a>04490                                     BestAttack.<a class="code" href="structATTACKTYPE.html#4a3c834866b912b3fa371ac855e7be42">ubOpponent</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a> ,
<a name="l04491"></a>04491                                     BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>,BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> );
<a name="l04492"></a>04492                               <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( tempstr);
<a name="l04493"></a>04493 <span class="preprocessor">                  #endif</span>
<a name="l04494"></a>04494 <span class="preprocessor"></span>
<a name="l04495"></a>04495 
<a name="l04496"></a>04496                   DebugMsg(TOPIC_JA2, DBG_LEVEL_3, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionBlack: Check for GL Bursts, is launcher capable? = %d, rtpcombat? = %d, bestattackaction = %d"</span>,<a class="code" href="Weapons_8cpp.html#127b65951598cb6031a8a2862d654bf9">IsGunBurstCapable</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>, FALSE ),<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#632ca06a3de72d8deb1d7d1777955e4a">bRTPCombat</a>,ubBestAttackAction ));
<a name="l04497"></a>04497                   <span class="keywordflow">if</span> (ubBestAttackAction == <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b260e54a79dd8e6db573a8216c3a63efc">AI_ACTION_TOSS_PROJECTILE</a> &amp;&amp; (<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>].usItem].usItemClass == IC_LAUNCHER &amp;&amp; <a class="code" href="Weapons_8cpp.html#127b65951598cb6031a8a2862d654bf9">IsGunBurstCapable</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>, FALSE )) &amp;&amp;
<a name="l04498"></a>04498                         (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#632ca06a3de72d8deb1d7d1777955e4a">bRTPCombat</a> == RTP_COMBAT_AGGRESSIVE) )
<a name="l04499"></a>04499                   {
<a name="l04500"></a>04500 
<a name="l04501"></a>04501                         DebugMsg(TOPIC_JA2, DBG_LEVEL_3, <span class="stringliteral">"DecideActionBlack: Doing burst calc"</span>);
<a name="l04502"></a>04502                         ubBurstAPs = <a class="code" href="Points_8cpp.html#e185748f40819bf798a0a3247a08e4d0">CalcAPsToBurst</a>( <a class="code" href="Soldier_01Control_8cpp.html#567738f5c11e8c81fa661e6aff177224">CalcActionPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ), &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[BestAttack.<a class="code" href="structATTACKTYPE.html#ce0c0ecf00fd91201faa76d57f877ef0">bWeaponIn</a>]) );
<a name="l04503"></a>04503 
<a name="l04504"></a>04504                         <span class="keywordflow">if</span> ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> - BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a>) &gt;= ubBurstAPs )
<a name="l04505"></a>04505                         {
<a name="l04506"></a>04506                               <span class="comment">// Base chance of bursting is 25% if best shot was +0 aim, down to 8% at +4</span>
<a name="l04507"></a>04507                               <span class="keywordflow">if</span> ( TANK( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l04508"></a>04508                               {
<a name="l04509"></a>04509                                     iChance = 100;
<a name="l04510"></a>04510                               }
<a name="l04511"></a>04511                               <span class="keywordflow">else</span>
<a name="l04512"></a>04512                               {
<a name="l04513"></a>04513                                     iChance = 50;
<a name="l04514"></a>04514                                     <span class="keywordflow">switch</span> (pSoldier-&gt;bAttitude)
<a name="l04515"></a>04515                                     {
<a name="l04516"></a>04516                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:         iChance += -5; <span class="keywordflow">break</span>;
<a name="l04517"></a>04517                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:         iChance +=  5; <span class="keywordflow">break</span>;
<a name="l04518"></a>04518                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:          iChance +=  5; <span class="keywordflow">break</span>;
<a name="l04519"></a>04519                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>: iChance +=  0; <span class="keywordflow">break</span>;
<a name="l04520"></a>04520                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:  iChance +=  0; <span class="keywordflow">break</span>;
<a name="l04521"></a>04521                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:  iChance += 10; <span class="keywordflow">break</span>;
<a name="l04522"></a>04522                                           <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>:iChance += 30; <span class="keywordflow">break</span>;
<a name="l04523"></a>04523                                     }
<a name="l04524"></a>04524                                     <span class="comment">// increase chance based on proximity and difficulty of enemy</span>
<a name="l04525"></a>04525                                     DebugMsg(<a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionBlack: check chance to gl burst"</span>));
<a name="l04526"></a>04526                                     iChance += ( 15 - <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( pSoldier-&gt;sGridNo, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a> ) ) * ( 1 + <a class="code" href="ai_8h.html#eb68d5bd7803b8c6d4637cf543b9372c">SoldierDifficultyLevel</a>( pSoldier ) );
<a name="l04527"></a>04527                               }
<a name="l04528"></a>04528 
<a name="l04529"></a>04529                               <span class="keywordflow">if</span> ( (<a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 100 ) &lt; iChance)
<a name="l04530"></a>04530                               {
<a name="l04531"></a>04531                                     DebugMsg(TOPIC_JA2, DBG_LEVEL_3, <span class="stringliteral">"DecideActionBlack: Doing GL burst"</span>);
<a name="l04532"></a>04532                                     BestAttack.<a class="code" href="structATTACKTYPE.html#3e604968dd1d2f8c19e76ca3a630b6c7">ubAimTime</a> = BURSTING;
<a name="l04533"></a>04533                                     BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> = BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> + <a class="code" href="Points_8cpp.html#e185748f40819bf798a0a3247a08e4d0">CalcAPsToBurst</a>( <a class="code" href="Soldier_01Control_8cpp.html#567738f5c11e8c81fa661e6aff177224">CalcActionPoints</a>( pSoldier ), &amp;(pSoldier-&gt;inv[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>]) );
<a name="l04534"></a>04534                                     <span class="comment">// check for spread burst possibilities</span>
<a name="l04535"></a>04535                                     <span class="keywordflow">if</span> (pSoldier-&gt;bAttitude != <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>)
<a name="l04536"></a>04536                                     {
<a name="l04537"></a>04537                                           <a class="code" href="AIInternals_8h.html#be1adbccdd358afca93b507465956d39">CalcSpreadBurst</a>( pSoldier, BestAttack.<a class="code" href="structATTACKTYPE.html#1fc63ce04937dc0f174f724d332c932e">sTarget</a>, BestAttack.<a class="code" href="structATTACKTYPE.html#f32b20868939af7812b7d6329e128a0d">bTargetLevel</a> );
<a name="l04538"></a>04538                                     }
<a name="l04539"></a>04539                                     pSoldier-&gt;bDoBurst = 1;
<a name="l04540"></a>04540 
<a name="l04541"></a>04541                               }
<a name="l04542"></a>04542                         }
<a name="l04543"></a>04543                   }
<a name="l04544"></a>04544 
<a name="l04545"></a>04545 
<a name="l04546"></a>04546                   <span class="keywordflow">return</span>(ubBestAttackAction);
<a name="l04547"></a>04547             }
<a name="l04548"></a>04548       
<a name="l04549"></a>04549       }
<a name="l04550"></a>04550 
<a name="l04551"></a>04551       <span class="comment">// end of tank AI</span>
<a name="l04552"></a>04552       <span class="keywordflow">if</span> ( TANK( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) )
<a name="l04553"></a>04553       {
<a name="l04554"></a>04554             <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l04555"></a>04555       }
<a name="l04556"></a>04556 
<a name="l04557"></a>04557       <span class="comment">// try to make boxer close if possible</span>
<a name="l04558"></a>04558       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_BOXER )
<a name="l04559"></a>04559       {
<a name="l04560"></a>04560             <span class="keywordflow">if</span> ( ubCanMove )
<a name="l04561"></a>04561             {
<a name="l04562"></a>04562                   sClosestOpponent = <a class="code" href="AIInternals_8h.html#f3636451b502427ea0d226b7ee865776">ClosestSeenOpponent</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, NULL, NULL);                       
<a name="l04563"></a>04563                   <span class="keywordflow">if</span> ( sClosestOpponent != NOWHERE )
<a name="l04564"></a>04564                   {
<a name="l04565"></a>04565                         <span class="comment">// temporarily make boxer have orders of CLOSEPATROL rather than STATIONARY</span>
<a name="l04566"></a>04566                         <span class="comment">// so he has a good roaming range</span>
<a name="l04567"></a>04567                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> = <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>;
<a name="l04568"></a>04568                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#8058d9871f438da8f6f5ed91da85e559">GoAsFarAsPossibleTowards</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sClosestOpponent, <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bedcd6be18202cbd0df633b0017f571f1">AI_ACTION_GET_CLOSER</a> );
<a name="l04569"></a>04569                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> = <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>;
<a name="l04570"></a>04570                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE )
<a name="l04571"></a>04571                         {
<a name="l04572"></a>04572                               <span class="comment">// truncate path to 1 step</span>
<a name="l04573"></a>04573                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> + <a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6a09658531f653174e06d5fdea8338fa">usPathingData</a>[0] );
<a name="l04574"></a>04574                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13569e868936f0aabb70ab73640be218">sFinalDestination</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>;
<a name="l04575"></a>04575                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>;
<a name="l04576"></a>04576                               <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bedcd6be18202cbd0df633b0017f571f1">AI_ACTION_GET_CLOSER</a> );
<a name="l04577"></a>04577                         }
<a name="l04578"></a>04578                   }
<a name="l04579"></a>04579             }
<a name="l04580"></a>04580             <span class="comment">// otherwise do nothing</span>
<a name="l04581"></a>04581             <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a> );
<a name="l04582"></a>04582       }
<a name="l04583"></a>04583       <span class="comment"></span>
<a name="l04584"></a>04584 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04585"></a>04585 <span class="comment"></span> <span class="comment">// IF A LOCATION WITH BETTER COVER IS AVAILABLE &amp; REACHABLE, GO FOR IT!</span><span class="comment"></span>
<a name="l04586"></a>04586 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04587"></a>04587 <span class="comment"></span>
<a name="l04588"></a>04588  <span class="keywordflow">if</span> (sBestCover != NOWHERE)
<a name="l04589"></a>04589   {
<a name="l04590"></a>04590 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l04591"></a>04591 <span class="preprocessor"></span>            <a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a> tempstr=<span class="stringliteral">""</span>;
<a name="l04592"></a>04592             sprintf ((CHAR *) tempstr,<span class="stringliteral">"%s - TAKING COVER at gridno %d (%d%% better)\n"</span>,
<a name="l04593"></a>04593             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,sBestCover,iCoverPercentBetter);
<a name="l04594"></a>04594             <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>( tempstr ) ;
<a name="l04595"></a>04595 <span class="preprocessor">#endif</span>
<a name="l04596"></a>04596 <span class="preprocessor"></span>      <span class="comment">//ScreenMsg( FONT_MCOLOR_LTYELLOW, MSG_TESTVERSION, L"AI %d taking cover, morale %d, from %d to %d", pSoldier-&gt;ubID, pSoldier-&gt;bAIMorale, pSoldier-&gt;sGridNo, sBestCover );</span>
<a name="l04597"></a>04597    <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = sBestCover;
<a name="l04598"></a>04598 
<a name="l04599"></a>04599    <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bd2358f4f3b1cd379c943855df803496d">AI_ACTION_TAKE_COVER</a>);
<a name="l04600"></a>04600       }
<a name="l04601"></a>04601 
<a name="l04602"></a>04602 <span class="comment"></span>
<a name="l04603"></a>04603 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04604"></a>04604 <span class="comment"></span> <span class="comment">// IF THINGS ARE REALLY HOPELESS, OR UNARMED, TRY TO RUN AWAY</span><span class="comment"></span>
<a name="l04605"></a>04605 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04606"></a>04606 <span class="comment"></span>
<a name="l04607"></a>04607  <span class="comment">// if soldier has enough APs left to move at least 1 square's worth</span>
<a name="l04608"></a>04608  <span class="keywordflow">if</span> ( ubCanMove &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp; AI_RTP_OPTION_CAN_RETREAT) )
<a name="l04609"></a>04609  {
<a name="l04610"></a>04610    <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> == <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e360129a915d611934bca8624d0ea8e21e">MORALE_HOPELESS</a>) || !bCanAttack)
<a name="l04611"></a>04611    {
<a name="l04612"></a>04612      <span class="comment">// look for best place to RUN AWAY to (farthest from the closest threat)</span>
<a name="l04613"></a>04613              <span class="comment">//pSoldier-&gt;usActionData = RunAway( pSoldier );</span>
<a name="l04614"></a>04614      <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="ai_8h.html#eb3ffb28e50d84917771661b9d91aa51">FindSpotMaxDistFromOpponents</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l04615"></a>04615 
<a name="l04616"></a>04616      <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE)
<a name="l04617"></a>04617      {
<a name="l04618"></a>04618 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l04619"></a>04619 <span class="preprocessor"></span>       sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - RUNNING AWAY to grid %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l04620"></a>04620        <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l04621"></a>04621 <span class="preprocessor">#endif</span>
<a name="l04622"></a>04622 <span class="preprocessor"></span>
<a name="l04623"></a>04623        <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950be1338b9c498abc9dd4b86d1b22291b12">AI_ACTION_RUN_AWAY</a>);
<a name="l04624"></a>04624      }
<a name="l04625"></a>04625    }
<a name="l04626"></a>04626  }
<a name="l04627"></a>04627 <span class="comment"></span>
<a name="l04628"></a>04628 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04629"></a>04629 <span class="comment"></span> <span class="comment">// IF SPOTTERS HAVE BEEN CALLED FOR, AND WE HAVE SOME NEW SIGHTINGS, RADIO!</span><span class="comment"></span>
<a name="l04630"></a>04630 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04631"></a>04631 <span class="comment"></span>
<a name="l04632"></a>04632  <span class="comment">// if we're a computer merc, and we have the action points remaining to RADIO</span>
<a name="l04633"></a>04633  <span class="comment">// (we never want NPCs to choose to radio if they would have to wait a turn)</span>
<a name="l04634"></a>04634  <span class="comment">// and we're not swimming in deep water, and somebody has called for spotters</span>
<a name="l04635"></a>04635  <span class="comment">// and we see the location of at least 2 opponents</span>
<a name="l04636"></a>04636  <span class="keywordflow">if</span> ((<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#0d06ef8dafb831a45e5caa0c61c6d76b">ubSpottersCalledForBy</a> != NOBODY) &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt;= AP_RADIO) &amp;&amp;
<a name="l04637"></a>04637      (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#794f2b53a1e037c0f011fe3aa2cebec8">bOppCnt</a> &gt; 1) &amp;&amp; !fCivilian &amp;&amp;
<a name="l04638"></a>04638      (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bMenInSector &gt; 1) &amp;&amp; !bInDeepWater)
<a name="l04639"></a>04639  {
<a name="l04640"></a>04640    <span class="comment">// base chance depends on how much new info we have to radio to the others</span>
<a name="l04641"></a>04641    iChance = 25 * <a class="code" href="ai_8h.html#b72f0daba2e93b7c9d9c2ba87426da07">WhatIKnowThatPublicDont</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,TRUE);   <span class="comment">// just count them</span>
<a name="l04642"></a>04642 
<a name="l04643"></a>04643    <span class="comment">// if I actually know something they don't</span>
<a name="l04644"></a>04644    <span class="keywordflow">if</span> (iChance)
<a name="l04645"></a>04645    {
<a name="l04646"></a>04646 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l04647"></a>04647 <span class="preprocessor"></span>     <a class="code" href="AIUtils_8cpp.html#88d13d659f1890049d17af096cc37432">AINumMessage</a>(<span class="stringliteral">"Chance to radio for SPOTTING = "</span>,iChance);
<a name="l04648"></a>04648 <span class="preprocessor">#endif</span>
<a name="l04649"></a>04649 <span class="preprocessor"></span>
<a name="l04650"></a>04650      <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)<a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance)
<a name="l04651"></a>04651      {
<a name="l04652"></a>04652 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l04653"></a>04653 <span class="preprocessor"></span>       <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"decides to radio a RED for SPOTTING!"</span>,1000);
<a name="l04654"></a>04654 <span class="preprocessor">#endif</span>
<a name="l04655"></a>04655 <span class="preprocessor"></span>
<a name="l04656"></a>04656        <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b32a0d931f53db4ddf96ac82a3b52484a">AI_ACTION_RED_ALERT</a>);
<a name="l04657"></a>04657      }
<a name="l04658"></a>04658    }
<a name="l04659"></a>04659  }
<a name="l04660"></a>04660 
<a name="l04661"></a>04661 <span class="comment"></span>
<a name="l04662"></a>04662 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04663"></a>04663 <span class="comment"></span> <span class="comment">// CROUCH IF NOT CROUCHING ALREADY</span><span class="comment"></span>
<a name="l04664"></a>04664 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04665"></a>04665 <span class="comment"></span>
<a name="l04666"></a>04666  <span class="comment">// if not in water and not already crouched, try to crouch down first</span>
<a name="l04667"></a>04667  <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#69f88541b84e4d9890e0b786199e9a3a">GetAPsToChangeStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_CROUCH ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l04668"></a>04668  {
<a name="l04669"></a>04669             <span class="keywordflow">if</span> ( !fCivilian &amp;&amp; !<a class="code" href="TeamTurns_8cpp.html#782955f80e251720a735649d4e8a5987">gfHiddenInterrupt</a> &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#419164836f72332cc058fa70ace03b47">IsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ANIM_CROUCH ) )
<a name="l04670"></a>04670             {
<a name="l04671"></a>04671                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = <a class="code" href="AIInternals_8h.html#442567fd1ee8d5cea3fb55c88bae8a21">StanceChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, BestAttack.<a class="code" href="structATTACKTYPE.html#3b67dab04a16b19f1444166d6735c220">ubAPCost</a> );
<a name="l04672"></a>04672                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != 0)
<a name="l04673"></a>04673                   {
<a name="l04674"></a>04674                         <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> == ANIM_PRONE)
<a name="l04675"></a>04675                         {
<a name="l04676"></a>04676                               <span class="comment">// we might want to turn before lying down!</span>
<a name="l04677"></a>04677                               <span class="keywordflow">if</span> ( (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#9f252be6995e21dcbda09f03c7cf5253">GetAPsToLook</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> - <a class="code" href="Points_8cpp.html#69f88541b84e4d9890e0b786199e9a3a">GetAPsToChangeStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> )) &amp;&amp;
<a name="l04678"></a>04678                                                 (((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> &gt; <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e360129a915d611934bca8624d0ea8e21e">MORALE_HOPELESS</a>) || ubCanMove) &amp;&amp; !<a class="code" href="AIInternals_8h.html#69a199d83bedd1ae4b00152576c0aa4a">AimingGun</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>)) )
<a name="l04679"></a>04679                               {
<a name="l04680"></a>04680                                     <span class="comment">// determine the location of the known closest opponent</span>
<a name="l04681"></a>04681                                     <span class="comment">// (don't care if he's conscious, don't care if he's reachable at all)</span>
<a name="l04682"></a>04682 
<a name="l04683"></a>04683                                     sClosestOpponent = <a class="code" href="AIInternals_8h.html#f3636451b502427ea0d226b7ee865776">ClosestSeenOpponent</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, NULL, NULL);                       
<a name="l04684"></a>04684                                     <span class="comment">// if we have a closest seen opponent</span>
<a name="l04685"></a>04685                                     <span class="keywordflow">if</span> (sClosestOpponent != NOWHERE)
<a name="l04686"></a>04686                                     {
<a name="l04687"></a>04687                                           bDirection = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>(<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(sClosestOpponent),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(sClosestOpponent));
<a name="l04688"></a>04688 
<a name="l04689"></a>04689                                           <span class="comment">// if we're not facing towards him</span>
<a name="l04690"></a>04690                                           <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> != bDirection)
<a name="l04691"></a>04691                                           {
<a name="l04692"></a>04692                                                 <span class="keywordflow">if</span> ( <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, bDirection, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) pSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>) )
<a name="l04693"></a>04693                                                 {
<a name="l04694"></a>04694                                                       <span class="comment">// change direction, THEN change stance!</span>
<a name="l04695"></a>04695                                                       pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a>;
<a name="l04696"></a>04696                                                       pSoldier-&gt;usNextActionData = pSoldier-&gt;usActionData;
<a name="l04697"></a>04697                                                       pSoldier-&gt;usActionData = bDirection;
<a name="l04698"></a>04698 <span class="preprocessor">                                                      #ifdef DEBUGDECISIONS</span>
<a name="l04699"></a>04699 <span class="preprocessor"></span>                                                            sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - TURNS to face CLOSEST OPPONENT in direction %d"</span>,pSoldier-&gt;name,pSoldier-&gt;usActionData);
<a name="l04700"></a>04700                                                             <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l04701"></a>04701 <span class="preprocessor">                                                      #endif</span>
<a name="l04702"></a>04702 <span class="preprocessor"></span>                                                      <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>);
<a name="l04703"></a>04703                                                 }
<a name="l04704"></a>04704                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (pSoldier-&gt;usActionData == ANIM_PRONE) &amp;&amp; (<a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( pSoldier, bDirection, ANIM_CROUCH) ) )
<a name="l04705"></a>04705                                                 {
<a name="l04706"></a>04706                                                       <span class="comment">// we shouldn't go prone, since we can't turn to shoot</span>
<a name="l04707"></a>04707                                                       pSoldier-&gt;usActionData = ANIM_CROUCH;
<a name="l04708"></a>04708                                                       pSoldier-&gt;bNextAction = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>;
<a name="l04709"></a>04709                                                       <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a> );
<a name="l04710"></a>04710                                                 }
<a name="l04711"></a>04711                                           }
<a name="l04712"></a>04712                                           <span class="comment">// else we are facing in the right direction</span>
<a name="l04713"></a>04713 
<a name="l04714"></a>04714                                     }
<a name="l04715"></a>04715                                     <span class="comment">// else we don't know any enemies</span>
<a name="l04716"></a>04716                               }
<a name="l04717"></a>04717 
<a name="l04718"></a>04718                               <span class="comment">// we don't want to turn</span>
<a name="l04719"></a>04719                         }
<a name="l04720"></a>04720                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b4eafc9f15e0576254083d073fd3ca6d4">AI_ACTION_END_TURN</a>;
<a name="l04721"></a>04721                         <span class="keywordflow">return</span>( <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b500e6725d683bb7b95de4ccb1b49e553">AI_ACTION_CHANGE_STANCE</a> );
<a name="l04722"></a>04722                   }
<a name="l04723"></a>04723             }
<a name="l04724"></a>04724       }
<a name="l04725"></a>04725 <span class="comment"></span>
<a name="l04726"></a>04726 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04727"></a>04727 <span class="comment"></span> <span class="comment">// TURN TO FACE CLOSEST KNOWN OPPONENT (IF NOT FACING THERE ALREADY)</span><span class="comment"></span>
<a name="l04728"></a>04728 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04729"></a>04729 <span class="comment"></span>
<a name="l04730"></a>04730       <span class="keywordflow">if</span> (!<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> || <a class="code" href="Points_8cpp.html#9f252be6995e21dcbda09f03c7cf5253">GetAPsToLook</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &lt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>)
<a name="l04731"></a>04731       {
<a name="l04732"></a>04732        <span class="comment">// hopeless guys shouldn't waste their time this way, UNLESS they CAN move</span>
<a name="l04733"></a>04733        <span class="comment">// but chose not to to get this far (which probably means they're cornered)</span>
<a name="l04734"></a>04734        <span class="comment">// ALSO, don't bother turning if we're already aiming a gun</span>
<a name="l04735"></a>04735        <span class="keywordflow">if</span> ( !<a class="code" href="TeamTurns_8cpp.html#782955f80e251720a735649d4e8a5987">gfHiddenInterrupt</a> &amp;&amp; ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a> &gt; <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e360129a915d611934bca8624d0ea8e21e">MORALE_HOPELESS</a>) || ubCanMove) &amp;&amp; !<a class="code" href="AIInternals_8h.html#69a199d83bedd1ae4b00152576c0aa4a">AimingGun</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>))
<a name="l04736"></a>04736        {
<a name="l04737"></a>04737              <span class="comment">// determine the location of the known closest opponent</span>
<a name="l04738"></a>04738              <span class="comment">// (don't care if he's conscious, don't care if he's reachable at all)</span>
<a name="l04739"></a>04739  
<a name="l04740"></a>04740              
<a name="l04741"></a>04741              sClosestOpponent = <a class="code" href="AIInternals_8h.html#f3636451b502427ea0d226b7ee865776">ClosestSeenOpponent</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, NULL, NULL);
<a name="l04742"></a>04742              <span class="comment">// if we have a closest reachable opponent</span>
<a name="l04743"></a>04743              <span class="keywordflow">if</span> (sClosestOpponent != NOWHERE)
<a name="l04744"></a>04744              {
<a name="l04745"></a>04745                    bDirection = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>(<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>),<a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>(sClosestOpponent),<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>(sClosestOpponent));
<a name="l04746"></a>04746 
<a name="l04747"></a>04747                    <span class="comment">// if we're not facing towards him</span>
<a name="l04748"></a>04748                    <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#8aa6174a253c3fa21a3ec41ce0174340">bDirection</a> != bDirection &amp;&amp; <a class="code" href="Soldier_01Control_8cpp.html#1b5209ae300c274f8e9fbe1ea76a7794">InternalIsValidStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, bDirection, <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubEndHeight ) )
<a name="l04749"></a>04749                    {
<a name="l04750"></a>04750                          <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = bDirection;
<a name="l04751"></a>04751 
<a name="l04752"></a>04752 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l04753"></a>04753 <span class="preprocessor"></span>                         sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - TURNS to face CLOSEST OPPONENT in direction %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l04754"></a>04754                          <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l04755"></a>04755 <span class="preprocessor">      #endif</span>
<a name="l04756"></a>04756 <span class="preprocessor"></span>
<a name="l04757"></a>04757                          <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>);
<a name="l04758"></a>04758                    }
<a name="l04759"></a>04759              }
<a name="l04760"></a>04760        }
<a name="l04761"></a>04761       }
<a name="l04762"></a>04762 
<a name="l04763"></a>04763  <span class="comment">// if a militia has absofreaking nothing else to do, maybe they should radio in a report!</span>
<a name="l04764"></a>04764 <span class="comment"></span>
<a name="l04765"></a>04765 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04766"></a>04766 <span class="comment"></span> <span class="comment">// RADIO RED ALERT: determine %chance to call others and report contact</span><span class="comment"></span>
<a name="l04767"></a>04767 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04768"></a>04768 <span class="comment"></span>
<a name="l04769"></a>04769  <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == MILITIA_TEAM &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a> &gt;= AP_RADIO) &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bMenInSector &gt; 1) )
<a name="l04770"></a>04770   {
<a name="l04771"></a>04771 
<a name="l04772"></a>04772    <span class="comment">// if there hasn't been an initial RED ALERT yet in this sector</span>
<a name="l04773"></a>04773    <span class="keywordflow">if</span> ( !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bAwareOfOpposition) || <a class="code" href="AIInternals_8h.html#e64d9ad938275226f748780f4d93d3f4">NeedToRadioAboutPanicTrigger</a>() )
<a name="l04774"></a>04774    {     <span class="comment">// since I'm at STATUS RED, I obviously know we're being invaded!</span>
<a name="l04775"></a>04775             DebugMsg(<a class="code" href="DEBUG_8cpp.html#e69a17b3d16566410d9b3cf08cb469a7">TOPIC_JA2AI</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionBlack: check chance to radio contact"</span>));
<a name="l04776"></a>04776             iChance = <a class="code" href="ai_8h.html#71440b56c1b498cae809e64152b7d65e">gbDiff</a>[DIFF_RADIO_RED_ALERT][ <a class="code" href="ai_8h.html#eb68d5bd7803b8c6d4637cf543b9372c">SoldierDifficultyLevel</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) ];
<a name="l04777"></a>04777    }
<a name="l04778"></a>04778    <span class="keywordflow">else</span> <span class="comment">// subsequent radioing (only to update enemy positions, request help)</span>
<a name="l04779"></a>04779      <span class="comment">// base chance depends on how much new info we have to radio to the others</span>
<a name="l04780"></a>04780      iChance = 10 * <a class="code" href="ai_8h.html#b72f0daba2e93b7c9d9c2ba87426da07">WhatIKnowThatPublicDont</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,FALSE);  <span class="comment">// use 10 * for RED alert</span>
<a name="l04781"></a>04781 
<a name="l04782"></a>04782    <span class="comment">// if I actually know something they don't and I ain't swimming (deep water)</span>
<a name="l04783"></a>04783    <span class="keywordflow">if</span> (iChance &amp;&amp; !bInDeepWater)
<a name="l04784"></a>04784     {
<a name="l04785"></a>04785      <span class="comment">// modify base chance according to orders</span>
<a name="l04786"></a>04786      <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a>)
<a name="l04787"></a>04787       {
<a name="l04788"></a>04788        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fc84bd0ee013c388bd7cc8139be7206a2">STATIONARY</a>:       iChance +=  20;  <span class="keywordflow">break</span>;
<a name="l04789"></a>04789        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fdb56c8891ff3ae7edaab609e648d959e">ONGUARD</a>:          iChance +=  15;  <span class="keywordflow">break</span>;
<a name="l04790"></a>04790        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffbc5202d0fef4bcd4a4625750d02a724">ONCALL</a>:           iChance +=  10;  <span class="keywordflow">break</span>;
<a name="l04791"></a>04791        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138ffe820c85dbe7ec3fed2fb2f40995bb5e">CLOSEPATROL</a>:                       <span class="keywordflow">break</span>;
<a name="l04792"></a>04792                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f4f7b012e8cbd1e2cc2b3fa9e1b5c9f9f">RNDPTPATROL</a>:
<a name="l04793"></a>04793        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f7dc5dd2cff7953315a832e7a457deb9d">POINTPATROL</a>:      iChance +=  -5;  <span class="keywordflow">break</span>;
<a name="l04794"></a>04794        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138fddbbeee5695e4be7e9f148315873ce2b">FARPATROL</a>:        iChance += -10;  <span class="keywordflow">break</span>;
<a name="l04795"></a>04795        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f5aa440b40aa8e6f41bfba3b0b8b4ed95">SEEKENEMY</a>:        iChance += -20;  <span class="keywordflow">break</span>;
<a name="l04796"></a>04796        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a>:                   iChance += -10;  <span class="keywordflow">break</span>;
<a name="l04797"></a>04797       }
<a name="l04798"></a>04798 
<a name="l04799"></a>04799      <span class="comment">// modify base chance according to attitude</span>
<a name="l04800"></a>04800      <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c805687690b8b5573780d07fc3931a36">bAttitude</a>)
<a name="l04801"></a>04801       {
<a name="l04802"></a>04802        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d33e48d9347e4b619a68607635dd6b57d8">DEFENSIVE</a>:        iChance +=  20;  <span class="keywordflow">break</span>;
<a name="l04803"></a>04803        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3e73edc4a643e93da3af5ae7298b3c8b0">BRAVESOLO</a>:        iChance += -10;  <span class="keywordflow">break</span>;
<a name="l04804"></a>04804        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d329be195ca24f675cf0e02feadccc6838">BRAVEAID</a>:                          <span class="keywordflow">break</span>;
<a name="l04805"></a>04805        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d39e8bc85ff63f77296958281799ac08f8">CUNNINGSOLO</a>:      iChance +=  -5;  <span class="keywordflow">break</span>;
<a name="l04806"></a>04806        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3ade291a409d5f329d6b60fea75b4c3ef">CUNNINGAID</a>:                        <span class="keywordflow">break</span>;
<a name="l04807"></a>04807        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3128db069f37b5cd1b44901dff4db4ae0">AGGRESSIVE</a>:       iChance += -20;  <span class="keywordflow">break</span>;
<a name="l04808"></a>04808                    <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#731c15105066cc17fd55a258db2879d3bd625481744f226dd53dc02c1d8593ec">ATTACKSLAYONLY</a>:         iChance = 0;
<a name="l04809"></a>04809       }
<a name="l04810"></a>04810 
<a name="l04811"></a>04811                   <span class="keywordflow">if</span> (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bAwareOfOpposition)
<a name="l04812"></a>04812                   {
<a name="l04813"></a>04813                         <span class="comment">// ignore morale (which could be really high)</span>
<a name="l04814"></a>04814                   }
<a name="l04815"></a>04815                   <span class="keywordflow">else</span>
<a name="l04816"></a>04816                   {
<a name="l04817"></a>04817                    <span class="comment">// modify base chance according to morale</span>
<a name="l04818"></a>04818                    <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb4b32c781e304a9fa71ba95b75a49e6">bAIMorale</a>)
<a name="l04819"></a>04819                         {
<a name="l04820"></a>04820                          <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e360129a915d611934bca8624d0ea8e21e">MORALE_HOPELESS</a>:  iChance *= 3;    <span class="keywordflow">break</span>;
<a name="l04821"></a>04821                          <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e3babad6ffb594c707f4cf71479ecac899">MORALE_WORRIED</a>:   iChance *= 2;    <span class="keywordflow">break</span>;
<a name="l04822"></a>04822                          <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e3ace720f60b0c5dd9ffeb0df82fa6b4e0">MORALE_NORMAL</a>:                     <span class="keywordflow">break</span>;
<a name="l04823"></a>04823                          <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e397b51ec5a452f3c4ebcddfd426c0485c">MORALE_CONFIDENT</a>: iChance /= 2;    <span class="keywordflow">break</span>;
<a name="l04824"></a>04824                          <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#5bc6c193b77b15ca30bb8821799616e34e0b5e2e2be99f4e43c1321cf58b19ad">MORALE_FEARLESS</a>:  iChance /= 3;    <span class="keywordflow">break</span>;
<a name="l04825"></a>04825                         }
<a name="l04826"></a>04826                   }
<a name="l04827"></a>04827 
<a name="l04828"></a>04828              <span class="comment">// reduce chance because we're in combat</span>
<a name="l04829"></a>04829              iChance /= 2;
<a name="l04830"></a>04830 
<a name="l04831"></a>04831 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l04832"></a>04832 <span class="preprocessor"></span>     <a class="code" href="AIUtils_8cpp.html#88d13d659f1890049d17af096cc37432">AINumMessage</a>(<span class="stringliteral">"Chance to radio RED alert = "</span>,iChance);
<a name="l04833"></a>04833 <span class="preprocessor">#endif</span>
<a name="l04834"></a>04834 <span class="preprocessor"></span>
<a name="l04835"></a>04835      <span class="keywordflow">if</span> ((<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>(100) &lt; iChance)
<a name="l04836"></a>04836       {
<a name="l04837"></a>04837 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l04838"></a>04838 <span class="preprocessor"></span>       <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"decides to radio a RED alert!"</span>,1000);
<a name="l04839"></a>04839 <span class="preprocessor">#endif</span>
<a name="l04840"></a>04840 <span class="preprocessor"></span>
<a name="l04841"></a>04841        <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b32a0d931f53db4ddf96ac82a3b52484a">AI_ACTION_RED_ALERT</a>);
<a name="l04842"></a>04842       }
<a name="l04843"></a>04843     }
<a name="l04844"></a>04844   }
<a name="l04845"></a>04845 <span class="comment"></span>
<a name="l04846"></a>04846 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04847"></a>04847 <span class="comment"></span> <span class="comment">// LEAVE THE SECTOR</span><span class="comment"></span>
<a name="l04848"></a>04848 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04849"></a>04849 <span class="comment"></span>
<a name="l04850"></a>04850  <span class="comment">// NOT IMPLEMENTED</span>
<a name="l04851"></a>04851 <span class="comment"></span>
<a name="l04852"></a>04852 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04853"></a>04853 <span class="comment"></span> <span class="comment">// DO NOTHING: Not enough points left to move, so save them for next turn</span><span class="comment"></span>
<a name="l04854"></a>04854 <span class="comment"> ////////////////////////////////////////////////////////////////////////////</span>
<a name="l04855"></a>04855 <span class="comment"></span>
<a name="l04856"></a>04856 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l04857"></a>04857 <span class="preprocessor"></span> <a class="code" href="AIUtils_8cpp.html#d229c25b0f18ae3804ffbc59940b651a">AINameMessage</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<span class="stringliteral">"- DOES NOTHING (BLACK)"</span>,1000);
<a name="l04858"></a>04858 <span class="preprocessor">#endif</span>
<a name="l04859"></a>04859 <span class="preprocessor"></span>
<a name="l04860"></a>04860  <span class="comment">// by default, if everything else fails, just stand in place and wait</span>
<a name="l04861"></a>04861  <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = NOWHERE;
<a name="l04862"></a>04862  <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l04863"></a>04863 
<a name="l04864"></a>04864 }
<a name="l04865"></a>04865 
<a name="l04866"></a><a class="code" href="DecideAction_8cpp.html#ae225f94edccc85265839e43ebeba7cb">04866</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="ai_8h.html#ae225f94edccc85265839e43ebeba7cb">DecideAction</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pSoldier)
<a name="l04867"></a>04867 {
<a name="l04868"></a>04868       DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"DecideAction"</span>);
<a name="l04869"></a>04869       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bAction=<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>;
<a name="l04870"></a>04870 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l04871"></a>04871 <span class="preprocessor"></span>            <a class="code" href="Types_8h.html#94ebfccc6e846c28751f8d616371f1e5">STR16</a> tempstr;
<a name="l04872"></a>04872 <span class="preprocessor">      #endif</span>
<a name="l04873"></a>04873 <span class="preprocessor"></span>
<a name="l04874"></a>04874 <span class="preprocessor">#ifdef AI_TIMING_TESTS</span>
<a name="l04875"></a>04875 <span class="preprocessor"></span> <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>           uiStartTime, uiEndTime;
<a name="l04876"></a>04876 <span class="preprocessor">#endif</span>
<a name="l04877"></a>04877 <span class="preprocessor"></span>
<a name="l04878"></a>04878       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != MILITIA_TEAM )
<a name="l04879"></a>04879       {
<a name="l04880"></a>04880             <span class="keywordflow">if</span> ( !<a class="code" href="Overhead_8cpp.html#ecf21a64b809ef021f32208e8786435a">sniperwarning</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#76cf3cb25fe41d314c711377ee8dbfad">bOrders</a> == <a class="code" href="Overhead_01Types_8h.html#5e7fba63eebd783231b18f414e8a138f3ccb90f0745801f31a0175bebe2261ae">SNIPER</a> )
<a name="l04881"></a>04881             {
<a name="l04882"></a>04882                   <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, L<span class="stringliteral">"Watch out for snipers..."</span> );
<a name="l04883"></a>04883                   <a class="code" href="Overhead_8cpp.html#ecf21a64b809ef021f32208e8786435a">sniperwarning</a> = TRUE;
<a name="l04884"></a>04884             }
<a name="l04885"></a>04885 
<a name="l04886"></a>04886             <span class="keywordflow">if</span> (!<a class="code" href="Overhead_8cpp.html#5c73af15be56120fd3de294379190ad5">biggunwarning</a> &amp;&amp; <a class="code" href="Items_8cpp.html#188b7d3543eb2a46a3af058455606e98">FindRocketLauncherOrCannon</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>) != NO_SLOT )
<a name="l04887"></a>04887             {
<a name="l04888"></a>04888                   <a class="code" href="Overhead_8cpp.html#5c73af15be56120fd3de294379190ad5">biggunwarning</a> = TRUE;
<a name="l04889"></a>04889                   <span class="comment">//TODO: don't say this again after reloading a savegame</span>
<a name="l04890"></a>04890                   <a class="code" href="Dialogue_01Control_8cpp.html#76d4599b1c97926d59f2994a97331811">SayQuoteFromAnyBodyInSector</a>( <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a29cdea124c137a0f963fb70deb351a628e">QUOTE_WEARY_SLASH_SUSPUCIOUS</a> );
<a name="l04891"></a>04891             }
<a name="l04892"></a>04892       }
<a name="l04893"></a>04893  <span class="comment">// turn off cautious flag</span>
<a name="l04894"></a>04894       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7d5fffce6e4f940d39e7512c1d378fe3">fAIFlags</a> &amp;= (~AI_CAUTIOUS);
<a name="l04895"></a>04895       <span class="comment">//reset flank count</span>
<a name="l04896"></a>04896 
<a name="l04897"></a>04897  <span class="comment">//NumMessage("DecideAction - Guy#",pSoldier-&gt;ubID);</span>
<a name="l04898"></a>04898 
<a name="l04899"></a>04899  <span class="comment">// if the NPC is being "ESCORTED" (seen civilians only for now)</span>
<a name="l04900"></a>04900  <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#bf9485d30ef04e8b908b3614e050c7d0">bUnderEscort</a>)
<a name="l04901"></a>04901   {
<a name="l04902"></a>04902 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l04903"></a>04903 <span class="preprocessor"></span>   <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(<span class="stringliteral">"AlertStatus = ESCORT"</span>);
<a name="l04904"></a>04904 <span class="preprocessor">#endif</span>
<a name="l04905"></a>04905 <span class="preprocessor"></span>
<a name="l04906"></a>04906    <span class="comment">//bAction = DecideActionEscort(pSoldier);</span>
<a name="l04907"></a>04907   }
<a name="l04908"></a>04908  <span class="keywordflow">else</span> <span class="comment">// "normal" NPC AI</span>
<a name="l04909"></a>04909   {
<a name="l04910"></a>04910    <span class="comment">// if status over-ride is set, bypass RED/YELLOW and go directly to GREEN!</span>
<a name="l04911"></a>04911    <span class="keywordflow">if</span> ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f72e7e4bdc35542eca5402ce5329de32">bBypassToGreen</a>) &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> &lt; <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532cb7890b45734e38021cf4022c1f24e2">STATUS_BLACK</a>))
<a name="l04912"></a>04912        {
<a name="l04913"></a>04913      bAction = <a class="code" href="ai_8h.html#ace6b78fb0a875c61b79ba65193f0d04">DecideActionGreen</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l04914"></a>04914              <span class="keywordflow">if</span> ( !<a class="code" href="AIInternals_8h.html#25c5537230a9ec6af357c7e3ddadb97b">gfTurnBasedAI</a> )
<a name="l04915"></a>04915              {
<a name="l04916"></a>04916                   <span class="comment">// reset bypass now</span>
<a name="l04917"></a>04917                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f72e7e4bdc35542eca5402ce5329de32">bBypassToGreen</a> = 0;
<a name="l04918"></a>04918              }
<a name="l04919"></a>04919        }
<a name="l04920"></a>04920    <span class="keywordflow">else</span>
<a name="l04921"></a>04921     {
<a name="l04922"></a>04922      <span class="keywordflow">switch</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a>)
<a name="l04923"></a>04923       {
<a name="l04924"></a>04924        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532f91de342fc2584dd731cfe5d47271c6">STATUS_GREEN</a>:
<a name="l04925"></a>04925 <span class="preprocessor">                              #ifdef DEBUGDECISIONS</span>
<a name="l04926"></a>04926 <span class="preprocessor"></span>                                    <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(<span class="stringliteral">"AlertStatus = GREEN"</span>);
<a name="l04927"></a>04927 <span class="preprocessor">                              #endif</span>
<a name="l04928"></a>04928 <span class="preprocessor"></span><span class="preprocessor">                              #ifdef AI_TIMING_TESTS</span>
<a name="l04929"></a>04929 <span class="preprocessor"></span>                                    uiStartTime = GetJA2Clock();
<a name="l04930"></a>04930 <span class="preprocessor">                              #endif</span>
<a name="l04931"></a>04931 <span class="preprocessor"></span>                              bAction = <a class="code" href="ai_8h.html#ace6b78fb0a875c61b79ba65193f0d04">DecideActionGreen</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l04932"></a>04932 <span class="preprocessor">                              #ifdef AI_TIMING_TESTS</span>
<a name="l04933"></a>04933 <span class="preprocessor"></span>                                    uiEndTime = GetJA2Clock();
<a name="l04934"></a>04934                                     <a class="code" href="Items_8cpp.html#560f288a33343e5714f7190dd73532f5">guiGreenTimeTotal</a> += (uiEndTime - uiStartTime);
<a name="l04935"></a>04935                                     <a class="code" href="Items_8cpp.html#6274f991f4dd82f3a1852fe99ec3c2ad">guiGreenCounter</a>++;
<a name="l04936"></a>04936 <span class="preprocessor">                              #endif</span>
<a name="l04937"></a>04937 <span class="preprocessor"></span>                              <span class="keywordflow">break</span>;
<a name="l04938"></a>04938 
<a name="l04939"></a>04939        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726530ecf4468b8fd828fc47998fef0f857fd">STATUS_YELLOW</a>:
<a name="l04940"></a>04940 <span class="preprocessor">                        #ifdef DEBUGDECISIONS</span>
<a name="l04941"></a>04941 <span class="preprocessor"></span>                              <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(<span class="stringliteral">"AlertStatus = YELLOW"</span>);
<a name="l04942"></a>04942 <span class="preprocessor">                        #endif</span>
<a name="l04943"></a>04943 <span class="preprocessor"></span><span class="preprocessor">                              #ifdef AI_TIMING_TESTS</span>
<a name="l04944"></a>04944 <span class="preprocessor"></span>                                    uiStartTime = GetJA2Clock();
<a name="l04945"></a>04945 <span class="preprocessor">                              #endif</span>
<a name="l04946"></a>04946 <span class="preprocessor"></span>                              bAction = <a class="code" href="ai_8h.html#7fea9db0a1bd960433cc4801e0881ab0">DecideActionYellow</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l04947"></a>04947 <span class="preprocessor">                              #ifdef AI_TIMING_TESTS</span>
<a name="l04948"></a>04948 <span class="preprocessor"></span>                                    uiEndTime = GetJA2Clock();
<a name="l04949"></a>04949                                     <a class="code" href="Items_8cpp.html#fd1fe6002b1a67e42007e9d57edfe1c3">guiYellowTimeTotal</a> += (uiEndTime - uiStartTime);
<a name="l04950"></a>04950                                     <a class="code" href="Items_8cpp.html#714829a7f2d911a0994dcf951fca197f">guiYellowCounter</a>++;
<a name="l04951"></a>04951 <span class="preprocessor">                              #endif</span>
<a name="l04952"></a>04952 <span class="preprocessor"></span>                              <span class="keywordflow">break</span>;
<a name="l04953"></a>04953 
<a name="l04954"></a>04954        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>:
<a name="l04955"></a>04955 <span class="preprocessor">                        #ifdef DEBUGDECISIONS</span>
<a name="l04956"></a>04956 <span class="preprocessor"></span>                              <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(<span class="stringliteral">"AlertStatus = RED"</span>);
<a name="l04957"></a>04957 <span class="preprocessor">                        #endif</span>
<a name="l04958"></a>04958 <span class="preprocessor"></span><span class="preprocessor">                              #ifdef AI_TIMING_TESTS</span>
<a name="l04959"></a>04959 <span class="preprocessor"></span>                                    uiStartTime = GetJA2Clock();
<a name="l04960"></a>04960 <span class="preprocessor">                              #endif</span>
<a name="l04961"></a>04961 <span class="preprocessor"></span>                              bAction = <a class="code" href="ai_8h.html#0a4ddf8062e33366cea57ebbeb597174">DecideActionRed</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,TRUE);
<a name="l04962"></a>04962 <span class="preprocessor">                              #ifdef AI_TIMING_TESTS</span>
<a name="l04963"></a>04963 <span class="preprocessor"></span>                                    uiEndTime = GetJA2Clock();
<a name="l04964"></a>04964                                     <a class="code" href="Items_8cpp.html#188ca4816426ac56fb709cf23b35d31c">guiRedTimeTotal</a> += (uiEndTime - uiStartTime);
<a name="l04965"></a>04965                                     <a class="code" href="Items_8cpp.html#7188e6c7639fc54414157c7dfbc0fc97">guiRedCounter</a>++;
<a name="l04966"></a>04966 <span class="preprocessor">                              #endif</span>
<a name="l04967"></a>04967 <span class="preprocessor"></span>                              <span class="keywordflow">break</span>;
<a name="l04968"></a>04968 
<a name="l04969"></a>04969        <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532cb7890b45734e38021cf4022c1f24e2">STATUS_BLACK</a>:
<a name="l04970"></a>04970 <span class="preprocessor">                        #ifdef DEBUGDECISIONS</span>
<a name="l04971"></a>04971 <span class="preprocessor"></span>                              <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(<span class="stringliteral">"AlertStatus = BLACK"</span>);
<a name="l04972"></a>04972 <span class="preprocessor">                        #endif</span>
<a name="l04973"></a>04973 <span class="preprocessor"></span><span class="preprocessor">                              #ifdef AI_TIMING_TESTS</span>
<a name="l04974"></a>04974 <span class="preprocessor"></span>                                    uiStartTime = GetJA2Clock();
<a name="l04975"></a>04975 <span class="preprocessor">                              #endif</span>
<a name="l04976"></a>04976 <span class="preprocessor"></span>                              bAction = <a class="code" href="ai_8h.html#80afb7150d57db68238ca93a590f90af">DecideActionBlack</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l04977"></a>04977                               DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"DecideActionBlack=%d"</span>,bAction));
<a name="l04978"></a>04978 <span class="preprocessor">                              #ifdef AI_TIMING_TESTS</span>
<a name="l04979"></a>04979 <span class="preprocessor"></span>                                    uiEndTime = GetJA2Clock();
<a name="l04980"></a>04980                                     <a class="code" href="Items_8cpp.html#defec480a0ddf33c9ace05ab1478ed1b">guiBlackTimeTotal</a> += (uiEndTime - uiStartTime);
<a name="l04981"></a>04981                                     <a class="code" href="Items_8cpp.html#3400808251577fa392a76aae9bdf9338">guiBlackCounter</a>++;
<a name="l04982"></a>04982 <span class="preprocessor">                              #endif</span>
<a name="l04983"></a>04983 <span class="preprocessor"></span>                              <span class="keywordflow">break</span>;
<a name="l04984"></a>04984       }
<a name="l04985"></a>04985     }
<a name="l04986"></a>04986   }
<a name="l04987"></a>04987 
<a name="l04988"></a>04988  
<a name="l04989"></a>04989 
<a name="l04990"></a>04990 <span class="preprocessor">#ifdef DEBUGDECISIONS</span>
<a name="l04991"></a>04991 <span class="preprocessor"></span>      sprintf((CHAR *) tempstr,<span class="stringliteral">"DecideAction: selected action %d, actionData %d\n\n"</span>,bAction,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l04992"></a>04992       <a class="code" href="ai_8h.html#67640c28ffcaa1eb59c6780ea4bb2e23">DebugAI</a>((<a class="code" href="Types_8h.html#ba0652aa53ceb4404f77e13a0c993b0e">STR</a>) tempstr );
<a name="l04993"></a>04993 <span class="preprocessor">#endif</span>
<a name="l04994"></a>04994 <span class="preprocessor"></span>
<a name="l04995"></a>04995 DebugMsg (<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<span class="stringliteral">"DecideAction done"</span>);
<a name="l04996"></a>04996       
<a name="l04997"></a>04997  <span class="keywordflow">return</span>(bAction);
<a name="l04998"></a>04998 }
<a name="l04999"></a>04999 
<a name="l05000"></a><a class="code" href="DecideAction_8cpp.html#79895c81d646ab0408fc4c51a46be1f4">05000</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="ai_8h.html#79895c81d646ab0408fc4c51a46be1f4">DecideActionEscort</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pSoldier)
<a name="l05001"></a>05001 {
<a name="l05002"></a>05002 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l05003"></a>05003 <span class="preprocessor"></span>            <a class="code" href="Types_8h.html#94ebfccc6e846c28751f8d616371f1e5">STR16</a> tempstr;
<a name="l05004"></a>05004 <span class="preprocessor">      #endif</span>
<a name="l05005"></a>05005 <span class="preprocessor"></span> 
<a name="l05006"></a>05006       <span class="comment">// if he has a place to go, and isn't already there... go!</span>
<a name="l05007"></a>05007       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> != NOWHERE &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>))
<a name="l05008"></a>05008       {
<a name="l05009"></a>05009 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l05010"></a>05010 <span class="preprocessor"></span>            sprintf((CHAR *)tempstr,<span class="stringliteral">"%s - ESCORTED NPC GOING to grid %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>);
<a name="l05011"></a>05011             <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l05012"></a>05012 <span class="preprocessor">      #endif</span>
<a name="l05013"></a>05013 <span class="preprocessor"></span>
<a name="l05014"></a>05014             <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950bd6ec85ce1f2d875bf6957fb46e63b70c">AI_ACTION_ESCORTED_MOVE</a>);
<a name="l05015"></a>05015        }
<a name="l05016"></a>05016       <span class="keywordflow">else</span>
<a name="l05017"></a>05017             <span class="keywordflow">return</span>(<a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b8e57fce88032f1864672cb6c0859cfb8">AI_ACTION_NONE</a>);
<a name="l05018"></a>05018 }
<a name="l05019"></a>05019 
<a name="l05020"></a>05020 
<a name="l05021"></a><a class="code" href="DecideAction_8cpp.html#deb4b27c776d12c422d88811706807fe">05021</a> <span class="keywordtype">void</span> <a class="code" href="AIInternals_8h.html#deb4b27c776d12c422d88811706807fe">DecideAlertStatus</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pSoldier )
<a name="l05022"></a>05022 {
<a name="l05023"></a>05023 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l05024"></a>05024 <span class="preprocessor"></span>            <a class="code" href="Types_8h.html#94ebfccc6e846c28751f8d616371f1e5">STR16</a> tempstr;
<a name="l05025"></a>05025 <span class="preprocessor">      #endif</span>
<a name="l05026"></a>05026 <span class="preprocessor"></span>      <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>  bOldStatus;
<a name="l05027"></a>05027       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iDummy;
<a name="l05028"></a>05028       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fClimbDummy,fReachableDummy;
<a name="l05029"></a>05029 
<a name="l05030"></a>05030       <span class="comment">// THE FOUR (4) POSSIBLE ALERT STATUSES ARE:</span>
<a name="l05031"></a>05031       <span class="comment">// GREEN - No one seen, no suspicious noise heard, go about regular duties</span>
<a name="l05032"></a>05032       <span class="comment">// YELLOW - Suspicious noise was heard personally or radioed in by buddy</span>
<a name="l05033"></a>05033       <span class="comment">// RED - Either saw opponents in person, or definite contact had been radioed</span>
<a name="l05034"></a>05034       <span class="comment">// BLACK - Currently has one or more opponents in sight</span>
<a name="l05035"></a>05035 
<a name="l05036"></a>05036       <span class="comment">// save the man's previous status</span>
<a name="l05037"></a>05037 
<a name="l05038"></a>05038       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_MONSTER)
<a name="l05039"></a>05039       {
<a name="l05040"></a>05040             <a class="code" href="AIInternals_8h.html#d1735ca8d1ee257b7f942c09e439ccaf">CreatureDecideAlertStatus</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l05041"></a>05041             <span class="keywordflow">return</span>;
<a name="l05042"></a>05042       }
<a name="l05043"></a>05043 
<a name="l05044"></a>05044       bOldStatus = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a>;
<a name="l05045"></a>05045 
<a name="l05046"></a>05046       <span class="comment">// determine the current alert status for this category of man</span>
<a name="l05047"></a>05047       <span class="comment">//if (!(pSoldier-&gt;uiStatusFlags &amp; SOLDIER_PC))</span>
<a name="l05048"></a>05048       {
<a name="l05049"></a>05049             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#794f2b53a1e037c0f011fe3aa2cebec8">bOppCnt</a> &gt; 0)        <span class="comment">// opponent(s) in sight</span>
<a name="l05050"></a>05050             {
<a name="l05051"></a>05051                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532cb7890b45734e38021cf4022c1f24e2">STATUS_BLACK</a>;
<a name="l05052"></a>05052                   <a class="code" href="ai_8h.html#7753064f76c879dd64430c27c5b259ff">CheckForChangingOrders</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l05053"></a>05053             }
<a name="l05054"></a>05054             <span class="keywordflow">else</span>                        <span class="comment">// no opponents are in sight</span>
<a name="l05055"></a>05055             {
<a name="l05056"></a>05056                   <span class="keywordflow">switch</span> (bOldStatus)
<a name="l05057"></a>05057                   {
<a name="l05058"></a>05058                         <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532cb7890b45734e38021cf4022c1f24e2">STATUS_BLACK</a>:
<a name="l05059"></a>05059                               <span class="comment">// then drop back to RED status</span>
<a name="l05060"></a>05060                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>;
<a name="l05061"></a>05061                               <span class="keywordflow">break</span>;
<a name="l05062"></a>05062 
<a name="l05063"></a>05063                         <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>:
<a name="l05064"></a>05064                               <span class="comment">// RED can never go back down below RED, only up to BLACK</span>
<a name="l05065"></a>05065                               <span class="keywordflow">break</span>;
<a name="l05066"></a>05066 
<a name="l05067"></a>05067                         <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726530ecf4468b8fd828fc47998fef0f857fd">STATUS_YELLOW</a>:
<a name="l05068"></a>05068                               <span class="comment">// if all enemies have been RED alerted, or we're under fire</span>
<a name="l05069"></a>05069                               <span class="keywordflow">if</span> (!PTR_CIVILIAN &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bAwareOfOpposition || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4d7d451394eccbed289b3276bc325722">bUnderFire</a>))
<a name="l05070"></a>05070                               {
<a name="l05071"></a>05071                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>;
<a name="l05072"></a>05072                               }
<a name="l05073"></a>05073                               <span class="keywordflow">else</span>
<a name="l05074"></a>05074                               {
<a name="l05075"></a>05075                                     <span class="comment">// if we are NOT aware of any uninvestigated noises right now</span>
<a name="l05076"></a>05076                                     <span class="comment">// and we are not currently in the middle of an action</span>
<a name="l05077"></a>05077                                     <span class="comment">// (could still be on his way heading to investigate a noise!)</span>
<a name="l05078"></a>05078                                     <span class="keywordflow">if</span> ((<a class="code" href="AIInternals_8h.html#774611f6beecaa6455887e3b463833c4">MostImportantNoiseHeard</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,&amp;iDummy,&amp;fClimbDummy,&amp;fReachableDummy) == NOWHERE) &amp;&amp; !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e9fecf31042005f1ae06517e13309c22">bActionInProgress</a>)
<a name="l05079"></a>05079                                     {
<a name="l05080"></a>05080                                           <span class="comment">// then drop back to GREEN status</span>
<a name="l05081"></a>05081                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532f91de342fc2584dd731cfe5d47271c6">STATUS_GREEN</a>;
<a name="l05082"></a>05082                                           <a class="code" href="ai_8h.html#7753064f76c879dd64430c27c5b259ff">CheckForChangingOrders</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l05083"></a>05083                                     }
<a name="l05084"></a>05084                               }
<a name="l05085"></a>05085                               <span class="keywordflow">break</span>;
<a name="l05086"></a>05086 
<a name="l05087"></a>05087                         <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532f91de342fc2584dd731cfe5d47271c6">STATUS_GREEN</a>:
<a name="l05088"></a>05088                               <span class="comment">// if all enemies have been RED alerted, or we're under fire</span>
<a name="l05089"></a>05089                               <span class="keywordflow">if</span> (!PTR_CIVILIAN &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>].bAwareOfOpposition || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4d7d451394eccbed289b3276bc325722">bUnderFire</a>))
<a name="l05090"></a>05090                               {
<a name="l05091"></a>05091                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>;
<a name="l05092"></a>05092                               }
<a name="l05093"></a>05093                               <span class="keywordflow">else</span>
<a name="l05094"></a>05094                               {
<a name="l05095"></a>05095                                     <span class="comment">// if we ARE aware of any uninvestigated noises right now</span>
<a name="l05096"></a>05096                                     <span class="keywordflow">if</span> (<a class="code" href="AIInternals_8h.html#774611f6beecaa6455887e3b463833c4">MostImportantNoiseHeard</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,&amp;iDummy,&amp;fClimbDummy,&amp;fReachableDummy) != NOWHERE)
<a name="l05097"></a>05097                                     {
<a name="l05098"></a>05098                                           <span class="comment">// then move up to YELLOW status</span>
<a name="l05099"></a>05099                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726530ecf4468b8fd828fc47998fef0f857fd">STATUS_YELLOW</a>;
<a name="l05100"></a>05100                                     }
<a name="l05101"></a>05101                               }
<a name="l05102"></a>05102                               <span class="keywordflow">break</span>;
<a name="l05103"></a>05103                   }
<a name="l05104"></a>05104        <span class="comment">// otherwise, RED stays RED, YELLOW stays YELLOW, GREEN stays GREEN</span>
<a name="l05105"></a>05105             }
<a name="l05106"></a>05106       }
<a name="l05107"></a>05107 
<a name="l05108"></a>05108 <span class="preprocessor">#if 0</span>
<a name="l05109"></a>05109 <span class="preprocessor"></span>      <span class="keywordflow">else</span>
<a name="l05110"></a>05110       {
<a name="l05111"></a>05111             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#794f2b53a1e037c0f011fe3aa2cebec8">bOppCnt</a> &gt; 0)
<a name="l05112"></a>05112             {
<a name="l05113"></a>05113                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532cb7890b45734e38021cf4022c1f24e2">STATUS_BLACK</a>; <span class="comment">// opponent(s) in sight</span>
<a name="l05114"></a>05114             }
<a name="l05115"></a>05115             <span class="keywordflow">else</span>
<a name="l05116"></a>05116             {
<a name="l05117"></a>05117                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>;         <span class="comment">// enemy sector</span>
<a name="l05118"></a>05118 
<a name="l05119"></a>05119 <span class="comment">/*</span>
<a name="l05120"></a>05120 <span class="comment">                  // wow, JA1 stuff...</span>
<a name="l05121"></a>05121 <span class="comment">       // good guys all have a built-in, magic, "enemy detecting radar"...</span>
<a name="l05122"></a>05122 <span class="comment">       if (Status.enemies)</span>
<a name="l05123"></a>05123 <span class="comment">       pSoldier-&gt;bAlertStatus = STATUS_RED;         // enemy sector</span>
<a name="l05124"></a>05124 <span class="comment">       else</span>
<a name="l05125"></a>05125 <span class="comment">      {</span>
<a name="l05126"></a>05126 <span class="comment">       pSoldier-&gt;bAlertStatus = STATUS_GREEN;       // secured sector</span>
<a name="l05127"></a>05127 <span class="comment"></span>
<a name="l05128"></a>05128 <span class="comment">       // if he just dropped back from alert status, and it's a GUARD</span>
<a name="l05129"></a>05129 <span class="comment">       if ((oldStatus &gt;= STATUS_RED) &amp;&amp; (pSoldier-&gt;manCategory == MAN_GUARD))</span>
<a name="l05130"></a>05130 <span class="comment">        {</span>
<a name="l05131"></a>05131 <span class="comment">         if (pSoldier-&gt;whereIWas == NOWHERE)       // not assigned to any trees</span>
<a name="l05132"></a>05132 <span class="comment">           // FUTURE ENHANCEMENT: Look for unguarded trees with tappers</span>
<a name="l05133"></a>05133 <span class="comment">           pSoldier-&gt;orders = ONCALL;</span>
<a name="l05134"></a>05134 <span class="comment">         else                                 // assigned to trees</span>
<a name="l05135"></a>05135 <span class="comment">           // FUTURE ENHANCEMENT: If his tree is now tapperless, go ONCALL</span>
<a name="l05136"></a>05136 <span class="comment">           pSoldier-&gt;orders = CLOSEPATROL;         // go back to his tree area</span>
<a name="l05137"></a>05137 <span class="comment"></span>
<a name="l05138"></a>05138 <span class="comment">         // turn off any existing bypass to Green and its "hyper-activity"</span>
<a name="l05139"></a>05139 <span class="comment">         pSoldier-&gt;bypassToGreen = FALSE;</span>
<a name="l05140"></a>05140 <span class="comment"></span>
<a name="l05141"></a>05141 <span class="comment">         // turn off the "inTheWay" flag, may have been set during TurnBased</span>
<a name="l05142"></a>05142 <span class="comment">         pSoldier-&gt;inTheWay = FALSE;</span>
<a name="l05143"></a>05143 <span class="comment"></span>
<a name="l05144"></a>05144 <span class="comment">         // make the guard put his gun away if he has it drawn</span>
<a name="l05145"></a>05145 <span class="comment">         HandleNoMoreTarget(pSoldier);</span>
<a name="l05146"></a>05146 <span class="comment">        }</span>
<a name="l05147"></a>05147 <span class="comment">      }</span>
<a name="l05148"></a>05148 <span class="comment">*/</span>
<a name="l05149"></a>05149       }
<a name="l05150"></a>05150   }
<a name="l05151"></a>05151 <span class="preprocessor">#endif</span>
<a name="l05152"></a>05152 <span class="preprocessor"></span>
<a name="l05153"></a>05153       <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#32021b7251048d8c62ea0c2e26b7a021">bBoxingState</a> == <a class="code" href="Overhead_01Types_8h.html#60ed5bd8e4835b98d48cf7afb819b4e5f2caf361bed5cf6236018fbb59ecded2">NOT_BOXING</a> )
<a name="l05154"></a>05154       {
<a name="l05155"></a>05155 
<a name="l05156"></a>05156             <span class="comment">// if the man's alert status has changed in any way</span>
<a name="l05157"></a>05157             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> != bOldStatus)
<a name="l05158"></a>05158             {
<a name="l05159"></a>05159                   <span class="comment">// HERE ARE TRYING TO AVOID NPCs SHUFFLING BACK &amp; FORTH BETWEEN RED &amp; BLACK</span>
<a name="l05160"></a>05160                   <span class="comment">// if either status is &lt; RED (ie. anything but RED-&gt;BLACK &amp;&amp; BLACK-&gt;RED)</span>
<a name="l05161"></a>05161                   <span class="keywordflow">if</span> ((bOldStatus &lt; <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>) || (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> &lt; <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>))
<a name="l05162"></a>05162                   {
<a name="l05163"></a>05163                         <span class="comment">// force a NEW action decision on next pass through HandleManAI()</span>
<a name="l05164"></a>05164                         <a class="code" href="ai_8h.html#af2540c1459f467488884f02b709c0ae">SetNewSituation</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l05165"></a>05165                   }
<a name="l05166"></a>05166 
<a name="l05167"></a>05167                   <span class="comment">// if this guy JUST discovered that there were opponents here for sure...</span>
<a name="l05168"></a>05168                   <span class="keywordflow">if</span> ((bOldStatus &lt; <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>) &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> &gt;= <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726538e43b8a191f7ae1324ae723f5b88d4f6">STATUS_RED</a>))
<a name="l05169"></a>05169                   {
<a name="l05170"></a>05170                         <a class="code" href="ai_8h.html#7753064f76c879dd64430c27c5b259ff">CheckForChangingOrders</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>);
<a name="l05171"></a>05171                   }
<a name="l05172"></a>05172 
<a name="l05173"></a>05173 <span class="preprocessor">      #ifdef DEBUGDECISIONS</span>
<a name="l05174"></a>05174 <span class="preprocessor"></span>                  <span class="comment">// don't report status changes for human-controlled mercs</span>
<a name="l05175"></a>05175                         sprintf((CHAR *)tempstr,<span class="stringliteral">"%s's Alert Status changed from %d to %d"</span>,
<a name="l05176"></a>05176                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>,bOldStatus,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a>);
<a name="l05177"></a>05177                         <a class="code" href="AIUtils_8cpp.html#e83cc05463b34975f01de42c4bf093ce">AIPopMessage</a>(tempstr);
<a name="l05178"></a>05178 <span class="preprocessor">      #endif</span>
<a name="l05179"></a>05179 <span class="preprocessor"></span>
<a name="l05180"></a>05180             }
<a name="l05181"></a>05181             <span class="keywordflow">else</span>   <span class="comment">// status didn't change</span>
<a name="l05182"></a>05182             {
<a name="l05183"></a>05183                   <span class="comment">// only do this stuff in TB</span>
<a name="l05184"></a>05184                   <span class="comment">// if a guy on status GREEN or YELLOW is running low on breath</span>
<a name="l05185"></a>05185                   <span class="keywordflow">if</span> (((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> == <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532f91de342fc2584dd731cfe5d47271c6">STATUS_GREEN</a>)  &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a> &lt; 75)) ||
<a name="l05186"></a>05186                         ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1dbdf1f93e3ca09449fd70635cceb8cb">bAlertStatus</a> == <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726530ecf4468b8fd828fc47998fef0f857fd">STATUS_YELLOW</a>) &amp;&amp; (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2a44d10fbcd1df19ba5bdbb4c1e60a38">bBreath</a> &lt; 50)))
<a name="l05187"></a>05187                   {
<a name="l05188"></a>05188                         <span class="comment">// as long as he's not in water (standing on a bridge is OK)</span>
<a name="l05189"></a>05189                         <span class="keywordflow">if</span> (!<a class="code" href="Soldier_01Control_8cpp.html#136730f4d5bc849d712446b0b871205a">MercInWater</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>))
<a name="l05190"></a>05190                         {
<a name="l05191"></a>05191                               <span class="comment">// force a NEW decision so that he can get some rest</span>
<a name="l05192"></a>05192                               <a class="code" href="ai_8h.html#af2540c1459f467488884f02b709c0ae">SetNewSituation</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l05193"></a>05193 
<a name="l05194"></a>05194                               <span class="comment">// current action will be canceled. if noise is no longer important</span>
<a name="l05195"></a>05195                               <span class="keywordflow">if</span> ((pSoldier-&gt;bAlertStatus == <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726530ecf4468b8fd828fc47998fef0f857fd">STATUS_YELLOW</a>) &amp;&amp;
<a name="l05196"></a>05196                                     (<a class="code" href="AIInternals_8h.html#774611f6beecaa6455887e3b463833c4">MostImportantNoiseHeard</a>(pSoldier,&amp;iDummy,&amp;fClimbDummy,&amp;fReachableDummy) == NOWHERE))
<a name="l05197"></a>05197                               {
<a name="l05198"></a>05198                                     <span class="comment">// then drop back to GREEN status</span>
<a name="l05199"></a>05199                                     pSoldier-&gt;bAlertStatus = <a class="code" href="Overhead_01Types_8h.html#727cc1d940fa1a6396c79b0f86a726532f91de342fc2584dd731cfe5d47271c6">STATUS_GREEN</a>;
<a name="l05200"></a>05200                                     <a class="code" href="ai_8h.html#7753064f76c879dd64430c27c5b259ff">CheckForChangingOrders</a>( pSoldier );
<a name="l05201"></a>05201                               }
<a name="l05202"></a>05202                         }
<a name="l05203"></a>05203                   }
<a name="l05204"></a>05204             }
<a name="l05205"></a>05205       }
<a name="l05206"></a>05206 
<a name="l05207"></a>05207 }
<a name="l05208"></a>05208 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Sep 9 13:48:02 2006 for Build by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
