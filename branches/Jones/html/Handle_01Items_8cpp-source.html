<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Build: Handle Items.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_3179ea33d55a76dc38212d9eab798728.html">export</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e5664b4b56927c8728eb3192fa60e338.html">hdc2</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_1eb12a41a47efb9efcd82fa98f4f4dbd.html">FTP</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_80cc1f21a78ab7941088ea567f236150.html">ja2src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_994ab287602efefceafe55287a3657d6.html">Build</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_43ed33c8f48e75fecb0508860a16371c.html">Tactical</a></div>
<h1>Handle Items.cpp</h1><a href="Handle_01Items_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifdef PRECOMPILEDHEADERS</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">      #include "<a class="code" href="Tactical_01All_8h.html">Tactical All.h</a>"</span>
<a name="l00003"></a>00003 <span class="preprocessor">#else</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor">      #include "items.h"</span>
<a name="l00005"></a>00005 <span class="preprocessor">      #include "<a class="code" href="Action_01Items_8h.html">Action Items.h</a>"</span>
<a name="l00006"></a>00006 <span class="preprocessor">      #include "handle Items.h"</span>
<a name="l00007"></a>00007 <span class="preprocessor">      #include "overhead.h"</span>
<a name="l00008"></a>00008 <span class="preprocessor">      #include "weapons.h"</span>
<a name="l00009"></a>00009 <span class="preprocessor">      #include "points.h"</span>
<a name="l00010"></a>00010 <span class="preprocessor">      #include "<a class="code" href="tiledef_8h.html">tiledef.h</a>"</span>
<a name="l00011"></a>00011 <span class="preprocessor">      #include "<a class="code" href="worlddef_8h.html">worlddef.h</a>"</span>
<a name="l00012"></a>00012 <span class="preprocessor">      #include "<a class="code" href="worldman_8h.html">worldman.h</a>"</span>
<a name="l00013"></a>00013 <span class="preprocessor">      #include "interface.h"</span>
<a name="l00014"></a>00014 <span class="preprocessor">      #include "<a class="code" href="renderworld_8h.html">renderworld.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">      #include "<a class="code" href="Animation_01Control_8h.html">Animation Control.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">      #include "font control.h"</span>
<a name="l00017"></a>00017 <span class="preprocessor">      #include "render dirty.h"</span>
<a name="l00018"></a>00018 <span class="preprocessor">      #include "World items.h"</span>
<a name="l00019"></a>00019 <span class="preprocessor">      #include "text.h"</span>
<a name="l00020"></a>00020 <span class="preprocessor">      #include "<a class="code" href="Timer_01Control_8h.html">Timer Control.h</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">      #include "wcheck.h"</span>
<a name="l00022"></a>00022 <span class="preprocessor">      #include "interface items.h"</span>
<a name="l00023"></a>00023 <span class="preprocessor">      #include "<a class="code" href="physics_8h.html">physics.h</a>"</span>
<a name="l00024"></a>00024 <span class="preprocessor">      #include "soldier profile.h"</span>
<a name="l00025"></a>00025 <span class="preprocessor">      #include "interface dialogue.h"</span>
<a name="l00026"></a>00026 <span class="preprocessor">      #include "quests.h"</span>
<a name="l00027"></a>00027 <span class="preprocessor">      #include "<a class="code" href="message_8h.html">message.h</a>"</span>
<a name="l00028"></a>00028 <span class="preprocessor">      #include "isometric utils.h"</span>
<a name="l00029"></a>00029 <span class="preprocessor">      #include "los.h"</span>
<a name="l00030"></a>00030 <span class="preprocessor">      #include "dialogue control.h"</span>
<a name="l00031"></a>00031 <span class="preprocessor">      #include "<a class="code" href="ai_8h.html">ai.h</a>"</span>
<a name="l00032"></a>00032 <span class="preprocessor">      #include "soldier macros.h"</span>
<a name="l00033"></a>00033 <span class="preprocessor">      #include "interface panels.h"</span>
<a name="l00034"></a>00034 <span class="preprocessor">      #include "<a class="code" href="Strategic_01Town_01Loyalty_8h.html">Strategic Town Loyalty.h</a>"</span>
<a name="l00035"></a>00035 <span class="preprocessor">      #include "soldier functions.h"</span>
<a name="l00036"></a>00036 <span class="preprocessor">      #include "<a class="code" href="Map_01Screen_01Helicopter_8h.html">Map Screen Helicopter.h</a>"</span>
<a name="l00037"></a>00037 <span class="preprocessor">      #include "pathai.h"</span>
<a name="l00038"></a>00038 <span class="preprocessor">      #include "<a class="code" href="fov_8h.html">fov.h</a>"</span>
<a name="l00039"></a>00039 <span class="preprocessor">      #include "<a class="code" href="MessageBoxScreen_8h.html">MessageBoxScreen.h</a>"</span>
<a name="l00040"></a>00040 <span class="preprocessor">      #include "explosion control.h"</span>
<a name="l00041"></a>00041 <span class="preprocessor">      #include "<a class="code" href="SkillCheck_8h.html">SkillCheck.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">      #include "<a class="code" href="Campaign_8h.html">Campaign.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">      #include "Random.h"</span>
<a name="l00044"></a>00044 <span class="preprocessor">      #include "structure wrap.h"</span>
<a name="l00045"></a>00045 <span class="preprocessor">      #include "interactive tiles.h"</span>
<a name="l00046"></a>00046 <span class="preprocessor">      #include "<a class="code" href="SaveLoadMap_8h.html">SaveLoadMap.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">      #include "<a class="code" href="ShopKeeper_01Interface_8h.html">ShopKeeper Interface.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">      #include "<a class="code" href="Arms_01Dealer_01Init_8h.html">Arms Dealer Init.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">      #include "soldier add.h"</span>
<a name="l00050"></a>00050 <span class="preprocessor">      #include "sound control.h"</span>
<a name="l00051"></a>00051 <span class="preprocessor">      #include "squads.h"</span>
<a name="l00052"></a>00052 <span class="preprocessor">      #include "rotting corpses.h"</span>
<a name="l00053"></a>00053 <span class="preprocessor">      #include "soldier ani.h"</span>
<a name="l00054"></a>00054 <span class="preprocessor">      #include "Opplist.h"</span>
<a name="l00055"></a>00055 <span class="preprocessor">      #include "<a class="code" href="qarray_8h.html">qarray.h</a>"</span>
<a name="l00056"></a>00056 <span class="preprocessor">      #include "render fun.h"</span>
<a name="l00057"></a>00057 <span class="preprocessor">      #include "<a class="code" href="environment_8h.html">environment.h</a>"</span>
<a name="l00058"></a>00058 <span class="preprocessor">#endif</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>
<a name="l00060"></a>00060 <span class="preprocessor">#define                             NUM_ITEMS_LISTED              8</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">#define                             NUM_ITEM_FLASH_SLOTS    50</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="preprocessor">#define                             MIN_LOB_RANGE                             6</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">00065</a> <a class="code" href="structITEM__POOL__LOCATOR.html">ITEM_POOL_LOCATOR</a>                   <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ NUM_ITEM_FLASH_SLOTS ];
<a name="l00066"></a><a class="code" href="Handle_01Items_8cpp.html#c473fcc349af3b6e5e7f30711c1f9429">00066</a> <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>                                                      <a class="code" href="Handle_01Items_8cpp.html#c473fcc349af3b6e5e7f30711c1f9429">guiNumFlashItemSlots</a> = 0;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <a class="code" href="structTAG__level__node.html">LEVELNODE</a> *<a class="code" href="Handle_01Items_8cpp.html#e6c8f73fc3fe56cf7f3dd72a60d70483">AddItemGraphicToWorld</a>( <a class="code" href="structINVTYPE.html">INVTYPE</a> *pItem, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel );
<a name="l00070"></a>00070 <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="Handle_01Items_8cpp.html#04e9ed094169e82cf0be4c7592bf5ebb">GetListMouseHotSpot</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sLargestLineWidth, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bNumItemsListed, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sFontX, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sFontY, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bCurStart );
<a name="l00071"></a>00071 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#e4a707ca7113a89b31388f924084e62b">RemoveItemGraphicFromWorld</a>( <a class="code" href="structINVTYPE.html">INVTYPE</a> *pItem, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel, <a class="code" href="structTAG__level__node.html">LEVELNODE</a> *pLevelNode );
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> * <a class="code" href="Handle_01Items_8cpp.html#426a9cae81da45767082edae988d7d5e">GetItemPoolForIndex</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iItemIndex, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel );
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Handle_01Items_8cpp.html#8bcee147a07978cc32b44e1a474c515c">GetFreeFlashItemSlot</a>(<span class="keywordtype">void</span>);
<a name="l00076"></a>00076 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#256ce32be2bef0e7404222513fa16d3d">RecountFlashItemSlots</a>(<span class="keywordtype">void</span>);
<a name="l00077"></a>00077 <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Handle_01Items_8cpp.html#2ff04917cd79809a4622bd6747d1b10c">AddFlashItemSlot</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool, <a class="code" href="Handle_01Items_8h.html#617cdd488b649139d4f59da69c7a4581">ITEM_POOL_LOCATOR_HOOK</a> Callback, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubFlags );
<a name="l00078"></a>00078 <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#5d83ffed8d6e4efd1820b490234df23d">RemoveFlashItemSlot</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool );
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="comment">// Disgusting hacks: have to keep track of these values for accesses in callbacks</span>
<a name="l00081"></a><a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">00081</a> <span class="keyword">static</span> <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *    <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>;
<a name="l00082"></a><a class="code" href="Handle_01Items_8cpp.html#2a4f3638cd7bc6c7361fbb6f14de1114">00082</a> <span class="keyword">static</span> <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                              <a class="code" href="Handle_01Items_8cpp.html#2a4f3638cd7bc6c7361fbb6f14de1114">gsTempGridno</a>;
<a name="l00083"></a><a class="code" href="Handle_01Items_8cpp.html#57d4fe8bcf106c822f1ac63008a4f28d">00083</a> <span class="keyword">static</span> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                               <a class="code" href="Handle_01Items_8cpp.html#57d4fe8bcf106c822f1ac63008a4f28d">bTempFrequency</a>;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#418b08f9fd1bcbe6f4af586abaf88c2e">BombMessageBoxCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue );
<a name="l00086"></a>00086 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#e1d43de575fe0728997851c36c81644b">BoobyTrapMessageBoxCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue );
<a name="l00087"></a>00087 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#ee52aafb872bfd335e0c54fedaa2e128">SwitchMessageBoxCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue );
<a name="l00088"></a>00088 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#7604c764ed5d12231713e8204072346c">BoobyTrapDialogueCallBack</a>( <span class="keywordtype">void</span> );
<a name="l00089"></a>00089 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#7f80ae8d4985e6da4575fd545cb51a2d">MineSpottedDialogueCallBack</a>( <span class="keywordtype">void</span> );
<a name="l00090"></a>00090 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#fb1b003f16dd2d4cab628193e7e9e673">MineSpottedLocatorCallback</a>( <span class="keywordtype">void</span> );
<a name="l00091"></a>00091 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#6dc7fb5abedf9373075875a601964bfe">RemoveBlueFlagDialogueCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue );
<a name="l00092"></a>00092 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#bf51e1afd56dade27cff5d8cf0b5f479">MineSpottedMessageBoxCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue );
<a name="l00093"></a>00093 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#7756ad997efa08df951c7de26ea6d50d">CheckForPickedOwnership</a>( <span class="keywordtype">void</span> );
<a name="l00094"></a>00094 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#f4498d4e49d6858e1f0636c8d35cf936">BoobyTrapInMapScreenMessageBoxCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue );
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#91ef9b366fe4c09b75bfe1e16c3f63b5">ContinuePastBoobyTrap</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bLevel, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iItemIndex, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fInStrategic, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> *pfSaidQuote );
<a name="l00098"></a>00098 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#c4c488e0463a2f8e01ab74ba02fb9f15">ItemIsCool</a>( <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> * pObj );
<a name="l00099"></a>00099 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="Handle_01Items_8cpp.html#04376bb6c024a83ce993a29ac1d8aeb8">gbItemPointerSrcSlot</a>;
<a name="l00100"></a>00100 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="Map_01Screen_01Interface_01Map_01Inventory_8cpp.html#addaead2158d7ab84c664c17506ffcee">MAPEndItemPointer</a>( );
<a name="l00101"></a>00101 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>    <a class="code" href="Handle_01Items_8cpp.html#0d67a1e997a3d54c71a0127ef4963a92">gfResetUIMovementOptimization</a>;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#0a41cd226d7b2ce19b27e23f3419922c">ItemPoolOKForPickup</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bZLevel );
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="Handle_01Items_8h.html#553f19703890d5de0b76be491cca8486">00105</a> <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *           <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>;
<a name="l00106"></a><a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">00106</a> <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *             <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a>;
<a name="l00107"></a><a class="code" href="Handle_01Items_8h.html#f1b620fc987b448487541c70463b4667">00107</a> <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                               <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a>;
<a name="l00108"></a><a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">00108</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>            <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a>;
<a name="l00109"></a><a class="code" href="Handle_01Items_8cpp.html#646730befce457ec377a2857d5ee5e90">00109</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                             <a class="code" href="Handle_01Items_8cpp.html#646730befce457ec377a2857d5ee5e90">gfDisarmingBuriedBomb</a>;
<a name="l00110"></a>00110 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>    <a class="code" href="Handle_01Items_8cpp.html#b2107f877c6241f423b9c1c443966fbe">gfDontChargeAPsToPickup</a>;
<a name="l00111"></a><a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">00111</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                                <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a>;
<a name="l00112"></a><a class="code" href="Handle_01Items_8cpp.html#b1635f6322fd155d731b899f5d3ee15d">00112</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                             <a class="code" href="Handle_01Items_8cpp.html#b1635f6322fd155d731b899f5d3ee15d">gfJustFoundBoobyTrap</a> = FALSE;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#8be34a74ed567842429dd7d4eeb78195">StartBombMessageBox</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo );
<a name="l00115"></a>00115 
<a name="l00116"></a><a class="code" href="UI_01Cursors_8cpp.html#d82ed66e3fd8a0a804c3b57d12bb5727">00116</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>     <a class="code" href="Handle_01Items_8cpp.html#d82ed66e3fd8a0a804c3b57d12bb5727">HandleCheckForBadChangeToGetThrough</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pTargetSoldier, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sTargetGridNo , <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bLevel ) 
<a name="l00117"></a>00117 {
<a name="l00118"></a>00118       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                                   fBadChangeToGetThrough = FALSE;
<a name="l00119"></a>00119       DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"HandleCheckForBadChangeToGetThrough"</span>));
<a name="l00120"></a>00120 
<a name="l00121"></a>00121       <span class="keywordflow">if</span> ( pTargetSoldier != NULL )
<a name="l00122"></a>00122       {
<a name="l00123"></a>00123             <span class="keywordflow">if</span> ( <a class="code" href="LOS_8cpp.html#32f2c709c096712cb2c41298bf91013a">SoldierToSoldierBodyPartChanceToGetThrough</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, pTargetSoldier, pSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#a2e765b8729e88a5e542a2e7852f0ccb">bAimShotLocation</a> ) &lt; OK_CHANCE_TO_GET_THROUGH )
<a name="l00124"></a>00124             {
<a name="l00125"></a>00125                   fBadChangeToGetThrough = TRUE;
<a name="l00126"></a>00126             }
<a name="l00127"></a>00127       }
<a name="l00128"></a>00128       <span class="keywordflow">else</span>
<a name="l00129"></a>00129       {
<a name="l00130"></a>00130             <span class="keywordflow">if</span> ( <a class="code" href="LOS_8cpp.html#0bba132831658145428452e19b18c43e">SoldierToLocationChanceToGetThrough</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) bLevel, 0, NOBODY ) &lt; OK_CHANCE_TO_GET_THROUGH )
<a name="l00131"></a>00131             {           
<a name="l00132"></a>00132                   fBadChangeToGetThrough = TRUE;
<a name="l00133"></a>00133             }
<a name="l00134"></a>00134       }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136       <span class="keywordflow">if</span> ( fBadChangeToGetThrough )
<a name="l00137"></a>00137       {
<a name="l00138"></a>00138             <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#f385ab0789a59fef8969e8164aa5dd19">sCantGetThroughSoldierGridNo</a> != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ||  <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#14a5c917bd76d0b201d494c3c1e17fad">sCantGetThroughGridNo</a> != sTargetGridNo || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#71b29bb57ff79c191ec9043e84b1bcb1">ubCantGetThroughID</a> != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> )
<a name="l00139"></a>00139             {
<a name="l00140"></a>00140                   <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#cd4960ad9cf452b848b99eac7ef801e0">fCantGetThrough</a> = FALSE;
<a name="l00141"></a>00141             }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143             <span class="comment">// Have we done this once already?</span>
<a name="l00144"></a>00144             <span class="keywordflow">if</span> ( !<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#cd4960ad9cf452b848b99eac7ef801e0">fCantGetThrough</a> )
<a name="l00145"></a>00145             {
<a name="l00146"></a>00146                   <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#cd4960ad9cf452b848b99eac7ef801e0">fCantGetThrough</a>                                               = TRUE;
<a name="l00147"></a>00147                   <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#14a5c917bd76d0b201d494c3c1e17fad">sCantGetThroughGridNo</a>                             = sTargetGridNo;
<a name="l00148"></a>00148                   <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#71b29bb57ff79c191ec9043e84b1bcb1">ubCantGetThroughID</a>                                = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>;
<a name="l00149"></a>00149                   <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#f385ab0789a59fef8969e8164aa5dd19">sCantGetThroughSoldierGridNo</a>    = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151                   <span class="comment">// PLay quote</span>
<a name="l00152"></a>00152                   <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a2981e02ab2e09433f47e624c2ae26c8b01">QUOTE_NO_LINE_OF_FIRE</a> );
<a name="l00153"></a>00153                   <span class="keywordflow">return</span>( FALSE );
<a name="l00154"></a>00154             }
<a name="l00155"></a>00155             <span class="keywordflow">else</span>
<a name="l00156"></a>00156             {
<a name="l00157"></a>00157                   <span class="comment">// Is this a different case?</span>
<a name="l00158"></a>00158                   <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#14a5c917bd76d0b201d494c3c1e17fad">sCantGetThroughGridNo</a> != sTargetGridNo || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#71b29bb57ff79c191ec9043e84b1bcb1">ubCantGetThroughID</a> != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> || <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#f385ab0789a59fef8969e8164aa5dd19">sCantGetThroughSoldierGridNo</a> != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> )
<a name="l00159"></a>00159                   {
<a name="l00160"></a>00160                         <span class="comment">// PLay quote</span>
<a name="l00161"></a>00161                         <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#14a5c917bd76d0b201d494c3c1e17fad">sCantGetThroughGridNo</a>     = sTargetGridNo;
<a name="l00162"></a>00162                         <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#71b29bb57ff79c191ec9043e84b1bcb1">ubCantGetThroughID</a>        = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164                         <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a2981e02ab2e09433f47e624c2ae26c8b01">QUOTE_NO_LINE_OF_FIRE</a> );
<a name="l00165"></a>00165                         <span class="keywordflow">return</span>( FALSE );
<a name="l00166"></a>00166                   }
<a name="l00167"></a>00167             }
<a name="l00168"></a>00168       }
<a name="l00169"></a>00169       <span class="keywordflow">else</span>
<a name="l00170"></a>00170       {
<a name="l00171"></a>00171             <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#cd4960ad9cf452b848b99eac7ef801e0">fCantGetThrough</a> = FALSE;
<a name="l00172"></a>00172       }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174       <span class="keywordflow">return</span>( TRUE );
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 
<a name="l00180"></a><a class="code" href="Handle_01Items_8h.html#81366bee57d86f5258547f14ca646619">00180</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Handle_01Items_8cpp.html#81366bee57d86f5258547f14ca646619">HandleItem</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> usGridNo, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bLevel, <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> usHandItem, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fFromUI )
<a name="l00181"></a>00181 {
<a name="l00182"></a>00182       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a>                   *pTargetSoldier = NULL;
<a name="l00183"></a>00183       <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>                                    usSoldierIndex;
<a name="l00184"></a>00184       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                     sTargetGridNo;
<a name="l00185"></a>00185       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                     sAPCost;
<a name="l00186"></a>00186       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                     sActionGridNo;
<a name="l00187"></a>00187       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                                     ubDirection;
<a name="l00188"></a>00188       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                     sAdjustedGridNo;
<a name="l00189"></a>00189       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                                   fDropBomb = FALSE;
<a name="l00190"></a>00190   <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                                 fAddingTurningCost = FALSE;
<a name="l00191"></a>00191   <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                                 fAddingRaiseGunCost = FALSE;
<a name="l00192"></a>00192       <a class="code" href="structTAG__level__node.html">LEVELNODE</a>                           *pIntNode;
<a name="l00193"></a>00193       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a>                           *pStructure;
<a name="l00194"></a>00194       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                     sGridNo;
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 
<a name="l00197"></a>00197       <span class="comment">// Remove any previous actions</span>
<a name="l00198"></a>00198       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a>            = NO_PENDING_ACTION;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200       <span class="comment">// here is where we would set a different value if the weapon mode is on </span>
<a name="l00201"></a>00201       <span class="comment">// "attached weapon"</span>
<a name="l00202"></a>00202       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#549976333a3c89be2ca4a342235e1464">usAttackingWeapon</a> = usHandItem;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204       <span class="comment">// Find soldier flags depend on if it's our own merc firing or a NPC</span>
<a name="l00205"></a>00205   <span class="comment">//if ( FindSoldier( usGridNo, &amp;usSoldierIndex, &amp;uiMercFlags, FIND_SOLDIER_GRIDNO )  )</span>
<a name="l00206"></a>00206       <span class="keywordflow">if</span> ( ( usSoldierIndex = <a class="code" href="worldman_8cpp.html#87338f0c77765726813428fd184bfcd8">WhoIsThere2</a>( usGridNo, bLevel ) ) != NO_SOLDIER )
<a name="l00207"></a>00207       {
<a name="l00208"></a>00208             pTargetSoldier = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ usSoldierIndex ];
<a name="l00209"></a>00209 
<a name="l00210"></a>00210             <span class="keywordflow">if</span> ( fFromUI )
<a name="l00211"></a>00211             {
<a name="l00212"></a>00212                   <span class="comment">// ATE: Check if we are targeting an interactive tile, and adjust gridno accordingly...</span>
<a name="l00213"></a>00213                   pIntNode = <a class="code" href="Interactive_01Tiles_8cpp.html#f21785f68e878eb880d644f9e9a5dbc1">GetCurInteractiveTileGridNoAndStructure</a>( &amp;sGridNo, &amp;pStructure );
<a name="l00214"></a>00214 
<a name="l00215"></a>00215             <span class="keywordflow">if</span> ( pIntNode != NULL &amp;&amp; pTargetSoldier == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00216"></a>00216             { 
<a name="l00217"></a>00217                   <span class="comment">// Truncate target sioldier</span>
<a name="l00218"></a>00218                   pTargetSoldier = NULL;
<a name="l00219"></a>00219             }
<a name="l00220"></a>00220             }
<a name="l00221"></a>00221       }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223       <span class="comment">// ATE: If in realtime, set attacker count to 0...</span>
<a name="l00224"></a>00224       <span class="keywordflow">if</span> ( !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) )
<a name="l00225"></a>00225       {
<a name="l00226"></a>00226             DebugMsg( <a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>, DBG_LEVEL_3, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"Setting attack busy count to 0 due to no combat"</span> ) );
<a name="l00227"></a>00227             <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a> = 0;
<a name="l00228"></a>00228       }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230   <span class="keywordflow">if</span> ( pTargetSoldier )
<a name="l00231"></a>00231   {
<a name="l00232"></a>00232     pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#29253c5ae4099335aaf0dd68af0c5c15">bBeingAttackedCount</a> = 0;
<a name="l00233"></a>00233   }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 
<a name="l00236"></a>00236       <span class="comment">// Check our soldier's life for unconscious!</span>
<a name="l00237"></a>00237       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a> &lt; OKLIFE )
<a name="l00238"></a>00238       {
<a name="l00239"></a>00239             <span class="keywordflow">return</span>( ITEM_HANDLE_UNCONSCIOUS );
<a name="l00240"></a>00240       }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242       <span class="keywordflow">if</span> (<a class="code" href="Handle_01Items_8cpp.html#aaae8566276789f2922af5339f346c37">HandItemWorks</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a> ) == FALSE )
<a name="l00243"></a>00243       {
<a name="l00244"></a>00244             <span class="keywordflow">return</span>( ITEM_HANDLE_BROKEN );
<a name="l00245"></a>00245       }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247       <span class="keywordflow">if</span> ( fFromUI &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> &amp;&amp; pTargetSoldier &amp;&amp; (pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> || pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a>) &amp;&amp; pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> != <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a7143fbbb5aa867c244f7cf6a230545002">CROW</a> &amp;&amp; <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].<a class="code" href="structINVTYPE.html#1f63e61536407cc997a998585017ba07">usItemClass</a> != IC_MEDKIT )
<a name="l00248"></a>00248       {
<a name="l00249"></a>00249             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE  )
<a name="l00250"></a>00250             {
<a name="l00251"></a>00251                   <span class="comment">// nice mercs won't shoot other nice guys or neutral civilians</span>
<a name="l00252"></a>00252                   <span class="keywordflow">if</span> ( (<a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].ubMiscFlags3 &amp; PROFILE_MISC_FLAG3_GOODGUY) &amp;&amp; ( (pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == NO_PROFILE &amp;&amp; pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a>) || <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].ubMiscFlags3 &amp; PROFILE_MISC_FLAG3_GOODGUY) )
<a name="l00253"></a>00253                   {
<a name="l00254"></a>00254                         <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a29ca7143b702aa71a6f324d922d9238a53">QUOTE_REFUSING_ORDER</a> );
<a name="l00255"></a>00255                         <span class="keywordflow">return</span>( ITEM_HANDLE_REFUSAL );                  
<a name="l00256"></a>00256                   }
<a name="l00257"></a>00257                   <span class="keywordflow">if</span> ( pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE )
<a name="l00258"></a>00258                   {
<a name="l00259"></a>00259                         <span class="comment">// buddies won't shoot each other</span>
<a name="l00260"></a>00260                         <span class="keywordflow">if</span> ( <a class="code" href="Soldier_01Profile_8cpp.html#25cc33133d5278dbb214ddbb132322a7">WhichBuddy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>, pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ) != -1 )
<a name="l00261"></a>00261                         {
<a name="l00262"></a>00262                               <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a29ca7143b702aa71a6f324d922d9238a53">QUOTE_REFUSING_ORDER</a> );
<a name="l00263"></a>00263                               <span class="keywordflow">return</span>( ITEM_HANDLE_REFUSAL );                  
<a name="l00264"></a>00264                         }
<a name="l00265"></a>00265                   }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267                   <span class="comment">// any recruited rebel will refuse to fire on another rebel or neutral nameless civ</span>
<a name="l00268"></a>00268                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> == <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a0785241787570cc516fbde66bef1057d466c0e">REBEL_CIV_GROUP</a> &amp;&amp; (pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> == <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a0785241787570cc516fbde66bef1057d466c0e">REBEL_CIV_GROUP</a> || ( pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a> &amp;&amp; pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> == NO_PROFILE &amp;&amp; pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> == <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a078524cb5f7573455bdacd2b87a051da610c97">NON_CIV_GROUP</a> &amp;&amp; pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> != <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a7143fbbb5aa867c244f7cf6a230545002">CROW</a> ) ) )
<a name="l00269"></a>00269                   {
<a name="l00270"></a>00270                         <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a29ca7143b702aa71a6f324d922d9238a53">QUOTE_REFUSING_ORDER</a> );
<a name="l00271"></a>00271                         <span class="keywordflow">return</span>( ITEM_HANDLE_REFUSAL );
<a name="l00272"></a>00272                   }
<a name="l00273"></a>00273             }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275       }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277       <span class="comment">// Check HAND ITEM</span>
<a name="l00278"></a>00278       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].usItemClass == IC_GUN || <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].usItemClass == IC_THROWING_KNIFE )
<a name="l00279"></a>00279       {
<a name="l00280"></a>00280             <span class="comment">// WEAPONS</span>
<a name="l00281"></a>00281             DebugMsg(<a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"HandleItem: checking for fingerprintID, item id = %d,id required = %d, imprint id = %d, soldier id = %d"</span>,usHandItem,<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[usHandItem].fingerprintid,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].ubImprintID,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>));
<a name="l00282"></a>00282             <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[usHandItem].fingerprintid )
<a name="l00283"></a>00283             {
<a name="l00284"></a>00284                   <span class="comment">// check imprint ID</span>
<a name="l00285"></a>00285                   <span class="comment">// NB not-imprinted value is NO_PROFILE</span>
<a name="l00286"></a>00286                   <span class="comment">// imprinted value is profile for mercs &amp; NPCs and NO_PROFILE + 1 for generic dudes</span>
<a name="l00287"></a>00287                   <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE)
<a name="l00288"></a>00288                   {
<a name="l00289"></a>00289                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].ubImprintID != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> )
<a name="l00290"></a>00290                         {
<a name="l00291"></a>00291                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].ubImprintID == NO_PROFILE )
<a name="l00292"></a>00292                               {
<a name="l00293"></a>00293                                     <span class="comment">// first shot using "virgin" gun... set imprint ID</span>
<a name="l00294"></a>00294                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].<a class="code" href="structOBJECTTYPE.html#bbf8833330a114c5ff8d0d95e51bee92">ubImprintID</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296                                     <span class="comment">// this could be an NPC (Krott)</span>
<a name="l00297"></a>00297                                     <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a>)
<a name="l00298"></a>00298                                     {
<a name="l00299"></a>00299                                           <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5748f239e5adcc984a23a4aebdf4c17c3">RG_ID_IMPRINTED</a>, RATE_11025, HIGHVOLUME, 1, MIDDLE );    
<a name="l00300"></a>00300               
<a name="l00301"></a>00301                           <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, L<span class="stringliteral">"\"%s\""</span>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe7107d863de086a881733747bb5ff9538d">GUN_GOT_FINGERPRINT</a> ] );
<a name="l00302"></a>00302 
<a name="l00303"></a>00303                                           <span class="keywordflow">return</span>( ITEM_HANDLE_BROKEN );
<a name="l00304"></a>00304                                     }
<a name="l00305"></a>00305                               }
<a name="l00306"></a>00306                               <span class="keywordflow">else</span>
<a name="l00307"></a>00307                               {
<a name="l00308"></a>00308                                     <span class="comment">// access denied!</span>
<a name="l00309"></a>00309                                     <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a>)
<a name="l00310"></a>00310                                     {
<a name="l00311"></a>00311                                           <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5c92c0ddd5d88adf1393954dcdd7f9074">RG_ID_INVALID</a>, RATE_11025, HIGHVOLUME, 1, MIDDLE );                                    
<a name="l00312"></a>00312 
<a name="l00313"></a>00313                                           <span class="comment">//if (Random( 100 ) &lt; (UINT32) pSoldier-&gt;bWisdom)</span>
<a name="l00314"></a>00314                                           <span class="comment">//{</span>
<a name="l00315"></a>00315                                           <span class="comment">//    DoMercBattleSound( pSoldier, BATTLE_SOUND_CURSE1 );</span>
<a name="l00316"></a>00316                                           <span class="comment">//}</span>
<a name="l00317"></a>00317                                           <span class="comment">//else</span>
<a name="l00318"></a>00318                                           <span class="comment">//{</span>
<a name="l00319"></a>00319                                           <span class="comment">//    TacticalCharacterDialogue( pSoldier, QUOTE_USELESS_ITEM );</span>
<a name="l00320"></a>00320                                           <span class="comment">//}</span>
<a name="l00321"></a>00321                                     }
<a name="l00322"></a>00322                                     <span class="keywordflow">return</span>( ITEM_HANDLE_BROKEN );
<a name="l00323"></a>00323                               }
<a name="l00324"></a>00324                         }
<a name="l00325"></a>00325                   }
<a name="l00326"></a>00326                   <span class="keywordflow">else</span>
<a name="l00327"></a>00327                   {
<a name="l00328"></a>00328                         <span class="comment">// guaranteed not to be controlled by the player, so no feedback required</span>
<a name="l00329"></a>00329                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].ubImprintID != (NO_PROFILE + 1) )
<a name="l00330"></a>00330                         {
<a name="l00331"></a>00331                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].ubImprintID == NO_PROFILE )
<a name="l00332"></a>00332                               {
<a name="l00333"></a>00333                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].<a class="code" href="structOBJECTTYPE.html#bbf8833330a114c5ff8d0d95e51bee92">ubImprintID</a> = (NO_PROFILE + 1);
<a name="l00334"></a>00334                               }
<a name="l00335"></a>00335                               <span class="keywordflow">else</span>
<a name="l00336"></a>00336                               {
<a name="l00337"></a>00337                                     <span class="keywordflow">return</span>( ITEM_HANDLE_BROKEN );
<a name="l00338"></a>00338                               }
<a name="l00339"></a>00339                         }
<a name="l00340"></a>00340                   }
<a name="l00341"></a>00341             }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343             <span class="comment">// IF we are not a throwing knife, check for ammo, reloading...</span>
<a name="l00344"></a>00344             <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].usItemClass != IC_THROWING_KNIFE )
<a name="l00345"></a>00345             {
<a name="l00346"></a>00346                   <span class="comment">// CHECK FOR AMMO!</span>
<a name="l00347"></a>00347                   <span class="keywordflow">if</span> ( !<a class="code" href="Points_8cpp.html#79e23528fb3285ccdcfd217080729048">EnoughAmmo</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, fFromUI, <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a> ) )
<a name="l00348"></a>00348                   {
<a name="l00349"></a>00349                         <span class="comment">//ATE: Reflect that we need to reset for bursting</span>
<a name="l00350"></a>00350                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#714dea2b644824d24476fa0f947ca452">fDoSpread</a> = FALSE;
<a name="l00351"></a>00351                         <span class="keywordflow">return</span>( ITEM_HANDLE_NOAMMO );
<a name="l00352"></a>00352                   }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354                   <span class="comment">// Check if we are reloading</span>
<a name="l00355"></a>00355                   <span class="keywordflow">if</span> ( (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; REALTIME) || !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) )
<a name="l00356"></a>00356                   {
<a name="l00357"></a>00357                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e1185996e8104ed077284c28f9595c3b">fReloading</a> )
<a name="l00358"></a>00358                         {
<a name="l00359"></a>00359                               <span class="keywordflow">return</span>( ITEM_HANDLE_RELOADING );
<a name="l00360"></a>00360                         }
<a name="l00361"></a>00361                   }
<a name="l00362"></a>00362             }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364             <span class="comment">// Get gridno - either soldier's position or the gridno</span>
<a name="l00365"></a>00365             <span class="keywordflow">if</span> ( pTargetSoldier != NULL )
<a name="l00366"></a>00366             {
<a name="l00367"></a>00367                   sTargetGridNo     = pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l00368"></a>00368             }
<a name="l00369"></a>00369             <span class="keywordflow">else</span>
<a name="l00370"></a>00370             {
<a name="l00371"></a>00371                   sTargetGridNo     = usGridNo;
<a name="l00372"></a>00372             }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374             <span class="comment">// If it's a player guy, check ChanceToGetThrough to play quote</span>
<a name="l00375"></a>00375             <span class="keywordflow">if</span> ( fFromUI &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; TURNBASED ) &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) )
<a name="l00376"></a>00376             {
<a name="l00377"></a>00377                   <span class="comment">// Don't do if no spread!</span>
<a name="l00378"></a>00378                   <span class="keywordflow">if</span> ( !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#714dea2b644824d24476fa0f947ca452">fDoSpread</a> )
<a name="l00379"></a>00379                   {
<a name="l00380"></a>00380                         <span class="keywordflow">if</span> ( !<a class="code" href="Handle_01Items_8cpp.html#d82ed66e3fd8a0a804c3b57d12bb5727">HandleCheckForBadChangeToGetThrough</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, pTargetSoldier, sTargetGridNo , bLevel ) )
<a name="l00381"></a>00381                         {
<a name="l00382"></a>00382                               <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l00383"></a>00383                         }
<a name="l00384"></a>00384                   }
<a name="l00385"></a>00385             }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 
<a name="l00388"></a>00388             <span class="comment">// Get AP COSTS</span>
<a name="l00389"></a>00389             <span class="comment">// ATE: OK something funny going on here - AI seems to NEED FALSE here,</span>
<a name="l00390"></a>00390             <span class="comment">// Our guys NEED TRUE. We shoulkd at some time make sure the AI and</span>
<a name="l00391"></a>00391             <span class="comment">// our guys are deducting/checking in the same manner to avoid</span>
<a name="l00392"></a>00392             <span class="comment">// these differences.</span>
<a name="l00393"></a>00393             sAPCost = <a class="code" href="Points_8cpp.html#0f8c5c45aa1476d851d7e0c242910908">CalcTotalAPsToAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo, TRUE, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f4d35b19eed93ae72b4bb54c4e6e8a3e">bAimTime</a> );
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 
<a name="l00396"></a>00396             <a class="code" href="Points_8cpp.html#3b12531a2257bc86bdf10fbcb505dbe9">GetAPChargeForShootOrStabWRTGunRaises</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo, TRUE, &amp;fAddingTurningCost, &amp;fAddingRaiseGunCost );
<a name="l00397"></a>00397 
<a name="l00398"></a>00398             <span class="comment">// If we are standing and are asked to turn AND raise gun, ignore raise gun...</span>
<a name="l00399"></a>00399             <span class="keywordflow">if</span> ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubHeight == ANIM_STAND )
<a name="l00400"></a>00400             {
<a name="l00401"></a>00401                   <span class="keywordflow">if</span> ( fAddingRaiseGunCost )
<a name="l00402"></a>00402                   {
<a name="l00403"></a>00403                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f310b1894267fcf2b8ca3cb929119439">fDontChargeTurningAPs</a> = TRUE;
<a name="l00404"></a>00404                   }
<a name="l00405"></a>00405             }
<a name="l00406"></a>00406             <span class="comment">/*else</span>
<a name="l00407"></a>00407 <span class="comment">            {</span>
<a name="l00408"></a>00408 <span class="comment">                  // If raising gun, don't charge turning!</span>
<a name="l00409"></a>00409 <span class="comment">              if ( fAddingTurningCost )</span>
<a name="l00410"></a>00410 <span class="comment">                  {</span>
<a name="l00411"></a>00411 <span class="comment">                        pSoldier-&gt;fDontChargeReadyAPs = TRUE;</span>
<a name="l00412"></a>00412 <span class="comment">                  }</span>
<a name="l00413"></a>00413 <span class="comment">            }*/</span>
<a name="l00414"></a>00414 
<a name="l00415"></a>00415       
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 
<a name="l00418"></a>00418             <span class="comment">// If this is a player guy, show message about no APS</span>
<a name="l00419"></a>00419             <span class="keywordflow">if</span> ( <a class="code" href="Points_8cpp.html#da12609dfc7e36a16ae6065e1c340929">EnoughPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0, fFromUI ) )
<a name="l00420"></a>00420             {
<a name="l00421"></a>00421                   <span class="keywordflow">if</span> ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE) &amp;&amp; (<a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].bPersonalityTrait == <a class="code" href="soldier_01profile_01type_8h.html#38fdbff4df855b330b943d47a9ade08c82607df43ad8170e18d704425e78bcc3">PSYCHO</a>) )
<a name="l00422"></a>00422                   {
<a name="l00423"></a>00423                         <span class="comment">// psychos might possibly switch to burst if they can</span>
<a name="l00424"></a>00424                         <span class="keywordflow">if</span> ( !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#dd307dffd553de4a1e01f74c050e6e07">bDoBurst</a> &amp;&amp; <a class="code" href="Weapons_8cpp.html#127b65951598cb6031a8a2862d654bf9">IsGunBurstCapable</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>, FALSE ) )
<a name="l00425"></a>00425                         {
<a name="l00426"></a>00426                               <span class="comment">// chance of firing burst if we have points... chance decreasing when ordered to do aimed shot</span>
<a name="l00427"></a>00427 
<a name="l00428"></a>00428                               <span class="comment">// temporarily set burst to true to calculate action points</span>
<a name="l00429"></a>00429                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#dd307dffd553de4a1e01f74c050e6e07">bDoBurst</a> = TRUE;
<a name="l00430"></a>00430                               sAPCost = <a class="code" href="Points_8cpp.html#0f8c5c45aa1476d851d7e0c242910908">CalcTotalAPsToAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo, TRUE, 0 );
<a name="l00431"></a>00431                               <span class="comment">// reset burst mode to false (which is what it was at originally)</span>
<a name="l00432"></a>00432                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#dd307dffd553de4a1e01f74c050e6e07">bDoBurst</a> = FALSE;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434                               <span class="keywordflow">if</span> ( <a class="code" href="Points_8cpp.html#da12609dfc7e36a16ae6065e1c340929">EnoughPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0, FALSE ) )
<a name="l00435"></a>00435                               {
<a name="l00436"></a>00436                                     <span class="comment">// we have enough points to do this burst, roll the dice and see if we want to change</span>
<a name="l00437"></a>00437                                     <span class="keywordflow">if</span> ( <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 3 + <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f4d35b19eed93ae72b4bb54c4e6e8a3e">bAimTime</a> ) == 0 )
<a name="l00438"></a>00438                                     {
<a name="l00439"></a>00439                                           <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0a4a851f6cd9cfa3b2b9616270692f1340">BATTLE_SOUND_LAUGH1</a> );
<a name="l00440"></a>00440                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#dd307dffd553de4a1e01f74c050e6e07">bDoBurst</a> = TRUE;
<a name="l00441"></a>00441                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#363d85a2e4c2405db5046904d1d4549d">bWeaponMode</a> = <a class="code" href="Soldier_01Control_8h.html#db461b7936f2fc5849c8168828b69c4c9f3b8343775332c34152385fe4c4edd7">WM_BURST</a>;
<a name="l00442"></a>00442                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a> = 0;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444                                     <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#c5c7f48843bbaeab7848215f323578c9">gzLateLocalizedString</a>[ 26 ], <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a> );        
<a name="l00445"></a>00445                                     }
<a name="l00446"></a>00446                               }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448                         }
<a name="l00449"></a>00449                   }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451                   <span class="keywordflow">if</span>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a> &amp;&amp; ((<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; TURNBASED))) <span class="comment">//this is the code that introduces uncertainty into full-auto bursts</span>
<a name="l00452"></a>00452                   {
<a name="l00453"></a>00453                         DebugMsg(TOPIC_JA2,DBG_LEVEL_3,<a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"HandleItem: auto fire - setting dice sides, marksmanship = %d"</span>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7a9a17a9aff519efd7423c6b11cdb046">bMarksmanship</a>));
<a name="l00454"></a>00454                         <span class="comment">//UINT32 diceSides = RAND_MAX;</span>
<a name="l00455"></a>00455                         <span class="comment">//Madd: tried to make this more marksmanship dependent than agility, a level 10 auto-weapons specialist with 100 in all stats was wasting wayyy too many APs on this fucker</span>
<a name="l00456"></a>00456                         <span class="comment">//UINT32 diceSides = RAND_MAX / ( max(1,pSoldier-&gt;bMarksmanship) / 10) ;</span>
<a name="l00457"></a>00457                   
<a name="l00458"></a>00458                         <span class="comment">//Kaiden: Had to change the minimum value to 10 instead of 1, </span>
<a name="l00459"></a>00459                         <span class="comment">//Rounding down resulted in division by zero and caused a crash.</span>
<a name="l00460"></a>00460                         <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> diceSides = RAND_MAX / ( max(10,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7a9a17a9aff519efd7423c6b11cdb046">bMarksmanship</a>) / 10) ;
<a name="l00461"></a>00461                         
<a name="l00462"></a>00462                         <a class="code" href="Types_8h.html#eb90fd78c942591ef3a935cf98baf4f8">DOUBLE</a> avgAPadded = max(((400.0f-2.0f*<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9e00ffce9fab366b226d73f77609c2f4">bAgility</a>))*(63.0f-5.0f*(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0becb3b2a6e15a9c7d60749a341aef38">bExpLevel</a>+2.0f*NUM_SKILL_TRAITS( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="soldier_01profile_01type_8h.html#88183a1fc58897e3edb65b354323264b97eb9509ad5c3326f089496bfaf514e9">AUTO_WEAPS</a> )))/2700.0f,1); <span class="comment">//Important! don't make this zero, the formulae don't like it.</span>
<a name="l00463"></a>00463                         <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> chanceToMisfire = (<a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)(((<a class="code" href="Types_8h.html#eb90fd78c942591ef3a935cf98baf4f8">DOUBLE</a>)diceSides*(2.0f*avgAPadded+1.0f-sqrt(4.0f*avgAPadded+1.0f)))/(2.0f*avgAPadded)); <span class="comment">//derive the chace to misfire from the desired average AP overspent, derived suing</span>
<a name="l00464"></a>00464                         <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> chanceToMisfireDry = (<a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)(((<a class="code" href="Types_8h.html#eb90fd78c942591ef3a935cf98baf4f8">DOUBLE</a>)diceSides*(avgAPadded+1.0f-sqrt(2.0f*avgAPadded+1.0f)))/(avgAPadded)); <span class="comment">//chance to misfire if weapon is dry.  Designed to waste avgAPadded/2 APs</span>
<a name="l00465"></a>00465                         <span class="comment">//soldiers get better at controlling bursts with levels, and reflex time (agility)</span>
<a name="l00466"></a>00466                         <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> misfirePenaltyConst = (<a class="code" href="Weapons_8cpp.html#6c24dc0d8b2495f69dd47e85000bafa1">GetAutofireShotsPerFiveAPs</a>(&amp;<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>]))/5;
<a name="l00467"></a>00467                         <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> misfirePenaltyRand = ((<a class="code" href="Weapons_8cpp.html#6c24dc0d8b2495f69dd47e85000bafa1">GetAutofireShotsPerFiveAPs</a>(&amp;<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>]))%5)*20; <span class="comment">//this is the remainder translated to a probability</span>
<a name="l00468"></a>00468                         <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> misfirePenalty;
<a name="l00469"></a>00469                         <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> startAuto = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a>;
<a name="l00470"></a>00470                         <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> startAPcost = <a class="code" href="Points_8cpp.html#0f8c5c45aa1476d851d7e0c242910908">CalcTotalAPsToAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo, TRUE, 0 );
<a name="l00471"></a>00471                         <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> roll;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473                         <span class="keywordflow">if</span>((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE) &amp;&amp; (<a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].bPersonalityTrait == <a class="code" href="soldier_01profile_01type_8h.html#38fdbff4df855b330b943d47a9ade08c82607df43ad8170e18d704425e78bcc3">PSYCHO</a>) &amp;&amp; <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>(100) &lt; 20)
<a name="l00474"></a>00474                         {
<a name="l00475"></a>00475                               chanceToMisfire = diceSides;
<a name="l00476"></a>00476                         <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#c5c7f48843bbaeab7848215f323578c9">gzLateLocalizedString</a>[ 26 ], <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a> );                    
<a name="l00477"></a>00477                         }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479                         chanceToMisfire = __min(diceSides-1, chanceToMisfire); <span class="comment">//cap the misfire chance, no-one has reflexes this bad</span>
<a name="l00480"></a>00480                         chanceToMisfire = __max(1, chanceToMisfire); <span class="comment">//cap the misfire chance, no-one has reflexes this good</span>
<a name="l00481"></a>00481 
<a name="l00482"></a>00482                         chanceToMisfireDry = __min(diceSides-1, chanceToMisfireDry); <span class="comment">//cap the misfire chance, no-one has reflexes this bad</span>
<a name="l00483"></a>00483                         chanceToMisfireDry = __max(1, chanceToMisfireDry); <span class="comment">//cap the misfire chance, no-one has reflexes this good</span>
<a name="l00484"></a>00484 
<a name="l00485"></a>00485                         <span class="comment">//roll dice for each AP to see if we failed to stop firing</span>
<a name="l00486"></a>00486                         <span class="keywordflow">do</span>
<a name="l00487"></a>00487                         {
<a name="l00488"></a>00488                               DebugMsg(TOPIC_JA2,DBG_LEVEL_3,<span class="stringliteral">"HandleItem: auto fire - Rolling dice"</span>);
<a name="l00489"></a>00489                               roll = <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>(diceSides);
<a name="l00490"></a>00490                               <span class="comment">//roll = rand();//Random(diceSides);</span>
<a name="l00491"></a>00491                               <span class="comment">//ScreenMsg( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, L"Rolled %d vs %d", roll, ((pSoldier-&gt;inv[ pSoldier-&gt;ubAttackingHand ].ubGunShotsLeft &gt;= pSoldier-&gt;bDoAutofire)?chanceToMisfire:chanceToMisfireDry));</span>
<a name="l00492"></a>00492 
<a name="l00493"></a>00493                               misfirePenalty = misfirePenaltyConst + (<a class="code" href="Random_8cpp.html#742221657b584d8416ada22fa8ff23dd">Chance</a>(misfirePenaltyRand)?1:0); <span class="comment">//apply the base integral cost and the fractional cost (in the form of probablilite)</span>
<a name="l00494"></a>00494 
<a name="l00495"></a>00495                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a> += misfirePenalty;
<a name="l00496"></a>00496                               sAPCost = <a class="code" href="Points_8cpp.html#0f8c5c45aa1476d851d7e0c242910908">CalcTotalAPsToAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo, TRUE, 0 );
<a name="l00497"></a>00497                         }
<a name="l00498"></a>00498                         <span class="keywordflow">while</span>(<a class="code" href="Points_8cpp.html#da12609dfc7e36a16ae6065e1c340929">EnoughPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0, FALSE ) &amp;&amp; roll &lt; ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].ubGunShotsLeft &gt;= <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a>)?chanceToMisfire:chanceToMisfireDry));
<a name="l00499"></a>00499                         <span class="comment">//note that we could misfire more bullets than we have rounds</span>
<a name="l00500"></a>00500                         <span class="comment">//this represents the soldier running out of ammo and not noticing</span>
<a name="l00501"></a>00501                         <span class="comment">//the max that can be lost this way is 1AP</span>
<a name="l00502"></a>00502                         
<a name="l00503"></a>00503                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a> -= misfirePenalty;
<a name="l00504"></a>00504                         sAPCost = <a class="code" href="Points_8cpp.html#0f8c5c45aa1476d851d7e0c242910908">CalcTotalAPsToAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo, TRUE, 0 );
<a name="l00505"></a>00505 
<a name="l00506"></a>00506                         <span class="keywordflow">if</span>((__min(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].ubGunShotsLeft) - startAuto) &gt; 0 &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == OUR_TEAM)
<a name="l00507"></a>00507                               <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#c5c7f48843bbaeab7848215f323578c9">gzLateLocalizedString</a>[ 62 ], <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>, __min(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b77b23ae10e38a30c4a586d26882545b">bDoAutofire</a>,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].ubGunShotsLeft) - startAuto );
<a name="l00508"></a>00508                         
<a name="l00509"></a>00509                   
<a name="l00510"></a>00510                         <span class="comment">//ScreenMsg( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, L"Chance:%d.%d, AvgAps=%f, APs=%d", chanceToMisfire/(diceSides/100),chanceToMisfire%(diceSides/100), avgAPadded,sAPCost-startAPcost);</span>
<a name="l00511"></a>00511 
<a name="l00512"></a>00512                   }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514                   <span class="comment">// Deduct points if our target is different!</span>
<a name="l00515"></a>00515                   <span class="comment">// if attacking a new target (or if the specific target is uncertain)</span>
<a name="l00516"></a>00516       
<a name="l00517"></a>00517             <span class="comment">// DEF:  Made into an event</span>
<a name="l00518"></a>00518 <span class="comment">//          EVENT_FireSoldierWeapon( pSoldier, sTargetGridNo );</span>
<a name="l00519"></a>00519                   <span class="keywordflow">if</span> (fFromUI)
<a name="l00520"></a>00520                   {
<a name="l00521"></a>00521                         <span class="comment">// set the target level; if the AI calls this it will have set the level already...</span>
<a name="l00522"></a>00522                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e29f2821a7f319ffe6405848dabb4c6b">bTargetLevel</a> = (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) <a class="code" href="Interface_8cpp.html#df8b6e6a517d072540efbabfca5ac189">gsInterfaceLevel</a>;
<a name="l00523"></a>00523                   }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525                   <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].usItemClass != IC_THROWING_KNIFE )
<a name="l00526"></a>00526                   {
<a name="l00527"></a>00527                         <span class="comment">// If doing spread, set down the first gridno.....</span>
<a name="l00528"></a>00528                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#714dea2b644824d24476fa0f947ca452">fDoSpread</a> )
<a name="l00529"></a>00529                         {
<a name="l00530"></a>00530                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf1c54b630b9b5588f6189ca5628271">sSpreadLocations</a>[ 0 ] != 0 )
<a name="l00531"></a>00531                               {
<a name="l00532"></a>00532                                     <a class="code" href="Soldier_01Control_8cpp.html#455a5c933e0016bda8096f0cc2d03115">SendBeginFireWeaponEvent</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf1c54b630b9b5588f6189ca5628271">sSpreadLocations</a>[ 0 ] );                          
<a name="l00533"></a>00533                               }
<a name="l00534"></a>00534                               <span class="keywordflow">else</span>
<a name="l00535"></a>00535                               {
<a name="l00536"></a>00536                                     <a class="code" href="Soldier_01Control_8cpp.html#455a5c933e0016bda8096f0cc2d03115">SendBeginFireWeaponEvent</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo );
<a name="l00537"></a>00537                               }
<a name="l00538"></a>00538                         }
<a name="l00539"></a>00539                         <span class="keywordflow">else</span>
<a name="l00540"></a>00540                         {
<a name="l00541"></a>00541                               <a class="code" href="Soldier_01Control_8cpp.html#455a5c933e0016bda8096f0cc2d03115">SendBeginFireWeaponEvent</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo );
<a name="l00542"></a>00542                         }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544                         <span class="comment">// ATE: Here to make cursor go back to move after LAW shot...</span>
<a name="l00545"></a>00545                         <span class="keywordflow">if</span> ( fFromUI &amp;&amp; <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[usHandItem].singleshotrocketlauncher)
<a name="l00546"></a>00546                         {
<a name="l00547"></a>00547                               <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e270ea91b11a2d193de66745f02c4a329">A_CHANGE_TO_MOVE</a>;
<a name="l00548"></a>00548                         }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550                   }
<a name="l00551"></a>00551                   <span class="keywordflow">else</span>
<a name="l00552"></a>00552                   {
<a name="l00553"></a>00553                         <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubDirection;
<a name="l00554"></a>00554                         <span class="comment">// Start knife throw attack</span>
<a name="l00555"></a>00555 
<a name="l00556"></a>00556                         <span class="comment">// Get direction</span>
<a name="l00557"></a>00557                         ubDirection = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="Soldier_01Control_8cpp.html#1d7b6c103ede7e551e76eef2ef173f9b">GetDirectionFromGridNo</a>( sTargetGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00558"></a>00558 
<a name="l00559"></a>00559                         <a class="code" href="Soldier_01Control_8cpp.html#f234588a2e32f02cf9eccd340620f0f1">EVENT_SoldierBeginKnifeThrowAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo, ubDirection );
<a name="l00560"></a>00560 
<a name="l00561"></a>00561                   }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563                   <span class="keywordflow">if</span> (fFromUI)
<a name="l00564"></a>00564                   {
<a name="l00565"></a>00565                         <span class="comment">// Descrease aim by two if in real time</span>
<a name="l00566"></a>00566                         <span class="keywordflow">if</span> ( (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; REALTIME ) || !(<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) )
<a name="l00567"></a>00567                         {
<a name="l00568"></a>00568                                <span class="comment">//pSoldier-&gt;bShownAimTime -= 2;</span>
<a name="l00569"></a>00569                                <span class="comment">//if ( pSoldier-&gt;bShownAimTime &lt; REFINE_AIM_1 )</span>
<a name="l00570"></a>00570                                <span class="comment">//{</span>
<a name="l00571"></a>00571                               <span class="comment">//          pSoldier-&gt;bShownAimTime = REFINE_AIM_1;</span>
<a name="l00572"></a>00572                                <span class="comment">//}</span>
<a name="l00573"></a>00573                                <span class="comment">//pSoldier-&gt;fPauseAim = TRUE;</span>
<a name="l00574"></a>00574                         }
<a name="l00575"></a>00575 
<a name="l00576"></a>00576                         <span class="comment">// If in turn based - refresh aim to first level</span>
<a name="l00577"></a>00577                         <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; TURNBASED &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; INCOMBAT) )
<a name="l00578"></a>00578                         {
<a name="l00579"></a>00579                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1b268d86e699d03be1c56bbf22c6d029">bShownAimTime</a> = REFINE_AIM_1;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581                               <span class="comment">// Locate to soldier if he's about to shoot!</span>
<a name="l00582"></a>00582                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a>  )
<a name="l00583"></a>00583                               {
<a name="l00584"></a>00584                                     <a class="code" href="Interface_01Panels_8cpp.html#ef4a881dd9595560f85f14a061648f0b">ShowRadioLocator</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>, SHOW_LOCATOR_NORMAL );
<a name="l00585"></a>00585                               }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587                         }
<a name="l00588"></a>00588                   }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590                   <span class="comment">// OK, set UI</span>
<a name="l00591"></a>00591                   <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l00592"></a>00592             }
<a name="l00593"></a>00593             <span class="keywordflow">else</span>
<a name="l00594"></a>00594             {
<a name="l00595"></a>00595                   <span class="keywordflow">return</span>( ITEM_HANDLE_NOAPS );
<a name="l00596"></a>00596             }
<a name="l00597"></a>00597 
<a name="l00598"></a>00598             <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l00599"></a>00599       }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601 
<a name="l00602"></a>00602       <span class="comment">//TRY PUNCHING</span>
<a name="l00603"></a>00603       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].usItemClass == IC_PUNCH )
<a name="l00604"></a>00604       {
<a name="l00605"></a>00605              <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>      sCnt;
<a name="l00606"></a>00606              <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>      sSpot;      
<a name="l00607"></a>00607              <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>            ubGuyThere;
<a name="l00608"></a>00608              <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>            sGotLocation = NOWHERE;
<a name="l00609"></a>00609              <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>    fGotAdjacent = FALSE;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611              <span class="keywordflow">for</span> ( sCnt = 0; sCnt &lt; <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b705a523f21006762cabafc28b9f36a34d">NUM_WORLD_DIRECTIONS</a>; sCnt++ )
<a name="l00612"></a>00612              {
<a name="l00613"></a>00613                         sSpot = <a class="code" href="Isometric_01Utils_8cpp.html#318d8410127e29bb232ab70363bc316e">NewGridNo</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( sCnt ) );
<a name="l00614"></a>00614 
<a name="l00615"></a>00615         <span class="comment">// Make sure movement costs are OK....</span>
<a name="l00616"></a>00616         <span class="keywordflow">if</span> ( <a class="code" href="worlddef_8cpp.html#4dc0cb4bdda24d948e2aa986389414aa">gubWorldMovementCosts</a>[ sSpot ][ sCnt ][ bLevel ] &gt;= TRAVELCOST_BLOCKED )
<a name="l00617"></a>00617         {
<a name="l00618"></a>00618           <span class="keywordflow">continue</span>;
<a name="l00619"></a>00619         }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621                         <span class="comment">// Check for who is there...</span>
<a name="l00622"></a>00622                         ubGuyThere = <a class="code" href="worldman_8cpp.html#87338f0c77765726813428fd184bfcd8">WhoIsThere2</a>( sSpot, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l00623"></a>00623 
<a name="l00624"></a>00624                         <span class="keywordflow">if</span> ( pTargetSoldier != NULL &amp;&amp; ubGuyThere == pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> )
<a name="l00625"></a>00625                         {
<a name="l00626"></a>00626                               <span class="comment">// We've got a guy here....</span>
<a name="l00627"></a>00627                               <span class="comment">// Who is the one we want......</span>
<a name="l00628"></a>00628                               sGotLocation = sSpot;
<a name="l00629"></a>00629                               sAdjustedGridNo   = pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l00630"></a>00630                               ubDirection       = ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )sCnt;
<a name="l00631"></a>00631                               <span class="keywordflow">break</span>;
<a name="l00632"></a>00632                         }
<a name="l00633"></a>00633              }
<a name="l00634"></a>00634 
<a name="l00635"></a>00635              <span class="keywordflow">if</span> ( sGotLocation == NOWHERE )
<a name="l00636"></a>00636              {
<a name="l00637"></a>00637                    <span class="comment">// See if we can get there to punch      </span>
<a name="l00638"></a>00638                    sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );
<a name="l00639"></a>00639                    <span class="keywordflow">if</span> ( sActionGridNo != -1 )
<a name="l00640"></a>00640                    {
<a name="l00641"></a>00641                               <span class="comment">// OK, we've got somebody...</span>
<a name="l00642"></a>00642                               sGotLocation = sActionGridNo;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644                               fGotAdjacent = TRUE;
<a name="l00645"></a>00645                    }
<a name="l00646"></a>00646              }
<a name="l00647"></a>00647                   
<a name="l00648"></a>00648              <span class="comment">// Did we get a loaction?</span>
<a name="l00649"></a>00649              <span class="keywordflow">if</span> ( sGotLocation != NOWHERE )
<a name="l00650"></a>00650              {
<a name="l00651"></a>00651                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#97fff971b8c532135f0c0451deac7aa1">sTargetGridNo</a> = usGridNo;
<a name="l00652"></a>00652 
<a name="l00653"></a>00653                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a>  = usGridNo;
<a name="l00654"></a>00654                         <span class="comment">// CHECK IF WE ARE AT THIS GRIDNO NOW</span>
<a name="l00655"></a>00655                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != sGotLocation &amp;&amp; fGotAdjacent )
<a name="l00656"></a>00656                         {
<a name="l00657"></a>00657                               <span class="comment">// SEND PENDING ACTION</span>
<a name="l00658"></a>00658                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a> = <a class="code" href="Soldier_01Control_8h.html#72e63dc1307b88cc08ad0bd6c737d748c4a9da85cf4c0e0a9cf6cff9e5389547">MERC_PUNCH</a>;
<a name="l00659"></a>00659                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = sAdjustedGridNo;
<a name="l00660"></a>00660                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>  = ubDirection;
<a name="l00661"></a>00661                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c5862a2a33a904c612ca884a799ac0c2">ubPendingActionAnimCount</a> = 0;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663                               <span class="comment">// WALK UP TO DEST FIRST</span>
<a name="l00664"></a>00664                               <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sGotLocation, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, FALSE, TRUE );
<a name="l00665"></a>00665                         }
<a name="l00666"></a>00666                         <span class="keywordflow">else</span>
<a name="l00667"></a>00667                         {     
<a name="l00668"></a>00668                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b7169eb6a928d5fcf0e201335ea935b1a">AI_ACTION_KNIFE_STAB</a>;
<a name="l00669"></a>00669                               <a class="code" href="Soldier_01Control_8cpp.html#ed2a14d25dc304979c854c394410655e">EVENT_SoldierBeginPunchAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAdjustedGridNo, ubDirection );
<a name="l00670"></a>00670                         }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672                         <span class="comment">// OK, set UI</span>
<a name="l00673"></a>00673                         <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l00674"></a>00674 
<a name="l00675"></a>00675                         <a class="code" href="Handle_01Items_8cpp.html#0d67a1e997a3d54c71a0127ef4963a92">gfResetUIMovementOptimization</a> = TRUE;
<a name="l00676"></a>00676 
<a name="l00677"></a>00677                         <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l00678"></a>00678              }
<a name="l00679"></a>00679              <span class="keywordflow">else</span>
<a name="l00680"></a>00680              {
<a name="l00681"></a>00681                         <span class="keywordflow">return</span>( ITEM_HANDLE_CANNOT_GETTO_LOCATION );
<a name="l00682"></a>00682              }
<a name="l00683"></a>00683       }
<a name="l00684"></a>00684 
<a name="l00685"></a>00685       <span class="comment">//USING THE MEDKIT</span>
<a name="l00686"></a>00686       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].usItemClass == IC_MEDKIT )
<a name="l00687"></a>00687       {     
<a name="l00688"></a>00688             <span class="comment">// ATE: AI CANNOT GO THROUGH HERE!</span>
<a name="l00689"></a>00689             <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> usMapPos;
<a name="l00690"></a>00690             <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>     fHadToUseCursorPos = FALSE;
<a name="l00691"></a>00691 
<a name="l00692"></a>00692             <span class="keywordflow">if</span> (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#1aa7fa93044da366b9072c35e0a9b297">fAutoBandageMode</a>)
<a name="l00693"></a>00693             {
<a name="l00694"></a>00694                   usMapPos = usGridNo;
<a name="l00695"></a>00695             }
<a name="l00696"></a>00696             <span class="keywordflow">else</span>
<a name="l00697"></a>00697             {
<a name="l00698"></a>00698                   <a class="code" href="Isometric_01Utils_8cpp.html#fd96ad4f2a2c6316e7de4d9640c84230">GetMouseMapPos</a>( &amp;usMapPos );
<a name="l00699"></a>00699             }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701              <span class="comment">// See if we can get there to stab </span>
<a name="l00702"></a>00702              sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );
<a name="l00703"></a>00703              <span class="keywordflow">if</span> ( sActionGridNo == -1 )
<a name="l00704"></a>00704              {
<a name="l00705"></a>00705                    <span class="comment">// Try another location...</span>
<a name="l00706"></a>00706                    sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usMapPos, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );
<a name="l00707"></a>00707 
<a name="l00708"></a>00708                    <span class="keywordflow">if</span> ( sActionGridNo == -1 )
<a name="l00709"></a>00709                    {
<a name="l00710"></a>00710                               <span class="keywordflow">return</span>( ITEM_HANDLE_CANNOT_GETTO_LOCATION );
<a name="l00711"></a>00711                    }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713                    <span class="keywordflow">if</span> ( !<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#1aa7fa93044da366b9072c35e0a9b297">fAutoBandageMode</a> )
<a name="l00714"></a>00714                    {
<a name="l00715"></a>00715                               fHadToUseCursorPos = TRUE;
<a name="l00716"></a>00716                    }
<a name="l00717"></a>00717              }
<a name="l00718"></a>00718 
<a name="l00719"></a>00719              <span class="comment">// Calculate AP costs...</span>
<a name="l00720"></a>00720              sAPCost = <a class="code" href="Points_8cpp.html#6612ec289b0cba2c3af711e73e5235a5">GetAPsToBeginFirstAid</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00721"></a>00721              sAPCost += <a class="code" href="PATHAI_8cpp.html#21b55ed2d493e5333f2236ada229ac7f">PlotPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, NO_COPYROUTE, FALSE, TEMPORARY, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, NOT_STEALTH, FORWARD, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>);
<a name="l00722"></a>00722 
<a name="l00723"></a>00723                   <span class="keywordflow">if</span> ( <a class="code" href="Points_8cpp.html#da12609dfc7e36a16ae6065e1c340929">EnoughPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0, fFromUI ) )
<a name="l00724"></a>00724                   {
<a name="l00725"></a>00725                         <span class="comment">// OK, set UI</span>
<a name="l00726"></a>00726                         <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l00727"></a>00727 
<a name="l00728"></a>00728                         <span class="comment">// CHECK IF WE ARE AT THIS GRIDNO NOW</span>
<a name="l00729"></a>00729                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != sActionGridNo )
<a name="l00730"></a>00730                         {
<a name="l00731"></a>00731                               <span class="comment">// SEND PENDING ACTION</span>
<a name="l00732"></a>00732                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a> = <a class="code" href="Soldier_01Control_8h.html#72e63dc1307b88cc08ad0bd6c737d7489651cf31c48193bc3b544276ed07a768">MERC_GIVEAID</a>;
<a name="l00733"></a>00733 
<a name="l00734"></a>00734                               <span class="keywordflow">if</span> ( fHadToUseCursorPos )
<a name="l00735"></a>00735                               {
<a name="l00736"></a>00736                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = usMapPos;
<a name="l00737"></a>00737                               }
<a name="l00738"></a>00738                               <span class="keywordflow">else</span>
<a name="l00739"></a>00739                               {
<a name="l00740"></a>00740                                     <span class="keywordflow">if</span> ( pTargetSoldier != NULL )
<a name="l00741"></a>00741                                     {
<a name="l00742"></a>00742                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l00743"></a>00743                                     }
<a name="l00744"></a>00744                                     <span class="keywordflow">else</span>
<a name="l00745"></a>00745                                     {
<a name="l00746"></a>00746                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = usGridNo;
<a name="l00747"></a>00747                                     }
<a name="l00748"></a>00748                               }
<a name="l00749"></a>00749                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>  = ubDirection;
<a name="l00750"></a>00750                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c5862a2a33a904c612ca884a799ac0c2">ubPendingActionAnimCount</a> = 0;
<a name="l00751"></a>00751 
<a name="l00752"></a>00752                               <span class="comment">// WALK UP TO DEST FIRST</span>
<a name="l00753"></a>00753                               <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, FALSE, TRUE );
<a name="l00754"></a>00754                         }
<a name="l00755"></a>00755                         <span class="keywordflow">else</span>
<a name="l00756"></a>00756                         {
<a name="l00757"></a>00757                               <a class="code" href="Soldier_01Control_8cpp.html#28572d1963d4d9384b351911034dea73">EVENT_SoldierBeginFirstAid</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAdjustedGridNo, ubDirection );
<a name="l00758"></a>00758                         }
<a name="l00759"></a>00759 
<a name="l00760"></a>00760                         <span class="keywordflow">if</span> ( fFromUI )
<a name="l00761"></a>00761                         {
<a name="l00762"></a>00762                               <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e270ea91b11a2d193de66745f02c4a329">A_CHANGE_TO_MOVE</a>;
<a name="l00763"></a>00763                         }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765                         <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l00766"></a>00766                   }
<a name="l00767"></a>00767              <span class="keywordflow">else</span>
<a name="l00768"></a>00768              {
<a name="l00769"></a>00769                         <span class="keywordflow">return</span>( ITEM_HANDLE_NOAPS );
<a name="l00770"></a>00770              }
<a name="l00771"></a>00771       }
<a name="l00772"></a>00772 
<a name="l00773"></a>00773       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[usHandItem].wirecutters &amp;&amp; pTargetSoldier == NULL ) <span class="comment">// Madd: quick fix to allow wirecutter/knives</span>
<a name="l00774"></a>00774       {
<a name="l00775"></a>00775              <span class="comment">// See if we can get there to stab </span>
<a name="l00776"></a>00776              sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );
<a name="l00777"></a>00777              <span class="keywordflow">if</span> ( sActionGridNo != -1 )
<a name="l00778"></a>00778              {
<a name="l00779"></a>00779                         <span class="comment">// Calculate AP costs...</span>
<a name="l00780"></a>00780                         sAPCost = <a class="code" href="Points_8cpp.html#4674a5330103b514023a95eef8fa6080">GetAPsToCutFence</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00781"></a>00781                         sAPCost += <a class="code" href="PATHAI_8cpp.html#21b55ed2d493e5333f2236ada229ac7f">PlotPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, NO_COPYROUTE, FALSE, TEMPORARY, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, NOT_STEALTH, FORWARD, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>);
<a name="l00782"></a>00782 
<a name="l00783"></a>00783                         <span class="keywordflow">if</span> ( <a class="code" href="Points_8cpp.html#da12609dfc7e36a16ae6065e1c340929">EnoughPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0, fFromUI ) )
<a name="l00784"></a>00784                         {
<a name="l00785"></a>00785                               <span class="comment">// OK, set UI</span>
<a name="l00786"></a>00786                               <span class="comment">// ATE: Set UI here, not below so that if UI is unset, we don't set again!</span>
<a name="l00787"></a>00787                               <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l00788"></a>00788                               <span class="comment">// CHECK IF WE ARE AT THIS GRIDNO NOW</span>
<a name="l00789"></a>00789                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != sActionGridNo )
<a name="l00790"></a>00790                               {
<a name="l00791"></a>00791                                     <span class="comment">// SEND PENDING ACTION</span>
<a name="l00792"></a>00792                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a> = <a class="code" href="Soldier_01Control_8h.html#72e63dc1307b88cc08ad0bd6c737d7484f06e45eb8aef89d03cf4250ab606dd0">MERC_CUTFFENCE</a>;
<a name="l00793"></a>00793                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = sAdjustedGridNo;
<a name="l00794"></a>00794                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>  = ubDirection;
<a name="l00795"></a>00795                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c5862a2a33a904c612ca884a799ac0c2">ubPendingActionAnimCount</a> = 0;
<a name="l00796"></a>00796 
<a name="l00797"></a>00797                                     <span class="comment">// WALK UP TO DEST FIRST</span>
<a name="l00798"></a>00798                                     <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a> , FALSE, TRUE );
<a name="l00799"></a>00799                               }
<a name="l00800"></a>00800                               <span class="keywordflow">else</span>
<a name="l00801"></a>00801                               {
<a name="l00802"></a>00802                                     <a class="code" href="Soldier_01Control_8cpp.html#d11320bed8b1fa776544bd3d08e32465">EVENT_SoldierBeginCutFence</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAdjustedGridNo, ubDirection );
<a name="l00803"></a>00803                               }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805 
<a name="l00806"></a>00806                               <span class="keywordflow">if</span> ( fFromUI )
<a name="l00807"></a>00807                               {
<a name="l00808"></a>00808                                     <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e270ea91b11a2d193de66745f02c4a329">A_CHANGE_TO_MOVE</a>;
<a name="l00809"></a>00809                               }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811                               <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l00812"></a>00812                    }
<a name="l00813"></a>00813                    <span class="keywordflow">else</span>
<a name="l00814"></a>00814                    {
<a name="l00815"></a>00815                               <span class="keywordflow">return</span>( ITEM_HANDLE_NOAPS );
<a name="l00816"></a>00816                    }
<a name="l00817"></a>00817             }
<a name="l00818"></a>00818             <span class="keywordflow">else</span>
<a name="l00819"></a>00819             {
<a name="l00820"></a>00820                   <span class="keywordflow">return</span>( ITEM_HANDLE_CANNOT_GETTO_LOCATION );
<a name="l00821"></a>00821             }
<a name="l00822"></a>00822       }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824   <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[usHandItem].toolkit )
<a name="l00825"></a>00825       {
<a name="l00826"></a>00826              <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubMercID;
<a name="l00827"></a>00827              <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>    fVehicle = FALSE;
<a name="l00828"></a>00828              <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>            sVehicleGridNo=-1;
<a name="l00829"></a>00829 
<a name="l00830"></a>00830              <span class="comment">// For repair, check if we are over a vehicle, then get gridnot to edge of that vehicle!</span>
<a name="l00831"></a>00831              <span class="keywordflow">if</span> ( <a class="code" href="Structure_01Wrap_8cpp.html#f59ad8c864c17d7196010d000508d721">IsRepairableStructAtGridNo</a>( usGridNo, &amp;ubMercID ) == 2 )
<a name="l00832"></a>00832              {
<a name="l00833"></a>00833                         <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sNewGridNo;
<a name="l00834"></a>00834                         <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubDirection;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836                         sNewGridNo = <a class="code" href="Soldier_01Add_8cpp.html#a64d04c9c3155dc56bbe214d16868ef9">FindGridNoFromSweetSpotWithStructDataFromSoldier</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, 5, &amp;ubDirection, 0, <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubMercID ] );
<a name="l00837"></a>00837 
<a name="l00838"></a>00838                         <span class="keywordflow">if</span> ( sNewGridNo != NOWHERE )
<a name="l00839"></a>00839                         {
<a name="l00840"></a>00840                               usGridNo = sNewGridNo;
<a name="l00841"></a>00841 
<a name="l00842"></a>00842                               sVehicleGridNo = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubMercID ]-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844                               fVehicle = TRUE;
<a name="l00845"></a>00845                         }
<a name="l00846"></a>00846              }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848              <span class="comment">// See if we can get there to stab </span>
<a name="l00849"></a>00849              sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );
<a name="l00850"></a>00850 
<a name="l00851"></a>00851              <span class="keywordflow">if</span> ( sActionGridNo != -1 )
<a name="l00852"></a>00852              {
<a name="l00853"></a>00853                         <span class="comment">// Calculate AP costs...</span>
<a name="l00854"></a>00854                         sAPCost = <a class="code" href="Points_8cpp.html#f1b97a04a5373ce66af5998ffbaf26f0">GetAPsToBeginRepair</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00855"></a>00855                         sAPCost += <a class="code" href="PATHAI_8cpp.html#21b55ed2d493e5333f2236ada229ac7f">PlotPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, NO_COPYROUTE, FALSE, TEMPORARY, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, NOT_STEALTH, FORWARD, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>);
<a name="l00856"></a>00856 
<a name="l00857"></a>00857                         <span class="keywordflow">if</span> ( <a class="code" href="Points_8cpp.html#da12609dfc7e36a16ae6065e1c340929">EnoughPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0, fFromUI ) )
<a name="l00858"></a>00858                         {
<a name="l00859"></a>00859                               <span class="comment">// CHECK IF WE ARE AT THIS GRIDNO NOW</span>
<a name="l00860"></a>00860                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != sActionGridNo )
<a name="l00861"></a>00861                               {
<a name="l00862"></a>00862                                     <span class="comment">// SEND PENDING ACTION</span>
<a name="l00863"></a>00863                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a> = <a class="code" href="Soldier_01Control_8h.html#72e63dc1307b88cc08ad0bd6c737d748c76c1b6f8392f0b2dbeca0d5a1e9b2be">MERC_REPAIR</a>;
<a name="l00864"></a>00864                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = sAdjustedGridNo;
<a name="l00865"></a>00865 
<a name="l00866"></a>00866                                     <span class="keywordflow">if</span> ( fVehicle )
<a name="l00867"></a>00867                                     {
<a name="l00868"></a>00868                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = sVehicleGridNo;
<a name="l00869"></a>00869                                     }
<a name="l00870"></a>00870 
<a name="l00871"></a>00871                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>  = ubDirection;
<a name="l00872"></a>00872                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c5862a2a33a904c612ca884a799ac0c2">ubPendingActionAnimCount</a> = 0;
<a name="l00873"></a>00873 
<a name="l00874"></a>00874                                     <span class="comment">// WALK UP TO DEST FIRST</span>
<a name="l00875"></a>00875                                     <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, FALSE, TRUE );
<a name="l00876"></a>00876                               }
<a name="l00877"></a>00877                               <span class="keywordflow">else</span>
<a name="l00878"></a>00878                               {
<a name="l00879"></a>00879                                     <a class="code" href="Soldier_01Control_8cpp.html#0081e86a22c6222487f9912946cd0fb3">EVENT_SoldierBeginRepair</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAdjustedGridNo, ubDirection );
<a name="l00880"></a>00880                               }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882                               <span class="comment">// OK, set UI</span>
<a name="l00883"></a>00883                               <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l00884"></a>00884 
<a name="l00885"></a>00885                               <span class="keywordflow">if</span> ( fFromUI )
<a name="l00886"></a>00886                               {
<a name="l00887"></a>00887                                     <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e270ea91b11a2d193de66745f02c4a329">A_CHANGE_TO_MOVE</a>;
<a name="l00888"></a>00888                               }
<a name="l00889"></a>00889 
<a name="l00890"></a>00890                               <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l00891"></a>00891                    }
<a name="l00892"></a>00892                    <span class="keywordflow">else</span>
<a name="l00893"></a>00893                    {
<a name="l00894"></a>00894                               <span class="keywordflow">return</span>( ITEM_HANDLE_NOAPS );
<a name="l00895"></a>00895                    }
<a name="l00896"></a>00896             }
<a name="l00897"></a>00897             <span class="keywordflow">else</span>
<a name="l00898"></a>00898             {
<a name="l00899"></a>00899                   <span class="keywordflow">return</span>( ITEM_HANDLE_CANNOT_GETTO_LOCATION );
<a name="l00900"></a>00900             }
<a name="l00901"></a>00901       }
<a name="l00902"></a>00902 
<a name="l00903"></a>00903   <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[usHandItem].gascan )
<a name="l00904"></a>00904       {
<a name="l00905"></a>00905              <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubMercID;
<a name="l00906"></a>00906              <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>            sVehicleGridNo=-1;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908              <span class="comment">// For repair, check if we are over a vehicle, then get gridnot to edge of that vehicle!</span>
<a name="l00909"></a>00909              <span class="keywordflow">if</span> ( <a class="code" href="Structure_01Wrap_8cpp.html#287145d7851fd1faf140b4893d21ad01">IsRefuelableStructAtGridNo</a>( usGridNo, &amp;ubMercID ) )
<a name="l00910"></a>00910              {
<a name="l00911"></a>00911                         <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sNewGridNo;
<a name="l00912"></a>00912                         <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubDirection;
<a name="l00913"></a>00913 
<a name="l00914"></a>00914                         sNewGridNo = <a class="code" href="Soldier_01Add_8cpp.html#a64d04c9c3155dc56bbe214d16868ef9">FindGridNoFromSweetSpotWithStructDataFromSoldier</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, 5, &amp;ubDirection, 0, <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubMercID ] );
<a name="l00915"></a>00915 
<a name="l00916"></a>00916                         <span class="keywordflow">if</span> ( sNewGridNo != NOWHERE )
<a name="l00917"></a>00917                         {
<a name="l00918"></a>00918                               usGridNo = sNewGridNo;
<a name="l00919"></a>00919 
<a name="l00920"></a>00920                               sVehicleGridNo = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubMercID ]-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l00921"></a>00921 
<a name="l00922"></a>00922                         }
<a name="l00923"></a>00923              }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925              <span class="comment">// See if we can get there to stab </span>
<a name="l00926"></a>00926              sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );
<a name="l00927"></a>00927 
<a name="l00928"></a>00928              <span class="keywordflow">if</span> ( sActionGridNo != -1 )
<a name="l00929"></a>00929              {
<a name="l00930"></a>00930                         <span class="comment">// Calculate AP costs...</span>
<a name="l00931"></a>00931                         sAPCost = <a class="code" href="Points_8cpp.html#895b3582339b5269685c1cd6e8c76204">GetAPsToRefuelVehicle</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00932"></a>00932                         sAPCost += <a class="code" href="PATHAI_8cpp.html#21b55ed2d493e5333f2236ada229ac7f">PlotPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, NO_COPYROUTE, FALSE, TEMPORARY, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, NOT_STEALTH, FORWARD, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>);
<a name="l00933"></a>00933 
<a name="l00934"></a>00934                         <span class="keywordflow">if</span> ( <a class="code" href="Points_8cpp.html#da12609dfc7e36a16ae6065e1c340929">EnoughPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0, fFromUI ) )
<a name="l00935"></a>00935                         {
<a name="l00936"></a>00936                               <span class="comment">// CHECK IF WE ARE AT THIS GRIDNO NOW</span>
<a name="l00937"></a>00937                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != sActionGridNo )
<a name="l00938"></a>00938                               {
<a name="l00939"></a>00939                                     <span class="comment">// SEND PENDING ACTION</span>
<a name="l00940"></a>00940                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a> = <a class="code" href="Soldier_01Control_8h.html#72e63dc1307b88cc08ad0bd6c737d748085b94c386f67381aa7e4d2c42e3314a">MERC_FUEL_VEHICLE</a>;
<a name="l00941"></a>00941                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = sAdjustedGridNo;
<a name="l00942"></a>00942 
<a name="l00943"></a>00943                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = sVehicleGridNo;
<a name="l00944"></a>00944                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>  = ubDirection;
<a name="l00945"></a>00945                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c5862a2a33a904c612ca884a799ac0c2">ubPendingActionAnimCount</a> = 0;
<a name="l00946"></a>00946 
<a name="l00947"></a>00947                                     <span class="comment">// WALK UP TO DEST FIRST</span>
<a name="l00948"></a>00948                                     <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, FALSE, TRUE );
<a name="l00949"></a>00949                               }
<a name="l00950"></a>00950                               <span class="keywordflow">else</span>
<a name="l00951"></a>00951                               {
<a name="l00952"></a>00952                                     <a class="code" href="Soldier_01Control_8cpp.html#427129911ae2e9f46d0b45a9e8650ddc">EVENT_SoldierBeginRefuel</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAdjustedGridNo, ubDirection );
<a name="l00953"></a>00953                               }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955                               <span class="comment">// OK, set UI</span>
<a name="l00956"></a>00956                               <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l00957"></a>00957 
<a name="l00958"></a>00958                               <span class="keywordflow">if</span> ( fFromUI )
<a name="l00959"></a>00959                               {
<a name="l00960"></a>00960                                     <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e270ea91b11a2d193de66745f02c4a329">A_CHANGE_TO_MOVE</a>;
<a name="l00961"></a>00961                               }
<a name="l00962"></a>00962 
<a name="l00963"></a>00963                               <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l00964"></a>00964                    }
<a name="l00965"></a>00965                    <span class="keywordflow">else</span>
<a name="l00966"></a>00966                    {
<a name="l00967"></a>00967                               <span class="keywordflow">return</span>( ITEM_HANDLE_NOAPS );
<a name="l00968"></a>00968                    }
<a name="l00969"></a>00969             }
<a name="l00970"></a>00970             <span class="keywordflow">else</span>
<a name="l00971"></a>00971             {
<a name="l00972"></a>00972                   <span class="keywordflow">return</span>( ITEM_HANDLE_CANNOT_GETTO_LOCATION );
<a name="l00973"></a>00973             }
<a name="l00974"></a>00974       }
<a name="l00975"></a>00975 
<a name="l00976"></a>00976 
<a name="l00977"></a>00977   <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[usHandItem].jar )
<a name="l00978"></a>00978       {
<a name="l00979"></a>00979              sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );
<a name="l00980"></a>00980 
<a name="l00981"></a>00981              <span class="keywordflow">if</span> ( sActionGridNo != -1 )
<a name="l00982"></a>00982              {
<a name="l00983"></a>00983                         <span class="comment">// Calculate AP costs...</span>
<a name="l00984"></a>00984                         sAPCost = <a class="code" href="Points_8cpp.html#26d4a91d53f7a46b5ddf48bc9e961766">GetAPsToUseJar</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo );
<a name="l00985"></a>00985                         sAPCost += <a class="code" href="PATHAI_8cpp.html#21b55ed2d493e5333f2236ada229ac7f">PlotPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, NO_COPYROUTE, FALSE, TEMPORARY, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, NOT_STEALTH, FORWARD, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>);
<a name="l00986"></a>00986 
<a name="l00987"></a>00987                         <span class="keywordflow">if</span> ( <a class="code" href="Points_8cpp.html#da12609dfc7e36a16ae6065e1c340929">EnoughPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0, fFromUI ) )
<a name="l00988"></a>00988                         {
<a name="l00989"></a>00989                               <span class="comment">// CHECK IF WE ARE AT THIS GRIDNO NOW</span>
<a name="l00990"></a>00990                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != sActionGridNo )
<a name="l00991"></a>00991                               {
<a name="l00992"></a>00992                                     <span class="comment">// SEND PENDING ACTION</span>
<a name="l00993"></a>00993                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a> = <a class="code" href="Soldier_01Control_8h.html#72e63dc1307b88cc08ad0bd6c737d7485449286b4cd9f00023798e67277c4d41">MERC_TAKEBLOOD</a>;
<a name="l00994"></a>00994                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = sAdjustedGridNo;
<a name="l00995"></a>00995                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>  = ubDirection;
<a name="l00996"></a>00996                                     <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c5862a2a33a904c612ca884a799ac0c2">ubPendingActionAnimCount</a> = 0;
<a name="l00997"></a>00997 
<a name="l00998"></a>00998                                     <span class="comment">// WALK UP TO DEST FIRST</span>
<a name="l00999"></a>00999                                     <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, FALSE, TRUE );
<a name="l01000"></a>01000                               }
<a name="l01001"></a>01001                               <span class="keywordflow">else</span>
<a name="l01002"></a>01002                               {
<a name="l01003"></a>01003                                     <a class="code" href="Soldier_01Control_8cpp.html#3733817e6509d76c3d6a336a8043265b">EVENT_SoldierBeginTakeBlood</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAdjustedGridNo, ubDirection );
<a name="l01004"></a>01004                               }
<a name="l01005"></a>01005 
<a name="l01006"></a>01006                               <span class="comment">// OK, set UI</span>
<a name="l01007"></a>01007                               <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l01008"></a>01008 
<a name="l01009"></a>01009                               <span class="keywordflow">if</span> ( fFromUI )
<a name="l01010"></a>01010                               {
<a name="l01011"></a>01011                                     <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e270ea91b11a2d193de66745f02c4a329">A_CHANGE_TO_MOVE</a>;
<a name="l01012"></a>01012                               }
<a name="l01013"></a>01013 
<a name="l01014"></a>01014                               <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l01015"></a>01015                    }
<a name="l01016"></a>01016                    <span class="keywordflow">else</span>
<a name="l01017"></a>01017                    {
<a name="l01018"></a>01018                               <span class="keywordflow">return</span>( ITEM_HANDLE_NOAPS );
<a name="l01019"></a>01019                    }
<a name="l01020"></a>01020             }
<a name="l01021"></a>01021             <span class="keywordflow">else</span>
<a name="l01022"></a>01022             {
<a name="l01023"></a>01023                   <span class="keywordflow">return</span>( ITEM_HANDLE_CANNOT_GETTO_LOCATION );
<a name="l01024"></a>01024             }
<a name="l01025"></a>01025       }
<a name="l01026"></a>01026 
<a name="l01027"></a>01027   <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[usHandItem].canandstring )
<a name="l01028"></a>01028       {
<a name="l01029"></a>01029              <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a>                          *pStructure;
<a name="l01030"></a>01030              <a class="code" href="structTAG__level__node.html">LEVELNODE</a>                          *pIntTile;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032              <span class="comment">// Get structure info for in tile!</span>
<a name="l01033"></a>01033              pIntTile = <a class="code" href="Interactive_01Tiles_8cpp.html#f21785f68e878eb880d644f9e9a5dbc1">GetCurInteractiveTileGridNoAndStructure</a>( (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> *)&amp;usGridNo, &amp;pStructure );
<a name="l01034"></a>01034 
<a name="l01035"></a>01035              <span class="comment">// We should not have null here if we are given this flag...</span>
<a name="l01036"></a>01036              <span class="keywordflow">if</span> ( pIntTile != NULL )
<a name="l01037"></a>01037              {
<a name="l01038"></a>01038                    sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, FALSE, TRUE );
<a name="l01039"></a>01039 
<a name="l01040"></a>01040                    <span class="keywordflow">if</span> ( sActionGridNo != -1 )
<a name="l01041"></a>01041                    {
<a name="l01042"></a>01042                               <span class="comment">// Calculate AP costs...</span>
<a name="l01043"></a>01043                               sAPCost = AP_ATTACH_CAN;
<a name="l01044"></a>01044                               sAPCost += <a class="code" href="PATHAI_8cpp.html#21b55ed2d493e5333f2236ada229ac7f">PlotPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, NO_COPYROUTE, FALSE, TEMPORARY, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, NOT_STEALTH, FORWARD, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#080980e5fe705dcea5c819b05aef6f21">bActionPoints</a>);
<a name="l01045"></a>01045 
<a name="l01046"></a>01046                               <span class="keywordflow">if</span> ( <a class="code" href="Points_8cpp.html#da12609dfc7e36a16ae6065e1c340929">EnoughPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0, fFromUI ) )
<a name="l01047"></a>01047                               {
<a name="l01048"></a>01048                                     <span class="comment">// CHECK IF WE ARE AT THIS GRIDNO NOW</span>
<a name="l01049"></a>01049                                     <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != sActionGridNo )
<a name="l01050"></a>01050                                     {
<a name="l01051"></a>01051                                           <span class="comment">// SEND PENDING ACTION</span>
<a name="l01052"></a>01052                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a> = <a class="code" href="Soldier_01Control_8h.html#72e63dc1307b88cc08ad0bd6c737d7483960639aa0013b990bbbfeae2390be45">MERC_ATTACH_CAN</a>;
<a name="l01053"></a>01053                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = usGridNo;
<a name="l01054"></a>01054                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>  = ubDirection;
<a name="l01055"></a>01055                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c5862a2a33a904c612ca884a799ac0c2">ubPendingActionAnimCount</a> = 0;
<a name="l01056"></a>01056 
<a name="l01057"></a>01057                                           <span class="comment">// WALK UP TO DEST FIRST</span>
<a name="l01058"></a>01058                                           <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, FALSE, TRUE );
<a name="l01059"></a>01059                                     }
<a name="l01060"></a>01060                                     <span class="keywordflow">else</span>
<a name="l01061"></a>01061                                     {
<a name="l01062"></a>01062                                           <a class="code" href="Soldier_01Control_8cpp.html#3733817e6509d76c3d6a336a8043265b">EVENT_SoldierBeginTakeBlood</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, ubDirection );
<a name="l01063"></a>01063                                     }
<a name="l01064"></a>01064 
<a name="l01065"></a>01065                                     <span class="comment">// OK, set UI</span>
<a name="l01066"></a>01066                                     <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l01067"></a>01067 
<a name="l01068"></a>01068                                     <span class="keywordflow">if</span> ( fFromUI )
<a name="l01069"></a>01069                                     {
<a name="l01070"></a>01070                                           <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e270ea91b11a2d193de66745f02c4a329">A_CHANGE_TO_MOVE</a>;
<a name="l01071"></a>01071                                     }
<a name="l01072"></a>01072 
<a name="l01073"></a>01073                                     <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l01074"></a>01074                          }
<a name="l01075"></a>01075                          <span class="keywordflow">else</span>
<a name="l01076"></a>01076                          {
<a name="l01077"></a>01077                                     <span class="keywordflow">return</span>( ITEM_HANDLE_NOAPS );
<a name="l01078"></a>01078                          }
<a name="l01079"></a>01079                   }
<a name="l01080"></a>01080                   <span class="keywordflow">else</span>
<a name="l01081"></a>01081                   {
<a name="l01082"></a>01082                         <span class="keywordflow">return</span>( ITEM_HANDLE_CANNOT_GETTO_LOCATION );
<a name="l01083"></a>01083                   }
<a name="l01084"></a>01084             }
<a name="l01085"></a>01085             <span class="keywordflow">else</span>
<a name="l01086"></a>01086             {
<a name="l01087"></a>01087                    <span class="keywordflow">return</span>( ITEM_HANDLE_CANNOT_GETTO_LOCATION );
<a name="l01088"></a>01088             }
<a name="l01089"></a>01089       }
<a name="l01090"></a>01090 
<a name="l01091"></a>01091       <span class="comment">// Check for remote detonator cursor....</span>
<a name="l01092"></a>01092       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].ubCursor == REMOTECURS )
<a name="l01093"></a>01093       {
<a name="l01094"></a>01094             sAPCost = AP_USE_REMOTE;
<a name="l01095"></a>01095 
<a name="l01096"></a>01096             <span class="keywordflow">if</span> ( <a class="code" href="Points_8cpp.html#da12609dfc7e36a16ae6065e1c340929">EnoughPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0, fFromUI ) )
<a name="l01097"></a>01097             {                 
<a name="l01098"></a>01098                   <a class="code" href="Points_8cpp.html#2443da2dcce8326e972d806fbc4eaff8">DeductPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0 );
<a name="l01099"></a>01099                   <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[usHandItem].xray )
<a name="l01100"></a>01100                   {
<a name="l01101"></a>01101                   <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b57157dba3c394fcbdf922d4829141e520">USE_X_RAY_MACHINE</a>, RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( HIGHVOLUME, pSoldier-&gt;sGridNo ), 1, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( pSoldier-&gt;sGridNo ) );                 
<a name="l01102"></a>01102 
<a name="l01103"></a>01103                         <a class="code" href="Items_8cpp.html#99c997721db742718493f6a105eacc1f">ActivateXRayDevice</a>( pSoldier );
<a name="l01104"></a>01104                         <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l01105"></a>01105                   }
<a name="l01106"></a>01106                   <span class="keywordflow">else</span> <span class="comment">// detonator</span>
<a name="l01107"></a>01107                   {
<a name="l01108"></a>01108                         <span class="comment">// Save gridno....</span>
<a name="l01109"></a>01109                         pSoldier-&gt;sPendingActionData2  = usGridNo;
<a name="l01110"></a>01110 
<a name="l01111"></a>01111                         <a class="code" href="Soldier_01Control_8cpp.html#f1a71f09e82b51be44639cae8394606d">EVENT_SoldierBeginUseDetonator</a>( pSoldier );                 
<a name="l01112"></a>01112 
<a name="l01113"></a>01113                         <span class="keywordflow">if</span> ( fFromUI )
<a name="l01114"></a>01114                         {
<a name="l01115"></a>01115                               <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e270ea91b11a2d193de66745f02c4a329">A_CHANGE_TO_MOVE</a>;
<a name="l01116"></a>01116                         }
<a name="l01117"></a>01117 
<a name="l01118"></a>01118                         <span class="comment">// Now start anim....</span>
<a name="l01119"></a>01119                         <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l01120"></a>01120                   }
<a name="l01121"></a>01121             }
<a name="l01122"></a>01122             <span class="keywordflow">else</span>
<a name="l01123"></a>01123             {
<a name="l01124"></a>01124                   <span class="keywordflow">return</span>( ITEM_HANDLE_NOAPS );
<a name="l01125"></a>01125             }
<a name="l01126"></a>01126       }
<a name="l01127"></a>01127 
<a name="l01128"></a>01128 
<a name="l01129"></a>01129       <span class="comment">// Check for mine.. anything without a detonator.....</span>
<a name="l01130"></a>01130       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].ubCursor == BOMBCURS )
<a name="l01131"></a>01131       {
<a name="l01132"></a>01132             fDropBomb = TRUE;
<a name="l01133"></a>01133       }
<a name="l01134"></a>01134 
<a name="l01135"></a>01135       <span class="comment">// Check for a bomb like a mine, that uses a pressure detonator</span>
<a name="l01136"></a>01136       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].ubCursor == INVALIDCURS )
<a name="l01137"></a>01137       {
<a name="l01138"></a>01138             <span class="comment">// Found detonator...</span>
<a name="l01139"></a>01139             <span class="keywordflow">if</span> ( <a class="code" href="Items_8cpp.html#69f462eb26c68f572dcfbaa2a7e24d32">IsDetonatorAttached</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ] ) )  || <a class="code" href="Items_8cpp.html#5057189c6cc02dcf8ba950768a9c3a43">IsRemoteDetonatorAttached</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ] ) ) )
<a name="l01140"></a>01140             {
<a name="l01141"></a>01141                   fDropBomb = TRUE;
<a name="l01142"></a>01142             }
<a name="l01143"></a>01143       }
<a name="l01144"></a>01144 
<a name="l01145"></a>01145       <span class="keywordflow">if</span> ( fDropBomb )
<a name="l01146"></a>01146       {
<a name="l01147"></a>01147             <span class="comment">// Save gridno....</span>
<a name="l01148"></a>01148             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = usGridNo;
<a name="l01149"></a>01149 
<a name="l01150"></a>01150             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != usGridNo )
<a name="l01151"></a>01151             {
<a name="l01152"></a>01152                   <span class="comment">// SEND PENDING ACTION</span>
<a name="l01153"></a>01153                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a> = <a class="code" href="Soldier_01Control_8h.html#72e63dc1307b88cc08ad0bd6c737d748d4ccc1ba37c001c1caa4b93d289d8ad7">MERC_DROPBOMB</a>;
<a name="l01154"></a>01154                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c5862a2a33a904c612ca884a799ac0c2">ubPendingActionAnimCount</a> = 0;
<a name="l01155"></a>01155 
<a name="l01156"></a>01156                   <span class="comment">// WALK UP TO DEST FIRST</span>
<a name="l01157"></a>01157                   <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, FALSE, TRUE );
<a name="l01158"></a>01158             }
<a name="l01159"></a>01159             <span class="keywordflow">else</span>
<a name="l01160"></a>01160             {
<a name="l01161"></a>01161                   <a class="code" href="Soldier_01Control_8cpp.html#2a9317b0131911d379a901233dfc8b73">EVENT_SoldierBeginDropBomb</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );               
<a name="l01162"></a>01162             }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164             <span class="comment">// OK, set UI</span>
<a name="l01165"></a>01165             <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l01166"></a>01166 
<a name="l01167"></a>01167             <span class="keywordflow">if</span> ( fFromUI )
<a name="l01168"></a>01168             {
<a name="l01169"></a>01169                   <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e270ea91b11a2d193de66745f02c4a329">A_CHANGE_TO_MOVE</a>;
<a name="l01170"></a>01170             }
<a name="l01171"></a>01171 
<a name="l01172"></a>01172             <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l01173"></a>01173       }
<a name="l01174"></a>01174       
<a name="l01175"></a>01175       <span class="comment">//USING THE BLADE</span>
<a name="l01176"></a>01176       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].usItemClass == IC_BLADE )
<a name="l01177"></a>01177       {
<a name="l01178"></a>01178              <span class="comment">// See if we can get there to stab </span>
<a name="l01179"></a>01179              <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> == <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a7fa470b7d78ba43f21bfd04c49f02a70b">BLOODCAT</a> )
<a name="l01180"></a>01180              {
<a name="l01181"></a>01181                   sActionGridNo =  <a class="code" href="Overhead_8cpp.html#ff78943e15f71ac488941f45de98528f">FindNextToAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );     
<a name="l01182"></a>01182              }
<a name="l01183"></a>01183              <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( CREATURE_OR_BLOODCAT( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) &amp;&amp; <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, usGridNo ) &gt; 1 )
<a name="l01184"></a>01184              {
<a name="l01185"></a>01185                   sActionGridNo =  <a class="code" href="Overhead_8cpp.html#ff78943e15f71ac488941f45de98528f">FindNextToAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );     
<a name="l01186"></a>01186                   <span class="keywordflow">if</span> (sActionGridNo == -1)
<a name="l01187"></a>01187                   {
<a name="l01188"></a>01188                    sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );
<a name="l01189"></a>01189                   }
<a name="l01190"></a>01190              }
<a name="l01191"></a>01191              <span class="keywordflow">else</span>
<a name="l01192"></a>01192              {
<a name="l01193"></a>01193                   sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );
<a name="l01194"></a>01194              }
<a name="l01195"></a>01195              
<a name="l01196"></a>01196              <span class="keywordflow">if</span> ( sActionGridNo != -1 )
<a name="l01197"></a>01197              {
<a name="l01198"></a>01198                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b4e39ed2a9e7da5cfd2284224398a896">usActionData</a> = sActionGridNo;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200                         <span class="comment">// CHECK IF WE ARE AT THIS GRIDNO NOW</span>
<a name="l01201"></a>01201                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != sActionGridNo )
<a name="l01202"></a>01202                         {
<a name="l01203"></a>01203                               <span class="comment">// SEND PENDING ACTION</span>
<a name="l01204"></a>01204                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a> = <a class="code" href="Soldier_01Control_8h.html#72e63dc1307b88cc08ad0bd6c737d748d482ef529b15e812f58f09e135dfd314">MERC_KNIFEATTACK</a>;
<a name="l01205"></a>01205                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = sAdjustedGridNo;
<a name="l01206"></a>01206                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>  = ubDirection;
<a name="l01207"></a>01207                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c5862a2a33a904c612ca884a799ac0c2">ubPendingActionAnimCount</a> = 0;
<a name="l01208"></a>01208 
<a name="l01209"></a>01209                               <span class="comment">// WALK UP TO DEST FIRST</span>
<a name="l01210"></a>01210                               <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, FALSE, TRUE );
<a name="l01211"></a>01211                         }
<a name="l01212"></a>01212                         <span class="keywordflow">else</span>
<a name="l01213"></a>01213                         {
<a name="l01214"></a>01214                               <span class="comment">// for the benefit of the AI</span>
<a name="l01215"></a>01215                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b7169eb6a928d5fcf0e201335ea935b1a">AI_ACTION_KNIFE_STAB</a>;
<a name="l01216"></a>01216                               <a class="code" href="Soldier_01Control_8cpp.html#84e7c0b7befc962379b286606c3110ea">EVENT_SoldierBeginBladeAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAdjustedGridNo, ubDirection );
<a name="l01217"></a>01217                         }
<a name="l01218"></a>01218 
<a name="l01219"></a>01219                         <span class="comment">// OK, set UI</span>
<a name="l01220"></a>01220                         <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l01221"></a>01221 
<a name="l01222"></a>01222                         <span class="keywordflow">if</span> ( fFromUI )
<a name="l01223"></a>01223                         {
<a name="l01224"></a>01224                               <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e270ea91b11a2d193de66745f02c4a329">A_CHANGE_TO_MOVE</a>;
<a name="l01225"></a>01225                               <a class="code" href="Handle_01Items_8cpp.html#0d67a1e997a3d54c71a0127ef4963a92">gfResetUIMovementOptimization</a> = TRUE;
<a name="l01226"></a>01226                         }
<a name="l01227"></a>01227 
<a name="l01228"></a>01228                         <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l01229"></a>01229              }
<a name="l01230"></a>01230              <span class="keywordflow">else</span>
<a name="l01231"></a>01231              {
<a name="l01232"></a>01232                         <span class="keywordflow">return</span>( ITEM_HANDLE_CANNOT_GETTO_LOCATION );
<a name="l01233"></a>01233              }
<a name="l01234"></a>01234       }
<a name="l01235"></a>01235 
<a name="l01236"></a>01236 
<a name="l01237"></a>01237       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].usItemClass == IC_TENTACLES )
<a name="l01238"></a>01238       {
<a name="l01239"></a>01239              <span class="comment">// See if we can get there to stab </span>
<a name="l01240"></a>01240              <span class="comment">//pSoldier-&gt;sTargetGridNo = sTargetGridNo;</span>
<a name="l01241"></a>01241              <span class="comment">//pSoldier-&gt;sLastTarget = sTargetGridNo;</span>
<a name="l01242"></a>01242              <span class="comment">//pSoldier-&gt;ubTargetID = WhoIsThere2( sTargetGridNo, pSoldier-&gt;bTargetLevel );</span>
<a name="l01243"></a>01243 
<a name="l01244"></a>01244              <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a>++;
<a name="l01245"></a>01245              DebugMsg( <a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>, DBG_LEVEL_3, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"!!!!!!! Starting swipe attack, incrementing a.b.c in HandleItems to %d"</span>, <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a>) );
<a name="l01246"></a>01246 
<a name="l01247"></a>01247 
<a name="l01248"></a>01248          sAPCost = <a class="code" href="Points_8cpp.html#0f8c5c45aa1476d851d7e0c242910908">CalcTotalAPsToAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sGridNo, FALSE, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f4d35b19eed93ae72b4bb54c4e6e8a3e">bAimTime</a> );
<a name="l01249"></a>01249 
<a name="l01250"></a>01250              <a class="code" href="Points_8cpp.html#2443da2dcce8326e972d806fbc4eaff8">DeductPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0 );
<a name="l01251"></a>01251 
<a name="l01252"></a>01252              <a class="code" href="Soldier_01Control_8cpp.html#2f98bd1e4ef2f55b4124a6cfa69a00e3">EVENT_InitNewSoldierAnim</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb7a31b4bc105bae98ed24b38bf746fff5">QUEEN_SWIPE</a>, 0 , FALSE );                            
<a name="l01253"></a>01253 
<a name="l01254"></a>01254              <span class="comment">//FireWeapon( pSoldier, sTargetGridNo );</span>
<a name="l01255"></a>01255              <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#70fc2b64ddf6ed6358c954ff3f200ce7">bAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b7169eb6a928d5fcf0e201335ea935b1a">AI_ACTION_KNIFE_STAB</a>;
<a name="l01256"></a>01256 
<a name="l01257"></a>01257              <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l01258"></a>01258       }
<a name="l01259"></a>01259 
<a name="l01260"></a>01260 
<a name="l01261"></a>01261       <span class="comment">// THIS IS IF WE WERE FROM THE UI</span>
<a name="l01262"></a>01262       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].usItemClass == IC_GRENADE || <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].usItemClass == IC_LAUNCHER || <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].usItemClass == IC_THROWN )
<a name="l01263"></a>01263       {
<a name="l01264"></a>01264             <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sCheckGridNo;
<a name="l01265"></a>01265 
<a name="l01266"></a>01266             <span class="comment">// Get gridno - either soldier's position or the gridno</span>
<a name="l01267"></a>01267             <span class="keywordflow">if</span> ( pTargetSoldier != NULL )
<a name="l01268"></a>01268             {
<a name="l01269"></a>01269                   sTargetGridNo     = pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l01270"></a>01270             }
<a name="l01271"></a>01271             <span class="keywordflow">else</span>
<a name="l01272"></a>01272             {
<a name="l01273"></a>01273                   sTargetGridNo     = usGridNo;
<a name="l01274"></a>01274             }
<a name="l01275"></a>01275 
<a name="l01276"></a>01276             sAPCost = <a class="code" href="Points_8cpp.html#84f116b33524232723bfa74949877c21">MinAPsToAttack</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo, TRUE );
<a name="l01277"></a>01277 
<a name="l01278"></a>01278             <span class="comment">// Check if these is room to place mortar!</span>
<a name="l01279"></a>01279             <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[usHandItem].mortar )
<a name="l01280"></a>01280             {
<a name="l01281"></a>01281                   ubDirection = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="Soldier_01Control_8cpp.html#1d7b6c103ede7e551e76eef2ef173f9b">GetDirectionFromGridNo</a>( sTargetGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01282"></a>01282 
<a name="l01283"></a>01283                   <span class="comment">// Get new gridno!</span>
<a name="l01284"></a>01284                   sCheckGridNo = <a class="code" href="Isometric_01Utils_8cpp.html#318d8410127e29bb232ab70363bc316e">NewGridNo</a>( (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)<a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( ubDirection ) );
<a name="l01285"></a>01285 
<a name="l01286"></a>01286                   <span class="keywordflow">if</span> ( !<a class="code" href="Soldier_01Ani_8cpp.html#52dee080c40e99d978e145a7fd2f3a67">OKFallDirection</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sCheckGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, ubDirection , <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ) )
<a name="l01287"></a>01287                   {
<a name="l01288"></a>01288                         <span class="keywordflow">return</span>( ITEM_HANDLE_NOROOM );
<a name="l01289"></a>01289                   }
<a name="l01290"></a>01290 
<a name="l01291"></a>01291                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c08e13a2118c98e4b8b72117e7dac653">fDontChargeAPsForStanceChange</a> = TRUE;
<a name="l01292"></a>01292             }
<a name="l01293"></a>01293             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[usHandItem].grenadelauncher )<span class="comment">//usHandItem == GLAUNCHER || usHandItem == UNDER_GLAUNCHER )</span>
<a name="l01294"></a>01294             {
<a name="l01295"></a>01295                   <a class="code" href="Points_8cpp.html#3b12531a2257bc86bdf10fbcb505dbe9">GetAPChargeForShootOrStabWRTGunRaises</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo, TRUE, &amp;fAddingTurningCost, &amp;fAddingRaiseGunCost );
<a name="l01296"></a>01296 
<a name="l01297"></a>01297                   <span class="comment">// If we are standing and are asked to turn AND raise gun, ignore raise gun...</span>
<a name="l01298"></a>01298                   <span class="keywordflow">if</span> ( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ pSoldier-&gt;usAnimState ].<a class="code" href="structANIMCONTROLTYPE.html#b9157ed02712719a4e7c4317370cd498">ubHeight</a> == ANIM_STAND )
<a name="l01299"></a>01299                   {
<a name="l01300"></a>01300                         <span class="keywordflow">if</span> ( fAddingRaiseGunCost )
<a name="l01301"></a>01301                         {
<a name="l01302"></a>01302                               pSoldier-&gt;fDontChargeTurningAPs = TRUE;
<a name="l01303"></a>01303                         }
<a name="l01304"></a>01304                   }
<a name="l01305"></a>01305                   <span class="comment">/*else</span>
<a name="l01306"></a>01306 <span class="comment">                  {</span>
<a name="l01307"></a>01307 <span class="comment">                        // If raising gun, don't charge turning!</span>
<a name="l01308"></a>01308 <span class="comment">                        if ( fAddingTurningCost )</span>
<a name="l01309"></a>01309 <span class="comment">                        {</span>
<a name="l01310"></a>01310 <span class="comment">                              pSoldier-&gt;fDontChargeReadyAPs = TRUE;</span>
<a name="l01311"></a>01311 <span class="comment">                        }</span>
<a name="l01312"></a>01312 <span class="comment">                  }*/</span>
<a name="l01313"></a>01313             }
<a name="l01314"></a>01314 
<a name="l01315"></a>01315             <span class="comment">// If this is a player guy, show message about no APS</span>
<a name="l01316"></a>01316             <span class="keywordflow">if</span> ( <a class="code" href="Points_8cpp.html#da12609dfc7e36a16ae6065e1c340929">EnoughPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sAPCost, 0, fFromUI ) )
<a name="l01317"></a>01317             {
<a name="l01318"></a>01318                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> = <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>;
<a name="l01319"></a>01319                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#549976333a3c89be2ca4a342235e1464">usAttackingWeapon</a> = usHandItem;
<a name="l01320"></a>01320                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e29f2821a7f319ffe6405848dabb4c6b">bTargetLevel</a>    = bLevel;
<a name="l01321"></a>01321 
<a name="l01322"></a>01322                   <span class="comment">// Look at the cursor, if toss cursor...</span>
<a name="l01323"></a>01323                   <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].ubCursor == TOSSCURS )
<a name="l01324"></a>01324                   {
<a name="l01325"></a>01325                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#97fff971b8c532135f0c0451deac7aa1">sTargetGridNo</a> = sTargetGridNo;
<a name="l01326"></a>01326                         <span class="comment">//    pSoldier-&gt;sLastTarget = sTargetGridNo;</span>
<a name="l01327"></a>01327                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f9fbe88de500cfce55e233298ada29e4">ubTargetID</a> = <a class="code" href="worldman_8cpp.html#87338f0c77765726813428fd184bfcd8">WhoIsThere2</a>( sTargetGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e29f2821a7f319ffe6405848dabb4c6b">bTargetLevel</a> );
<a name="l01328"></a>01328 
<a name="l01329"></a>01329                         <span class="comment">// Increment attack counter...</span>
<a name="l01330"></a>01330                         <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a>++;
<a name="l01331"></a>01331 
<a name="l01332"></a>01332                         <span class="comment">// ATE: Don't charge turning...</span>
<a name="l01333"></a>01333                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f310b1894267fcf2b8ca3cb929119439">fDontChargeTurningAPs</a> = TRUE;
<a name="l01334"></a>01334                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c08e13a2118c98e4b8b72117e7dac653">fDontChargeAPsForStanceChange</a> = TRUE;
<a name="l01335"></a>01335 
<a name="l01336"></a>01336                         <a class="code" href="Weapons_8cpp.html#a217c0a5c7ef566d2d19759d16e2a9ea">FireWeapon</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo );
<a name="l01337"></a>01337                   }
<a name="l01338"></a>01338                   <span class="keywordflow">else</span>
<a name="l01339"></a>01339                   {
<a name="l01340"></a>01340 
<a name="l01341"></a>01341                         <a class="code" href="Soldier_01Control_8cpp.html#455a5c933e0016bda8096f0cc2d03115">SendBeginFireWeaponEvent</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sTargetGridNo );
<a name="l01342"></a>01342 
<a name="l01343"></a>01343                   }
<a name="l01344"></a>01344 
<a name="l01345"></a>01345                   <span class="comment">// OK, set UI</span>
<a name="l01346"></a>01346                   <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l01347"></a>01347 
<a name="l01348"></a>01348                   <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l01349"></a>01349 
<a name="l01350"></a>01350             }
<a name="l01351"></a>01351             <span class="keywordflow">else</span>
<a name="l01352"></a>01352             {
<a name="l01353"></a>01353                   <span class="keywordflow">return</span>( ITEM_HANDLE_NOAPS );
<a name="l01354"></a>01354             }
<a name="l01355"></a>01355 
<a name="l01356"></a>01356             <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l01357"></a>01357       }
<a name="l01358"></a>01358 
<a name="l01359"></a>01359       <span class="comment">// CHECK FOR BOMB....</span>
<a name="l01360"></a>01360       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ usHandItem ].ubCursor == INVALIDCURS )
<a name="l01361"></a>01361       {
<a name="l01362"></a>01362             <span class="comment">// Found detonator...</span>
<a name="l01363"></a>01363             <span class="keywordflow">if</span> ( <a class="code" href="Items_8cpp.html#69f462eb26c68f572dcfbaa2a7e24d32">IsDetonatorAttached</a> ( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ usHandItem ] ) )  || <a class="code" href="Items_8cpp.html#5057189c6cc02dcf8ba950768a9c3a43">IsRemoteDetonatorAttached</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ usHandItem ] ) ) )
<a name="l01364"></a>01364             {
<a name="l01365"></a>01365                   <a class="code" href="Handle_01Items_8cpp.html#8be34a74ed567842429dd7d4eeb78195">StartBombMessageBox</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usGridNo );
<a name="l01366"></a>01366 
<a name="l01367"></a>01367                   <span class="keywordflow">if</span> ( fFromUI )
<a name="l01368"></a>01368                   {
<a name="l01369"></a>01369                         <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e270ea91b11a2d193de66745f02c4a329">A_CHANGE_TO_MOVE</a>;
<a name="l01370"></a>01370                   }
<a name="l01371"></a>01371 
<a name="l01372"></a>01372                   <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l01373"></a>01373             }
<a name="l01374"></a>01374       }
<a name="l01375"></a>01375 
<a name="l01376"></a>01376       <span class="keywordflow">return</span>( ITEM_HANDLE_OK );
<a name="l01377"></a>01377 }
<a name="l01378"></a>01378 
<a name="l01379"></a>01379 
<a name="l01380"></a><a class="code" href="Handle_01Items_8h.html#9cd3f682a2c690da88d055dee14f229a">01380</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#9cd3f682a2c690da88d055dee14f229a">HandleSoldierDropBomb</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo )
<a name="l01381"></a>01381 {
<a name="l01382"></a>01382       <span class="comment">// Does this have detonator that needs info?</span>
<a name="l01383"></a>01383       <span class="keywordflow">if</span> ( <a class="code" href="Items_8cpp.html#69f462eb26c68f572dcfbaa2a7e24d32">IsDetonatorAttached</a> ( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a> ] ) ) || <a class="code" href="Items_8cpp.html#5057189c6cc02dcf8ba950768a9c3a43">IsRemoteDetonatorAttached</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ HANDPOS ] ) ) )
<a name="l01384"></a>01384       {
<a name="l01385"></a>01385             <a class="code" href="Handle_01Items_8cpp.html#8be34a74ed567842429dd7d4eeb78195">StartBombMessageBox</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sGridNo );
<a name="l01386"></a>01386       }
<a name="l01387"></a>01387       <span class="keywordflow">else</span>
<a name="l01388"></a>01388       {
<a name="l01389"></a>01389             <span class="comment">// We have something... all we do is place...</span>
<a name="l01390"></a>01390             <span class="keywordflow">if</span> ( <a class="code" href="Items_8cpp.html#7fecee7474f626d9999d60304129c031">ArmBomb</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ HANDPOS ]), 0 ) )
<a name="l01391"></a>01391             {
<a name="l01392"></a>01392                   <span class="comment">// Snap: Do a skill check here as well</span>
<a name="l01393"></a>01393                   <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e41a0cdf3ca5245d4cace59b8a6355c644">PLANTING_BOMB_CHECK</a>, 0 );
<a name="l01394"></a>01394 
<a name="l01395"></a>01395                   <span class="keywordflow">if</span> ( iResult &gt;= 0 )
<a name="l01396"></a>01396                   {
<a name="l01397"></a>01397                         <span class="comment">// EXPLOSIVES GAIN (25):  Place a bomb, or buried and armed a mine</span>
<a name="l01398"></a>01398                         <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, EXPLODEAMT, 25, FALSE );
<a name="l01399"></a>01399 
<a name="l01400"></a>01400                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ HANDPOS ].<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a> = __min( 10, ( <a class="code" href="SkillCheck_8cpp.html#4dadb296e11e2633e5f12a2432fbc147">EffectiveExplosive</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) / 20) + (<a class="code" href="SkillCheck_8cpp.html#15874afa42450a6228e52f68f6871178">EffectiveExpLevel</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) / 3) );
<a name="l01401"></a>01401                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ HANDPOS ].<a class="code" href="structOBJECTTYPE.html#085f3d8acfbd4ec7448607c65054cc27">ubBombOwner</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> + 2;
<a name="l01402"></a>01402 
<a name="l01403"></a>01403                         <span class="comment">// we now know there is something nasty here                </span>
<a name="l01404"></a>01404                         <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#430f12029207b5bb7b32ed30ef355253">uiFlags</a> |= MAPELEMENT_PLAYER_MINE_PRESENT;
<a name="l01405"></a>01405 
<a name="l01406"></a>01406                         <a class="code" href="Handle_01Items_8cpp.html#ca7f6f6da97e9a4c2b737296485f5c84">AddItemToPool</a>( sGridNo, &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ HANDPOS ] ), BURIED, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, WORLD_ITEM_ARMED_BOMB, 0 );
<a name="l01407"></a>01407                         <a class="code" href="Items_8cpp.html#5950d1252d479c6f8c5a25d86b06d889">DeleteObj</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ HANDPOS ]) );
<a name="l01408"></a>01408                   }
<a name="l01409"></a>01409                   <span class="keywordflow">else</span>
<a name="l01410"></a>01410                   {
<a name="l01411"></a>01411                         <span class="comment">// EXPLOSIVES GAIN (10):  Failed to place a bomb, or bury and arm a mine</span>
<a name="l01412"></a>01412                         <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, EXPLODEAMT, 10, FROM_FAILURE );
<a name="l01413"></a>01413 
<a name="l01414"></a>01414                         <span class="comment">// oops!  How badly did we screw up?</span>
<a name="l01415"></a>01415                         <span class="keywordflow">if</span> ( iResult &lt; -20 )
<a name="l01416"></a>01416                         {
<a name="l01417"></a>01417                               <span class="comment">// OOPS! ... BOOM!</span>
<a name="l01418"></a>01418                               <a class="code" href="Explosion_01Control_8cpp.html#add4813e471ef668a64079af2ea8b36a">IgniteExplosion</a>( NOBODY, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#80d05007932f81f157f2773852ebf62f">sX</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#bad6abc8c1fd843d332db84aa9c1a10c">sY</a>, (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) (<a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>].sHeight), <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ HANDPOS ].<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l01419"></a>01419                               <a class="code" href="Items_8cpp.html#5950d1252d479c6f8c5a25d86b06d889">DeleteObj</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ HANDPOS ]) );
<a name="l01420"></a>01420                         }
<a name="l01421"></a>01421                   }
<a name="l01422"></a>01422 
<a name="l01423"></a>01423             }
<a name="l01424"></a>01424       }
<a name="l01425"></a>01425 }
<a name="l01426"></a>01426 
<a name="l01427"></a><a class="code" href="Handle_01Items_8h.html#5271c7468e2488cb83518cd367e10702">01427</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#5271c7468e2488cb83518cd367e10702">HandleSoldierUseRemote</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo )
<a name="l01428"></a>01428 {
<a name="l01429"></a>01429       <a class="code" href="Handle_01Items_8cpp.html#8be34a74ed567842429dd7d4eeb78195">StartBombMessageBox</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sGridNo );
<a name="l01430"></a>01430 }
<a name="l01431"></a>01431 
<a name="l01432"></a><a class="code" href="Handle_01Items_8h.html#549d99e2966b380fda3c7b440f0aa9b9">01432</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#549d99e2966b380fda3c7b440f0aa9b9">SoldierHandleDropItem</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l01433"></a>01433 {
<a name="l01434"></a>01434       <span class="comment">// LOOK IN PANDING DATA FOR ITEM TO DROP, AND LOCATION</span>
<a name="l01435"></a>01435       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> != NULL )
<a name="l01436"></a>01436       { 
<a name="l01437"></a>01437             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#73246323764393ce2a5ece7fcb7b7cf8">bVisible</a> != -1 )
<a name="l01438"></a>01438             {
<a name="l01439"></a>01439                   <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5b30cdcae32c76ebd3b56c743fcb46671">THROW_IMPACT_2</a>, RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( MIDVOLUME, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ), 1, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ) );               
<a name="l01440"></a>01440             }
<a name="l01441"></a>01441 
<a name="l01442"></a>01442             <a class="code" href="Handle_01Items_8cpp.html#ca7f6f6da97e9a4c2b737296485f5c84">AddItemToPool</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a>, 1, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, 0 , -1 );
<a name="l01443"></a>01443             <a class="code" href="Handle_01Items_8cpp.html#ef92c00fc5ad51b4a9064e4a09d59492">NotifySoldiersToLookforItems</a>( );
<a name="l01444"></a>01444 
<a name="l01445"></a>01445             MemFree( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> );
<a name="l01446"></a>01446             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> = NULL;
<a name="l01447"></a>01447       }
<a name="l01448"></a>01448 }
<a name="l01449"></a>01449 
<a name="l01450"></a>01450 
<a name="l01451"></a><a class="code" href="Handle_01Items_8h.html#6dbe6563ec31d94fa0b163216b5d466b">01451</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#6dbe6563ec31d94fa0b163216b5d466b">HandleSoldierThrowItem</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo )
<a name="l01452"></a>01452 {
<a name="l01453"></a>01453       <span class="comment">// Determine what to do</span>
<a name="l01454"></a>01454       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubDirection;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456       <span class="comment">// Set attacker to NOBODY, since it's not a combat attack</span>
<a name="l01457"></a>01457       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f9fbe88de500cfce55e233298ada29e4">ubTargetID</a> = NOBODY;
<a name="l01458"></a>01458 
<a name="l01459"></a>01459       <span class="comment">// Alrighty, switch based on stance!</span>
<a name="l01460"></a>01460       <span class="keywordflow">switch</span>( <a class="code" href="Animation_01Control_8cpp.html#633440a87c34a25c700ce620db87d036">gAnimControl</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1f73b62a5ea0dd26fa1bec1d9f522b41">usAnimState</a> ].ubHeight )
<a name="l01461"></a>01461       {
<a name="l01462"></a>01462             <span class="keywordflow">case</span> ANIM_STAND:
<a name="l01463"></a>01463 
<a name="l01464"></a>01464                   <span class="comment">// CHECK IF WE ARE NOT ON THE SAME GRIDNO</span>
<a name="l01465"></a>01465                   <span class="keywordflow">if</span> ( sGridNo == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> )
<a name="l01466"></a>01466                   {
<a name="l01467"></a>01467                         <a class="code" href="Soldier_01Control_8cpp.html#dcf34ad19a0735490cbf7445df7276d6">PickDropItemAnimation</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01468"></a>01468                   }
<a name="l01469"></a>01469                   <span class="keywordflow">else</span>
<a name="l01470"></a>01470                   {
<a name="l01471"></a>01471                         <span class="comment">// CHANGE DIRECTION AT LEAST</span>
<a name="l01472"></a>01472                         ubDirection = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="Soldier_01Control_8cpp.html#1d7b6c103ede7e551e76eef2ef173f9b">GetDirectionFromGridNo</a>( sGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01473"></a>01473 
<a name="l01474"></a>01474                         <a class="code" href="Soldier_01Control_8cpp.html#abb661aaf102cd9417e7e4991838e63a">SoldierGotoStationaryStance</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01475"></a>01475 
<a name="l01476"></a>01476                         <a class="code" href="Soldier_01Control_8cpp.html#019f893295bb96f48261ded184a17cab">EVENT_SetSoldierDesiredDirection</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubDirection );
<a name="l01477"></a>01477                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#4e43480af5296b43cb574f6e57983921">fTurningUntilDone</a> = TRUE;
<a name="l01478"></a>01478 
<a name="l01479"></a>01479                         <span class="comment">// Draw item depending on distance from buddy</span>
<a name="l01480"></a>01480                         <span class="keywordflow">if</span> ( <a class="code" href="Isometric_01Utils_8cpp.html#65702ddcdaa0f3db6014ed56d6087d98">GetRangeFromGridNoDiff</a>( sGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ) &lt; MIN_LOB_RANGE )
<a name="l01481"></a>01481                         {
<a name="l01482"></a>01482                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#10dcc042f40b20751530663b0bbbe289">usPendingAnimation</a> = <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2ebe770d84586f3a0300555bcd7f43dfade">LOB_ITEM</a>;
<a name="l01483"></a>01483                         }
<a name="l01484"></a>01484                         <span class="keywordflow">else</span>
<a name="l01485"></a>01485                         {
<a name="l01486"></a>01486                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#10dcc042f40b20751530663b0bbbe289">usPendingAnimation</a> = <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb86e9b3d04759407660c2707fb8c5536d">THROW_ITEM</a>;
<a name="l01487"></a>01487                         }     
<a name="l01488"></a>01488 
<a name="l01489"></a>01489                   }
<a name="l01490"></a>01490                   <span class="keywordflow">break</span>;
<a name="l01491"></a>01491 
<a name="l01492"></a>01492             <span class="keywordflow">case</span> ANIM_CROUCH:
<a name="l01493"></a>01493             <span class="keywordflow">case</span> ANIM_PRONE:
<a name="l01494"></a>01494 
<a name="l01495"></a>01495                   <span class="comment">// CHECK IF WE ARE NOT ON THE SAME GRIDNO</span>
<a name="l01496"></a>01496                   <span class="keywordflow">if</span> ( sGridNo == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> )
<a name="l01497"></a>01497                   {
<a name="l01498"></a>01498                         <span class="comment">// OK, JUST DROP ITEM!</span>
<a name="l01499"></a>01499                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> != NULL )
<a name="l01500"></a>01500                         {
<a name="l01501"></a>01501                               <a class="code" href="Handle_01Items_8cpp.html#ca7f6f6da97e9a4c2b737296485f5c84">AddItemToPool</a>( sGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a>, 1, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, 0, -1 );
<a name="l01502"></a>01502                               <a class="code" href="Handle_01Items_8cpp.html#ef92c00fc5ad51b4a9064e4a09d59492">NotifySoldiersToLookforItems</a>( );
<a name="l01503"></a>01503 
<a name="l01504"></a>01504                               MemFree( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> );
<a name="l01505"></a>01505                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> = NULL;
<a name="l01506"></a>01506                         }
<a name="l01507"></a>01507                   }
<a name="l01508"></a>01508                   <span class="keywordflow">else</span>
<a name="l01509"></a>01509                   {
<a name="l01510"></a>01510                         <span class="comment">// OK, go from prone/crouch to stand first!</span>
<a name="l01511"></a>01511                         ubDirection = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="Soldier_01Control_8cpp.html#1d7b6c103ede7e551e76eef2ef173f9b">GetDirectionFromGridNo</a>( sGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01512"></a>01512                         <a class="code" href="Soldier_01Control_8cpp.html#019f893295bb96f48261ded184a17cab">EVENT_SetSoldierDesiredDirection</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubDirection );
<a name="l01513"></a>01513 
<a name="l01514"></a>01514                         <a class="code" href="Soldier_01Control_8cpp.html#6f191e00fb4f3c5e2cbe762aa402a420">ChangeSoldierState</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb86e9b3d04759407660c2707fb8c5536d">THROW_ITEM</a>, 0 , FALSE );
<a name="l01515"></a>01515                   }
<a name="l01516"></a>01516       }
<a name="l01517"></a>01517 
<a name="l01518"></a>01518 }
<a name="l01519"></a>01519 
<a name="l01520"></a>01520 
<a name="l01521"></a><a class="code" href="Handle_01Items_8h.html#38fa877956cab6d1b458501aeeb8c71e">01521</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#38fa877956cab6d1b458501aeeb8c71e">SoldierGiveItem</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pTargetSoldier, <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *pObject, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bInvPos )
<a name="l01522"></a>01522 {
<a name="l01523"></a>01523       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sActionGridNo, sAdjustedGridNo;
<a name="l01524"></a>01524       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubDirection;
<a name="l01525"></a>01525 
<a name="l01526"></a>01526        <span class="comment">// Remove any previous actions</span>
<a name="l01527"></a>01527        <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a>           = NO_PENDING_ACTION;
<a name="l01528"></a>01528 
<a name="l01529"></a>01529        <span class="comment">// See if we can get there to stab </span>
<a name="l01530"></a>01530        sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, &amp;ubDirection, &amp;sAdjustedGridNo, TRUE, FALSE );
<a name="l01531"></a>01531        <span class="keywordflow">if</span> ( sActionGridNo != -1 )
<a name="l01532"></a>01532        {
<a name="l01533"></a>01533                   <span class="comment">// SEND PENDING ACTION</span>
<a name="l01534"></a>01534                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a> = <a class="code" href="Soldier_01Control_8h.html#72e63dc1307b88cc08ad0bd6c737d748ee8ec3a7c2148813904ea3de8aae0516">MERC_GIVEITEM</a>;
<a name="l01535"></a>01535 
<a name="l01536"></a>01536                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2b57262d84965c3e6e984fa416813053">bPendingActionData5</a> = bInvPos;  
<a name="l01537"></a>01537                   <span class="comment">// Copy temp object</span>
<a name="l01538"></a>01538                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a>   = (<a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *)MemAlloc( <span class="keyword">sizeof</span>( <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> ) );
<a name="l01539"></a>01539                   memcpy( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a>, pObject, <span class="keyword">sizeof</span>( OBJECTTYPE ) );
<a name="l01540"></a>01540 
<a name="l01541"></a>01541 
<a name="l01542"></a>01542                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>;
<a name="l01543"></a>01543                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>  = ubDirection;
<a name="l01544"></a>01544                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#304094e7d2a05131c34f41c46dfb6fad">uiPendingActionData4</a> = pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>;
<a name="l01545"></a>01545                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c5862a2a33a904c612ca884a799ac0c2">ubPendingActionAnimCount</a> = 0;
<a name="l01546"></a>01546 
<a name="l01547"></a>01547                   <span class="comment">// Set soldier as engaged!</span>
<a name="l01548"></a>01548                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> |= SOLDIER_ENGAGEDINACTION;
<a name="l01549"></a>01549 
<a name="l01550"></a>01550                   <span class="comment">// CHECK IF WE ARE AT THIS GRIDNO NOW</span>
<a name="l01551"></a>01551                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != sActionGridNo )
<a name="l01552"></a>01552                   {
<a name="l01553"></a>01553                         <span class="comment">// WALK UP TO DEST FIRST</span>
<a name="l01554"></a>01554                         <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, pSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, FALSE, TRUE );
<a name="l01555"></a>01555                   }
<a name="l01556"></a>01556                   <span class="keywordflow">else</span>
<a name="l01557"></a>01557                   {
<a name="l01558"></a>01558                         <a class="code" href="Soldier_01Control_8cpp.html#a1de2ff9ec55ad546d8f794965191f7a">EVENT_SoldierBeginGiveItem</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01559"></a>01559                     <span class="comment">// CHANGE DIRECTION OF TARGET TO OPPOSIDE DIRECTION!</span>
<a name="l01560"></a>01560                     <a class="code" href="Soldier_01Control_8cpp.html#019f893295bb96f48261ded184a17cab">EVENT_SetSoldierDesiredDirection</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubDirection );
<a name="l01561"></a>01561                   }
<a name="l01562"></a>01562 
<a name="l01563"></a>01563                   <span class="comment">// Set target as engaged!</span>
<a name="l01564"></a>01564                   pTargetSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> |= SOLDIER_ENGAGEDINACTION;
<a name="l01565"></a>01565 
<a name="l01566"></a>01566                   <span class="keywordflow">return</span>;
<a name="l01567"></a>01567        }
<a name="l01568"></a>01568        <span class="keywordflow">else</span>
<a name="l01569"></a>01569        {
<a name="l01570"></a>01570                   <span class="keywordflow">return</span>;
<a name="l01571"></a>01571        }
<a name="l01572"></a>01572 }
<a name="l01573"></a>01573 
<a name="l01574"></a><a class="code" href="Handle_01Items_8h.html#111790bb92964b77cc5bfe36df277cc7">01574</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#111790bb92964b77cc5bfe36df277cc7">SoldierDropItem</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> * pObj )
<a name="l01575"></a>01575 {
<a name="l01576"></a>01576       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> = (<a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *)MemAlloc( <span class="keyword">sizeof</span>( <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> ) );
<a name="l01577"></a>01577       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> == NULL)
<a name="l01578"></a>01578       {
<a name="l01579"></a>01579             <span class="comment">// OUT OF MEMORY! YIKES!</span>
<a name="l01580"></a>01580             <span class="keywordflow">return</span>( FALSE );
<a name="l01581"></a>01581       }
<a name="l01582"></a>01582       memcpy( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a>, pObj, <span class="keyword">sizeof</span>( OBJECTTYPE ) );
<a name="l01583"></a>01583       <a class="code" href="Soldier_01Control_8cpp.html#dcf34ad19a0735490cbf7445df7276d6">PickDropItemAnimation</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01584"></a>01584       <span class="keywordflow">return</span>( TRUE );
<a name="l01585"></a>01585 }
<a name="l01586"></a>01586 
<a name="l01587"></a><a class="code" href="Handle_01Items_8h.html#728ea1023712f480f0da436aa99be631">01587</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#728ea1023712f480f0da436aa99be631">SoldierPickupItem</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iItemIndex, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bZLevel )
<a name="l01588"></a>01588 {
<a name="l01589"></a>01589       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                     sActionGridNo;
<a name="l01590"></a>01590 
<a name="l01591"></a>01591       <span class="comment">// Remove any previous actions</span>
<a name="l01592"></a>01592       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a>            = NO_PENDING_ACTION;
<a name="l01593"></a>01593 
<a name="l01594"></a>01594       sActionGridNo = <a class="code" href="Handle_01Items_8cpp.html#29f9b6fb69c5f31798d6d5924f22edd5">AdjustGridNoForItemPlacement</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sGridNo );
<a name="l01595"></a>01595 
<a name="l01596"></a>01596       <span class="comment">// SET PENDING ACTIONS!</span>
<a name="l01597"></a>01597       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#77e9ca91b8a5b17fdc0acb99901cbdad">ubPendingAction</a> = <a class="code" href="Soldier_01Control_8h.html#72e63dc1307b88cc08ad0bd6c737d7480bc2d24bac5cc5d8d57ac744a75cc4cb">MERC_PICKUPITEM</a>;
<a name="l01598"></a>01598       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#a69215f405f59c8085b3bb27f76893c3">uiPendingActionData1</a> = iItemIndex;
<a name="l01599"></a>01599       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>  = sActionGridNo;
<a name="l01600"></a>01600       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#304094e7d2a05131c34f41c46dfb6fad">uiPendingActionData4</a> = sGridNo;
<a name="l01601"></a>01601       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>  = bZLevel;
<a name="l01602"></a>01602       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c5862a2a33a904c612ca884a799ac0c2">ubPendingActionAnimCount</a> = 0;
<a name="l01603"></a>01603 
<a name="l01604"></a>01604       <span class="comment">// Deduct points!</span>
<a name="l01605"></a>01605       <span class="comment">//sAPCost = GetAPsToPickupItem( pSoldier, sGridNo );</span>
<a name="l01606"></a>01606       <span class="comment">//DeductPoints( pSoldier, sAPCost, 0 );</span>
<a name="l01607"></a>01607       <a class="code" href="Handle_01UI_8cpp.html#738fcf0207cfe6fed8ddaf00710f3d32">SetUIBusy</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l01608"></a>01608 
<a name="l01609"></a>01609       <span class="comment">// CHECK IF NOT AT SAME GRIDNO</span>
<a name="l01610"></a>01610       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != sActionGridNo )
<a name="l01611"></a>01611       {
<a name="l01612"></a>01612             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> )
<a name="l01613"></a>01613             {
<a name="l01614"></a>01614                   <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, pSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, TRUE, TRUE );
<a name="l01615"></a>01615 
<a name="l01616"></a>01616                   <span class="comment">// Say it only if we don;t have to go too far!</span>
<a name="l01617"></a>01617                   <span class="keywordflow">if</span> ( pSoldier-&gt;usPathDataSize &gt; 5 )
<a name="l01618"></a>01618                   {
<a name="l01619"></a>01619                         <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>(  pSoldier, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0ad438cfef4495b2df34f8dbe552dcdd4c">BATTLE_SOUND_OK1</a> );
<a name="l01620"></a>01620                   }
<a name="l01621"></a>01621             }
<a name="l01622"></a>01622             <span class="keywordflow">else</span>
<a name="l01623"></a>01623             {
<a name="l01624"></a>01624                   <a class="code" href="Soldier_01Control_8cpp.html#18904ef0a19715b48802e43dcbff5b89">EVENT_InternalGetNewSoldierPath</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sActionGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#28f15074956f36e3933f6cc10647eacf">usUIMovementMode</a>, FALSE, TRUE );
<a name="l01625"></a>01625             }
<a name="l01626"></a>01626       }           
<a name="l01627"></a>01627       <span class="keywordflow">else</span>
<a name="l01628"></a>01628       {
<a name="l01629"></a>01629             <span class="comment">// DO ANIMATION OF PICKUP NOW!</span>
<a name="l01630"></a>01630             <a class="code" href="Soldier_01Control_8cpp.html#9056bb17e1031268a46b6be6d7a9d180">PickPickupAnimation</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#a69215f405f59c8085b3bb27f76893c3">uiPendingActionData1</a>, (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#304094e7d2a05131c34f41c46dfb6fad">uiPendingActionData4</a> ), <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a> );
<a name="l01631"></a>01631       }
<a name="l01632"></a>01632 
<a name="l01633"></a>01633 }
<a name="l01634"></a>01634 
<a name="l01635"></a>01635 
<a name="l01636"></a><a class="code" href="Handle_01Items_8cpp.html#76744989c52d69147a41eb8690e8d8a7">01636</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#76744989c52d69147a41eb8690e8d8a7">HandleAutoPlaceFail</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iItemIndex, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo )
<a name="l01637"></a>01637 {
<a name="l01638"></a>01638       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a>)
<a name="l01639"></a>01639       {
<a name="l01640"></a>01640             <span class="comment">// Place it in buddy's hand!</span>
<a name="l01641"></a>01641             <span class="keywordflow">if</span> ( <a class="code" href="Map_01Screen_01Interface_01Map_01Inventory_8cpp.html#a338c4e51d4834e0388d319683afe422">gpItemPointer</a> == NULL )
<a name="l01642"></a>01642             {
<a name="l01643"></a>01643                   <a class="code" href="Interface_01Items_8cpp.html#b31e187f27da1dc1bcabbb13a7221734">InternalBeginItemPointer</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;(<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iItemIndex ].o ), NO_SLOT );
<a name="l01644"></a>01644             }
<a name="l01645"></a>01645             <span class="keywordflow">else</span>
<a name="l01646"></a>01646             {
<a name="l01647"></a>01647                   <span class="comment">// Add back to world...</span>
<a name="l01648"></a>01648                   <a class="code" href="Handle_01Items_8cpp.html#ca7f6f6da97e9a4c2b737296485f5c84">AddItemToPool</a>( sGridNo, &amp;(<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iItemIndex ].o ), 1 , <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, 0, -1 );
<a name="l01649"></a>01649 
<a name="l01650"></a>01650                   <span class="comment">// If we are a merc, say DAMN quote....</span>
<a name="l01651"></a>01651                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> )
<a name="l01652"></a>01652                   {
<a name="l01653"></a>01653                         <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0aa5a3b5d825d15837f5c41acc1031f4b0">BATTLE_SOUND_CURSE1</a> );
<a name="l01654"></a>01654                   }
<a name="l01655"></a>01655             }
<a name="l01656"></a>01656       }
<a name="l01657"></a>01657 }
<a name="l01658"></a>01658 
<a name="l01659"></a><a class="code" href="Handle_01Items_8h.html#837432bbd14f9db90acea2b3bcaef5dc">01659</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#837432bbd14f9db90acea2b3bcaef5dc">SoldierGetItemFromWorld</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iItemIndex, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bZLevel, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> *pfSelectionList )
<a name="l01660"></a>01660 {
<a name="l01661"></a>01661       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *           pItemPool;
<a name="l01662"></a>01662       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *           pItemPoolToDelete = NULL;
<a name="l01663"></a>01663       <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a>              Object;
<a name="l01664"></a>01664       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                               cnt = 0;
<a name="l01665"></a>01665       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                             fPickup;
<a name="l01666"></a>01666       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                             fFailedAutoPlace = FALSE;
<a name="l01667"></a>01667       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                               iItemIndexToDelete;
<a name="l01668"></a>01668       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                             fShouldSayCoolQuote = FALSE;
<a name="l01669"></a>01669       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                             fDidSayCoolQuote = FALSE;
<a name="l01670"></a>01670   <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>         fSaidBoobyTrapQuote = FALSE;
<a name="l01671"></a>01671 
<a name="l01672"></a>01672       <span class="comment">// OK. CHECK IF WE ARE DOING ALL IN THIS POOL....</span>
<a name="l01673"></a>01673       <span class="keywordflow">if</span> ( iItemIndex == ITEM_PICKUP_ACTION_ALL || iItemIndex == ITEM_PICKUP_SELECTION )
<a name="l01674"></a>01674       {
<a name="l01675"></a>01675             <span class="comment">// DO all pickup!</span>
<a name="l01676"></a>01676             <span class="comment">// LOOP THROUGH LIST TO FIND NODE WE WANT</span>
<a name="l01677"></a>01677             <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l01678"></a>01678 
<a name="l01679"></a>01679             <span class="keywordflow">while</span>( pItemPool )
<a name="l01680"></a>01680             {
<a name="l01681"></a>01681                   <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#0a41cd226d7b2ce19b27e23f3419922c">ItemPoolOKForPickup</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, pItemPool, bZLevel ) )
<a name="l01682"></a>01682                   {
<a name="l01683"></a>01683                         fPickup = TRUE;
<a name="l01684"></a>01684 
<a name="l01685"></a>01685                         <span class="keywordflow">if</span> ( iItemIndex == ITEM_PICKUP_SELECTION )
<a name="l01686"></a>01686                         {
<a name="l01687"></a>01687                               <span class="keywordflow">if</span> ( !pfSelectionList[ cnt ] )
<a name="l01688"></a>01688                               {
<a name="l01689"></a>01689                                     fPickup = FALSE;
<a name="l01690"></a>01690                               }
<a name="l01691"></a>01691                         }
<a name="l01692"></a>01692                                     
<a name="l01693"></a>01693                         <span class="comment">// Increment counter...</span>
<a name="l01694"></a>01694                         <span class="comment">//:ATE: Only incremrnt counter for items we can see..</span>
<a name="l01695"></a>01695                         cnt++;
<a name="l01696"></a>01696 
<a name="l01697"></a>01697                         <span class="keywordflow">if</span> ( fPickup )
<a name="l01698"></a>01698                         {
<a name="l01699"></a>01699                               <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#91ef9b366fe4c09b75bfe1e16c3f63b5">ContinuePastBoobyTrap</a>( pSoldier, sGridNo, bZLevel, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, FALSE, &amp;fSaidBoobyTrapQuote ) )
<a name="l01700"></a>01700                               {
<a name="l01701"></a>01701                                     <span class="comment">// Make copy of item</span>
<a name="l01702"></a>01702                                     memcpy( &amp;Object, &amp;(<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o), <span class="keyword">sizeof</span>( <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> ) );
<a name="l01703"></a>01703 
<a name="l01704"></a>01704                                     <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#c4c488e0463a2f8e01ab74ba02fb9f15">ItemIsCool</a>( &amp;Object ) )
<a name="l01705"></a>01705                                     {
<a name="l01706"></a>01706                                           fShouldSayCoolQuote = TRUE;
<a name="l01707"></a>01707                                     }
<a name="l01708"></a>01708 
<a name="l01709"></a>01709                                     <span class="keywordflow">if</span> (Object.usItem == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f453396ea1193548270407675ea4eeee2b">SWITCH</a>)
<a name="l01710"></a>01710                                     {
<a name="l01711"></a>01711                                           <span class="comment">// ask about activating the switch!</span>
<a name="l01712"></a>01712                                           <a class="code" href="Handle_01Items_8cpp.html#57d4fe8bcf106c822f1ac63008a4f28d">bTempFrequency</a> = Object.bFrequency;
<a name="l01713"></a>01713                                           <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a> = pSoldier;
<a name="l01714"></a>01714                                           <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28edfaaee6cf60e9dcec27ec0650dbbc39f">MSG_BOX_BASIC_STYLE</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe726815a4106839c5967c0c58de4eafe15">ACTIVATE_SWITCH_PROMPT</a> ] , <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf29873e16bc1530dedb416060abbeea6d0">GAME_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_YESNO, <a class="code" href="Handle_01Items_8cpp.html#ee52aafb872bfd335e0c54fedaa2e128">SwitchMessageBoxCallBack</a>, NULL );
<a name="l01715"></a>01715                                           pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l01716"></a>01716                                     }
<a name="l01717"></a>01717                                     <span class="keywordflow">else</span>
<a name="l01718"></a>01718                                     {
<a name="l01719"></a>01719                                           <span class="keywordflow">if</span> ( !<a class="code" href="Items_8cpp.html#b0cdccd7f510d5464ab386cb5b69c28f">AutoPlaceObject</a>( pSoldier, &amp;Object, TRUE ) )
<a name="l01720"></a>01720                                           {
<a name="l01721"></a>01721                                                 <span class="comment">// check to see if the object has been swapped with one in inventory</span>
<a name="l01722"></a>01722                                                 <span class="keywordflow">if</span> ( Object.usItem != <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.usItem || Object.ubNumberOfObjects != <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.ubNumberOfObjects )
<a name="l01723"></a>01723                                                 {
<a name="l01724"></a>01724                                                       <span class="comment">// copy back because item changed, and we must make sure the item pool reflects this.</span>
<a name="l01725"></a>01725                                                       memcpy( &amp;(<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o), &amp;Object, <span class="keyword">sizeof</span>( OBJECTTYPE ) );
<a name="l01726"></a>01726                                                 }
<a name="l01727"></a>01727 
<a name="l01728"></a>01728                                                 pItemPoolToDelete = pItemPool;
<a name="l01729"></a>01729                                                 pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l01730"></a>01730                                                 fFailedAutoPlace = TRUE;
<a name="l01731"></a>01731                                                 <span class="comment">// continue, to try and place ay others...</span>
<a name="l01732"></a>01732                                                 <span class="keywordflow">continue</span>;
<a name="l01733"></a>01733                                           }
<a name="l01734"></a>01734                                           <span class="comment">/*</span>
<a name="l01735"></a>01735 <span class="comment">                                          // handle theft.. will return true if theft has failed ( if soldier was caught )</span>
<a name="l01736"></a>01736 <span class="comment">                                          if( pSoldier-&gt;bTeam == OUR_TEAM )</span>
<a name="l01737"></a>01737 <span class="comment">                                          {</span>
<a name="l01738"></a>01738 <span class="comment">                                                // check to see if object was owned by another</span>
<a name="l01739"></a>01739 <span class="comment">                                                if( Object.fFlags &amp; OBJECT_OWNED_BY_CIVILIAN )</span>
<a name="l01740"></a>01740 <span class="comment">                                                {</span>
<a name="l01741"></a>01741 <span class="comment">                                                      // owned by a civilian</span>
<a name="l01742"></a>01742 <span class="comment">                                                      if( HandleLoyaltyAdjustmentForRobbery( pSoldier ) == TRUE )</span>
<a name="l01743"></a>01743 <span class="comment">                                                      {</span>
<a name="l01744"></a>01744 <span class="comment">                                                            // implememnt actual tactical reaction for theft..shoot robber, yell out, etc</span>
<a name="l01745"></a>01745 <span class="comment">                                                      }</span>
<a name="l01746"></a>01746 <span class="comment"></span>
<a name="l01747"></a>01747 <span class="comment">                                                      // reset who owns object</span>
<a name="l01748"></a>01748 <span class="comment">                                                      Object.fFlags &amp;= ~( OBJECT_OWNED_BY_CIVILIAN );</span>
<a name="l01749"></a>01749 <span class="comment">                                                }</span>
<a name="l01750"></a>01750 <span class="comment">                                          }</span>
<a name="l01751"></a>01751 <span class="comment">                                          */</span>
<a name="l01752"></a>01752 
<a name="l01753"></a>01753                                           <span class="comment">//pItemPoolToDelete = pItemPool;</span>
<a name="l01754"></a>01754                                           iItemIndexToDelete = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>;
<a name="l01755"></a>01755                                           pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l01756"></a>01756                                           <a class="code" href="Handle_01Items_8cpp.html#e60fbe0d27199e2f0c08121214fd7306">RemoveItemFromPool</a>( sGridNo, iItemIndexToDelete, pSoldier-&gt;bLevel );
<a name="l01757"></a>01757                                     }
<a name="l01758"></a>01758                               }
<a name="l01759"></a>01759                               <span class="keywordflow">else</span>
<a name="l01760"></a>01760                               {
<a name="l01761"></a>01761                                     <span class="comment">// boobytrap found... stop picking up things!</span>
<a name="l01762"></a>01762                                     <span class="keywordflow">break</span>;
<a name="l01763"></a>01763                               }
<a name="l01764"></a>01764                         }
<a name="l01765"></a>01765                         <span class="keywordflow">else</span>
<a name="l01766"></a>01766                         {
<a name="l01767"></a>01767                               pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l01768"></a>01768                         }
<a name="l01769"></a>01769                   }
<a name="l01770"></a>01770                   <span class="keywordflow">else</span>
<a name="l01771"></a>01771                   {
<a name="l01772"></a>01772                         pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l01773"></a>01773                   }
<a name="l01774"></a>01774             }
<a name="l01775"></a>01775 
<a name="l01776"></a>01776             <span class="comment">// ATE; If here, and we failed to add any more stuff, put failed one in our cursor...</span>
<a name="l01777"></a>01777             <span class="keywordflow">if</span> ( pItemPoolToDelete != NULL &amp;&amp; fFailedAutoPlace )
<a name="l01778"></a>01778             {
<a name="l01779"></a>01779                   <a class="code" href="Handle_01Items_8cpp.html#b2107f877c6241f423b9c1c443966fbe">gfDontChargeAPsToPickup</a> = TRUE;
<a name="l01780"></a>01780                   <a class="code" href="Handle_01Items_8cpp.html#76744989c52d69147a41eb8690e8d8a7">HandleAutoPlaceFail</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, pItemPoolToDelete-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, sGridNo );
<a name="l01781"></a>01781                   <a class="code" href="Handle_01Items_8cpp.html#e60fbe0d27199e2f0c08121214fd7306">RemoveItemFromPool</a>( sGridNo, pItemPoolToDelete-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l01782"></a>01782                   pItemPoolToDelete = NULL;
<a name="l01783"></a>01783             }
<a name="l01784"></a>01784       }
<a name="l01785"></a>01785       <span class="keywordflow">else</span>
<a name="l01786"></a>01786       {
<a name="l01787"></a>01787             <span class="comment">// REMOVE ITEM FROM POOL</span>
<a name="l01788"></a>01788             <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#296963c365c156859be03ab5e8c204d5">ItemExistsAtLocation</a>( sGridNo, iItemIndex, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> ) )
<a name="l01789"></a>01789             {     
<a name="l01790"></a>01790 
<a name="l01791"></a>01791                   <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#91ef9b366fe4c09b75bfe1e16c3f63b5">ContinuePastBoobyTrap</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sGridNo, bZLevel, iItemIndex, FALSE, &amp;fSaidBoobyTrapQuote ) )
<a name="l01792"></a>01792                   {
<a name="l01793"></a>01793 
<a name="l01794"></a>01794                         <span class="comment">// Make copy of item</span>
<a name="l01795"></a>01795                         memcpy( &amp;Object, &amp;(<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iItemIndex ].o), <span class="keyword">sizeof</span>( <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> ) );
<a name="l01796"></a>01796 
<a name="l01797"></a>01797                         <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#c4c488e0463a2f8e01ab74ba02fb9f15">ItemIsCool</a>( &amp;Object ) )
<a name="l01798"></a>01798                         {
<a name="l01799"></a>01799                               fShouldSayCoolQuote = TRUE;
<a name="l01800"></a>01800                         }
<a name="l01801"></a>01801 
<a name="l01802"></a>01802                         <span class="keywordflow">if</span> (Object.usItem == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f453396ea1193548270407675ea4eeee2b">SWITCH</a>)
<a name="l01803"></a>01803                         {
<a name="l01804"></a>01804                               <span class="comment">// handle switch</span>
<a name="l01805"></a>01805                               <a class="code" href="Handle_01Items_8cpp.html#57d4fe8bcf106c822f1ac63008a4f28d">bTempFrequency</a> = Object.bFrequency;
<a name="l01806"></a>01806                               <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l01807"></a>01807                               <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28edfaaee6cf60e9dcec27ec0650dbbc39f">MSG_BOX_BASIC_STYLE</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe726815a4106839c5967c0c58de4eafe15">ACTIVATE_SWITCH_PROMPT</a> ], <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf29873e16bc1530dedb416060abbeea6d0">GAME_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_YESNO, <a class="code" href="Handle_01Items_8cpp.html#ee52aafb872bfd335e0c54fedaa2e128">SwitchMessageBoxCallBack</a>, NULL );
<a name="l01808"></a>01808                         }
<a name="l01809"></a>01809                         <span class="keywordflow">else</span>
<a name="l01810"></a>01810                         {
<a name="l01811"></a>01811 <span class="comment">/*</span>
<a name="l01812"></a>01812 <span class="comment">                              // handle theft.. will return true if theft has failed ( if soldier was caught )</span>
<a name="l01813"></a>01813 <span class="comment">                              if( pSoldier-&gt;bTeam == OUR_TEAM )</span>
<a name="l01814"></a>01814 <span class="comment">                              {</span>
<a name="l01815"></a>01815 <span class="comment">                                    // check to see if object was owned by another</span>
<a name="l01816"></a>01816 <span class="comment">                                    if( Object.fFlags &amp; OBJECT_OWNED_BY_CIVILIAN )</span>
<a name="l01817"></a>01817 <span class="comment">                                    {</span>
<a name="l01818"></a>01818 <span class="comment">                                          // owned by a civilian</span>
<a name="l01819"></a>01819 <span class="comment">                                          if( HandleLoyaltyAdjustmentForRobbery( pSoldier ) == TRUE )</span>
<a name="l01820"></a>01820 <span class="comment">                                          {</span>
<a name="l01821"></a>01821 <span class="comment">                                                // implememnt actual tactical reaction for theft..shoot robber, yell out, etc</span>
<a name="l01822"></a>01822 <span class="comment">                                          }</span>
<a name="l01823"></a>01823 <span class="comment"></span>
<a name="l01824"></a>01824 <span class="comment">                                          // reset who owns object</span>
<a name="l01825"></a>01825 <span class="comment">                                          Object.fFlags &amp;= ~( OBJECT_OWNED_BY_CIVILIAN );</span>
<a name="l01826"></a>01826 <span class="comment">                                    }</span>
<a name="l01827"></a>01827 <span class="comment">                              }</span>
<a name="l01828"></a>01828 <span class="comment">*/</span>
<a name="l01829"></a>01829                               <a class="code" href="Handle_01Items_8cpp.html#e60fbe0d27199e2f0c08121214fd7306">RemoveItemFromPool</a>( sGridNo, iItemIndex, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l01830"></a>01830 
<a name="l01831"></a>01831                               <span class="keywordflow">if</span> ( !<a class="code" href="Items_8cpp.html#b0cdccd7f510d5464ab386cb5b69c28f">AutoPlaceObject</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;(<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iItemIndex ].o ), TRUE ) )
<a name="l01832"></a>01832                               {
<a name="l01833"></a>01833                                     <a class="code" href="Handle_01Items_8cpp.html#b2107f877c6241f423b9c1c443966fbe">gfDontChargeAPsToPickup</a> = TRUE;
<a name="l01834"></a>01834                                     <a class="code" href="Handle_01Items_8cpp.html#76744989c52d69147a41eb8690e8d8a7">HandleAutoPlaceFail</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, iItemIndex, sGridNo );
<a name="l01835"></a>01835                               }
<a name="l01836"></a>01836                         }
<a name="l01837"></a>01837 
<a name="l01838"></a>01838                   }
<a name="l01839"></a>01839             }
<a name="l01840"></a>01840       }
<a name="l01841"></a>01841 
<a name="l01842"></a>01842       <span class="comment">// OK, check if potentially a good candidate for cool quote</span>
<a name="l01843"></a>01843       <span class="keywordflow">if</span> ( fShouldSayCoolQuote &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> )
<a name="l01844"></a>01844       {
<a name="l01845"></a>01845             <span class="comment">// Do we have this quote..?</span>
<a name="l01846"></a>01846             <span class="keywordflow">if</span> ( <a class="code" href="QARRAY_8cpp.html#e93c954f0ec074dec2f9c4fc087ee1d2">QuoteExp_GotGunOrUsedGun</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ] == <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a299631003e4ebffc7bc4d55a2dda380ad4">QUOTE_FOUND_SOMETHING_SPECIAL</a> )
<a name="l01847"></a>01847             {
<a name="l01848"></a>01848                   <span class="comment">// Have we not said it today?</span>
<a name="l01849"></a>01849                   <span class="keywordflow">if</span> ( !( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#460d1be0d96ad07ca098aaf7986bf0ec">usQuoteSaidFlags</a> &amp; SOLDIER_QUOTE_SAID_FOUND_SOMETHING_NICE ) )
<a name="l01850"></a>01850                   {
<a name="l01851"></a>01851                         <span class="comment">// set flag</span>
<a name="l01852"></a>01852                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#460d1be0d96ad07ca098aaf7986bf0ec">usQuoteSaidFlags</a> |= SOLDIER_QUOTE_SAID_FOUND_SOMETHING_NICE;
<a name="l01853"></a>01853 
<a name="l01854"></a>01854                         <span class="comment">// Say it....</span>
<a name="l01855"></a>01855                         <span class="comment">// We've found something!</span>
<a name="l01856"></a>01856                         <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a299631003e4ebffc7bc4d55a2dda380ad4">QUOTE_FOUND_SOMETHING_SPECIAL</a> );
<a name="l01857"></a>01857 
<a name="l01858"></a>01858                         fDidSayCoolQuote = TRUE;
<a name="l01859"></a>01859                   }
<a name="l01860"></a>01860             }
<a name="l01861"></a>01861       }
<a name="l01862"></a>01862 
<a name="l01863"></a>01863       <span class="comment">// Aknowledge....</span>
<a name="l01864"></a>01864       <span class="keywordflow">if</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == OUR_TEAM &amp;&amp; !fDidSayCoolQuote &amp;&amp; !fSaidBoobyTrapQuote )
<a name="l01865"></a>01865       {
<a name="l01866"></a>01866             <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0aaaf686dad633392af1290eb32e6713c8">BATTLE_SOUND_GOTIT</a> );
<a name="l01867"></a>01867       }
<a name="l01868"></a>01868 
<a name="l01869"></a>01869 
<a name="l01870"></a>01870       <span class="comment">// OK partner......look for any hidden items!</span>
<a name="l01871"></a>01871       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> &amp;&amp; <a class="code" href="Handle_01Items_8cpp.html#6c2195cfbb74917a3ac007e94623797e">LookForHiddenItems</a>( sGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, TRUE, 0 ) )
<a name="l01872"></a>01872       {
<a name="l01873"></a>01873         <span class="comment">// WISDOM GAIN (5):  Found a hidden object</span>
<a name="l01874"></a>01874     <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, WISDOMAMT, 5, FALSE );
<a name="l01875"></a>01875 
<a name="l01876"></a>01876             <span class="comment">// We've found something!</span>
<a name="l01877"></a>01877             <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)( <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a2911e21c67ced28112703054171ee2b7f4">QUOTE_SPOTTED_SOMETHING_ONE</a> + <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 2 ) ) );
<a name="l01878"></a>01878       }
<a name="l01879"></a>01879 
<a name="l01880"></a>01880       <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l01881"></a>01881       <a class="code" href="Handle_01Items_8cpp.html#2a4f3638cd7bc6c7361fbb6f14de1114">gsTempGridno</a> = sGridNo;
<a name="l01882"></a>01882       <a class="code" href="Timer_01Control_8cpp.html#ea6ae1cc206c97b220fafdb86bf158e5">SetCustomizableTimerCallbackAndDelay</a>( 1000, <a class="code" href="Handle_01Items_8cpp.html#7756ad997efa08df951c7de26ea6d50d">CheckForPickedOwnership</a>, TRUE );
<a name="l01883"></a>01883 }
<a name="l01884"></a>01884 
<a name="l01885"></a>01885 
<a name="l01886"></a><a class="code" href="Handle_01Items_8h.html#3dcfa407aea2f357ad73ea11f00192aa">01886</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#3dcfa407aea2f357ad73ea11f00192aa">HandleSoldierPickupItem</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iItemIndex, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bZLevel )
<a name="l01887"></a>01887 {
<a name="l01888"></a>01888       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l01889"></a>01889       <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>                        usNum;
<a name="l01890"></a>01890 
<a name="l01891"></a>01891       <span class="comment">// Draw menu if more than one item!</span>
<a name="l01892"></a>01892       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> ) )
<a name="l01893"></a>01893       {
<a name="l01894"></a>01894             <span class="comment">// OK, if an enemy, go directly ( skip menu )</span>
<a name="l01895"></a>01895             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> )
<a name="l01896"></a>01896             {
<a name="l01897"></a>01897                   <a class="code" href="Handle_01Items_8cpp.html#837432bbd14f9db90acea2b3bcaef5dc">SoldierGetItemFromWorld</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, iItemIndex, sGridNo, bZLevel, NULL );
<a name="l01898"></a>01898             }
<a name="l01899"></a>01899             <span class="keywordflow">else</span>
<a name="l01900"></a>01900             {
<a name="l01901"></a>01901                   <span class="keywordflow">if</span> (<a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].uiFlags &amp; MAPELEMENT_PLAYER_MINE_PRESENT)
<a name="l01902"></a>01902                   {
<a name="l01903"></a>01903                         <span class="comment">// have the computer ask us if we want to proceed</span>
<a name="l01904"></a>01904 
<a name="l01905"></a>01905                         <span class="comment">// override the item index passed in with the one for the bomb in this</span>
<a name="l01906"></a>01906                         <span class="comment">// tile</span>
<a name="l01907"></a>01907                         iItemIndex = <a class="code" href="World_01Items_8cpp.html#1aa717be2de160903b45585106061c56">FindWorldItemForBombInGridNo</a>( sGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l01908"></a>01908 <span class="preprocessor">#ifdef JA2TESTVERSION</span>
<a name="l01909"></a>01909 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (iItemIndex == -1)
<a name="l01910"></a>01910                         {
<a name="l01911"></a>01911                               <span class="comment">// WTF????</span>
<a name="l01912"></a>01912                               <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_ERROR, L<span class="stringliteral">"Cannot find bomb item in gridno %d"</span>, sGridNo );
<a name="l01913"></a>01913                               <span class="keywordflow">return</span>;
<a name="l01914"></a>01914                         }
<a name="l01915"></a>01915 <span class="preprocessor">#endif</span>
<a name="l01916"></a>01916 <span class="preprocessor"></span>
<a name="l01917"></a>01917                         <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a> = <a class="code" href="Handle_01Items_8cpp.html#426a9cae81da45767082edae988d7d5e">GetItemPoolForIndex</a>( sGridNo, iItemIndex, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l01918"></a>01918                         <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l01919"></a>01919                         <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a> = sGridNo;
<a name="l01920"></a>01920                         <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a>  = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>;
<a name="l01921"></a>01921                         <a class="code" href="Handle_01Items_8cpp.html#646730befce457ec377a2857d5ee5e90">gfDisarmingBuriedBomb</a> = TRUE;
<a name="l01922"></a>01922                         <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a> = <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iItemIndex ].<a class="code" href="structWORLDITEM.html#0f219e2d7aafd3aeca85991add1ef5f8">o</a>.<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a>;
<a name="l01923"></a>01923 
<a name="l01924"></a>01924                         <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28edfaaee6cf60e9dcec27ec0650dbbc39f">MSG_BOX_BASIC_STYLE</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe78982702989fcf4ef0095f29cc8dedbd9">DISARM_TRAP_PROMPT</a> ], <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf29873e16bc1530dedb416060abbeea6d0">GAME_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_YESNO, <a class="code" href="Handle_01Items_8cpp.html#e1d43de575fe0728997851c36c81644b">BoobyTrapMessageBoxCallBack</a>, NULL );
<a name="l01925"></a>01925                   }
<a name="l01926"></a>01926                   <span class="keywordflow">else</span>
<a name="l01927"></a>01927                   {
<a name="l01928"></a>01928                         <span class="comment">// OK, only hidden items exist...</span>
<a name="l01929"></a>01929                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> &amp;&amp; <a class="code" href="Handle_01Items_8cpp.html#4138d586ff6c1a4c7debc1eb91586204">DoesItemPoolContainAllHiddenItems</a>( pItemPool ) )
<a name="l01930"></a>01930                         {
<a name="l01931"></a>01931                               <span class="comment">// He's touched them....</span>
<a name="l01932"></a>01932                               <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#6c2195cfbb74917a3ac007e94623797e">LookForHiddenItems</a>( sGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, TRUE, 0 ) )
<a name="l01933"></a>01933                               {
<a name="l01934"></a>01934                                     <span class="comment">// WISDOM GAIN (5):  Found a hidden object</span>
<a name="l01935"></a>01935                                     <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, WISDOMAMT, 5, FALSE );
<a name="l01936"></a>01936 
<a name="l01937"></a>01937                                     <span class="comment">// We've found something!</span>
<a name="l01938"></a>01938                                     <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>)( <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a2911e21c67ced28112703054171ee2b7f4">QUOTE_SPOTTED_SOMETHING_ONE</a> + <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 2 ) ) );
<a name="l01939"></a>01939                               }
<a name="l01940"></a>01940                               <span class="keywordflow">else</span>
<a name="l01941"></a>01941                               {
<a name="l01942"></a>01942                                     <span class="comment">// Say NOTHING quote...</span>
<a name="l01943"></a>01943                                     <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0a138998dc9ae142b64753fbef27bd72de">BATTLE_SOUND_NOTHING</a> );
<a name="l01944"></a>01944                               }
<a name="l01945"></a>01945                         }
<a name="l01946"></a>01946                         <span class="keywordflow">else</span>
<a name="l01947"></a>01947                         {
<a name="l01948"></a>01948                               <span class="comment">// If only one good item exists....</span>
<a name="l01949"></a>01949                               <span class="keywordflow">if</span> ( ( usNum = <a class="code" href="Handle_01Items_8cpp.html#658301c1b8f3e756917fcbbde1ad1a73">GetNumOkForDisplayItemsInPool</a>( pItemPool, bZLevel ) ) == 1 )
<a name="l01950"></a>01950                               {
<a name="l01951"></a>01951                                     <span class="comment">// Find first OK item....</span>
<a name="l01952"></a>01952                                     <span class="keywordflow">while</span>( !<a class="code" href="Handle_01Items_8cpp.html#ec958a67be0ebc67209a65183705ed24">ItemPoolOKForDisplay</a>( pItemPool, bZLevel  ) )
<a name="l01953"></a>01953                                     {
<a name="l01954"></a>01954                                           pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l01955"></a>01955                                     }
<a name="l01956"></a>01956                                     <a class="code" href="Handle_01Items_8cpp.html#837432bbd14f9db90acea2b3bcaef5dc">SoldierGetItemFromWorld</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, sGridNo, bZLevel, NULL );
<a name="l01957"></a>01957                               }
<a name="l01958"></a>01958                               <span class="keywordflow">else</span>
<a name="l01959"></a>01959                               {
<a name="l01960"></a>01960                                     <span class="keywordflow">if</span> ( usNum != 0 )
<a name="l01961"></a>01961                                     {
<a name="l01962"></a>01962                                           <span class="comment">// Freeze guy!</span>
<a name="l01963"></a>01963                                           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#458a4b9ca265e9c6f88f526587e52fd1">fPauseAllAnimation</a> = TRUE;
<a name="l01964"></a>01964 
<a name="l01965"></a>01965                                           <a class="code" href="Interface_01Items_8cpp.html#0dd1e4d1007670a06bb8e9219d3dd1a7">InitializeItemPickupMenu</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sGridNo, pItemPool, 0, 0, bZLevel );
<a name="l01966"></a>01966 
<a name="l01967"></a>01967                                           <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e262169b5107bab7d6238f916d550a0cd">G_GETTINGITEM</a>;
<a name="l01968"></a>01968                                     }
<a name="l01969"></a>01969                                     <span class="keywordflow">else</span>
<a name="l01970"></a>01970                                     {
<a name="l01971"></a>01971                                           <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0a138998dc9ae142b64753fbef27bd72de">BATTLE_SOUND_NOTHING</a> );
<a name="l01972"></a>01972                                     }
<a name="l01973"></a>01973                               }
<a name="l01974"></a>01974                         }
<a name="l01975"></a>01975                   }
<a name="l01976"></a>01976             }
<a name="l01977"></a>01977       }
<a name="l01978"></a>01978       <span class="keywordflow">else</span>
<a name="l01979"></a>01979       {
<a name="l01980"></a>01980             <span class="comment">// Say NOTHING quote...</span>
<a name="l01981"></a>01981             <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0a138998dc9ae142b64753fbef27bd72de">BATTLE_SOUND_NOTHING</a> );
<a name="l01982"></a>01982       }
<a name="l01983"></a>01983 
<a name="l01984"></a>01984 }
<a name="l01985"></a>01985 
<a name="l01986"></a>01986 
<a name="l01987"></a><a class="code" href="Handle_01Items_8cpp.html#e6c8f73fc3fe56cf7f3dd72a60d70483">01987</a> <a class="code" href="structTAG__level__node.html">LEVELNODE</a> *<a class="code" href="Handle_01Items_8cpp.html#e6c8f73fc3fe56cf7f3dd72a60d70483">AddItemGraphicToWorld</a>( <a class="code" href="structINVTYPE.html">INVTYPE</a> *pItem, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel )
<a name="l01988"></a>01988 {
<a name="l01989"></a>01989       <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>                  usTileIndex;
<a name="l01990"></a>01990       <a class="code" href="structTAG__level__node.html">LEVELNODE</a>         *pNode;
<a name="l01991"></a>01991 
<a name="l01992"></a>01992       usTileIndex = <a class="code" href="Interface_01Items_8cpp.html#eb05d63b91981ad20c18e847cb876ee9">GetTileGraphicForItem</a>( pItem );
<a name="l01993"></a>01993 
<a name="l01994"></a>01994       <span class="comment">// OK, Do stuff differently base on level!</span>
<a name="l01995"></a>01995       <span class="keywordflow">if</span> ( ubLevel == 0 )
<a name="l01996"></a>01996       {
<a name="l01997"></a>01997             pNode = <a class="code" href="worldman_8cpp.html#fb0df5d310bb9f0d04c87a20c9727adf">AddStructToTail</a>( sGridNo, usTileIndex ); 
<a name="l01998"></a>01998             <span class="comment">//SET FLAG FOR AN ITEM</span>
<a name="l01999"></a>01999             pNode-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> |= LEVELNODE_ITEM;
<a name="l02000"></a>02000       }
<a name="l02001"></a>02001       <span class="keywordflow">else</span>
<a name="l02002"></a>02002       {
<a name="l02003"></a>02003             <a class="code" href="worldman_8cpp.html#b01b9dac3c1a52aff7c24b94ca29156b">AddOnRoofToHead</a>( sGridNo, usTileIndex ); 
<a name="l02004"></a>02004             <span class="comment">//SET FLAG FOR AN ITEM</span>
<a name="l02005"></a>02005             pNode = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#cc1855e037c8009f869e8d4ef8f90e6c">pOnRoofHead</a>;
<a name="l02006"></a>02006             pNode-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> |= LEVELNODE_ITEM;
<a name="l02007"></a>02007       }
<a name="l02008"></a>02008 
<a name="l02009"></a>02009       <span class="comment">// DIRTY INTERFACE</span>
<a name="l02010"></a>02010       <a class="code" href="Interface_8cpp.html#310e02e85df33f7794f5c4c11ae1844d">fInterfacePanelDirty</a> = DIRTYLEVEL2;
<a name="l02011"></a>02011 
<a name="l02012"></a>02012       <span class="comment">// DIRTY TILE</span>
<a name="l02013"></a>02013       <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#430f12029207b5bb7b32ed30ef355253">uiFlags</a> |= MAPELEMENT_REDRAW;
<a name="l02014"></a>02014       <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>(RENDER_FLAG_MARKED);
<a name="l02015"></a>02015 
<a name="l02016"></a>02016       <span class="keywordflow">return</span>( pNode );
<a name="l02017"></a>02017 }
<a name="l02018"></a>02018 
<a name="l02019"></a>02019 
<a name="l02020"></a><a class="code" href="Handle_01Items_8cpp.html#e4a707ca7113a89b31388f924084e62b">02020</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#e4a707ca7113a89b31388f924084e62b">RemoveItemGraphicFromWorld</a>( <a class="code" href="structINVTYPE.html">INVTYPE</a> *pItem, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel, <a class="code" href="structTAG__level__node.html">LEVELNODE</a> *pLevelNode )
<a name="l02021"></a>02021 {
<a name="l02022"></a>02022       <a class="code" href="structTAG__level__node.html">LEVELNODE</a> *pNode;
<a name="l02023"></a>02023 
<a name="l02024"></a>02024       <span class="comment">// OK, Do stuff differently base on level!</span>
<a name="l02025"></a>02025       <span class="comment">// Loop through and find pointer....</span>
<a name="l02026"></a>02026       <span class="keywordflow">if</span> ( ubLevel == 0 )
<a name="l02027"></a>02027       {
<a name="l02028"></a>02028             pNode = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#0cc751d3c74e25ab6dd78d58da155f6d">pStructHead</a>;            
<a name="l02029"></a>02029       }
<a name="l02030"></a>02030       <span class="keywordflow">else</span>
<a name="l02031"></a>02031       {
<a name="l02032"></a>02032             pNode = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#cc1855e037c8009f869e8d4ef8f90e6c">pOnRoofHead</a>;            
<a name="l02033"></a>02033       }
<a name="l02034"></a>02034 
<a name="l02035"></a>02035       <span class="keywordflow">while</span>( pNode != NULL )
<a name="l02036"></a>02036       {
<a name="l02037"></a>02037             <span class="keywordflow">if</span> ( pNode == pLevelNode )
<a name="l02038"></a>02038             {
<a name="l02039"></a>02039                   <span class="comment">// Found one!</span>
<a name="l02040"></a>02040                   <span class="keywordflow">if</span> ( ubLevel == 0 )
<a name="l02041"></a>02041                   {
<a name="l02042"></a>02042                         <a class="code" href="worldman_8cpp.html#1cc61cf6f1d4a5383c2162f88ef7b728">RemoveStructFromLevelNode</a>( sGridNo, pNode );
<a name="l02043"></a>02043                   }
<a name="l02044"></a>02044                   <span class="keywordflow">else</span>
<a name="l02045"></a>02045                   {
<a name="l02046"></a>02046                         <a class="code" href="worldman_8cpp.html#8429b1ae85a328307bdcc59d9583f34e">RemoveOnRoofFromLevelNode</a>( sGridNo, pNode );
<a name="l02047"></a>02047                   }
<a name="l02048"></a>02048 
<a name="l02049"></a>02049                   <span class="keywordflow">break</span>;
<a name="l02050"></a>02050             }
<a name="l02051"></a>02051 
<a name="l02052"></a>02052             pNode = pNode-&gt;<a class="code" href="structTAG__level__node.html#7c693acc3b593ab866b789ba7542eef7">pNext</a>;
<a name="l02053"></a>02053       }
<a name="l02054"></a>02054 
<a name="l02055"></a>02055       <span class="comment">// DIRTY INTERFACE</span>
<a name="l02056"></a>02056       <a class="code" href="Interface_8cpp.html#310e02e85df33f7794f5c4c11ae1844d">fInterfacePanelDirty</a> = DIRTYLEVEL2;
<a name="l02057"></a>02057 
<a name="l02058"></a>02058       <span class="comment">// DIRTY TILE</span>
<a name="l02059"></a>02059       <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#430f12029207b5bb7b32ed30ef355253">uiFlags</a> |= MAPELEMENT_REDRAW;
<a name="l02060"></a>02060       <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>(RENDER_FLAG_MARKED);
<a name="l02061"></a>02061 
<a name="l02062"></a>02062       <span class="comment">//TEMP RENDER FULL!!!</span>
<a name="l02063"></a>02063       <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>(RENDER_FLAG_FULL);
<a name="l02064"></a>02064 }
<a name="l02065"></a>02065 
<a name="l02066"></a>02066 <span class="comment">// INVENTORY POOL STUFF</span>
<a name="l02067"></a><a class="code" href="Handle_01Items_8h.html#ca7f6f6da97e9a4c2b737296485f5c84">02067</a> <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a>* <a class="code" href="Handle_01Items_8cpp.html#ca7f6f6da97e9a4c2b737296485f5c84">AddItemToPool</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *pObject, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bVisible, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel, <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> usFlags, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bRenderZHeightAboveLevel )
<a name="l02068"></a>02068 {
<a name="l02069"></a>02069       <span class="keywordflow">return</span> <a class="code" href="Handle_01Items_8cpp.html#7413df933b908678d113153b26bb8be3">InternalAddItemToPool</a>( &amp;sGridNo, pObject, bVisible, ubLevel, usFlags, bRenderZHeightAboveLevel, NULL );
<a name="l02070"></a>02070 }
<a name="l02071"></a>02071 
<a name="l02072"></a><a class="code" href="Handle_01Items_8h.html#065803b2ee07a7e27d95012998ab9889">02072</a> <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> * <a class="code" href="Handle_01Items_8cpp.html#065803b2ee07a7e27d95012998ab9889">AddItemToPoolAndGetIndex</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *pObject, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bVisible, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel, <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> usFlags, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bRenderZHeightAboveLevel, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> * piItemIndex )
<a name="l02073"></a>02073 {
<a name="l02074"></a>02074       <span class="keywordflow">return</span>( <a class="code" href="Handle_01Items_8cpp.html#7413df933b908678d113153b26bb8be3">InternalAddItemToPool</a>( &amp;sGridNo, pObject, bVisible, ubLevel, usFlags, bRenderZHeightAboveLevel, piItemIndex ) );
<a name="l02075"></a>02075 }
<a name="l02076"></a>02076 
<a name="l02077"></a><a class="code" href="Handle_01Items_8h.html#7413df933b908678d113153b26bb8be3">02077</a> <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a>* <a class="code" href="Handle_01Items_8cpp.html#7413df933b908678d113153b26bb8be3">InternalAddItemToPool</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> *psGridNo, <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *pObject, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bVisible, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel, <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> usFlags, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bRenderZHeightAboveLevel, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> * piItemIndex )
<a name="l02078"></a>02078 {
<a name="l02079"></a>02079       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l02080"></a>02080       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPoolTemp;
<a name="l02081"></a>02081       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                   iWorldItem;
<a name="l02082"></a>02082       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a>         *pStructure, *pBase;
<a name="l02083"></a>02083       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                   sDesiredLevel;
<a name="l02084"></a>02084       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>       sNewGridNo = *psGridNo;
<a name="l02085"></a>02085       <a class="code" href="structTAG__level__node.html">LEVELNODE</a>         *pNode;
<a name="l02086"></a>02086       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fForceOnGround = FALSE;
<a name="l02087"></a>02087       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fObjectInOpenable = FALSE;
<a name="l02088"></a>02088   <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>        bTerrainID;
<a name="l02089"></a>02089 
<a name="l02090"></a>02090       Assert( pObject-&gt;<a class="code" href="structOBJECTTYPE.html#84ab3cbeb7dfdcc2e5ad4051e165d294">ubNumberOfObjects</a> &lt;= MAX_OBJECTS_PER_SLOT);
<a name="l02091"></a>02091 
<a name="l02092"></a>02092       <span class="comment">// ATE: Check if the gridno is OK</span>
<a name="l02093"></a>02093       <span class="keywordflow">if</span> ( (*psGridNo) == NOWHERE )
<a name="l02094"></a>02094       {
<a name="l02095"></a>02095             <span class="comment">// Display warning.....</span>
<a name="l02096"></a>02096             <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L<span class="stringliteral">"Error: Item %d was given invalid grid location %d for item pool. Please Report."</span>, pObject-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>, (*psGridNo) );
<a name="l02097"></a>02097 
<a name="l02098"></a>02098     (*psGridNo) = sNewGridNo = <a class="code" href="Map_01Information_8cpp.html#9092e81f9a27bc1c300962e835ee7f22">gMapInformation</a>.<a class="code" href="structMAPCREATE__STRUCT.html#6a007bef504e146fbdc2f94a5f093a3c">sCenterGridNo</a>;
<a name="l02099"></a>02099 
<a name="l02100"></a>02100             <span class="comment">//return( NULL );</span>
<a name="l02101"></a>02101       }
<a name="l02102"></a>02102 
<a name="l02103"></a>02103       <span class="comment">// CHECK IF THIS ITEM IS IN DEEP WATER....</span>
<a name="l02104"></a>02104       <span class="comment">// IF SO, CHECK IF IT SINKS...</span>
<a name="l02105"></a>02105       <span class="comment">// IF SO, DONT'T ADD!</span>
<a name="l02106"></a>02106       bTerrainID = <a class="code" href="worldman_8cpp.html#ff4861660a5bfb5f9810adfa9c547d04">GetTerrainType</a>( *psGridNo );
<a name="l02107"></a>02107 
<a name="l02108"></a>02108   <span class="keywordflow">if</span> ( bTerrainID == <a class="code" href="tiledef_8h.html#c670bc5d76bf3f6a2bdda553ba73177c6d5b5dcfd05a52b309607f0047f1b5fd">DEEP_WATER</a> || bTerrainID == <a class="code" href="tiledef_8h.html#c670bc5d76bf3f6a2bdda553ba73177c991564694eec10f14cfdab99c29b5718">LOW_WATER</a> || bTerrainID == <a class="code" href="tiledef_8h.html#c670bc5d76bf3f6a2bdda553ba73177c8c5eadde6447854c388b3ed3bb03b05f">MED_WATER</a> )
<a name="l02109"></a>02109   {
<a name="l02110"></a>02110 <span class="comment">//          if ( Item[ pObject-&gt;usItem ].fFlags &amp; ITEM_SINKS )</span>
<a name="l02111"></a>02111             <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ pObject-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> ].sinks  )
<a name="l02112"></a>02112             {
<a name="l02113"></a>02113                   <span class="keywordflow">return</span>( NULL );
<a name="l02114"></a>02114             }
<a name="l02115"></a>02115       }
<a name="l02116"></a>02116 
<a name="l02117"></a>02117       <span class="comment">// First things first - look at where we are to place the items, and</span>
<a name="l02118"></a>02118       <span class="comment">// set some flags appropriately</span>
<a name="l02119"></a>02119 
<a name="l02120"></a>02120       <span class="comment">// On a structure?</span>
<a name="l02121"></a>02121       <span class="comment">//Locations on roofs without a roof is not possible, so</span>
<a name="l02122"></a>02122       <span class="comment">//we convert the onroof intention to ground.</span>
<a name="l02123"></a>02123       <span class="keywordflow">if</span>( ubLevel &amp;&amp; !<a class="code" href="Overhead_8cpp.html#16380e271fdc03604152be2d9cca8867">FlatRoofAboveGridNo</a>( *psGridNo ) )
<a name="l02124"></a>02124       {
<a name="l02125"></a>02125             ubLevel = 0;
<a name="l02126"></a>02126       }
<a name="l02127"></a>02127 
<a name="l02128"></a>02128       <span class="keywordflow">if</span> ( bRenderZHeightAboveLevel == -1 )
<a name="l02129"></a>02129       {
<a name="l02130"></a>02130             fForceOnGround = TRUE;
<a name="l02131"></a>02131             bRenderZHeightAboveLevel = 0;
<a name="l02132"></a>02132       }
<a name="l02133"></a>02133 
<a name="l02134"></a>02134       <span class="comment">// Check structure database</span>
<a name="l02135"></a>02135       <span class="keywordflow">if</span> ( <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ *psGridNo ].pStructureHead &amp;&amp; (pObject-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> != <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4f8504500da6b5018e9afcfb429a4768d">OWNERSHIP</a>) &amp;&amp; (pObject-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> != <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4badb02dc80151403af1a50e2e767fc85">ACTION_ITEM</a>) )
<a name="l02136"></a>02136       {
<a name="l02137"></a>02137             <span class="comment">// Something is here, check obstruction in future</span>
<a name="l02138"></a>02138             sDesiredLevel = ubLevel ? STRUCTURE_ON_ROOF : STRUCTURE_ON_GROUND;
<a name="l02139"></a>02139             pStructure = <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( *psGridNo , STRUCTURE_BLOCKSMOVES );
<a name="l02140"></a>02140             <span class="keywordflow">while</span>( pStructure )
<a name="l02141"></a>02141             {
<a name="l02142"></a>02142                   <span class="keywordflow">if</span>( !(pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#5a803a00d8769236709b4f0665951383">fFlags</a> &amp;( STRUCTURE_PERSON | STRUCTURE_CORPSE ) ) &amp;&amp; pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#a8cb801aeb04ca6e49c4ab8b66c75997">sCubeOffset</a> == sDesiredLevel )
<a name="l02143"></a>02143                   {
<a name="l02144"></a>02144                         <span class="comment">// If we are going into a raised struct AND we have above level set to -1</span>
<a name="l02145"></a>02145                         <span class="keywordflow">if</span> ( <a class="code" href="structure_8cpp.html#86ee58ae4bc59a0b22887750cf686e91">StructureBottomLevel</a>( pStructure ) != 1 &amp;&amp; fForceOnGround )
<a name="l02146"></a>02146                         {
<a name="l02147"></a>02147                               <span class="keywordflow">break</span>;
<a name="l02148"></a>02148                         }
<a name="l02149"></a>02149 
<a name="l02150"></a>02150                         <span class="comment">// Adjust the item's gridno to the base of struct.....</span>
<a name="l02151"></a>02151                         pBase = <a class="code" href="structure_8cpp.html#b55dd5bf5b84e82450258b2ffd222181">FindBaseStructure</a>( pStructure );
<a name="l02152"></a>02152                         
<a name="l02153"></a>02153                         <span class="comment">// Get LEVELNODE for struct and remove!</span>
<a name="l02154"></a>02154                         sNewGridNo = pBase-&gt;<a class="code" href="structTAG__STRUCTURE.html#0d887297b2381aceed479a0ace92e895">sGridNo</a>;
<a name="l02155"></a>02155       
<a name="l02156"></a>02156                         <span class="comment">// Check for openable flag....</span>
<a name="l02157"></a>02157                         <span class="keywordflow">if</span> ( pStructure-&gt;fFlags &amp; STRUCTURE_OPENABLE )
<a name="l02158"></a>02158                         {
<a name="l02159"></a>02159                               <span class="comment">// ATE: Set a flag here - we need to know later that we're in an openable...</span>
<a name="l02160"></a>02160                               fObjectInOpenable = TRUE;
<a name="l02161"></a>02161 
<a name="l02162"></a>02162                               <span class="comment">// Something of note is here....</span>
<a name="l02163"></a>02163                               <span class="comment">// SOME sort of structure is here.... set render flag to off</span>
<a name="l02164"></a>02164                               usFlags |= WORLD_ITEM_DONTRENDER;
<a name="l02165"></a>02165 
<a name="l02166"></a>02166                               <span class="comment">// Openable.. check if it's closed, if so, set visiblity...</span>
<a name="l02167"></a>02167                               <span class="keywordflow">if</span> ( !( pStructure-&gt;fFlags &amp; STRUCTURE_OPEN ) )
<a name="l02168"></a>02168                               {
<a name="l02169"></a>02169                                     <span class="comment">// -2 means - don't reveal!</span>
<a name="l02170"></a>02170                                     bVisible = -2;
<a name="l02171"></a>02171                               }
<a name="l02172"></a>02172 
<a name="l02173"></a>02173                               bRenderZHeightAboveLevel = CONVERT_INDEX_TO_PIXELS( <a class="code" href="structure_8cpp.html#5638007d3c09177a2df3b2ea6088233a">StructureHeight</a>( pStructure ) );
<a name="l02174"></a>02174                               <span class="keywordflow">break</span>;
<a name="l02175"></a>02175 
<a name="l02176"></a>02176                         }
<a name="l02177"></a>02177                         <span class="comment">// Else can we place an item on top?</span>
<a name="l02178"></a>02178                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( pStructure-&gt;fFlags &amp; ( STRUCTURE_GENERIC ) )
<a name="l02179"></a>02179                         {
<a name="l02180"></a>02180                               <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel0, ubLevel1, ubLevel2, ubLevel3;
<a name="l02181"></a>02181 
<a name="l02182"></a>02182                               <span class="comment">// If we are going into a raised struct AND we have above level set to -1</span>
<a name="l02183"></a>02183                               <span class="keywordflow">if</span> ( <a class="code" href="structure_8cpp.html#86ee58ae4bc59a0b22887750cf686e91">StructureBottomLevel</a>( pStructure ) != 1 &amp;&amp; fForceOnGround )
<a name="l02184"></a>02184                               {
<a name="l02185"></a>02185                                     <span class="keywordflow">break</span>;
<a name="l02186"></a>02186                               }
<a name="l02187"></a>02187 
<a name="l02188"></a>02188                               <span class="comment">// Find most dence area...</span>
<a name="l02189"></a>02189                               <span class="keywordflow">if</span> ( <a class="code" href="structure_8cpp.html#ad9a74775a36a8b5cdc5e1410d49b014">StructureDensity</a>( pStructure, &amp;ubLevel0, &amp;ubLevel1, &amp;ubLevel2, &amp;ubLevel3 ) )
<a name="l02190"></a>02190                               {
<a name="l02191"></a>02191                                      <span class="keywordflow">if</span> ( ubLevel3 == 0 &amp;&amp; ubLevel2 == 0 &amp;&amp; ubLevel1 == 0 &amp;&amp; ubLevel0 == 0 )
<a name="l02192"></a>02192                                      {
<a name="l02193"></a>02193                                                 bRenderZHeightAboveLevel = 0;
<a name="l02194"></a>02194                                      }                                                                      
<a name="l02195"></a>02195                                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ubLevel3 &gt;= ubLevel0 &amp;&amp; ubLevel3 &gt;= ubLevel2 &amp;&amp; ubLevel3 &gt;= ubLevel1 )
<a name="l02196"></a>02196                                      {
<a name="l02197"></a>02197                                                 bRenderZHeightAboveLevel = CONVERT_INDEX_TO_PIXELS( 4 );
<a name="l02198"></a>02198                                      }                                  
<a name="l02199"></a>02199                                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ubLevel2 &gt;= ubLevel0 &amp;&amp; ubLevel2 &gt;= ubLevel1 &amp;&amp; ubLevel2 &gt;= ubLevel3 )
<a name="l02200"></a>02200                                      {
<a name="l02201"></a>02201                                                 bRenderZHeightAboveLevel = CONVERT_INDEX_TO_PIXELS( 3 );
<a name="l02202"></a>02202                                      }
<a name="l02203"></a>02203                                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ubLevel1 &gt;= ubLevel0 &amp;&amp; ubLevel1 &gt;= ubLevel2 &amp;&amp; ubLevel1 &gt;= ubLevel3 )
<a name="l02204"></a>02204                                      {
<a name="l02205"></a>02205                                                 bRenderZHeightAboveLevel = CONVERT_INDEX_TO_PIXELS( 2 );
<a name="l02206"></a>02206                                      }
<a name="l02207"></a>02207                                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ubLevel0 &gt;= ubLevel1 &amp;&amp; ubLevel0 &gt;= ubLevel2 &amp;&amp; ubLevel0 &gt;= ubLevel3 )
<a name="l02208"></a>02208                                      {
<a name="l02209"></a>02209                                                 bRenderZHeightAboveLevel = CONVERT_INDEX_TO_PIXELS( 1 );
<a name="l02210"></a>02210                                      }
<a name="l02211"></a>02211                               }
<a name="l02212"></a>02212                               
<a name="l02213"></a>02213                               <span class="comment">// Set flag indicating it has an item on top!</span>
<a name="l02214"></a>02214                               pStructure-&gt;fFlags |= STRUCTURE_HASITEMONTOP;
<a name="l02215"></a>02215                               <span class="keywordflow">break</span>;
<a name="l02216"></a>02216                         }
<a name="l02217"></a>02217 
<a name="l02218"></a>02218                   }
<a name="l02219"></a>02219                   
<a name="l02220"></a>02220                   pStructure = <a class="code" href="structure_8cpp.html#cb29f04194ddd6161b1b20c3671ec4b6">FindNextStructure</a>( pStructure, STRUCTURE_BLOCKSMOVES );
<a name="l02221"></a>02221             }
<a name="l02222"></a>02222       }
<a name="l02223"></a>02223 
<a name="l02224"></a>02224       <span class="keywordflow">if</span> (pObject-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f453396ea1193548270407675ea4eeee2b">SWITCH</a> &amp;&amp; !fObjectInOpenable )
<a name="l02225"></a>02225       {
<a name="l02226"></a>02226             <span class="keywordflow">if</span> (bVisible != -2)
<a name="l02227"></a>02227             {
<a name="l02228"></a>02228                   <span class="comment">// switch items which are not hidden inside objects should be considered buried</span>
<a name="l02229"></a>02229                   bVisible = BURIED;
<a name="l02230"></a>02230                   <span class="comment">// and they are pressure-triggered unless there is a switch structure there</span>
<a name="l02231"></a>02231                   <span class="keywordflow">if</span> (<a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( *psGridNo, STRUCTURE_SWITCH ) != NULL)
<a name="l02232"></a>02232                   {
<a name="l02233"></a>02233                         pObject-&gt;<a class="code" href="structOBJECTTYPE.html#11538e133e999113e56a505515d9804f">bDetonatorType</a> = <a class="code" href="Item_01Types_8h.html#6fc932f93bf4d61f06ab663a791913956adc5928003da6553022723f6be60f2c">BOMB_SWITCH</a>;
<a name="l02234"></a>02234                   }
<a name="l02235"></a>02235                   <span class="keywordflow">else</span>
<a name="l02236"></a>02236                   {
<a name="l02237"></a>02237                         pObject-&gt;<a class="code" href="structOBJECTTYPE.html#11538e133e999113e56a505515d9804f">bDetonatorType</a> = <a class="code" href="Item_01Types_8h.html#6fc932f93bf4d61f06ab663a79191395ba0d1790ae9b9f536df6b3998e9390b9">BOMB_PRESSURE</a>;
<a name="l02238"></a>02238                   }
<a name="l02239"></a>02239             }
<a name="l02240"></a>02240             <span class="keywordflow">else</span>
<a name="l02241"></a>02241             {
<a name="l02242"></a>02242                   <span class="comment">// else they are manually controlled</span>
<a name="l02243"></a>02243                   pObject-&gt;<a class="code" href="structOBJECTTYPE.html#11538e133e999113e56a505515d9804f">bDetonatorType</a> = <a class="code" href="Item_01Types_8h.html#6fc932f93bf4d61f06ab663a791913956adc5928003da6553022723f6be60f2c">BOMB_SWITCH</a>;
<a name="l02244"></a>02244             }
<a name="l02245"></a>02245       }
<a name="l02246"></a>02246       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( pObject-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4badb02dc80151403af1a50e2e767fc85">ACTION_ITEM</a> )
<a name="l02247"></a>02247       {
<a name="l02248"></a>02248             <span class="keywordflow">switch</span>( pObject-&gt;<a class="code" href="structOBJECTTYPE.html#ce5a9b46852e6e766cf0aa06edd21686">bActionValue</a> )
<a name="l02249"></a>02249             {
<a name="l02250"></a>02250                   <span class="keywordflow">case</span> <a class="code" href="Action_01Items_8h.html#9ef42d46d391286f9a974d5069848516a3f3f71c8848b60f04c9757ac9b1f794">ACTION_ITEM_SMALL_PIT</a>:
<a name="l02251"></a>02251                   <span class="keywordflow">case</span> <a class="code" href="Action_01Items_8h.html#9ef42d46d391286f9a974d5069848516b65b8bac2d65e7da7c87e882b357b224">ACTION_ITEM_LARGE_PIT</a>:
<a name="l02252"></a>02252                         <span class="comment">// mark as known about by civs and creatures</span>
<a name="l02253"></a>02253                         <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sNewGridNo ].<a class="code" href="structMAP__ELEMENT.html#430f12029207b5bb7b32ed30ef355253">uiFlags</a> |= MAPELEMENT_ENEMY_MINE_PRESENT;
<a name="l02254"></a>02254                         <span class="keywordflow">break</span>;
<a name="l02255"></a>02255                   <span class="keywordflow">default</span>:
<a name="l02256"></a>02256                         <span class="keywordflow">break</span>;
<a name="l02257"></a>02257             }
<a name="l02258"></a>02258       }
<a name="l02259"></a>02259 
<a name="l02260"></a>02260       <span class="keywordflow">if</span> ( *psGridNo != sNewGridNo )
<a name="l02261"></a>02261       {
<a name="l02262"></a>02262             *psGridNo = sNewGridNo;
<a name="l02263"></a>02263       }
<a name="l02264"></a>02264 
<a name="l02265"></a>02265 
<a name="l02266"></a>02266       <span class="comment">//First add the item to the global list.  This is so the game can keep track </span>
<a name="l02267"></a>02267       <span class="comment">//of where the items are, for file i/o, etc.</span>
<a name="l02268"></a>02268       iWorldItem = <a class="code" href="World_01Items_8cpp.html#68e560c5f58a0e1de518bc2c949c56fc">AddItemToWorld</a>( *psGridNo,  pObject, ubLevel, usFlags, bRenderZHeightAboveLevel, bVisible );
<a name="l02269"></a>02269 
<a name="l02270"></a>02270       <span class="comment">// Check for and existing pool on the object layer</span>
<a name="l02271"></a>02271       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( *psGridNo, &amp;pItemPool, ubLevel ) )
<a name="l02272"></a>02272       {
<a name="l02273"></a>02273 
<a name="l02274"></a>02274             <span class="comment">// Add to exitsing pool</span>
<a name="l02275"></a>02275             <span class="comment">// Add graphic</span>
<a name="l02276"></a>02276             pNode = <a class="code" href="Handle_01Items_8cpp.html#e6c8f73fc3fe56cf7f3dd72a60d70483">AddItemGraphicToWorld</a>( &amp;(<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ pObject-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> ] ), *psGridNo, ubLevel );
<a name="l02277"></a>02277 
<a name="l02278"></a>02278             <span class="comment">// Set pool head value in levelnode</span>
<a name="l02279"></a>02279             pNode-&gt;<a class="code" href="structTAG__level__node.html#8624c806c103872cc6f98e52e7ed9e3d">pItemPool</a> = pItemPool;
<a name="l02280"></a>02280 
<a name="l02281"></a>02281             <span class="comment">// Add New Node</span>
<a name="l02282"></a>02282             pItemPoolTemp = pItemPool;
<a name="l02283"></a>02283             <span class="comment">// Create new pool</span>
<a name="l02284"></a>02284             pItemPool = (<a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *)MemAlloc( <span class="keyword">sizeof</span>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> ) );
<a name="l02285"></a>02285 
<a name="l02286"></a>02286             <span class="comment">// Set Next to NULL</span>
<a name="l02287"></a>02287             pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a> = NULL;
<a name="l02288"></a>02288             <span class="comment">// Set Item index</span>
<a name="l02289"></a>02289             pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> = iWorldItem;
<a name="l02290"></a>02290             <span class="comment">// Get a link back!</span>
<a name="l02291"></a>02291             pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8fb6ca67b4c4dc719e7d2b927cbb510f">pLevelNode</a> = pNode;
<a name="l02292"></a>02292 
<a name="l02293"></a>02293             <span class="keywordflow">if</span>( pItemPoolTemp )
<a name="l02294"></a>02294             {
<a name="l02295"></a>02295                   <span class="comment">// Get last item in list</span>
<a name="l02296"></a>02296                   <span class="keywordflow">while</span>( pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a> != NULL )
<a name="l02297"></a>02297                         pItemPoolTemp = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02298"></a>02298 
<a name="l02299"></a>02299                   <span class="comment">// Set Next of previous</span>
<a name="l02300"></a>02300                   pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a> = pItemPool;
<a name="l02301"></a>02301             }
<a name="l02302"></a>02302             <span class="comment">// Set Previous of new one</span>
<a name="l02303"></a>02303             pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#7ee735a43a38256a0497c42e45054efc">pPrev</a> = pItemPoolTemp;         
<a name="l02304"></a>02304 
<a name="l02305"></a>02305       }
<a name="l02306"></a>02306       <span class="keywordflow">else</span>
<a name="l02307"></a>02307       {
<a name="l02308"></a>02308             pNode = <a class="code" href="Handle_01Items_8cpp.html#e6c8f73fc3fe56cf7f3dd72a60d70483">AddItemGraphicToWorld</a>( &amp;(<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ pObject-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> ] ), *psGridNo, ubLevel );
<a name="l02309"></a>02309 
<a name="l02310"></a>02310             <span class="comment">// Create new pool</span>
<a name="l02311"></a>02311             pItemPool = (<a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *)MemAlloc( <span class="keyword">sizeof</span>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> ) );
<a name="l02312"></a>02312 
<a name="l02313"></a>02313             pNode-&gt;<a class="code" href="structTAG__level__node.html#8624c806c103872cc6f98e52e7ed9e3d">pItemPool</a> = pItemPool;
<a name="l02314"></a>02314 
<a name="l02315"></a>02315             <span class="comment">// Set prev to NULL</span>
<a name="l02316"></a>02316             pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#7ee735a43a38256a0497c42e45054efc">pPrev</a> = NULL;
<a name="l02317"></a>02317             <span class="comment">// Set next to NULL</span>
<a name="l02318"></a>02318             pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a> = NULL;
<a name="l02319"></a>02319             <span class="comment">// Set Item index</span>
<a name="l02320"></a>02320             pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> = iWorldItem;
<a name="l02321"></a>02321             <span class="comment">// Get a link back!</span>
<a name="l02322"></a>02322             pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8fb6ca67b4c4dc719e7d2b927cbb510f">pLevelNode</a> = pNode;
<a name="l02323"></a>02323 
<a name="l02324"></a>02324             <span class="comment">// Set flag to indicate item pool presence</span>
<a name="l02325"></a>02325             <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[*psGridNo].<a class="code" href="structMAP__ELEMENT.html#430f12029207b5bb7b32ed30ef355253">uiFlags</a> |= MAPELEMENT_ITEMPOOL_PRESENT;
<a name="l02326"></a>02326       }
<a name="l02327"></a>02327 
<a name="l02328"></a>02328       <span class="comment">// Set visible!</span>
<a name="l02329"></a>02329       pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#b4cda5e950dbf9506a3442f956476659">bVisible</a> = bVisible;
<a name="l02330"></a>02330 
<a name="l02331"></a>02331       <span class="comment">// If bbisible is true, render makered world</span>
<a name="l02332"></a>02332       <span class="keywordflow">if</span> ( bVisible == 1 &amp;&amp; <a class="code" href="Soldier_01Find_8cpp.html#d9c8fdbf9d59886a70560360867bb150">GridNoOnScreen</a>( (*psGridNo ) ) )
<a name="l02333"></a>02333       {
<a name="l02334"></a>02334             <span class="comment">//gpWorldLevelData[*psGridNo].uiFlags|=MAPELEMENT_REDRAW;</span>
<a name="l02335"></a>02335             <span class="comment">//SetRenderFlags(RENDER_FLAG_MARKED);</span>
<a name="l02336"></a>02336             <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>(RENDER_FLAG_FULL);
<a name="l02337"></a>02337       }
<a name="l02338"></a>02338 
<a name="l02339"></a>02339       <span class="comment">// Set flahs timer</span>
<a name="l02340"></a>02340       pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#73d13babb7b64e62eb568cb3d1b73c03">bFlashColor</a>                                       = FALSE;
<a name="l02341"></a>02341       pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a>                                                       = *psGridNo;
<a name="l02342"></a>02342       pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#d001579cc68909cba0f885510f2d242a">ubLevel</a>                                                       = ubLevel;
<a name="l02343"></a>02343       pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ae68082a46145464d2f10d48ab258a59">usFlags</a>                                                       = usFlags;
<a name="l02344"></a>02344       pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#b4cda5e950dbf9506a3442f956476659">bVisible</a>                                                      = bVisible;
<a name="l02345"></a>02345       pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a>  = bRenderZHeightAboveLevel;
<a name="l02346"></a>02346 
<a name="l02347"></a>02347       <span class="comment">// ATE: Get head of pool again....</span>
<a name="l02348"></a>02348       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( *psGridNo, &amp;pItemPool, ubLevel ) )
<a name="l02349"></a>02349       {
<a name="l02350"></a>02350             <a class="code" href="Handle_01Items_8cpp.html#d8e674b58e835f4a49cd565c8313aba6">AdjustItemPoolVisibility</a>( pItemPool );
<a name="l02351"></a>02351       }
<a name="l02352"></a>02352 
<a name="l02353"></a>02353       <span class="keywordflow">if</span> (piItemIndex)
<a name="l02354"></a>02354       {
<a name="l02355"></a>02355             *piItemIndex = iWorldItem;
<a name="l02356"></a>02356       }
<a name="l02357"></a>02357       
<a name="l02358"></a>02358       <span class="keywordflow">return</span>( &amp;(<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iWorldItem ].o ) );
<a name="l02359"></a>02359 }
<a name="l02360"></a>02360 
<a name="l02361"></a>02361 
<a name="l02362"></a><a class="code" href="Handle_01Items_8h.html#296963c365c156859be03ab5e8c204d5">02362</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#296963c365c156859be03ab5e8c204d5">ItemExistsAtLocation</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iItemIndex, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel )
<a name="l02363"></a>02363 {
<a name="l02364"></a>02364       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l02365"></a>02365       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPoolTemp;
<a name="l02366"></a>02366       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fItemFound = FALSE;
<a name="l02367"></a>02367 
<a name="l02368"></a>02368       <span class="comment">// Check for an existing pool on the object layer</span>
<a name="l02369"></a>02369       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, ubLevel ) )
<a name="l02370"></a>02370       {
<a name="l02371"></a>02371       <span class="comment">// LOOP THROUGH LIST TO FIND NODE WE WANT</span>
<a name="l02372"></a>02372             pItemPoolTemp = pItemPool;
<a name="l02373"></a>02373             <span class="keywordflow">while</span>( pItemPoolTemp != NULL )
<a name="l02374"></a>02374             {
<a name="l02375"></a>02375                   <span class="keywordflow">if</span> ( pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> == iItemIndex )
<a name="l02376"></a>02376                   {
<a name="l02377"></a>02377                         <span class="keywordflow">return</span>( TRUE );
<a name="l02378"></a>02378                   }
<a name="l02379"></a>02379                   pItemPoolTemp = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02380"></a>02380             }
<a name="l02381"></a>02381 
<a name="l02382"></a>02382       }
<a name="l02383"></a>02383 
<a name="l02384"></a>02384       <span class="keywordflow">return</span>( FALSE );
<a name="l02385"></a>02385 }
<a name="l02386"></a>02386 
<a name="l02387"></a><a class="code" href="Handle_01Items_8h.html#bb1a3cf41a73c390330bbf2996dbfabc">02387</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#bb1a3cf41a73c390330bbf2996dbfabc">ItemTypeExistsAtLocation</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> usItem, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> * piItemIndex )
<a name="l02388"></a>02388 {
<a name="l02389"></a>02389       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l02390"></a>02390       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPoolTemp;
<a name="l02391"></a>02391       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fItemFound = FALSE;
<a name="l02392"></a>02392 
<a name="l02393"></a>02393       <span class="comment">// Check for an existing pool on the object layer</span>
<a name="l02394"></a>02394       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, ubLevel ) )
<a name="l02395"></a>02395       {
<a name="l02396"></a>02396       <span class="comment">// LOOP THROUGH LIST TO FIND ITEM WE WANT</span>
<a name="l02397"></a>02397             pItemPoolTemp = pItemPool;
<a name="l02398"></a>02398             <span class="keywordflow">while</span>( pItemPoolTemp != NULL )
<a name="l02399"></a>02399             {
<a name="l02400"></a>02400                   <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.usItem == usItem )
<a name="l02401"></a>02401                   {
<a name="l02402"></a>02402                         <span class="keywordflow">if</span> ( piItemIndex )
<a name="l02403"></a>02403                         {
<a name="l02404"></a>02404                               *piItemIndex = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>;
<a name="l02405"></a>02405                         }
<a name="l02406"></a>02406                         <span class="keywordflow">return</span>( TRUE );
<a name="l02407"></a>02407                   }
<a name="l02408"></a>02408                   pItemPoolTemp = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02409"></a>02409             }
<a name="l02410"></a>02410 
<a name="l02411"></a>02411       }
<a name="l02412"></a>02412 
<a name="l02413"></a>02413       <span class="keywordflow">return</span>( FALSE );
<a name="l02414"></a>02414 }
<a name="l02415"></a>02415 
<a name="l02416"></a><a class="code" href="Handle_01Items_8h.html#a37a59f2ff688ef3c09f1243885630e6">02416</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#a37a59f2ff688ef3c09f1243885630e6">MarblesExistAtLocation</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> * piItemIndex )
<a name="l02417"></a>02417 {
<a name="l02418"></a>02418       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l02419"></a>02419       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPoolTemp;
<a name="l02420"></a>02420       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fItemFound = FALSE;
<a name="l02421"></a>02421 
<a name="l02422"></a>02422       <span class="comment">// Check for an existing pool on the object layer</span>
<a name="l02423"></a>02423       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, ubLevel ) )
<a name="l02424"></a>02424       {
<a name="l02425"></a>02425       <span class="comment">// LOOP THROUGH LIST TO FIND ITEM WE WANT</span>
<a name="l02426"></a>02426             pItemPoolTemp = pItemPool;
<a name="l02427"></a>02427             <span class="keywordflow">while</span>( pItemPoolTemp != NULL )
<a name="l02428"></a>02428             {
<a name="l02429"></a>02429                   <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.usItem].marbles )
<a name="l02430"></a>02430                   {
<a name="l02431"></a>02431                         <span class="keywordflow">if</span> ( piItemIndex )
<a name="l02432"></a>02432                         {
<a name="l02433"></a>02433                               *piItemIndex = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>;
<a name="l02434"></a>02434                         }
<a name="l02435"></a>02435                         <span class="keywordflow">return</span>( TRUE );
<a name="l02436"></a>02436                   }
<a name="l02437"></a>02437                   pItemPoolTemp = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02438"></a>02438             }
<a name="l02439"></a>02439 
<a name="l02440"></a>02440       }
<a name="l02441"></a>02441 
<a name="l02442"></a>02442       <span class="keywordflow">return</span>( FALSE );
<a name="l02443"></a>02443 }
<a name="l02444"></a>02444 
<a name="l02445"></a>02445 
<a name="l02446"></a><a class="code" href="Handle_01Items_8h.html#9e884945701aaab240a090cb63db47f4">02446</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Handle_01Items_8cpp.html#9e884945701aaab240a090cb63db47f4">GetItemOfClassTypeInPool</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiItemClass, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel )
<a name="l02447"></a>02447 {
<a name="l02448"></a>02448       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l02449"></a>02449       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPoolTemp;
<a name="l02450"></a>02450       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fItemFound = FALSE;
<a name="l02451"></a>02451 
<a name="l02452"></a>02452       <span class="comment">// Check for an existing pool on the object layer</span>
<a name="l02453"></a>02453       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, ubLevel ) )
<a name="l02454"></a>02454       {
<a name="l02455"></a>02455       <span class="comment">// LOOP THROUGH LIST TO FIND NODE WE WANT</span>
<a name="l02456"></a>02456             pItemPoolTemp = pItemPool;
<a name="l02457"></a>02457             <span class="keywordflow">while</span>( pItemPoolTemp != NULL )
<a name="l02458"></a>02458             {
<a name="l02459"></a>02459                   <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.usItem ].usItemClass &amp; uiItemClass )
<a name="l02460"></a>02460                   {
<a name="l02461"></a>02461                         <span class="keywordflow">return</span>( pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> );
<a name="l02462"></a>02462                   }
<a name="l02463"></a>02463                   pItemPoolTemp = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02464"></a>02464             }
<a name="l02465"></a>02465 
<a name="l02466"></a>02466       }
<a name="l02467"></a>02467 
<a name="l02468"></a>02468       <span class="keywordflow">return</span>( -1 );
<a name="l02469"></a>02469 }
<a name="l02470"></a>02470 
<a name="l02471"></a><a class="code" href="Handle_01Items_8cpp.html#426a9cae81da45767082edae988d7d5e">02471</a> <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> * <a class="code" href="Handle_01Items_8cpp.html#426a9cae81da45767082edae988d7d5e">GetItemPoolForIndex</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iItemIndex, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel )
<a name="l02472"></a>02472 {
<a name="l02473"></a>02473       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l02474"></a>02474       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPoolTemp;
<a name="l02475"></a>02475       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fItemFound = FALSE;
<a name="l02476"></a>02476 
<a name="l02477"></a>02477       <span class="comment">// Check for an existing pool on the object layer</span>
<a name="l02478"></a>02478       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, ubLevel ) )
<a name="l02479"></a>02479       {
<a name="l02480"></a>02480       <span class="comment">// LOOP THROUGH LIST TO FIND NODE WE WANT</span>
<a name="l02481"></a>02481             pItemPoolTemp = pItemPool;
<a name="l02482"></a>02482             <span class="keywordflow">while</span>( pItemPoolTemp != NULL )
<a name="l02483"></a>02483             {
<a name="l02484"></a>02484                   <span class="keywordflow">if</span> (pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> == iItemIndex )
<a name="l02485"></a>02485                   {
<a name="l02486"></a>02486                         <span class="keywordflow">return</span>( pItemPoolTemp );
<a name="l02487"></a>02487                   }
<a name="l02488"></a>02488                   pItemPoolTemp = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02489"></a>02489             }
<a name="l02490"></a>02490 
<a name="l02491"></a>02491       }
<a name="l02492"></a>02492 
<a name="l02493"></a>02493       <span class="keywordflow">return</span>( NULL );
<a name="l02494"></a>02494 }
<a name="l02495"></a>02495 
<a name="l02496"></a>02496 
<a name="l02497"></a>02497 
<a name="l02498"></a><a class="code" href="Handle_01Items_8h.html#212ec326da79fed87fcabbcd30aa0399">02498</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#212ec326da79fed87fcabbcd30aa0399">DoesItemPoolContainAnyHiddenItems</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool )
<a name="l02499"></a>02499 {
<a name="l02500"></a>02500       <span class="comment">// LOOP THROUGH LIST TO FIND NODE WE WANT</span>
<a name="l02501"></a>02501       <span class="keywordflow">while</span>( pItemPool != NULL )
<a name="l02502"></a>02502       {
<a name="l02503"></a>02503             <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].bVisible == HIDDEN_ITEM )
<a name="l02504"></a>02504             {
<a name="l02505"></a>02505                   <span class="keywordflow">return</span>( TRUE );
<a name="l02506"></a>02506             }
<a name="l02507"></a>02507 
<a name="l02508"></a>02508             pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02509"></a>02509       }
<a name="l02510"></a>02510 
<a name="l02511"></a>02511       <span class="keywordflow">return</span>( FALSE );
<a name="l02512"></a>02512 }
<a name="l02513"></a>02513 
<a name="l02514"></a><a class="code" href="Handle_01Items_8h.html#4138d586ff6c1a4c7debc1eb91586204">02514</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#4138d586ff6c1a4c7debc1eb91586204">DoesItemPoolContainAllHiddenItems</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool )
<a name="l02515"></a>02515 {
<a name="l02516"></a>02516       <span class="comment">// LOOP THROUGH LIST TO FIND NODE WE WANT</span>
<a name="l02517"></a>02517       <span class="keywordflow">while</span>( pItemPool != NULL )
<a name="l02518"></a>02518       {
<a name="l02519"></a>02519             <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].bVisible != HIDDEN_ITEM )
<a name="l02520"></a>02520             {
<a name="l02521"></a>02521                   <span class="keywordflow">return</span>( FALSE );
<a name="l02522"></a>02522             }
<a name="l02523"></a>02523 
<a name="l02524"></a>02524             pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02525"></a>02525       }
<a name="l02526"></a>02526 
<a name="l02527"></a>02527       <span class="keywordflow">return</span>( TRUE );
<a name="l02528"></a>02528 }
<a name="l02529"></a>02529 
<a name="l02530"></a>02530 
<a name="l02531"></a><a class="code" href="Handle_01Items_8h.html#6c2195cfbb74917a3ac007e94623797e">02531</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#6c2195cfbb74917a3ac007e94623797e">LookForHiddenItems</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> ubLevel, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fSetLocator, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bZLevel )
<a name="l02532"></a>02532 {
<a name="l02533"></a>02533       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool = NULL;
<a name="l02534"></a>02534       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pHeadItemPool = NULL;
<a name="l02535"></a>02535       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>           fFound = FALSE;
<a name="l02536"></a>02536 
<a name="l02537"></a>02537       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, ubLevel ) )
<a name="l02538"></a>02538       {
<a name="l02539"></a>02539             pHeadItemPool = pItemPool;
<a name="l02540"></a>02540 
<a name="l02541"></a>02541             <span class="comment">// LOOP THROUGH LIST TO FIND NODE WE WANT</span>
<a name="l02542"></a>02542             <span class="keywordflow">while</span>( pItemPool != NULL )
<a name="l02543"></a>02543             {
<a name="l02544"></a>02544                   <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].bVisible == HIDDEN_ITEM &amp;&amp; <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.usItem != <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4f8504500da6b5018e9afcfb429a4768d">OWNERSHIP</a> )
<a name="l02545"></a>02545                   {
<a name="l02546"></a>02546                         fFound = TRUE;
<a name="l02547"></a>02547             
<a name="l02548"></a>02548                         <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].<a class="code" href="structWORLDITEM.html#c2c79d0683fed574b39e0f3c90f24e34">bVisible</a> = INVISIBLE;
<a name="l02549"></a>02549                   }
<a name="l02550"></a>02550 
<a name="l02551"></a>02551                   pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02552"></a>02552             }
<a name="l02553"></a>02553       }
<a name="l02554"></a>02554 
<a name="l02555"></a>02555       <span class="comment">// If found, set item pool visibility...</span>
<a name="l02556"></a>02556       <span class="keywordflow">if</span> ( fFound )
<a name="l02557"></a>02557       {
<a name="l02558"></a>02558             <a class="code" href="Handle_01Items_8cpp.html#d2466e7c6ba932d50b6b96ddb398b0d4">SetItemPoolVisibilityOn</a>( pHeadItemPool, INVISIBLE, fSetLocator );
<a name="l02559"></a>02559       }
<a name="l02560"></a>02560 
<a name="l02561"></a>02561       <span class="keywordflow">return</span>( fFound );
<a name="l02562"></a>02562 }
<a name="l02563"></a>02563 
<a name="l02564"></a>02564 
<a name="l02565"></a><a class="code" href="Handle_01Items_8h.html#403f116897387a1ee8aae10748e28f70">02565</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="Handle_01Items_8cpp.html#403f116897387a1ee8aae10748e28f70">GetZLevelOfItemPoolGivenStructure</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel, <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a> *pStructure )
<a name="l02566"></a>02566 {
<a name="l02567"></a>02567       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool;
<a name="l02568"></a>02568 
<a name="l02569"></a>02569       <span class="keywordflow">if</span> ( pStructure == NULL )
<a name="l02570"></a>02570       {
<a name="l02571"></a>02571             <span class="keywordflow">return</span>( 0 );
<a name="l02572"></a>02572       }
<a name="l02573"></a>02573 
<a name="l02574"></a>02574       <span class="comment">// OK, check if this struct contains items....</span>
<a name="l02575"></a>02575       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, ubLevel ) == TRUE )
<a name="l02576"></a>02576       {
<a name="l02577"></a>02577             <span class="keywordflow">return</span>( <a class="code" href="Handle_01Items_8cpp.html#21d660298a488f81d35055b59787f506">GetLargestZLevelOfItemPool</a>( pItemPool ) );
<a name="l02578"></a>02578       }
<a name="l02579"></a>02579       <span class="keywordflow">return</span>( 0 );
<a name="l02580"></a>02580 }
<a name="l02581"></a>02581 
<a name="l02582"></a><a class="code" href="Handle_01Items_8h.html#21d660298a488f81d35055b59787f506">02582</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="Handle_01Items_8cpp.html#21d660298a488f81d35055b59787f506">GetLargestZLevelOfItemPool</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool )
<a name="l02583"></a>02583 {
<a name="l02584"></a>02584       <span class="comment">// OK, loop through pools and get any height != 0........</span>
<a name="l02585"></a>02585       <span class="keywordflow">while</span>( pItemPool != NULL )
<a name="l02586"></a>02586       {
<a name="l02587"></a>02587             <span class="keywordflow">if</span> ( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a> &gt; 0 )
<a name="l02588"></a>02588             {
<a name="l02589"></a>02589                   <span class="keywordflow">return</span>( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a> );
<a name="l02590"></a>02590             }
<a name="l02591"></a>02591 
<a name="l02592"></a>02592             pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02593"></a>02593       }
<a name="l02594"></a>02594 
<a name="l02595"></a>02595       <span class="keywordflow">return</span>( 0 );
<a name="l02596"></a>02596 }
<a name="l02597"></a>02597 
<a name="l02598"></a>02598 
<a name="l02599"></a>02599 
<a name="l02600"></a><a class="code" href="Handle_01Items_8h.html#276eae6e13751a488cfd2250862f6345">02600</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#276eae6e13751a488cfd2250862f6345">DoesItemPoolContainAllItemsOfHigherZLevel</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool )
<a name="l02601"></a>02601 {
<a name="l02602"></a>02602       <span class="comment">// LOOP THROUGH LIST TO FIND NODE WE WANT</span>
<a name="l02603"></a>02603       <span class="keywordflow">while</span>( pItemPool != NULL )
<a name="l02604"></a>02604       {
<a name="l02605"></a>02605             <span class="keywordflow">if</span> ( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a> == 0 )
<a name="l02606"></a>02606             {
<a name="l02607"></a>02607                   <span class="keywordflow">return</span>( FALSE );
<a name="l02608"></a>02608             }
<a name="l02609"></a>02609 
<a name="l02610"></a>02610             pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02611"></a>02611       }
<a name="l02612"></a>02612 
<a name="l02613"></a>02613       <span class="keywordflow">return</span>( TRUE );
<a name="l02614"></a>02614 }
<a name="l02615"></a>02615 
<a name="l02616"></a>02616 
<a name="l02617"></a><a class="code" href="Handle_01Items_8h.html#1a39485ccff7092847dfd7d65f0f6a93">02617</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#1a39485ccff7092847dfd7d65f0f6a93">DoesItemPoolContainAllItemsOfZeroZLevel</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool )
<a name="l02618"></a>02618 {
<a name="l02619"></a>02619       <span class="comment">// LOOP THROUGH LIST TO FIND NODE WE WANT</span>
<a name="l02620"></a>02620       <span class="keywordflow">while</span>( pItemPool != NULL )
<a name="l02621"></a>02621       {
<a name="l02622"></a>02622             <span class="keywordflow">if</span> ( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a> != 0 )
<a name="l02623"></a>02623             {
<a name="l02624"></a>02624                   <span class="keywordflow">return</span>( FALSE );
<a name="l02625"></a>02625             }
<a name="l02626"></a>02626 
<a name="l02627"></a>02627             pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02628"></a>02628       }
<a name="l02629"></a>02629 
<a name="l02630"></a>02630       <span class="keywordflow">return</span>( TRUE );
<a name="l02631"></a>02631 }
<a name="l02632"></a>02632 
<a name="l02633"></a>02633 
<a name="l02634"></a><a class="code" href="Handle_01Items_8h.html#745b330543772dad079b18b992c21d28">02634</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#745b330543772dad079b18b992c21d28">RemoveItemPool</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel )
<a name="l02635"></a>02635 {
<a name="l02636"></a>02636       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l02637"></a>02637 
<a name="l02638"></a>02638       <span class="comment">// Check for and existing pool on the object layer</span>
<a name="l02639"></a>02639       <span class="keywordflow">while</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, ubLevel ) == TRUE )
<a name="l02640"></a>02640       {
<a name="l02641"></a>02641             <a class="code" href="Handle_01Items_8cpp.html#e60fbe0d27199e2f0c08121214fd7306">RemoveItemFromPool</a>( sGridNo, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, ubLevel );
<a name="l02642"></a>02642       }
<a name="l02643"></a>02643 }
<a name="l02644"></a>02644 
<a name="l02645"></a><a class="code" href="Handle_01Items_8h.html#e3999819de51fad53dd9a8a6fe6f1c75">02645</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#e3999819de51fad53dd9a8a6fe6f1c75">RemoveAllUnburiedItems</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel )
<a name="l02646"></a>02646 {
<a name="l02647"></a>02647       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l02648"></a>02648 
<a name="l02649"></a>02649       <span class="comment">// Check for and existing pool on the object layer</span>
<a name="l02650"></a>02650       <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, ubLevel );
<a name="l02651"></a>02651 
<a name="l02652"></a>02652       <span class="keywordflow">while</span>( pItemPool )
<a name="l02653"></a>02653       {
<a name="l02654"></a>02654             <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].bVisible == BURIED)
<a name="l02655"></a>02655             {
<a name="l02656"></a>02656                   pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02657"></a>02657             }
<a name="l02658"></a>02658             <span class="keywordflow">else</span>
<a name="l02659"></a>02659             {
<a name="l02660"></a>02660                   <a class="code" href="Handle_01Items_8cpp.html#e60fbe0d27199e2f0c08121214fd7306">RemoveItemFromPool</a>( sGridNo, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, ubLevel );
<a name="l02661"></a>02661                   <span class="comment">// get new start pointer</span>
<a name="l02662"></a>02662                   <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, ubLevel );
<a name="l02663"></a>02663             }
<a name="l02664"></a>02664       }
<a name="l02665"></a>02665 }
<a name="l02666"></a>02666 
<a name="l02667"></a>02667 
<a name="l02668"></a><a class="code" href="Handle_01Items_8cpp.html#4a008d94c6175493677c51ac523c5d26">02668</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#4a008d94c6175493677c51ac523c5d26">LoopLevelNodeForShowThroughFlag</a>( <a class="code" href="structTAG__level__node.html">LEVELNODE</a> *pNode, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel )
<a name="l02669"></a>02669 {
<a name="l02670"></a>02670       <span class="keywordflow">while</span> ( pNode != NULL )
<a name="l02671"></a>02671       {
<a name="l02672"></a>02672             <span class="keywordflow">if</span> ( pNode-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> &amp; LEVELNODE_ITEM )
<a name="l02673"></a>02673             {
<a name="l02674"></a>02674                   <span class="keywordflow">if</span> ( ubLevel == 0 )
<a name="l02675"></a>02675                   {
<a name="l02676"></a>02676                         <span class="comment">// If we are in a room....</span>
<a name="l02677"></a>02677                         <span class="comment">// if ( IsRoofPresentAtGridno( sGridNo ) || gfCaves || gfBasement )</span>
<a name="l02678"></a>02678                         {
<a name="l02679"></a>02679                               pNode-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> |= LEVELNODE_SHOW_THROUGH;
<a name="l02680"></a>02680                         }
<a name="l02681"></a>02681                   }
<a name="l02682"></a>02682                   <span class="keywordflow">else</span>
<a name="l02683"></a>02683                   {
<a name="l02684"></a>02684                         pNode-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> |= LEVELNODE_SHOW_THROUGH;
<a name="l02685"></a>02685                   }
<a name="l02686"></a>02686 
<a name="l02687"></a>02687                   <span class="keywordflow">if</span>( <a class="code" href="GameSettings_8cpp.html#955420499d1cb3101625c85ea703b6bb">gGameSettings</a>.<a class="code" href="structGAME__SETTINGS.html#9d80dbd111727423b8924b5e72e3a0ed">fOptions</a>[ <a class="code" href="GameSettings_8h.html#394b3903fbf00ba2b6243f60689a5a5f5539cd515a6cdfc403cdc76d54d7ef2f">TOPTION_GLOW_ITEMS</a> ] ) 
<a name="l02688"></a>02688                   {
<a name="l02689"></a>02689                         pNode-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> |= LEVELNODE_DYNAMIC;
<a name="l02690"></a>02690                   }
<a name="l02691"></a>02691 
<a name="l02692"></a>02692             }
<a name="l02693"></a>02693             pNode = pNode-&gt;<a class="code" href="structTAG__level__node.html#7c693acc3b593ab866b789ba7542eef7">pNext</a>;
<a name="l02694"></a>02694       }
<a name="l02695"></a>02695 }
<a name="l02696"></a>02696 
<a name="l02697"></a><a class="code" href="Handle_01Items_8cpp.html#c7f2be5d75afa5e5fd1e74b3813c4cea">02697</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#c7f2be5d75afa5e5fd1e74b3813c4cea">HandleItemObscuredFlag</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel )
<a name="l02698"></a>02698 {
<a name="l02699"></a>02699       <a class="code" href="structTAG__level__node.html">LEVELNODE</a> *pNode;
<a name="l02700"></a>02700 
<a name="l02701"></a>02701       <span class="keywordflow">if</span> ( ubLevel == 0 )
<a name="l02702"></a>02702       {
<a name="l02703"></a>02703             pNode = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#0cc751d3c74e25ab6dd78d58da155f6d">pStructHead</a>;
<a name="l02704"></a>02704             <a class="code" href="Handle_01Items_8cpp.html#4a008d94c6175493677c51ac523c5d26">LoopLevelNodeForShowThroughFlag</a>( pNode, sGridNo,  ubLevel );
<a name="l02705"></a>02705       }
<a name="l02706"></a>02706       <span class="keywordflow">else</span>
<a name="l02707"></a>02707       {
<a name="l02708"></a>02708             pNode = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#cc1855e037c8009f869e8d4ef8f90e6c">pOnRoofHead</a>;
<a name="l02709"></a>02709             <a class="code" href="Handle_01Items_8cpp.html#4a008d94c6175493677c51ac523c5d26">LoopLevelNodeForShowThroughFlag</a>( pNode, sGridNo, ubLevel );
<a name="l02710"></a>02710       }
<a name="l02711"></a>02711 }
<a name="l02712"></a>02712 
<a name="l02713"></a>02713 
<a name="l02714"></a><a class="code" href="Handle_01Items_8h.html#d2466e7c6ba932d50b6b96ddb398b0d4">02714</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#d2466e7c6ba932d50b6b96ddb398b0d4">SetItemPoolVisibilityOn</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bAllGreaterThan, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fSetLocator )
<a name="l02715"></a>02715 {
<a name="l02716"></a>02716       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPoolTemp;
<a name="l02717"></a>02717       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fAtLeastModified = FALSE, fDeleted = FALSE;
<a name="l02718"></a>02718       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                    bVisibleValue;
<a name="l02719"></a>02719       <span class="comment">//OBJECTTYPE *pObj;</span>
<a name="l02720"></a>02720 
<a name="l02721"></a>02721       pItemPoolTemp = pItemPool;
<a name="l02722"></a>02722       <span class="keywordflow">while</span>( pItemPoolTemp != NULL )
<a name="l02723"></a>02723       {
<a name="l02724"></a>02724             bVisibleValue = <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].<a class="code" href="structWORLDITEM.html#c2c79d0683fed574b39e0f3c90f24e34">bVisible</a>;
<a name="l02725"></a>02725 
<a name="l02726"></a>02726             <span class="comment">// Update each item...</span>
<a name="l02727"></a>02727             <span class="keywordflow">if</span> ( bVisibleValue != VISIBLE )
<a name="l02728"></a>02728             {
<a name="l02729"></a>02729                   <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.usItem == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4badb02dc80151403af1a50e2e767fc85">ACTION_ITEM</a> )
<a name="l02730"></a>02730                   {
<a name="l02731"></a>02731                         <span class="comment">// NEVER MAKE VISIBLE!</span>
<a name="l02732"></a>02732                         pItemPoolTemp = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02733"></a>02733                         <span class="keywordflow">continue</span>;
<a name="l02734"></a>02734                   }
<a name="l02735"></a>02735 
<a name="l02736"></a>02736                   <span class="comment">// If we have reached a visible value we should not modify, ignore...</span>
<a name="l02737"></a>02737                   <span class="keywordflow">if</span> ( bVisibleValue &gt;= bAllGreaterThan &amp;&amp; <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.usItem != <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4f8504500da6b5018e9afcfb429a4768d">OWNERSHIP</a> )
<a name="l02738"></a>02738                   {
<a name="l02739"></a>02739                         <span class="comment">// Update the world value</span>
<a name="l02740"></a>02740                         <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].<a class="code" href="structWORLDITEM.html#c2c79d0683fed574b39e0f3c90f24e34">bVisible</a> = VISIBLE;
<a name="l02741"></a>02741 
<a name="l02742"></a>02742                         fAtLeastModified = TRUE;
<a name="l02743"></a>02743                   }
<a name="l02744"></a>02744 
<a name="l02745"></a>02745                   <span class="comment">/*                 </span>
<a name="l02746"></a>02746 <span class="comment">                  if ( gWorldItems[ pItemPoolTemp-&gt;iItemIndex ].o.usItem == ACTION_ITEM )</span>
<a name="l02747"></a>02747 <span class="comment">                  {</span>
<a name="l02748"></a>02748 <span class="comment">                        pObj = &amp;(gWorldItems[ pItemPoolTemp-&gt;iItemIndex ].o);</span>
<a name="l02749"></a>02749 <span class="comment">                        switch( pObj-&gt;bActionValue )</span>
<a name="l02750"></a>02750 <span class="comment">                        {</span>
<a name="l02751"></a>02751 <span class="comment">                              case ACTION_ITEM_SMALL_PIT:</span>
<a name="l02752"></a>02752 <span class="comment">                              case ACTION_ITEM_LARGE_PIT:</span>
<a name="l02753"></a>02753 <span class="comment">                                    if (pObj-&gt;bDetonatorType == 0)</span>
<a name="l02754"></a>02754 <span class="comment">                                    {</span>
<a name="l02755"></a>02755 <span class="comment">                                          // randomly set to active or destroy the item!</span>
<a name="l02756"></a>02756 <span class="comment">                                          if (Random( 100 ) &lt; 65)</span>
<a name="l02757"></a>02757 <span class="comment">                                          {</span>
<a name="l02758"></a>02758 <span class="comment">                                                ArmBomb( pObj, 0 ); // will be set to pressure type so freq is irrelevant</span>
<a name="l02759"></a>02759 <span class="comment">                                                gWorldItems[ pItemPoolTemp-&gt;iItemIndex ].usFlags |= WORLD_ITEM_ARMED_BOMB;</span>
<a name="l02760"></a>02760 <span class="comment">                                                AddBombToWorld( pItemPoolTemp-&gt;iItemIndex );</span>
<a name="l02761"></a>02761 <span class="comment">                                          }</span>
<a name="l02762"></a>02762 <span class="comment">                                          else</span>
<a name="l02763"></a>02763 <span class="comment">                                          {</span>
<a name="l02764"></a>02764 <span class="comment">                                                // get pointer to the next element NOW</span>
<a name="l02765"></a>02765 <span class="comment">                                                pItemPoolTemp     = pItemPoolTemp-&gt;pNext;</span>
<a name="l02766"></a>02766 <span class="comment">                                                // set flag so we don't traverse an additional time</span>
<a name="l02767"></a>02767 <span class="comment">                                                fDeleted = TRUE;</span>
<a name="l02768"></a>02768 <span class="comment">                                                // remove item from pool</span>
<a name="l02769"></a>02769 <span class="comment">                                                RemoveItemFromPool( pItemPool-&gt;sGridNo, pItemPool-&gt;iItemIndex, pItemPool-&gt;ubLevel );</span>
<a name="l02770"></a>02770 <span class="comment">                                          }</span>
<a name="l02771"></a>02771 <span class="comment">                                    }</span>
<a name="l02772"></a>02772 <span class="comment">                                    break;</span>
<a name="l02773"></a>02773 <span class="comment">                              default:</span>
<a name="l02774"></a>02774 <span class="comment">                                    break;</span>
<a name="l02775"></a>02775 <span class="comment">                        }</span>
<a name="l02776"></a>02776 <span class="comment">                  }</span>
<a name="l02777"></a>02777 <span class="comment">                  */</span>
<a name="l02778"></a>02778 
<a name="l02779"></a>02779                   <span class="keywordflow">if</span> (fDeleted)
<a name="l02780"></a>02780                   {
<a name="l02781"></a>02781                         <span class="comment">// don't get the 'next' pointer because we did so above</span>
<a name="l02782"></a>02782 
<a name="l02783"></a>02783                         <span class="comment">// reset fDeleted to false so we don't skip moving through the list more than once</span>
<a name="l02784"></a>02784                         fDeleted = FALSE;
<a name="l02785"></a>02785                   }
<a name="l02786"></a>02786                   <span class="keywordflow">else</span>
<a name="l02787"></a>02787                   {
<a name="l02788"></a>02788                         pItemPoolTemp                                   = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02789"></a>02789                   }
<a name="l02790"></a>02790 
<a name="l02791"></a>02791             }
<a name="l02792"></a>02792             <span class="keywordflow">else</span>
<a name="l02793"></a>02793             {
<a name="l02794"></a>02794                   pItemPoolTemp                                   = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02795"></a>02795             }
<a name="l02796"></a>02796       }
<a name="l02797"></a>02797 
<a name="l02798"></a>02798       <span class="comment">// If we didn;t find any that should be modified..</span>
<a name="l02799"></a>02799       <span class="keywordflow">if</span> ( !fAtLeastModified )
<a name="l02800"></a>02800       {
<a name="l02801"></a>02801             <span class="keywordflow">return</span>( FALSE );
<a name="l02802"></a>02802       }
<a name="l02803"></a>02803 
<a name="l02804"></a>02804 
<a name="l02805"></a>02805       <span class="comment">// Update global pool bVisible to true ( if at least one is visible... )</span>
<a name="l02806"></a>02806       pItemPoolTemp = pItemPool;
<a name="l02807"></a>02807       <span class="keywordflow">while</span>( pItemPoolTemp != NULL )
<a name="l02808"></a>02808       {
<a name="l02809"></a>02809             pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#b4cda5e950dbf9506a3442f956476659">bVisible</a> = VISIBLE;
<a name="l02810"></a>02810 
<a name="l02811"></a>02811             pItemPoolTemp                                   = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02812"></a>02812       }
<a name="l02813"></a>02813 
<a name="l02814"></a>02814       <span class="comment">// Handle obscured flag...</span>
<a name="l02815"></a>02815       <a class="code" href="Handle_01Items_8cpp.html#c7f2be5d75afa5e5fd1e74b3813c4cea">HandleItemObscuredFlag</a>( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a>, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#d001579cc68909cba0f885510f2d242a">ubLevel</a> );
<a name="l02816"></a>02816 
<a name="l02817"></a>02817       <span class="keywordflow">if</span> ( fSetLocator )
<a name="l02818"></a>02818       {
<a name="l02819"></a>02819             <a class="code" href="Handle_01Items_8cpp.html#79961f4def8b8b7faaea39edc3f0e728">SetItemPoolLocator</a>( pItemPool );
<a name="l02820"></a>02820       }
<a name="l02821"></a>02821 
<a name="l02822"></a>02822       <span class="keywordflow">return</span>( TRUE );
<a name="l02823"></a>02823 }
<a name="l02824"></a>02824 
<a name="l02825"></a>02825 
<a name="l02826"></a><a class="code" href="Handle_01Items_8h.html#72fd82a8e682384608b0556832970c51">02826</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#72fd82a8e682384608b0556832970c51">SetItemPoolVisibilityHidden</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool )
<a name="l02827"></a>02827 {
<a name="l02828"></a>02828       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPoolTemp;
<a name="l02829"></a>02829 
<a name="l02830"></a>02830       pItemPoolTemp = pItemPool;
<a name="l02831"></a>02831       <span class="keywordflow">while</span>( pItemPoolTemp != NULL )
<a name="l02832"></a>02832       {
<a name="l02833"></a>02833             <span class="comment">// Update the world value</span>
<a name="l02834"></a>02834             <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].<a class="code" href="structWORLDITEM.html#c2c79d0683fed574b39e0f3c90f24e34">bVisible</a> = HIDDEN_IN_OBJECT;
<a name="l02835"></a>02835             pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#b4cda5e950dbf9506a3442f956476659">bVisible</a> = HIDDEN_IN_OBJECT;
<a name="l02836"></a>02836 
<a name="l02837"></a>02837             pItemPoolTemp                                   = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02838"></a>02838       }
<a name="l02839"></a>02839 }
<a name="l02840"></a>02840 
<a name="l02841"></a>02841 <span class="comment">// This determines the overall initial visibility of the pool...</span>
<a name="l02842"></a>02842 <span class="comment">// IF ANY are set to VISIBLE, MODIFY</span>
<a name="l02843"></a><a class="code" href="Handle_01Items_8h.html#d8e674b58e835f4a49cd565c8313aba6">02843</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#d8e674b58e835f4a49cd565c8313aba6">AdjustItemPoolVisibility</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool )
<a name="l02844"></a>02844 {
<a name="l02845"></a>02845       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPoolTemp;
<a name="l02846"></a>02846       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fAtLeastModified = FALSE;
<a name="l02847"></a>02847 
<a name="l02848"></a>02848       pItemPoolTemp = pItemPool;
<a name="l02849"></a>02849       <span class="keywordflow">while</span>( pItemPoolTemp != NULL )
<a name="l02850"></a>02850       {
<a name="l02851"></a>02851             <span class="comment">// DEFAULT ITEM POOL TO INVISIBLE....</span>
<a name="l02852"></a>02852             pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#b4cda5e950dbf9506a3442f956476659">bVisible</a> = INVISIBLE;
<a name="l02853"></a>02853 
<a name="l02854"></a>02854             <span class="comment">// Update each item...</span>
<a name="l02855"></a>02855             <span class="comment">// If we have reached a visible value we should not modify, ignore...</span>
<a name="l02856"></a>02856             <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].bVisible == VISIBLE )
<a name="l02857"></a>02857             {
<a name="l02858"></a>02858                   fAtLeastModified = TRUE;
<a name="l02859"></a>02859             }
<a name="l02860"></a>02860 
<a name="l02861"></a>02861             pItemPoolTemp                                   = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02862"></a>02862       }
<a name="l02863"></a>02863 
<a name="l02864"></a>02864       <span class="comment">// Handle obscured flag...</span>
<a name="l02865"></a>02865       <a class="code" href="Handle_01Items_8cpp.html#c7f2be5d75afa5e5fd1e74b3813c4cea">HandleItemObscuredFlag</a>( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a>, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#d001579cc68909cba0f885510f2d242a">ubLevel</a> );
<a name="l02866"></a>02866 
<a name="l02867"></a>02867       <span class="comment">// If we didn;t find any that should be modified..</span>
<a name="l02868"></a>02868       <span class="keywordflow">if</span> ( !fAtLeastModified )
<a name="l02869"></a>02869       {
<a name="l02870"></a>02870             <span class="keywordflow">return</span>;
<a name="l02871"></a>02871       }
<a name="l02872"></a>02872 
<a name="l02873"></a>02873       <span class="comment">// Update global pool bVisible to true ( if at least one is visible... )</span>
<a name="l02874"></a>02874       pItemPoolTemp = pItemPool;
<a name="l02875"></a>02875       <span class="keywordflow">while</span>( pItemPoolTemp != NULL )
<a name="l02876"></a>02876       {
<a name="l02877"></a>02877             pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#b4cda5e950dbf9506a3442f956476659">bVisible</a> = VISIBLE;
<a name="l02878"></a>02878 
<a name="l02879"></a>02879             pItemPoolTemp                                   = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02880"></a>02880       }
<a name="l02881"></a>02881 
<a name="l02882"></a>02882       <span class="comment">// Handle obscured flag...</span>
<a name="l02883"></a>02883       <a class="code" href="Handle_01Items_8cpp.html#c7f2be5d75afa5e5fd1e74b3813c4cea">HandleItemObscuredFlag</a>( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a>, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#d001579cc68909cba0f885510f2d242a">ubLevel</a> );
<a name="l02884"></a>02884 }
<a name="l02885"></a>02885 
<a name="l02886"></a>02886 
<a name="l02887"></a><a class="code" href="Handle_01Items_8h.html#e60fbe0d27199e2f0c08121214fd7306">02887</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#e60fbe0d27199e2f0c08121214fd7306">RemoveItemFromPool</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iItemIndex, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel )
<a name="l02888"></a>02888 {
<a name="l02889"></a>02889       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l02890"></a>02890       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPoolTemp;
<a name="l02891"></a>02891       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fItemFound = FALSE;
<a name="l02892"></a>02892       <a class="code" href="structTAG__level__node.html">LEVELNODE</a>         *pObject;
<a name="l02893"></a>02893 
<a name="l02894"></a>02894 
<a name="l02895"></a>02895       <span class="comment">// Check for and existing pool on the object layer</span>
<a name="l02896"></a>02896       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sGridNo, &amp;pItemPool, ubLevel ) )
<a name="l02897"></a>02897       {
<a name="l02898"></a>02898 
<a name="l02899"></a>02899             <span class="comment">// REMOVE FROM LIST</span>
<a name="l02900"></a>02900             
<a name="l02901"></a>02901             <span class="comment">// LOOP THROUGH LIST TO FIND NODE WE WANT</span>
<a name="l02902"></a>02902             pItemPoolTemp = pItemPool;
<a name="l02903"></a>02903             <span class="keywordflow">while</span>( pItemPoolTemp != NULL )
<a name="l02904"></a>02904             {
<a name="l02905"></a>02905                   <span class="keywordflow">if</span> ( pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> == iItemIndex )
<a name="l02906"></a>02906                   {
<a name="l02907"></a>02907                         fItemFound = TRUE;
<a name="l02908"></a>02908                         <span class="keywordflow">break</span>;
<a name="l02909"></a>02909                   }
<a name="l02910"></a>02910                   pItemPoolTemp = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02911"></a>02911             }
<a name="l02912"></a>02912 
<a name="l02913"></a>02913             <span class="keywordflow">if</span> ( !fItemFound )
<a name="l02914"></a>02914             {
<a name="l02915"></a>02915                   <span class="comment">// COULDNOT FIND ITEM? MAYBE SOMEBODY GOT IT BEFORE WE GOT THERE!</span>
<a name="l02916"></a>02916                   <span class="keywordflow">return</span>( FALSE );
<a name="l02917"></a>02917             }
<a name="l02918"></a>02918 
<a name="l02919"></a>02919             <span class="comment">// REMOVE GRAPHIC</span>
<a name="l02920"></a>02920             <a class="code" href="Handle_01Items_8cpp.html#e4a707ca7113a89b31388f924084e62b">RemoveItemGraphicFromWorld</a>( &amp;(<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iItemIndex ].o.usItem ] ), sGridNo, ubLevel, pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8fb6ca67b4c4dc719e7d2b927cbb510f">pLevelNode</a> );
<a name="l02921"></a>02921 
<a name="l02922"></a>02922             <span class="comment">// IF WE ARE LOCATIONG STILL, KILL LOCATOR!</span>
<a name="l02923"></a>02923             <span class="keywordflow">if</span> ( pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#73d13babb7b64e62eb568cb3d1b73c03">bFlashColor</a> != 0 )
<a name="l02924"></a>02924             {
<a name="l02925"></a>02925                   <span class="comment">// REMOVE TIMER!</span>
<a name="l02926"></a>02926                   <a class="code" href="Handle_01Items_8cpp.html#5d83ffed8d6e4efd1820b490234df23d">RemoveFlashItemSlot</a>( pItemPoolTemp );
<a name="l02927"></a>02927             }
<a name="l02928"></a>02928 
<a name="l02929"></a>02929             <span class="comment">// REMOVE PREV</span>
<a name="l02930"></a>02930             <span class="keywordflow">if</span> ( pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#7ee735a43a38256a0497c42e45054efc">pPrev</a> != NULL )
<a name="l02931"></a>02931             {
<a name="l02932"></a>02932                   pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#7ee735a43a38256a0497c42e45054efc">pPrev</a>-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a> = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02933"></a>02933             }
<a name="l02934"></a>02934 
<a name="l02935"></a>02935             <span class="comment">// REMOVE NEXT</span>
<a name="l02936"></a>02936             <span class="keywordflow">if</span> ( pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a> != NULL )
<a name="l02937"></a>02937             {
<a name="l02938"></a>02938                   pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>-&gt;<a class="code" href="structTAG__ITEM__POOL.html#7ee735a43a38256a0497c42e45054efc">pPrev</a> = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#7ee735a43a38256a0497c42e45054efc">pPrev</a>;
<a name="l02939"></a>02939             }
<a name="l02940"></a>02940 
<a name="l02941"></a>02941 
<a name="l02942"></a>02942             <span class="comment">// IF THIS NODE WAS THE HEAD, SET ANOTHER AS HEAD AT THIS GRIDNO</span>
<a name="l02943"></a>02943             <span class="keywordflow">if</span> ( pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#7ee735a43a38256a0497c42e45054efc">pPrev</a> == NULL )
<a name="l02944"></a>02944             {
<a name="l02945"></a>02945                   <span class="comment">// WE'RE HEAD</span>
<a name="l02946"></a>02946                   <span class="keywordflow">if</span> ( ubLevel == 0 )
<a name="l02947"></a>02947                   {
<a name="l02948"></a>02948                         pObject = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#0cc751d3c74e25ab6dd78d58da155f6d">pStructHead</a>;
<a name="l02949"></a>02949                   }
<a name="l02950"></a>02950                   <span class="keywordflow">else</span>
<a name="l02951"></a>02951                   {
<a name="l02952"></a>02952                         pObject = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#cc1855e037c8009f869e8d4ef8f90e6c">pOnRoofHead</a>;
<a name="l02953"></a>02953                   }
<a name="l02954"></a>02954 
<a name="l02955"></a>02955                   fItemFound = FALSE;
<a name="l02956"></a>02956                   <span class="comment">// LOOP THORUGH OBJECT LAYER</span>
<a name="l02957"></a>02957                   <span class="keywordflow">while</span>( pObject != NULL )
<a name="l02958"></a>02958                   {
<a name="l02959"></a>02959                         <span class="keywordflow">if</span> ( pObject-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> &amp; LEVELNODE_ITEM )
<a name="l02960"></a>02960                         {
<a name="l02961"></a>02961                               <span class="comment">// ADJUST TO NEXT GUY FOR HEAD</span>
<a name="l02962"></a>02962                               pObject-&gt;<a class="code" href="structTAG__level__node.html#8624c806c103872cc6f98e52e7ed9e3d">pItemPool</a> = pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l02963"></a>02963                               fItemFound = TRUE;
<a name="l02964"></a>02964                         }
<a name="l02965"></a>02965                         pObject = pObject-&gt;<a class="code" href="structTAG__level__node.html#7c693acc3b593ab866b789ba7542eef7">pNext</a>;
<a name="l02966"></a>02966                   }
<a name="l02967"></a>02967 
<a name="l02968"></a>02968                   <span class="keywordflow">if</span> (!fItemFound)
<a name="l02969"></a>02969                   {
<a name="l02970"></a>02970                         <span class="comment">// THIS WAS THE LAST ITEM IN THE POOL!</span>
<a name="l02971"></a>02971                         <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[sGridNo].<a class="code" href="structMAP__ELEMENT.html#430f12029207b5bb7b32ed30ef355253">uiFlags</a> &amp;= ~(MAPELEMENT_ITEMPOOL_PRESENT);
<a name="l02972"></a>02972                   }
<a name="l02973"></a>02973             }
<a name="l02974"></a>02974 
<a name="l02975"></a>02975             <span class="comment">// Find any structure with flag set as having items on top.. if this one did...</span>
<a name="l02976"></a>02976             <span class="keywordflow">if</span> ( pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a> &gt; 0 )
<a name="l02977"></a>02977             {
<a name="l02978"></a>02978                   <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a>         *pStructure;
<a name="l02979"></a>02979                   <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pTempPool;
<a name="l02980"></a>02980 
<a name="l02981"></a>02981                   <span class="comment">// Check if an item pool exists here....</span>
<a name="l02982"></a>02982                   <span class="keywordflow">if</span> ( !<a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a>, &amp;pTempPool, pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#d001579cc68909cba0f885510f2d242a">ubLevel</a> ) )
<a name="l02983"></a>02983                   {
<a name="l02984"></a>02984                         pStructure = <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( pItemPoolTemp-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a> , STRUCTURE_HASITEMONTOP );
<a name="l02985"></a>02985                         
<a name="l02986"></a>02986                         <span class="keywordflow">if</span> ( pStructure != NULL )
<a name="l02987"></a>02987                         {
<a name="l02988"></a>02988                               <span class="comment">// Remove...</span>
<a name="l02989"></a>02989                               pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#5a803a00d8769236709b4f0665951383">fFlags</a> &amp;= (~STRUCTURE_HASITEMONTOP );
<a name="l02990"></a>02990 
<a name="l02991"></a>02991                               <span class="comment">// Re-adjust interactive tile...</span>
<a name="l02992"></a>02992                               <a class="code" href="Interactive_01Tiles_8cpp.html#8503760df18f34bd35bd17ba87e00227">BeginCurInteractiveTileCheck</a>( INTILE_CHECK_SELECTIVE );
<a name="l02993"></a>02993                         }
<a name="l02994"></a>02994                   }
<a name="l02995"></a>02995             }
<a name="l02996"></a>02996 
<a name="l02997"></a>02997             <a class="code" href="Handle_01Items_8cpp.html#d8e674b58e835f4a49cd565c8313aba6">AdjustItemPoolVisibility</a>( pItemPoolTemp );
<a name="l02998"></a>02998 
<a name="l02999"></a>02999             <span class="comment">// DELETE</span>
<a name="l03000"></a>03000             MemFree( pItemPoolTemp );
<a name="l03001"></a>03001 
<a name="l03002"></a>03002             <a class="code" href="World_01Items_8cpp.html#8abc94b7da803f150d4c8c57389e3cbe">RemoveItemFromWorld</a>( iItemIndex );
<a name="l03003"></a>03003             
<a name="l03004"></a>03004             <span class="keywordflow">return</span>( TRUE );
<a name="l03005"></a>03005       }
<a name="l03006"></a>03006 
<a name="l03007"></a>03007       <span class="keywordflow">return</span>( FALSE );
<a name="l03008"></a>03008 }
<a name="l03009"></a>03009 
<a name="l03010"></a><a class="code" href="Handle_01Items_8h.html#5fb3f882e72fa47505d032f333224fc5">03010</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#5fb3f882e72fa47505d032f333224fc5">MoveItemPools</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sStartPos, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sEndPos )
<a name="l03011"></a>03011 {
<a name="l03012"></a>03012       <span class="comment">// note, only works between locations on the ground</span>
<a name="l03013"></a>03013       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l03014"></a>03014       <a class="code" href="structWORLDITEM.html">WORLDITEM</a>         TempWorldItem;
<a name="l03015"></a>03015 
<a name="l03016"></a>03016       <span class="comment">// While there is an existing pool</span>
<a name="l03017"></a>03017       <span class="keywordflow">while</span>( <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( sStartPos, &amp;pItemPool, 0 ) )
<a name="l03018"></a>03018       {
<a name="l03019"></a>03019             memcpy( &amp;TempWorldItem, &amp;(<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ]), <span class="keyword">sizeof</span>( <a class="code" href="structWORLDITEM.html">WORLDITEM</a> ) );
<a name="l03020"></a>03020             <a class="code" href="Handle_01Items_8cpp.html#e60fbe0d27199e2f0c08121214fd7306">RemoveItemFromPool</a>( sStartPos, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, 0 );
<a name="l03021"></a>03021             <a class="code" href="Handle_01Items_8cpp.html#ca7f6f6da97e9a4c2b737296485f5c84">AddItemToPool</a>( sEndPos, &amp;(TempWorldItem.<a class="code" href="structWORLDITEM.html#0f219e2d7aafd3aeca85991add1ef5f8">o</a>), -1, TempWorldItem.<a class="code" href="structWORLDITEM.html#8d003401e1c598e2f0c8a71c1a662b51">ubLevel</a>, TempWorldItem.<a class="code" href="structWORLDITEM.html#2541b9925d33bbad4966199febf0443d">usFlags</a>, TempWorldItem.<a class="code" href="structWORLDITEM.html#f52d51fbc924e18ed40d6e2abf035786">bRenderZHeightAboveLevel</a> );
<a name="l03022"></a>03022       }
<a name="l03023"></a>03023       <span class="keywordflow">return</span>( TRUE );
<a name="l03024"></a>03024 }
<a name="l03025"></a>03025 
<a name="l03026"></a><a class="code" href="Handle_01Items_8h.html#f3115ef99b74538fde1620eee4e58261">03026</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>     <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> usMapPos, <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> **ppItemPool, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel )
<a name="l03027"></a>03027 {
<a name="l03028"></a>03028       <a class="code" href="structTAG__level__node.html">LEVELNODE</a> *pObject;
<a name="l03029"></a>03029 
<a name="l03030"></a>03030       <span class="keywordflow">if</span> ( ubLevel == 0 )
<a name="l03031"></a>03031       {
<a name="l03032"></a>03032             pObject = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ usMapPos ].<a class="code" href="structMAP__ELEMENT.html#0cc751d3c74e25ab6dd78d58da155f6d">pStructHead</a>;
<a name="l03033"></a>03033       }
<a name="l03034"></a>03034       <span class="keywordflow">else</span>
<a name="l03035"></a>03035       {
<a name="l03036"></a>03036             pObject = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ usMapPos ].<a class="code" href="structMAP__ELEMENT.html#cc1855e037c8009f869e8d4ef8f90e6c">pOnRoofHead</a>;
<a name="l03037"></a>03037       }
<a name="l03038"></a>03038 
<a name="l03039"></a>03039       (*ppItemPool) = NULL;
<a name="l03040"></a>03040 
<a name="l03041"></a>03041       <span class="comment">// LOOP THORUGH OBJECT LAYER</span>
<a name="l03042"></a>03042       <span class="keywordflow">while</span>( pObject != NULL )
<a name="l03043"></a>03043       {
<a name="l03044"></a>03044             <span class="keywordflow">if</span> ( pObject-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> &amp; LEVELNODE_ITEM )
<a name="l03045"></a>03045             {
<a name="l03046"></a>03046                   (*ppItemPool) = pObject-&gt;<a class="code" href="structTAG__level__node.html#8624c806c103872cc6f98e52e7ed9e3d">pItemPool</a>;
<a name="l03047"></a>03047 
<a name="l03048"></a>03048                   <span class="comment">//DEF added the check because pObject-&gt;pItemPool was NULL which was causing problems</span>
<a name="l03049"></a>03049                   <span class="keywordflow">if</span>( *ppItemPool )
<a name="l03050"></a>03050                         <span class="keywordflow">return</span>( TRUE );
<a name="l03051"></a>03051                   <span class="keywordflow">else</span>
<a name="l03052"></a>03052                         <span class="keywordflow">return</span>( FALSE );
<a name="l03053"></a>03053             }
<a name="l03054"></a>03054 
<a name="l03055"></a>03055             pObject = pObject-&gt;<a class="code" href="structTAG__level__node.html#7c693acc3b593ab866b789ba7542eef7">pNext</a>;
<a name="l03056"></a>03056       }
<a name="l03057"></a>03057 
<a name="l03058"></a>03058       <span class="keywordflow">return</span>( FALSE );  
<a name="l03059"></a>03059 }
<a name="l03060"></a>03060 
<a name="l03061"></a>03061 
<a name="l03062"></a>03062 
<a name="l03063"></a><a class="code" href="Handle_01Items_8h.html#ef92c00fc5ad51b4a9064e4a09d59492">03063</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#ef92c00fc5ad51b4a9064e4a09d59492">NotifySoldiersToLookforItems</a>( )
<a name="l03064"></a>03064 {
<a name="l03065"></a>03065       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> cnt;
<a name="l03066"></a>03066       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l03067"></a>03067 
<a name="l03068"></a>03068       <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; <a class="code" href="Overhead_8cpp.html#d627c552ede524c66140f3410174d3d4">guiNumMercSlots</a>; cnt++ )
<a name="l03069"></a>03069       {
<a name="l03070"></a>03070             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Overhead_8cpp.html#b139938f6b836645dd67972944d21bf3">MercSlots</a>[ cnt ];
<a name="l03071"></a>03071 
<a name="l03072"></a>03072             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> != NULL )
<a name="l03073"></a>03073             {
<a name="l03074"></a>03074                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> |= SOLDIER_LOOKFOR_ITEMS;
<a name="l03075"></a>03075             }
<a name="l03076"></a>03076       }
<a name="l03077"></a>03077 
<a name="l03078"></a>03078 }
<a name="l03079"></a>03079 
<a name="l03080"></a>03080 
<a name="l03081"></a><a class="code" href="Handle_01Items_8h.html#c366146cd2d05be5cf8f66c77b7a0673">03081</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#55eecbf7cc73e99f7a432b43d6d6407b">AllSoldiersLookforItems</a>( <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fShowLocators )
<a name="l03082"></a>03082 {
<a name="l03083"></a>03083       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> cnt;
<a name="l03084"></a>03084       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l03085"></a>03085 
<a name="l03086"></a>03086       <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; <a class="code" href="Overhead_8cpp.html#d627c552ede524c66140f3410174d3d4">guiNumMercSlots</a>; cnt++ )
<a name="l03087"></a>03087       {
<a name="l03088"></a>03088             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Overhead_8cpp.html#b139938f6b836645dd67972944d21bf3">MercSlots</a>[ cnt ];
<a name="l03089"></a>03089 
<a name="l03090"></a>03090             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> != NULL )
<a name="l03091"></a>03091             {
<a name="l03092"></a>03092                   <a class="code" href="fov_8cpp.html#724f63c284560d0fc27088bcfc15e1c4">RevealRoofsAndItems</a>(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, TRUE, fShowLocators, pSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, FALSE );
<a name="l03093"></a>03093             }
<a name="l03094"></a>03094       }
<a name="l03095"></a>03095 
<a name="l03096"></a>03096 }
<a name="l03097"></a>03097 
<a name="l03098"></a>03098 
<a name="l03099"></a><a class="code" href="Handle_01Items_8h.html#658301c1b8f3e756917fcbbde1ad1a73">03099</a> <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> <a class="code" href="Handle_01Items_8cpp.html#658301c1b8f3e756917fcbbde1ad1a73">GetNumOkForDisplayItemsInPool</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bZLevel )
<a name="l03100"></a>03100 {
<a name="l03101"></a>03101       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                               cnt;
<a name="l03102"></a>03102 
<a name="l03103"></a>03103       <span class="comment">//Determine total #</span>
<a name="l03104"></a>03104       cnt = 0;
<a name="l03105"></a>03105       <span class="keywordflow">while</span>( pItemPool != NULL )
<a name="l03106"></a>03106       {
<a name="l03107"></a>03107             <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#ec958a67be0ebc67209a65183705ed24">ItemPoolOKForDisplay</a>( pItemPool, bZLevel ) )
<a name="l03108"></a>03108             {
<a name="l03109"></a>03109                   cnt++;
<a name="l03110"></a>03110             }
<a name="l03111"></a>03111 
<a name="l03112"></a>03112             pItemPool = pItemPool-&gt;pNext;       
<a name="l03113"></a>03113       }
<a name="l03114"></a>03114 
<a name="l03115"></a>03115       <span class="keywordflow">return</span>( (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) cnt );
<a name="l03116"></a>03116 }
<a name="l03117"></a>03117 
<a name="l03118"></a>03118 
<a name="l03119"></a><a class="code" href="overhead_01map_8cpp.html#ba28ec3e74ac8611edf76d9201f9e353">03119</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#ba28ec3e74ac8611edf76d9201f9e353">AnyItemsVisibleOnLevel</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bZLevel )
<a name="l03120"></a>03120 {
<a name="l03121"></a>03121       <span class="keywordflow">if</span> ( ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a> &amp; SHOW_ALL_ITEMS ) )
<a name="l03122"></a>03122       {
<a name="l03123"></a>03123             <span class="keywordflow">return</span>( TRUE );
<a name="l03124"></a>03124       }
<a name="l03125"></a>03125 
<a name="l03126"></a>03126       <span class="comment">//Determine total #</span>
<a name="l03127"></a>03127       <span class="keywordflow">while</span>( pItemPool != NULL )
<a name="l03128"></a>03128       {
<a name="l03129"></a>03129             <span class="keywordflow">if</span> ( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a> == bZLevel )
<a name="l03130"></a>03130             {
<a name="l03131"></a>03131                   <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].bVisible == VISIBLE )
<a name="l03132"></a>03132                   {
<a name="l03133"></a>03133                         <span class="keywordflow">return</span>( TRUE );
<a name="l03134"></a>03134                   }
<a name="l03135"></a>03135             }
<a name="l03136"></a>03136 
<a name="l03137"></a>03137             pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;       
<a name="l03138"></a>03138 
<a name="l03139"></a>03139       }
<a name="l03140"></a>03140 
<a name="l03141"></a>03141       <span class="keywordflow">return</span>( FALSE );
<a name="l03142"></a>03142 }
<a name="l03143"></a>03143 
<a name="l03144"></a>03144 
<a name="l03145"></a><a class="code" href="Handle_01Items_8h.html#ec958a67be0ebc67209a65183705ed24">03145</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#ec958a67be0ebc67209a65183705ed24">ItemPoolOKForDisplay</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bZLevel )
<a name="l03146"></a>03146 {
<a name="l03147"></a>03147       <span class="keywordflow">if</span> (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a>&amp;SHOW_ALL_ITEMS)
<a name="l03148"></a>03148       {
<a name="l03149"></a>03149             <span class="keywordflow">return</span>( TRUE );
<a name="l03150"></a>03150       }
<a name="l03151"></a>03151 
<a name="l03152"></a>03152       <span class="comment">// Setup some conditions!</span>
<a name="l03153"></a>03153       <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].bVisible != VISIBLE  )
<a name="l03154"></a>03154       {
<a name="l03155"></a>03155             <span class="keywordflow">return</span>( FALSE );
<a name="l03156"></a>03156       }
<a name="l03157"></a>03157 
<a name="l03158"></a>03158       <span class="comment">// If -1, it means find all</span>
<a name="l03159"></a>03159       <span class="keywordflow">if</span> ( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a> != bZLevel &amp;&amp; bZLevel != -1 )
<a name="l03160"></a>03160             {
<a name="l03161"></a>03161             <span class="keywordflow">return</span>( FALSE );
<a name="l03162"></a>03162       }
<a name="l03163"></a>03163 
<a name="l03164"></a>03164       <span class="keywordflow">return</span>( TRUE );
<a name="l03165"></a>03165 }
<a name="l03166"></a>03166 
<a name="l03167"></a><a class="code" href="Handle_01Items_8cpp.html#0a41cd226d7b2ce19b27e23f3419922c">03167</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#0a41cd226d7b2ce19b27e23f3419922c">ItemPoolOKForPickup</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bZLevel )
<a name="l03168"></a>03168 {
<a name="l03169"></a>03169       <span class="keywordflow">if</span> (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#89eb954f99ad4f28b84d7cf675c8ed32">uiFlags</a>&amp;SHOW_ALL_ITEMS)
<a name="l03170"></a>03170       {
<a name="l03171"></a>03171             <span class="keywordflow">return</span>( TRUE );
<a name="l03172"></a>03172       }
<a name="l03173"></a>03173 
<a name="l03174"></a>03174       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> )
<a name="l03175"></a>03175       {
<a name="l03176"></a>03176             <span class="comment">// Setup some conditions!</span>
<a name="l03177"></a>03177             <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].bVisible != VISIBLE  )
<a name="l03178"></a>03178             {
<a name="l03179"></a>03179                   <span class="keywordflow">return</span>( FALSE );
<a name="l03180"></a>03180             }
<a name="l03181"></a>03181       }
<a name="l03182"></a>03182 
<a name="l03183"></a>03183       <span class="comment">// If -1, it means find all</span>
<a name="l03184"></a>03184       <span class="keywordflow">if</span> ( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a> != bZLevel &amp;&amp; bZLevel != -1 )
<a name="l03185"></a>03185             {
<a name="l03186"></a>03186             <span class="keywordflow">return</span>( FALSE );
<a name="l03187"></a>03187       }
<a name="l03188"></a>03188 
<a name="l03189"></a>03189       <span class="keywordflow">return</span>( TRUE );
<a name="l03190"></a>03190 }
<a name="l03191"></a>03191 
<a name="l03192"></a>03192 
<a name="l03193"></a>03193 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#a2ffed608487a515c7e7ebf5fcfb364f">HandleAnyMercInSquadHasCompatibleStuff</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubSquad, <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *pObject, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fReset );
<a name="l03194"></a>03194 
<a name="l03195"></a>03195 
<a name="l03196"></a><a class="code" href="Handle_01Items_8h.html#19a0bde34991ee9039fe3f2c61230ef2">03196</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#19a0bde34991ee9039fe3f2c61230ef2">DrawItemPoolList</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> bCommand, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bZLevel, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sXPos, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sYPos )
<a name="l03197"></a>03197 {
<a name="l03198"></a>03198       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sY;
<a name="l03199"></a>03199       <a class="code" href="structINVTYPE.html">INVTYPE</a>                 *pItem;
<a name="l03200"></a>03200       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pTempItemPool;
<a name="l03201"></a>03201       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> pStr[ 100 ];
<a name="l03202"></a>03202       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>       cnt = 0, sHeight = 0;
<a name="l03203"></a>03203       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>  sLargeLineWidth = 0, sLineWidth;
<a name="l03204"></a>03204       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fRecalcNumListed = FALSE;
<a name="l03205"></a>03205       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fSelectionDone = FALSE;
<a name="l03206"></a>03206 
<a name="l03207"></a>03207       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                    gbCurrentItemSel = 0;
<a name="l03208"></a>03208       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                    bNumItemsListed = 0;
<a name="l03209"></a>03209       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                   sFontX, sFontY;
<a name="l03210"></a>03210       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                   sLargestLineWidth = 30;
<a name="l03211"></a>03211       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                    bCurStart = 0;
<a name="l03212"></a>03212       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fDoBack;
<a name="l03213"></a>03213 
<a name="l03214"></a>03214 
<a name="l03215"></a>03215       <span class="comment">// Take a look at each guy in current sqaud and check for compatible ammo...</span>
<a name="l03216"></a>03216 
<a name="l03217"></a>03217       <span class="comment">// Determine how many there are</span>
<a name="l03218"></a>03218       <span class="comment">// MOVE HEAD TO CURRENT START</span>
<a name="l03219"></a>03219       cnt = 0;
<a name="l03220"></a>03220       pTempItemPool = pItemPool;
<a name="l03221"></a>03221       <span class="keywordflow">while</span>( pTempItemPool != NULL )
<a name="l03222"></a>03222       {
<a name="l03223"></a>03223             <span class="keywordflow">if</span> ( cnt == bCurStart )
<a name="l03224"></a>03224             {
<a name="l03225"></a>03225                   <span class="keywordflow">break</span>;
<a name="l03226"></a>03226             }
<a name="l03227"></a>03227 
<a name="l03228"></a>03228             <span class="comment">// ATE: Put some conditions on this....</span>
<a name="l03229"></a>03229             <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#ec958a67be0ebc67209a65183705ed24">ItemPoolOKForDisplay</a>( pTempItemPool, bZLevel ) )
<a name="l03230"></a>03230             {
<a name="l03231"></a>03231                   cnt++;
<a name="l03232"></a>03232             }
<a name="l03233"></a>03233 
<a name="l03234"></a>03234             pTempItemPool = pTempItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l03235"></a>03235       }
<a name="l03236"></a>03236 
<a name="l03237"></a>03237       cnt = bCurStart;
<a name="l03238"></a>03238       fDoBack = FALSE;
<a name="l03239"></a>03239       <span class="keywordflow">while</span>( pTempItemPool != NULL )
<a name="l03240"></a>03240       {
<a name="l03241"></a>03241             <span class="comment">// IF WE HAVE MORE THAN THE SET AMOUNT, QUIT NOW!</span>
<a name="l03242"></a>03242             <span class="keywordflow">if</span> ( cnt == ( bCurStart + NUM_ITEMS_LISTED ) )
<a name="l03243"></a>03243             {
<a name="l03244"></a>03244                   cnt++;
<a name="l03245"></a>03245                   fDoBack = TRUE;
<a name="l03246"></a>03246                   <span class="keywordflow">break</span>;
<a name="l03247"></a>03247             }
<a name="l03248"></a>03248 
<a name="l03249"></a>03249             <span class="comment">// ATE: Put some conditions on this....</span>
<a name="l03250"></a>03250             <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#ec958a67be0ebc67209a65183705ed24">ItemPoolOKForDisplay</a>( pTempItemPool, bZLevel ) )
<a name="l03251"></a>03251             {
<a name="l03252"></a>03252                   cnt++;
<a name="l03253"></a>03253             }
<a name="l03254"></a>03254 
<a name="l03255"></a>03255             sHeight += <a class="code" href="Font_8cpp.html#35cddf34696d33489efb820caf968907">GetFontHeight</a>( SMALLFONT1 ) - 2;
<a name="l03256"></a>03256 
<a name="l03257"></a>03257             pTempItemPool = pTempItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;           
<a name="l03258"></a>03258       }
<a name="l03259"></a>03259 
<a name="l03260"></a>03260 
<a name="l03261"></a>03261       pTempItemPool = pItemPool;
<a name="l03262"></a>03262       <span class="keywordflow">while</span>( pTempItemPool != NULL )
<a name="l03263"></a>03263       {
<a name="l03264"></a>03264             <span class="comment">// ATE: Put some conditions on this....</span>
<a name="l03265"></a>03265             <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#ec958a67be0ebc67209a65183705ed24">ItemPoolOKForDisplay</a>( pTempItemPool, bZLevel ) )
<a name="l03266"></a>03266             {
<a name="l03267"></a>03267                   <a class="code" href="Handle_01Items_8cpp.html#a2ffed608487a515c7e7ebf5fcfb364f">HandleAnyMercInSquadHasCompatibleStuff</a>( (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>)<a class="code" href="Squads_8cpp.html#7b191255333292b85d3e366c8def7a21">CurrentSquad</a>( ), &amp;(<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pTempItemPool-&gt;iItemIndex ].<a class="code" href="structWORLDITEM.html#0f219e2d7aafd3aeca85991add1ef5f8">o</a> ), FALSE );
<a name="l03268"></a>03268             }
<a name="l03269"></a>03269 
<a name="l03270"></a>03270             pTempItemPool = pTempItemPool-&gt;pNext;
<a name="l03271"></a>03271       }
<a name="l03272"></a>03272 
<a name="l03273"></a>03273       <span class="comment">// IF COUNT IS ALREADY &gt; MAX, ADD A PREV...</span>
<a name="l03274"></a>03274       <span class="keywordflow">if</span> ( bCurStart &gt;= NUM_ITEMS_LISTED )
<a name="l03275"></a>03275       {
<a name="l03276"></a>03276             cnt++;
<a name="l03277"></a>03277       }
<a name="l03278"></a>03278       
<a name="l03279"></a>03279       bNumItemsListed = (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>)cnt;
<a name="l03280"></a>03280 
<a name="l03281"></a>03281       
<a name="l03282"></a>03282       <span class="comment">//RENDER LIST!</span>
<a name="l03283"></a>03283       <span class="comment">// Determine max length</span>
<a name="l03284"></a>03284       pTempItemPool = pItemPool;
<a name="l03285"></a>03285       <span class="keywordflow">while</span>( pTempItemPool != NULL )
<a name="l03286"></a>03286       {
<a name="l03287"></a>03287             <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#ec958a67be0ebc67209a65183705ed24">ItemPoolOKForDisplay</a>( pTempItemPool, bZLevel ) )
<a name="l03288"></a>03288             {                 
<a name="l03289"></a>03289                   <span class="comment">// GET ITEM</span>
<a name="l03290"></a>03290                   pItem = &amp;<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pTempItemPool-&gt;iItemIndex ].<a class="code" href="structWORLDITEM.html#0f219e2d7aafd3aeca85991add1ef5f8">o</a>.<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> ];
<a name="l03291"></a>03291                   <span class="comment">// Set string</span>
<a name="l03292"></a>03292                   <span class="keywordflow">if</span> ( gWorldItems[ pTempItemPool-&gt;iItemIndex ].o.ubNumberOfObjects &gt; 1 )
<a name="l03293"></a>03293                   {
<a name="l03294"></a>03294                         swprintf( (<span class="keywordtype">wchar_t</span> *)pStr, (<span class="keywordtype">wchar_t</span> *)L<span class="stringliteral">"%s (%d)"</span>, <a class="code" href="__DutchText_8cpp.html#1a6754089e322c2627f2dae5ac92f044">ShortItemNames</a>[ gWorldItems[ pTempItemPool-&gt;iItemIndex ].o.usItem ], gWorldItems[ pTempItemPool-&gt;iItemIndex ].o.ubNumberOfObjects );
<a name="l03295"></a>03295                   }
<a name="l03296"></a>03296                   <span class="keywordflow">else</span>
<a name="l03297"></a>03297                   {
<a name="l03298"></a>03298                         swprintf( (<span class="keywordtype">wchar_t</span> *)pStr, (<span class="keywordtype">wchar_t</span> *)L<span class="stringliteral">"%s"</span>, <a class="code" href="__DutchText_8cpp.html#1a6754089e322c2627f2dae5ac92f044">ShortItemNames</a>[ gWorldItems[ pTempItemPool-&gt;iItemIndex ].o.usItem ] );
<a name="l03299"></a>03299                   }
<a name="l03300"></a>03300 
<a name="l03301"></a>03301                   <span class="comment">// Get Width</span>
<a name="l03302"></a>03302                   sLineWidth = <a class="code" href="Font_8cpp.html#3bbbfeabebae07a03f719f35607c6e4f">StringPixLength</a>( pStr,SMALLFONT1 );
<a name="l03303"></a>03303 
<a name="l03304"></a>03304                   <span class="keywordflow">if</span> ( sLineWidth &gt; sLargeLineWidth )
<a name="l03305"></a>03305                   {
<a name="l03306"></a>03306                         sLargeLineWidth = sLineWidth;
<a name="l03307"></a>03307                   }
<a name="l03308"></a>03308                   sLargestLineWidth = sLargeLineWidth;
<a name="l03309"></a>03309             }
<a name="l03310"></a>03310             pTempItemPool = pTempItemPool-&gt;pNext;
<a name="l03311"></a>03311       }
<a name="l03312"></a>03312 
<a name="l03313"></a>03313       <span class="comment">// Determine where our mouse is!</span>
<a name="l03314"></a>03314       <span class="keywordflow">if</span> ( sXPos &gt; ( <a class="code" href="local_8h.html#599adbe412c60e0cc5abb86be7ee4507">SCREEN_WIDTH</a> - sLargestLineWidth ) )
<a name="l03315"></a>03315       {
<a name="l03316"></a>03316             sFontX = sXPos - sLargestLineWidth;
<a name="l03317"></a>03317       }
<a name="l03318"></a>03318       <span class="keywordflow">else</span>
<a name="l03319"></a>03319       {
<a name="l03320"></a>03320             sFontX = sXPos + 15;
<a name="l03321"></a>03321       }
<a name="l03322"></a>03322       sFontY = sYPos;
<a name="l03323"></a>03323 
<a name="l03324"></a>03324       <span class="comment">// Move up if over interface....</span>
<a name="l03325"></a>03325       <span class="keywordflow">if</span> ( ( sFontY + sHeight ) &gt; ( <a class="code" href="Interface_8cpp.html#37871c8e1ece32a7d52bbad885f14d32">INV_INTERFACE_START_Y</a> ) )
<a name="l03326"></a>03326       {
<a name="l03327"></a>03327             sFontY = ( <a class="code" href="Interface_8cpp.html#37871c8e1ece32a7d52bbad885f14d32">INV_INTERFACE_START_Y</a> ) - sHeight;
<a name="l03328"></a>03328       }
<a name="l03329"></a>03329 
<a name="l03330"></a>03330       <span class="comment">// Detertime vertiacal center</span>
<a name="l03331"></a>03331       sFontY -= ( sHeight / 2 );
<a name="l03332"></a>03332 
<a name="l03333"></a>03333 
<a name="l03334"></a>03334       <a class="code" href="Font_8cpp.html#fa4871009f0473cca0380217753947dc">SetFont</a>( SMALLFONT1 );
<a name="l03335"></a>03335       <a class="code" href="Font_8cpp.html#a1fe8cc526be9e2c96b5dd66e348506f">SetFontBackground</a>( FONT_MCOLOR_BLACK );
<a name="l03336"></a>03336       <a class="code" href="Font_8cpp.html#388be5810478c3f3bdb861f144085d70">SetFontForeground</a>( FONT_MCOLOR_DKGRAY );
<a name="l03337"></a>03337 
<a name="l03338"></a>03338       <span class="comment">// MOVE HEAD TO CURRENT START</span>
<a name="l03339"></a>03339       cnt = 0;
<a name="l03340"></a>03340       <span class="keywordflow">while</span>( pItemPool != NULL )
<a name="l03341"></a>03341       {
<a name="l03342"></a>03342             <span class="keywordflow">if</span> ( cnt == bCurStart )
<a name="l03343"></a>03343             {
<a name="l03344"></a>03344                   <span class="keywordflow">break</span>;
<a name="l03345"></a>03345             }
<a name="l03346"></a>03346 
<a name="l03347"></a>03347             <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#ec958a67be0ebc67209a65183705ed24">ItemPoolOKForDisplay</a>( pItemPool, bZLevel ) )
<a name="l03348"></a>03348             {
<a name="l03349"></a>03349                   cnt++;
<a name="l03350"></a>03350             }
<a name="l03351"></a>03351 
<a name="l03352"></a>03352             pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l03353"></a>03353       }
<a name="l03354"></a>03354 
<a name="l03355"></a>03355       <span class="comment">// START DISPLAY LOOP</span>
<a name="l03356"></a>03356       cnt = bCurStart;
<a name="l03357"></a>03357       sY    = sFontY;         
<a name="l03358"></a>03358 
<a name="l03359"></a>03359       <span class="comment">// ADD PREV TO THIS LIST!</span>
<a name="l03360"></a>03360       <span class="keywordflow">if</span> ( bCurStart &gt;= NUM_ITEMS_LISTED )
<a name="l03361"></a>03361       {
<a name="l03362"></a>03362             <span class="comment">// Set string</span>
<a name="l03363"></a>03363             <span class="keywordflow">if</span> ( cnt == gbCurrentItemSel )
<a name="l03364"></a>03364             {
<a name="l03365"></a>03365                   <a class="code" href="Font_8cpp.html#388be5810478c3f3bdb861f144085d70">SetFontForeground</a>( FONT_MCOLOR_LTGRAY );
<a name="l03366"></a>03366             }
<a name="l03367"></a>03367             <span class="keywordflow">else</span>
<a name="l03368"></a>03368             {
<a name="l03369"></a>03369                   <a class="code" href="Font_8cpp.html#388be5810478c3f3bdb861f144085d70">SetFontForeground</a>( FONT_MCOLOR_DKGRAY );
<a name="l03370"></a>03370             }
<a name="l03371"></a>03371             swprintf( (<span class="keywordtype">wchar_t</span> *)pStr, (<span class="keywordtype">wchar_t</span> *)<a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe7d386c974df083ebd1a4cb18b4ecbdbe4">ITEMPOOL_POPUP_PREV_STR</a> ] );
<a name="l03372"></a>03372             <a class="code" href="Render_01Dirty_8cpp.html#ae5c011dc4af8d9a67af870a92f56e1f">gprintfdirty</a>( sFontX, sY, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> *)pStr );
<a name="l03373"></a>03373             <a class="code" href="Font_8cpp.html#b3e12cf19a0ca58abf6689cc8eca3ead">mprintf</a>( sFontX, sY, pStr );
<a name="l03374"></a>03374             sY += <a class="code" href="Font_8cpp.html#35cddf34696d33489efb820caf968907">GetFontHeight</a>( SMALLFONT1 ) - 2;
<a name="l03375"></a>03375             cnt++;
<a name="l03376"></a>03376       }
<a name="l03377"></a>03377 
<a name="l03378"></a>03378       <span class="keywordflow">while</span>( pItemPool != NULL )
<a name="l03379"></a>03379       {
<a name="l03380"></a>03380             <span class="keywordflow">if</span> ( bCommand == ITEMLIST_HANDLE )
<a name="l03381"></a>03381             {
<a name="l03382"></a>03382                   <span class="keywordflow">if</span> ( cnt == gbCurrentItemSel )
<a name="l03383"></a>03383                   {
<a name="l03384"></a>03384                         <a class="code" href="Font_8cpp.html#388be5810478c3f3bdb861f144085d70">SetFontForeground</a>( FONT_MCOLOR_LTGRAY );
<a name="l03385"></a>03385                   }
<a name="l03386"></a>03386                   <span class="keywordflow">else</span>
<a name="l03387"></a>03387                   {
<a name="l03388"></a>03388                         <a class="code" href="Font_8cpp.html#388be5810478c3f3bdb861f144085d70">SetFontForeground</a>( FONT_MCOLOR_DKGRAY );
<a name="l03389"></a>03389                   }
<a name="l03390"></a>03390             }
<a name="l03391"></a>03391 
<a name="l03392"></a>03392 
<a name="l03393"></a>03393             <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#ec958a67be0ebc67209a65183705ed24">ItemPoolOKForDisplay</a>( pItemPool, bZLevel ) )
<a name="l03394"></a>03394             {
<a name="l03395"></a>03395                   <span class="comment">// GET ITEM</span>
<a name="l03396"></a>03396                   pItem = &amp;<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].<a class="code" href="structWORLDITEM.html#0f219e2d7aafd3aeca85991add1ef5f8">o</a>.<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> ];
<a name="l03397"></a>03397                   <span class="comment">// Set string</span>
<a name="l03398"></a>03398 
<a name="l03399"></a>03399                   <span class="keywordflow">if</span> ( gWorldItems[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.ubNumberOfObjects &gt; 1 )
<a name="l03400"></a>03400                   {
<a name="l03401"></a>03401                         swprintf( (<span class="keywordtype">wchar_t</span> *)pStr, (<span class="keywordtype">wchar_t</span> *)L<span class="stringliteral">"%s (%d)"</span>, <a class="code" href="__DutchText_8cpp.html#1a6754089e322c2627f2dae5ac92f044">ShortItemNames</a>[ gWorldItems[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.usItem ], gWorldItems[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.ubNumberOfObjects );
<a name="l03402"></a>03402                   }
<a name="l03403"></a>03403                   <span class="keywordflow">else</span>
<a name="l03404"></a>03404                   {
<a name="l03405"></a>03405                         swprintf( (<span class="keywordtype">wchar_t</span> *)pStr, (<span class="keywordtype">wchar_t</span> *)L<span class="stringliteral">"%s"</span>, <a class="code" href="__DutchText_8cpp.html#1a6754089e322c2627f2dae5ac92f044">ShortItemNames</a>[ gWorldItems[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.usItem ] );
<a name="l03406"></a>03406                   }
<a name="l03407"></a>03407 
<a name="l03408"></a>03408                   <a class="code" href="Render_01Dirty_8cpp.html#ae5c011dc4af8d9a67af870a92f56e1f">gprintfdirty</a>( sFontX, sY, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> *)pStr );
<a name="l03409"></a>03409                   <a class="code" href="Font_8cpp.html#b3e12cf19a0ca58abf6689cc8eca3ead">mprintf</a>( sFontX, sY, pStr );
<a name="l03410"></a>03410 
<a name="l03411"></a>03411                   sY += <a class="code" href="Font_8cpp.html#35cddf34696d33489efb820caf968907">GetFontHeight</a>( SMALLFONT1 ) - 2;
<a name="l03412"></a>03412                   cnt++;
<a name="l03413"></a>03413             }
<a name="l03414"></a>03414             pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l03415"></a>03415 
<a name="l03416"></a>03416 
<a name="l03417"></a>03417             <span class="keywordflow">if</span> ( fDoBack )
<a name="l03418"></a>03418             {
<a name="l03419"></a>03419                   <span class="keywordflow">if</span> ( cnt == ( bNumItemsListed - 1) )
<a name="l03420"></a>03420                   {
<a name="l03421"></a>03421                         <span class="keywordflow">break</span>;
<a name="l03422"></a>03422                   }
<a name="l03423"></a>03423             }
<a name="l03424"></a>03424 
<a name="l03425"></a>03425       }
<a name="l03426"></a>03426       <span class="keywordflow">if</span> ( fDoBack )
<a name="l03427"></a>03427       {
<a name="l03428"></a>03428                   <span class="keywordflow">if</span> ( cnt == ( bNumItemsListed - 1) )
<a name="l03429"></a>03429                   {
<a name="l03430"></a>03430                         <span class="comment">// Set string</span>
<a name="l03431"></a>03431                         <span class="keywordflow">if</span> ( cnt == gbCurrentItemSel )
<a name="l03432"></a>03432                         {
<a name="l03433"></a>03433                               <a class="code" href="Font_8cpp.html#388be5810478c3f3bdb861f144085d70">SetFontForeground</a>( FONT_MCOLOR_LTGRAY );
<a name="l03434"></a>03434                         }
<a name="l03435"></a>03435                         <span class="keywordflow">else</span>
<a name="l03436"></a>03436                         {
<a name="l03437"></a>03437                               <a class="code" href="Font_8cpp.html#388be5810478c3f3bdb861f144085d70">SetFontForeground</a>( FONT_MCOLOR_DKGRAY );
<a name="l03438"></a>03438                         }
<a name="l03439"></a>03439                         swprintf( (<span class="keywordtype">wchar_t</span> *)pStr, (<span class="keywordtype">wchar_t</span> *)<a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe726da977f1fabc0b98d2750eecb310b2c">ITEMPOOL_POPUP_MORE_STR</a> ] );
<a name="l03440"></a>03440                         <a class="code" href="Render_01Dirty_8cpp.html#ae5c011dc4af8d9a67af870a92f56e1f">gprintfdirty</a>( sFontX, sY, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> *)pStr );
<a name="l03441"></a>03441                         <a class="code" href="Font_8cpp.html#b3e12cf19a0ca58abf6689cc8eca3ead">mprintf</a>( sFontX, sY, pStr );
<a name="l03442"></a>03442                   }
<a name="l03443"></a>03443       }
<a name="l03444"></a>03444 
<a name="l03445"></a>03445       <span class="keywordflow">return</span>( fSelectionDone );
<a name="l03446"></a>03446 
<a name="l03447"></a>03447 }
<a name="l03448"></a>03448 
<a name="l03449"></a>03449 
<a name="l03450"></a><a class="code" href="Handle_01Items_8cpp.html#04e9ed094169e82cf0be4c7592bf5ebb">03450</a> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="Handle_01Items_8cpp.html#04e9ed094169e82cf0be4c7592bf5ebb">GetListMouseHotSpot</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sLargestLineWidth, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bNumItemsListed, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sFontX, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sFontY, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bCurStart )
<a name="l03451"></a>03451 {
<a name="l03452"></a>03452       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>  cnt = 0;
<a name="l03453"></a>03453       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>  sTestX1, sTestX2, sTestY1, sTestY2;
<a name="l03454"></a>03454       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>  sLineHeight;
<a name="l03455"></a>03455       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>   gbCurrentItemSel = -1;
<a name="l03456"></a>03456       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>   bListedItems;
<a name="l03457"></a>03457 
<a name="l03458"></a>03458       sLineHeight = <a class="code" href="Font_8cpp.html#35cddf34696d33489efb820caf968907">GetFontHeight</a>( SMALLFONT1 ) - 2;
<a name="l03459"></a>03459 
<a name="l03460"></a>03460       sTestX1 = sFontX;
<a name="l03461"></a>03461       sTestX2 = sFontX + sLargestLineWidth;
<a name="l03462"></a>03462 
<a name="l03463"></a>03463 
<a name="l03464"></a>03464       bListedItems = ( bNumItemsListed - bCurStart );
<a name="l03465"></a>03465 
<a name="l03466"></a>03466 
<a name="l03467"></a>03467       <span class="keywordflow">if</span> ( gusMouseXPos &lt; sTestX1 || gusMouseXPos &gt; sTestX2 )
<a name="l03468"></a>03468       {
<a name="l03469"></a>03469             gbCurrentItemSel = -1;
<a name="l03470"></a>03470       }
<a name="l03471"></a>03471       <span class="keywordflow">else</span>
<a name="l03472"></a>03472       {
<a name="l03473"></a>03473             <span class="comment">// Determine where mouse is!</span>
<a name="l03474"></a>03474             <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; bListedItems; cnt++ )
<a name="l03475"></a>03475             {
<a name="l03476"></a>03476                   sTestY1 = sFontY + ( sLineHeight * cnt );
<a name="l03477"></a>03477                   sTestY2 = sFontY + ( sLineHeight * ( cnt + 1 ) );
<a name="l03478"></a>03478 
<a name="l03479"></a>03479                   <span class="keywordflow">if</span> ( <a class="code" href="input_8cpp.html#cb09b6d6d53490d8a11992dd51f582f3">gusMouseYPos</a> &gt; sTestY1 &amp;&amp; <a class="code" href="input_8cpp.html#cb09b6d6d53490d8a11992dd51f582f3">gusMouseYPos</a> &lt; sTestY2 )
<a name="l03480"></a>03480                   {
<a name="l03481"></a>03481                         gbCurrentItemSel = (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>)cnt;
<a name="l03482"></a>03482                         <span class="keywordflow">break</span>;
<a name="l03483"></a>03483                   }
<a name="l03484"></a>03484             }
<a name="l03485"></a>03485       }
<a name="l03486"></a>03486 
<a name="l03487"></a>03487       <span class="comment">// OFFSET START</span>
<a name="l03488"></a>03488       gbCurrentItemSel += bCurStart;
<a name="l03489"></a>03489       
<a name="l03490"></a>03490       <span class="keywordflow">return</span>( gbCurrentItemSel );
<a name="l03491"></a>03491 }
<a name="l03492"></a>03492 
<a name="l03493"></a>03493 
<a name="l03494"></a><a class="code" href="Handle_01Items_8h.html#79961f4def8b8b7faaea39edc3f0e728">03494</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#79961f4def8b8b7faaea39edc3f0e728">SetItemPoolLocator</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool )
<a name="l03495"></a>03495 {
<a name="l03496"></a>03496       pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#73d13babb7b64e62eb568cb3d1b73c03">bFlashColor</a> = 59;
<a name="l03497"></a>03497 
<a name="l03498"></a>03498       pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#2952e2986c81343aa4af1566e922b9a6">uiTimerID</a>          = <a class="code" href="Handle_01Items_8cpp.html#2ff04917cd79809a4622bd6747d1b10c">AddFlashItemSlot</a>( pItemPool, NULL, 0 );
<a name="l03499"></a>03499 
<a name="l03500"></a>03500 }
<a name="l03501"></a>03501 
<a name="l03502"></a><a class="code" href="Handle_01Items_8h.html#8bb946e2b636fd21276251138b685e22">03502</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#8bb946e2b636fd21276251138b685e22">SetItemPoolLocatorWithCallback</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool, <a class="code" href="Handle_01Items_8h.html#617cdd488b649139d4f59da69c7a4581">ITEM_POOL_LOCATOR_HOOK</a> Callback )
<a name="l03503"></a>03503 {
<a name="l03504"></a>03504       pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#73d13babb7b64e62eb568cb3d1b73c03">bFlashColor</a> = 59;
<a name="l03505"></a>03505 
<a name="l03506"></a>03506       pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#2952e2986c81343aa4af1566e922b9a6">uiTimerID</a>          = <a class="code" href="Handle_01Items_8cpp.html#2ff04917cd79809a4622bd6747d1b10c">AddFlashItemSlot</a>( pItemPool, Callback, 0 );
<a name="l03507"></a>03507 
<a name="l03508"></a>03508 }
<a name="l03509"></a>03509 
<a name="l03510"></a>03510 
<a name="l03511"></a>03511 
<a name="l03512"></a>03512 
<a name="l03513"></a>03513 
<a name="l03514"></a>03514 
<a name="l03515"></a>03515 
<a name="l03516"></a>03516 
<a name="l03517"></a>03517 
<a name="l03518"></a>03518 
<a name="l03519"></a>03519 
<a name="l03520"></a>03520 
<a name="l03521"></a>03521 
<a name="l03522"></a>03522 
<a name="l03523"></a>03523 
<a name="l03524"></a>03524 <span class="comment"></span>
<a name="l03525"></a>03525 <span class="comment">/// ITEM POOL INDICATOR FUNCTIONS</span>
<a name="l03526"></a>03526 <span class="comment"></span>
<a name="l03527"></a>03527 
<a name="l03528"></a>03528 
<a name="l03529"></a><a class="code" href="Handle_01Items_8cpp.html#8bcee147a07978cc32b44e1a474c515c">03529</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Handle_01Items_8cpp.html#8bcee147a07978cc32b44e1a474c515c">GetFreeFlashItemSlot</a>(<span class="keywordtype">void</span>)
<a name="l03530"></a>03530 {
<a name="l03531"></a>03531       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiCount;
<a name="l03532"></a>03532 
<a name="l03533"></a>03533       <span class="keywordflow">for</span>(uiCount=0; uiCount &lt; <a class="code" href="Handle_01Items_8cpp.html#c473fcc349af3b6e5e7f30711c1f9429">guiNumFlashItemSlots</a>; uiCount++)
<a name="l03534"></a>03534       {
<a name="l03535"></a>03535             <span class="keywordflow">if</span>(( <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[uiCount].fAllocated == FALSE ) )
<a name="l03536"></a>03536                   <span class="keywordflow">return</span>((<a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>)uiCount);
<a name="l03537"></a>03537       }
<a name="l03538"></a>03538 
<a name="l03539"></a>03539       <span class="keywordflow">if</span>(guiNumFlashItemSlots &lt; NUM_ITEM_FLASH_SLOTS )
<a name="l03540"></a>03540             <span class="keywordflow">return</span>((<a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>)guiNumFlashItemSlots++);
<a name="l03541"></a>03541 
<a name="l03542"></a>03542       <span class="keywordflow">return</span>(-1);
<a name="l03543"></a>03543 }
<a name="l03544"></a>03544 
<a name="l03545"></a>03545 
<a name="l03546"></a><a class="code" href="Handle_01Items_8cpp.html#256ce32be2bef0e7404222513fa16d3d">03546</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#256ce32be2bef0e7404222513fa16d3d">RecountFlashItemSlots</a>(<span class="keywordtype">void</span>)
<a name="l03547"></a>03547 {
<a name="l03548"></a>03548 <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> uiCount;
<a name="l03549"></a>03549 
<a name="l03550"></a>03550       <span class="keywordflow">for</span>(uiCount=<a class="code" href="Handle_01Items_8cpp.html#c473fcc349af3b6e5e7f30711c1f9429">guiNumFlashItemSlots</a>-1; (uiCount &gt;=0) ; uiCount--)
<a name="l03551"></a>03551       {
<a name="l03552"></a>03552             <span class="keywordflow">if</span>( ( <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[uiCount].fAllocated ) )
<a name="l03553"></a>03553             {
<a name="l03554"></a>03554                   <a class="code" href="Handle_01Items_8cpp.html#c473fcc349af3b6e5e7f30711c1f9429">guiNumFlashItemSlots</a>=(<a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)(uiCount+1);
<a name="l03555"></a>03555                   <span class="keywordflow">break</span>;
<a name="l03556"></a>03556             }
<a name="l03557"></a>03557       }
<a name="l03558"></a>03558 }
<a name="l03559"></a>03559 
<a name="l03560"></a>03560 
<a name="l03561"></a><a class="code" href="Handle_01Items_8cpp.html#2ff04917cd79809a4622bd6747d1b10c">03561</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Handle_01Items_8cpp.html#2ff04917cd79809a4622bd6747d1b10c">AddFlashItemSlot</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool, <a class="code" href="Handle_01Items_8h.html#617cdd488b649139d4f59da69c7a4581">ITEM_POOL_LOCATOR_HOOK</a> Callback, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubFlags )
<a name="l03562"></a>03562 {
<a name="l03563"></a>03563       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>             iFlashItemIndex;
<a name="l03564"></a>03564 
<a name="l03565"></a>03565       <span class="keywordflow">if</span>( ( iFlashItemIndex = <a class="code" href="Handle_01Items_8cpp.html#8bcee147a07978cc32b44e1a474c515c">GetFreeFlashItemSlot</a>() )==(-1) )
<a name="l03566"></a>03566             <span class="keywordflow">return</span>(-1);
<a name="l03567"></a>03567 
<a name="l03568"></a>03568       ubFlags |= ITEM_LOCATOR_LOCKED;
<a name="l03569"></a>03569 
<a name="l03570"></a>03570 
<a name="l03571"></a>03571       <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ iFlashItemIndex ].<a class="code" href="structITEM__POOL__LOCATOR.html#cda742684df26a00403190e30aad1deb">pItemPool</a>       = pItemPool;
<a name="l03572"></a>03572 
<a name="l03573"></a>03573       <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ iFlashItemIndex ].<a class="code" href="structITEM__POOL__LOCATOR.html#f9a12f0615a9fc41c0cd699b922b6380">bRadioFrame</a>                     = 0;
<a name="l03574"></a>03574       <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ iFlashItemIndex ].<a class="code" href="structITEM__POOL__LOCATOR.html#543ab234c596462e7224588dfaa01d32">uiLastFrameUpdate</a> = GetJA2Clock( );
<a name="l03575"></a>03575       <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ iFlashItemIndex ].<a class="code" href="structITEM__POOL__LOCATOR.html#62b36b6d0a46142a790e221bbac84d48">Callback</a>                          = Callback;
<a name="l03576"></a>03576       <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ iFlashItemIndex ].<a class="code" href="structITEM__POOL__LOCATOR.html#a41eae6e9edfa76b78cf962665f40c44">fAllocated</a>                      = TRUE;
<a name="l03577"></a>03577       <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ iFlashItemIndex ].<a class="code" href="structITEM__POOL__LOCATOR.html#37a170ff7446d8f457c3f43d92fb81b8">ubFlags</a>                               = ubFlags;
<a name="l03578"></a>03578 
<a name="l03579"></a>03579 
<a name="l03580"></a>03580       <span class="keywordflow">return</span>( iFlashItemIndex );
<a name="l03581"></a>03581 }
<a name="l03582"></a>03582 
<a name="l03583"></a>03583 
<a name="l03584"></a><a class="code" href="Handle_01Items_8cpp.html#5d83ffed8d6e4efd1820b490234df23d">03584</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#5d83ffed8d6e4efd1820b490234df23d">RemoveFlashItemSlot</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool )
<a name="l03585"></a>03585 {
<a name="l03586"></a>03586       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiCount;
<a name="l03587"></a>03587 
<a name="l03588"></a>03588       CHECKF( pItemPool != NULL );
<a name="l03589"></a>03589 
<a name="l03590"></a>03590       <span class="keywordflow">for</span>( uiCount=0; uiCount &lt; <a class="code" href="Handle_01Items_8cpp.html#c473fcc349af3b6e5e7f30711c1f9429">guiNumFlashItemSlots</a>; uiCount++)
<a name="l03591"></a>03591       {
<a name="l03592"></a>03592             <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ uiCount ].fAllocated )
<a name="l03593"></a>03593             {
<a name="l03594"></a>03594                   <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ uiCount ].pItemPool == pItemPool )
<a name="l03595"></a>03595                   {
<a name="l03596"></a>03596                         <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ uiCount ].fAllocated = FALSE;
<a name="l03597"></a>03597 
<a name="l03598"></a>03598                         <span class="comment">// Check if we have a callback and call it if so!</span>
<a name="l03599"></a>03599                         <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ uiCount ].Callback != NULL )
<a name="l03600"></a>03600                         {
<a name="l03601"></a>03601                               <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ uiCount ].Callback( );
<a name="l03602"></a>03602                         }
<a name="l03603"></a>03603 
<a name="l03604"></a>03604                         <span class="keywordflow">return</span>( TRUE );
<a name="l03605"></a>03605                   }
<a name="l03606"></a>03606             }
<a name="l03607"></a>03607       }
<a name="l03608"></a>03608 
<a name="l03609"></a>03609       <span class="keywordflow">return</span>( TRUE );
<a name="l03610"></a>03610 }
<a name="l03611"></a>03611 
<a name="l03612"></a>03612 
<a name="l03613"></a><a class="code" href="Handle_01Items_8h.html#cfb495394267633e85bd528ea0a9723c">03613</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#cfb495394267633e85bd528ea0a9723c">HandleFlashingItems</a>( )
<a name="l03614"></a>03614 {
<a name="l03615"></a>03615       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> cnt;
<a name="l03616"></a>03616       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l03617"></a>03617       <a class="code" href="structTAG__level__node.html">LEVELNODE</a>         *pObject;
<a name="l03618"></a>03618       <a class="code" href="structITEM__POOL__LOCATOR.html">ITEM_POOL_LOCATOR</a> *pLocator;
<a name="l03619"></a>03619       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fDoLocator = FALSE;
<a name="l03620"></a>03620 
<a name="l03621"></a>03621       <span class="keywordflow">if</span> ( COUNTERDONE( <a class="code" href="Timer_01Control_8h.html#9a17283e1986c46118656d6ddc9026c3604746827e5761cabebd6c73d14bf72a">CYCLERENDERITEMCOLOR</a> ) )
<a name="l03622"></a>03622       {
<a name="l03623"></a>03623                   RESETCOUNTER( <a class="code" href="Timer_01Control_8h.html#9a17283e1986c46118656d6ddc9026c3604746827e5761cabebd6c73d14bf72a">CYCLERENDERITEMCOLOR</a> );
<a name="l03624"></a>03624 
<a name="l03625"></a>03625                   <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; <a class="code" href="Handle_01Items_8cpp.html#c473fcc349af3b6e5e7f30711c1f9429">guiNumFlashItemSlots</a>; cnt++ )
<a name="l03626"></a>03626                   {
<a name="l03627"></a>03627                               pLocator  = &amp;( <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ cnt ] );
<a name="l03628"></a>03628 
<a name="l03629"></a>03629                               <span class="keywordflow">if</span> ( pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#a41eae6e9edfa76b78cf962665f40c44">fAllocated</a> )
<a name="l03630"></a>03630                               {
<a name="l03631"></a>03631                                     fDoLocator = TRUE;
<a name="l03632"></a>03632 
<a name="l03633"></a>03633                                     <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( ( pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#37a170ff7446d8f457c3f43d92fb81b8">ubFlags</a> &amp; ITEM_LOCATOR_LOCKED ) )
<a name="l03634"></a>03634                                     {
<a name="l03635"></a>03635                                           <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#d2c3549e0a512607553d150160a0709c">fLockItemLocators</a> == FALSE )
<a name="l03636"></a>03636                                           {
<a name="l03637"></a>03637                                             <span class="comment">// Turn off!</span>
<a name="l03638"></a>03638                                                 pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#37a170ff7446d8f457c3f43d92fb81b8">ubFlags</a> &amp;= (~ITEM_LOCATOR_LOCKED);
<a name="l03639"></a>03639                                           }
<a name="l03640"></a>03640                                           <span class="keywordflow">else</span>
<a name="l03641"></a>03641                                           {
<a name="l03642"></a>03642                                                 fDoLocator = FALSE;
<a name="l03643"></a>03643                                           }
<a name="l03644"></a>03644                                     }
<a name="l03645"></a>03645 
<a name="l03646"></a>03646                                     <span class="keywordflow">if</span> ( fDoLocator )
<a name="l03647"></a>03647                                     {
<a name="l03648"></a>03648                                           pItemPool = pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#cda742684df26a00403190e30aad1deb">pItemPool</a>;
<a name="l03649"></a>03649 
<a name="l03650"></a>03650                                           <span class="comment">// Update radio locator</span>
<a name="l03651"></a>03651                                           {
<a name="l03652"></a>03652                                                 <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>                  uiClock;
<a name="l03653"></a>03653 
<a name="l03654"></a>03654                                                 uiClock = GetJA2Clock( );
<a name="l03655"></a>03655                                                 
<a name="l03656"></a>03656                                                 <span class="comment">// Update frame values!</span>
<a name="l03657"></a>03657                                                 <span class="keywordflow">if</span> ( ( uiClock - pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#543ab234c596462e7224588dfaa01d32">uiLastFrameUpdate</a> ) &gt; 80 )
<a name="l03658"></a>03658                                                 {
<a name="l03659"></a>03659                                                       pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#543ab234c596462e7224588dfaa01d32">uiLastFrameUpdate</a> = uiClock;
<a name="l03660"></a>03660 
<a name="l03661"></a>03661                                                       <span class="comment">// Update frame</span>
<a name="l03662"></a>03662                                                       pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#f9a12f0615a9fc41c0cd699b922b6380">bRadioFrame</a>++;
<a name="l03663"></a>03663 
<a name="l03664"></a>03664                                                       <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#f9a12f0615a9fc41c0cd699b922b6380">bRadioFrame</a> == 5 )
<a name="l03665"></a>03665                                                       {
<a name="l03666"></a>03666                                                             pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#f9a12f0615a9fc41c0cd699b922b6380">bRadioFrame</a> = 0;
<a name="l03667"></a>03667                                                       }
<a name="l03668"></a>03668                                                 }
<a name="l03669"></a>03669                                           }
<a name="l03670"></a>03670 
<a name="l03671"></a>03671                                           <span class="comment">// UPDATE FLASH COLOR VALUE</span>
<a name="l03672"></a>03672                                           pItemPool-&gt;bFlashColor--;
<a name="l03673"></a>03673 
<a name="l03674"></a>03674                                           <span class="keywordflow">if</span> ( pItemPool-&gt;ubLevel == 0 )
<a name="l03675"></a>03675                                           {
<a name="l03676"></a>03676                                                 pObject = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ pItemPool-&gt;sGridNo ].<a class="code" href="structMAP__ELEMENT.html#0cc751d3c74e25ab6dd78d58da155f6d">pStructHead</a>;
<a name="l03677"></a>03677                                           }
<a name="l03678"></a>03678                                           <span class="keywordflow">else</span>
<a name="l03679"></a>03679                                           {
<a name="l03680"></a>03680                                                 pObject = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ pItemPool-&gt;sGridNo ].<a class="code" href="structMAP__ELEMENT.html#cc1855e037c8009f869e8d4ef8f90e6c">pOnRoofHead</a>;
<a name="l03681"></a>03681                                           }
<a name="l03682"></a>03682 
<a name="l03683"></a>03683                                           <span class="comment">// LOOP THORUGH OBJECT LAYER</span>
<a name="l03684"></a>03684                                           <span class="keywordflow">while</span>( pObject != NULL )
<a name="l03685"></a>03685                                           {
<a name="l03686"></a>03686                                                 <span class="keywordflow">if</span> ( pObject-&gt;uiFlags &amp; LEVELNODE_ITEM )
<a name="l03687"></a>03687                                                 {
<a name="l03688"></a>03688                                                       <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( pItemPool-&gt;bFlashColor == 1 )
<a name="l03689"></a>03689                                                       {
<a name="l03690"></a>03690                                                             <span class="comment">//pObject-&gt;uiFlags &amp;= (~LEVELNODE_DYNAMIC);</span>
<a name="l03691"></a>03691                                                             <span class="comment">//pObject-&gt;uiFlags |= ( LEVELNODE_LASTDYNAMIC  );</span>
<a name="l03692"></a>03692                                                       }
<a name="l03693"></a>03693                                                       <span class="keywordflow">else</span>
<a name="l03694"></a>03694                                                       {
<a name="l03695"></a>03695                                                             <span class="comment">//pObject-&gt;uiFlags |= LEVELNODE_DYNAMIC;</span>
<a name="l03696"></a>03696                                                       }
<a name="l03697"></a>03697 
<a name="l03698"></a>03698                                                 }
<a name="l03699"></a>03699 
<a name="l03700"></a>03700                                                 pObject = pObject-&gt;pNext;
<a name="l03701"></a>03701                                           }
<a name="l03702"></a>03702 
<a name="l03703"></a>03703                                           <span class="keywordflow">if</span> ( pItemPool-&gt;bFlashColor == 1 )
<a name="l03704"></a>03704                                           {
<a name="l03705"></a>03705                                                 pItemPool-&gt;bFlashColor = 0;
<a name="l03706"></a>03706 
<a name="l03707"></a>03707                                                 <span class="comment">// REMOVE TIMER!</span>
<a name="l03708"></a>03708                                                 <a class="code" href="Handle_01Items_8cpp.html#5d83ffed8d6e4efd1820b490234df23d">RemoveFlashItemSlot</a>( pItemPool );
<a name="l03709"></a>03709 
<a name="l03710"></a>03710                                                 <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>( RENDER_FLAG_FULL );
<a name="l03711"></a>03711                                           }
<a name="l03712"></a>03712                                     }
<a name="l03713"></a>03713                               }
<a name="l03714"></a>03714                   }
<a name="l03715"></a>03715 
<a name="l03716"></a>03716                   <a class="code" href="Handle_01Items_8cpp.html#256ce32be2bef0e7404222513fa16d3d">RecountFlashItemSlots</a>( );
<a name="l03717"></a>03717 
<a name="l03718"></a>03718       }
<a name="l03719"></a>03719 
<a name="l03720"></a>03720 }
<a name="l03721"></a>03721 
<a name="l03722"></a>03722 
<a name="l03723"></a><a class="code" href="Handle_01Items_8h.html#c18402c2869cf8fc89f9df07d0817896">03723</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#c18402c2869cf8fc89f9df07d0817896">RenderTopmostFlashingItems</a>( )
<a name="l03724"></a>03724 {
<a name="l03725"></a>03725       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> cnt;
<a name="l03726"></a>03726       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pItemPool;
<a name="l03727"></a>03727       <a class="code" href="structITEM__POOL__LOCATOR.html">ITEM_POOL_LOCATOR</a> *pLocator;
<a name="l03728"></a>03728 
<a name="l03729"></a>03729       <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; <a class="code" href="Handle_01Items_8cpp.html#c473fcc349af3b6e5e7f30711c1f9429">guiNumFlashItemSlots</a>; cnt++ )
<a name="l03730"></a>03730       {
<a name="l03731"></a>03731             pLocator  = &amp;( <a class="code" href="Handle_01Items_8cpp.html#df2053c815c5937d3e8b430067a39d0a">FlashItemSlots</a>[ cnt ] );
<a name="l03732"></a>03732 
<a name="l03733"></a>03733             <span class="keywordflow">if</span> ( pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#a41eae6e9edfa76b78cf962665f40c44">fAllocated</a> )
<a name="l03734"></a>03734             {
<a name="l03735"></a>03735                   <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( !( pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#37a170ff7446d8f457c3f43d92fb81b8">ubFlags</a> &amp; ( ITEM_LOCATOR_LOCKED ) ) )
<a name="l03736"></a>03736                   {
<a name="l03737"></a>03737                         pItemPool = pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#cda742684df26a00403190e30aad1deb">pItemPool</a>;
<a name="l03738"></a>03738 
<a name="l03739"></a>03739                         <span class="comment">// Update radio locator</span>
<a name="l03740"></a>03740                         {
<a name="l03741"></a>03741                               <a class="code" href="Types_8h.html#8d06b04c04132c6f7c0fcb08c6167455">FLOAT</a>                   dOffsetX, dOffsetY;
<a name="l03742"></a>03742                               <a class="code" href="Types_8h.html#8d06b04c04132c6f7c0fcb08c6167455">FLOAT</a>                   dTempX_S, dTempY_S;
<a name="l03743"></a>03743                               <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                   sX, sY, sXPos, sYPos;
<a name="l03744"></a>03744                               <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                   iBack;
<a name="l03745"></a>03745 
<a name="l03746"></a>03746                               <a class="code" href="Isometric_01Utils_8cpp.html#5919936aba0b5f157738a66b7fe682f2">ConvertGridNoToCenterCellXY</a>( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a>, &amp;sX, &amp;sY );
<a name="l03747"></a>03747 
<a name="l03748"></a>03748                               dOffsetX = (<a class="code" href="Types_8h.html#8d06b04c04132c6f7c0fcb08c6167455">FLOAT</a>)( sX - <a class="code" href="renderworld_8cpp.html#1bf795f2a13e8559ffa77bc67b81dcb7">gsRenderCenterX</a> );
<a name="l03749"></a>03749                               dOffsetY = (<a class="code" href="Types_8h.html#8d06b04c04132c6f7c0fcb08c6167455">FLOAT</a>)( sY - <a class="code" href="renderworld_8cpp.html#086faf26457fce933b3a4f2e2ef450f3">gsRenderCenterY</a> );
<a name="l03750"></a>03750 
<a name="l03751"></a>03751                               <span class="comment">// Calculate guy's position</span>
<a name="l03752"></a>03752                               <a class="code" href="Isometric_01Utils_8cpp.html#96e5e7d8f6033d488d64a1baa963e3ab">FloatFromCellToScreenCoordinates</a>( dOffsetX, dOffsetY, &amp;dTempX_S, &amp;dTempY_S );
<a name="l03753"></a>03753 
<a name="l03754"></a>03754                               sXPos = ( ( <a class="code" href="renderworld_8cpp.html#829facd7abae54fcc284037c443e54bf">gsVIEWPORT_END_X</a> - <a class="code" href="renderworld_8cpp.html#81bf7674212c692b12d2fd3c41050c9b">gsVIEWPORT_START_X</a> ) /2 ) + (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)dTempX_S;
<a name="l03755"></a>03755                               sYPos = ( ( <a class="code" href="HelpScreen_8cpp.html#268f46eb948cd6eb0f3406b688e4ccaa">gsVIEWPORT_END_Y</a> - <a class="code" href="renderworld_8cpp.html#71c227d79f4390bf0c95bfe1050ce147">gsVIEWPORT_START_Y</a> ) /2 ) + (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)dTempY_S - <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a> ].sHeight;
<a name="l03756"></a>03756 
<a name="l03757"></a>03757                               <span class="comment">// Adjust for offset position on screen</span>
<a name="l03758"></a>03758                               sXPos -= <a class="code" href="renderworld_8cpp.html#14a29b29b3237d31eacf3f1c42e1a2cf">gsRenderWorldOffsetX</a>;
<a name="l03759"></a>03759                               sYPos -= <a class="code" href="renderworld_8cpp.html#0685e1bf7b5f2885e942ae0a7330b3cc">gsRenderWorldOffsetY</a>;
<a name="l03760"></a>03760                               sYPos -= pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a>;
<a name="l03761"></a>03761 
<a name="l03762"></a>03762                               <span class="comment">// Adjust for render height</span>
<a name="l03763"></a>03763                               sYPos += <a class="code" href="renderworld_8cpp.html#566b47ab5060367cf4d02cf071f0b624">gsRenderHeight</a>;
<a name="l03764"></a>03764 
<a name="l03765"></a>03765                               <span class="comment">// Adjust for level height</span>
<a name="l03766"></a>03766                               <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#d001579cc68909cba0f885510f2d242a">ubLevel</a> )
<a name="l03767"></a>03767                               {
<a name="l03768"></a>03768                                     sYPos -= ROOF_LEVEL_HEIGHT;
<a name="l03769"></a>03769                               }
<a name="l03770"></a>03770 
<a name="l03771"></a>03771                               <span class="comment">// Center circle!</span>
<a name="l03772"></a>03772                               sXPos -= 20;
<a name="l03773"></a>03773                               sYPos -= 20;
<a name="l03774"></a>03774 
<a name="l03775"></a>03775                               iBack = <a class="code" href="Render_01Dirty_8cpp.html#df4bbccca1d6db8b39e7144b0641e213">RegisterBackgroundRect</a>( BGND_FLAG_SINGLE, NULL, sXPos, sYPos, (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)(sXPos +40 ), (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)(sYPos + 40 ) ); 
<a name="l03776"></a>03776                               <span class="keywordflow">if</span> ( iBack != -1 )
<a name="l03777"></a>03777                               {
<a name="l03778"></a>03778                                     <a class="code" href="Render_01Dirty_8cpp.html#d745efb9a07f15227175d98859466219">SetBackgroundRectFilled</a>( iBack );
<a name="l03779"></a>03779                               }
<a name="l03780"></a>03780 
<a name="l03781"></a>03781                               <a class="code" href="vobject_8cpp.html#8599b65a72008f87d4f9083c8c280d3a">BltVideoObjectFromIndex</a>(  FRAME_BUFFER, <a class="code" href="Interface_8cpp.html#bb6f62c7cad4be1695b01c56ab64df25">guiRADIO</a>, pLocator-&gt;<a class="code" href="structITEM__POOL__LOCATOR.html#f9a12f0615a9fc41c0cd699b922b6380">bRadioFrame</a>, sXPos, sYPos, VO_BLT_SRCTRANSPARENCY, NULL );
<a name="l03782"></a>03782 
<a name="l03783"></a>03783                               <a class="code" href="Handle_01Items_8cpp.html#19a0bde34991ee9039fe3f2c61230ef2">DrawItemPoolList</a>( pItemPool, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a> , ITEMLIST_DISPLAY, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a>, sXPos, sYPos );
<a name="l03784"></a>03784 
<a name="l03785"></a>03785                         }
<a name="l03786"></a>03786                   }
<a name="l03787"></a>03787             }
<a name="l03788"></a>03788       }
<a name="l03789"></a>03789 
<a name="l03790"></a>03790 }
<a name="l03791"></a>03791 
<a name="l03792"></a>03792 
<a name="l03793"></a>03793 
<a name="l03794"></a>03794 
<a name="l03795"></a><a class="code" href="Handle_01Items_8h.html#347c3e9ff8ebab005920916fa11f7045">03795</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#347c3e9ff8ebab005920916fa11f7045">VerifyGiveItem</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> **ppTargetSoldier )
<a name="l03796"></a>03796 {
<a name="l03797"></a>03797       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pTSoldier;
<a name="l03798"></a>03798       <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> usSoldierIndex;
<a name="l03799"></a>03799       <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a>  *pObject;
<a name="l03800"></a>03800 
<a name="l03801"></a>03801       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                   sGridNo;
<a name="l03802"></a>03802       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                   ubDirection;
<a name="l03803"></a>03803       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                   ubTargetMercID;
<a name="l03804"></a>03804 
<a name="l03805"></a>03805       <span class="comment">// DO SOME CHECKS IF WE CAN DO ANIMATION.....</span>
<a name="l03806"></a>03806 
<a name="l03807"></a>03807       <span class="comment">// Get items from pending data</span>
<a name="l03808"></a>03808       pObject = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a>;
<a name="l03809"></a>03809 
<a name="l03810"></a>03810       sGridNo           = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>;
<a name="l03811"></a>03811       ubDirection = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>;
<a name="l03812"></a>03812       ubTargetMercID = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#304094e7d2a05131c34f41c46dfb6fad">uiPendingActionData4</a>;
<a name="l03813"></a>03813 
<a name="l03814"></a>03814       usSoldierIndex = <a class="code" href="worldman_8cpp.html#87338f0c77765726813428fd184bfcd8">WhoIsThere2</a>( sGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l03815"></a>03815 
<a name="l03816"></a>03816       <span class="comment">// See if our target is still available</span>
<a name="l03817"></a>03817       <span class="keywordflow">if</span> ( usSoldierIndex != NOBODY )
<a name="l03818"></a>03818       {     
<a name="l03819"></a>03819             <span class="comment">// Check if it's the same merc!</span>
<a name="l03820"></a>03820             <span class="keywordflow">if</span> ( usSoldierIndex != ubTargetMercID )
<a name="l03821"></a>03821             {
<a name="l03822"></a>03822                   <span class="keywordflow">return</span>( FALSE );
<a name="l03823"></a>03823             }
<a name="l03824"></a>03824 
<a name="l03825"></a>03825             <span class="comment">// Get soldier</span>
<a name="l03826"></a>03826             <a class="code" href="Overhead_8cpp.html#f0ada03378d5018e6f225bf25ab20b24">GetSoldier</a>( &amp;pTSoldier, usSoldierIndex );
<a name="l03827"></a>03827 
<a name="l03828"></a>03828             <span class="comment">// Look for item in hand....  </span>
<a name="l03829"></a>03829 
<a name="l03830"></a>03830             (*ppTargetSoldier) = pTSoldier;
<a name="l03831"></a>03831 
<a name="l03832"></a>03832             <span class="keywordflow">return</span>( TRUE );
<a name="l03833"></a>03833       }
<a name="l03834"></a>03834       <span class="keywordflow">else</span>
<a name="l03835"></a>03835       {
<a name="l03836"></a>03836             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> != NULL )
<a name="l03837"></a>03837             {
<a name="l03838"></a>03838                   <a class="code" href="Handle_01Items_8cpp.html#ca7f6f6da97e9a4c2b737296485f5c84">AddItemToPool</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a>, 1, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, 0 , -1 );
<a name="l03839"></a>03839 
<a name="l03840"></a>03840                   <span class="comment">// Place it on the ground!</span>
<a name="l03841"></a>03841                   <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe7960cb252cbf4d4727eb6251e8f2cbfb4">ITEM_HAS_BEEN_PLACED_ON_GROUND_STR</a> ], <a class="code" href="__DutchText_8cpp.html#1a6754089e322c2627f2dae5ac92f044">ShortItemNames</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a>-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> ] );       
<a name="l03842"></a>03842 
<a name="l03843"></a>03843                   <span class="comment">// OK, disengage buddy</span>
<a name="l03844"></a>03844                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp;= (~SOLDIER_ENGAGEDINACTION );
<a name="l03845"></a>03845 
<a name="l03846"></a>03846                   <span class="keywordflow">if</span> ( ubTargetMercID != NOBODY )
<a name="l03847"></a>03847                   {
<a name="l03848"></a>03848                         <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubTargetMercID ]-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp;= (~SOLDIER_ENGAGEDINACTION );
<a name="l03849"></a>03849                   }
<a name="l03850"></a>03850 
<a name="l03851"></a>03851                   MemFree( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> );
<a name="l03852"></a>03852                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> = NULL;
<a name="l03853"></a>03853 
<a name="l03854"></a>03854             }
<a name="l03855"></a>03855       }
<a name="l03856"></a>03856 
<a name="l03857"></a>03857       <span class="keywordflow">return</span>( FALSE );
<a name="l03858"></a>03858 }
<a name="l03859"></a>03859 
<a name="l03860"></a>03860 
<a name="l03861"></a><a class="code" href="Handle_01Items_8h.html#cdd019d685eabf074358928539a5e75f">03861</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#cdd019d685eabf074358928539a5e75f">SoldierGiveItemFromAnimation</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l03862"></a>03862 {
<a name="l03863"></a>03863       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pTSoldier;
<a name="l03864"></a>03864       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                    bInvPos;
<a name="l03865"></a>03865       <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a>  TempObject;
<a name="l03866"></a>03866       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                   ubProfile;
<a name="l03867"></a>03867 
<a name="l03868"></a>03868       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                   sGridNo;
<a name="l03869"></a>03869       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                   ubDirection;
<a name="l03870"></a>03870       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                   ubTargetMercID;
<a name="l03871"></a>03871       <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>                  usItemNum;
<a name="l03872"></a>03872       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fToTargetPlayer = FALSE;
<a name="l03873"></a>03873 
<a name="l03874"></a>03874       <span class="comment">// Get items from pending data</span>
<a name="l03875"></a>03875 
<a name="l03876"></a>03876       <span class="comment">// Get objectype and delete</span>
<a name="l03877"></a>03877       memcpy( &amp;TempObject, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a>, <span class="keyword">sizeof</span>( <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> ) );
<a name="l03878"></a>03878       MemFree( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> );
<a name="l03879"></a>03879       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c8e5d4de5c5e5af59fc90d9c545a6bce">pTempObject</a> = NULL;
<a name="l03880"></a>03880 
<a name="l03881"></a>03881 
<a name="l03882"></a>03882       bInvPos = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2b57262d84965c3e6e984fa416813053">bPendingActionData5</a>;
<a name="l03883"></a>03883       usItemNum = TempObject.<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>;
<a name="l03884"></a>03884 
<a name="l03885"></a>03885   <span class="comment">// ATE: OK, check if we have an item in the cursor from</span>
<a name="l03886"></a>03886   <span class="comment">// this soldier and from this inv slot, if so, delete!!!!!!!</span>
<a name="l03887"></a>03887   <span class="keywordflow">if</span> ( <a class="code" href="Map_01Screen_01Interface_01Map_01Inventory_8cpp.html#a338c4e51d4834e0388d319683afe422">gpItemPointer</a> != NULL )
<a name="l03888"></a>03888   {
<a name="l03889"></a>03889     <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> == <a class="code" href="mapscreen_8cpp.html#18cbb71ef08841ff4ab21347be79f8d3">gpItemPointerSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> )
<a name="l03890"></a>03890     {
<a name="l03891"></a>03891       <span class="keywordflow">if</span> ( bInvPos == <a class="code" href="Handle_01Items_8cpp.html#04376bb6c024a83ce993a29ac1d8aeb8">gbItemPointerSrcSlot</a> &amp;&amp; usItemNum == <a class="code" href="Map_01Screen_01Interface_01Map_01Inventory_8cpp.html#a338c4e51d4834e0388d319683afe422">gpItemPointer</a>-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>  )
<a name="l03892"></a>03892       {
<a name="l03893"></a>03893         <span class="comment">// Remove!!!</span>
<a name="l03894"></a>03894         <a class="code" href="Interface_01Items_8cpp.html#403361f9ef42414ba0dec54c0fb74bfb">EndItemPointer</a>( );
<a name="l03895"></a>03895       }
<a name="l03896"></a>03896     }
<a name="l03897"></a>03897   }
<a name="l03898"></a>03898 
<a name="l03899"></a>03899       sGridNo           = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf70f6f1b637647860538cd60b5399c">sPendingActionData2</a>;
<a name="l03900"></a>03900       ubDirection = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#9262a8e1996d3ab40047dca23f4568c0">bPendingActionData3</a>;
<a name="l03901"></a>03901       ubTargetMercID = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#304094e7d2a05131c34f41c46dfb6fad">uiPendingActionData4</a>;
<a name="l03902"></a>03902 
<a name="l03903"></a>03903       <span class="comment">// ATE: Deduct APs!</span>
<a name="l03904"></a>03904       <a class="code" href="Points_8cpp.html#2443da2dcce8326e972d806fbc4eaff8">DeductPoints</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, AP_PICKUP_ITEM, 0 );
<a name="l03905"></a>03905 
<a name="l03906"></a>03906       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#347c3e9ff8ebab005920916fa11f7045">VerifyGiveItem</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;pTSoldier ) )
<a name="l03907"></a>03907       {
<a name="l03908"></a>03908             <span class="comment">// DAVE! - put stuff here to bring up shopkeeper.......</span>
<a name="l03909"></a>03909 
<a name="l03910"></a>03910             <span class="comment">//if the user just clicked on an arms dealer</span>
<a name="l03911"></a>03911             <span class="keywordflow">if</span>( <a class="code" href="Arms_01Dealer_01Init_8cpp.html#2cd9afebbc87f9c3d1050e8d3ec914ab">IsMercADealer</a>( pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ) )
<a name="l03912"></a>03912             {
<a name="l03913"></a>03913                   <a class="code" href="Dialogue_01Control_8cpp.html#49558f98c1f13e34f1d85fe8acf92b3d">UnSetEngagedInConvFromPCAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l03914"></a>03914 
<a name="l03915"></a>03915                   <span class="comment">//if the dealer is Micky, </span>
<a name="l03916"></a>03916                   <span class="comment">/*</span>
<a name="l03917"></a>03917 <span class="comment">                  if( pTSoldier-&gt;ubProfile == MICKY )</span>
<a name="l03918"></a>03918 <span class="comment">                  {</span>
<a name="l03919"></a>03919 <span class="comment">                        //and the items are alcohol, dont enter the shopkeeper</span>
<a name="l03920"></a>03920 <span class="comment">                        if( GetArmsDealerItemTypeFromItemNumber( TempObject.usItem ) == ARMS_DEALER_ALCOHOL )</span>
<a name="l03921"></a>03921 <span class="comment">                              return;</span>
<a name="l03922"></a>03922 <span class="comment">                  }</span>
<a name="l03923"></a>03923 <span class="comment">                  */</span>
<a name="l03924"></a>03924 
<a name="l03925"></a>03925                   <span class="keywordflow">if</span> ( <a class="code" href="NPC_8cpp.html#3d3de240eb5512c19bec3004309efc90">NPCHasUnusedRecordWithGivenApproach</a>( pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>, <a class="code" href="NPC_8h.html#fe4ba80db4eca5533465fe913160a13a3151db88645c44c92369d2ffff3f99b6">APPROACH_BUYSELL</a> ) )
<a name="l03926"></a>03926                   {
<a name="l03927"></a>03927                         <a class="code" href="NPC_8cpp.html#d7f92a649ae364cf3c2b7b69c4806bd0">TriggerNPCWithGivenApproach</a>( pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>, <a class="code" href="NPC_8h.html#fe4ba80db4eca5533465fe913160a13a3151db88645c44c92369d2ffff3f99b6">APPROACH_BUYSELL</a>, TRUE );
<a name="l03928"></a>03928                         <span class="keywordflow">return</span>;
<a name="l03929"></a>03929                   }
<a name="l03930"></a>03930                   <span class="comment">// now also check for buy/sell lines (Oct 13)</span>
<a name="l03931"></a>03931                   <span class="comment">/*</span>
<a name="l03932"></a>03932 <span class="comment">                  else if ( NPCWillingToAcceptItem( pTSoldier-&gt;ubProfile, pSoldier-&gt;ubProfile, &amp;TempObject ) )</span>
<a name="l03933"></a>03933 <span class="comment">                  {</span>
<a name="l03934"></a>03934 <span class="comment">                        TriggerNPCWithGivenApproach( pTSoldier-&gt;ubProfile, APPROACH_GIVINGITEM, TRUE );</span>
<a name="l03935"></a>03935 <span class="comment">                        return;</span>
<a name="l03936"></a>03936 <span class="comment">                  }*/</span>
<a name="l03937"></a>03937                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !<a class="code" href="NPC_8cpp.html#c999bd8da3fc2dd1d2453ed3de77e225">NPCWillingToAcceptItem</a>( pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>, pSoldier-&gt;ubProfile, &amp;TempObject ) )
<a name="l03938"></a>03938                   {
<a name="l03939"></a>03939 
<a name="l03940"></a>03940                         <span class="comment">//Enter the shopkeeper interface</span>
<a name="l03941"></a>03941                         <a class="code" href="ShopKeeper_01Interface_8cpp.html#a52452e70b026b7ba81b5ddb08a4457e">EnterShopKeeperInterfaceScreen</a>( pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> );
<a name="l03942"></a>03942 
<a name="l03943"></a>03943 <span class="comment">// removed the if, because if the player picked up an item straight from the ground or money strait from the money </span>
<a name="l03944"></a>03944 <span class="comment">// interface, the item would NOT have a bInvPos, therefore it would not get added to the dealer, and would get deleted</span>
<a name="l03945"></a>03945 <span class="comment">//                      if ( bInvPos != NO_SLOT )</span>
<a name="l03946"></a>03946                         {
<a name="l03947"></a>03947                               <span class="comment">// MUST send in NO_SLOT, as the SKI wille expect it to exist in inv if not....</span>
<a name="l03948"></a>03948                               <a class="code" href="ShopKeeper_01Interface_8cpp.html#7ec2d8ce1365a8ff8cba9b3f234696c8">AddItemToPlayersOfferAreaAfterShopKeeperOpen</a>( &amp;TempObject, NO_SLOT );
<a name="l03949"></a>03949 
<a name="l03950"></a>03950 <span class="comment">/*</span>
<a name="l03951"></a>03951 <span class="comment">Changed because if the player gave 1 item from a pile, the rest of the items in the piule would disappear</span>
<a name="l03952"></a>03952 <span class="comment">                              // OK, r    emove the item, as the SKI will give it back once done</span>
<a name="l03953"></a>03953 <span class="comment">                              DeleteObj( &amp;( pSoldier-&gt;inv[ bInvPos ] ) );</span>
<a name="l03954"></a>03954 <span class="comment">*/</span>
<a name="l03955"></a>03955 
<a name="l03956"></a>03956 
<a name="l03957"></a>03957                               <span class="keywordflow">if</span> ( bInvPos != NO_SLOT )
<a name="l03958"></a>03958                               {
<a name="l03959"></a>03959                                     <a class="code" href="Items_8cpp.html#5c48a6476c06d69d2edb4b3912d2ae70">RemoveObjFrom</a>( &amp;pSoldier-&gt;inv[ bInvPos ], TempObject.<a class="code" href="structOBJECTTYPE.html#84ab3cbeb7dfdcc2e5ad4051e165d294">ubNumberOfObjects</a> );
<a name="l03960"></a>03960                               }
<a name="l03961"></a>03961 
<a name="l03962"></a>03962                               <a class="code" href="Interface_8cpp.html#8a607488839071ed48da8a73aeaad595">DirtyMercPanelInterface</a>( pSoldier, DIRTYLEVEL2 );
<a name="l03963"></a>03963                         }
<a name="l03964"></a>03964 
<a name="l03965"></a>03965                         <span class="keywordflow">return</span>;
<a name="l03966"></a>03966                   }
<a name="l03967"></a>03967             }
<a name="l03968"></a>03968 
<a name="l03969"></a>03969             <span class="comment">// OK&lt; FOR NOW HANDLE NPC's DIFFERENT!</span>
<a name="l03970"></a>03970             ubProfile = pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>;
<a name="l03971"></a>03971 
<a name="l03972"></a>03972             <span class="comment">// 1 ) PLayer to NPC = NPC</span>
<a name="l03973"></a>03973             <span class="comment">// 2 ) Player to player = player;</span>
<a name="l03974"></a>03974             <span class="comment">// 3 ) NPC to player = player;</span>
<a name="l03975"></a>03975             <span class="comment">// 4 ) NPC TO NPC = NPC</span>
<a name="l03976"></a>03976 
<a name="l03977"></a>03977             <span class="comment">// Switch on target...</span>
<a name="l03978"></a>03978             <span class="comment">// Are we a player dude.. ( target? )</span>
<a name="l03979"></a>03979             <span class="keywordflow">if</span> ( ubProfile &lt; FIRST_RPC || RPC_RECRUITED( pTSoldier ) || ubProfile &gt;= <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa150c510db5aaca8d588a456f077a86a2d">GASTON</a> )
<a name="l03980"></a>03980             {     
<a name="l03981"></a>03981                   fToTargetPlayer = TRUE;
<a name="l03982"></a>03982             }
<a name="l03983"></a>03983 
<a name="l03984"></a>03984 
<a name="l03985"></a>03985             <span class="keywordflow">if</span> ( fToTargetPlayer )
<a name="l03986"></a>03986             {
<a name="l03987"></a>03987                   <span class="comment">// begin giving</span>
<a name="l03988"></a>03988                   <a class="code" href="Interface_8cpp.html#8a607488839071ed48da8a73aeaad595">DirtyMercPanelInterface</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, DIRTYLEVEL2 );
<a name="l03989"></a>03989 
<a name="l03990"></a>03990                   <span class="comment">// We are a merc, add!</span>
<a name="l03991"></a>03991                   <span class="keywordflow">if</span> ( !<a class="code" href="Items_8cpp.html#b0cdccd7f510d5464ab386cb5b69c28f">AutoPlaceObject</a>( pTSoldier, &amp;TempObject, TRUE ) )
<a name="l03992"></a>03992                   {
<a name="l03993"></a>03993                         <span class="comment">// Erase!</span>
<a name="l03994"></a>03994                         <span class="keywordflow">if</span> ( bInvPos != NO_SLOT )
<a name="l03995"></a>03995                         {
<a name="l03996"></a>03996                               <a class="code" href="Items_8cpp.html#5950d1252d479c6f8c5a25d86b06d889">DeleteObj</a>( &amp;( pSoldier-&gt;inv[ bInvPos ] ) );
<a name="l03997"></a>03997                               <a class="code" href="Interface_8cpp.html#8a607488839071ed48da8a73aeaad595">DirtyMercPanelInterface</a>( pSoldier, DIRTYLEVEL2 );
<a name="l03998"></a>03998                         }
<a name="l03999"></a>03999                         
<a name="l04000"></a>04000                         <a class="code" href="Handle_01Items_8cpp.html#ca7f6f6da97e9a4c2b737296485f5c84">AddItemToPool</a>( pSoldier-&gt;sGridNo, &amp;TempObject, 1, pSoldier-&gt;bLevel, 0 , -1 );
<a name="l04001"></a>04001 
<a name="l04002"></a>04002                         <span class="comment">// We could not place it!</span>
<a name="l04003"></a>04003                         <span class="comment">// Drop it on the ground?</span>
<a name="l04004"></a>04004                         <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe7960cb252cbf4d4727eb6251e8f2cbfb4">ITEM_HAS_BEEN_PLACED_ON_GROUND_STR</a> ], <a class="code" href="__DutchText_8cpp.html#1a6754089e322c2627f2dae5ac92f044">ShortItemNames</a>[ usItemNum ] );         
<a name="l04005"></a>04005 
<a name="l04006"></a>04006                         <span class="comment">// OK, disengage buddy</span>
<a name="l04007"></a>04007                         pSoldier-&gt;uiStatusFlags &amp;= (~SOLDIER_ENGAGEDINACTION );
<a name="l04008"></a>04008                         pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp;= (~SOLDIER_ENGAGEDINACTION );
<a name="l04009"></a>04009                   }
<a name="l04010"></a>04010                   <span class="keywordflow">else</span>
<a name="l04011"></a>04011                   {
<a name="l04012"></a>04012                         <span class="comment">// Erase!</span>
<a name="l04013"></a>04013                         <span class="keywordflow">if</span> ( bInvPos != NO_SLOT )
<a name="l04014"></a>04014                         {
<a name="l04015"></a>04015                               <a class="code" href="Items_8cpp.html#5950d1252d479c6f8c5a25d86b06d889">DeleteObj</a>( &amp;( pSoldier-&gt;inv[ bInvPos ] ) );
<a name="l04016"></a>04016                               <a class="code" href="Interface_8cpp.html#8a607488839071ed48da8a73aeaad595">DirtyMercPanelInterface</a>( pSoldier, DIRTYLEVEL2 );
<a name="l04017"></a>04017                         }
<a name="l04018"></a>04018 
<a name="l04019"></a>04019                         <span class="comment">// OK, it's given, display message!</span>
<a name="l04020"></a>04020                         <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe7dd79fb156188eb70910b492ad9add81f">ITEM_HAS_BEEN_GIVEN_TO_STR</a> ], <a class="code" href="__DutchText_8cpp.html#1a6754089e322c2627f2dae5ac92f044">ShortItemNames</a>[ usItemNum ], pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a> );
<a name="l04021"></a>04021                         <span class="keywordflow">if</span> (usItemNum == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4fbf7e82d9551a181f32f99564541f312">MONEY</a>)
<a name="l04022"></a>04022                         {
<a name="l04023"></a>04023                               <span class="comment">// are we giving money to an NPC, to whom we owe money?</span>
<a name="l04024"></a>04024                               <span class="keywordflow">if</span> (pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE &amp;&amp; <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>].iBalance &lt; 0)
<a name="l04025"></a>04025                               {
<a name="l04026"></a>04026                                     <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>].<a class="code" href="structMERCPROFILESTRUCT.html#c35cc0ea235c0ee715cac81a684c7380">iBalance</a> += TempObject.<a class="code" href="structOBJECTTYPE.html#c1c1aff6f6a60e1a522bbe3cac327a88">uiMoneyAmount</a>;
<a name="l04027"></a>04027                                     <span class="keywordflow">if</span> (<a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>].iBalance &gt;= 0)
<a name="l04028"></a>04028                                     {
<a name="l04029"></a>04029                                           <span class="comment">// don't let the player accumulate credit (?)</span>
<a name="l04030"></a>04030                                           <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>].<a class="code" href="structMERCPROFILESTRUCT.html#c35cc0ea235c0ee715cac81a684c7380">iBalance</a> = 0;
<a name="l04031"></a>04031 
<a name="l04032"></a>04032                                           <span class="comment">// report the payment and set facts to indicate people not being owed money</span>
<a name="l04033"></a>04033                                           <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe70367085d61473810a8e432cc98411cc3">GUY_HAS_BEEN_PAID_IN_FULL_STR</a> ], pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a> );
<a name="l04034"></a>04034                                     }
<a name="l04035"></a>04035                                     <span class="keywordflow">else</span>
<a name="l04036"></a>04036                                     {
<a name="l04037"></a>04037                                           <span class="comment">// report the payment</span>
<a name="l04038"></a>04038                                           <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe7270571ab78a32d07f47b0bf9908f1dae">GUY_STILL_OWED_STR</a> ], pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#7bf7231f416aa66f38010b7a7e8f2341">name</a>, -<a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a>].iBalance );        
<a name="l04039"></a>04039                                     }
<a name="l04040"></a>04040                               }
<a name="l04041"></a>04041                         }
<a name="l04042"></a>04042                   }
<a name="l04043"></a>04043             }
<a name="l04044"></a>04044             <span class="keywordflow">else</span>
<a name="l04045"></a>04045             {
<a name="l04046"></a>04046                   <span class="comment">// Erase!</span>
<a name="l04047"></a>04047                   <span class="keywordflow">if</span> ( bInvPos != NO_SLOT )
<a name="l04048"></a>04048                   {
<a name="l04049"></a>04049                         <a class="code" href="Items_8cpp.html#0b912c79911891027d5cf460c9eaa589">RemoveObjs</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ bInvPos ]), TempObject.<a class="code" href="structOBJECTTYPE.html#84ab3cbeb7dfdcc2e5ad4051e165d294">ubNumberOfObjects</a> );
<a name="l04050"></a>04050                         <a class="code" href="Interface_8cpp.html#8a607488839071ed48da8a73aeaad595">DirtyMercPanelInterface</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, DIRTYLEVEL2 );
<a name="l04051"></a>04051                   }
<a name="l04052"></a>04052 
<a name="l04053"></a>04053                   <span class="comment">// Now intiate conv</span>
<a name="l04054"></a>04054                   <a class="code" href="Interface_01Dialogue_8cpp.html#fbe9698a690e568a4298f0582423a00f">InitiateConversation</a>( pTSoldier, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="NPC_8h.html#fe4ba80db4eca5533465fe913160a13ad513d8f91006e520c9cd624d0735978b">APPROACH_GIVINGITEM</a>, (<a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>)&amp;TempObject );
<a name="l04055"></a>04055             }
<a name="l04056"></a>04056       }
<a name="l04057"></a>04057 
<a name="l04058"></a>04058       <span class="comment">// OK, disengage buddy</span>
<a name="l04059"></a>04059       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp;= (~SOLDIER_ENGAGEDINACTION );
<a name="l04060"></a>04060       pTSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp;= (~SOLDIER_ENGAGEDINACTION );
<a name="l04061"></a>04061 
<a name="l04062"></a>04062 }
<a name="l04063"></a>04063 
<a name="l04064"></a>04064 
<a name="l04065"></a>04065 
<a name="l04066"></a><a class="code" href="Handle_01Items_8h.html#29f9b6fb69c5f31798d6d5924f22edd5">04066</a> <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> <a class="code" href="Handle_01Items_8cpp.html#29f9b6fb69c5f31798d6d5924f22edd5">AdjustGridNoForItemPlacement</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo )
<a name="l04067"></a>04067 {
<a name="l04068"></a>04068       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a>         *pStructure;
<a name="l04069"></a>04069       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                   sDesiredLevel;
<a name="l04070"></a>04070       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                   sActionGridNo;
<a name="l04071"></a>04071       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fStructFound = FALSE;
<a name="l04072"></a>04072       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                   ubDirection;
<a name="l04073"></a>04073       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                   sAdjustedGridNo;
<a name="l04074"></a>04074       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                   ubTargetID;
<a name="l04075"></a>04075 
<a name="l04076"></a>04076       
<a name="l04077"></a>04077       sActionGridNo = sGridNo;
<a name="l04078"></a>04078 
<a name="l04079"></a>04079       <span class="comment">// Check structure database</span>
<a name="l04080"></a>04080       <span class="keywordflow">if</span>( <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].pStructureHead )
<a name="l04081"></a>04081       {
<a name="l04082"></a>04082             <span class="comment">// Something is here, check obstruction in future</span>
<a name="l04083"></a>04083             sDesiredLevel = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> ? STRUCTURE_ON_ROOF : STRUCTURE_ON_GROUND;
<a name="l04084"></a>04084             pStructure = <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)sGridNo, STRUCTURE_BLOCKSMOVES );
<a name="l04085"></a>04085             <span class="keywordflow">while</span>( pStructure )
<a name="l04086"></a>04086             {
<a name="l04087"></a>04087                   <span class="keywordflow">if</span>( !(pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#5a803a00d8769236709b4f0665951383">fFlags</a> &amp; STRUCTURE_PASSABLE) &amp;&amp; pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#a8cb801aeb04ca6e49c4ab8b66c75997">sCubeOffset</a> == sDesiredLevel )
<a name="l04088"></a>04088                   {
<a name="l04089"></a>04089                         <span class="comment">// Check for openable flag....</span>
<a name="l04090"></a>04090                         <span class="comment">//if ( pStructure-&gt;fFlags &amp; ( STRUCTURE_OPENABLE | STRUCTURE_HASITEMONTOP ) )</span>
<a name="l04091"></a>04091                         {
<a name="l04092"></a>04092                               fStructFound = TRUE;
<a name="l04093"></a>04093                               <span class="keywordflow">break</span>;
<a name="l04094"></a>04094                         }
<a name="l04095"></a>04095                   }
<a name="l04096"></a>04096                   pStructure = <a class="code" href="structure_8cpp.html#cb29f04194ddd6161b1b20c3671ec4b6">FindNextStructure</a>( pStructure, STRUCTURE_BLOCKSMOVES );
<a name="l04097"></a>04097             }
<a name="l04098"></a>04098       }
<a name="l04099"></a>04099 
<a name="l04100"></a>04100       <span class="comment">// ATE: IF a person is found, use adjacent gridno for it!</span>
<a name="l04101"></a>04101       ubTargetID = <a class="code" href="worldman_8cpp.html#87338f0c77765726813428fd184bfcd8">WhoIsThere2</a>( sGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l04102"></a>04102 
<a name="l04103"></a>04103       <span class="keywordflow">if</span> ( fStructFound || ( ubTargetID != NOBODY &amp;&amp; ubTargetID != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> ) )
<a name="l04104"></a>04104       {
<a name="l04105"></a>04105             <span class="comment">// GET ADJACENT GRIDNO</span>
<a name="l04106"></a>04106             sActionGridNo =  <a class="code" href="Overhead_8cpp.html#d1a60549f93262064e9f2d0af8861973">FindAdjacentGridEx</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sGridNo, &amp;ubDirection, &amp;sAdjustedGridNo, FALSE, FALSE );
<a name="l04107"></a>04107 
<a name="l04108"></a>04108             <span class="keywordflow">if</span> ( sActionGridNo == -1 )
<a name="l04109"></a>04109             {
<a name="l04110"></a>04110                   sActionGridNo = sAdjustedGridNo;
<a name="l04111"></a>04111             }
<a name="l04112"></a>04112       }
<a name="l04113"></a>04113 
<a name="l04114"></a>04114       <span class="keywordflow">return</span>( sActionGridNo );
<a name="l04115"></a>04115 }
<a name="l04116"></a>04116  
<a name="l04117"></a>04117 
<a name="l04118"></a><a class="code" href="Handle_01Items_8cpp.html#8be34a74ed567842429dd7d4eeb78195">04118</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#8be34a74ed567842429dd7d4eeb78195">StartBombMessageBox</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo )
<a name="l04119"></a>04119 {
<a name="l04120"></a>04120       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubRoom;
<a name="l04121"></a>04121 
<a name="l04122"></a>04122       <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l04123"></a>04123       <a class="code" href="Handle_01Items_8cpp.html#2a4f3638cd7bc6c7361fbb6f14de1114">gsTempGridno</a> = sGridNo;
<a name="l04124"></a>04124       <span class="keywordflow">if</span> (<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].usItem].remotetrigger )
<a name="l04125"></a>04125       {
<a name="l04126"></a>04126             <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28ee5e262027426058dc95957ae95e97538">MSG_BOX_BASIC_SMALL_BUTTONS</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe7476251a2584760f8c3d4478addae78fe">CHOOSE_BOMB_FREQUENCY_STR</a> ], <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf29873e16bc1530dedb416060abbeea6d0">GAME_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_FOUR_NUMBERED_BUTTONS, <a class="code" href="Handle_01Items_8cpp.html#418b08f9fd1bcbe6f4af586abaf88c2e">BombMessageBoxCallBack</a>, NULL );
<a name="l04127"></a>04127       }
<a name="l04128"></a>04128       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[HANDPOS].<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f442491d78a36173d4c8cdf3bf4e87c50d">REMOTETRIGGER</a>)
<a name="l04129"></a>04129       {
<a name="l04130"></a>04130             <span class="comment">// ATE ignore the commented-out code and add stuff to open the secret passage here</span>
<a name="l04131"></a>04131             <span class="comment">/*</span>
<a name="l04132"></a>04132 <span class="comment">            switch( pSoldier-&gt;inv[HANDPOS].ubLocationID )</span>
<a name="l04133"></a>04133 <span class="comment">            {</span>
<a name="l04134"></a>04134 <span class="comment">                  // check to make sure the appropriate sector is loaded</span>
<a name="l04135"></a>04135 <span class="comment">            }</span>
<a name="l04136"></a>04136 <span class="comment">            SetOffBombsByFrequency( pSoldier-&gt;ubID, pSoldier-&gt;inv[HANDPOS].bFrequency );</span>
<a name="l04137"></a>04137 <span class="comment">            */</span>
<a name="l04138"></a>04138                   
<a name="l04139"></a>04139       <span class="comment">// PLay sound....</span>
<a name="l04140"></a>04140       <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5122632928289fdf030cf4cbaf506235c">USE_STATUE_REMOTE</a>, RATE_11025, HIGHVOLUME, 1, MIDDLEPAN );                               
<a name="l04141"></a>04141 
<a name="l04142"></a>04142 
<a name="l04143"></a>04143             <span class="comment">// Check what sector we are in....</span>
<a name="l04144"></a>04144             <span class="keywordflow">if</span> ( <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a> == 3 &amp;&amp; <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a> == MAP_ROW_O &amp;&amp; <a class="code" href="strategicmap_8cpp.html#da715721a8ceedd42acf6ddb33e63ce0">gbWorldSectorZ</a> == 0 )
<a name="l04145"></a>04145             {
<a name="l04146"></a>04146                   <span class="keywordflow">if</span> ( <a class="code" href="Render_01Fun_8cpp.html#8df6498b7334d324ca92136572bba261">InARoom</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, &amp;ubRoom ) &amp;&amp; ubRoom == 4 )
<a name="l04147"></a>04147                   {
<a name="l04148"></a>04148                         <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0ad438cfef4495b2df34f8dbe552dcdd4c">BATTLE_SOUND_OK1</a> );
<a name="l04149"></a>04149 
<a name="l04150"></a>04150                         <span class="comment">// Open statue</span>
<a name="l04151"></a>04151                         <a class="code" href="End_01Game_8cpp.html#1217879bacb3dd196d8a87847e0e2d8a">ChangeO3SectorStatue</a>( FALSE );
<a name="l04152"></a>04152 
<a name="l04153"></a>04153                   }
<a name="l04154"></a>04154                   <span class="keywordflow">else</span>
<a name="l04155"></a>04155                   {
<a name="l04156"></a>04156                         <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0aa5a3b5d825d15837f5c41acc1031f4b0">BATTLE_SOUND_CURSE1</a> );
<a name="l04157"></a>04157                   }
<a name="l04158"></a>04158             }
<a name="l04159"></a>04159             <span class="keywordflow">else</span>
<a name="l04160"></a>04160             {
<a name="l04161"></a>04161                   <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0aa5a3b5d825d15837f5c41acc1031f4b0">BATTLE_SOUND_CURSE1</a> );
<a name="l04162"></a>04162             }
<a name="l04163"></a>04163       }
<a name="l04164"></a>04164       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="Items_8cpp.html#69f462eb26c68f572dcfbaa2a7e24d32">IsDetonatorAttached</a> ( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[HANDPOS]) )  )
<a name="l04165"></a>04165       {
<a name="l04166"></a>04166             <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28ee5e262027426058dc95957ae95e97538">MSG_BOX_BASIC_SMALL_BUTTONS</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe70d97cf09d6ddfebd50ffea964c45c9c1">CHOOSE_TIMER_STR</a> ], <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf29873e16bc1530dedb416060abbeea6d0">GAME_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_FOUR_NUMBERED_BUTTONS, <a class="code" href="Handle_01Items_8cpp.html#418b08f9fd1bcbe6f4af586abaf88c2e">BombMessageBoxCallBack</a>, NULL );
<a name="l04167"></a>04167       }
<a name="l04168"></a>04168       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="Items_8cpp.html#5057189c6cc02dcf8ba950768a9c3a43">IsRemoteDetonatorAttached</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[HANDPOS]) ) )
<a name="l04169"></a>04169       {
<a name="l04170"></a>04170             <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28ee5e262027426058dc95957ae95e97538">MSG_BOX_BASIC_SMALL_BUTTONS</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe7124e98809ecd58edbe3b0ce54297350c">CHOOSE_REMOTE_FREQUENCY_STR</a> ], <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf29873e16bc1530dedb416060abbeea6d0">GAME_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_FOUR_NUMBERED_BUTTONS, <a class="code" href="Handle_01Items_8cpp.html#418b08f9fd1bcbe6f4af586abaf88c2e">BombMessageBoxCallBack</a>, NULL );
<a name="l04171"></a>04171       }
<a name="l04172"></a>04172 }
<a name="l04173"></a>04173 
<a name="l04174"></a><a class="code" href="Handle_01Items_8cpp.html#418b08f9fd1bcbe6f4af586abaf88c2e">04174</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#418b08f9fd1bcbe6f4af586abaf88c2e">BombMessageBoxCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue )
<a name="l04175"></a>04175 {
<a name="l04176"></a>04176       <span class="keywordflow">if</span> (<a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>)
<a name="l04177"></a>04177       {
<a name="l04178"></a>04178             <span class="keywordflow">if</span> (<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a>].usItem ].remotetrigger )
<a name="l04179"></a>04179             {
<a name="l04180"></a>04180                   <a class="code" href="Explosion_01Control_8cpp.html#466b8c5a726dc0f74645c6717b2a938e">SetOffBombsByFrequency</a>( <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>, ubExitValue );
<a name="l04181"></a>04181             }
<a name="l04182"></a>04182             <span class="keywordflow">else</span>
<a name="l04183"></a>04183             {
<a name="l04184"></a>04184                   <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iResult;
<a name="l04185"></a>04185 
<a name="l04186"></a>04186                   <span class="keywordflow">if</span> (<a class="code" href="Items_8cpp.html#5057189c6cc02dcf8ba950768a9c3a43">IsRemoteDetonatorAttached</a>( &amp;(<a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[HANDPOS]) ) )
<a name="l04187"></a>04187                   {
<a name="l04188"></a>04188                         iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e489d587b09bef0472e8dd84c16bffc690">PLANTING_REMOTE_BOMB_CHECK</a>, 0 );
<a name="l04189"></a>04189                   }
<a name="l04190"></a>04190                   <span class="keywordflow">else</span>
<a name="l04191"></a>04191                   {
<a name="l04192"></a>04192                         iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e41a0cdf3ca5245d4cace59b8a6355c644">PLANTING_BOMB_CHECK</a>, 0 );
<a name="l04193"></a>04193                   }
<a name="l04194"></a>04194 
<a name="l04195"></a>04195                   <span class="keywordflow">if</span> ( iResult &gt;= 0 )
<a name="l04196"></a>04196                   {
<a name="l04197"></a>04197                         <span class="comment">// EXPLOSIVES GAIN (25):  Place a bomb, or buried and armed a mine</span>
<a name="l04198"></a>04198                         <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>, EXPLODEAMT, 25, FALSE );
<a name="l04199"></a>04199                   }
<a name="l04200"></a>04200                   <span class="keywordflow">else</span>
<a name="l04201"></a>04201                   {
<a name="l04202"></a>04202                         <span class="comment">// EXPLOSIVES GAIN (10):  Failed to place a bomb, or bury and arm a mine</span>
<a name="l04203"></a>04203                         <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>, EXPLODEAMT, 10, FROM_FAILURE );
<a name="l04204"></a>04204 
<a name="l04205"></a>04205                         <span class="comment">// oops!  How badly did we screw up?</span>
<a name="l04206"></a>04206                         <span class="keywordflow">if</span> ( iResult &gt;= -20 )
<a name="l04207"></a>04207                         {
<a name="l04208"></a>04208                               <span class="comment">// messed up the setting</span>
<a name="l04209"></a>04209                               <span class="keywordflow">if</span> ( ubExitValue == 0 )
<a name="l04210"></a>04210                               {
<a name="l04211"></a>04211                                     ubExitValue = 1;
<a name="l04212"></a>04212                               }
<a name="l04213"></a>04213                               <span class="keywordflow">else</span>
<a name="l04214"></a>04214                               {
<a name="l04215"></a>04215                                     <span class="comment">// change up/down by 1</span>
<a name="l04216"></a>04216                                     ubExitValue = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) (ubExitValue + <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 3 ) - 1);
<a name="l04217"></a>04217                               }
<a name="l04218"></a>04218                               <span class="comment">// and continue</span>
<a name="l04219"></a>04219                         }
<a name="l04220"></a>04220                         <span class="keywordflow">else</span>
<a name="l04221"></a>04221                         {
<a name="l04222"></a>04222                               <span class="comment">// OOPS! ... BOOM!</span>
<a name="l04223"></a>04223                               <a class="code" href="Explosion_01Control_8cpp.html#add4813e471ef668a64079af2ea8b36a">IgniteExplosion</a>( NOBODY, <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#80d05007932f81f157f2773852ebf62f">sX</a>, <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#bad6abc8c1fd843d332db84aa9c1a10c">sY</a>, (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) (<a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[<a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>].sHeight), <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ HANDPOS ].<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>, <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l04224"></a>04224                               <span class="keywordflow">return</span>;
<a name="l04225"></a>04225                         }
<a name="l04226"></a>04226                   }
<a name="l04227"></a>04227 
<a name="l04228"></a>04228                   <span class="keywordflow">if</span> ( <a class="code" href="Items_8cpp.html#7fecee7474f626d9999d60304129c031">ArmBomb</a>( &amp;(<a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[HANDPOS]), ubExitValue ) )
<a name="l04229"></a>04229                   {
<a name="l04230"></a>04230                         <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ HANDPOS ].<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a> = __min( 10, ( <a class="code" href="SkillCheck_8cpp.html#4dadb296e11e2633e5f12a2432fbc147">EffectiveExplosive</a>( <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a> ) / 20) + (<a class="code" href="SkillCheck_8cpp.html#15874afa42450a6228e52f68f6871178">EffectiveExpLevel</a>( <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a> ) / 3) );
<a name="l04231"></a>04231                         <span class="comment">// HACK IMMINENT!</span>
<a name="l04232"></a>04232                         <span class="comment">// value of 1 is stored in maps for SIDE of bomb owner... when we want to use IDs!</span>
<a name="l04233"></a>04233                         <span class="comment">// so we add 2 to all owner IDs passed through here and subtract 2 later</span>
<a name="l04234"></a>04234                         <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[HANDPOS].<a class="code" href="structOBJECTTYPE.html#085f3d8acfbd4ec7448607c65054cc27">ubBombOwner</a> = <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> + 2;
<a name="l04235"></a>04235                         <a class="code" href="Handle_01Items_8cpp.html#ca7f6f6da97e9a4c2b737296485f5c84">AddItemToPool</a>( <a class="code" href="Handle_01Items_8cpp.html#2a4f3638cd7bc6c7361fbb6f14de1114">gsTempGridno</a>, &amp;(<a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[HANDPOS]), 1, <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, WORLD_ITEM_ARMED_BOMB, 0 );
<a name="l04236"></a>04236                         <a class="code" href="Items_8cpp.html#5950d1252d479c6f8c5a25d86b06d889">DeleteObj</a>( &amp;(<a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[HANDPOS]) );
<a name="l04237"></a>04237                   }
<a name="l04238"></a>04238             }
<a name="l04239"></a>04239       }
<a name="l04240"></a>04240 
<a name="l04241"></a>04241 }
<a name="l04242"></a>04242 
<a name="l04243"></a>04243 
<a name="l04244"></a><a class="code" href="Handle_01Items_8h.html#aaae8566276789f2922af5339f346c37">04244</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#aaae8566276789f2922af5339f346c37">HandItemWorks</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bSlot )
<a name="l04245"></a>04245 {
<a name="l04246"></a>04246       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                                         fItemJustBroke = FALSE, fItemWorks = TRUE;
<a name="l04247"></a>04247       <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *                        pObj;
<a name="l04248"></a>04248       
<a name="l04249"></a>04249       pObj = &amp;( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ bSlot ] );
<a name="l04250"></a>04250 
<a name="l04251"></a>04251       <span class="comment">// if the item can be damaged, than we must check that it's in good enough</span>
<a name="l04252"></a>04252       <span class="comment">// shape to be usable, and doesn't break during use.</span>
<a name="l04253"></a>04253       <span class="comment">// Exception: land mines.  You can bury them broken, they just won't blow!</span>
<a name="l04254"></a>04254 <span class="comment">//    if ( (Item[ pObj-&gt;usItem ].fFlags &amp; ITEM_DAMAGEABLE) &amp;&amp; (pObj-&gt;usItem != MINE) &amp;&amp; (Item[ pObj-&gt;usItem ].usItemClass != IC_MEDKIT) &amp;&amp; pObj-&gt;usItem != GAS_CAN )</span>
<a name="l04255"></a>04255       <span class="keywordflow">if</span> ( (<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ pObj-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> ].damageable ) &amp;&amp; (!<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[pObj-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>].mine ) &amp;&amp; (<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ pObj-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> ].usItemClass != IC_MEDKIT) &amp;&amp; !<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[pObj-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>].gascan )
<a name="l04256"></a>04256       {
<a name="l04257"></a>04257             <span class="comment">// if it's still usable, check whether it breaks</span>
<a name="l04258"></a>04258             <span class="keywordflow">if</span> ( pObj-&gt;<a class="code" href="structOBJECTTYPE.html#aa0827e15c8e54d285d2850ea5ffbb07">bStatus</a>[0] &gt;= USABLE)
<a name="l04259"></a>04259             {
<a name="l04260"></a>04260                   <span class="comment">// if a dice roll is greater than the item's status</span>
<a name="l04261"></a>04261                   <span class="keywordflow">if</span> ( (<a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>(80) + 20) &gt;= (<a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>) (pObj-&gt;<a class="code" href="structOBJECTTYPE.html#aa0827e15c8e54d285d2850ea5ffbb07">bStatus</a>[0] + 50) )
<a name="l04262"></a>04262                   {
<a name="l04263"></a>04263                         fItemJustBroke = TRUE;
<a name="l04264"></a>04264                         fItemWorks = FALSE;
<a name="l04265"></a>04265 
<a name="l04266"></a>04266                         <span class="comment">// item breaks, and becomes unusable...  so its status is reduced</span>
<a name="l04267"></a>04267                         <span class="comment">// to somewhere between 1 and the 1 less than USABLE</span>
<a name="l04268"></a>04268                         pObj-&gt;<a class="code" href="structOBJECTTYPE.html#aa0827e15c8e54d285d2850ea5ffbb07">bStatus</a>[0] = (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) ( 1 + <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( USABLE - 1 ) );
<a name="l04269"></a>04269                   }
<a name="l04270"></a>04270             }
<a name="l04271"></a>04271             <span class="keywordflow">else</span>  <span class="comment">// it's already unusable</span>
<a name="l04272"></a>04272             {
<a name="l04273"></a>04273                   fItemWorks = FALSE;
<a name="l04274"></a>04274             }
<a name="l04275"></a>04275 
<a name="l04276"></a>04276             <span class="keywordflow">if</span> (!fItemWorks &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a>)
<a name="l04277"></a>04277             {
<a name="l04278"></a>04278                   <span class="comment">// merc says "This thing doesn't work!"</span>
<a name="l04279"></a>04279                   <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a297b57c2d8fcdebf7a74c3ffb6670b3a53">QUOTE_USELESS_ITEM</a> );
<a name="l04280"></a>04280                   <span class="keywordflow">if</span> (fItemJustBroke)
<a name="l04281"></a>04281                   {
<a name="l04282"></a>04282                         <a class="code" href="Interface_8cpp.html#8a607488839071ed48da8a73aeaad595">DirtyMercPanelInterface</a>( pSoldier, DIRTYLEVEL2 );
<a name="l04283"></a>04283                   }
<a name="l04284"></a>04284             }
<a name="l04285"></a>04285       }
<a name="l04286"></a>04286 
<a name="l04287"></a>04287       <span class="keywordflow">if</span> ( fItemWorks &amp;&amp; bSlot == <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855408e678e638d95e18d5e9a2a64a96e2e">HANDPOS</a> &amp;&amp; <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ pObj-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> ].usItemClass == IC_GUN )
<a name="l04288"></a>04288       {
<a name="l04289"></a>04289             <span class="comment">// are we using two guns at once?</span>
<a name="l04290"></a>04290             <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855009684dc553cebead620fa082b29cb86">SECONDHANDPOS</a>].usItem ].usItemClass == IC_GUN &amp;&amp;
<a name="l04291"></a>04291                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855009684dc553cebead620fa082b29cb86">SECONDHANDPOS</a>].bGunStatus &gt;= USABLE &amp;&amp;
<a name="l04292"></a>04292                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855009684dc553cebead620fa082b29cb86">SECONDHANDPOS</a>].ubGunShotsLeft &gt; 0)
<a name="l04293"></a>04293             {
<a name="l04294"></a>04294                   <span class="comment">// check the second gun for breakage, and if IT breaks, return false</span>
<a name="l04295"></a>04295                   <span class="keywordflow">return</span>( <a class="code" href="Handle_01Items_8cpp.html#aaae8566276789f2922af5339f346c37">HandItemWorks</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc87855009684dc553cebead620fa082b29cb86">SECONDHANDPOS</a> ) );
<a name="l04296"></a>04296             }
<a name="l04297"></a>04297       }
<a name="l04298"></a>04298 
<a name="l04299"></a>04299       <span class="keywordflow">return</span>( fItemWorks );
<a name="l04300"></a>04300 }
<a name="l04301"></a>04301 
<a name="l04302"></a>04302 
<a name="l04303"></a><a class="code" href="Handle_01Items_8h.html#9bae781a83db2ac6a3f2a6efafe7eb65">04303</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#9bae781a83db2ac6a3f2a6efafe7eb65">SetOffBoobyTrapInMapScreen</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *pObject )
<a name="l04304"></a>04304 {
<a name="l04305"></a>04305       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubPtsDmg = 0;
<a name="l04306"></a>04306 
<a name="l04307"></a>04307       <span class="comment">// check if trapped item is an explosive, if so then up the amount of dmg</span>
<a name="l04308"></a>04308       <span class="keywordflow">if</span>( ( pObject -&gt; usItem == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f41232b1b230d16a358afacf9b10b73ed3">TNT</a> )|| (  pObject -&gt; usItem == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f40358584dab0bc3a6ff014581cf6f4660">RDX</a> ) )
<a name="l04309"></a>04309       {
<a name="l04310"></a>04310             <span class="comment">// for explosive</span>
<a name="l04311"></a>04311             ubPtsDmg = 0;
<a name="l04312"></a>04312       }
<a name="l04313"></a>04313       <span class="keywordflow">else</span>
<a name="l04314"></a>04314       {
<a name="l04315"></a>04315             <span class="comment">// normal mini grenade dmg</span>
<a name="l04316"></a>04316             ubPtsDmg = 0;
<a name="l04317"></a>04317       }
<a name="l04318"></a>04318 
<a name="l04319"></a>04319       <span class="comment">// injure the inventory character</span>
<a name="l04320"></a>04320       <a class="code" href="Soldier_01Control_8cpp.html#1f3b5961c7800928b7924f2488bfec1f">SoldierTakeDamage</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, 0, ubPtsDmg, ubPtsDmg, TAKE_DAMAGE_EXPLOSION, NOBODY, NOWHERE, 0, TRUE );
<a name="l04321"></a>04321 
<a name="l04322"></a>04322       <span class="comment">// play the sound</span>
<a name="l04323"></a>04323       <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b55e94c6ce5bff17fffb4d1dd636c34186">EXPLOSION_1</a>, RATE_11025, BTNVOLUME, 1, MIDDLEPAN );                  
<a name="l04324"></a>04324 
<a name="l04325"></a>04325 }
<a name="l04326"></a>04326 
<a name="l04327"></a>04327 
<a name="l04328"></a><a class="code" href="Handle_01Items_8cpp.html#6441e04860af54199d307f1f5031b38d">04328</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#6441e04860af54199d307f1f5031b38d">SetOffBoobyTrap</a>( <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> * pItemPool )
<a name="l04329"></a>04329 {
<a name="l04330"></a>04330       <span class="keywordflow">if</span> ( pItemPool )
<a name="l04331"></a>04331       {
<a name="l04332"></a>04332             <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sX, sY;
<a name="l04333"></a>04333             sX = <a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a> );
<a name="l04334"></a>04334             sY = <a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a> );
<a name="l04335"></a>04335             <a class="code" href="Explosion_01Control_8cpp.html#add4813e471ef668a64079af2ea8b36a">IgniteExplosion</a>( NOBODY, sX, sY, (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) (<a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a>].sHeight + pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#6487b22456a7a340fbfb15a2a257d454">bRenderZHeightAboveLevel</a>), pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a>, <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4fc6f5a7711dc97b72fc50dc538b4580a">MINI_GRENADE</a>, 0 );
<a name="l04336"></a>04336             <a class="code" href="Handle_01Items_8cpp.html#e60fbe0d27199e2f0c08121214fd7306">RemoveItemFromPool</a>( pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#ba2ac070ffc5f38b6b62b7d8038afff3">sGridNo</a>, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#d001579cc68909cba0f885510f2d242a">ubLevel</a> );
<a name="l04337"></a>04337       }
<a name="l04338"></a>04338 
<a name="l04339"></a>04339 }
<a name="l04340"></a>04340 
<a name="l04341"></a><a class="code" href="Handle_01Items_8cpp.html#91ef9b366fe4c09b75bfe1e16c3f63b5">04341</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#91ef9b366fe4c09b75bfe1e16c3f63b5">ContinuePastBoobyTrap</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bLevel, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iItemIndex, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fInStrategic, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> *pfSaidQuote )
<a name="l04342"></a>04342 {
<a name="l04343"></a>04343       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                             fBoobyTrapKnowledge;
<a name="l04344"></a>04344       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                                bTrapDifficulty, bTrapDetectLevel;
<a name="l04345"></a>04345       <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *            pObj;
<a name="l04346"></a>04346 
<a name="l04347"></a>04347       pObj = &amp;(<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iItemIndex ].<a class="code" href="structWORLDITEM.html#0f219e2d7aafd3aeca85991add1ef5f8">o</a>);
<a name="l04348"></a>04348 
<a name="l04349"></a>04349   (*pfSaidQuote) = FALSE;
<a name="l04350"></a>04350 
<a name="l04351"></a>04351       <span class="keywordflow">if</span> (pObj-&gt;<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a> &gt; 0)
<a name="l04352"></a>04352       {
<a name="l04353"></a>04353             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a>)
<a name="l04354"></a>04354             {
<a name="l04355"></a>04355                   <span class="comment">// does the player know about this item?</span>
<a name="l04356"></a>04356                   fBoobyTrapKnowledge = ((pObj-&gt;<a class="code" href="structOBJECTTYPE.html#0f1e67bac22f1b89c4040ef8a5ea48c2">fFlags</a> &amp; OBJECT_KNOWN_TO_BE_TRAPPED) &gt; 0);
<a name="l04357"></a>04357 
<a name="l04358"></a>04358                   <span class="comment">// blue flag stuff?</span>
<a name="l04359"></a>04359 
<a name="l04360"></a>04360                   <span class="keywordflow">if</span> (!fBoobyTrapKnowledge)
<a name="l04361"></a>04361                   {
<a name="l04362"></a>04362                         bTrapDifficulty = pObj-&gt;<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a>;
<a name="l04363"></a>04363                         bTrapDetectLevel = <a class="code" href="SkillCheck_8cpp.html#7f6623bad6276c85c17b252860879583">CalcTrapDetectLevel</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, FALSE );
<a name="l04364"></a>04364                         <span class="keywordflow">if</span> (bTrapDetectLevel &gt;= bTrapDifficulty)
<a name="l04365"></a>04365                         {
<a name="l04366"></a>04366                               <span class="comment">// spotted the trap!</span>
<a name="l04367"></a>04367                               pObj-&gt;<a class="code" href="structOBJECTTYPE.html#0f1e67bac22f1b89c4040ef8a5ea48c2">fFlags</a> |= OBJECT_KNOWN_TO_BE_TRAPPED;
<a name="l04368"></a>04368                               fBoobyTrapKnowledge = TRUE;
<a name="l04369"></a>04369 
<a name="l04370"></a>04370                               <span class="comment">// Make him warn us:</span>
<a name="l04371"></a>04371 
<a name="l04372"></a>04372                               <span class="comment">// Set things up..</span>
<a name="l04373"></a>04373                               <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l04374"></a>04374                               <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a> = <a class="code" href="Handle_01Items_8cpp.html#426a9cae81da45767082edae988d7d5e">GetItemPoolForIndex</a>( sGridNo, iItemIndex, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l04375"></a>04375                               <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a> = sGridNo;
<a name="l04376"></a>04376                           <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a>  = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>;
<a name="l04377"></a>04377                               <a class="code" href="Handle_01Items_8cpp.html#646730befce457ec377a2857d5ee5e90">gfDisarmingBuriedBomb</a> = FALSE;
<a name="l04378"></a>04378                               <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a> = bTrapDifficulty;
<a name="l04379"></a>04379 
<a name="l04380"></a>04380                               <span class="comment">// And make the call for the dialogue</span>
<a name="l04381"></a>04381                               <a class="code" href="Dialogue_01Control_8cpp.html#d6e34ed2e1392ad257900391bceec09c">SetStopTimeQuoteCallback</a>( <a class="code" href="Handle_01Items_8cpp.html#7604c764ed5d12231713e8204072346c">BoobyTrapDialogueCallBack</a> );
<a name="l04382"></a>04382                               <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a292262222af56ce76376cac0e6b567e571">QUOTE_BOOBYTRAP_ITEM</a> );
<a name="l04383"></a>04383 
<a name="l04384"></a>04384           (*pfSaidQuote) = TRUE;
<a name="l04385"></a>04385 
<a name="l04386"></a>04386                               <span class="keywordflow">return</span>( FALSE );
<a name="l04387"></a>04387                         }
<a name="l04388"></a>04388                   }
<a name="l04389"></a>04389 
<a name="l04390"></a>04390                   <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a> = <a class="code" href="Handle_01Items_8cpp.html#426a9cae81da45767082edae988d7d5e">GetItemPoolForIndex</a>( sGridNo, iItemIndex, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l04391"></a>04391                   <span class="keywordflow">if</span> (fBoobyTrapKnowledge)
<a name="l04392"></a>04392                   {
<a name="l04393"></a>04393                         <span class="comment">// have the computer ask us if we want to proceed</span>
<a name="l04394"></a>04394                         <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l04395"></a>04395                         <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a> = sGridNo;
<a name="l04396"></a>04396                         <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a>  = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>;
<a name="l04397"></a>04397                         <a class="code" href="Handle_01Items_8cpp.html#646730befce457ec377a2857d5ee5e90">gfDisarmingBuriedBomb</a> = FALSE;
<a name="l04398"></a>04398                         <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a> = pObj-&gt;<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a>;
<a name="l04399"></a>04399 
<a name="l04400"></a>04400                         <span class="keywordflow">if</span>( fInStrategic )
<a name="l04401"></a>04401                         {
<a name="l04402"></a>04402                               <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28edfaaee6cf60e9dcec27ec0650dbbc39f">MSG_BOX_BASIC_STYLE</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe71a4f43769cce587f5317e833f179abf8">DISARM_BOOBYTRAP_PROMPT</a> ], <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf26f9c31d9e3c6ef2f0d8e4917d387b871">MAP_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_YESNO, <a class="code" href="Handle_01Items_8cpp.html#f4498d4e49d6858e1f0636c8d35cf936">BoobyTrapInMapScreenMessageBoxCallBack</a>, NULL );
<a name="l04403"></a>04403                         }
<a name="l04404"></a>04404                         <span class="keywordflow">else</span>
<a name="l04405"></a>04405                         {
<a name="l04406"></a>04406                               <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28edfaaee6cf60e9dcec27ec0650dbbc39f">MSG_BOX_BASIC_STYLE</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe71a4f43769cce587f5317e833f179abf8">DISARM_BOOBYTRAP_PROMPT</a> ], <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf29873e16bc1530dedb416060abbeea6d0">GAME_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_YESNO, <a class="code" href="Handle_01Items_8cpp.html#e1d43de575fe0728997851c36c81644b">BoobyTrapMessageBoxCallBack</a>, NULL );
<a name="l04407"></a>04407                         }
<a name="l04408"></a>04408                   }
<a name="l04409"></a>04409                   <span class="keywordflow">else</span>
<a name="l04410"></a>04410                   {
<a name="l04411"></a>04411                         <span class="comment">// oops!</span>
<a name="l04412"></a>04412                         <a class="code" href="Handle_01Items_8cpp.html#6441e04860af54199d307f1f5031b38d">SetOffBoobyTrap</a>( <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a> );
<a name="l04413"></a>04413                   }
<a name="l04414"></a>04414 
<a name="l04415"></a>04415                   <span class="keywordflow">return</span>( FALSE );
<a name="l04416"></a>04416 
<a name="l04417"></a>04417             }
<a name="l04418"></a>04418             <span class="comment">// else, enemies etc always know about boobytraps and are not affected by them</span>
<a name="l04419"></a>04419       }
<a name="l04420"></a>04420 
<a name="l04421"></a>04421       <span class="keywordflow">return</span>( TRUE );
<a name="l04422"></a>04422 }
<a name="l04423"></a>04423 
<a name="l04424"></a><a class="code" href="Handle_01Items_8cpp.html#7604c764ed5d12231713e8204072346c">04424</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#7604c764ed5d12231713e8204072346c">BoobyTrapDialogueCallBack</a>( <span class="keywordtype">void</span> )
<a name="l04425"></a>04425 {
<a name="l04426"></a>04426       <a class="code" href="Handle_01Items_8cpp.html#b1635f6322fd155d731b899f5d3ee15d">gfJustFoundBoobyTrap</a> = TRUE;
<a name="l04427"></a>04427 
<a name="l04428"></a>04428       <span class="comment">// now prompt the user...</span>
<a name="l04429"></a>04429       <span class="keywordflow">if</span>( <a class="code" href="Interface_01Control_8cpp.html#13888453701b7175bfe2287212a0d666">guiTacticalInterfaceFlags</a> &amp; INTERFACE_MAPSCREEN )
<a name="l04430"></a>04430       {
<a name="l04431"></a>04431             <a class="code" href="MessageBoxScreen_8cpp.html#f480404e936544ddb29a371b785dc2f3">DoScreenIndependantMessageBox</a>( <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe71a4f43769cce587f5317e833f179abf8">DISARM_BOOBYTRAP_PROMPT</a> ],  ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_YESNO, <a class="code" href="Handle_01Items_8cpp.html#f4498d4e49d6858e1f0636c8d35cf936">BoobyTrapInMapScreenMessageBoxCallBack</a> );
<a name="l04432"></a>04432       }
<a name="l04433"></a>04433       <span class="keywordflow">else</span>
<a name="l04434"></a>04434       {
<a name="l04435"></a>04435             <a class="code" href="MessageBoxScreen_8cpp.html#f480404e936544ddb29a371b785dc2f3">DoScreenIndependantMessageBox</a>( <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe71a4f43769cce587f5317e833f179abf8">DISARM_BOOBYTRAP_PROMPT</a> ],  ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_YESNO, <a class="code" href="Handle_01Items_8cpp.html#e1d43de575fe0728997851c36c81644b">BoobyTrapMessageBoxCallBack</a> );
<a name="l04436"></a>04436       }
<a name="l04437"></a>04437 }
<a name="l04438"></a>04438 
<a name="l04439"></a><a class="code" href="Handle_01Items_8cpp.html#e1d43de575fe0728997851c36c81644b">04439</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#e1d43de575fe0728997851c36c81644b">BoobyTrapMessageBoxCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue )
<a name="l04440"></a>04440 {
<a name="l04441"></a>04441       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#b1635f6322fd155d731b899f5d3ee15d">gfJustFoundBoobyTrap</a> )
<a name="l04442"></a>04442       {
<a name="l04443"></a>04443             <span class="comment">// NOW award for finding boobytrap</span>
<a name="l04444"></a>04444             <span class="comment">// WISDOM GAIN:  Detected a booby-trap</span>
<a name="l04445"></a>04445             <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, WISDOMAMT, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (3 * <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a>), FALSE );
<a name="l04446"></a>04446             <span class="comment">// EXPLOSIVES GAIN:  Detected a booby-trap</span>
<a name="l04447"></a>04447             <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( gpBoobyTrapSoldier, EXPLODEAMT, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (3 * gbTrapDifficulty), FALSE );
<a name="l04448"></a>04448             <a class="code" href="Handle_01Items_8cpp.html#b1635f6322fd155d731b899f5d3ee15d">gfJustFoundBoobyTrap</a> = FALSE;
<a name="l04449"></a>04449       }
<a name="l04450"></a>04450 
<a name="l04451"></a>04451       <span class="keywordflow">if</span> (ubExitValue == MSG_BOX_RETURN_YES)
<a name="l04452"></a>04452       {
<a name="l04453"></a>04453             <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                               iCheckResult;
<a name="l04454"></a>04454             <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a>              Object;
<a name="l04455"></a>04455 
<a name="l04456"></a>04456 
<a name="l04457"></a>04457             <span class="comment">// get the item </span>
<a name="l04458"></a>04458             memcpy( &amp;Object, &amp;(<a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a>-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o), <span class="keyword">sizeof</span>( <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> ) );
<a name="l04459"></a>04459 
<a name="l04460"></a>04460             <span class="comment">// Snap: make it easier to disarm our own traps.</span>
<a name="l04461"></a>04461             <span class="comment">// If we succede - we get exp, but if we fail - we pay fair and square!</span>
<a name="l04462"></a>04462             
<a name="l04463"></a>04463             <span class="comment">// NB owner grossness... bombs 'owned' by the enemy are stored with side value 1 in </span>
<a name="l04464"></a>04464             <span class="comment">// the map. So if we want to detect a bomb placed by the player, owner is &gt; 1, and</span>
<a name="l04465"></a>04465             <span class="comment">// owner - 2 gives the ID of the character who planted it</span>
<a name="l04466"></a>04466             <span class="keywordflow">if</span> ( Object.<a class="code" href="structOBJECTTYPE.html#085f3d8acfbd4ec7448607c65054cc27">ubBombOwner</a> &gt; 1 &amp;&amp; ( (<a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>)Object.<a class="code" href="structOBJECTTYPE.html#085f3d8acfbd4ec7448607c65054cc27">ubBombOwner</a> - 2 &gt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ OUR_TEAM ].<a class="code" href="structTacticalTeamType.html#f8fe819ad07b242f5dbf97fd4c69b00d">bFirstID</a> &amp;&amp; Object.<a class="code" href="structOBJECTTYPE.html#085f3d8acfbd4ec7448607c65054cc27">ubBombOwner</a> - 2 &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ OUR_TEAM ].<a class="code" href="structTacticalTeamType.html#6a887279dad735dc302f21c1e559d5ce">bLastID</a> ) )
<a name="l04467"></a>04467             {
<a name="l04468"></a>04468                   <span class="keywordflow">if</span> ( Object.<a class="code" href="structOBJECTTYPE.html#085f3d8acfbd4ec7448607c65054cc27">ubBombOwner</a> - 2 == <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> )
<a name="l04469"></a>04469                   {
<a name="l04470"></a>04470                         <span class="comment">// my own boobytrap!</span>
<a name="l04471"></a>04471                         iCheckResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e41fa1bcc5c870a7ebfde254bdc841c716">DISARM_TRAP_CHECK</a>, 40 );
<a name="l04472"></a>04472                   }
<a name="l04473"></a>04473                   <span class="keywordflow">else</span>
<a name="l04474"></a>04474                   {
<a name="l04475"></a>04475                         <span class="comment">// our team's boobytrap!</span>
<a name="l04476"></a>04476                         iCheckResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e41fa1bcc5c870a7ebfde254bdc841c716">DISARM_TRAP_CHECK</a>, 20 );
<a name="l04477"></a>04477                   }
<a name="l04478"></a>04478             }
<a name="l04479"></a>04479             <span class="keywordflow">else</span>
<a name="l04480"></a>04480             {
<a name="l04481"></a>04481                   iCheckResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e41fa1bcc5c870a7ebfde254bdc841c716">DISARM_TRAP_CHECK</a>, 0 );
<a name="l04482"></a>04482             }
<a name="l04483"></a>04483             
<a name="l04484"></a>04484             <span class="keywordflow">if</span> (iCheckResult &gt;= 0)
<a name="l04485"></a>04485             {
<a name="l04486"></a>04486 
<a name="l04487"></a>04487                   <span class="keywordflow">if</span> ( Object.<a class="code" href="structOBJECTTYPE.html#085f3d8acfbd4ec7448607c65054cc27">ubBombOwner</a> &gt; 1 &amp;&amp; ( (<a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>)Object.<a class="code" href="structOBJECTTYPE.html#085f3d8acfbd4ec7448607c65054cc27">ubBombOwner</a> - 2 &gt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ OUR_TEAM ].<a class="code" href="structTacticalTeamType.html#f8fe819ad07b242f5dbf97fd4c69b00d">bFirstID</a> &amp;&amp; Object.<a class="code" href="structOBJECTTYPE.html#085f3d8acfbd4ec7448607c65054cc27">ubBombOwner</a> - 2 &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ OUR_TEAM ].<a class="code" href="structTacticalTeamType.html#6a887279dad735dc302f21c1e559d5ce">bLastID</a> ) )
<a name="l04488"></a>04488                   {
<a name="l04489"></a>04489                         <span class="keywordflow">if</span> ( Object.<a class="code" href="structOBJECTTYPE.html#085f3d8acfbd4ec7448607c65054cc27">ubBombOwner</a> - 2 == <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> )
<a name="l04490"></a>04490                         {
<a name="l04491"></a>04491                               <span class="comment">// disarmed my own boobytrap!</span>
<a name="l04492"></a>04492                               <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, EXPLODEAMT, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (2 * <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a>), FALSE );
<a name="l04493"></a>04493                         }
<a name="l04494"></a>04494                         <span class="keywordflow">else</span>
<a name="l04495"></a>04495                         {
<a name="l04496"></a>04496                               <span class="comment">// disarmed our team's boobytrap!</span>
<a name="l04497"></a>04497                               <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, EXPLODEAMT, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (4 * <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a>), FALSE );
<a name="l04498"></a>04498                         }
<a name="l04499"></a>04499                   }
<a name="l04500"></a>04500                   <span class="keywordflow">else</span>
<a name="l04501"></a>04501                   {
<a name="l04502"></a>04502                         <span class="comment">// disarmed a boobytrap!</span>
<a name="l04503"></a>04503                         <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, EXPLODEAMT, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (6 * <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a>), FALSE );
<a name="l04504"></a>04504                   }
<a name="l04505"></a>04505 
<a name="l04506"></a>04506                   <span class="comment">// have merc say this is good</span>
<a name="l04507"></a>04507                   <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0aeb62247b5212b82ddca160c00682284b">BATTLE_SOUND_COOL1</a> );
<a name="l04508"></a>04508 
<a name="l04509"></a>04509                   <span class="keywordflow">if</span> (<a class="code" href="Handle_01Items_8cpp.html#646730befce457ec377a2857d5ee5e90">gfDisarmingBuriedBomb</a>)
<a name="l04510"></a>04510                   {     
<a name="l04511"></a>04511                         <span class="keywordflow">if</span> (Object.<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f453396ea1193548270407675ea4eeee2b">SWITCH</a>)
<a name="l04512"></a>04512                         {
<a name="l04513"></a>04513                               <span class="comment">// give the player a remote trigger instead</span>
<a name="l04514"></a>04514                               <a class="code" href="Items_8cpp.html#153f1fcda178d6758ff8b01cf7999170">CreateItem</a>( <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4b846e6e70552ec7a47da51df9390e3fe">REMOTEBOMBTRIGGER</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (1 + <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 9 )), &amp;Object );
<a name="l04515"></a>04515                         }
<a name="l04516"></a>04516                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Object.<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4badb02dc80151403af1a50e2e767fc85">ACTION_ITEM</a> &amp;&amp; Object.<a class="code" href="structOBJECTTYPE.html#ce5a9b46852e6e766cf0aa06edd21686">bActionValue</a> != <a class="code" href="Action_01Items_8h.html#9ef42d46d391286f9a974d506984851627589689e509e1cf038a2238d73cb5e1">ACTION_ITEM_BLOW_UP</a> )
<a name="l04517"></a>04517                         {
<a name="l04518"></a>04518                               <span class="comment">// give the player a detonator instead</span>
<a name="l04519"></a>04519                               <a class="code" href="Items_8cpp.html#153f1fcda178d6758ff8b01cf7999170">CreateItem</a>( <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4ba6734731c29b0bd69902ceb58851127">DETONATOR</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (1 + <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 9 )), &amp;Object );
<a name="l04520"></a>04520                         }
<a name="l04521"></a>04521                         <span class="keywordflow">else</span>
<a name="l04522"></a>04522                         {
<a name="l04523"></a>04523                               <span class="comment">// switch action item to the real item type</span>
<a name="l04524"></a>04524                               <a class="code" href="Items_8cpp.html#153f1fcda178d6758ff8b01cf7999170">CreateItem</a>( Object.<a class="code" href="structOBJECTTYPE.html#2e413d8bd27447371be211e3fc0d738d">usBombItem</a>, Object.<a class="code" href="structOBJECTTYPE.html#29adc458070eb799434506d3e3764964">bBombStatus</a>, &amp;Object );
<a name="l04525"></a>04525                         }
<a name="l04526"></a>04526 
<a name="l04527"></a>04527                         <span class="comment">// remove any blue flag graphic</span>
<a name="l04528"></a>04528                         <a class="code" href="Handle_01Items_8cpp.html#fdc539137255b9943133ba42a805258a">RemoveBlueFlag</a>( <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a>, <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a> );
<a name="l04529"></a>04529                   }
<a name="l04530"></a>04530                   <span class="keywordflow">else</span>
<a name="l04531"></a>04531                   {
<a name="l04532"></a>04532                         Object.<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a> = 0;
<a name="l04533"></a>04533                         Object.<a class="code" href="structOBJECTTYPE.html#0f1e67bac22f1b89c4040ef8a5ea48c2">fFlags</a> &amp;= ~( OBJECT_KNOWN_TO_BE_TRAPPED );
<a name="l04534"></a>04534                   }
<a name="l04535"></a>04535 
<a name="l04536"></a>04536                   <span class="comment">// place it in the guy's inventory/cursor</span>
<a name="l04537"></a>04537                   <span class="keywordflow">if</span> ( <a class="code" href="Items_8cpp.html#b0cdccd7f510d5464ab386cb5b69c28f">AutoPlaceObject</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, &amp;Object, TRUE ) )
<a name="l04538"></a>04538                   {
<a name="l04539"></a>04539                         <span class="comment">// remove it from the ground</span>
<a name="l04540"></a>04540                         <a class="code" href="Handle_01Items_8cpp.html#e60fbe0d27199e2f0c08121214fd7306">RemoveItemFromPool</a>( <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a>, <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a>-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a> );
<a name="l04541"></a>04541                   }
<a name="l04542"></a>04542                   <span class="keywordflow">else</span>
<a name="l04543"></a>04543                   {
<a name="l04544"></a>04544                         <span class="comment">// make sure the item in the world is untrapped</span>
<a name="l04545"></a>04545                         <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a>-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].<a class="code" href="structWORLDITEM.html#0f219e2d7aafd3aeca85991add1ef5f8">o</a>.<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a> = 0;
<a name="l04546"></a>04546                         <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a>-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].<a class="code" href="structWORLDITEM.html#0f219e2d7aafd3aeca85991add1ef5f8">o</a>.<a class="code" href="structOBJECTTYPE.html#0f1e67bac22f1b89c4040ef8a5ea48c2">fFlags</a> &amp;= ~( OBJECT_KNOWN_TO_BE_TRAPPED );
<a name="l04547"></a>04547 
<a name="l04548"></a>04548                         <span class="comment">// ATE; If we failed to add to inventory, put failed one in our cursor...</span>
<a name="l04549"></a>04549                         <a class="code" href="Handle_01Items_8cpp.html#b2107f877c6241f423b9c1c443966fbe">gfDontChargeAPsToPickup</a> = TRUE;
<a name="l04550"></a>04550                         <a class="code" href="Handle_01Items_8cpp.html#76744989c52d69147a41eb8690e8d8a7">HandleAutoPlaceFail</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a>-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a> );
<a name="l04551"></a>04551                         <a class="code" href="Handle_01Items_8cpp.html#e60fbe0d27199e2f0c08121214fd7306">RemoveItemFromPool</a>( <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a>, <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a>-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a> );
<a name="l04552"></a>04552                   }
<a name="l04553"></a>04553             }
<a name="l04554"></a>04554             <span class="keywordflow">else</span>
<a name="l04555"></a>04555             {
<a name="l04556"></a>04556                   <span class="comment">// oops! trap goes off</span>
<a name="l04557"></a>04557       <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, EXPLODEAMT, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (3 * <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a> ), FROM_FAILURE );
<a name="l04558"></a>04558 
<a name="l04559"></a>04559                   <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0aa5a3b5d825d15837f5c41acc1031f4b0">BATTLE_SOUND_CURSE1</a> );
<a name="l04560"></a>04560 
<a name="l04561"></a>04561                   <span class="keywordflow">if</span> (<a class="code" href="Handle_01Items_8cpp.html#646730befce457ec377a2857d5ee5e90">gfDisarmingBuriedBomb</a>)
<a name="l04562"></a>04562                   {
<a name="l04563"></a>04563                         <a class="code" href="Explosion_01Control_8cpp.html#38bdad72f3eb31bbccf55bc55205497c">SetOffBombsInGridNo</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>, <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a>, TRUE, <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a> );
<a name="l04564"></a>04564                   }
<a name="l04565"></a>04565                   <span class="keywordflow">else</span>
<a name="l04566"></a>04566                   {
<a name="l04567"></a>04567                         <a class="code" href="Handle_01Items_8cpp.html#6441e04860af54199d307f1f5031b38d">SetOffBoobyTrap</a>( <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a> );
<a name="l04568"></a>04568                   }
<a name="l04569"></a>04569             }
<a name="l04570"></a>04570       }
<a name="l04571"></a>04571       <span class="keywordflow">else</span>
<a name="l04572"></a>04572       {
<a name="l04573"></a>04573             <span class="keywordflow">if</span> (<a class="code" href="Handle_01Items_8cpp.html#646730befce457ec377a2857d5ee5e90">gfDisarmingBuriedBomb</a>)
<a name="l04574"></a>04574             {
<a name="l04575"></a>04575                   <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28edfaaee6cf60e9dcec27ec0650dbbc39f">MSG_BOX_BASIC_STYLE</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe781bc39f7c80579f9fad750b91f344668">REMOVE_BLUE_FLAG_PROMPT</a> ], <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf29873e16bc1530dedb416060abbeea6d0">GAME_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_YESNO, <a class="code" href="Handle_01Items_8cpp.html#6dc7fb5abedf9373075875a601964bfe">RemoveBlueFlagDialogueCallBack</a>, NULL );
<a name="l04576"></a>04576             }
<a name="l04577"></a>04577             <span class="comment">// otherwise do nothing</span>
<a name="l04578"></a>04578       }
<a name="l04579"></a>04579 }
<a name="l04580"></a>04580 
<a name="l04581"></a><a class="code" href="Handle_01Items_8cpp.html#f4498d4e49d6858e1f0636c8d35cf936">04581</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#f4498d4e49d6858e1f0636c8d35cf936">BoobyTrapInMapScreenMessageBoxCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue )
<a name="l04582"></a>04582 {
<a name="l04583"></a>04583       <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#b1635f6322fd155d731b899f5d3ee15d">gfJustFoundBoobyTrap</a> )
<a name="l04584"></a>04584       {
<a name="l04585"></a>04585             <span class="comment">// NOW award for finding boobytrap</span>
<a name="l04586"></a>04586 
<a name="l04587"></a>04587             <span class="comment">// WISDOM GAIN:  Detected a booby-trap</span>
<a name="l04588"></a>04588             <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, WISDOMAMT, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (3 * <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a>), FALSE );
<a name="l04589"></a>04589             <span class="comment">// EXPLOSIVES GAIN:  Detected a booby-trap</span>
<a name="l04590"></a>04590             <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( gpBoobyTrapSoldier, EXPLODEAMT, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (3 * gbTrapDifficulty), FALSE );
<a name="l04591"></a>04591             <a class="code" href="Handle_01Items_8cpp.html#b1635f6322fd155d731b899f5d3ee15d">gfJustFoundBoobyTrap</a> = FALSE;
<a name="l04592"></a>04592       }
<a name="l04593"></a>04593 
<a name="l04594"></a>04594       <span class="keywordflow">if</span> (ubExitValue == MSG_BOX_RETURN_YES)
<a name="l04595"></a>04595       {
<a name="l04596"></a>04596             <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                               iCheckResult;
<a name="l04597"></a>04597             <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a>              Object;
<a name="l04598"></a>04598 
<a name="l04599"></a>04599             iCheckResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e41fa1bcc5c870a7ebfde254bdc841c716">DISARM_TRAP_CHECK</a>, 0 );
<a name="l04600"></a>04600 
<a name="l04601"></a>04601             <span class="keywordflow">if</span> (iCheckResult &gt;= 0)
<a name="l04602"></a>04602             {
<a name="l04603"></a>04603                   <span class="comment">// disarmed a boobytrap!</span>
<a name="l04604"></a>04604       <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, EXPLODEAMT, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (6 * <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a>), FALSE );
<a name="l04605"></a>04605 
<a name="l04606"></a>04606 
<a name="l04607"></a>04607                   <span class="comment">// have merc say this is good</span>
<a name="l04608"></a>04608                   <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0aeb62247b5212b82ddca160c00682284b">BATTLE_SOUND_COOL1</a> );
<a name="l04609"></a>04609 
<a name="l04610"></a>04610                   <span class="comment">// get the item </span>
<a name="l04611"></a>04611                   memcpy( &amp;Object, <a class="code" href="Map_01Screen_01Interface_01Map_01Inventory_8cpp.html#a338c4e51d4834e0388d319683afe422">gpItemPointer</a>, <span class="keyword">sizeof</span>( <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> ) );
<a name="l04612"></a>04612 
<a name="l04613"></a>04613                   <span class="keywordflow">if</span> (<a class="code" href="Handle_01Items_8cpp.html#646730befce457ec377a2857d5ee5e90">gfDisarmingBuriedBomb</a>)
<a name="l04614"></a>04614                   {     
<a name="l04615"></a>04615                         <span class="keywordflow">if</span> (Object.<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f453396ea1193548270407675ea4eeee2b">SWITCH</a>)
<a name="l04616"></a>04616                         {
<a name="l04617"></a>04617                               <span class="comment">// give the player a remote trigger instead</span>
<a name="l04618"></a>04618                               <a class="code" href="Items_8cpp.html#153f1fcda178d6758ff8b01cf7999170">CreateItem</a>( <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4b846e6e70552ec7a47da51df9390e3fe">REMOTEBOMBTRIGGER</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (1 + <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 9 )), &amp;Object );
<a name="l04619"></a>04619                         }
<a name="l04620"></a>04620                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Object.<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a> == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4badb02dc80151403af1a50e2e767fc85">ACTION_ITEM</a> &amp;&amp; Object.<a class="code" href="structOBJECTTYPE.html#ce5a9b46852e6e766cf0aa06edd21686">bActionValue</a> != <a class="code" href="Action_01Items_8h.html#9ef42d46d391286f9a974d506984851627589689e509e1cf038a2238d73cb5e1">ACTION_ITEM_BLOW_UP</a> )
<a name="l04621"></a>04621                         {
<a name="l04622"></a>04622                               <span class="comment">// give the player a detonator instead</span>
<a name="l04623"></a>04623                               <a class="code" href="Items_8cpp.html#153f1fcda178d6758ff8b01cf7999170">CreateItem</a>( <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4ba6734731c29b0bd69902ceb58851127">DETONATOR</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (1 + <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 9 )), &amp;Object );
<a name="l04624"></a>04624                         }
<a name="l04625"></a>04625                         <span class="keywordflow">else</span>
<a name="l04626"></a>04626                         {
<a name="l04627"></a>04627                               <span class="comment">// switch action item to the real item type</span>
<a name="l04628"></a>04628                               <a class="code" href="Items_8cpp.html#153f1fcda178d6758ff8b01cf7999170">CreateItem</a>( Object.<a class="code" href="structOBJECTTYPE.html#2e413d8bd27447371be211e3fc0d738d">usBombItem</a>, Object.<a class="code" href="structOBJECTTYPE.html#29adc458070eb799434506d3e3764964">bBombStatus</a>, &amp;Object );
<a name="l04629"></a>04629                         }
<a name="l04630"></a>04630                   }
<a name="l04631"></a>04631                   <span class="keywordflow">else</span>
<a name="l04632"></a>04632                   {
<a name="l04633"></a>04633                         Object.<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a> = 0;
<a name="l04634"></a>04634                         Object.<a class="code" href="structOBJECTTYPE.html#0f1e67bac22f1b89c4040ef8a5ea48c2">fFlags</a> &amp;= ~( OBJECT_KNOWN_TO_BE_TRAPPED );
<a name="l04635"></a>04635                   }
<a name="l04636"></a>04636 
<a name="l04637"></a>04637                   <a class="code" href="Map_01Screen_01Interface_01Map_01Inventory_8cpp.html#addaead2158d7ab84c664c17506ffcee">MAPEndItemPointer</a>( );
<a name="l04638"></a>04638 
<a name="l04639"></a>04639                   <span class="comment">// place it in the guy's inventory/cursor</span>
<a name="l04640"></a>04640                   <span class="keywordflow">if</span> ( !<a class="code" href="Items_8cpp.html#b0cdccd7f510d5464ab386cb5b69c28f">AutoPlaceObject</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, &amp;Object, TRUE ) )
<a name="l04641"></a>04641                   {
<a name="l04642"></a>04642                         <a class="code" href="Map_01Screen_01Interface_01Map_01Inventory_8cpp.html#324d24d7621670bd5312b21bc46308a7">AutoPlaceObjectInInventoryStash</a>( &amp;Object );
<a name="l04643"></a>04643                   }
<a name="l04644"></a>04644 
<a name="l04645"></a>04645                   <a class="code" href="Map_01Screen_01Interface_01Map_01Inventory_8cpp.html#bf76cd88cbce9c07321f7bcf2b23e977">HandleButtonStatesWhileMapInventoryActive</a>( );
<a name="l04646"></a>04646             }
<a name="l04647"></a>04647             <span class="keywordflow">else</span>
<a name="l04648"></a>04648             {
<a name="l04649"></a>04649                   <span class="comment">// oops! trap goes off</span>
<a name="l04650"></a>04650       <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, EXPLODEAMT, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (3 * <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a> ), FROM_FAILURE );
<a name="l04651"></a>04651 
<a name="l04652"></a>04652                   <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0aa5a3b5d825d15837f5c41acc1031f4b0">BATTLE_SOUND_CURSE1</a> );
<a name="l04653"></a>04653                   
<a name="l04654"></a>04654                   <span class="keywordflow">if</span> (<a class="code" href="Handle_01Items_8cpp.html#646730befce457ec377a2857d5ee5e90">gfDisarmingBuriedBomb</a>)
<a name="l04655"></a>04655                   {
<a name="l04656"></a>04656                         <a class="code" href="Explosion_01Control_8cpp.html#38bdad72f3eb31bbccf55bc55205497c">SetOffBombsInGridNo</a>( <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>, <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a>, TRUE, <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a> );
<a name="l04657"></a>04657                   }
<a name="l04658"></a>04658                   <span class="keywordflow">else</span>
<a name="l04659"></a>04659                   {
<a name="l04660"></a>04660                         <a class="code" href="Handle_01Items_8cpp.html#6441e04860af54199d307f1f5031b38d">SetOffBoobyTrap</a>( <a class="code" href="Handle_01Items_8cpp.html#b1ab884a3c749dce3842e0c91c174a6e">gpBoobyTrapItemPool</a> );
<a name="l04661"></a>04661                   }
<a name="l04662"></a>04662             }
<a name="l04663"></a>04663       }
<a name="l04664"></a>04664       <span class="keywordflow">else</span>
<a name="l04665"></a>04665       {
<a name="l04666"></a>04666             <span class="keywordflow">if</span> (<a class="code" href="Handle_01Items_8cpp.html#646730befce457ec377a2857d5ee5e90">gfDisarmingBuriedBomb</a>)
<a name="l04667"></a>04667             {
<a name="l04668"></a>04668                   <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28edfaaee6cf60e9dcec27ec0650dbbc39f">MSG_BOX_BASIC_STYLE</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe781bc39f7c80579f9fad750b91f344668">REMOVE_BLUE_FLAG_PROMPT</a> ], <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf29873e16bc1530dedb416060abbeea6d0">GAME_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_YESNO, <a class="code" href="Handle_01Items_8cpp.html#6dc7fb5abedf9373075875a601964bfe">RemoveBlueFlagDialogueCallBack</a>, NULL );
<a name="l04669"></a>04669             }
<a name="l04670"></a>04670             <span class="comment">// otherwise do nothing</span>
<a name="l04671"></a>04671       }
<a name="l04672"></a>04672 }
<a name="l04673"></a>04673 
<a name="l04674"></a>04674 
<a name="l04675"></a>04675 
<a name="l04676"></a><a class="code" href="Handle_01Items_8cpp.html#ee52aafb872bfd335e0c54fedaa2e128">04676</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#ee52aafb872bfd335e0c54fedaa2e128">SwitchMessageBoxCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue )
<a name="l04677"></a>04677 {
<a name="l04678"></a>04678       <span class="keywordflow">if</span> ( ubExitValue == MSG_BOX_RETURN_YES )
<a name="l04679"></a>04679       {
<a name="l04680"></a>04680     <span class="comment">// Message that switch is activated...</span>
<a name="l04681"></a>04681             <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#c5c7f48843bbaeab7848215f323578c9">gzLateLocalizedString</a>[ 60 ] );            
<a name="l04682"></a>04682 
<a name="l04683"></a>04683             <a class="code" href="Explosion_01Control_8cpp.html#466b8c5a726dc0f74645c6717b2a938e">SetOffBombsByFrequency</a>( <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>,  <a class="code" href="Handle_01Items_8cpp.html#57d4fe8bcf106c822f1ac63008a4f28d">bTempFrequency</a> );
<a name="l04684"></a>04684       }
<a name="l04685"></a>04685 }
<a name="l04686"></a>04686 
<a name="l04687"></a><a class="code" href="Handle_01Items_8h.html#310f580f422be66dbece7e0dfe55ec38">04687</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#310f580f422be66dbece7e0dfe55ec38">NearbyGroundSeemsWrong</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fCheckAroundGridno, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> * psProblemGridNo )
<a name="l04688"></a>04688 {
<a name="l04689"></a>04689       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                               sNextGridNo;
<a name="l04690"></a>04690       <span class="comment">// BOOLEAN fWorthChecking = FALSE, fProblemExists = FALSE, fDetectedProblem = FALSE;</span>
<a name="l04691"></a>04691       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                               ubDetectLevel, ubDirection;
<a name="l04692"></a>04692       <a class="code" href="structMAP__ELEMENT.html">MAP_ELEMENT</a> *           pMapElement;
<a name="l04693"></a>04693       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>                              fCheckFlag;
<a name="l04694"></a>04694       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>                              uiWorldBombIndex;
<a name="l04695"></a>04695       <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *            pObj;
<a name="l04696"></a>04696       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                             fMining, fFoundMetal = FALSE;
<a name="l04697"></a>04697 <span class="comment">//    ITEM_POOL *             pItemPool;</span>
<a name="l04698"></a>04698       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                               ubMovementCost;
<a name="l04699"></a>04699 
<a name="l04700"></a>04700       ubDetectLevel = 0;
<a name="l04701"></a>04701 
<a name="l04702"></a>04702       <span class="keywordflow">if</span> (  <a class="code" href="Items_8cpp.html#23f90afe1e04c475cfe2b526dd59f4b9">FindMetalDetector</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ) != NO_SLOT )
<a name="l04703"></a>04703       {
<a name="l04704"></a>04704             fMining = TRUE;
<a name="l04705"></a>04705       }
<a name="l04706"></a>04706       <span class="keywordflow">else</span>
<a name="l04707"></a>04707       {
<a name="l04708"></a>04708             fMining = FALSE;
<a name="l04709"></a>04709 
<a name="l04710"></a>04710             ubDetectLevel = <a class="code" href="SkillCheck_8cpp.html#7f6623bad6276c85c17b252860879583">CalcTrapDetectLevel</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, FALSE );
<a name="l04711"></a>04711             <span class="comment">/*</span>
<a name="l04712"></a>04712 <span class="comment">            if (pSoldier-&gt;bStealthMode)</span>
<a name="l04713"></a>04713 <span class="comment">            {</span>
<a name="l04714"></a>04714 <span class="comment">                  ubDetectLevel++;</span>
<a name="l04715"></a>04715 <span class="comment">            }</span>
<a name="l04716"></a>04716 <span class="comment">            switch (pSoldier-&gt;usAnimState)</span>
<a name="l04717"></a>04717 <span class="comment">            {</span>
<a name="l04718"></a>04718 <span class="comment">                  case CRAWLING:</span>
<a name="l04719"></a>04719 <span class="comment">                        ubDetectLevel += 2;</span>
<a name="l04720"></a>04720 <span class="comment">                        break;</span>
<a name="l04721"></a>04721 <span class="comment"></span>
<a name="l04722"></a>04722 <span class="comment">                  case SWATTING:</span>
<a name="l04723"></a>04723 <span class="comment">                        ubDetectLevel++;</span>
<a name="l04724"></a>04724 <span class="comment">                        break;</span>
<a name="l04725"></a>04725 <span class="comment"></span>
<a name="l04726"></a>04726 <span class="comment">                  default:</span>
<a name="l04727"></a>04727 <span class="comment">                        break;</span>
<a name="l04728"></a>04728 <span class="comment">            }</span>
<a name="l04729"></a>04729 <span class="comment">            */</span>
<a name="l04730"></a>04730       }
<a name="l04731"></a>04731 
<a name="l04732"></a>04732       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1e61c0006bacccf9457c3f6c43607578">bSide</a> == 0)
<a name="l04733"></a>04733       {
<a name="l04734"></a>04734             fCheckFlag = MAPELEMENT_PLAYER_MINE_PRESENT;
<a name="l04735"></a>04735       }
<a name="l04736"></a>04736       <span class="keywordflow">else</span>
<a name="l04737"></a>04737       {
<a name="l04738"></a>04738             fCheckFlag = MAPELEMENT_ENEMY_MINE_PRESENT;
<a name="l04739"></a>04739       }
<a name="l04740"></a>04740 
<a name="l04741"></a>04741       <span class="comment">// check every tile around gridno for the presence of "nasty stuff"</span>
<a name="l04742"></a>04742       <span class="keywordflow">for</span> (ubDirection = 0; ubDirection &lt; 8; ubDirection++)
<a name="l04743"></a>04743       {
<a name="l04744"></a>04744             <span class="keywordflow">if</span> ( fCheckAroundGridno )
<a name="l04745"></a>04745             {
<a name="l04746"></a>04746                   <span class="comment">// get the gridno of the next spot adjacent to lastGridno in that direction</span>
<a name="l04747"></a>04747                   sNextGridNo = <a class="code" href="Isometric_01Utils_8cpp.html#318d8410127e29bb232ab70363bc316e">NewGridNo</a>( sGridNo, (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) <a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) ubDirection ) );
<a name="l04748"></a>04748 
<a name="l04749"></a>04749                   <span class="comment">// don't check directions that are impassable!</span>
<a name="l04750"></a>04750                   ubMovementCost = <a class="code" href="worlddef_8cpp.html#4dc0cb4bdda24d948e2aa986389414aa">gubWorldMovementCosts</a>[ sNextGridNo ][ ubDirection ][ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> ];
<a name="l04751"></a>04751                   <span class="keywordflow">if</span> ( IS_TRAVELCOST_DOOR( ubMovementCost ) )
<a name="l04752"></a>04752                   {
<a name="l04753"></a>04753                         ubMovementCost = <a class="code" href="PATHAI_8cpp.html#1c8b5d7ed922dd1625a391785ef4e010">DoorTravelCost</a>( NULL, sNextGridNo, ubMovementCost, FALSE, NULL );
<a name="l04754"></a>04754                   }
<a name="l04755"></a>04755                   <span class="keywordflow">if</span> ( ubMovementCost &gt;= TRAVELCOST_BLOCKED)
<a name="l04756"></a>04756                   {
<a name="l04757"></a>04757                         <span class="keywordflow">continue</span>;
<a name="l04758"></a>04758                   }
<a name="l04759"></a>04759             }
<a name="l04760"></a>04760             <span class="keywordflow">else</span>
<a name="l04761"></a>04761             {
<a name="l04762"></a>04762                   <span class="comment">// we should just be checking the gridno </span>
<a name="l04763"></a>04763                   sNextGridNo = sGridNo;
<a name="l04764"></a>04764                   ubDirection = 8; <span class="comment">// don't loop</span>
<a name="l04765"></a>04765             }
<a name="l04766"></a>04766 
<a name="l04767"></a>04767             <span class="comment">// if this sNextGridNo isn't out of bounds... but it never can be</span>
<a name="l04768"></a>04768             pMapElement = &amp;(<a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[sNextGridNo]);
<a name="l04769"></a>04769       
<a name="l04770"></a>04770             <span class="keywordflow">if</span> (pMapElement-&gt;<a class="code" href="structMAP__ELEMENT.html#430f12029207b5bb7b32ed30ef355253">uiFlags</a> &amp; fCheckFlag)
<a name="l04771"></a>04771             {
<a name="l04772"></a>04772                   <span class="comment">// already know there's a mine there</span>
<a name="l04773"></a>04773                   <span class="keywordflow">continue</span>;
<a name="l04774"></a>04774             }
<a name="l04775"></a>04775 
<a name="l04776"></a>04776             <span class="comment">// check for boobytraps</span>
<a name="l04777"></a>04777             <span class="keywordflow">for</span> (uiWorldBombIndex = 0; uiWorldBombIndex &lt; <a class="code" href="World_01Items_8cpp.html#f7920b4813d6b2d375dfc0d56dcf8d95">guiNumWorldBombs</a>; uiWorldBombIndex++)
<a name="l04778"></a>04778             {
<a name="l04779"></a>04779                   <span class="keywordflow">if</span> (<a class="code" href="World_01Items_8cpp.html#c07b19b92a496114511f36bdf7d35813">gWorldBombs</a>[uiWorldBombIndex].fExists &amp;&amp; <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ <a class="code" href="World_01Items_8cpp.html#c07b19b92a496114511f36bdf7d35813">gWorldBombs</a>[uiWorldBombIndex].iItemIndex ].sGridNo == sNextGridNo)
<a name="l04780"></a>04780                   {
<a name="l04781"></a>04781                         pObj = &amp;( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ <a class="code" href="World_01Items_8cpp.html#c07b19b92a496114511f36bdf7d35813">gWorldBombs</a>[uiWorldBombIndex].iItemIndex ].o );
<a name="l04782"></a>04782                         <span class="keywordflow">if</span> ( pObj-&gt;<a class="code" href="structOBJECTTYPE.html#11538e133e999113e56a505515d9804f">bDetonatorType</a> == <a class="code" href="Item_01Types_8h.html#6fc932f93bf4d61f06ab663a79191395ba0d1790ae9b9f536df6b3998e9390b9">BOMB_PRESSURE</a> &amp;&amp; !(pObj-&gt;<a class="code" href="structOBJECTTYPE.html#0f1e67bac22f1b89c4040ef8a5ea48c2">fFlags</a> &amp; OBJECT_KNOWN_TO_BE_TRAPPED) &amp;&amp; (!(pObj-&gt;<a class="code" href="structOBJECTTYPE.html#0f1e67bac22f1b89c4040ef8a5ea48c2">fFlags</a> &amp; OBJECT_DISABLED_BOMB)) )
<a name="l04783"></a>04783                         {
<a name="l04784"></a>04784                               <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( fMining &amp;&amp; pObj-&gt;<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a> &lt;= 10 )
<a name="l04785"></a>04785                               {
<a name="l04786"></a>04786                                     <span class="comment">// add blue flag</span>
<a name="l04787"></a>04787                                     <a class="code" href="Handle_01Items_8cpp.html#98014335a350539627e4af7be10c7565">AddBlueFlag</a>( sNextGridNo, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l04788"></a>04788                                     fFoundMetal = TRUE;
<a name="l04789"></a>04789                                     <span class="keywordflow">break</span>;
<a name="l04790"></a>04790                               }
<a name="l04791"></a>04791                               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ubDetectLevel &gt;= pObj-&gt;<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a>)
<a name="l04792"></a>04792                               {
<a name="l04793"></a>04793                                     <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#eb633099940bc20ff5a969bce84eab42">uiStatusFlags</a> &amp; SOLDIER_PC )
<a name="l04794"></a>04794                                     {
<a name="l04795"></a>04795                               <span class="comment">// detected exposives buried nearby...</span>
<a name="l04796"></a>04796                                           <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, EXPLODEAMT, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (pObj-&gt;<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a>), FALSE );
<a name="l04797"></a>04797                                           <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( pSoldier, WISDOMAMT, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (pObj-&gt;<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a>), FALSE );
<a name="l04798"></a>04798 
<a name="l04799"></a>04799                                           <span class="comment">// set item as known</span>
<a name="l04800"></a>04800                                           pObj-&gt;<a class="code" href="structOBJECTTYPE.html#0f1e67bac22f1b89c4040ef8a5ea48c2">fFlags</a> |= OBJECT_KNOWN_TO_BE_TRAPPED;
<a name="l04801"></a>04801                                     }
<a name="l04802"></a>04802 
<a name="l04803"></a>04803                                     *psProblemGridNo = sNextGridNo;
<a name="l04804"></a>04804                                     <span class="keywordflow">return</span>( TRUE );
<a name="l04805"></a>04805                               }
<a name="l04806"></a>04806                         }
<a name="l04807"></a>04807                   }
<a name="l04808"></a>04808             }
<a name="l04809"></a>04809 
<a name="l04810"></a>04810             <span class="comment">/*</span>
<a name="l04811"></a>04811 <span class="comment">            // also check for metal items if using a metal detector</span>
<a name="l04812"></a>04812 <span class="comment">            if (fMining)</span>
<a name="l04813"></a>04813 <span class="comment">            {</span>
<a name="l04814"></a>04814 <span class="comment">                  // add blue flags where we find metallic objects hidden</span>
<a name="l04815"></a>04815 <span class="comment">                  GetItemPool( sNextGridNo, &amp;pItemPool, pSoldier-&gt;bLevel );</span>
<a name="l04816"></a>04816 <span class="comment">                  while( pItemPool )</span>
<a name="l04817"></a>04817 <span class="comment">                  {</span>
<a name="l04818"></a>04818 <span class="comment">                        if ( pItemPool-&gt;bVisible == BURIED || (pItemPool-&gt;bVisible != TRUE &amp;&amp; gWorldItems[ pItemPool-&gt;iItemIndex ].o.bTrap &gt; 0 ) )</span>
<a name="l04819"></a>04819 <span class="comment">                        {</span>
<a name="l04820"></a>04820 <span class="comment">                              pObj = &amp;( gWorldItems[ pItemPool-&gt;iItemIndex ].o );</span>
<a name="l04821"></a>04821 <span class="comment">                              if ( pObj-&gt;usItem == ACTION_ITEM &amp;&amp; pObj-&gt; )</span>
<a name="l04822"></a>04822 <span class="comment">                              {</span>
<a name="l04823"></a>04823 <span class="comment">                                    switch( pObj-&gt;bActionValue )</span>
<a name="l04824"></a>04824 <span class="comment">                                    {</span>
<a name="l04825"></a>04825 <span class="comment">                                          case ACTION_ITEM_BLOW_UP:</span>
<a name="l04826"></a>04826 <span class="comment">                                          case ACTION_ITEM_LOCAL_ALARM:</span>
<a name="l04827"></a>04827 <span class="comment">                                          case ACTION_ITEM_GLOBAL_ALARM:</span>
<a name="l04828"></a>04828 <span class="comment">                                                // add blue flag</span>
<a name="l04829"></a>04829 <span class="comment">                                                AddBlueFlag( sNextGridNo, pSoldier-&gt;bLevel );</span>
<a name="l04830"></a>04830 <span class="comment">                                                fFoundMetal = TRUE;</span>
<a name="l04831"></a>04831 <span class="comment">                                                break;</span>
<a name="l04832"></a>04832 <span class="comment">                                          default:</span>
<a name="l04833"></a>04833 <span class="comment">                                                break;</span>
<a name="l04834"></a>04834 <span class="comment"></span>
<a name="l04835"></a>04835 <span class="comment">                                    }</span>
<a name="l04836"></a>04836 <span class="comment">                              }</span>
<a name="l04837"></a>04837 <span class="comment">                              else if (Item[ pObj-&gt;usItem ].fFlags &amp; ITEM_METAL)</span>
<a name="l04838"></a>04838 <span class="comment">                              {</span>
<a name="l04839"></a>04839 <span class="comment">                                    // add blue flag</span>
<a name="l04840"></a>04840 <span class="comment">                                    AddBlueFlag( sNextGridNo, pSoldier-&gt;bLevel );</span>
<a name="l04841"></a>04841 <span class="comment">                                    fFoundMetal = TRUE;</span>
<a name="l04842"></a>04842 <span class="comment">                                    break;</span>
<a name="l04843"></a>04843 <span class="comment">                              }</span>
<a name="l04844"></a>04844 <span class="comment">                        }</span>
<a name="l04845"></a>04845 <span class="comment">                        pItemPool = pItemPool-&gt;pNext;</span>
<a name="l04846"></a>04846 <span class="comment">                  }</span>
<a name="l04847"></a>04847 <span class="comment">            }</span>
<a name="l04848"></a>04848 <span class="comment">            */</span>
<a name="l04849"></a>04849 
<a name="l04850"></a>04850       }
<a name="l04851"></a>04851 
<a name="l04852"></a>04852       *psProblemGridNo = NOWHERE;
<a name="l04853"></a>04853       <span class="keywordflow">if</span> (fFoundMetal)
<a name="l04854"></a>04854       {
<a name="l04855"></a>04855             <span class="keywordflow">return</span>( TRUE );
<a name="l04856"></a>04856       }
<a name="l04857"></a>04857       <span class="keywordflow">else</span>
<a name="l04858"></a>04858       {
<a name="l04859"></a>04859             <span class="keywordflow">return</span>( FALSE );
<a name="l04860"></a>04860       }
<a name="l04861"></a>04861 }
<a name="l04862"></a>04862 
<a name="l04863"></a><a class="code" href="Handle_01Items_8cpp.html#7f80ae8d4985e6da4575fd545cb51a2d">04863</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#7f80ae8d4985e6da4575fd545cb51a2d">MineSpottedDialogueCallBack</a>( <span class="keywordtype">void</span> )
<a name="l04864"></a>04864 {
<a name="l04865"></a>04865       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> * pItemPool;
<a name="l04866"></a>04866 
<a name="l04867"></a>04867   <span class="comment">// ATE: REALLY IMPORTANT - ALL CALLBACK ITEMS SHOULD UNLOCK</span>
<a name="l04868"></a>04868   <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#d2c3549e0a512607553d150160a0709c">fLockItemLocators</a> = FALSE;
<a name="l04869"></a>04869 
<a name="l04870"></a>04870       <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a>, &amp;pItemPool, <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a> );
<a name="l04871"></a>04871 
<a name="l04872"></a>04872       <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e9284e6f1f50ffc974b408c62555d8ba2">LU_BEGINUILOCK</a>;
<a name="l04873"></a>04873 
<a name="l04874"></a>04874       <span class="comment">// play a locator at the location of the mine</span>
<a name="l04875"></a>04875       <a class="code" href="Handle_01Items_8cpp.html#8bb946e2b636fd21276251138b685e22">SetItemPoolLocatorWithCallback</a>( pItemPool, <a class="code" href="Handle_01Items_8cpp.html#fb1b003f16dd2d4cab628193e7e9e673">MineSpottedLocatorCallback</a> );
<a name="l04876"></a>04876 }
<a name="l04877"></a>04877 
<a name="l04878"></a><a class="code" href="Handle_01Items_8cpp.html#fb1b003f16dd2d4cab628193e7e9e673">04878</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#fb1b003f16dd2d4cab628193e7e9e673">MineSpottedLocatorCallback</a>( <span class="keywordtype">void</span> )
<a name="l04879"></a>04879 {
<a name="l04880"></a>04880       <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405ecdd777bfca71920c86e66ee609316ceb">LU_ENDUILOCK</a>;
<a name="l04881"></a>04881 
<a name="l04882"></a>04882       <span class="comment">// now ask the player if he wants to place a blue flag.</span>
<a name="l04883"></a>04883       <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28edfaaee6cf60e9dcec27ec0650dbbc39f">MSG_BOX_BASIC_STYLE</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe7d79d8045076e801c1ee56d17927025e3">PLACE_BLUE_FLAG_PROMPT</a> ], <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf29873e16bc1530dedb416060abbeea6d0">GAME_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_YESNO, <a class="code" href="Handle_01Items_8cpp.html#bf51e1afd56dade27cff5d8cf0b5f479">MineSpottedMessageBoxCallBack</a>, NULL );
<a name="l04884"></a>04884 }
<a name="l04885"></a>04885 
<a name="l04886"></a><a class="code" href="Handle_01Items_8cpp.html#bf51e1afd56dade27cff5d8cf0b5f479">04886</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#bf51e1afd56dade27cff5d8cf0b5f479">MineSpottedMessageBoxCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue )
<a name="l04887"></a>04887 {
<a name="l04888"></a>04888       <span class="keywordflow">if</span> (ubExitValue == MSG_BOX_RETURN_YES)
<a name="l04889"></a>04889       {
<a name="l04890"></a>04890             <span class="comment">// place a blue flag where the mine was found</span>
<a name="l04891"></a>04891             <a class="code" href="Handle_01Items_8cpp.html#98014335a350539627e4af7be10c7565">AddBlueFlag</a>( <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a>, <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a> );
<a name="l04892"></a>04892       }
<a name="l04893"></a>04893 }
<a name="l04894"></a>04894 
<a name="l04895"></a><a class="code" href="Handle_01Items_8cpp.html#6dc7fb5abedf9373075875a601964bfe">04895</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#6dc7fb5abedf9373075875a601964bfe">RemoveBlueFlagDialogueCallBack</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubExitValue )
<a name="l04896"></a>04896 {
<a name="l04897"></a>04897       <span class="keywordflow">if</span> (ubExitValue == MSG_BOX_RETURN_YES)
<a name="l04898"></a>04898       {
<a name="l04899"></a>04899             <a class="code" href="Handle_01Items_8cpp.html#fdc539137255b9943133ba42a805258a">RemoveBlueFlag</a>( <a class="code" href="Handle_01Items_8cpp.html#f1b620fc987b448487541c70463b4667">gsBoobyTrapGridNo</a>, <a class="code" href="Handle_01Items_8cpp.html#51a12d17293461ff2801af97440489a4">gbBoobyTrapLevel</a> );
<a name="l04900"></a>04900       }
<a name="l04901"></a>04901 }
<a name="l04902"></a>04902 
<a name="l04903"></a><a class="code" href="Handle_01Items_8h.html#98014335a350539627e4af7be10c7565">04903</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#98014335a350539627e4af7be10c7565">AddBlueFlag</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo ,<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bLevel )
<a name="l04904"></a>04904 {
<a name="l04905"></a>04905       <a class="code" href="structTAG__level__node.html">LEVELNODE</a> *pNode;
<a name="l04906"></a>04906 
<a name="l04907"></a>04907       <a class="code" href="SaveLoadMap_8cpp.html#b21040d8a2dd004ba4c9bd36ac249ff3">ApplyMapChangesToMapTempFile</a>( TRUE );
<a name="l04908"></a>04908       <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#430f12029207b5bb7b32ed30ef355253">uiFlags</a> |= MAPELEMENT_PLAYER_MINE_PRESENT;
<a name="l04909"></a>04909 
<a name="l04910"></a>04910   pNode = <a class="code" href="worldman_8cpp.html#fb0df5d310bb9f0d04c87a20c9727adf">AddStructToTail</a>( sGridNo, BLUEFLAG_GRAPHIC );
<a name="l04911"></a>04911 
<a name="l04912"></a>04912       <span class="keywordflow">if</span> ( pNode )
<a name="l04913"></a>04913       {
<a name="l04914"></a>04914             pNode-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> |= LEVELNODE_SHOW_THROUGH;
<a name="l04915"></a>04915       }
<a name="l04916"></a>04916 
<a name="l04917"></a>04917       <a class="code" href="SaveLoadMap_8cpp.html#b21040d8a2dd004ba4c9bd36ac249ff3">ApplyMapChangesToMapTempFile</a>( FALSE );
<a name="l04918"></a>04918       <a class="code" href="worlddef_8cpp.html#26ee830f0d9b77dea7feee9cde874558">RecompileLocalMovementCostsFromRadius</a>( sGridNo, bLevel );
<a name="l04919"></a>04919       <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>(RENDER_FLAG_FULL);
<a name="l04920"></a>04920 }
<a name="l04921"></a>04921 
<a name="l04922"></a><a class="code" href="Handle_01Items_8h.html#fdc539137255b9943133ba42a805258a">04922</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#fdc539137255b9943133ba42a805258a">RemoveBlueFlag</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bLevel )
<a name="l04923"></a>04923 {
<a name="l04924"></a>04924       <a class="code" href="SaveLoadMap_8cpp.html#b21040d8a2dd004ba4c9bd36ac249ff3">ApplyMapChangesToMapTempFile</a>( TRUE );
<a name="l04925"></a>04925       <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[sGridNo].<a class="code" href="structMAP__ELEMENT.html#430f12029207b5bb7b32ed30ef355253">uiFlags</a> &amp;= ~(MAPELEMENT_PLAYER_MINE_PRESENT);
<a name="l04926"></a>04926 
<a name="l04927"></a>04927   <span class="keywordflow">if</span> ( bLevel == 0 )
<a name="l04928"></a>04928   {
<a name="l04929"></a>04929         <a class="code" href="worldman_8cpp.html#d86473576ee54508483e8f6f988fb0c5">RemoveStruct</a>( sGridNo, BLUEFLAG_GRAPHIC );
<a name="l04930"></a>04930   }
<a name="l04931"></a>04931   <span class="keywordflow">else</span>
<a name="l04932"></a>04932   {
<a name="l04933"></a>04933     <a class="code" href="worldman_8cpp.html#8d06092dfaebfdc977a6ca14932bc3a9">RemoveOnRoof</a>( sGridNo, BLUEFLAG_GRAPHIC );
<a name="l04934"></a>04934   }
<a name="l04935"></a>04935 
<a name="l04936"></a>04936       <a class="code" href="SaveLoadMap_8cpp.html#b21040d8a2dd004ba4c9bd36ac249ff3">ApplyMapChangesToMapTempFile</a>( FALSE );
<a name="l04937"></a>04937       <a class="code" href="worlddef_8cpp.html#26ee830f0d9b77dea7feee9cde874558">RecompileLocalMovementCostsFromRadius</a>( sGridNo, bLevel );
<a name="l04938"></a>04938       <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>(RENDER_FLAG_FULL);
<a name="l04939"></a>04939 }
<a name="l04940"></a>04940 
<a name="l04941"></a><a class="code" href="Handle_01Items_8h.html#799c460ae59c26604434de560066c81f">04941</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#799c460ae59c26604434de560066c81f">MakeNPCGrumpyForMinorOffense</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pOffendingSoldier )
<a name="l04942"></a>04942 {
<a name="l04943"></a>04943       <a class="code" href="ai_8h.html#6cced4c42ca3081db5b89f6a584e549f">CancelAIAction</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, TRUE );
<a name="l04944"></a>04944 
<a name="l04945"></a>04945       <span class="keywordflow">switch</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> )
<a name="l04946"></a>04946       {
<a name="l04947"></a>04947             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa193147ef3c4942477c343fbfff042f74a">FREDO</a>:
<a name="l04948"></a>04948             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1dcda4f3676fdbf1782374e8046b9443f">FRANZ</a>:
<a name="l04949"></a>04949             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1737b675309e5cd511168f50ee2f6b612">HERVE</a>:
<a name="l04950"></a>04950             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa18c0f57de6038a950d4813a05d38bbf28">PETER</a>:
<a name="l04951"></a>04951             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa16db81aa485f7cd0c1a844d0afafa9ca1">ALBERTO</a>:
<a name="l04952"></a>04952             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1c16317c1ae7b8552e19a99fbe2644047">CARLO</a>:
<a name="l04953"></a>04953             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1b678aa503cc3b74de91ca9429dfc1cff">MANNY</a>:
<a name="l04954"></a>04954             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1664caa3c281309dd8938f272042346e3">GABBY</a>:
<a name="l04955"></a>04955             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1a9ff2f72766e0f4ea63bd2ff06525b70">ARNIE</a>:
<a name="l04956"></a>04956             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa189cf152d0147870b93b9368c26c740aa">HOWARD</a>:
<a name="l04957"></a>04957             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa15e72f846ee5b2e4e04de87e6bd3e6662">SAM</a>:
<a name="l04958"></a>04958             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa178cb5bfb5a33927e8291aff708638b59">FATHER</a>:
<a name="l04959"></a>04959             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa17fc90832a3d2046513e3c7dd4cca7969">TINA</a>:
<a name="l04960"></a>04960             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa15ca74bc5fe46b1d6d44b6ec9fc0a7898">ARMAND</a>:
<a name="l04961"></a>04961             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa14f5168cdb74c9be8385a7493e6b023a1">WALTER</a>:
<a name="l04962"></a>04962                   <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].<a class="code" href="structMERCPROFILESTRUCT.html#ef69000d93333be8514a29b0ad500888">ubMiscFlags3</a> |= PROFILE_MISC_FLAG3_NPC_PISSED_OFF;
<a name="l04963"></a>04963                   <a class="code" href="NPC_8cpp.html#af73d5141d97b94dbc9799c8c5a919a5">TriggerNPCWithIHateYouQuote</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> );
<a name="l04964"></a>04964                   <span class="keywordflow">break</span>;
<a name="l04965"></a>04965             <span class="keywordflow">default</span>:
<a name="l04966"></a>04966                   <span class="comment">// trigger NPCs with quote if available</span>
<a name="l04967"></a>04967                   <a class="code" href="opplist_8cpp.html#b6c342881dfbb260b8b708f3ab5f2f38">AddToShouldBecomeHostileOrSayQuoteList</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a> );
<a name="l04968"></a>04968                   <span class="keywordflow">break</span>;
<a name="l04969"></a>04969       }
<a name="l04970"></a>04970 
<a name="l04971"></a>04971   <span class="keywordflow">if</span> ( pOffendingSoldier )
<a name="l04972"></a>04972   {
<a name="l04973"></a>04973         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#53ed9c5e40b0869d3105c303f04a083b">bNextAction</a> = <a class="code" href="ai_8h.html#21d5e8f8cdaa838586b31007df0a950b37cf9e2444c935d3fcb8ec2307a02d75">AI_ACTION_CHANGE_FACING</a>;
<a name="l04974"></a>04974         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b733cfde1d6b930da0d914cc679564ca">usNextActionData</a> = <a class="code" href="Soldier_01Control_8cpp.html#5d07f5ec1830ee43c5ea64def81cfded">atan8</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#80d05007932f81f157f2773852ebf62f">sX</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#bad6abc8c1fd843d332db84aa9c1a10c">sY</a>, pOffendingSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#80d05007932f81f157f2773852ebf62f">sX</a>, pOffendingSoldier-&gt;<a class="code" href="structSOLDIERTYPE.html#bad6abc8c1fd843d332db84aa9c1a10c">sY</a> );
<a name="l04975"></a>04975   }
<a name="l04976"></a>04976 }
<a name="l04977"></a>04977 
<a name="l04978"></a>04978 
<a name="l04979"></a><a class="code" href="Handle_01Items_8cpp.html#5ddef68cadcbd073a97ea83a8da5b1c5">04979</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#5ddef68cadcbd073a97ea83a8da5b1c5">TestPotentialOwner</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l04980"></a>04980 {
<a name="l04981"></a>04981       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#653dad4e2520784e293eca9f948b8532">bActive</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b0096f321a0de4f0617283f7b3212aa0">bInSector</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a> &gt;= OKLIFE )
<a name="l04982"></a>04982       {
<a name="l04983"></a>04983             <span class="keywordflow">if</span> ( <a class="code" href="LOS_8cpp.html#1687abe11a81ed4e42b9d83f7510304c">SoldierToSoldierLineOfSightTest</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) <a class="code" href="opplist_8cpp.html#3024b66f9b450ab359bf03734c3aad9b">DistanceVisible</a>( pSoldier, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7680b9f541cb30851967400ce4b0f2807">DIRECTION_IRRELEVANT</a>, 0, <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a> ), TRUE ) )
<a name="l04984"></a>04984             {
<a name="l04985"></a>04985                   <a class="code" href="Handle_01Items_8cpp.html#799c460ae59c26604434de560066c81f">MakeNPCGrumpyForMinorOffense</a>( pSoldier, <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a> );
<a name="l04986"></a>04986             }
<a name="l04987"></a>04987       }
<a name="l04988"></a>04988 }
<a name="l04989"></a>04989 
<a name="l04990"></a><a class="code" href="Handle_01Items_8cpp.html#7756ad997efa08df951c7de26ea6d50d">04990</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#7756ad997efa08df951c7de26ea6d50d">CheckForPickedOwnership</a>( <span class="keywordtype">void</span> )
<a name="l04991"></a>04991 {
<a name="l04992"></a>04992       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *                   pItemPool;
<a name="l04993"></a>04993       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                                     ubProfile;
<a name="l04994"></a>04994       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                                     ubCivGroup;
<a name="l04995"></a>04995       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *                 <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l04996"></a>04996       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                                     ubLoop;
<a name="l04997"></a>04997 
<a name="l04998"></a>04998       <span class="comment">// LOOP THROUGH LIST TO FIND NODE WE WANT</span>
<a name="l04999"></a>04999       <a class="code" href="Handle_01Items_8cpp.html#f3115ef99b74538fde1620eee4e58261">GetItemPool</a>( <a class="code" href="Handle_01Items_8cpp.html#2a4f3638cd7bc6c7361fbb6f14de1114">gsTempGridno</a>, &amp;pItemPool, <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a> );
<a name="l05000"></a>05000 
<a name="l05001"></a>05001       <span class="keywordflow">while</span>( pItemPool )
<a name="l05002"></a>05002       {
<a name="l05003"></a>05003             <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.usItem == <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4f8504500da6b5018e9afcfb429a4768d">OWNERSHIP</a> )
<a name="l05004"></a>05004             {
<a name="l05005"></a>05005                   <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.ubOwnerProfile != NO_PROFILE )
<a name="l05006"></a>05006                   {
<a name="l05007"></a>05007                         ubProfile = <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].<a class="code" href="structWORLDITEM.html#0f219e2d7aafd3aeca85991add1ef5f8">o</a>.<a class="code" href="structOBJECTTYPE.html#8c130a0bfbdeb777fa90230a6c42d313">ubOwnerProfile</a>;
<a name="l05008"></a>05008                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Soldier_01Profile_8cpp.html#2a54c4a06df8ed61529646f23682ef9d">FindSoldierByProfileID</a>( ubProfile, FALSE );
<a name="l05009"></a>05009                         <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l05010"></a>05010                         {
<a name="l05011"></a>05011                               <a class="code" href="Handle_01Items_8cpp.html#5ddef68cadcbd073a97ea83a8da5b1c5">TestPotentialOwner</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l05012"></a>05012                         }
<a name="l05013"></a>05013                   }
<a name="l05014"></a>05014                   <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].o.ubOwnerCivGroup != <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a078524cb5f7573455bdacd2b87a051da610c97">NON_CIV_GROUP</a> ) 
<a name="l05015"></a>05015                   {
<a name="l05016"></a>05016                         ubCivGroup = <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> ].<a class="code" href="structWORLDITEM.html#0f219e2d7aafd3aeca85991add1ef5f8">o</a>.<a class="code" href="structOBJECTTYPE.html#ddfe9a40daf403fb9175bebb1d289262">ubOwnerCivGroup</a>;
<a name="l05017"></a>05017                         <span class="keywordflow">if</span> ( ubCivGroup == <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a0785248e818a9693e42cfdf988862de0f393aa">HICKS_CIV_GROUP</a> &amp;&amp; <a class="code" href="Quests_8cpp.html#6744b59d27bf2791d0c2fefe18e548d3">CheckFact</a>( <a class="code" href="Quests_8h.html#aead3e57f613f07868a1b2afb6b943f119e920e92211ecca4d79f7217468f5ce">FACT_HICKS_MARRIED_PLAYER_MERC</a>, 0 ) )
<a name="l05018"></a>05018                         {
<a name="l05019"></a>05019                               <span class="comment">// skip because hicks appeased</span>
<a name="l05020"></a>05020                               pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l05021"></a>05021                               <span class="keywordflow">continue</span>;
<a name="l05022"></a>05022                         }
<a name="l05023"></a>05023                         <span class="keywordflow">for</span> ( ubLoop = <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ CIV_TEAM ].<a class="code" href="structTacticalTeamType.html#f8fe819ad07b242f5dbf97fd4c69b00d">bFirstID</a>; ubLoop &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ CIV_TEAM ].<a class="code" href="structTacticalTeamType.html#6a887279dad735dc302f21c1e559d5ce">bLastID</a>; ubLoop++ )
<a name="l05024"></a>05024                         {
<a name="l05025"></a>05025                               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubLoop ];
<a name="l05026"></a>05026                               <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> == ubCivGroup )
<a name="l05027"></a>05027                               {
<a name="l05028"></a>05028                                     <a class="code" href="Handle_01Items_8cpp.html#5ddef68cadcbd073a97ea83a8da5b1c5">TestPotentialOwner</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l05029"></a>05029                               }
<a name="l05030"></a>05030                         }
<a name="l05031"></a>05031                   }
<a name="l05032"></a>05032             }
<a name="l05033"></a>05033             pItemPool = pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l05034"></a>05034       }
<a name="l05035"></a>05035 
<a name="l05036"></a>05036 }
<a name="l05037"></a>05037 
<a name="l05038"></a>05038 
<a name="l05039"></a>05039 
<a name="l05040"></a><a class="code" href="Handle_01Items_8cpp.html#644a8912ec065b26622ee09cf354a3f7">05040</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#644a8912ec065b26622ee09cf354a3f7">LoopLevelNodeForItemGlowFlag</a>( <a class="code" href="structTAG__level__node.html">LEVELNODE</a> *pNode, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fOn )
<a name="l05041"></a>05041 {
<a name="l05042"></a>05042       <span class="keywordflow">while</span> ( pNode != NULL )
<a name="l05043"></a>05043       {
<a name="l05044"></a>05044             <span class="keywordflow">if</span> ( pNode-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> &amp; LEVELNODE_ITEM )
<a name="l05045"></a>05045             {
<a name="l05046"></a>05046                   <span class="keywordflow">if</span> ( fOn )
<a name="l05047"></a>05047                   {
<a name="l05048"></a>05048                         pNode-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> |= LEVELNODE_DYNAMIC;
<a name="l05049"></a>05049                   }
<a name="l05050"></a>05050                   <span class="keywordflow">else</span>
<a name="l05051"></a>05051                   {
<a name="l05052"></a>05052                         pNode-&gt;<a class="code" href="structTAG__level__node.html#d2f7b6a466532e1f2bb982a0f206db6a">uiFlags</a> &amp;= (~LEVELNODE_DYNAMIC);
<a name="l05053"></a>05053                   }
<a name="l05054"></a>05054             }
<a name="l05055"></a>05055             pNode = pNode-&gt;<a class="code" href="structTAG__level__node.html#7c693acc3b593ab866b789ba7542eef7">pNext</a>;
<a name="l05056"></a>05056       }
<a name="l05057"></a>05057 }
<a name="l05058"></a>05058 
<a name="l05059"></a>05059 
<a name="l05060"></a><a class="code" href="Handle_01Items_8cpp.html#52e764628f4c496d49938a0a515536ae">05060</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#52e764628f4c496d49938a0a515536ae">HandleItemGlowFlag</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubLevel, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fOn )
<a name="l05061"></a>05061 {
<a name="l05062"></a>05062       <a class="code" href="structTAG__level__node.html">LEVELNODE</a> *pNode;
<a name="l05063"></a>05063 
<a name="l05064"></a>05064       <span class="keywordflow">if</span> ( ubLevel == 0 )
<a name="l05065"></a>05065       {
<a name="l05066"></a>05066             pNode = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#0cc751d3c74e25ab6dd78d58da155f6d">pStructHead</a>;
<a name="l05067"></a>05067             <a class="code" href="Handle_01Items_8cpp.html#644a8912ec065b26622ee09cf354a3f7">LoopLevelNodeForItemGlowFlag</a>( pNode, sGridNo,  ubLevel, fOn );
<a name="l05068"></a>05068       }
<a name="l05069"></a>05069       <span class="keywordflow">else</span>
<a name="l05070"></a>05070       {
<a name="l05071"></a>05071             pNode = <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].<a class="code" href="structMAP__ELEMENT.html#cc1855e037c8009f869e8d4ef8f90e6c">pOnRoofHead</a>;
<a name="l05072"></a>05072             <a class="code" href="Handle_01Items_8cpp.html#644a8912ec065b26622ee09cf354a3f7">LoopLevelNodeForItemGlowFlag</a>( pNode, sGridNo, ubLevel, fOn );
<a name="l05073"></a>05073       }
<a name="l05074"></a>05074 }
<a name="l05075"></a>05075 
<a name="l05076"></a><a class="code" href="Turn_01Based_01Input_8cpp.html#26cfb6b5c61759ae142ce5fe32aa92bc">05076</a> <span class="keywordtype">void</span> <a class="code" href="Options_01Screen_8cpp.html#26cfb6b5c61759ae142ce5fe32aa92bc">ToggleItemGlow</a>( <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fOn )
<a name="l05077"></a>05077 {
<a name="l05078"></a>05078       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> cnt;
<a name="l05079"></a>05079 
<a name="l05080"></a>05080       <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; WORLD_MAX; cnt++ )
<a name="l05081"></a>05081       {
<a name="l05082"></a>05082             <a class="code" href="Handle_01Items_8cpp.html#52e764628f4c496d49938a0a515536ae">HandleItemGlowFlag</a>( ( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> )cnt, 0, fOn );
<a name="l05083"></a>05083             <a class="code" href="Handle_01Items_8cpp.html#52e764628f4c496d49938a0a515536ae">HandleItemGlowFlag</a>( ( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> )cnt, 1, fOn );
<a name="l05084"></a>05084       }
<a name="l05085"></a>05085 
<a name="l05086"></a>05086       <span class="keywordflow">if</span> ( !fOn )
<a name="l05087"></a>05087       {
<a name="l05088"></a>05088             <a class="code" href="GameSettings_8cpp.html#955420499d1cb3101625c85ea703b6bb">gGameSettings</a>.<a class="code" href="structGAME__SETTINGS.html#9d80dbd111727423b8924b5e72e3a0ed">fOptions</a>[ <a class="code" href="GameSettings_8h.html#394b3903fbf00ba2b6243f60689a5a5f5539cd515a6cdfc403cdc76d54d7ef2f">TOPTION_GLOW_ITEMS</a> ] = FALSE;
<a name="l05089"></a>05089       }
<a name="l05090"></a>05090       <span class="keywordflow">else</span>
<a name="l05091"></a>05091       {
<a name="l05092"></a>05092             <a class="code" href="GameSettings_8cpp.html#955420499d1cb3101625c85ea703b6bb">gGameSettings</a>.<a class="code" href="structGAME__SETTINGS.html#9d80dbd111727423b8924b5e72e3a0ed">fOptions</a>[ <a class="code" href="GameSettings_8h.html#394b3903fbf00ba2b6243f60689a5a5f5539cd515a6cdfc403cdc76d54d7ef2f">TOPTION_GLOW_ITEMS</a> ] = TRUE;
<a name="l05093"></a>05093       }
<a name="l05094"></a>05094 
<a name="l05095"></a>05095       <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>(RENDER_FLAG_FULL);
<a name="l05096"></a>05096 }
<a name="l05097"></a>05097 
<a name="l05098"></a><a class="code" href="Handle_01Items_8h.html#80a48cd1305014e0aba464b961362b65">05098</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#80a48cd1305014e0aba464b961362b65">ContinuePastBoobyTrapInMapScreen</a>( <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> *pObject, <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l05099"></a>05099 {
<a name="l05100"></a>05100       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                             fBoobyTrapKnowledge;
<a name="l05101"></a>05101       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                                bTrapDifficulty, bTrapDetectLevel;
<a name="l05102"></a>05102 
<a name="l05103"></a>05103       <span class="keywordflow">if</span> (pObject-&gt;<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a> &gt; 0)
<a name="l05104"></a>05104       {
<a name="l05105"></a>05105             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a>)
<a name="l05106"></a>05106             {
<a name="l05107"></a>05107                   <span class="comment">// does the player know about this item?</span>
<a name="l05108"></a>05108                   fBoobyTrapKnowledge = ((pObject-&gt;<a class="code" href="structOBJECTTYPE.html#0f1e67bac22f1b89c4040ef8a5ea48c2">fFlags</a> &amp; OBJECT_KNOWN_TO_BE_TRAPPED) &gt; 0);
<a name="l05109"></a>05109 
<a name="l05110"></a>05110                   <span class="comment">// blue flag stuff?</span>
<a name="l05111"></a>05111 
<a name="l05112"></a>05112                   <span class="keywordflow">if</span> (!fBoobyTrapKnowledge)
<a name="l05113"></a>05113                   {
<a name="l05114"></a>05114                         bTrapDifficulty = pObject-&gt;<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a>;
<a name="l05115"></a>05115                         bTrapDetectLevel = <a class="code" href="SkillCheck_8cpp.html#7f6623bad6276c85c17b252860879583">CalcTrapDetectLevel</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, FALSE );
<a name="l05116"></a>05116                         <span class="keywordflow">if</span> (bTrapDetectLevel &gt;= bTrapDifficulty)
<a name="l05117"></a>05117                         {
<a name="l05118"></a>05118                               <span class="comment">// spotted the trap!</span>
<a name="l05119"></a>05119                               pObject-&gt;<a class="code" href="structOBJECTTYPE.html#0f1e67bac22f1b89c4040ef8a5ea48c2">fFlags</a> |= OBJECT_KNOWN_TO_BE_TRAPPED;
<a name="l05120"></a>05120                               fBoobyTrapKnowledge = TRUE;
<a name="l05121"></a>05121 
<a name="l05122"></a>05122                               <span class="comment">// Make him warn us:</span>
<a name="l05123"></a>05123                               <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l05124"></a>05124 
<a name="l05125"></a>05125                               <span class="comment">// And make the call for the dialogue</span>
<a name="l05126"></a>05126                               <a class="code" href="Dialogue_01Control_8cpp.html#d6e34ed2e1392ad257900391bceec09c">SetStopTimeQuoteCallback</a>( <a class="code" href="Handle_01Items_8cpp.html#7604c764ed5d12231713e8204072346c">BoobyTrapDialogueCallBack</a> );
<a name="l05127"></a>05127                               <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a292262222af56ce76376cac0e6b567e571">QUOTE_BOOBYTRAP_ITEM</a> );
<a name="l05128"></a>05128 
<a name="l05129"></a>05129                               <span class="keywordflow">return</span>( FALSE );
<a name="l05130"></a>05130                         }
<a name="l05131"></a>05131                   }
<a name="l05132"></a>05132 
<a name="l05133"></a>05133                   <span class="keywordflow">if</span> (fBoobyTrapKnowledge)
<a name="l05134"></a>05134                   {
<a name="l05135"></a>05135                         <span class="comment">// have the computer ask us if we want to proceed</span>
<a name="l05136"></a>05136                         <a class="code" href="Handle_01Items_8cpp.html#553f19703890d5de0b76be491cca8486">gpBoobyTrapSoldier</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l05137"></a>05137                         <a class="code" href="Handle_01Items_8cpp.html#968c84fc9f191339881c20fa8ccd32d2">gbTrapDifficulty</a> = pObject-&gt;<a class="code" href="structOBJECTTYPE.html#1450f408597be1d0cf02cb7aa98e774d">bTrap</a>;
<a name="l05138"></a>05138                         <a class="code" href="MessageBoxScreen_8cpp.html#ff890475da4a6f8d61959852ea396a03">DoMessageBox</a>( <a class="code" href="MessageBoxScreen_8h.html#2f1398dba5e4a5616b83437528bdb28edfaaee6cf60e9dcec27ec0650dbbc39f">MSG_BOX_BASIC_STYLE</a>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe71a4f43769cce587f5317e833f179abf8">DISARM_BOOBYTRAP_PROMPT</a> ], <a class="code" href="screenids_8h.html#a4ee5dea8709d2b490486a62df77faf26f9c31d9e3c6ef2f0d8e4917d387b871">MAP_SCREEN</a>, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )MSG_BOX_FLAG_YESNO, <a class="code" href="Handle_01Items_8cpp.html#f4498d4e49d6858e1f0636c8d35cf936">BoobyTrapInMapScreenMessageBoxCallBack</a>, NULL );     
<a name="l05139"></a>05139                   }
<a name="l05140"></a>05140                   <span class="keywordflow">else</span>
<a name="l05141"></a>05141                   {
<a name="l05142"></a>05142                         <span class="comment">// oops!</span>
<a name="l05143"></a>05143                         <a class="code" href="Handle_01Items_8cpp.html#9bae781a83db2ac6a3f2a6efafe7eb65">SetOffBoobyTrapInMapScreen</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, pObject );
<a name="l05144"></a>05144                   }
<a name="l05145"></a>05145 
<a name="l05146"></a>05146                   <span class="keywordflow">return</span>( FALSE );
<a name="l05147"></a>05147 
<a name="l05148"></a>05148             }
<a name="l05149"></a>05149             <span class="comment">// else, enemies etc always know about boobytraps and are not affected by them</span>
<a name="l05150"></a>05150       }
<a name="l05151"></a>05151 
<a name="l05152"></a>05152       <span class="keywordflow">return</span>( TRUE );
<a name="l05153"></a>05153 }
<a name="l05154"></a>05154 
<a name="l05155"></a>05155 <span class="comment">// Well, clears all item pools</span>
<a name="l05156"></a><a class="code" href="Handle_01Items_8cpp.html#1108f16ac09fa09a5748aadc16d119fd">05156</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#1108f16ac09fa09a5748aadc16d119fd">ClearAllItemPools</a>( )
<a name="l05157"></a>05157 {
<a name="l05158"></a>05158       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> cnt;
<a name="l05159"></a>05159 
<a name="l05160"></a>05160       <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; WORLD_MAX; cnt++ )
<a name="l05161"></a>05161       {
<a name="l05162"></a>05162             <a class="code" href="Handle_01Items_8cpp.html#745b330543772dad079b18b992c21d28">RemoveItemPool</a>( (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)cnt, 0 );
<a name="l05163"></a>05163             <a class="code" href="Handle_01Items_8cpp.html#745b330543772dad079b18b992c21d28">RemoveItemPool</a>( (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)cnt, 1 );
<a name="l05164"></a>05164       }
<a name="l05165"></a>05165 }
<a name="l05166"></a>05166 
<a name="l05167"></a>05167 
<a name="l05168"></a>05168 <span class="comment">// Refresh item pools</span>
<a name="l05169"></a><a class="code" href="Handle_01Items_8h.html#5a1e422d82e828959c4886b02b6bb4cd">05169</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#5a1e422d82e828959c4886b02b6bb4cd">RefreshItemPools</a>( <a class="code" href="structWORLDITEM.html">WORLDITEM</a> * pItemList, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iNumberOfItems )
<a name="l05170"></a>05170 {
<a name="l05171"></a>05171       <a class="code" href="Handle_01Items_8cpp.html#1108f16ac09fa09a5748aadc16d119fd">ClearAllItemPools</a>( );
<a name="l05172"></a>05172 
<a name="l05173"></a>05173       <a class="code" href="World_01Items_8cpp.html#2d1cfb807bb9b2c7f6936651d9837e7a">RefreshWorldItemsIntoItemPools</a>(  pItemList, iNumberOfItems );
<a name="l05174"></a>05174 }
<a name="l05175"></a>05175 
<a name="l05176"></a>05176 
<a name="l05177"></a><a class="code" href="Handle_01Items_8h.html#69a176a53b0d9221669e17af4c782c7b">05177</a> <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> <a class="code" href="Handle_01Items_8cpp.html#69a176a53b0d9221669e17af4c782c7b">FindNearestAvailableGridNoForItem</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSweetGridNo, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> ubRadius )
<a name="l05178"></a>05178 {
<a name="l05179"></a>05179       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>  sTop, sBottom;
<a name="l05180"></a>05180       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>  sLeft, sRight;
<a name="l05181"></a>05181       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>  cnt1, cnt2, cnt3;
<a name="l05182"></a>05182       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>       sGridNo;
<a name="l05183"></a>05183       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>       uiRange, uiLowestRange = 999999;
<a name="l05184"></a>05184       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>       sLowestGridNo=0;
<a name="l05185"></a>05185       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                         leftmost;
<a name="l05186"></a>05186       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>     fFound = FALSE;
<a name="l05187"></a>05187       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> soldier;
<a name="l05188"></a>05188       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubSaveNPCAPBudget;
<a name="l05189"></a>05189       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubSaveNPCDistLimit;
<a name="l05190"></a>05190       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>     fSetDirection   = FALSE;
<a name="l05191"></a>05191 
<a name="l05192"></a>05192       cnt3 = 0;
<a name="l05193"></a>05193 
<a name="l05194"></a>05194       <span class="comment">//Save AI pathing vars.  changing the distlimit restricts how </span>
<a name="l05195"></a>05195       <span class="comment">//far away the pathing will consider.</span>
<a name="l05196"></a>05196       ubSaveNPCAPBudget = <a class="code" href="PATHAI_8cpp.html#d00692861418c3708b40f1b24cdda537">gubNPCAPBudget</a>;
<a name="l05197"></a>05197       ubSaveNPCDistLimit = <a class="code" href="PATHAI_8cpp.html#34ed6f54eb9848070637e924909fac89">gubNPCDistLimit</a>;
<a name="l05198"></a>05198       <a class="code" href="PATHAI_8cpp.html#d00692861418c3708b40f1b24cdda537">gubNPCAPBudget</a> = 0;
<a name="l05199"></a>05199       <a class="code" href="PATHAI_8cpp.html#34ed6f54eb9848070637e924909fac89">gubNPCDistLimit</a> = ubRadius;
<a name="l05200"></a>05200 
<a name="l05201"></a>05201       <span class="comment">//create dummy soldier, and use the pathing to determine which nearby slots are</span>
<a name="l05202"></a>05202       <span class="comment">//reachable.</span>
<a name="l05203"></a>05203       memset( &amp;soldier, 0, <span class="keyword">sizeof</span>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> ) );
<a name="l05204"></a>05204       soldier.<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> = 1;
<a name="l05205"></a>05205       soldier.<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> = sSweetGridNo;
<a name="l05206"></a>05206 
<a name="l05207"></a>05207       sTop        = ubRadius;
<a name="l05208"></a>05208       sBottom = -ubRadius;
<a name="l05209"></a>05209       sLeft   = - ubRadius;
<a name="l05210"></a>05210       sRight  = ubRadius;
<a name="l05211"></a>05211 
<a name="l05212"></a>05212       <span class="comment">//clear the mapelements of potential residue MAPELEMENT_REACHABLE flags</span>
<a name="l05213"></a>05213       <span class="comment">//in the square region.</span>
<a name="l05214"></a>05214       <span class="keywordflow">for</span>( cnt1 = sBottom; cnt1 &lt;= sTop; cnt1++ )
<a name="l05215"></a>05215       {
<a name="l05216"></a>05216             <span class="keywordflow">for</span>( cnt2 = sLeft; cnt2 &lt;= sRight; cnt2++ )
<a name="l05217"></a>05217             {
<a name="l05218"></a>05218                   sGridNo = sSweetGridNo + (WORLD_COLS * cnt1) + cnt2;
<a name="l05219"></a>05219                   <span class="keywordflow">if</span> ( sGridNo &gt;=0 &amp;&amp; sGridNo &lt; WORLD_MAX )
<a name="l05220"></a>05220                   {
<a name="l05221"></a>05221                         <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].uiFlags &amp;= (~MAPELEMENT_REACHABLE);
<a name="l05222"></a>05222                   }
<a name="l05223"></a>05223             }
<a name="l05224"></a>05224       }
<a name="l05225"></a>05225 
<a name="l05226"></a>05226       <span class="comment">//Now, find out which of these gridnos are reachable </span>
<a name="l05227"></a>05227       <span class="comment">//(use the fake soldier and the pathing settings)</span>
<a name="l05228"></a>05228       <a class="code" href="PATHAI_8cpp.html#9309cf7e4c3dba4d296854459a8f59f8">FindBestPath</a>( &amp;soldier, NOWHERE, 0, <a class="code" href="Animation_01Control_8h.html#9c02dc5e870a2c7d20bbaafb3e7be2eb7f92908f6f669259d971b608823d2ebb">WALKING</a>, COPYREACHABLE, 0 );
<a name="l05229"></a>05229       
<a name="l05230"></a>05230       uiLowestRange = 999999; 
<a name="l05231"></a>05231 
<a name="l05232"></a>05232       <span class="keywordflow">for</span>( cnt1 = sBottom; cnt1 &lt;= sTop; cnt1++ )
<a name="l05233"></a>05233       {
<a name="l05234"></a>05234             leftmost = ( ( sSweetGridNo + ( WORLD_COLS * cnt1 ) )/ WORLD_COLS ) * WORLD_COLS;
<a name="l05235"></a>05235 
<a name="l05236"></a>05236             <span class="keywordflow">for</span>( cnt2 = sLeft; cnt2 &lt;= sRight; cnt2++ )
<a name="l05237"></a>05237             {
<a name="l05238"></a>05238                   sGridNo = sSweetGridNo + ( WORLD_COLS * cnt1 ) + cnt2;
<a name="l05239"></a>05239                   <span class="keywordflow">if</span> ( sGridNo &gt;=0 &amp;&amp; sGridNo &lt; WORLD_MAX &amp;&amp; sGridNo &gt;= leftmost &amp;&amp; sGridNo &lt; ( leftmost + WORLD_COLS ) &amp;&amp;
<a name="l05240"></a>05240                         <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ sGridNo ].uiFlags &amp; MAPELEMENT_REACHABLE )
<a name="l05241"></a>05241                   {
<a name="l05242"></a>05242                         <span class="comment">// Go on sweet stop</span>
<a name="l05243"></a>05243                         <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#1b42cba58f5984a3d0b0d0ec0d3def8c">NewOKDestination</a>( &amp;soldier, sGridNo, TRUE, soldier.bLevel ) )
<a name="l05244"></a>05244                         {
<a name="l05245"></a>05245                               uiRange = <a class="code" href="Isometric_01Utils_8cpp.html#cec8f2eef3f8131c6e7f0077541ca470">GetRangeInCellCoordsFromGridNoDiff</a>( sSweetGridNo, sGridNo );
<a name="l05246"></a>05246 
<a name="l05247"></a>05247                               <span class="keywordflow">if</span> ( uiRange &lt; uiLowestRange )
<a name="l05248"></a>05248                               {
<a name="l05249"></a>05249                                     sLowestGridNo = sGridNo;
<a name="l05250"></a>05250                                     uiLowestRange = uiRange;
<a name="l05251"></a>05251                                     fFound = TRUE;
<a name="l05252"></a>05252                               }
<a name="l05253"></a>05253                         }
<a name="l05254"></a>05254                   }
<a name="l05255"></a>05255             }
<a name="l05256"></a>05256       }
<a name="l05257"></a>05257       <a class="code" href="PATHAI_8cpp.html#d00692861418c3708b40f1b24cdda537">gubNPCAPBudget</a> = ubSaveNPCAPBudget;
<a name="l05258"></a>05258       <a class="code" href="PATHAI_8cpp.html#34ed6f54eb9848070637e924909fac89">gubNPCDistLimit</a> = ubSaveNPCDistLimit;
<a name="l05259"></a>05259       <span class="keywordflow">if</span> ( fFound )
<a name="l05260"></a>05260       {
<a name="l05261"></a>05261             <span class="keywordflow">return</span> sLowestGridNo;
<a name="l05262"></a>05262       }
<a name="l05263"></a>05263       <span class="keywordflow">return</span> NOWHERE;
<a name="l05264"></a>05264 }
<a name="l05265"></a>05265 
<a name="l05266"></a>05266 
<a name="l05267"></a><a class="code" href="Handle_01Items_8h.html#7140f5ed92023556828ebfa2c2e051ec">05267</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Handle_01Items_8cpp.html#7140f5ed92023556828ebfa2c2e051ec">CanPlayerUseRocketRifle</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fDisplay )
<a name="l05268"></a>05268 {
<a name="l05269"></a>05269       <span class="keywordflow">if</span> ( <a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].usItem].fingerprintid )
<a name="l05270"></a>05270   {
<a name="l05271"></a>05271     <span class="comment">// check imprint ID</span>
<a name="l05272"></a>05272     <span class="comment">// NB not-imprinted value is NO_PROFILE</span>
<a name="l05273"></a>05273     <span class="comment">// imprinted value is profile for mercs &amp; NPCs and NO_PROFILE + 1 for generic dudes</span>
<a name="l05274"></a>05274     <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE)
<a name="l05275"></a>05275     {
<a name="l05276"></a>05276           <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].ubImprintID != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> )
<a name="l05277"></a>05277           {
<a name="l05278"></a>05278         <span class="comment">// NOT a virgin gun...</span>
<a name="l05279"></a>05279                 <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#99a689d831418a5e3ed638a34761514e">ubAttackingHand</a> ].ubImprintID != NO_PROFILE )
<a name="l05280"></a>05280                 {
<a name="l05281"></a>05281                       <span class="comment">// access denied!</span>
<a name="l05282"></a>05282                       <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a>)
<a name="l05283"></a>05283                       {
<a name="l05284"></a>05284                             <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5c92c0ddd5d88adf1393954dcdd7f9074">RG_ID_INVALID</a>, RATE_11025, HIGHVOLUME, 1, MIDDLE );
<a name="l05285"></a>05285           
<a name="l05286"></a>05286             <span class="keywordflow">if</span> ( fDisplay )
<a name="l05287"></a>05287             {
<a name="l05288"></a>05288                           <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_UI_FEEDBACK, L<span class="stringliteral">"\"%s\""</span>, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe7331fa9c5dc9df28c453b96ec75b08cba">GUN_NOGOOD_FINGERPRINT</a> ] );
<a name="l05289"></a>05289             }
<a name="l05290"></a>05290                       }
<a name="l05291"></a>05291                       <span class="keywordflow">return</span>( FALSE );
<a name="l05292"></a>05292                 }
<a name="l05293"></a>05293           }
<a name="l05294"></a>05294     }
<a name="l05295"></a>05295   }
<a name="l05296"></a>05296   <span class="keywordflow">return</span>( TRUE );
<a name="l05297"></a>05297 }
<a name="l05298"></a>05298 <span class="comment"></span>
<a name="l05299"></a>05299 <span class="comment">/**</span>
<a name="l05300"></a>05300 <span class="comment"> * jackaians: pretty bad function. Create an artificial ItemPool, where </span>
<a name="l05301"></a>05301 <span class="comment"> * iItemIndex is not the index in the world, but is used to store the index</span>
<a name="l05302"></a>05302 <span class="comment"> * of the opponent's slots.</span>
<a name="l05303"></a>05303 <span class="comment"> * if only one item, return in ubIndexRet the item's index</span>
<a name="l05304"></a>05304 <span class="comment"> */</span>
<a name="l05305"></a><a class="code" href="Handle_01Items_8h.html#ea1f48f53a5059e339543627a014a0ed">05305</a> <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> <a class="code" href="Handle_01Items_8cpp.html#ea1f48f53a5059e339543627a014a0ed">StealItems</a>(<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a>* <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>,<a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a>* pOpponent, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>* ubIndexRet)
<a name="l05306"></a>05306 {
<a name="l05307"></a>05307       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>       ubCount=0;
<a name="l05308"></a>05308       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>   *pItemPool,*pTempItemPool,*pTempLastItemPool;
<a name="l05309"></a>05309       <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a>  *pObject;   
<a name="l05310"></a>05310       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>       i;
<a name="l05311"></a>05311 
<a name="l05312"></a>05312       <span class="comment">//Create a temporary item pool, with index in Opponent's inventory as index</span>
<a name="l05313"></a>05313       pItemPool=NULL;
<a name="l05314"></a>05314       <span class="keywordflow">for</span>(i=0 ; i&lt;<a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc878553e9a668bdf9e2a72b855424ee1bdabcf">NUM_INV_SLOTS</a>; i++)
<a name="l05315"></a>05315       {
<a name="l05316"></a>05316             pObject=pOpponent-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>+i;
<a name="l05317"></a>05317             <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> (pObject-&gt;<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>!=0)
<a name="l05318"></a>05318             {
<a name="l05319"></a>05319                   pTempItemPool = (<a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>*)MemAlloc(<span class="keyword">sizeof</span>(<a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>));
<a name="l05320"></a>05320                   ++ubCount;
<a name="l05321"></a>05321                   <span class="keywordflow">if</span> (pItemPool == NULL)
<a name="l05322"></a>05322                   {
<a name="l05323"></a>05323                         pItemPool = pTempItemPool;
<a name="l05324"></a>05324                         pItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#7ee735a43a38256a0497c42e45054efc">pPrev</a> = NULL;
<a name="l05325"></a>05325                   }
<a name="l05326"></a>05326                   <span class="keywordflow">else</span>
<a name="l05327"></a>05327                   {
<a name="l05328"></a>05328                         pTempItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#7ee735a43a38256a0497c42e45054efc">pPrev</a> = pTempLastItemPool;
<a name="l05329"></a>05329                         pTempLastItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a> = pTempItemPool;
<a name="l05330"></a>05330                   }
<a name="l05331"></a>05331                   pTempItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a> = NULL;
<a name="l05332"></a>05332                   pTempItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a> = i;
<a name="l05333"></a>05333                   <span class="comment">//very bad, jack, to test if we are stealing?</span>
<a name="l05334"></a>05334                   pTempItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8fb6ca67b4c4dc719e7d2b927cbb510f">pLevelNode</a>=NULL;<span class="comment">//finally not used</span>
<a name="l05335"></a>05335                   pTempLastItemPool=pTempItemPool;
<a name="l05336"></a>05336             }
<a name="l05337"></a>05337       }
<a name="l05338"></a>05338       <span class="keywordflow">if</span> (ubCount == 0)
<a name="l05339"></a>05339       {
<a name="l05340"></a>05340             <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0a138998dc9ae142b64753fbef27bd72de">BATTLE_SOUND_NOTHING</a> );
<a name="l05341"></a>05341             <span class="keywordflow">return</span>( 0);
<a name="l05342"></a>05342       }
<a name="l05343"></a>05343 
<a name="l05344"></a>05344       <span class="comment">//if only one item</span>
<a name="l05345"></a>05345       <span class="keywordflow">if</span> (ubCount == 1)
<a name="l05346"></a>05346       {
<a name="l05347"></a>05347             *ubIndexRet=pItemPool-&gt;iItemIndex;
<a name="l05348"></a>05348             MemFree( pItemPool);
<a name="l05349"></a>05349             <span class="keywordflow">return</span>( 1);
<a name="l05350"></a>05350       }
<a name="l05351"></a>05351 
<a name="l05352"></a>05352       <span class="comment">// Freeze guy!</span>
<a name="l05353"></a>05353       <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#458a4b9ca265e9c6f88f526587e52fd1">fPauseAllAnimation</a> = TRUE;
<a name="l05354"></a>05354 
<a name="l05355"></a>05355       <a class="code" href="Interface_01Items_8cpp.html#7ad57530157376da5ab7413d434f2e76">InitializeStealItemPickupMenu</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, pOpponent, pItemPool, ubCount);
<a name="l05356"></a>05356       <a class="code" href="Handle_01UI_8cpp.html#c1a811228f6db879e9c1d67b68651a1b">guiPendingOverrideEvent</a> = <a class="code" href="Handle_01UI_8h.html#af14d9a15c91cd740ff202b6335e405e262169b5107bab7d6238f916d550a0cd">G_GETTINGITEM</a>;
<a name="l05357"></a>05357       <span class="keywordflow">return</span>( ubCount );
<a name="l05358"></a>05358 }
<a name="l05359"></a>05359 
<a name="l05360"></a>05360 <span class="comment"></span>
<a name="l05361"></a>05361 <span class="comment">/**</span>
<a name="l05362"></a>05362 <span class="comment"> * jackaians: function copied from SoldierGetItemFromWorld</span>
<a name="l05363"></a>05363 <span class="comment"> * check user's choices and try to place them in his slots</span>
<a name="l05364"></a>05364 <span class="comment"> */</span>
<a name="l05365"></a><a class="code" href="Handle_01Items_8h.html#3bd909e2204e0c34d0b4ac18b2bf56fb">05365</a> <span class="keywordtype">void</span> <a class="code" href="Handle_01Items_8cpp.html#3bd909e2204e0c34d0b4ac18b2bf56fb">SoldierStealItemFromSoldier</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pOpponent,<a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a> *pItemPool, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iItemIndex, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bZLevel, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> *pfSelectionList )
<a name="l05366"></a>05366 {
<a name="l05367"></a>05367       <a class="code" href="structTAG__ITEM__POOL.html">ITEM_POOL</a>         *pTempItemPool;
<a name="l05368"></a>05368       <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a>        Object;
<a name="l05369"></a>05369       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>             cnt = 0;
<a name="l05370"></a>05370       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fPickup;
<a name="l05371"></a>05371       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fFailedAutoPlace = FALSE;
<a name="l05372"></a>05372       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fShouldSayCoolQuote = FALSE;
<a name="l05373"></a>05373       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                 fDidSayCoolQuote = FALSE;
<a name="l05374"></a>05374 
<a name="l05375"></a>05375       <span class="comment">// OK. CHECK IF WE ARE DOING ALL IN THIS POOL....</span>
<a name="l05376"></a>05376       <span class="keywordflow">if</span> ( iItemIndex == ITEM_PICKUP_ACTION_ALL || iItemIndex == ITEM_PICKUP_SELECTION )
<a name="l05377"></a>05377       {
<a name="l05378"></a>05378             pTempItemPool = pItemPool;
<a name="l05379"></a>05379 
<a name="l05380"></a>05380             <span class="keywordflow">while</span>( pTempItemPool )
<a name="l05381"></a>05381             {
<a name="l05382"></a>05382                         fPickup = TRUE;
<a name="l05383"></a>05383                         <span class="keywordflow">if</span> ( iItemIndex == ITEM_PICKUP_SELECTION )
<a name="l05384"></a>05384                         {
<a name="l05385"></a>05385                               <span class="keywordflow">if</span> ( !pfSelectionList[ cnt ] )
<a name="l05386"></a>05386                               {
<a name="l05387"></a>05387                                     fPickup = FALSE;
<a name="l05388"></a>05388                               }
<a name="l05389"></a>05389                         }
<a name="l05390"></a>05390                         <span class="comment">// Increment counter...</span>
<a name="l05391"></a>05391                         cnt++;
<a name="l05392"></a>05392                         <span class="keywordflow">if</span> ( fPickup )
<a name="l05393"></a>05393                         {
<a name="l05394"></a>05394                               <span class="comment">// Make copy of item</span>
<a name="l05395"></a>05395                               memcpy( &amp;Object, pOpponent-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>+pTempItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>, <span class="keyword">sizeof</span>( <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a> ) );
<a name="l05396"></a>05396                               <span class="keywordflow">if</span> ( <a class="code" href="Handle_01Items_8cpp.html#c4c488e0463a2f8e01ab74ba02fb9f15">ItemIsCool</a>( &amp;Object ) )
<a name="l05397"></a>05397                               {
<a name="l05398"></a>05398                                     fShouldSayCoolQuote = TRUE;
<a name="l05399"></a>05399                               }
<a name="l05400"></a>05400                               <span class="keywordflow">if</span> ( !<a class="code" href="Items_8cpp.html#b0cdccd7f510d5464ab386cb5b69c28f">AutoPlaceObject</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, &amp;Object, TRUE ) )
<a name="l05401"></a>05401                               {
<a name="l05402"></a>05402                                     <a class="code" href="Handle_01Items_8cpp.html#ca7f6f6da97e9a4c2b737296485f5c84">AddItemToPool</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, &amp;Object, 1, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, 0, -1 );
<a name="l05403"></a>05403                               }
<a name="l05404"></a>05404                               <a class="code" href="Items_8cpp.html#5950d1252d479c6f8c5a25d86b06d889">DeleteObj</a>(pOpponent-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>+pTempItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#8b7c8953da8316b6921b514e2c1cef36">iItemIndex</a>);
<a name="l05405"></a>05405                         }
<a name="l05406"></a>05406                         pTempItemPool = pTempItemPool-&gt;<a class="code" href="structTAG__ITEM__POOL.html#9a6b2d91332d94678076c494658fc522">pNext</a>;
<a name="l05407"></a>05407             }
<a name="l05408"></a>05408       }
<a name="l05409"></a>05409       <span class="comment">// OK, check if potentially a good candidate for cool quote</span>
<a name="l05410"></a>05410       <span class="keywordflow">if</span> ( fShouldSayCoolQuote &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> )
<a name="l05411"></a>05411       {
<a name="l05412"></a>05412             <span class="comment">// Do we have this quote..?</span>
<a name="l05413"></a>05413             <span class="keywordflow">if</span> ( <a class="code" href="QARRAY_8cpp.html#e93c954f0ec074dec2f9c4fc087ee1d2">QuoteExp_GotGunOrUsedGun</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ] == <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a299631003e4ebffc7bc4d55a2dda380ad4">QUOTE_FOUND_SOMETHING_SPECIAL</a> )
<a name="l05414"></a>05414             {
<a name="l05415"></a>05415                   <span class="comment">// Have we not said it today?</span>
<a name="l05416"></a>05416                   <span class="keywordflow">if</span> ( !( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#460d1be0d96ad07ca098aaf7986bf0ec">usQuoteSaidFlags</a> &amp; SOLDIER_QUOTE_SAID_FOUND_SOMETHING_NICE ) )
<a name="l05417"></a>05417                   {
<a name="l05418"></a>05418                         <span class="comment">// set flag</span>
<a name="l05419"></a>05419                         <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#460d1be0d96ad07ca098aaf7986bf0ec">usQuoteSaidFlags</a> |= SOLDIER_QUOTE_SAID_FOUND_SOMETHING_NICE;
<a name="l05420"></a>05420                         <span class="comment">// Say it....</span>
<a name="l05421"></a>05421                         <span class="comment">// We've found something!</span>
<a name="l05422"></a>05422                         <a class="code" href="Dialogue_01Control_8cpp.html#78d57daff1e69f02d5d83bd74d30e520">TacticalCharacterDialogue</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Dialogue_01Control_8h.html#db9a2c9e383607c8609a364ff1521a299631003e4ebffc7bc4d55a2dda380ad4">QUOTE_FOUND_SOMETHING_SPECIAL</a> );
<a name="l05423"></a>05423                         fDidSayCoolQuote = TRUE;
<a name="l05424"></a>05424                   }
<a name="l05425"></a>05425             }
<a name="l05426"></a>05426       }
<a name="l05427"></a>05427       <span class="comment">// Aknowledge....</span>
<a name="l05428"></a>05428       <span class="keywordflow">if</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == OUR_TEAM &amp;&amp; !fDidSayCoolQuote )
<a name="l05429"></a>05429       {
<a name="l05430"></a>05430             <a class="code" href="Soldier_01Control_8cpp.html#62effc98ffa51ddb2fc78301c82acdb8">DoMercBattleSound</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Soldier_01Control_8h.html#3ab071cf265666f49f6e3f6639d69f0aaaf686dad633392af1290eb32e6713c8">BATTLE_SOUND_GOTIT</a> );
<a name="l05431"></a>05431       }
<a name="l05432"></a>05432       <a class="code" href="Handle_01Items_8cpp.html#0773888b752da630f0adc27e589c3cfd">gpTempSoldier</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l05433"></a>05433       <a class="code" href="Handle_01Items_8cpp.html#2a4f3638cd7bc6c7361fbb6f14de1114">gsTempGridno</a> = sGridNo;
<a name="l05434"></a>05434       <a class="code" href="Timer_01Control_8cpp.html#ea6ae1cc206c97b220fafdb86bf158e5">SetCustomizableTimerCallbackAndDelay</a>( 1000, <a class="code" href="Handle_01Items_8cpp.html#7756ad997efa08df951c7de26ea6d50d">CheckForPickedOwnership</a>, TRUE );
<a name="l05435"></a>05435 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Sep 9 13:48:13 2006 for Build by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
