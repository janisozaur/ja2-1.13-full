<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Build: Keys.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_3179ea33d55a76dc38212d9eab798728.html">export</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e5664b4b56927c8728eb3192fa60e338.html">hdc2</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_1eb12a41a47efb9efcd82fa98f4f4dbd.html">FTP</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_80cc1f21a78ab7941088ea567f236150.html">ja2src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_994ab287602efefceafe55287a3657d6.html">Build</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_43ed33c8f48e75fecb0508860a16371c.html">Tactical</a></div>
<h1>Keys.cpp</h1><a href="Keys_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifdef PRECOMPILEDHEADERS</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">      #include "<a class="code" href="Tactical_01All_8h.html">Tactical All.h</a>"</span>
<a name="l00003"></a>00003 <span class="preprocessor">#else</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor">      #include &lt;stdio.h&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">      #include &lt;memory.h&gt;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">      #include "types.h"</span>
<a name="l00008"></a>00008 <span class="preprocessor">      #include "<a class="code" href="Soldier_01Control_8h.html">Soldier Control.h</a>"</span>
<a name="l00009"></a>00009 <span class="preprocessor">      #include "<a class="code" href="Keys_8h.html">Keys.h</a>"</span>
<a name="l00010"></a>00010 <span class="preprocessor">      #include "debug.h"</span>
<a name="l00011"></a>00011 <span class="preprocessor">      #include "<a class="code" href="Smoothing_01Utils_8h.html">Smoothing Utils.h</a>"</span>
<a name="l00012"></a>00012 <span class="preprocessor">      #include "<a class="code" href="SkillCheck_8h.html">SkillCheck.h</a>"</span>
<a name="l00013"></a>00013 <span class="preprocessor">      #include "<a class="code" href="opplist_8h.html">opplist.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">      #include "items.h"</span>
<a name="l00015"></a>00015 <span class="preprocessor">      #include "weapons.h"</span>
<a name="l00016"></a>00016 <span class="preprocessor">      #include "<a class="code" href="ai_8h.html">ai.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">      #include "<a class="code" href="message_8h.html">message.h</a>"</span>
<a name="l00018"></a>00018 <span class="preprocessor">      #include "text.h"</span>
<a name="l00019"></a>00019 <span class="preprocessor">      #include "explosion control.h"</span>
<a name="l00020"></a>00020 <span class="preprocessor">      #include "isometric utils.h"</span>
<a name="l00021"></a>00021 <span class="preprocessor">      #include "StrategicMap.h"</span>
<a name="l00022"></a>00022 <span class="preprocessor">      #include "<a class="code" href="Tactical_01Save_8h.html">Tactical Save.h</a>"</span>
<a name="l00023"></a>00023 <span class="preprocessor">      #include "<a class="code" href="Campaign_01Types_8h.html">Campaign Types.h</a>"</span>
<a name="l00024"></a>00024 <span class="preprocessor">      #include "los.h"</span>
<a name="l00025"></a>00025 <span class="preprocessor">      #include "<a class="code" href="opplist_8h.html">opplist.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">      #include "tiledat.h"</span>
<a name="l00027"></a>00027 <span class="preprocessor">      #include "overhead.h"</span>
<a name="l00028"></a>00028 <span class="preprocessor">      #include "<a class="code" href="structure_8h.html">structure.h</a>"</span>
<a name="l00029"></a>00029 <span class="preprocessor">      #include "<a class="code" href="renderworld_8h.html">renderworld.h</a>"</span>
<a name="l00030"></a>00030 <span class="preprocessor">      #include "<a class="code" href="worldman_8h.html">worldman.h</a>"</span>
<a name="l00031"></a>00031 <span class="preprocessor">      #include "wcheck.h"</span>
<a name="l00032"></a>00032 <span class="preprocessor">      #include "<a class="code" href="random_8h.html">random.h</a>"</span>
<a name="l00033"></a>00033 <span class="preprocessor">      #include "<a class="code" href="worlddef_8h.html">worlddef.h</a>"</span>
<a name="l00034"></a>00034 <span class="preprocessor">      #include "campaign.h"</span>
<a name="l00035"></a>00035 <span class="preprocessor">      #include "sound control.h"</span>
<a name="l00036"></a>00036 <span class="preprocessor">#endif</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="Keys_8cpp.html#6ba62379372b98e2b7fe5515c9fb7eca">00039</a> <a class="code" href="structDOOR__STATUS.html">DOOR_STATUS</a>       *<a class="code" href="Keys_8cpp.html#6ba62379372b98e2b7fe5515c9fb7eca">gpDoorStatus</a> = NULL;
<a name="l00040"></a><a class="code" href="Keys_8cpp.html#d68fcf80befae7e291fea4ae302713be">00040</a> <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                         <a class="code" href="Keys_8cpp.html#d68fcf80befae7e291fea4ae302713be">gubNumDoorStatus</a>=0;
<a name="l00041"></a>00041 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> <a class="code" href="strategicmap_8cpp.html#01ca3b96c9be3396d25395a427b600b2">gbMercIsNewInThisSector</a>[ MAX_NUM_SOLDIERS ];
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#041a1847b1285f61dea1dedabe2f445d">InternalIsPerceivedDifferentThanReality</a>( <a class="code" href="structDOOR__STATUS.html">DOOR_STATUS</a> *pDoorStatus );
<a name="l00045"></a>00045 <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#145ac35032d0afbd82b707e11812739d">InternalUpdateDoorGraphicFromStatus</a>( <a class="code" href="structDOOR__STATUS.html">DOOR_STATUS</a> *pDoorStatus, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fUsePerceivedStatus, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fDirty );
<a name="l00046"></a>00046 <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#45457afbca611277a89d4a6a60e43b2c">InternalUpdateDoorsPerceivedValue</a>( <a class="code" href="structDOOR__STATUS.html">DOOR_STATUS</a> *pDoorStatus );
<a name="l00047"></a>00047 <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>     <a class="code" href="Keys_8cpp.html#db8b808b372b84d51abc27f557362ea2">InternalSetDoorPerceivedOpenStatus</a>( <a class="code" href="structDOOR__STATUS.html">DOOR_STATUS</a> *pDoorStatus, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fPerceivedOpen );
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="Keys_8h.html#ab8078c8cf4279fff5dff74c95741089">00050</a> <a class="code" href="structKEY.html">KEY</a> <a class="code" href="Keys_8cpp.html#ab8078c8cf4279fff5dff74c95741089">KeyTable</a>[NUM_KEYS] =
<a name="l00051"></a>00051 {
<a name="l00052"></a>00052       <span class="comment">// Item #               Flags       Sector, Date Found</span>
<a name="l00053"></a>00053       <span class="comment">//                                        </span>
<a name="l00054"></a>00054       {<a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f435bcc2bc85513df4f3897a9d64a9c51c">KEY_1</a>,                       0,                0,                0},
<a name="l00055"></a>00055       {<a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f42333d7c312aa98622c41e74c5d13e8de">KEY_2</a>,                       0,                0,                0},
<a name="l00056"></a>00056       {<a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4ef054680a9be7da17d196e15aec894f8">KEY_3</a>,                       0,                0,                0},
<a name="l00057"></a>00057       {<a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4e9f20352b4ef69ae68b9ff44abadfd79">KEY_4</a>,                       0,                0,                0},
<a name="l00058"></a>00058       {<a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4ed864c0209ba46546ba112f6c36e0cc4">KEY_5</a>,                       0,                0,                0},
<a name="l00059"></a>00059       {<a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f42fe7fe99bcb0fd90bf4234be9e4ce5be">KEY_6</a>,                       0,                0,                0},
<a name="l00060"></a>00060       {<a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4e78c88108d428cb8066e7a056195f489">KEY_7</a>,                       0,                0,                0},
<a name="l00061"></a>00061       {<a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4ab8917d426f9be27c95c0d3810006d7b">KEY_8</a>,                       0,                0,                0},
<a name="l00062"></a>00062       {<a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4601382e2da6215882c129b43b3384611">KEY_9</a>,                       0,                0,                0},
<a name="l00063"></a>00063       {<a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f43353acdb1b20de6387db1fab9dd355da">KEY_10</a>,                0,                0,                0}
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 };
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="comment">//Current number of doors in world.</span>
<a name="l00068"></a><a class="code" href="Keys_8h.html#d15527579743a262fc26967caf7d8460">00068</a> <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> <a class="code" href="Keys_8cpp.html#d15527579743a262fc26967caf7d8460">gubNumDoors</a> = 0;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="comment">//Current max number of doors.  This is only used by the editor.  When adding doors to the </span>
<a name="l00071"></a>00071 <span class="comment">//world, we may run out of space in the DoorTable, so we will allocate a new array with extra slots,</span>
<a name="l00072"></a>00072 <span class="comment">//then copy everything over again.  gubMaxDoors holds the arrays actual number of slots, even though</span>
<a name="l00073"></a>00073 <span class="comment">//the current number (gubNumDoors) will be &lt;= to it.</span>
<a name="l00074"></a><a class="code" href="Keys_8h.html#248f6e06b390bc9fcebae99b8f403bfb">00074</a> <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> <a class="code" href="Keys_8cpp.html#248f6e06b390bc9fcebae99b8f403bfb">gubMaxDoors</a> = 0;
<a name="l00075"></a>00075 
<a name="l00076"></a><a class="code" href="Keys_8h.html#493f14b276689fa88b4a321de7f3d781">00076</a> <a class="code" href="structLOCK.html">LOCK</a> <a class="code" href="Keys_8cpp.html#493f14b276689fa88b4a321de7f3d781">LockTable</a>[NUM_LOCKS] = { 0 };
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="comment">/*</span>
<a name="l00079"></a>00079 <span class="comment">LOCK LockTable[NUM_LOCKS] =</span>
<a name="l00080"></a>00080 <span class="comment">{</span>
<a name="l00081"></a>00081 <span class="comment">      // Keys that will open the lock                       Lock type               Pick diff               Smash diff</span>
<a name="l00082"></a>00082 <span class="comment">      { { NO_KEY, NO_KEY, NO_KEY, NO_KEY},      LOCK_REGULAR,                             0,                                  0},</span>
<a name="l00083"></a>00083 <span class="comment">      { { 0,                  NO_KEY, NO_KEY, NO_KEY},      LOCK_REGULAR,                       -25,                          -25},</span>
<a name="l00084"></a>00084 <span class="comment">      { { 1,                  NO_KEY, NO_KEY, NO_KEY},      LOCK_REGULAR,                       -60,                          -55},</span>
<a name="l00085"></a>00085 <span class="comment">      { { 2,                  NO_KEY, NO_KEY, NO_KEY},      LOCK_REGULAR,                       -75,                          -80},</span>
<a name="l00086"></a>00086 <span class="comment">      { { 3,                  NO_KEY, NO_KEY, NO_KEY},      LOCK_REGULAR,                       -35,                          -45},</span>
<a name="l00087"></a>00087 <span class="comment">      { { 4,                  NO_KEY, NO_KEY, NO_KEY},      LOCK_REGULAR,                       -45,                          -60},</span>
<a name="l00088"></a>00088 <span class="comment">      { { 5,                  NO_KEY, NO_KEY, NO_KEY},      LOCK_REGULAR,                       -65,                          -90},</span>
<a name="l00089"></a>00089 <span class="comment">      { { 6,                  NO_KEY, NO_KEY, NO_KEY},      LOCK_PADLOCK,                       -60,                          -70},</span>
<a name="l00090"></a>00090 <span class="comment">      { { 7,                  NO_KEY, NO_KEY, NO_KEY},      LOCK_ELECTRONIC,        -50,                          -60},</span>
<a name="l00091"></a>00091 <span class="comment">      { { 8,                  NO_KEY, NO_KEY, NO_KEY},      LOCK_ELECTRONIC,        -75,                          -80},</span>
<a name="l00092"></a>00092 <span class="comment">      { { 9,                  NO_KEY, NO_KEY, NO_KEY},      LOCK_CARD,                          -50,                          -40},</span>
<a name="l00093"></a>00093 <span class="comment">      { { 10,                 NO_KEY, NO_KEY, NO_KEY},      LOCK_CARD,                          -85,                          -80},</span>
<a name="l00094"></a>00094 <span class="comment">      { { 11,                 NO_KEY, NO_KEY, NO_KEY},      LOCK_REGULAR,                       -50,                          -50}</span>
<a name="l00095"></a>00095 <span class="comment">};</span>
<a name="l00096"></a>00096 <span class="comment">*/</span>
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="Keys_8h.html#313a9e945ab415804e161fcf877ec685">00098</a> <a class="code" href="structDOORTRAP.html">DOORTRAP</a> <a class="code" href="Keys_8cpp.html#313a9e945ab415804e161fcf877ec685">DoorTrapTable</a>[<a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d81ee2b92c52849f7a3c4666566a7d18095">NUM_DOOR_TRAPS</a>] =
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100       { 0 },                                                                                                                                    <span class="comment">// nothing</span>
<a name="l00101"></a>00101       { DOOR_TRAP_STOPS_ACTION },                                                                     <span class="comment">// explosion</span>
<a name="l00102"></a>00102       { DOOR_TRAP_STOPS_ACTION | DOOR_TRAP_RECURRING},      <span class="comment">// electric</span>
<a name="l00103"></a>00103       { DOOR_TRAP_RECURRING },                                                                              <span class="comment">// siren</span>
<a name="l00104"></a>00104       { DOOR_TRAP_RECURRING | DOOR_TRAP_SILENT},                        <span class="comment">// silent alarm</span>
<a name="l00105"></a>00105       { DOOR_TRAP_RECURRING },                                                                              <span class="comment">// brothel siren</span>
<a name="l00106"></a>00106       { DOOR_TRAP_STOPS_ACTION | DOOR_TRAP_RECURRING},      <span class="comment">// super electric</span>
<a name="l00107"></a>00107 };
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">//Dynamic array of Doors.  For general game purposes, the doors that are locked and/or trapped</span>
<a name="l00112"></a>00112 <span class="comment">//are permanently saved within the map, and are loaded and allocated when the map is loaded.  Because</span>
<a name="l00113"></a>00113 <span class="comment">//the editor allows more doors to be added, or removed, the actual size of the DoorTable may change.</span>
<a name="l00114"></a><a class="code" href="Keys_8h.html#fa8779b5515c4e47187eb0ac2e4fe238">00114</a> <a class="code" href="structDOOR.html">DOOR</a> * <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a> = NULL;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="Keys_8h.html#82a5e7ec9ea3f124b57fcb974d213184">00118</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#82a5e7ec9ea3f124b57fcb974d213184">LoadLockTable</a>( <span class="keywordtype">void</span> )
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiNumBytesRead = 0;
<a name="l00121"></a>00121       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiBytesToRead;
<a name="l00122"></a>00122       <a class="code" href="Types_8h.html#2f68f0189367ead40015f7c0ec68eb9e">CHAR8</a> *     pFileName = <span class="stringliteral">"BINARYDATA\\Locks.bin"</span>;
<a name="l00123"></a>00123       <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a>      hFile;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125       <span class="comment">// Load the Lock Table</span>
<a name="l00126"></a>00126 
<a name="l00127"></a>00127       hFile = <a class="code" href="FileMan_8cpp.html#1e5007589e18cbc273b9677470215db4">FileOpen</a>( pFileName, FILE_ACCESS_READ, FALSE );
<a name="l00128"></a>00128       <span class="keywordflow">if</span>( !hFile )
<a name="l00129"></a>00129       {
<a name="l00130"></a>00130             DebugMsg( <a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>, DBG_LEVEL_3, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"FAILED to LoadLockTable from file %s"</span>, pFileName) );
<a name="l00131"></a>00131             <span class="keywordflow">return</span>(FALSE);
<a name="l00132"></a>00132       }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134       uiBytesToRead = <span class="keyword">sizeof</span>( <a class="code" href="structLOCK.html">LOCK</a> ) * NUM_LOCKS;
<a name="l00135"></a>00135       <a class="code" href="FileMan_8cpp.html#1b213074411fd4c1dc8fd345e787b17e">FileRead</a>( hFile, <a class="code" href="Keys_8cpp.html#493f14b276689fa88b4a321de7f3d781">LockTable</a>, uiBytesToRead, &amp;uiNumBytesRead );
<a name="l00136"></a>00136 
<a name="l00137"></a>00137       <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l00138"></a>00138 
<a name="l00139"></a>00139       <span class="keywordflow">if</span> ( uiNumBytesRead != uiBytesToRead )
<a name="l00140"></a>00140       {
<a name="l00141"></a>00141             <span class="keywordflow">return</span>( FALSE );
<a name="l00142"></a>00142       }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144       <span class="keywordflow">return</span>( TRUE );
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="Keys_8h.html#66dd462e88f04bd257d71453111f0b01">00149</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#66dd462e88f04bd257d71453111f0b01">SoldierHasKey</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubKeyID )
<a name="l00150"></a>00150 {
<a name="l00151"></a>00151       <span class="keywordflow">if</span> ( <a class="code" href="Keys_8cpp.html#26f3b0d00fd69de2f8d657b65d607c09">KeyExistsInKeyRing</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubKeyID, NULL ) || <a class="code" href="Keys_8cpp.html#2828235e5793b77fcc33bb9d0eaec7ca">KeyExistsInInventory</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubKeyID ) )
<a name="l00152"></a>00152       {
<a name="l00153"></a>00153             <span class="keywordflow">return</span>( TRUE );
<a name="l00154"></a>00154       }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156       <span class="keywordflow">return</span>( FALSE );
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00159"></a><a class="code" href="Keys_8h.html#26f3b0d00fd69de2f8d657b65d607c09">00159</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#26f3b0d00fd69de2f8d657b65d607c09">KeyExistsInKeyRing</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubKeyID, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> * pubPos )
<a name="l00160"></a>00160 {
<a name="l00161"></a>00161       <span class="comment">// returns the index into the key ring where the key can be found</span>
<a name="l00162"></a>00162       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>       ubLoop;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164       <span class="keywordflow">if</span> (!(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5eb793cec0b17373b557d44083fa6dcb">pKeyRing</a>))
<a name="l00165"></a>00165       {
<a name="l00166"></a>00166             <span class="comment">// no key ring!</span>
<a name="l00167"></a>00167             <span class="keywordflow">return</span>( FALSE );
<a name="l00168"></a>00168       }
<a name="l00169"></a>00169       <span class="keywordflow">for</span> (ubLoop = 0; ubLoop &lt; NUM_KEYS; ubLoop++)
<a name="l00170"></a>00170       {
<a name="l00171"></a>00171             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5eb793cec0b17373b557d44083fa6dcb">pKeyRing</a>[ubLoop].<a class="code" href="structKEY__ON__RING.html#102d2f6c111966fefffe296bfbb1173e">ubNumber</a> == 0)
<a name="l00172"></a>00172             {
<a name="l00173"></a>00173                   <span class="keywordflow">continue</span>;
<a name="l00174"></a>00174             }
<a name="l00175"></a>00175             <span class="keywordflow">if</span> (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5eb793cec0b17373b557d44083fa6dcb">pKeyRing</a>[ubLoop].<a class="code" href="structKEY__ON__RING.html#3ce49bfe5961be0d65ba15667e8cf633">ubKeyID</a> == ubKeyID || (ubKeyID == ANYKEY) )
<a name="l00176"></a>00176             {
<a name="l00177"></a>00177                   <span class="comment">// found it!</span>
<a name="l00178"></a>00178                   <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> (pubPos)
<a name="l00179"></a>00179                   {
<a name="l00180"></a>00180                         *pubPos = ubLoop;
<a name="l00181"></a>00181                   }
<a name="l00182"></a>00182                   <span class="keywordflow">return</span>( TRUE );
<a name="l00183"></a>00183             }
<a name="l00184"></a>00184       }
<a name="l00185"></a>00185       <span class="comment">// exhausted key ring</span>
<a name="l00186"></a>00186       <span class="keywordflow">return</span>( FALSE );
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="Keys_8h.html#2828235e5793b77fcc33bb9d0eaec7ca">00189</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#2828235e5793b77fcc33bb9d0eaec7ca">KeyExistsInInventory</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubKeyID )
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                   ubLoop;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193       <span class="keywordflow">for</span> (ubLoop = 0; ubLoop &lt; <a class="code" href="Soldier_01Control_8h.html#2a5937706f1724c8f06a0396bdc878553e9a668bdf9e2a72b855424ee1bdabcf">NUM_INV_SLOTS</a>; ubLoop++)
<a name="l00194"></a>00194       {
<a name="l00195"></a>00195             <span class="keywordflow">if</span> (<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ubLoop].<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>].usItemClass == IC_KEY)
<a name="l00196"></a>00196             {
<a name="l00197"></a>00197                   <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( (<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ubLoop].<a class="code" href="structOBJECTTYPE.html#262fe136aa239969a351b4b1ca83008c">ubKeyID</a> == ubKeyID) || (ubKeyID == ANYKEY) )
<a name="l00198"></a>00198                   {
<a name="l00199"></a>00199                         <span class="comment">// there's the key we want!</span>
<a name="l00200"></a>00200                         <span class="keywordflow">return</span>( TRUE );
<a name="l00201"></a>00201                   }
<a name="l00202"></a>00202             }
<a name="l00203"></a>00203       }
<a name="l00204"></a>00204       <span class="keywordflow">return</span>( FALSE );
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 
<a name="l00208"></a><a class="code" href="Keys_8cpp.html#c442dc6a516bf6e46aa01bfea207e197">00208</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#c442dc6a516bf6e46aa01bfea207e197">ValidKey</a>( <a class="code" href="structDOOR.html">DOOR</a> * pDoor, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubKeyID )
<a name="l00209"></a>00209 {
<a name="l00210"></a>00210       <span class="keywordflow">return</span> (pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a> == ubKeyID);
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00213"></a><a class="code" href="Keys_8cpp.html#6550bbcd7840f4095ca07961fd98b04a">00213</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#6550bbcd7840f4095ca07961fd98b04a">DoLockDoor</a>( <a class="code" href="structDOOR.html">DOOR</a> * pDoor, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubKeyID )
<a name="l00214"></a>00214 {
<a name="l00215"></a>00215       <span class="comment">// if the door is unlocked and this is the right key, lock the door and</span>
<a name="l00216"></a>00216       <span class="comment">// return true, otherwise return false</span>
<a name="l00217"></a>00217       <span class="keywordflow">if</span> (!(pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a>) &amp;&amp; <a class="code" href="Keys_8cpp.html#c442dc6a516bf6e46aa01bfea207e197">ValidKey</a>( pDoor, ubKeyID ))
<a name="l00218"></a>00218       {
<a name="l00219"></a>00219             pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a> = TRUE;
<a name="l00220"></a>00220             <span class="keywordflow">return</span>( TRUE );
<a name="l00221"></a>00221       }
<a name="l00222"></a>00222       <span class="keywordflow">else</span>
<a name="l00223"></a>00223       {
<a name="l00224"></a>00224             <span class="keywordflow">return</span>( FALSE );
<a name="l00225"></a>00225       }
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a><a class="code" href="Keys_8cpp.html#5ae6bce28c433868e73faca6e49eb712">00228</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#5ae6bce28c433868e73faca6e49eb712">DoUnlockDoor</a>( <a class="code" href="structDOOR.html">DOOR</a> * pDoor, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubKeyID )
<a name="l00229"></a>00229 {
<a name="l00230"></a>00230       <span class="comment">// if the door is locked and this is the right key, unlock the door and</span>
<a name="l00231"></a>00231       <span class="comment">// return true, otherwise return false</span>
<a name="l00232"></a>00232       <span class="keywordflow">if</span> ( (pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a>) &amp;&amp; <a class="code" href="Keys_8cpp.html#c442dc6a516bf6e46aa01bfea207e197">ValidKey</a>( pDoor, ubKeyID ))
<a name="l00233"></a>00233       {
<a name="l00234"></a>00234             <span class="comment">// Play lockpicking</span>
<a name="l00235"></a>00235             <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( ( (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5bae8ad281445257b23084bb5d5bcb4bc">UNLOCK_DOOR_1</a> ), RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( MIDVOLUME, pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> ), 1, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> ) );                 
<a name="l00236"></a>00236 
<a name="l00237"></a>00237             pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a> = FALSE;
<a name="l00238"></a>00238             <span class="keywordflow">return</span>( TRUE );
<a name="l00239"></a>00239       }
<a name="l00240"></a>00240       <span class="keywordflow">else</span>
<a name="l00241"></a>00241       {
<a name="l00242"></a>00242             <span class="keywordflow">return</span>( FALSE );
<a name="l00243"></a>00243       }
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="Keys_8h.html#f194e648e5d9acab4a49fce000f87d76">00246</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#f194e648e5d9acab4a49fce000f87d76">AttemptToUnlockDoor</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structDOOR.html">DOOR</a> * pDoor )
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>       ubLoop;
<a name="l00249"></a>00249       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>       ubKeyID;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251       <span class="keywordflow">for</span>( ubLoop = 0; ubLoop &lt; MAX_KEYS_PER_LOCK; ubLoop++)
<a name="l00252"></a>00252       {
<a name="l00253"></a>00253             ubKeyID = pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a>;
<a name="l00254"></a>00254             <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> (<a class="code" href="Keys_8cpp.html#26f3b0d00fd69de2f8d657b65d607c09">KeyExistsInKeyRing</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubKeyID, NULL ))
<a name="l00255"></a>00255             {
<a name="l00256"></a>00256                   <span class="comment">// unlock door and move key to front of key ring!</span>
<a name="l00257"></a>00257                   <a class="code" href="Keys_8cpp.html#5ae6bce28c433868e73faca6e49eb712">DoUnlockDoor</a>( pDoor, ubKeyID );
<a name="l00258"></a>00258                   <span class="keywordflow">return</span>( TRUE );
<a name="l00259"></a>00259             }
<a name="l00260"></a>00260             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Keys_8cpp.html#2828235e5793b77fcc33bb9d0eaec7ca">KeyExistsInInventory</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubKeyID ))
<a name="l00261"></a>00261             {
<a name="l00262"></a>00262                   <span class="comment">// unlock door!</span>
<a name="l00263"></a>00263                   <a class="code" href="Keys_8cpp.html#5ae6bce28c433868e73faca6e49eb712">DoUnlockDoor</a>( pDoor, ubKeyID );
<a name="l00264"></a>00264                   <span class="keywordflow">return</span>( TRUE );
<a name="l00265"></a>00265             }
<a name="l00266"></a>00266       }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268       <span class="comment">// drat, couldn't find the key</span>
<a name="l00269"></a>00269       <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b56326accc3fcba2892613f502e3c70329">KEY_FAILURE</a>, RATE_11025, MIDVOLUME, 1, MIDDLEPAN );                  
<a name="l00270"></a>00270       
<a name="l00271"></a>00271       <span class="keywordflow">return</span>( FALSE );
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a><a class="code" href="Keys_8h.html#6e87d54ec5732661bcbe399345829d0b">00274</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#6e87d54ec5732661bcbe399345829d0b">AttemptToLockDoor</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structDOOR.html">DOOR</a> * pDoor )
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>       ubLoop;
<a name="l00277"></a>00277       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>       ubKeyID;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279       <span class="keywordflow">for</span>( ubLoop = 0; ubLoop &lt; MAX_KEYS_PER_LOCK; ubLoop++)
<a name="l00280"></a>00280       {
<a name="l00281"></a>00281             ubKeyID = pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a>;
<a name="l00282"></a>00282             <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> (<a class="code" href="Keys_8cpp.html#26f3b0d00fd69de2f8d657b65d607c09">KeyExistsInKeyRing</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubKeyID, NULL ))
<a name="l00283"></a>00283             {
<a name="l00284"></a>00284                   <span class="comment">// lock door and move key to front of key ring!</span>
<a name="l00285"></a>00285                   <a class="code" href="Keys_8cpp.html#6550bbcd7840f4095ca07961fd98b04a">DoLockDoor</a>( pDoor, ubKeyID );
<a name="l00286"></a>00286                   <span class="keywordflow">return</span>( TRUE );
<a name="l00287"></a>00287             }
<a name="l00288"></a>00288             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="Keys_8cpp.html#2828235e5793b77fcc33bb9d0eaec7ca">KeyExistsInInventory</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, ubKeyID ))
<a name="l00289"></a>00289             {
<a name="l00290"></a>00290                   <span class="comment">// lock door!</span>
<a name="l00291"></a>00291                   <a class="code" href="Keys_8cpp.html#6550bbcd7840f4095ca07961fd98b04a">DoLockDoor</a>( pDoor, ubKeyID );
<a name="l00292"></a>00292                   <span class="keywordflow">return</span>( TRUE );
<a name="l00293"></a>00293             }
<a name="l00294"></a>00294       }
<a name="l00295"></a>00295       <span class="comment">// drat, couldn't find the key</span>
<a name="l00296"></a>00296       <span class="keywordflow">return</span>( FALSE );
<a name="l00297"></a>00297 }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 
<a name="l00300"></a><a class="code" href="Keys_8h.html#6b2cddf606e85bb9711c536d9f481fc1">00300</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#6b2cddf606e85bb9711c536d9f481fc1">AttemptToCrowbarLock</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structDOOR.html">DOOR</a> * pDoor )
<a name="l00301"></a>00301 {
<a name="l00302"></a>00302       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>       iResult;
<a name="l00303"></a>00303       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>        bStress, bSlot;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305       bSlot = <a class="code" href="Items_8cpp.html#e85df74933dff15bc8ebcbf39cf06002">FindUsableCrowbar</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00306"></a>00306       <span class="keywordflow">if</span> ( bSlot == ITEM_NOT_FOUND )
<a name="l00307"></a>00307       {
<a name="l00308"></a>00308             <span class="comment">// error!</span>
<a name="l00309"></a>00309             <span class="keywordflow">return</span>( FALSE );
<a name="l00310"></a>00310       }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312       <span class="comment">// generate a noise for thumping on the door</span>
<a name="l00313"></a>00313       <a class="code" href="opplist_8cpp.html#dd89235e898eba71e64fe3269ad08e25">MakeNoise</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>].ubTerrainID, CROWBAR_DOOR_VOLUME, <a class="code" href="opplist_8h.html#8585c80e32993102dff78219f1bf177dd033c47f18e243e231bc62f6ec968eb1">NOISE_DOOR_SMASHING</a> );
<a name="l00314"></a>00314 
<a name="l00315"></a>00315       <span class="keywordflow">if</span> ( !pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a> )
<a name="l00316"></a>00316       {
<a name="l00317"></a>00317             <span class="comment">// auto success but no XP</span>
<a name="l00318"></a>00318 
<a name="l00319"></a>00319             <span class="comment">// succeeded! door can never be locked again, so remove from door list...</span>
<a name="l00320"></a>00320             <a class="code" href="Keys_8cpp.html#8a69ba6d1f5ba8d176f6f8c75097af0c">RemoveDoorInfoFromTable</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> );
<a name="l00321"></a>00321             <span class="comment">// award experience points?</span>
<a name="l00322"></a>00322 
<a name="l00323"></a>00323             <span class="comment">// Play lock busted sound</span>
<a name="l00324"></a>00324             <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( ( (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5d709a80a794710449e635213c9142980">BREAK_LOCK</a> ), RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( MIDVOLUME, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ), 1, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ) );              
<a name="l00325"></a>00325 
<a name="l00326"></a>00326             <span class="keywordflow">return</span>( TRUE );
<a name="l00327"></a>00327       }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329       <span class="keywordflow">if</span> ( pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a> == LOCK_UNOPENABLE )
<a name="l00330"></a>00330       {
<a name="l00331"></a>00331             <span class="comment">// auto failure!</span>
<a name="l00332"></a>00332             <span class="keywordflow">return</span>( FALSE );
<a name="l00333"></a>00333       }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335       <span class="comment">// possibly damage crowbar</span>
<a name="l00336"></a>00336       bStress = __min( <a class="code" href="SkillCheck_8cpp.html#3b47762eea82938c2f52367cd11ffea0">EffectiveStrength</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> ), <a class="code" href="Keys_8cpp.html#493f14b276689fa88b4a321de7f3d781">LockTable</a>[pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a>].ubSmashDifficulty + 30 );
<a name="l00337"></a>00337       <span class="comment">// reduce crowbar status by random % between 0 and 5%</span>
<a name="l00338"></a>00338       <a class="code" href="Items_8cpp.html#1aaefdb8eb43a04a10d9fd9d8550b94e">DamageObj</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ bSlot ]), (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( bStress / 20 ) );
<a name="l00339"></a>00339 
<a name="l00340"></a>00340       <span class="comment">// did we succeed?</span>
<a name="l00341"></a>00341 
<a name="l00342"></a>00342       <span class="keywordflow">if</span> ( <a class="code" href="Keys_8cpp.html#493f14b276689fa88b4a321de7f3d781">LockTable</a>[pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a>].ubSmashDifficulty == OPENING_NOT_POSSIBLE )
<a name="l00343"></a>00343       {
<a name="l00344"></a>00344             <span class="comment">// do this to get 'can't do this' messages</span>
<a name="l00345"></a>00345             iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e40d257a07c4889e6389e8607bbcc18f3a">OPEN_WITH_CROWBAR</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) ( -100 ) );
<a name="l00346"></a>00346             iResult = -100;
<a name="l00347"></a>00347       }
<a name="l00348"></a>00348       <span class="keywordflow">else</span>
<a name="l00349"></a>00349       {
<a name="l00350"></a>00350             iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e40d257a07c4889e6389e8607bbcc18f3a">OPEN_WITH_CROWBAR</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) ( - (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (<a class="code" href="Keys_8cpp.html#493f14b276689fa88b4a321de7f3d781">LockTable</a>[pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a>].ubSmashDifficulty - pDoor-&gt;<a class="code" href="structDOOR.html#5ce39a5852723dcb4a9a643e6b5c0b46">bLockDamage</a>) ) );
<a name="l00351"></a>00351       }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353       <span class="keywordflow">if</span> (iResult &gt; 0)
<a name="l00354"></a>00354       {
<a name="l00355"></a>00355     <span class="comment">// STR GAIN (20) - Pried open a lock</span>
<a name="l00356"></a>00356     <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, STRAMT, 20, FALSE );
<a name="l00357"></a>00357 
<a name="l00358"></a>00358             <span class="comment">// succeeded! door can never be locked again, so remove from door list...</span>
<a name="l00359"></a>00359             <a class="code" href="Keys_8cpp.html#8a69ba6d1f5ba8d176f6f8c75097af0c">RemoveDoorInfoFromTable</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> );
<a name="l00360"></a>00360 
<a name="l00361"></a>00361             <span class="comment">// Play lock busted sound</span>
<a name="l00362"></a>00362             <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( ( (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5d709a80a794710449e635213c9142980">BREAK_LOCK</a> ), RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( MIDVOLUME, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ), 1, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ) );              
<a name="l00363"></a>00363 
<a name="l00364"></a>00364             <span class="keywordflow">return</span>( TRUE );
<a name="l00365"></a>00365       }
<a name="l00366"></a>00366       <span class="keywordflow">else</span>
<a name="l00367"></a>00367       {
<a name="l00368"></a>00368             <span class="keywordflow">if</span> (iResult &gt; -10)
<a name="l00369"></a>00369             {
<a name="l00370"></a>00370                   <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_YELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe72b67e8f39e5b56cddda35cb2a5ca96d3">LOCK_HAS_BEEN_HIT</a> ] );  
<a name="l00371"></a>00371 
<a name="l00372"></a>00372                   <span class="comment">// STR GAIN - Damaged a lock by prying</span>
<a name="l00373"></a>00373                   <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, STRAMT, 5, FALSE );
<a name="l00374"></a>00374 
<a name="l00375"></a>00375                   <span class="comment">// we came close... so do some damage to the lock</span>
<a name="l00376"></a>00376                   pDoor-&gt;<a class="code" href="structDOOR.html#5ce39a5852723dcb4a9a643e6b5c0b46">bLockDamage</a> += (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (10 + iResult);
<a name="l00377"></a>00377             }
<a name="l00378"></a>00378             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( iResult &gt; -40 &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c799c14dd2af5ca54abbf0839c9bb8c8">sSkillCheckGridNo</a> )
<a name="l00379"></a>00379             {
<a name="l00380"></a>00380                   <span class="comment">// give token point for effort :-)</span>
<a name="l00381"></a>00381                   <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, STRAMT, 1, FALSE );
<a name="l00382"></a>00382             }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384             <span class="keywordflow">return</span>( FALSE );
<a name="l00385"></a>00385       }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389 
<a name="l00390"></a><a class="code" href="Keys_8h.html#afba528dc22d1c069cd1428f07142442">00390</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#afba528dc22d1c069cd1428f07142442">AttemptToSmashDoor</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structDOOR.html">DOOR</a> * pDoor )
<a name="l00391"></a>00391 {
<a name="l00392"></a>00392       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>       iResult;
<a name="l00393"></a>00393 
<a name="l00394"></a>00394       <a class="code" href="structLOCK.html">LOCK</a> * pLock;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396       <span class="comment">// generate a noise for thumping on the door</span>
<a name="l00397"></a>00397       <a class="code" href="opplist_8cpp.html#dd89235e898eba71e64fe3269ad08e25">MakeNoise</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#0d1f73c5d0ac839ec84a4792505949cb">bLevel</a>, <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>].ubTerrainID, SMASHING_DOOR_VOLUME, <a class="code" href="opplist_8h.html#8585c80e32993102dff78219f1bf177dd033c47f18e243e231bc62f6ec968eb1">NOISE_DOOR_SMASHING</a> );
<a name="l00398"></a>00398 
<a name="l00399"></a>00399       <span class="keywordflow">if</span> ( !pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a> )
<a name="l00400"></a>00400       {
<a name="l00401"></a>00401             <span class="comment">// auto success but no XP</span>
<a name="l00402"></a>00402 
<a name="l00403"></a>00403             <span class="comment">// succeeded! door can never be locked again, so remove from door list...</span>
<a name="l00404"></a>00404             <a class="code" href="Keys_8cpp.html#8a69ba6d1f5ba8d176f6f8c75097af0c">RemoveDoorInfoFromTable</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> );
<a name="l00405"></a>00405             <span class="comment">// award experience points?</span>
<a name="l00406"></a>00406 
<a name="l00407"></a>00407             <span class="comment">// Play lock busted sound</span>
<a name="l00408"></a>00408             <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( ( (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5d709a80a794710449e635213c9142980">BREAK_LOCK</a> ), RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( MIDVOLUME, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ), 1, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ) );              
<a name="l00409"></a>00409 
<a name="l00410"></a>00410             <span class="keywordflow">return</span>( TRUE );
<a name="l00411"></a>00411       }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413       <span class="keywordflow">if</span> ( pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a> == LOCK_UNOPENABLE )
<a name="l00414"></a>00414       {
<a name="l00415"></a>00415             <span class="comment">// auto failure!</span>
<a name="l00416"></a>00416             <span class="keywordflow">return</span>( FALSE );
<a name="l00417"></a>00417       }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419       pLock = &amp;(<a class="code" href="Keys_8cpp.html#493f14b276689fa88b4a321de7f3d781">LockTable</a>[pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a>]);
<a name="l00420"></a>00420 
<a name="l00421"></a>00421       <span class="comment">// did we succeed?</span>
<a name="l00422"></a>00422       <span class="keywordflow">if</span> ( pLock-&gt;<a class="code" href="structLOCK.html#8c1e7740c7011fe771f840448007311b">ubSmashDifficulty</a> == OPENING_NOT_POSSIBLE )
<a name="l00423"></a>00423       {
<a name="l00424"></a>00424             <span class="comment">// do this to get 'can't do this' messages</span>
<a name="l00425"></a>00425             iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e4b18be7ecf53f624f9bd883698bfe735e">SMASH_DOOR_CHECK</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) ( -100 ) );
<a name="l00426"></a>00426             iResult = -100;
<a name="l00427"></a>00427       }
<a name="l00428"></a>00428       <span class="keywordflow">else</span>
<a name="l00429"></a>00429       {
<a name="l00430"></a>00430             iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e4b18be7ecf53f624f9bd883698bfe735e">SMASH_DOOR_CHECK</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) ( - (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (<a class="code" href="Keys_8cpp.html#493f14b276689fa88b4a321de7f3d781">LockTable</a>[pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a>].ubSmashDifficulty - pDoor-&gt;<a class="code" href="structDOOR.html#5ce39a5852723dcb4a9a643e6b5c0b46">bLockDamage</a>) ) );
<a name="l00431"></a>00431       }
<a name="l00432"></a>00432       <span class="keywordflow">if</span> (iResult &gt; 0)
<a name="l00433"></a>00433       {
<a name="l00434"></a>00434     <span class="comment">// STR GAIN (20) - Pried open a lock</span>
<a name="l00435"></a>00435     <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, STRAMT, 20, FALSE );
<a name="l00436"></a>00436 
<a name="l00437"></a>00437             <span class="comment">// succeeded! door can never be locked again, so remove from door list...</span>
<a name="l00438"></a>00438             <a class="code" href="Keys_8cpp.html#8a69ba6d1f5ba8d176f6f8c75097af0c">RemoveDoorInfoFromTable</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> );
<a name="l00439"></a>00439             <span class="comment">// award experience points?</span>
<a name="l00440"></a>00440 
<a name="l00441"></a>00441             <span class="comment">// Play lock busted sound</span>
<a name="l00442"></a>00442             <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( ( (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>)<a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5d709a80a794710449e635213c9142980">BREAK_LOCK</a> ), RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( MIDVOLUME, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ), 1, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ) );              
<a name="l00443"></a>00443 
<a name="l00444"></a>00444             <span class="keywordflow">return</span>( TRUE );
<a name="l00445"></a>00445       }
<a name="l00446"></a>00446       <span class="keywordflow">else</span>
<a name="l00447"></a>00447       {
<a name="l00448"></a>00448             <span class="keywordflow">if</span> (iResult &gt; -10)
<a name="l00449"></a>00449             {
<a name="l00450"></a>00450                   <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_YELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe72b67e8f39e5b56cddda35cb2a5ca96d3">LOCK_HAS_BEEN_HIT</a> ] );  
<a name="l00451"></a>00451 
<a name="l00452"></a>00452                   <span class="comment">// STR GAIN - Damaged a lock by prying</span>
<a name="l00453"></a>00453                   <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, STRAMT, 5, FALSE );
<a name="l00454"></a>00454 
<a name="l00455"></a>00455                   <span class="comment">// we came close... so do some damage to the lock</span>
<a name="l00456"></a>00456                   pDoor-&gt;<a class="code" href="structDOOR.html#5ce39a5852723dcb4a9a643e6b5c0b46">bLockDamage</a> += (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (10 + iResult);
<a name="l00457"></a>00457             }
<a name="l00458"></a>00458             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( iResult &gt; -40 &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#c799c14dd2af5ca54abbf0839c9bb8c8">sSkillCheckGridNo</a> )
<a name="l00459"></a>00459             {
<a name="l00460"></a>00460                   <span class="comment">// give token point for effort :-)</span>
<a name="l00461"></a>00461                   <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, STRAMT, 1, FALSE );
<a name="l00462"></a>00462             }
<a name="l00463"></a>00463             <span class="keywordflow">return</span>( FALSE );
<a name="l00464"></a>00464       }
<a name="l00465"></a>00465 }
<a name="l00466"></a>00466 
<a name="l00467"></a><a class="code" href="Keys_8h.html#7da83aae572e75eac56f3eeed957ae37">00467</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#7da83aae572e75eac56f3eeed957ae37">AttemptToPickLock</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structDOOR.html">DOOR</a> * pDoor )
<a name="l00468"></a>00468 {
<a name="l00469"></a>00469       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iResult;
<a name="l00470"></a>00470       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bReason;
<a name="l00471"></a>00471       <a class="code" href="structLOCK.html">LOCK</a> * pLock;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473       <span class="keywordflow">if</span> ( pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a> == LOCK_UNOPENABLE )
<a name="l00474"></a>00474       {
<a name="l00475"></a>00475             <span class="comment">// auto failure!</span>
<a name="l00476"></a>00476             <span class="keywordflow">return</span>( FALSE );
<a name="l00477"></a>00477       }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479       pLock = &amp;(<a class="code" href="Keys_8cpp.html#493f14b276689fa88b4a321de7f3d781">LockTable</a>[pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a>]);
<a name="l00480"></a>00480 
<a name="l00481"></a>00481       <span class="comment">// look up the type of lock to see if it is electronic or not</span>
<a name="l00482"></a>00482       <span class="keywordflow">if</span> (pLock-&gt;<a class="code" href="structLOCK.html#a39121e560cf265e192923cef6803666">ubLockType</a> == LOCK_CARD || pLock-&gt;<a class="code" href="structLOCK.html#a39121e560cf265e192923cef6803666">ubLockType</a> == LOCK_ELECTRONIC )
<a name="l00483"></a>00483       {
<a name="l00484"></a>00484             bReason = <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e4fccd0cd63758fa47b15215b6f34f7d74">ELECTRONIC_LOCKPICKING_CHECK</a>;
<a name="l00485"></a>00485       }
<a name="l00486"></a>00486       <span class="keywordflow">else</span>
<a name="l00487"></a>00487       {
<a name="l00488"></a>00488             bReason = <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e485c63bb8e1d32279364becff39161b88">LOCKPICKING_CHECK</a>;
<a name="l00489"></a>00489       }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491       <span class="comment">// Play lockpicking</span>
<a name="l00492"></a>00492       <span class="comment">// ATE: Moved to animation</span>
<a name="l00493"></a>00493       <span class="comment">//PlayJA2Sample( ( (UINT8)PICKING_LOCK ), RATE_11025, SoundVolume( MIDVOLUME, pSoldier-&gt;sGridNo ), 1, SoundDir( pSoldier-&gt;sGridNo ) );                </span>
<a name="l00494"></a>00494 
<a name="l00495"></a>00495       <span class="comment">// See if we measure up to the task.  </span>
<a name="l00496"></a>00496       <span class="comment">// The difficulty is negated here to make it a skill adjustment</span>
<a name="l00497"></a>00497       <span class="keywordflow">if</span> ( pLock-&gt;<a class="code" href="structLOCK.html#01b7aef1e166f5341004fdd34df9994d">ubPickDifficulty</a> == OPENING_NOT_POSSIBLE )
<a name="l00498"></a>00498       {
<a name="l00499"></a>00499             <span class="comment">// do this to get 'can't do this' messages</span>
<a name="l00500"></a>00500             iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, bReason, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) ( -100 ) );
<a name="l00501"></a>00501             iResult = -100;
<a name="l00502"></a>00502       }
<a name="l00503"></a>00503       <span class="keywordflow">else</span>
<a name="l00504"></a>00504       {
<a name="l00505"></a>00505             iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, bReason, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) ( - (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (pLock-&gt;<a class="code" href="structLOCK.html#01b7aef1e166f5341004fdd34df9994d">ubPickDifficulty</a>) ) );
<a name="l00506"></a>00506       }
<a name="l00507"></a>00507       <span class="keywordflow">if</span> (iResult &gt; 0)
<a name="l00508"></a>00508       {
<a name="l00509"></a>00509         <span class="comment">// MECHANICAL GAIN:  Picked open a lock</span>
<a name="l00510"></a>00510     <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, MECHANAMT, ( <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> ) ( pLock-&gt;<a class="code" href="structLOCK.html#01b7aef1e166f5341004fdd34df9994d">ubPickDifficulty</a> / 5 ), FALSE );
<a name="l00511"></a>00511 
<a name="l00512"></a>00512         <span class="comment">// DEXTERITY GAIN:  Picked open a lock</span>
<a name="l00513"></a>00513     <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, DEXTAMT, ( <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> ) ( pLock-&gt;<a class="code" href="structLOCK.html#01b7aef1e166f5341004fdd34df9994d">ubPickDifficulty</a> / 10 ), FALSE );
<a name="l00514"></a>00514 
<a name="l00515"></a>00515             <span class="comment">// WISDOM GAIN:  Picked open a lock (Snap)</span>
<a name="l00516"></a>00516             <span class="keywordflow">if</span> ( bReason == <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e4fccd0cd63758fa47b15215b6f34f7d74">ELECTRONIC_LOCKPICKING_CHECK</a> )
<a name="l00517"></a>00517                 <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, WISDOMAMT, ( <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> ) ( pLock-&gt;<a class="code" href="structLOCK.html#01b7aef1e166f5341004fdd34df9994d">ubPickDifficulty</a> / 10 ), FALSE );
<a name="l00518"></a>00518             <span class="keywordflow">else</span>
<a name="l00519"></a>00519                 <a class="code" href="Campaign_8cpp.html#52fdd1cf34ce93451b918b35dca190b3">StatChange</a>( pSoldier, WISDOMAMT, ( <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> ) ( pLock-&gt;<a class="code" href="structLOCK.html#01b7aef1e166f5341004fdd34df9994d">ubPickDifficulty</a> / 15 ), FALSE );
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 
<a name="l00522"></a>00522 
<a name="l00523"></a>00523             <span class="comment">// succeeded!</span>
<a name="l00524"></a>00524             pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a> = FALSE;
<a name="l00525"></a>00525             <span class="keywordflow">return</span>( TRUE );
<a name="l00526"></a>00526       }
<a name="l00527"></a>00527       <span class="keywordflow">else</span>
<a name="l00528"></a>00528       {
<a name="l00529"></a>00529             <span class="comment">// NOTE: failures are not rewarded, since you can keep trying indefinitely...</span>
<a name="l00530"></a>00530 
<a name="l00531"></a>00531             <span class="comment">// check for traps</span>
<a name="l00532"></a>00532             <span class="keywordflow">return</span>( FALSE );
<a name="l00533"></a>00533       }
<a name="l00534"></a>00534 }
<a name="l00535"></a>00535 
<a name="l00536"></a><a class="code" href="Keys_8h.html#28a309ff378a0f22ce6f9065b5e5f012">00536</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#28a309ff378a0f22ce6f9065b5e5f012">AttemptToUntrapDoor</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structDOOR.html">DOOR</a> * pDoor )
<a name="l00537"></a>00537 {
<a name="l00538"></a>00538       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>       iResult;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540       <span class="comment">// See if we measure up to the task.  </span>
<a name="l00541"></a>00541       <span class="keywordflow">if</span> ( pDoor-&gt;<a class="code" href="structDOOR.html#13bd94a4823fe1713a89d6af26439516">ubTrapID</a> == <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d810755372f61dedcc3e20ca0324c1b5652">EXPLOSION</a>  )
<a name="l00542"></a>00542       {
<a name="l00543"></a>00543             iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e41fa1bcc5c870a7ebfde254bdc841c716">DISARM_TRAP_CHECK</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (pDoor-&gt;<a class="code" href="structDOOR.html#1f53f276ffcc76b8dbf3eb0ebffb9dcb">ubTrapLevel</a> * 7) );
<a name="l00544"></a>00544       }
<a name="l00545"></a>00545       <span class="keywordflow">else</span>
<a name="l00546"></a>00546       {
<a name="l00547"></a>00547             iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e474b5413ecf40a95ce5049e51cb093f18">DISARM_ELECTRONIC_TRAP_CHECK</a>, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>) (pDoor-&gt;<a class="code" href="structDOOR.html#1f53f276ffcc76b8dbf3eb0ebffb9dcb">ubTrapLevel</a> * 7) );
<a name="l00548"></a>00548       }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550       <span class="keywordflow">if</span> (iResult &gt; 0)
<a name="l00551"></a>00551       {
<a name="l00552"></a>00552             <span class="comment">// succeeded!</span>
<a name="l00553"></a>00553             pDoor-&gt;<a class="code" href="structDOOR.html#1f53f276ffcc76b8dbf3eb0ebffb9dcb">ubTrapLevel</a> = 0;
<a name="l00554"></a>00554             pDoor-&gt;<a class="code" href="structDOOR.html#13bd94a4823fe1713a89d6af26439516">ubTrapID</a> = <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d81015e9806ec7c994503df311d726b4daf">NO_TRAP</a>;
<a name="l00555"></a>00555             <span class="keywordflow">return</span>( TRUE );
<a name="l00556"></a>00556       }
<a name="l00557"></a>00557       <span class="keywordflow">else</span>
<a name="l00558"></a>00558       {
<a name="l00559"></a>00559             <span class="comment">// trap should REALLY go off now!</span>
<a name="l00560"></a>00560             <span class="keywordflow">return</span>( FALSE );
<a name="l00561"></a>00561       }
<a name="l00562"></a>00562 }
<a name="l00563"></a>00563 
<a name="l00564"></a><a class="code" href="Keys_8h.html#1e1858354d41d9080ed9a49d2d0a4814">00564</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#1e1858354d41d9080ed9a49d2d0a4814">ExamineDoorForTraps</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structDOOR.html">DOOR</a> * pDoor )
<a name="l00565"></a>00565 {
<a name="l00566"></a>00566       <span class="comment">// Check to see if there is a trap or not on this door</span>
<a name="l00567"></a>00567       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bDetectLevel;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569       <span class="keywordflow">if</span> (pDoor-&gt;<a class="code" href="structDOOR.html#13bd94a4823fe1713a89d6af26439516">ubTrapID</a> == <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d81015e9806ec7c994503df311d726b4daf">NO_TRAP</a>)
<a name="l00570"></a>00570       {
<a name="l00571"></a>00571             <span class="comment">// No trap!</span>
<a name="l00572"></a>00572             pDoor-&gt;<a class="code" href="structDOOR.html#745b24259bcd2b60d452c45a76cd217a">bPerceivedTrapped</a> = DOOR_PERCEIVED_UNTRAPPED;
<a name="l00573"></a>00573       }
<a name="l00574"></a>00574       <span class="keywordflow">else</span>
<a name="l00575"></a>00575       {
<a name="l00576"></a>00576             <span class="keywordflow">if</span> (pDoor-&gt;<a class="code" href="structDOOR.html#745b24259bcd2b60d452c45a76cd217a">bPerceivedTrapped</a> == DOOR_PERCEIVED_TRAPPED)
<a name="l00577"></a>00577             {
<a name="l00578"></a>00578                   <span class="keywordflow">return</span>( TRUE );
<a name="l00579"></a>00579             }
<a name="l00580"></a>00580             <span class="keywordflow">else</span>
<a name="l00581"></a>00581             {
<a name="l00582"></a>00582                   bDetectLevel = <a class="code" href="SkillCheck_8cpp.html#7f6623bad6276c85c17b252860879583">CalcTrapDetectLevel</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, TRUE );
<a name="l00583"></a>00583                   <span class="keywordflow">if</span> (bDetectLevel &lt; pDoor-&gt;ubTrapLevel)
<a name="l00584"></a>00584                   {
<a name="l00585"></a>00585                         pDoor-&gt;<a class="code" href="structDOOR.html#745b24259bcd2b60d452c45a76cd217a">bPerceivedTrapped</a> = DOOR_PERCEIVED_UNTRAPPED;
<a name="l00586"></a>00586                   }
<a name="l00587"></a>00587                   <span class="keywordflow">else</span>
<a name="l00588"></a>00588                   {
<a name="l00589"></a>00589                         pDoor-&gt;<a class="code" href="structDOOR.html#745b24259bcd2b60d452c45a76cd217a">bPerceivedTrapped</a> = DOOR_PERCEIVED_TRAPPED;
<a name="l00590"></a>00590                         <span class="keywordflow">return</span>( TRUE );
<a name="l00591"></a>00591                   }
<a name="l00592"></a>00592             }
<a name="l00593"></a>00593       }
<a name="l00594"></a>00594       <span class="keywordflow">return</span>( FALSE );
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00597"></a><a class="code" href="Keys_8h.html#bc774c8b45169a3bae2fe5c8895c4786">00597</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#bc774c8b45169a3bae2fe5c8895c4786">HasDoorTrapGoneOff</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structDOOR.html">DOOR</a> * pDoor )
<a name="l00598"></a>00598 {
<a name="l00599"></a>00599       <span class="comment">// Check to see if the soldier causes the trap to go off</span>
<a name="l00600"></a>00600       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bDetectLevel;
<a name="l00601"></a>00601 
<a name="l00602"></a>00602       <span class="keywordflow">if</span> (pDoor-&gt;<a class="code" href="structDOOR.html#13bd94a4823fe1713a89d6af26439516">ubTrapID</a> != <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d81015e9806ec7c994503df311d726b4daf">NO_TRAP</a>)
<a name="l00603"></a>00603       {
<a name="l00604"></a>00604             <span class="comment">// one quick check to see if the guy sees the trap ahead of time!</span>
<a name="l00605"></a>00605             bDetectLevel = <a class="code" href="SkillCheck_8cpp.html#7f6623bad6276c85c17b252860879583">CalcTrapDetectLevel</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, FALSE );
<a name="l00606"></a>00606             <span class="keywordflow">if</span> (bDetectLevel &lt; pDoor-&gt;ubTrapLevel)
<a name="l00607"></a>00607             {
<a name="l00608"></a>00608                   <span class="comment">// trap goes off!</span>
<a name="l00609"></a>00609                   <span class="keywordflow">return</span>( TRUE );
<a name="l00610"></a>00610             }
<a name="l00611"></a>00611       }
<a name="l00612"></a>00612       <span class="keywordflow">return</span>( FALSE );
<a name="l00613"></a>00613 }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615 
<a name="l00616"></a><a class="code" href="Keys_8h.html#5d5aa4b758cc640990a2768f31d20174">00616</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#5d5aa4b758cc640990a2768f31d20174">HandleDoorTrap</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structDOOR.html">DOOR</a> * pDoor )
<a name="l00617"></a>00617 {
<a name="l00618"></a>00618       <span class="keywordflow">if</span> ( !( <a class="code" href="Keys_8cpp.html#313a9e945ab415804e161fcf877ec685">DoorTrapTable</a>[ pDoor-&gt;<a class="code" href="structDOOR.html#13bd94a4823fe1713a89d6af26439516">ubTrapID</a> ].fFlags &amp; DOOR_TRAP_SILENT )  )
<a name="l00619"></a>00619       {
<a name="l00620"></a>00620             <span class="keywordflow">switch</span>( pDoor-&gt;<a class="code" href="structDOOR.html#13bd94a4823fe1713a89d6af26439516">ubTrapID</a> )
<a name="l00621"></a>00621             {
<a name="l00622"></a>00622                   <span class="keywordflow">case</span> <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d81fcc6be5a5878aef7ab02c3869e4b0e6d">BROTHEL_SIREN</a>:
<a name="l00623"></a>00623                         <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_YELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ <a class="code" href="Text_8h.html#d11a20102b8fc2e6eef5e2ce9afdfbe7de9dc52625a86614915651372d0676cd">LOCK_TRAP_HAS_GONE_OFF_STR</a> ], <a class="code" href="__DutchText_8cpp.html#8b645808894dfc0a571be76737dd2d05">pDoorTrapStrings</a>[ <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d81a0832f418724bc0689d1314208f681a3">SIREN</a> ] );
<a name="l00624"></a>00624                         <span class="keywordflow">break</span>;
<a name="l00625"></a>00625                   <span class="keywordflow">case</span> <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d811ebbf9d1037329b8763b68a9c10e9b3d">SUPER_ELECTRIC</a>:
<a name="l00626"></a>00626                         <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_YELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ LOCK_TRAP_HAS_GONE_OFF_STR ], <a class="code" href="__DutchText_8cpp.html#8b645808894dfc0a571be76737dd2d05">pDoorTrapStrings</a>[ <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d81904fa7835cb04ae9b123743acb18a38c">ELECTRIC</a> ] );
<a name="l00627"></a>00627                         <span class="keywordflow">break</span>;
<a name="l00628"></a>00628                   <span class="keywordflow">default</span>:
<a name="l00629"></a>00629                         <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_YELLOW, MSG_INTERFACE, <a class="code" href="__DutchText_8cpp.html#f69c72cc23fedc3149347ccb542af8f8">TacticalStr</a>[ LOCK_TRAP_HAS_GONE_OFF_STR ], <a class="code" href="__DutchText_8cpp.html#8b645808894dfc0a571be76737dd2d05">pDoorTrapStrings</a>[ pDoor-&gt;<a class="code" href="structDOOR.html#13bd94a4823fe1713a89d6af26439516">ubTrapID</a> ] );
<a name="l00630"></a>00630                         <span class="keywordflow">break</span>;
<a name="l00631"></a>00631             }
<a name="l00632"></a>00632       }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634       <span class="comment">// set trap off</span>
<a name="l00635"></a>00635       <span class="keywordflow">switch</span>( pDoor-&gt;<a class="code" href="structDOOR.html#13bd94a4823fe1713a89d6af26439516">ubTrapID</a> )
<a name="l00636"></a>00636       {
<a name="l00637"></a>00637             <span class="keywordflow">case</span> <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d810755372f61dedcc3e20ca0324c1b5652">EXPLOSION</a>:
<a name="l00638"></a>00638                   <span class="comment">// cause damage as a regular hand grenade</span>
<a name="l00639"></a>00639                   <a class="code" href="Explosion_01Control_8cpp.html#add4813e471ef668a64079af2ea8b36a">IgniteExplosion</a>( NOBODY, <a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ), (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)<a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> ), 25, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="Item_01Types_8h.html#572f9555da77e1b21f4cd40aed8d20f4b56082115d9fe14a5936f71d26e35e8e">HAND_GRENADE</a>, 0 );
<a name="l00640"></a>00640                   <span class="keywordflow">break</span>;
<a name="l00641"></a>00641  
<a name="l00642"></a>00642             <span class="keywordflow">case</span> <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d81a0832f418724bc0689d1314208f681a3">SIREN</a>:
<a name="l00643"></a>00643                   <span class="comment">// play siren sound effect but otherwise treat as silent alarm, calling</span>
<a name="l00644"></a>00644                   <span class="comment">// available enemies to this location</span>
<a name="l00645"></a>00645                   <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5dfe767c2c1942f272537f5a2d4f8c194">KLAXON_ALARM</a>, RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( MIDVOLUME, pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> ), 5, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> ) );
<a name="l00646"></a>00646             <span class="keywordflow">case</span> <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d813c43fb6c9e537b76417fc9712d3e9b12">SILENT_ALARM</a>:
<a name="l00647"></a>00647                   <span class="comment">// Get all available enemies running here</span>
<a name="l00648"></a>00648                   <a class="code" href="ai_8h.html#2d5bea7d6ce4fa378fb9b34e128d619c">CallAvailableEnemiesTo</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> );
<a name="l00649"></a>00649                   <span class="keywordflow">break</span>;
<a name="l00650"></a>00650 
<a name="l00651"></a>00651             <span class="keywordflow">case</span> <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d81fcc6be5a5878aef7ab02c3869e4b0e6d">BROTHEL_SIREN</a>:
<a name="l00652"></a>00652                   <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5dfe767c2c1942f272537f5a2d4f8c194">KLAXON_ALARM</a>, RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( MIDVOLUME, pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> ), 5, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> ) );
<a name="l00653"></a>00653                   <a class="code" href="ai_8h.html#933cf606ad368f1a7fe357068a5e718e">CallAvailableKingpinMenTo</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> );
<a name="l00654"></a>00654                   <span class="comment">// no one is authorized any more!</span>
<a name="l00655"></a>00655                   <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa146682cff26c936b8f0888f4eef6024c5">MADAME</a> ].<a class="code" href="structMERCPROFILESTRUCT.html#2383e5671eb993c3061bad92ab884550">bNPCData</a> = 0;
<a name="l00656"></a>00656                   <span class="keywordflow">break</span>;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658             <span class="keywordflow">case</span> <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d81904fa7835cb04ae9b123743acb18a38c">ELECTRIC</a>:
<a name="l00659"></a>00659                   <span class="comment">// insert electrical sound effect here</span>
<a name="l00660"></a>00660                   <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5d962fe164cfc20e49bfd2d2437aec2f0">DOOR_ELECTRICITY</a>, RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( MIDVOLUME, pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> ), 1, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> ) );
<a name="l00661"></a>00661 
<a name="l00662"></a>00662           <span class="comment">// Set attacker's ID</span>
<a name="l00663"></a>00663           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d9c0383469bf58f73ba6bea3e8ebf22b">ubAttackerID</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>;
<a name="l00664"></a>00664           <span class="comment">// Increment  being attacked count</span>
<a name="l00665"></a>00665           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#29253c5ae4099335aaf0dd68af0c5c15">bBeingAttackedCount</a>++;
<a name="l00666"></a>00666               <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a>++;
<a name="l00667"></a>00667               DebugMsg( <a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>, DBG_LEVEL_3, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"!!!!!!! Trap gone off %d"</span>, <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a>) );
<a name="l00668"></a>00668 
<a name="l00669"></a>00669                   <a class="code" href="Soldier_01Control_8cpp.html#1f3b5961c7800928b7924f2488bfec1f">SoldierTakeDamage</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, 0, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (10 + <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 10 )), (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) ((3 + <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 3 ) * 1000)), TAKE_DAMAGE_ELECTRICITY, NOBODY, pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a>, 0, TRUE );
<a name="l00670"></a>00670                   <span class="keywordflow">break</span>;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672             <span class="keywordflow">case</span> <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d811ebbf9d1037329b8763b68a9c10e9b3d">SUPER_ELECTRIC</a>:
<a name="l00673"></a>00673                   <span class="comment">// insert electrical sound effect here</span>
<a name="l00674"></a>00674                   <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b5d962fe164cfc20e49bfd2d2437aec2f0">DOOR_ELECTRICITY</a>, RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( MIDVOLUME, pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> ), 1, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> ) ); 
<a name="l00675"></a>00675 
<a name="l00676"></a>00676           <span class="comment">// Set attacker's ID</span>
<a name="l00677"></a>00677           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d9c0383469bf58f73ba6bea3e8ebf22b">ubAttackerID</a> = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#18aef170576da81b10d00e7b6cd3627b">ubID</a>;
<a name="l00678"></a>00678           <span class="comment">// Increment  being attacked count</span>
<a name="l00679"></a>00679           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#29253c5ae4099335aaf0dd68af0c5c15">bBeingAttackedCount</a>++;
<a name="l00680"></a>00680               <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a>++;
<a name="l00681"></a>00681               DebugMsg( <a class="code" href="DEBUG_8cpp.html#a7985c2fd033797fc67a03b2c26e07c6">TOPIC_JA2</a>, DBG_LEVEL_3, <a class="code" href="DEBUG_8cpp.html#88565bf27eec0b2003eb5bc9426b8e4b">String</a>(<span class="stringliteral">"!!!!!!! Trap gone off %d"</span>, <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#b44a086b36d7dd7af18e11f8fdea4d05">ubAttackBusyCount</a>) );
<a name="l00682"></a>00682 
<a name="l00683"></a>00683                   <a class="code" href="Soldier_01Control_8cpp.html#1f3b5961c7800928b7924f2488bfec1f">SoldierTakeDamage</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, 0, (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) (20 + <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 20 )), (<a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>) ((6 + <a class="code" href="Random_8cpp.html#ca9f12606e77e67e4a79ee8ec0cba956">PreRandom</a>( 6 ) * 1000)), TAKE_DAMAGE_ELECTRICITY, NOBODY, pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a>, 0, TRUE );
<a name="l00684"></a>00684                   <span class="keywordflow">break</span>;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686 
<a name="l00687"></a>00687             <span class="keywordflow">default</span>:
<a name="l00688"></a>00688                   <span class="comment">// no trap</span>
<a name="l00689"></a>00689                   <span class="keywordflow">break</span>;
<a name="l00690"></a>00690       }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 
<a name="l00695"></a><a class="code" href="Keys_8h.html#50e276972e7e1455e7c54eb070248567">00695</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#50e276972e7e1455e7c54eb070248567">AttemptToBlowUpLock</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> * <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="structDOOR.html">DOOR</a> * pDoor )
<a name="l00696"></a>00696 {
<a name="l00697"></a>00697       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iResult;
<a name="l00698"></a>00698       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>  bSlot = NO_SLOT;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700       bSlot = <a class="code" href="Items_8cpp.html#bf1348024a0591857f9adea64e650c03">FindLockBomb</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00701"></a>00701       <span class="keywordflow">if</span> (bSlot == NO_SLOT)
<a name="l00702"></a>00702       {
<a name="l00703"></a>00703             <span class="keywordflow">return</span>( FALSE );
<a name="l00704"></a>00704       }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706       iResult = <a class="code" href="SkillCheck_8cpp.html#5f856107f6b8e4dcfb44a8a699b6bc08">SkillCheck</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="SkillCheck_8h.html#6bce718a73fdc0ff3aa1fd33a80937e41a0cdf3ca5245d4cace59b8a6355c644">PLANTING_BOMB_CHECK</a>, 0 );
<a name="l00707"></a>00707       <span class="keywordflow">if</span> (iResult &gt;= -20)
<a name="l00708"></a>00708       {
<a name="l00709"></a>00709             <span class="comment">// Do explosive graphic....</span>
<a name="l00710"></a>00710             {
<a name="l00711"></a>00711                   <a class="code" href="structTAG__anitile__params.html">ANITILE_PARAMS</a>    AniParams;
<a name="l00712"></a>00712                   <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                               sGridNo;
<a name="l00713"></a>00713                   <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                               sX, sY, sZ;
<a name="l00714"></a>00714 
<a name="l00715"></a>00715                   <span class="comment">// Get gridno</span>
<a name="l00716"></a>00716                   sGridNo = pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a>;
<a name="l00717"></a>00717 
<a name="l00718"></a>00718                   <span class="comment">// Get sX, sy;</span>
<a name="l00719"></a>00719                   sX = <a class="code" href="Isometric_01Utils_8cpp.html#e0e10363746997c2159f4f0b2c002d87">CenterX</a>( sGridNo );
<a name="l00720"></a>00720                   sY = <a class="code" href="Isometric_01Utils_8cpp.html#e7722f80f6c715e5fa8e79926c940d73">CenterY</a>( sGridNo );
<a name="l00721"></a>00721 
<a name="l00722"></a>00722                   <span class="comment">// Get Z position, based on orientation....</span>
<a name="l00723"></a>00723                   sZ = 20;
<a name="l00724"></a>00724 
<a name="l00725"></a>00725                   AniParams.<a class="code" href="structTAG__anitile__params.html#457f1509b42b6f0a2a617ce57d7eddc9">sGridNo</a>                                     = sGridNo;
<a name="l00726"></a>00726                   AniParams.<a class="code" href="structTAG__anitile__params.html#10211a054ff029783b3b785c4103f9df">ubLevelID</a>                                   = ANI_TOPMOST_LEVEL;
<a name="l00727"></a>00727                   AniParams.<a class="code" href="structTAG__anitile__params.html#f0993416d5fde71cbb1f9f7f71fc5ca5">sDelay</a>                                      = (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>)( 100 );
<a name="l00728"></a>00728                   AniParams.<a class="code" href="structTAG__anitile__params.html#1d54c89eb22ad9da5d84a14e0d1a41fe">sStartFrame</a>                           = 0;
<a name="l00729"></a>00729                   AniParams.<a class="code" href="structTAG__anitile__params.html#15b4c53141174e4efe5645916d894529">uiFlags</a>                                     = ANITILE_CACHEDTILE | ANITILE_FORWARD | ANITILE_ALWAYS_TRANSLUCENT;
<a name="l00730"></a>00730                   AniParams.<a class="code" href="structTAG__anitile__params.html#d9aabc8dd8ebdc915e3ef71990e92fc7">sX</a>                                                      = sX;
<a name="l00731"></a>00731                   AniParams.<a class="code" href="structTAG__anitile__params.html#4c29e2e2ef48cd931047cff67d1734da">sY</a>                                                      = sY;
<a name="l00732"></a>00732                   AniParams.<a class="code" href="structTAG__anitile__params.html#f4a11dc2f02f60ed5fb029ed15f1bf63">sZ</a>                                                      = sZ;
<a name="l00733"></a>00733 
<a name="l00734"></a>00734                   <a class="code" href="Sys_01Globals_8h.html#9e96e1edff6728e41ac635536c3d8304">strcpy</a>( AniParams.<a class="code" href="structTAG__anitile__params.html#e51e1a4df4f4a1fcd60d06189d8a3c43">zCachedFile</a>, <span class="stringliteral">"TILECACHE\\MINIBOOM.STI"</span> );
<a name="l00735"></a>00735 
<a name="l00736"></a>00736                   <a class="code" href="Tile_01Animation_8cpp.html#3f6fd4aecdf5e20b7859f020454aee93">CreateAnimationTile</a>( &amp;AniParams );
<a name="l00737"></a>00737 
<a name="l00738"></a>00738                   <a class="code" href="Sound_01Control_8cpp.html#6b140a8e4fcf89b7740c037ff12580a7">PlayJA2Sample</a>( <a class="code" href="Sound_01Control_8h.html#946995a6d03371486c23b23d9ca362b595dbc9b3bb44a2c1d9c1db38f63db00e">SMALL_EXPLODE_1</a> , RATE_11025, <a class="code" href="Sound_01Control_8cpp.html#f62b2a668c2e25997578956c425723c4">SoundVolume</a>( (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>)HIGHVOLUME, sGridNo ), 1, <a class="code" href="Sound_01Control_8cpp.html#a258fd693b7e800828705055bf357c8d">SoundDir</a>( sGridNo ) );                                
<a name="l00739"></a>00739 
<a name="l00740"></a>00740                   <span class="comment">// Remove the explosive.....</span>
<a name="l00741"></a>00741                   bSlot = <a class="code" href="Items_8cpp.html#bf1348024a0591857f9adea64e650c03">FindLockBomb</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00742"></a>00742                   <span class="keywordflow">if</span> (bSlot != NO_SLOT)
<a name="l00743"></a>00743                   {
<a name="l00744"></a>00744                         <a class="code" href="Items_8cpp.html#0b912c79911891027d5cf460c9eaa589">RemoveObjs</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ bSlot ]), 1 );
<a name="l00745"></a>00745                         <a class="code" href="Interface_8cpp.html#8a607488839071ed48da8a73aeaad595">DirtyMercPanelInterface</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, DIRTYLEVEL2 );
<a name="l00746"></a>00746                   }
<a name="l00747"></a>00747             }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749             <span class="comment">// Not sure if this makes sense, but the explosive is small.</span>
<a name="l00750"></a>00750             <span class="comment">// Double the damage here as we are damaging a lock rather than a person</span>
<a name="l00751"></a>00751             pDoor-&gt;<a class="code" href="structDOOR.html#5ce39a5852723dcb4a9a643e6b5c0b46">bLockDamage</a> += <a class="code" href="Weapons_8cpp.html#2c2ae92d28e595deaada6adf85ed5c44">Explosive</a>[<a class="code" href="Item_01Types_8h.html#f9dc4cc7a3a99ad5944940cfb7c82237">Item</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[bSlot].<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>].<a class="code" href="structINVTYPE.html#8f52f99607debfdbb9a8dbf9e43c1967">ubClassIndex</a>].<a class="code" href="structEXPLOSIVETYPE.html#4cb578bdf8c0e98e887f3bde438da284">ubDamage</a> * 2;
<a name="l00752"></a>00752             <span class="keywordflow">if</span> (pDoor-&gt;<a class="code" href="structDOOR.html#5ce39a5852723dcb4a9a643e6b5c0b46">bLockDamage</a> &gt; <a class="code" href="Keys_8cpp.html#493f14b276689fa88b4a321de7f3d781">LockTable</a>[ pDoor-&gt;<a class="code" href="structDOOR.html#882369429929994f448b3ad85e0cff95">ubLockID</a> ].ubSmashDifficulty )
<a name="l00753"></a>00753             {
<a name="l00754"></a>00754                   <span class="comment">// succeeded! door can never be locked again, so remove from door list...</span>
<a name="l00755"></a>00755                   <a class="code" href="Keys_8cpp.html#8a69ba6d1f5ba8d176f6f8c75097af0c">RemoveDoorInfoFromTable</a>( pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> );
<a name="l00756"></a>00756                   <span class="comment">// award experience points?</span>
<a name="l00757"></a>00757                   <span class="keywordflow">return</span>( TRUE );
<a name="l00758"></a>00758             }
<a name="l00759"></a>00759       }
<a name="l00760"></a>00760       <span class="keywordflow">else</span>
<a name="l00761"></a>00761       {
<a name="l00762"></a>00762             bSlot = <a class="code" href="Items_8cpp.html#bf1348024a0591857f9adea64e650c03">FindLockBomb</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l00763"></a>00763             <span class="keywordflow">if</span> (bSlot != NO_SLOT)
<a name="l00764"></a>00764             {
<a name="l00765"></a>00765                   <a class="code" href="Items_8cpp.html#0b912c79911891027d5cf460c9eaa589">RemoveObjs</a>( &amp;(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[ bSlot ]), 1 );
<a name="l00766"></a>00766                   <a class="code" href="Interface_8cpp.html#8a607488839071ed48da8a73aeaad595">DirtyMercPanelInterface</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, DIRTYLEVEL2 );
<a name="l00767"></a>00767             }
<a name="l00768"></a>00768 
<a name="l00769"></a>00769             <span class="comment">// OOPS! ... BOOM!</span>
<a name="l00770"></a>00770             <a class="code" href="Explosion_01Control_8cpp.html#add4813e471ef668a64079af2ea8b36a">IgniteExplosion</a>( NOBODY, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#80d05007932f81f157f2773852ebf62f">sX</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#bad6abc8c1fd843d332db84aa9c1a10c">sY</a>, (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) (<a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>].sHeight), <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#13c875b952b6d634680165d127a9870b">inv</a>[bSlot].<a class="code" href="structOBJECTTYPE.html#4fbe05335f161f08f354566b8e5a0a19">usItem</a>, 0 );
<a name="l00771"></a>00771       }
<a name="l00772"></a>00772       <span class="keywordflow">return</span>( FALSE );
<a name="l00773"></a>00773 }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 <span class="comment">//File I/O for loading the door information from the map.  This automatically allocates</span>
<a name="l00776"></a>00776 <span class="comment">//the exact number of slots when loading.</span>
<a name="l00777"></a><a class="code" href="Keys_8h.html#0ed2ccfb35e897278f661f99d4ecafb9">00777</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#0ed2ccfb35e897278f661f99d4ecafb9">LoadDoorTableFromMap</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> **hBuffer )
<a name="l00778"></a>00778 {
<a name="l00779"></a>00779       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> cnt;
<a name="l00780"></a>00780 
<a name="l00781"></a>00781       <a class="code" href="Keys_8cpp.html#ab4e1c9ca2c1d6a3f4e19282dd097ae1">TrashDoorTable</a>();
<a name="l00782"></a>00782       LOADDATA( &amp;<a class="code" href="Keys_8cpp.html#d15527579743a262fc26967caf7d8460">gubNumDoors</a>, *hBuffer, 1 );
<a name="l00783"></a>00783 
<a name="l00784"></a>00784       <a class="code" href="Keys_8cpp.html#248f6e06b390bc9fcebae99b8f403bfb">gubMaxDoors</a> = <a class="code" href="Keys_8cpp.html#d15527579743a262fc26967caf7d8460">gubNumDoors</a>;
<a name="l00785"></a>00785       <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a> = (<a class="code" href="structDOOR.html">DOOR</a> *)MemAlloc( <span class="keyword">sizeof</span>( <a class="code" href="structDOOR.html">DOOR</a> ) * <a class="code" href="Keys_8cpp.html#248f6e06b390bc9fcebae99b8f403bfb">gubMaxDoors</a> );
<a name="l00786"></a>00786 
<a name="l00787"></a>00787       LOADDATA( <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>, *hBuffer, <span class="keyword">sizeof</span>( DOOR )*gubMaxDoors );
<a name="l00788"></a>00788 
<a name="l00789"></a>00789       <span class="comment">// OK, reset perceived values to nothing...</span>
<a name="l00790"></a>00790       <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; <a class="code" href="Keys_8cpp.html#d15527579743a262fc26967caf7d8460">gubNumDoors</a>; cnt++ )
<a name="l00791"></a>00791       {
<a name="l00792"></a>00792             <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ cnt ].bPerceivedLocked = DOOR_PERCEIVED_UNKNOWN;
<a name="l00793"></a>00793             <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ cnt ].<a class="code" href="structDOOR.html#745b24259bcd2b60d452c45a76cd217a">bPerceivedTrapped</a> = DOOR_PERCEIVED_UNKNOWN;
<a name="l00794"></a>00794       }
<a name="l00795"></a>00795 }
<a name="l00796"></a>00796 
<a name="l00797"></a>00797 <span class="comment">//Saves the existing door information to the map.  Before it actually saves, it'll verify that the</span>
<a name="l00798"></a>00798 <span class="comment">//door still exists.  Otherwise, it'll ignore it.  It is possible in the editor to delete doors in </span>
<a name="l00799"></a>00799 <span class="comment">//many different ways, so I opted to put it in the saving routine.</span>
<a name="l00800"></a><a class="code" href="Keys_8h.html#3ed751e3f4426f269ec8ad8bc9a00242">00800</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#3ed751e3f4426f269ec8ad8bc9a00242">SaveDoorTableToMap</a>( <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a> fp )
<a name="l00801"></a>00801 {
<a name="l00802"></a>00802       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> i = 0;
<a name="l00803"></a>00803       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiBytesWritten;
<a name="l00804"></a>00804 
<a name="l00805"></a>00805       <span class="keywordflow">while</span>( i &lt; <a class="code" href="Keys_8cpp.html#d15527579743a262fc26967caf7d8460">gubNumDoors</a> )
<a name="l00806"></a>00806       {
<a name="l00807"></a>00807             <span class="keywordflow">if</span>( !<a class="code" href="EditorBuildings_8cpp.html#9444db50af3cbead68a0e32effc4a43b">OpenableAtGridNo</a>( <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ i ].sGridNo ) )
<a name="l00808"></a>00808                   <a class="code" href="Keys_8cpp.html#8a69ba6d1f5ba8d176f6f8c75097af0c">RemoveDoorInfoFromTable</a>( <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ i ].sGridNo );
<a name="l00809"></a>00809             <span class="keywordflow">else</span>
<a name="l00810"></a>00810                   i++;
<a name="l00811"></a>00811       }
<a name="l00812"></a>00812       <a class="code" href="FileMan_8cpp.html#09ed41c07d607c8c64a7e2b9fb25660c">FileWrite</a>( fp, &amp;<a class="code" href="Keys_8cpp.html#d15527579743a262fc26967caf7d8460">gubNumDoors</a>, 1, &amp;uiBytesWritten );
<a name="l00813"></a>00813       <a class="code" href="FileMan_8cpp.html#09ed41c07d607c8c64a7e2b9fb25660c">FileWrite</a>( fp, <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>, <span class="keyword">sizeof</span>( <a class="code" href="structDOOR.html">DOOR</a> )*<a class="code" href="Keys_8cpp.html#d15527579743a262fc26967caf7d8460">gubNumDoors</a>, &amp;uiBytesWritten );
<a name="l00814"></a>00814 }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 <span class="comment">//The editor adds locks to the world.  If the gridno already exists, then the currently existing door</span>
<a name="l00817"></a>00817 <span class="comment">//information is overwritten.</span>
<a name="l00818"></a><a class="code" href="Keys_8h.html#f1787a7c55bfd1e58dd4707f80e3b143">00818</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#f1787a7c55bfd1e58dd4707f80e3b143">AddDoorInfoToTable</a>( <a class="code" href="structDOOR.html">DOOR</a> *pDoor )
<a name="l00819"></a>00819 {
<a name="l00820"></a>00820       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> i;
<a name="l00821"></a>00821       <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Keys_8cpp.html#d15527579743a262fc26967caf7d8460">gubNumDoors</a>; i++ )
<a name="l00822"></a>00822       {
<a name="l00823"></a>00823             <span class="keywordflow">if</span>( <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ i ].sGridNo == pDoor-&gt;<a class="code" href="structDOOR.html#332af23780ac31008fd4142928570fd4">sGridNo</a> )
<a name="l00824"></a>00824             {
<a name="l00825"></a>00825                   memcpy( &amp;<a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ i ], pDoor, <span class="keyword">sizeof</span>( <a class="code" href="structDOOR.html">DOOR</a> ) );
<a name="l00826"></a>00826                   <span class="keywordflow">return</span>;
<a name="l00827"></a>00827             }
<a name="l00828"></a>00828       }
<a name="l00829"></a>00829       <span class="comment">//no existing door found, so add a new one.</span>
<a name="l00830"></a>00830       <span class="keywordflow">if</span>( <a class="code" href="Keys_8cpp.html#d15527579743a262fc26967caf7d8460">gubNumDoors</a> &lt; <a class="code" href="Keys_8cpp.html#248f6e06b390bc9fcebae99b8f403bfb">gubMaxDoors</a> )
<a name="l00831"></a>00831       {
<a name="l00832"></a>00832             memcpy( &amp;<a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ <a class="code" href="Keys_8cpp.html#d15527579743a262fc26967caf7d8460">gubNumDoors</a> ], pDoor, <span class="keyword">sizeof</span>( <a class="code" href="structDOOR.html">DOOR</a> ) );
<a name="l00833"></a>00833             gubNumDoors++;
<a name="l00834"></a>00834       }
<a name="l00835"></a>00835       <span class="keywordflow">else</span>
<a name="l00836"></a>00836       { <span class="comment">//we need to allocate more memory, so add ten more slots.</span>
<a name="l00837"></a>00837             <a class="code" href="structDOOR.html">DOOR</a> *NewDoorTable;
<a name="l00838"></a>00838             <a class="code" href="Keys_8cpp.html#248f6e06b390bc9fcebae99b8f403bfb">gubMaxDoors</a> += 10;
<a name="l00839"></a>00839             <span class="comment">//Allocate new table with max+10 doors.</span>
<a name="l00840"></a>00840             NewDoorTable = (<a class="code" href="structDOOR.html">DOOR</a>*)MemAlloc( <span class="keyword">sizeof</span>( <a class="code" href="structDOOR.html">DOOR</a> ) * <a class="code" href="Keys_8cpp.html#248f6e06b390bc9fcebae99b8f403bfb">gubMaxDoors</a> );
<a name="l00841"></a>00841             <span class="comment">//Copy contents of existing door table to new door table.</span>
<a name="l00842"></a>00842             memcpy( NewDoorTable, <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>, <span class="keyword">sizeof</span>( DOOR ) * gubNumDoors );
<a name="l00843"></a>00843             <span class="comment">//Deallocate the existing door table (possible to not have one).</span>
<a name="l00844"></a>00844             <span class="keywordflow">if</span>( <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a> )
<a name="l00845"></a>00845                   MemFree( <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a> );
<a name="l00846"></a>00846             <span class="comment">//Assign the new door table as the existing door table</span>
<a name="l00847"></a>00847             <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a> = NewDoorTable;
<a name="l00848"></a>00848             <span class="comment">//Add the new door info to the table.</span>
<a name="l00849"></a>00849             memcpy( &amp;<a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ gubNumDoors ], pDoor, <span class="keyword">sizeof</span>( DOOR ) );
<a name="l00850"></a>00850             gubNumDoors++;
<a name="l00851"></a>00851       }
<a name="l00852"></a>00852 }
<a name="l00853"></a>00853 
<a name="l00854"></a>00854 <span class="comment">//When the editor removes a door from the world, this function looks for and removes accompanying door</span>
<a name="l00855"></a>00855 <span class="comment">//information.  If the entry is not the last entry, the last entry is move to it's current slot, to keep</span>
<a name="l00856"></a>00856 <span class="comment">//everything contiguous.</span>
<a name="l00857"></a><a class="code" href="Keys_8h.html#8a69ba6d1f5ba8d176f6f8c75097af0c">00857</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#8a69ba6d1f5ba8d176f6f8c75097af0c">RemoveDoorInfoFromTable</a>( <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="editscreen_8cpp.html#48f31659f64cd18c814b1612166c50b5">iMapIndex</a> )
<a name="l00858"></a>00858 {
<a name="l00859"></a>00859       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> i;
<a name="l00860"></a>00860   <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iNumDoorsToCopy;
<a name="l00861"></a>00861       <span class="keywordflow">for</span>( i = 0; i &lt; gubNumDoors; i++ )
<a name="l00862"></a>00862       {
<a name="l00863"></a>00863             <span class="keywordflow">if</span>( <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ i ].sGridNo == iMapIndex )
<a name="l00864"></a>00864             {
<a name="l00865"></a>00865       iNumDoorsToCopy = gubNumDoors - i - 1;
<a name="l00866"></a>00866       <span class="keywordflow">if</span>( iNumDoorsToCopy )
<a name="l00867"></a>00867       {
<a name="l00868"></a>00868                     memmove( &amp;<a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ i ], &amp;<a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ i+1 ], <span class="keyword">sizeof</span>( DOOR ) * iNumDoorsToCopy );
<a name="l00869"></a>00869       }
<a name="l00870"></a>00870                   gubNumDoors--;
<a name="l00871"></a>00871                   <span class="keywordflow">return</span>;
<a name="l00872"></a>00872             }
<a name="l00873"></a>00873       }
<a name="l00874"></a>00874 }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 <span class="comment">//This is the link to see if a door exists at a gridno.  </span>
<a name="l00877"></a><a class="code" href="Keys_8h.html#19a7eb42b15e1c0a749124960b84e972">00877</a> DOOR* <a class="code" href="Keys_8cpp.html#19a7eb42b15e1c0a749124960b84e972">FindDoorInfoAtGridNo</a>( <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="editscreen_8cpp.html#48f31659f64cd18c814b1612166c50b5">iMapIndex</a> )
<a name="l00878"></a>00878 {
<a name="l00879"></a>00879       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> i;
<a name="l00880"></a>00880       <span class="keywordflow">for</span>( i = 0; i &lt; gubNumDoors; i++ )
<a name="l00881"></a>00881       {
<a name="l00882"></a>00882             <span class="keywordflow">if</span>( <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ i ].sGridNo == iMapIndex )
<a name="l00883"></a>00883                   <span class="keywordflow">return</span> &amp;<a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>[ i ];
<a name="l00884"></a>00884       }
<a name="l00885"></a>00885       <span class="keywordflow">return</span> NULL;
<a name="l00886"></a>00886 }
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 <span class="comment">//Upon world deallocation, the door table needs to be deallocated.  Remember, this function</span>
<a name="l00889"></a>00889 <span class="comment">//resets the values, so make sure you do this before you change gubNumDoors or gubMaxDoors.</span>
<a name="l00890"></a><a class="code" href="Keys_8h.html#ab4e1c9ca2c1d6a3f4e19282dd097ae1">00890</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#ab4e1c9ca2c1d6a3f4e19282dd097ae1">TrashDoorTable</a>()
<a name="l00891"></a>00891 {
<a name="l00892"></a>00892       <span class="keywordflow">if</span>( <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a> )
<a name="l00893"></a>00893             MemFree( <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a> );
<a name="l00894"></a>00894       DoorTable = NULL;
<a name="l00895"></a>00895       gubNumDoors = 0;
<a name="l00896"></a>00896       gubMaxDoors = 0;
<a name="l00897"></a>00897 }
<a name="l00898"></a>00898 
<a name="l00899"></a><a class="code" href="Keys_8h.html#f422369baf8df4bbd20859bca8926751">00899</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#f422369baf8df4bbd20859bca8926751">UpdateDoorPerceivedValue</a>( DOOR *pDoor )
<a name="l00900"></a>00900 {
<a name="l00901"></a>00901       <span class="keywordflow">if</span> ( pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a> )
<a name="l00902"></a>00902       {
<a name="l00903"></a>00903             pDoor-&gt;<a class="code" href="structDOOR.html#e6b27f21c43c5e8dca1293e92fbdb172">bPerceivedLocked</a> = DOOR_PERCEIVED_LOCKED;
<a name="l00904"></a>00904       }
<a name="l00905"></a>00905       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !pDoor-&gt;<a class="code" href="structDOOR.html#1e0898f7f714accc46ed1945170ef98d">fLocked</a> ) 
<a name="l00906"></a>00906       {
<a name="l00907"></a>00907             pDoor-&gt;<a class="code" href="structDOOR.html#e6b27f21c43c5e8dca1293e92fbdb172">bPerceivedLocked</a> = DOOR_PERCEIVED_UNLOCKED;
<a name="l00908"></a>00908       }
<a name="l00909"></a>00909 
<a name="l00910"></a>00910       <span class="keywordflow">if</span> (pDoor-&gt;<a class="code" href="structDOOR.html#13bd94a4823fe1713a89d6af26439516">ubTrapID</a> != <a class="code" href="Keys_8h.html#08aee3934927ccc4237313f4c3098d81015e9806ec7c994503df311d726b4daf">NO_TRAP</a>)
<a name="l00911"></a>00911       {
<a name="l00912"></a>00912             pDoor-&gt;<a class="code" href="structDOOR.html#745b24259bcd2b60d452c45a76cd217a">bPerceivedTrapped</a> = DOOR_PERCEIVED_TRAPPED;
<a name="l00913"></a>00913       }
<a name="l00914"></a>00914       <span class="keywordflow">else</span>
<a name="l00915"></a>00915       {
<a name="l00916"></a>00916             pDoor-&gt;<a class="code" href="structDOOR.html#745b24259bcd2b60d452c45a76cd217a">bPerceivedTrapped</a> = DOOR_PERCEIVED_UNTRAPPED;
<a name="l00917"></a>00917       }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919 }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921 
<a name="l00922"></a>00922 
<a name="l00923"></a>00923 
<a name="l00924"></a>00924 
<a name="l00925"></a><a class="code" href="Keys_8h.html#09022dc2ebd5d63176735683ff7e446a">00925</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>  <a class="code" href="Keys_8cpp.html#09022dc2ebd5d63176735683ff7e446a">SaveDoorTableToDoorTableTempFile</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorX, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorY, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bSectorZ )
<a name="l00926"></a>00926 {
<a name="l00927"></a>00927       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiNumBytesWritten;
<a name="l00928"></a>00928       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiSizeToSave=0;
<a name="l00929"></a>00929       <a class="code" href="Types_8h.html#2f68f0189367ead40015f7c0ec68eb9e">CHAR8</a>       zMapName[ 128 ];
<a name="l00930"></a>00930       <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a>      hFile;
<a name="l00931"></a>00931 
<a name="l00932"></a>00932 <span class="comment">//    return( TRUE );</span>
<a name="l00933"></a>00933 
<a name="l00934"></a>00934       uiSizeToSave = gubNumDoors * <span class="keyword">sizeof</span>( DOOR );
<a name="l00935"></a>00935 
<a name="l00936"></a>00936 
<a name="l00937"></a>00937       <span class="comment">//Convert the current sector location into a file name</span>
<a name="l00938"></a>00938 <span class="comment">//    GetMapFileName( sSectorX, sSectorY, bSectorZ, zTempName, FALSE );</span>
<a name="l00939"></a>00939 
<a name="l00940"></a>00940       <span class="comment">//add the 'd' for 'Door' to the front of the map name</span>
<a name="l00941"></a>00941 <span class="comment">//    sprintf( zMapName, "%s\\d_%s", MAPS_DIR, zTempName);</span>
<a name="l00942"></a>00942 
<a name="l00943"></a>00943       <a class="code" href="Tactical_01Save_8cpp.html#ac1ec82dd3bcbf09c20edda3ac4a1d75">GetMapTempFileName</a>( SF_DOOR_TABLE_TEMP_FILES_EXISTS, zMapName, sSectorX, sSectorY, bSectorZ );
<a name="l00944"></a>00944 
<a name="l00945"></a>00945       <span class="comment">//if the file already exists, delete it</span>
<a name="l00946"></a>00946       <span class="keywordflow">if</span>( <a class="code" href="FileMan_8cpp.html#8eb098ceba9cecc2c60c7e40c964e147">FileExists</a>( zMapName ) )
<a name="l00947"></a>00947       {
<a name="l00948"></a>00948             <span class="comment">//We are going to be overwriting the file</span>
<a name="l00949"></a>00949             <span class="keywordflow">if</span>( !<a class="code" href="FileMan_8cpp.html#12ec9d9b03c4bea61fe2afecae64a230">FileDelete</a>( zMapName ) )
<a name="l00950"></a>00950             {
<a name="l00951"></a>00951                   <span class="keywordflow">return</span>(FALSE);
<a name="l00952"></a>00952             }
<a name="l00953"></a>00953       }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955 
<a name="l00956"></a>00956       
<a name="l00957"></a>00957       <span class="comment">//Open the file for writing, Create it if it doesnt exist</span>
<a name="l00958"></a>00958       hFile = <a class="code" href="FileMan_8cpp.html#1e5007589e18cbc273b9677470215db4">FileOpen</a>( zMapName, FILE_ACCESS_WRITE | FILE_OPEN_ALWAYS, FALSE );
<a name="l00959"></a>00959       <span class="keywordflow">if</span>( hFile == 0 )
<a name="l00960"></a>00960       {
<a name="l00961"></a>00961             <span class="comment">//Error opening map modification file</span>
<a name="l00962"></a>00962             <span class="keywordflow">return</span>( FALSE );
<a name="l00963"></a>00963       }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965 
<a name="l00966"></a>00966       <span class="comment">//Save the number of doors</span>
<a name="l00967"></a>00967       <a class="code" href="FileMan_8cpp.html#09ed41c07d607c8c64a7e2b9fb25660c">FileWrite</a>( hFile, &amp;gubNumDoors, <span class="keyword">sizeof</span>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ), &amp;uiNumBytesWritten );
<a name="l00968"></a>00968       <span class="keywordflow">if</span>( uiNumBytesWritten != <span class="keyword">sizeof</span>( UINT8 ) )
<a name="l00969"></a>00969       {
<a name="l00970"></a>00970             <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l00971"></a>00971             <span class="keywordflow">return</span>( FALSE );
<a name="l00972"></a>00972       }
<a name="l00973"></a>00973 
<a name="l00974"></a>00974 
<a name="l00975"></a>00975       <span class="comment">//if there are doors to save</span>
<a name="l00976"></a>00976       <span class="keywordflow">if</span>( uiSizeToSave != 0 )
<a name="l00977"></a>00977       {
<a name="l00978"></a>00978             <span class="comment">//Save the door table</span>
<a name="l00979"></a>00979             <a class="code" href="FileMan_8cpp.html#09ed41c07d607c8c64a7e2b9fb25660c">FileWrite</a>( hFile, <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>, uiSizeToSave, &amp;uiNumBytesWritten );
<a name="l00980"></a>00980             <span class="keywordflow">if</span>( uiNumBytesWritten != uiSizeToSave )
<a name="l00981"></a>00981             {
<a name="l00982"></a>00982                   <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l00983"></a>00983                   <span class="keywordflow">return</span>( FALSE );
<a name="l00984"></a>00984             }
<a name="l00985"></a>00985       }
<a name="l00986"></a>00986 
<a name="l00987"></a>00987       
<a name="l00988"></a>00988       <span class="comment">//Set the sector flag indicating that there is a Door table temp file present </span>
<a name="l00989"></a>00989       <a class="code" href="Tactical_01Save_8cpp.html#1d9e3649d7691d4447d80af4c235ad0a">SetSectorFlag</a>( <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a>, <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a>, <a class="code" href="strategicmap_8cpp.html#da715721a8ceedd42acf6ddb33e63ce0">gbWorldSectorZ</a>, SF_DOOR_TABLE_TEMP_FILES_EXISTS );
<a name="l00990"></a>00990 
<a name="l00991"></a>00991       <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l00992"></a>00992 
<a name="l00993"></a>00993       <span class="keywordflow">return</span>( TRUE );
<a name="l00994"></a>00994 }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996 
<a name="l00997"></a>00997 
<a name="l00998"></a><a class="code" href="Keys_8h.html#aba9cd04747b352fdaddd63073f38a74">00998</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#aba9cd04747b352fdaddd63073f38a74">LoadDoorTableFromDoorTableTempFile</a>( )
<a name="l00999"></a>00999 {
<a name="l01000"></a>01000       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiNumBytesRead;
<a name="l01001"></a>01001       <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a>      hFile;
<a name="l01002"></a>01002       <a class="code" href="Types_8h.html#2f68f0189367ead40015f7c0ec68eb9e">CHAR8</a>       zMapName[ 128 ];
<a name="l01003"></a>01003 
<a name="l01004"></a>01004 <span class="comment">//    return( TRUE );</span>
<a name="l01005"></a>01005 
<a name="l01006"></a>01006 
<a name="l01007"></a>01007       <span class="comment">//Convert the current sector location into a file name</span>
<a name="l01008"></a>01008 <span class="comment">//    GetMapFileName( gWorldSectorX, gWorldSectorY, gbWorldSectorZ, zTempName, FALSE );</span>
<a name="l01009"></a>01009 
<a name="l01010"></a>01010       <span class="comment">//add the 'd' for 'Door' to the front of the map name</span>
<a name="l01011"></a>01011 <span class="comment">//    sprintf( zMapName, "%s\\d_%s", MAPS_DIR, zTempName);</span>
<a name="l01012"></a>01012 
<a name="l01013"></a>01013       <a class="code" href="Tactical_01Save_8cpp.html#ac1ec82dd3bcbf09c20edda3ac4a1d75">GetMapTempFileName</a>( SF_DOOR_TABLE_TEMP_FILES_EXISTS, zMapName, <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a>, <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a>, <a class="code" href="strategicmap_8cpp.html#da715721a8ceedd42acf6ddb33e63ce0">gbWorldSectorZ</a> );
<a name="l01014"></a>01014 
<a name="l01015"></a>01015       <span class="comment">//Check to see if the file exists</span>
<a name="l01016"></a>01016       <span class="keywordflow">if</span>( !<a class="code" href="FileMan_8cpp.html#8eb098ceba9cecc2c60c7e40c964e147">FileExists</a>( zMapName ) )
<a name="l01017"></a>01017       {
<a name="l01018"></a>01018             <span class="comment">//If the file doesnt exists, its no problem.</span>
<a name="l01019"></a>01019             <span class="keywordflow">return</span>( TRUE );
<a name="l01020"></a>01020       }
<a name="l01021"></a>01021 
<a name="l01022"></a>01022       <span class="comment">//Get rid of the existing door table</span>
<a name="l01023"></a>01023       <a class="code" href="Keys_8cpp.html#ab4e1c9ca2c1d6a3f4e19282dd097ae1">TrashDoorTable</a>();
<a name="l01024"></a>01024 
<a name="l01025"></a>01025       <span class="comment">//Open the file for reading</span>
<a name="l01026"></a>01026       hFile = <a class="code" href="FileMan_8cpp.html#1e5007589e18cbc273b9677470215db4">FileOpen</a>( zMapName, FILE_ACCESS_READ | FILE_OPEN_EXISTING, FALSE );
<a name="l01027"></a>01027       <span class="keywordflow">if</span>( hFile == 0 )
<a name="l01028"></a>01028       {
<a name="l01029"></a>01029             <span class="comment">//Error opening map modification file,</span>
<a name="l01030"></a>01030             <span class="keywordflow">return</span>( FALSE );
<a name="l01031"></a>01031       }
<a name="l01032"></a>01032 
<a name="l01033"></a>01033       <span class="comment">//Read in the number of doors</span>
<a name="l01034"></a>01034       <a class="code" href="FileMan_8cpp.html#1b213074411fd4c1dc8fd345e787b17e">FileRead</a>( hFile, &amp;gubMaxDoors, <span class="keyword">sizeof</span>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ), &amp;uiNumBytesRead );
<a name="l01035"></a>01035       <span class="keywordflow">if</span>( uiNumBytesRead != <span class="keyword">sizeof</span>( UINT8 ) )
<a name="l01036"></a>01036       {
<a name="l01037"></a>01037             <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l01038"></a>01038             <span class="keywordflow">return</span>( FALSE );
<a name="l01039"></a>01039       }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041       gubNumDoors = gubMaxDoors;
<a name="l01042"></a>01042 
<a name="l01043"></a>01043       <span class="comment">//if there is no doors to load</span>
<a name="l01044"></a>01044       <span class="keywordflow">if</span>( gubNumDoors != 0 )
<a name="l01045"></a>01045       {
<a name="l01046"></a>01046             <span class="comment">//Allocate space for the door table</span>
<a name="l01047"></a>01047             <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a> = (DOOR *) MemAlloc( <span class="keyword">sizeof</span>( DOOR ) * gubMaxDoors );
<a name="l01048"></a>01048             <span class="keywordflow">if</span>( <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a> == NULL )
<a name="l01049"></a>01049             {
<a name="l01050"></a>01050                   <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l01051"></a>01051                   <span class="keywordflow">return</span>( FALSE );
<a name="l01052"></a>01052             }
<a name="l01053"></a>01053 
<a name="l01054"></a>01054 
<a name="l01055"></a>01055             <span class="comment">//Read in the number of doors</span>
<a name="l01056"></a>01056             <a class="code" href="FileMan_8cpp.html#1b213074411fd4c1dc8fd345e787b17e">FileRead</a>( hFile, <a class="code" href="Keys_8cpp.html#fa8779b5515c4e47187eb0ac2e4fe238">DoorTable</a>, <span class="keyword">sizeof</span>( DOOR ) * gubMaxDoors, &amp;uiNumBytesRead );
<a name="l01057"></a>01057             <span class="keywordflow">if</span>( uiNumBytesRead != <span class="keyword">sizeof</span>( DOOR ) * gubMaxDoors )
<a name="l01058"></a>01058             {
<a name="l01059"></a>01059                   <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l01060"></a>01060                   <span class="keywordflow">return</span>( FALSE );
<a name="l01061"></a>01061             }
<a name="l01062"></a>01062       }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064       <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l01065"></a>01065 
<a name="l01066"></a>01066       <span class="keywordflow">return</span>( TRUE );
<a name="l01067"></a>01067 }
<a name="l01068"></a>01068 
<a name="l01069"></a>01069 
<a name="l01070"></a>01070 
<a name="l01071"></a>01071 
<a name="l01072"></a>01072 <span class="comment">// fOpen is True if the door is open, false if it is closed</span>
<a name="l01073"></a><a class="code" href="Keys_8h.html#c118cd896b166ea78a30667d327dccdd">01073</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#892aa270754b01b45e85f16f7a60e0b9">ModifyDoorStatus</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fOpen, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fPerceivedOpen )
<a name="l01074"></a>01074 {
<a name="l01075"></a>01075       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubCnt;
<a name="l01076"></a>01076       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a> * pStructure;
<a name="l01077"></a>01077       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a> * pBaseStructure;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079       <span class="comment">//Set the gridno for the door</span>
<a name="l01080"></a>01080 
<a name="l01081"></a>01081       <span class="comment">// Find the base tile for the door structure and use that gridno</span>
<a name="l01082"></a>01082       pStructure = <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( sGridNo, STRUCTURE_ANYDOOR );
<a name="l01083"></a>01083       <span class="keywordflow">if</span> (pStructure)
<a name="l01084"></a>01084       {
<a name="l01085"></a>01085             pBaseStructure = <a class="code" href="structure_8cpp.html#b55dd5bf5b84e82450258b2ffd222181">FindBaseStructure</a>( pStructure );
<a name="l01086"></a>01086       }
<a name="l01087"></a>01087       <span class="keywordflow">else</span>
<a name="l01088"></a>01088       {
<a name="l01089"></a>01089             pBaseStructure = NULL;
<a name="l01090"></a>01090       }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092       <span class="keywordflow">if</span> ( pBaseStructure == NULL )
<a name="l01093"></a>01093       {
<a name="l01094"></a>01094 <span class="preprocessor">#if 0</span>
<a name="l01095"></a>01095 <span class="preprocessor"></span>            <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L<span class="stringliteral">"Door structure data at %d was not found"</span>, sGridNo );
<a name="l01096"></a>01096 <span class="preprocessor">#endif</span>
<a name="l01097"></a>01097 <span class="preprocessor"></span>            <span class="keywordflow">return</span>( FALSE );
<a name="l01098"></a>01098       }
<a name="l01099"></a>01099       
<a name="l01100"></a>01100       <span class="comment">//if there is an array</span>
<a name="l01101"></a>01101       <span class="keywordflow">if</span>( <a class="code" href="Keys_8cpp.html#6ba62379372b98e2b7fe5515c9fb7eca">gpDoorStatus</a> )
<a name="l01102"></a>01102       {
<a name="l01103"></a>01103             <span class="comment">//Check to see if the user is adding an existing door</span>
<a name="l01104"></a>01104             <span class="keywordflow">for</span>( ubCnt=0; ubCnt&lt;<a class="code" href="Keys_8cpp.html#d68fcf80befae7e291fea4ae302713be">gubNumDoorStatus</a>; ubCnt++)
<a name="l01105"></a>01105             {
<a name="l01106"></a>01106                   <span class="comment">//if the door is already in the array</span>
<a name="l01107"></a>01107                   <span class="keywordflow">if</span>( <a class="code" href="Keys_8cpp.html#6ba62379372b98e2b7fe5515c9fb7eca">gpDoorStatus</a>[ ubCnt ].sGridNo ==      pBaseStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#0d887297b2381aceed479a0ace92e895">sGridNo</a> )
<a name="l01108"></a>01108                   {
<a name="l01109"></a>01109                         <span class="comment">//set the status</span>
<a name="l01110"></a>01110                         <span class="comment">// ATE: Don't set if set to DONTSET</span>
<a name="l01111"></a>01111                         <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( fPerceivedOpen != DONTSETDOORSTATUS )
<a name="l01112"></a>01112                         {
<a name="l01113"></a>01113                               <span class="keywordflow">if</span>( fPerceivedOpen )
<a name="l01114"></a>01114                                     <a class="code" href="Keys_8cpp.html#6ba62379372b98e2b7fe5515c9fb7eca">gpDoorStatus</a>[ ubCnt ].ubFlags |= DOOR_PERCEIVED_OPEN;
<a name="l01115"></a>01115                               <span class="keywordflow">else</span>
<a name="l01116"></a>01116                                     <a class="code" href="Keys_8cpp.html#6ba62379372b98e2b7fe5515c9fb7eca">gpDoorStatus</a>[ ubCnt ].<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp;= ~DOOR_PERCEIVED_OPEN;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118                               <span class="comment">// Turn off perceived not set flag....</span>
<a name="l01119"></a>01119                                     <a class="code" href="Keys_8cpp.html#6ba62379372b98e2b7fe5515c9fb7eca">gpDoorStatus</a>[ ubCnt ].<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp;= ~DOOR_PERCEIVED_NOTSET;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121                         }
<a name="l01122"></a>01122 
<a name="l01123"></a>01123                         <span class="keywordflow">if</span> ( fOpen != DONTSETDOORSTATUS )
<a name="l01124"></a>01124                         {
<a name="l01125"></a>01125                               <span class="keywordflow">if</span>( fOpen )
<a name="l01126"></a>01126                                     <a class="code" href="Keys_8cpp.html#6ba62379372b98e2b7fe5515c9fb7eca">gpDoorStatus</a>[ ubCnt ].ubFlags |= DOOR_OPEN;
<a name="l01127"></a>01127                               <span class="keywordflow">else</span>
<a name="l01128"></a>01128                                     <a class="code" href="Keys_8cpp.html#6ba62379372b98e2b7fe5515c9fb7eca">gpDoorStatus</a>[ ubCnt ].<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp;= ~DOOR_OPEN;
<a name="l01129"></a>01129                         }
<a name="l01130"></a>01130 
<a name="l01131"></a>01131                         <span class="comment">//Dont add it</span>
<a name="l01132"></a>01132                         <span class="keywordflow">return</span>( TRUE );
<a name="l01133"></a>01133                   }
<a name="l01134"></a>01134             }
<a name="l01135"></a>01135       }
<a name="l01136"></a>01136 
<a name="l01137"></a>01137       <span class="comment">// add a new door status structure</span>
<a name="l01138"></a>01138 
<a name="l01139"></a>01139       <span class="comment">//if there is an array</span>
<a name="l01140"></a>01140       <span class="keywordflow">if</span>( <a class="code" href="Keys_8cpp.html#6ba62379372b98e2b7fe5515c9fb7eca">gpDoorStatus</a> )
<a name="l01141"></a>01141       {
<a name="l01142"></a>01142             <span class="comment">//Increment the number of doors</span>
<a name="l01143"></a>01143             <a class="code" href="Keys_8cpp.html#d68fcf80befae7e291fea4ae302713be">gubNumDoorStatus</a>++;
<a name="l01144"></a>01144 
<a name="l01145"></a>01145             <span class="comment">//reallocate memory to hold the new door</span>
<a name="l01146"></a>01146             gpDoorStatus = (<a class="code" href="structDOOR__STATUS.html">DOOR_STATUS</a> *) MemRealloc( gpDoorStatus, <span class="keyword">sizeof</span>( <a class="code" href="structDOOR__STATUS.html">DOOR_STATUS</a> ) * <a class="code" href="Keys_8cpp.html#d68fcf80befae7e291fea4ae302713be">gubNumDoorStatus</a> );
<a name="l01147"></a>01147             <span class="keywordflow">if</span>( gpDoorStatus == NULL )
<a name="l01148"></a>01148                   <span class="keywordflow">return</span>( FALSE );
<a name="l01149"></a>01149 
<a name="l01150"></a>01150       }
<a name="l01151"></a>01151       <span class="keywordflow">else</span>
<a name="l01152"></a>01152       {
<a name="l01153"></a>01153             <span class="comment">//Set the initial number of doors</span>
<a name="l01154"></a>01154             gubNumDoorStatus = 1;
<a name="l01155"></a>01155 
<a name="l01156"></a>01156             gpDoorStatus = (DOOR_STATUS *) MemAlloc( <span class="keyword">sizeof</span>( DOOR_STATUS ) );
<a name="l01157"></a>01157             <span class="keywordflow">if</span>( gpDoorStatus == NULL )
<a name="l01158"></a>01158                   <span class="keywordflow">return</span>( FALSE );
<a name="l01159"></a>01159       }
<a name="l01160"></a>01160 
<a name="l01161"></a>01161       gpDoorStatus[ gubNumDoorStatus-1 ].sGridNo = pBaseStructure-&gt;sGridNo;
<a name="l01162"></a>01162 
<a name="l01163"></a>01163       <span class="comment">//Init the flags</span>
<a name="l01164"></a>01164       gpDoorStatus[ gubNumDoorStatus-1 ].ubFlags = 0;
<a name="l01165"></a>01165 
<a name="l01166"></a>01166       <span class="comment">//If the door is to be initially open</span>
<a name="l01167"></a>01167       <span class="keywordflow">if</span>( fOpen )
<a name="l01168"></a>01168             gpDoorStatus[ gubNumDoorStatus-1 ].ubFlags |= DOOR_OPEN;
<a name="l01169"></a>01169 
<a name="l01170"></a>01170       <span class="comment">// IF A NEW DOOR, USE SAME AS ACTUAL</span>
<a name="l01171"></a>01171       <span class="keywordflow">if</span> ( fPerceivedOpen != DONTSETDOORSTATUS )
<a name="l01172"></a>01172       {
<a name="l01173"></a>01173             <span class="keywordflow">if</span>( fOpen )
<a name="l01174"></a>01174                   gpDoorStatus[ gubNumDoorStatus-1 ].ubFlags |= DOOR_PERCEIVED_OPEN; 
<a name="l01175"></a>01175       }
<a name="l01176"></a>01176       <span class="keywordflow">else</span>
<a name="l01177"></a>01177       {
<a name="l01178"></a>01178             gpDoorStatus[ gubNumDoorStatus-1 ].ubFlags |= DOOR_PERCEIVED_NOTSET; 
<a name="l01179"></a>01179       }
<a name="l01180"></a>01180 
<a name="l01181"></a>01181       <span class="comment">// flag the tile as containing a door status </span>
<a name="l01182"></a>01182       <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ pBaseStructure-&gt;sGridNo ].<a class="code" href="structMAP__ELEMENT.html#44798d8c9c5a05f8930f3c6728fcadec">ubExtFlags</a>[0] |= MAPELEMENT_EXT_DOOR_STATUS_PRESENT;
<a name="l01183"></a>01183 
<a name="l01184"></a>01184       <span class="keywordflow">return</span>( TRUE );
<a name="l01185"></a>01185 }
<a name="l01186"></a>01186 
<a name="l01187"></a><a class="code" href="Keys_8h.html#6b9fb34a2b6a189d2b6c308f13b6f777">01187</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#6b9fb34a2b6a189d2b6c308f13b6f777">TrashDoorStatusArray</a>( )
<a name="l01188"></a>01188 {
<a name="l01189"></a>01189       <span class="keywordflow">if</span>( gpDoorStatus )
<a name="l01190"></a>01190       {
<a name="l01191"></a>01191             MemFree( gpDoorStatus );
<a name="l01192"></a>01192             gpDoorStatus = NULL;
<a name="l01193"></a>01193       }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195       gubNumDoorStatus = 0;
<a name="l01196"></a>01196 }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198 
<a name="l01199"></a><a class="code" href="Keys_8h.html#52b93bfb2fc2d4b7b6728cdd4448b257">01199</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>     <a class="code" href="Keys_8cpp.html#52b93bfb2fc2d4b7b6728cdd4448b257">IsDoorOpen</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo )
<a name="l01200"></a>01200 {
<a name="l01201"></a>01201       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubCnt;
<a name="l01202"></a>01202       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a> * pStructure;
<a name="l01203"></a>01203       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a> * pBaseStructure;
<a name="l01204"></a>01204 
<a name="l01205"></a>01205       <span class="comment">// Find the base tile for the door structure and use that gridno</span>
<a name="l01206"></a>01206       pStructure = <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( sGridNo, STRUCTURE_ANYDOOR );
<a name="l01207"></a>01207       <span class="keywordflow">if</span> (pStructure)
<a name="l01208"></a>01208       {
<a name="l01209"></a>01209             pBaseStructure = <a class="code" href="structure_8cpp.html#b55dd5bf5b84e82450258b2ffd222181">FindBaseStructure</a>( pStructure );
<a name="l01210"></a>01210       }
<a name="l01211"></a>01211       <span class="keywordflow">else</span>
<a name="l01212"></a>01212       {
<a name="l01213"></a>01213             pBaseStructure = NULL;
<a name="l01214"></a>01214       }
<a name="l01215"></a>01215 
<a name="l01216"></a>01216       <span class="keywordflow">if</span> ( pBaseStructure == NULL )
<a name="l01217"></a>01217       {
<a name="l01218"></a>01218 <span class="preprocessor">#if 0</span>
<a name="l01219"></a>01219 <span class="preprocessor"></span>            <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L<span class="stringliteral">"Door structure data at %d was not found"</span>, sGridNo );
<a name="l01220"></a>01220 <span class="preprocessor">#endif</span>
<a name="l01221"></a>01221 <span class="preprocessor"></span>            <span class="keywordflow">return</span>( FALSE );
<a name="l01222"></a>01222       }
<a name="l01223"></a>01223 
<a name="l01224"></a>01224       <span class="comment">//if there is an array</span>
<a name="l01225"></a>01225       <span class="keywordflow">if</span>( gpDoorStatus )
<a name="l01226"></a>01226       {
<a name="l01227"></a>01227             <span class="comment">//Check to see if the user is adding an existing door</span>
<a name="l01228"></a>01228             <span class="keywordflow">for</span>( ubCnt=0; ubCnt&lt;gubNumDoorStatus; ubCnt++)
<a name="l01229"></a>01229             {
<a name="l01230"></a>01230                   <span class="comment">//if this is the door</span>
<a name="l01231"></a>01231                   <span class="keywordflow">if</span>( gpDoorStatus[ ubCnt ].sGridNo == pBaseStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#0d887297b2381aceed479a0ace92e895">sGridNo</a> )
<a name="l01232"></a>01232                   {
<a name="l01233"></a>01233                         <span class="keywordflow">if</span>( gpDoorStatus[ ubCnt ].ubFlags &amp; DOOR_OPEN )
<a name="l01234"></a>01234                               <span class="keywordflow">return</span>( TRUE );
<a name="l01235"></a>01235                         <span class="keywordflow">else</span>
<a name="l01236"></a>01236                               <span class="keywordflow">return</span>( FALSE );
<a name="l01237"></a>01237                   }
<a name="l01238"></a>01238             }
<a name="l01239"></a>01239       }
<a name="l01240"></a>01240 
<a name="l01241"></a>01241 <span class="preprocessor">      #ifdef JA2TESTVERSION</span>
<a name="l01242"></a>01242 <span class="preprocessor"></span>      <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_TESTVERSION, L<span class="stringliteral">"WARNING! Failed to find the Door Open Status on Gridno %s"</span>, sGridNo );
<a name="l01243"></a>01243 <span class="preprocessor">      #endif</span>
<a name="l01244"></a>01244 <span class="preprocessor"></span>
<a name="l01245"></a>01245       <span class="keywordflow">return</span>( FALSE );
<a name="l01246"></a>01246 }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248 <span class="comment">// Returns a doors status value, NULL if not found</span>
<a name="l01249"></a><a class="code" href="Keys_8h.html#baeda4a8cbd53f6a4a750a15101bdeb2">01249</a> DOOR_STATUS *<a class="code" href="Keys_8cpp.html#baeda4a8cbd53f6a4a750a15101bdeb2">GetDoorStatus</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo )
<a name="l01250"></a>01250 {
<a name="l01251"></a>01251       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubCnt;
<a name="l01252"></a>01252       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a> * pStructure;
<a name="l01253"></a>01253       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a> * pBaseStructure;
<a name="l01254"></a>01254 
<a name="l01255"></a>01255       <span class="comment">//if there is an array</span>
<a name="l01256"></a>01256       <span class="keywordflow">if</span>( gpDoorStatus )
<a name="l01257"></a>01257       {
<a name="l01258"></a>01258             <span class="comment">// Find the base tile for the door structure and use that gridno</span>
<a name="l01259"></a>01259             pStructure = <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( sGridNo, STRUCTURE_ANYDOOR );
<a name="l01260"></a>01260             <span class="keywordflow">if</span> (pStructure)
<a name="l01261"></a>01261             {
<a name="l01262"></a>01262                   pBaseStructure = <a class="code" href="structure_8cpp.html#b55dd5bf5b84e82450258b2ffd222181">FindBaseStructure</a>( pStructure );
<a name="l01263"></a>01263             }
<a name="l01264"></a>01264             <span class="keywordflow">else</span>
<a name="l01265"></a>01265             {
<a name="l01266"></a>01266                   pBaseStructure = NULL;
<a name="l01267"></a>01267             }
<a name="l01268"></a>01268 
<a name="l01269"></a>01269             <span class="keywordflow">if</span> ( pBaseStructure == NULL )
<a name="l01270"></a>01270             {
<a name="l01271"></a>01271                   <span class="keywordflow">return</span>( NULL );
<a name="l01272"></a>01272             }
<a name="l01273"></a>01273 
<a name="l01274"></a>01274             <span class="comment">//Check to see if the user is adding an existing door</span>
<a name="l01275"></a>01275             <span class="keywordflow">for</span>( ubCnt=0; ubCnt&lt;gubNumDoorStatus; ubCnt++)
<a name="l01276"></a>01276             {
<a name="l01277"></a>01277                   <span class="comment">//if this is the door</span>
<a name="l01278"></a>01278                   <span class="keywordflow">if</span>( gpDoorStatus[ ubCnt ].sGridNo == pBaseStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#0d887297b2381aceed479a0ace92e895">sGridNo</a> )
<a name="l01279"></a>01279                   {
<a name="l01280"></a>01280                         <span class="keywordflow">return</span>( &amp;( gpDoorStatus[ ubCnt ] ) );
<a name="l01281"></a>01281                   }
<a name="l01282"></a>01282             }
<a name="l01283"></a>01283       }
<a name="l01284"></a>01284 
<a name="l01285"></a>01285       <span class="keywordflow">return</span>( NULL );
<a name="l01286"></a>01286 }
<a name="l01287"></a>01287 
<a name="l01288"></a>01288 
<a name="l01289"></a><a class="code" href="Keys_8h.html#bc18aa8ab066ff5e5de6e206a4675154">01289</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#bc18aa8ab066ff5e5de6e206a4675154">AllMercsLookForDoor</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fUpdateValue )
<a name="l01290"></a>01290 {
<a name="l01291"></a>01291       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                    cnt, cnt2;
<a name="l01292"></a>01292       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                                                         bDirs[ 8 ] = { <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7d0611de6f28d4a9c9eac959f5344698e">NORTH</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b78ef5c0bce69283a9986011a63eea8a6b">SOUTH</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7b5b3793b961949c817c7c0d99c05dad7">EAST</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7e9449e8683a8199dad36b07a63b2f523">WEST</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7a6671505783298e4cb967931c1c1ac5b">NORTHEAST</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7c8aee466c121a3c3c942f58e1d8864d4">NORTHWEST</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b716c2c7abfbd3bad3343b0dcaa858bb49">SOUTHEAST</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b76aa90951b336be999de204e61dd366d4">SOUTHWEST</a> };
<a name="l01293"></a>01293       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a>                                      *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l01294"></a>01294       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                                        sDistVisible;    
<a name="l01295"></a>01295       DOOR_STATUS                                      *pDoorStatus;
<a name="l01296"></a>01296       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                                             usNewGridNo;
<a name="l01297"></a>01297 
<a name="l01298"></a>01298       <span class="comment">// Get door</span>
<a name="l01299"></a>01299       pDoorStatus = <a class="code" href="Keys_8cpp.html#baeda4a8cbd53f6a4a750a15101bdeb2">GetDoorStatus</a>( sGridNo );
<a name="l01300"></a>01300 
<a name="l01301"></a>01301       <span class="keywordflow">if</span> ( pDoorStatus == NULL )
<a name="l01302"></a>01302       {
<a name="l01303"></a>01303             <span class="keywordflow">return</span>( FALSE );
<a name="l01304"></a>01304       }
<a name="l01305"></a>01305 
<a name="l01306"></a>01306       <span class="comment">// IF IT'S THE SELECTED GUY, MAKE ANOTHER SELECTED!</span>
<a name="l01307"></a>01307       cnt = <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> ].<a class="code" href="structTacticalTeamType.html#f8fe819ad07b242f5dbf97fd4c69b00d">bFirstID</a>;
<a name="l01308"></a>01308 
<a name="l01309"></a>01309       <span class="comment">// look for all mercs on the same team, </span>
<a name="l01310"></a>01310       <span class="keywordflow">for</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ cnt ]; cnt &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> ].<a class="code" href="structTacticalTeamType.html#6a887279dad735dc302f21c1e559d5ce">bLastID</a>; cnt++,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>++ )
<a name="l01311"></a>01311       { 
<a name="l01312"></a>01312             <span class="comment">// ATE: Ok, lets check for some basic things here!</span>
<a name="l01313"></a>01313             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a> &gt;= OKLIFE &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a> != NOWHERE &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#653dad4e2520784e293eca9f948b8532">bActive</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b0096f321a0de4f0617283f7b3212aa0">bInSector</a> )
<a name="l01314"></a>01314             {
<a name="l01315"></a>01315                   <span class="comment">// is he close enough to see that gridno if he turns his head?</span>
<a name="l01316"></a>01316                   sDistVisible = <a class="code" href="opplist_8cpp.html#3024b66f9b450ab359bf03734c3aad9b">DistanceVisible</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7680b9f541cb30851967400ce4b0f2807">DIRECTION_IRRELEVANT</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7680b9f541cb30851967400ce4b0f2807">DIRECTION_IRRELEVANT</a>, sGridNo, 0, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01317"></a>01317                   
<a name="l01318"></a>01318                   <span class="keywordflow">if</span> (<a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, sGridNo ) &lt;= sDistVisible )
<a name="l01319"></a>01319                   {
<a name="l01320"></a>01320                         <span class="comment">// and we can trace a line of sight to his x,y coordinates?</span>
<a name="l01321"></a>01321                         <span class="comment">// (taking into account we are definitely aware of this guy now)</span>
<a name="l01322"></a>01322                         <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( <a class="code" href="LOS_8cpp.html#7ccd0f206cf1c499fcb25349e20fd106">SoldierTo3DLocationLineOfSightTest</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sGridNo, 0, 0, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) sDistVisible, TRUE ) )
<a name="l01323"></a>01323                         {
<a name="l01324"></a>01324                               <span class="comment">// Update status...</span>
<a name="l01325"></a>01325                               <span class="keywordflow">if</span> ( fUpdateValue )
<a name="l01326"></a>01326                               {
<a name="l01327"></a>01327                                     <a class="code" href="Keys_8cpp.html#45457afbca611277a89d4a6a60e43b2c">InternalUpdateDoorsPerceivedValue</a>( pDoorStatus );
<a name="l01328"></a>01328                               }
<a name="l01329"></a>01329                               <span class="keywordflow">return</span>( TRUE );
<a name="l01330"></a>01330                         }
<a name="l01331"></a>01331                   }
<a name="l01332"></a>01332 
<a name="l01333"></a>01333                   <span class="comment">// Now try other adjacent gridnos...</span>
<a name="l01334"></a>01334                   <span class="keywordflow">for</span> ( cnt2 = 0; cnt2 &lt; 8; cnt2++ )
<a name="l01335"></a>01335                   {
<a name="l01336"></a>01336                               usNewGridNo = <a class="code" href="Isometric_01Utils_8cpp.html#318d8410127e29bb232ab70363bc316e">NewGridNo</a>( sGridNo, <a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( bDirs[ cnt2 ] ) );
<a name="l01337"></a>01337                               sDistVisible = <a class="code" href="opplist_8cpp.html#3024b66f9b450ab359bf03734c3aad9b">DistanceVisible</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7680b9f541cb30851967400ce4b0f2807">DIRECTION_IRRELEVANT</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7680b9f541cb30851967400ce4b0f2807">DIRECTION_IRRELEVANT</a>, usNewGridNo, 0, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01338"></a>01338                         
<a name="l01339"></a>01339                               <span class="keywordflow">if</span> (<a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, usNewGridNo ) &lt;= sDistVisible )
<a name="l01340"></a>01340                               {
<a name="l01341"></a>01341                                     <span class="comment">// and we can trace a line of sight to his x,y coordinates?</span>
<a name="l01342"></a>01342                                     <span class="comment">// (taking into account we are definitely aware of this guy now)</span>
<a name="l01343"></a>01343                                     <span class="keywordflow">if</span> ( <a class="code" href="LOS_8cpp.html#7ccd0f206cf1c499fcb25349e20fd106">SoldierTo3DLocationLineOfSightTest</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usNewGridNo, 0, 0, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) sDistVisible, TRUE ) )
<a name="l01344"></a>01344                                     {
<a name="l01345"></a>01345                                           <span class="comment">// Update status...</span>
<a name="l01346"></a>01346                                           <span class="keywordflow">if</span> ( fUpdateValue )
<a name="l01347"></a>01347                                           {
<a name="l01348"></a>01348                                                 <a class="code" href="Keys_8cpp.html#45457afbca611277a89d4a6a60e43b2c">InternalUpdateDoorsPerceivedValue</a>( pDoorStatus );
<a name="l01349"></a>01349                                           }
<a name="l01350"></a>01350                                           <span class="keywordflow">return</span>( TRUE );
<a name="l01351"></a>01351                                     }
<a name="l01352"></a>01352                               }
<a name="l01353"></a>01353                   }
<a name="l01354"></a>01354             }
<a name="l01355"></a>01355       }
<a name="l01356"></a>01356 
<a name="l01357"></a>01357       <span class="keywordflow">return</span>( FALSE );
<a name="l01358"></a>01358 }
<a name="l01359"></a>01359 
<a name="l01360"></a>01360 
<a name="l01361"></a><a class="code" href="Keys_8h.html#99dc8cf8ac168a1e358576f1f35774e0">01361</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#99dc8cf8ac168a1e358576f1f35774e0">MercLooksForDoors</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fUpdateValue )
<a name="l01362"></a>01362 {
<a name="l01363"></a>01363       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                    cnt, cnt2;
<a name="l01364"></a>01364       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                                        sDistVisible;    
<a name="l01365"></a>01365       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                                        sGridNo;
<a name="l01366"></a>01366       DOOR_STATUS                                      *pDoorStatus;
<a name="l01367"></a>01367       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                                                         bDirs[ 8 ] = { <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7d0611de6f28d4a9c9eac959f5344698e">NORTH</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b78ef5c0bce69283a9986011a63eea8a6b">SOUTH</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7b5b3793b961949c817c7c0d99c05dad7">EAST</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7e9449e8683a8199dad36b07a63b2f523">WEST</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7a6671505783298e4cb967931c1c1ac5b">NORTHEAST</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7c8aee466c121a3c3c942f58e1d8864d4">NORTHWEST</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b716c2c7abfbd3bad3343b0dcaa858bb49">SOUTHEAST</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b76aa90951b336be999de204e61dd366d4">SOUTHWEST</a> };
<a name="l01368"></a>01368       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>                                                        usNewGridNo;
<a name="l01369"></a>01369 
<a name="l01370"></a>01370 
<a name="l01371"></a>01371 
<a name="l01372"></a>01372       <span class="comment">// Loop through all corpses....</span>
<a name="l01373"></a>01373       <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; gubNumDoorStatus; cnt++ )
<a name="l01374"></a>01374       {
<a name="l01375"></a>01375             pDoorStatus = &amp;( gpDoorStatus[ cnt ] );
<a name="l01376"></a>01376 
<a name="l01377"></a>01377             <span class="keywordflow">if</span> ( !<a class="code" href="Keys_8cpp.html#041a1847b1285f61dea1dedabe2f445d">InternalIsPerceivedDifferentThanReality</a>( pDoorStatus ) )
<a name="l01378"></a>01378             {
<a name="l01379"></a>01379                   <span class="keywordflow">continue</span>;
<a name="l01380"></a>01380             }
<a name="l01381"></a>01381 
<a name="l01382"></a>01382             sGridNo = pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#770d8232151bd48f0f384be74f5fb252">sGridNo</a>;
<a name="l01383"></a>01383 
<a name="l01384"></a>01384             <span class="comment">// is he close enough to see that gridno if he turns his head?</span>
<a name="l01385"></a>01385             sDistVisible = <a class="code" href="opplist_8cpp.html#3024b66f9b450ab359bf03734c3aad9b">DistanceVisible</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7680b9f541cb30851967400ce4b0f2807">DIRECTION_IRRELEVANT</a>, <a class="code" href="Overhead_01Types_8h.html#df5bf54a26a76adf253f57d88ade82b7680b9f541cb30851967400ce4b0f2807">DIRECTION_IRRELEVANT</a>, sGridNo, 0, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> );
<a name="l01386"></a>01386             
<a name="l01387"></a>01387             <span class="keywordflow">if</span> ( <a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, sGridNo ) &lt;= sDistVisible )
<a name="l01388"></a>01388             {
<a name="l01389"></a>01389                   <span class="comment">// and we can trace a line of sight to his x,y coordinates?</span>
<a name="l01390"></a>01390                   <span class="comment">// (taking into account we are definitely aware of this guy now)</span>
<a name="l01391"></a>01391                   <span class="keywordflow">if</span> ( <a class="code" href="LOS_8cpp.html#7ccd0f206cf1c499fcb25349e20fd106">SoldierTo3DLocationLineOfSightTest</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, sGridNo, 0, 0, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) sDistVisible, TRUE ) )
<a name="l01392"></a>01392                   {
<a name="l01393"></a>01393                         <span class="comment">// OK, here... update perceived value....</span>
<a name="l01394"></a>01394                         <span class="keywordflow">if</span> ( fUpdateValue )
<a name="l01395"></a>01395                         {
<a name="l01396"></a>01396                               <a class="code" href="Keys_8cpp.html#45457afbca611277a89d4a6a60e43b2c">InternalUpdateDoorsPerceivedValue</a>( pDoorStatus );
<a name="l01397"></a>01397 
<a name="l01398"></a>01398                               <span class="comment">// Update graphic....</span>
<a name="l01399"></a>01399                               <a class="code" href="Keys_8cpp.html#145ac35032d0afbd82b707e11812739d">InternalUpdateDoorGraphicFromStatus</a>( pDoorStatus, TRUE, TRUE );
<a name="l01400"></a>01400                         }
<a name="l01401"></a>01401                         <span class="keywordflow">return</span>( TRUE );
<a name="l01402"></a>01402                   }
<a name="l01403"></a>01403             }
<a name="l01404"></a>01404 
<a name="l01405"></a>01405             <span class="comment">// Now try other adjacent gridnos...</span>
<a name="l01406"></a>01406             <span class="keywordflow">for</span> ( cnt2 = 0; cnt2 &lt; 8; cnt2++ )
<a name="l01407"></a>01407             {
<a name="l01408"></a>01408                     usNewGridNo = <a class="code" href="Isometric_01Utils_8cpp.html#318d8410127e29bb232ab70363bc316e">NewGridNo</a>( sGridNo, <a class="code" href="Isometric_01Utils_8cpp.html#a4a3adf599f99864b1de33673888fd5e">DirectionInc</a>( bDirs[ cnt2 ] ) );
<a name="l01409"></a>01409                   
<a name="l01410"></a>01410                         <span class="keywordflow">if</span> (<a class="code" href="Isometric_01Utils_8cpp.html#a9c80c0c7523c83360aeb6b46963780b">PythSpacesAway</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2ab66ee0f37902cd448f4a738df4f2bf">sGridNo</a>, usNewGridNo ) &lt;= sDistVisible )
<a name="l01411"></a>01411                         {
<a name="l01412"></a>01412                               <span class="comment">// and we can trace a line of sight to his x,y coordinates?</span>
<a name="l01413"></a>01413                               <span class="comment">// (taking into account we are definitely aware of this guy now)</span>
<a name="l01414"></a>01414                               <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( <a class="code" href="LOS_8cpp.html#7ccd0f206cf1c499fcb25349e20fd106">SoldierTo3DLocationLineOfSightTest</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, usNewGridNo, 0, 0, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) sDistVisible, TRUE ) )
<a name="l01415"></a>01415                               {
<a name="l01416"></a>01416                                     <span class="comment">// Update status...</span>
<a name="l01417"></a>01417                                     <span class="keywordflow">if</span> ( fUpdateValue )
<a name="l01418"></a>01418                                     {
<a name="l01419"></a>01419                                           <a class="code" href="Keys_8cpp.html#45457afbca611277a89d4a6a60e43b2c">InternalUpdateDoorsPerceivedValue</a>( pDoorStatus );
<a name="l01420"></a>01420 
<a name="l01421"></a>01421                                           <span class="comment">// Update graphic....</span>
<a name="l01422"></a>01422                                           <a class="code" href="Keys_8cpp.html#145ac35032d0afbd82b707e11812739d">InternalUpdateDoorGraphicFromStatus</a>( pDoorStatus, TRUE, TRUE );
<a name="l01423"></a>01423 
<a name="l01424"></a>01424                                     }
<a name="l01425"></a>01425                                     <span class="keywordflow">return</span>( TRUE );
<a name="l01426"></a>01426                               }
<a name="l01427"></a>01427                         }
<a name="l01428"></a>01428             }
<a name="l01429"></a>01429 
<a name="l01430"></a>01430       }
<a name="l01431"></a>01431 
<a name="l01432"></a>01432       <span class="keywordflow">return</span>( FALSE );
<a name="l01433"></a>01433 }
<a name="l01434"></a>01434 
<a name="l01435"></a><a class="code" href="Keys_8cpp.html#2970697de53ce7081ff1664b462b9bdf">01435</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#2970697de53ce7081ff1664b462b9bdf">SyncronizeDoorStatusToStructureData</a>( DOOR_STATUS *pDoorStatus )
<a name="l01436"></a>01436 {
<a name="l01437"></a>01437       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a> *pStructure, *pBaseStructure;
<a name="l01438"></a>01438       <a class="code" href="structTAG__level__node.html">LEVELNODE</a> * pNode;
<a name="l01439"></a>01439       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sBaseGridNo                    = NOWHERE;
<a name="l01440"></a>01440 
<a name="l01441"></a>01441       <span class="comment">// First look for a door structure here...</span>
<a name="l01442"></a>01442       pStructure = <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#770d8232151bd48f0f384be74f5fb252">sGridNo</a>, STRUCTURE_ANYDOOR );
<a name="l01443"></a>01443 
<a name="l01444"></a>01444       <span class="keywordflow">if</span> (pStructure)
<a name="l01445"></a>01445       {
<a name="l01446"></a>01446             pBaseStructure = <a class="code" href="structure_8cpp.html#b55dd5bf5b84e82450258b2ffd222181">FindBaseStructure</a>( pStructure );
<a name="l01447"></a>01447             sBaseGridNo    = pBaseStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#0d887297b2381aceed479a0ace92e895">sGridNo</a>;
<a name="l01448"></a>01448       }
<a name="l01449"></a>01449       <span class="keywordflow">else</span>
<a name="l01450"></a>01450       {
<a name="l01451"></a>01451             pBaseStructure = NULL;
<a name="l01452"></a>01452       }
<a name="l01453"></a>01453 
<a name="l01454"></a>01454       <span class="keywordflow">if</span> ( pBaseStructure == NULL )
<a name="l01455"></a>01455       {
<a name="l01456"></a>01456 <span class="preprocessor">#if 0</span>
<a name="l01457"></a>01457 <span class="preprocessor"></span>            <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L<span class="stringliteral">"Door structure data at %d was not found"</span>, pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#770d8232151bd48f0f384be74f5fb252">sGridNo</a> );
<a name="l01458"></a>01458 <span class="preprocessor">#endif</span>
<a name="l01459"></a>01459 <span class="preprocessor"></span>            <span class="keywordflow">return</span>;
<a name="l01460"></a>01460       }
<a name="l01461"></a>01461 
<a name="l01462"></a>01462       pNode = <a class="code" href="worldman_8cpp.html#e2df8481c67a19731cc710feb2d440cc">FindLevelNodeBasedOnStructure</a>( sBaseGridNo, pBaseStructure );
<a name="l01463"></a>01463       <span class="keywordflow">if</span> (!pNode)
<a name="l01464"></a>01464       {
<a name="l01465"></a>01465 <span class="preprocessor">#ifdef JA2BETAVERSION</span>
<a name="l01466"></a>01466 <span class="preprocessor"></span>            <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L<span class="stringliteral">"Could not find levelnode from door structure at %d"</span>, pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#770d8232151bd48f0f384be74f5fb252">sGridNo</a> );
<a name="l01467"></a>01467 <span class="preprocessor">#endif</span>
<a name="l01468"></a>01468 <span class="preprocessor"></span>            <span class="keywordflow">return</span>;
<a name="l01469"></a>01469       }
<a name="l01470"></a>01470 
<a name="l01471"></a>01471       <span class="comment">// ATE: OK let me explain something here:</span>
<a name="l01472"></a>01472       <span class="comment">// One of the purposes of this function is to MAKE sure the door status MATCHES</span>
<a name="l01473"></a>01473       <span class="comment">// the struct data value - if not - change ( REGARDLESS of perceived being used or not... )</span>
<a name="l01474"></a>01474       <span class="comment">// </span>
<a name="l01475"></a>01475       <span class="comment">// Check for opened...</span>
<a name="l01476"></a>01476       <span class="keywordflow">if</span> ( pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_OPEN )
<a name="l01477"></a>01477       {
<a name="l01478"></a>01478             <span class="comment">// IF closed.....</span>
<a name="l01479"></a>01479             <span class="keywordflow">if</span> ( !( pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#5a803a00d8769236709b4f0665951383">fFlags</a> &amp; STRUCTURE_OPEN ) )
<a name="l01480"></a>01480             {
<a name="l01481"></a>01481                   <span class="comment">// Swap!</span>
<a name="l01482"></a>01482                   <a class="code" href="structure_8cpp.html#ad13bc1d7d88f89467a75846644e1387">SwapStructureForPartner</a>( sBaseGridNo, pBaseStructure ); 
<a name="l01483"></a>01483                   <a class="code" href="worlddef_8cpp.html#b6f63b0553b0ec12788bcf9f76e59b23">RecompileLocalMovementCosts</a>( sBaseGridNo );
<a name="l01484"></a>01484             }
<a name="l01485"></a>01485       }
<a name="l01486"></a>01486       <span class="keywordflow">else</span>
<a name="l01487"></a>01487       {     
<a name="l01488"></a>01488             <span class="keywordflow">if</span> ( ( pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#5a803a00d8769236709b4f0665951383">fFlags</a> &amp; STRUCTURE_OPEN ) )
<a name="l01489"></a>01489             {
<a name="l01490"></a>01490                   <span class="comment">// Swap!</span>
<a name="l01491"></a>01491                   <a class="code" href="structure_8cpp.html#ad13bc1d7d88f89467a75846644e1387">SwapStructureForPartner</a>( sBaseGridNo, pBaseStructure ); 
<a name="l01492"></a>01492                   <a class="code" href="worlddef_8cpp.html#b6f63b0553b0ec12788bcf9f76e59b23">RecompileLocalMovementCosts</a>( sBaseGridNo );
<a name="l01493"></a>01493             }
<a name="l01494"></a>01494       }
<a name="l01495"></a>01495 }     
<a name="l01496"></a>01496 
<a name="l01497"></a><a class="code" href="Keys_8h.html#e63d5e09f2250d49389d78115be6ba39">01497</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#e63d5e09f2250d49389d78115be6ba39">UpdateDoorGraphicsFromStatus</a>( <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fUsePerceivedStatus, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fDirty )
<a name="l01498"></a>01498 {
<a name="l01499"></a>01499       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                    cnt;
<a name="l01500"></a>01500       DOOR_STATUS                                      *pDoorStatus;
<a name="l01501"></a>01501 
<a name="l01502"></a>01502       <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; gubNumDoorStatus; cnt++ )
<a name="l01503"></a>01503       {
<a name="l01504"></a>01504             pDoorStatus = &amp;( gpDoorStatus[ cnt ] );
<a name="l01505"></a>01505 
<a name="l01506"></a>01506             <span class="comment">// ATE: Make sure door status flag and struct info are syncronized....</span>
<a name="l01507"></a>01507             <a class="code" href="Keys_8cpp.html#2970697de53ce7081ff1664b462b9bdf">SyncronizeDoorStatusToStructureData</a>( pDoorStatus );
<a name="l01508"></a>01508 
<a name="l01509"></a>01509             <a class="code" href="Keys_8cpp.html#145ac35032d0afbd82b707e11812739d">InternalUpdateDoorGraphicFromStatus</a>( pDoorStatus, fUsePerceivedStatus, fDirty );
<a name="l01510"></a>01510       }
<a name="l01511"></a>01511 }
<a name="l01512"></a>01512 
<a name="l01513"></a><a class="code" href="Keys_8cpp.html#145ac35032d0afbd82b707e11812739d">01513</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#145ac35032d0afbd82b707e11812739d">InternalUpdateDoorGraphicFromStatus</a>( DOOR_STATUS *pDoorStatus, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fUsePerceivedStatus, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fDirty )
<a name="l01514"></a>01514 {
<a name="l01515"></a>01515       <a class="code" href="structTAG__STRUCTURE.html">STRUCTURE</a> *pStructure, *pBaseStructure;
<a name="l01516"></a>01516       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>             cnt;
<a name="l01517"></a>01517       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>           fOpenedGraphic = FALSE;
<a name="l01518"></a>01518       <a class="code" href="structTAG__level__node.html">LEVELNODE</a> * pNode;
<a name="l01519"></a>01519       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>           fWantToBeOpen  = FALSE;
<a name="l01520"></a>01520       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>           fDifferent     = FALSE;
<a name="l01521"></a>01521       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sBaseGridNo                    = NOWHERE;
<a name="l01522"></a>01522 
<a name="l01523"></a>01523 
<a name="l01524"></a>01524       <span class="comment">// OK, look at perceived status and adjust graphic</span>
<a name="l01525"></a>01525       <span class="comment">// First look for a door structure here...</span>
<a name="l01526"></a>01526       pStructure = <a class="code" href="structure_8cpp.html#ee89227e95ac05ac3aac945c1ed529a0">FindStructure</a>( pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#770d8232151bd48f0f384be74f5fb252">sGridNo</a>, STRUCTURE_ANYDOOR );
<a name="l01527"></a>01527 
<a name="l01528"></a>01528       <span class="keywordflow">if</span> (pStructure)
<a name="l01529"></a>01529       {
<a name="l01530"></a>01530             pBaseStructure = <a class="code" href="structure_8cpp.html#b55dd5bf5b84e82450258b2ffd222181">FindBaseStructure</a>( pStructure );
<a name="l01531"></a>01531             sBaseGridNo    = pBaseStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#0d887297b2381aceed479a0ace92e895">sGridNo</a>;
<a name="l01532"></a>01532       }
<a name="l01533"></a>01533       <span class="keywordflow">else</span>
<a name="l01534"></a>01534       {
<a name="l01535"></a>01535             pBaseStructure = NULL;
<a name="l01536"></a>01536       }
<a name="l01537"></a>01537 
<a name="l01538"></a>01538       <span class="keywordflow">if</span> ( pBaseStructure == NULL )
<a name="l01539"></a>01539       {
<a name="l01540"></a>01540 <span class="preprocessor">#if 0</span>
<a name="l01541"></a>01541 <span class="preprocessor"></span>            <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L<span class="stringliteral">"Door structure data at %d was not found"</span>, pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#770d8232151bd48f0f384be74f5fb252">sGridNo</a> );
<a name="l01542"></a>01542 <span class="preprocessor">#endif</span>
<a name="l01543"></a>01543 <span class="preprocessor"></span>            <span class="keywordflow">return</span>;
<a name="l01544"></a>01544       }
<a name="l01545"></a>01545 
<a name="l01546"></a>01546       pNode = <a class="code" href="worldman_8cpp.html#e2df8481c67a19731cc710feb2d440cc">FindLevelNodeBasedOnStructure</a>( sBaseGridNo, pBaseStructure );
<a name="l01547"></a>01547       <span class="keywordflow">if</span> (!pNode)
<a name="l01548"></a>01548       {
<a name="l01549"></a>01549 <span class="preprocessor">#ifdef JA2BETAVERSION</span>
<a name="l01550"></a>01550 <span class="preprocessor"></span>            <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_BETAVERSION, L<span class="stringliteral">"Could not find levelnode from door structure at %d"</span>, pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#770d8232151bd48f0f384be74f5fb252">sGridNo</a> );
<a name="l01551"></a>01551 <span class="preprocessor">#endif</span>
<a name="l01552"></a>01552 <span class="preprocessor"></span>            <span class="keywordflow">return</span>;
<a name="l01553"></a>01553       }
<a name="l01554"></a>01554 
<a name="l01555"></a>01555       <span class="comment">// Get status we want to chenge to.....</span>
<a name="l01556"></a>01556       <span class="keywordflow">if</span> ( fUsePerceivedStatus )
<a name="l01557"></a>01557       {
<a name="l01558"></a>01558             <span class="keywordflow">if</span> ( pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_PERCEIVED_OPEN )
<a name="l01559"></a>01559             {
<a name="l01560"></a>01560                   fWantToBeOpen = TRUE;
<a name="l01561"></a>01561             }
<a name="l01562"></a>01562       }
<a name="l01563"></a>01563       <span class="keywordflow">else</span>
<a name="l01564"></a>01564       {
<a name="l01565"></a>01565             <span class="keywordflow">if</span> ( pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_OPEN )
<a name="l01566"></a>01566             {
<a name="l01567"></a>01567                   fWantToBeOpen = TRUE;
<a name="l01568"></a>01568             }
<a name="l01569"></a>01569       }
<a name="l01570"></a>01570 
<a name="l01571"></a>01571       <span class="comment">// First look for an opened door</span>
<a name="l01572"></a>01572       <span class="comment">// get what it is now...</span>
<a name="l01573"></a>01573       cnt = 0;
<a name="l01574"></a>01574       <span class="keywordflow">while</span>( <a class="code" href="TileDat_8cpp.html#42cff4e9f1adc7423077ddbbb6b68f9e">gClosedDoorList</a>[ cnt ] != -1 )
<a name="l01575"></a>01575       {
<a name="l01576"></a>01576             <span class="comment">// IF WE ARE A SHADOW TYPE</span>
<a name="l01577"></a>01577             <span class="keywordflow">if</span> ( pNode-&gt;<a class="code" href="structTAG__level__node.html#52b821707a4f7d758df5f97d376ef9f7">usIndex</a> == <a class="code" href="TileDat_8cpp.html#42cff4e9f1adc7423077ddbbb6b68f9e">gClosedDoorList</a>[ cnt ] )
<a name="l01578"></a>01578             {
<a name="l01579"></a>01579                   fOpenedGraphic = TRUE;
<a name="l01580"></a>01580                   <span class="keywordflow">break</span>;
<a name="l01581"></a>01581             }
<a name="l01582"></a>01582             cnt++;
<a name="l01583"></a>01583       };
<a name="l01584"></a>01584 
<a name="l01585"></a>01585       <span class="comment">// OK, we either have an opened graphic, in which case we want to switch to the closed, or a closed</span>
<a name="l01586"></a>01586       <span class="comment">// in which case we want to switch to opened...</span>
<a name="l01587"></a>01587       <span class="comment">// adjust o' graphic</span>
<a name="l01588"></a>01588 
<a name="l01589"></a>01589 
<a name="l01590"></a>01590       <span class="comment">// OK, we now need to test these things against the true structure data</span>
<a name="l01591"></a>01591       <span class="comment">// we may need to only adjust the graphic here....</span>
<a name="l01592"></a>01592       <span class="keywordflow">if</span> ( fWantToBeOpen &amp;&amp; ( pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#5a803a00d8769236709b4f0665951383">fFlags</a> &amp; STRUCTURE_OPEN ) )
<a name="l01593"></a>01593       {
<a name="l01594"></a>01594             <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fFound = FALSE;
<a name="l01595"></a>01595             <span class="comment">// Adjust graphic....</span>
<a name="l01596"></a>01596             
<a name="l01597"></a>01597             <span class="comment">// Loop through and and find opened graphic for the closed one....</span>
<a name="l01598"></a>01598             cnt = 0;
<a name="l01599"></a>01599             <span class="keywordflow">while</span>( <a class="code" href="TileDat_8cpp.html#c3371becc7cda1d5a228357dce68c845">gOpenDoorList</a>[ cnt ] != -1 )
<a name="l01600"></a>01600             {
<a name="l01601"></a>01601                   <span class="comment">// IF WE ARE A SHADOW TYPE</span>
<a name="l01602"></a>01602                   <span class="keywordflow">if</span> ( pNode-&gt;<a class="code" href="structTAG__level__node.html#52b821707a4f7d758df5f97d376ef9f7">usIndex</a> == <a class="code" href="TileDat_8cpp.html#c3371becc7cda1d5a228357dce68c845">gOpenDoorList</a>[ cnt ] )
<a name="l01603"></a>01603                   {
<a name="l01604"></a>01604                         fFound = TRUE;
<a name="l01605"></a>01605                         <span class="keywordflow">break</span>;
<a name="l01606"></a>01606                   }
<a name="l01607"></a>01607                   cnt++;
<a name="l01608"></a>01608             };
<a name="l01609"></a>01609             
<a name="l01610"></a>01610             <span class="comment">// OK, now use opened graphic.</span>
<a name="l01611"></a>01611             <span class="keywordflow">if</span> ( fFound )
<a name="l01612"></a>01612             {
<a name="l01613"></a>01613                   pNode-&gt;<a class="code" href="structTAG__level__node.html#52b821707a4f7d758df5f97d376ef9f7">usIndex</a> = <a class="code" href="TileDat_8cpp.html#42cff4e9f1adc7423077ddbbb6b68f9e">gClosedDoorList</a>[ cnt ];
<a name="l01614"></a>01614 
<a name="l01615"></a>01615                   <span class="keywordflow">if</span> ( fDirty )
<a name="l01616"></a>01616                   {
<a name="l01617"></a>01617                         <a class="code" href="renderworld_8cpp.html#1e1ddb2858063ee68614cd6c221369bb">InvalidateWorldRedundency</a>( );
<a name="l01618"></a>01618                         <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>( RENDER_FLAG_FULL );
<a name="l01619"></a>01619                   }
<a name="l01620"></a>01620             }
<a name="l01621"></a>01621 
<a name="l01622"></a>01622             <span class="keywordflow">return</span>;
<a name="l01623"></a>01623       }
<a name="l01624"></a>01624       
<a name="l01625"></a>01625       <span class="comment">// If we want to be closed but structure is closed</span>
<a name="l01626"></a>01626       <span class="keywordflow">if</span> ( !fWantToBeOpen &amp;&amp; !( pStructure-&gt;<a class="code" href="structTAG__STRUCTURE.html#5a803a00d8769236709b4f0665951383">fFlags</a> &amp; STRUCTURE_OPEN ) )
<a name="l01627"></a>01627       {
<a name="l01628"></a>01628             <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fFound = FALSE;
<a name="l01629"></a>01629             <span class="comment">// Adjust graphic....</span>
<a name="l01630"></a>01630             
<a name="l01631"></a>01631             <span class="comment">// Loop through and and find closed graphic for the opend one....</span>
<a name="l01632"></a>01632             cnt = 0;
<a name="l01633"></a>01633             <span class="keywordflow">while</span>( <a class="code" href="TileDat_8cpp.html#42cff4e9f1adc7423077ddbbb6b68f9e">gClosedDoorList</a>[ cnt ] != -1 )
<a name="l01634"></a>01634             {
<a name="l01635"></a>01635                   <span class="comment">// IF WE ARE A SHADOW TYPE</span>
<a name="l01636"></a>01636                   <span class="keywordflow">if</span> ( pNode-&gt;<a class="code" href="structTAG__level__node.html#52b821707a4f7d758df5f97d376ef9f7">usIndex</a> == <a class="code" href="TileDat_8cpp.html#42cff4e9f1adc7423077ddbbb6b68f9e">gClosedDoorList</a>[ cnt ] )
<a name="l01637"></a>01637                   {
<a name="l01638"></a>01638                         fFound = TRUE;
<a name="l01639"></a>01639                         <span class="keywordflow">break</span>;
<a name="l01640"></a>01640                   }
<a name="l01641"></a>01641                   cnt++;
<a name="l01642"></a>01642             };
<a name="l01643"></a>01643             
<a name="l01644"></a>01644             <span class="comment">// OK, now use opened graphic.</span>
<a name="l01645"></a>01645             <span class="keywordflow">if</span> ( fFound )
<a name="l01646"></a>01646             {
<a name="l01647"></a>01647                   pNode-&gt;<a class="code" href="structTAG__level__node.html#52b821707a4f7d758df5f97d376ef9f7">usIndex</a> = <a class="code" href="TileDat_8cpp.html#c3371becc7cda1d5a228357dce68c845">gOpenDoorList</a>[ cnt ];
<a name="l01648"></a>01648 
<a name="l01649"></a>01649                   <span class="keywordflow">if</span> ( fDirty )
<a name="l01650"></a>01650                   {
<a name="l01651"></a>01651                         <a class="code" href="renderworld_8cpp.html#1e1ddb2858063ee68614cd6c221369bb">InvalidateWorldRedundency</a>( );
<a name="l01652"></a>01652                         <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>( RENDER_FLAG_FULL );
<a name="l01653"></a>01653                   }
<a name="l01654"></a>01654             }
<a name="l01655"></a>01655 
<a name="l01656"></a>01656             <span class="keywordflow">return</span>;
<a name="l01657"></a>01657       }
<a name="l01658"></a>01658 
<a name="l01659"></a>01659 
<a name="l01660"></a>01660       <span class="keywordflow">if</span> ( fOpenedGraphic &amp;&amp; !fWantToBeOpen )
<a name="l01661"></a>01661       {
<a name="l01662"></a>01662             <span class="comment">// Close the beast!</span>
<a name="l01663"></a>01663             fDifferent = TRUE;
<a name="l01664"></a>01664             pNode-&gt;<a class="code" href="structTAG__level__node.html#52b821707a4f7d758df5f97d376ef9f7">usIndex</a> = <a class="code" href="TileDat_8cpp.html#c3371becc7cda1d5a228357dce68c845">gOpenDoorList</a>[ cnt ];
<a name="l01665"></a>01665       }
<a name="l01666"></a>01666       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !fOpenedGraphic &amp;&amp; fWantToBeOpen )
<a name="l01667"></a>01667       {
<a name="l01668"></a>01668             <span class="comment">// Find the closed door graphic and adjust....</span>
<a name="l01669"></a>01669             cnt = 0;
<a name="l01670"></a>01670             <span class="keywordflow">while</span>( <a class="code" href="TileDat_8cpp.html#c3371becc7cda1d5a228357dce68c845">gOpenDoorList</a>[ cnt ] != -1 )
<a name="l01671"></a>01671             {
<a name="l01672"></a>01672                   <span class="comment">// IF WE ARE A SHADOW TYPE</span>
<a name="l01673"></a>01673                   <span class="keywordflow">if</span> ( pNode-&gt;<a class="code" href="structTAG__level__node.html#52b821707a4f7d758df5f97d376ef9f7">usIndex</a> == <a class="code" href="TileDat_8cpp.html#c3371becc7cda1d5a228357dce68c845">gOpenDoorList</a>[ cnt ] )
<a name="l01674"></a>01674                   {
<a name="l01675"></a>01675                         <span class="comment">// Open the beast!</span>
<a name="l01676"></a>01676                         fDifferent = TRUE;
<a name="l01677"></a>01677                         pNode-&gt;<a class="code" href="structTAG__level__node.html#52b821707a4f7d758df5f97d376ef9f7">usIndex</a> = <a class="code" href="TileDat_8cpp.html#42cff4e9f1adc7423077ddbbb6b68f9e">gClosedDoorList</a>[ cnt ];
<a name="l01678"></a>01678                         <span class="keywordflow">break</span>;
<a name="l01679"></a>01679                   }
<a name="l01680"></a>01680                   cnt++;
<a name="l01681"></a>01681             };
<a name="l01682"></a>01682       }
<a name="l01683"></a>01683 
<a name="l01684"></a>01684       <span class="keywordflow">if</span> ( fDifferent )
<a name="l01685"></a>01685       {
<a name="l01686"></a>01686             <a class="code" href="structure_8cpp.html#ad13bc1d7d88f89467a75846644e1387">SwapStructureForPartner</a>( sBaseGridNo, pBaseStructure );
<a name="l01687"></a>01687  
<a name="l01688"></a>01688             <a class="code" href="worlddef_8cpp.html#b6f63b0553b0ec12788bcf9f76e59b23">RecompileLocalMovementCosts</a>( sBaseGridNo );
<a name="l01689"></a>01689 
<a name="l01690"></a>01690             <span class="keywordflow">if</span> ( fDirty )
<a name="l01691"></a>01691             {
<a name="l01692"></a>01692                   <a class="code" href="renderworld_8cpp.html#1e1ddb2858063ee68614cd6c221369bb">InvalidateWorldRedundency</a>( );
<a name="l01693"></a>01693                   <a class="code" href="renderworld_8cpp.html#986f210b1a26336aa2943bdce24ffb94">SetRenderFlags</a>( RENDER_FLAG_FULL );
<a name="l01694"></a>01694             }
<a name="l01695"></a>01695       }
<a name="l01696"></a>01696 }
<a name="l01697"></a>01697 
<a name="l01698"></a>01698 
<a name="l01699"></a><a class="code" href="Keys_8cpp.html#041a1847b1285f61dea1dedabe2f445d">01699</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#041a1847b1285f61dea1dedabe2f445d">InternalIsPerceivedDifferentThanReality</a>( DOOR_STATUS *pDoorStatus )
<a name="l01700"></a>01700 {
<a name="l01701"></a>01701       <span class="keywordflow">if</span> ( ( pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_PERCEIVED_NOTSET ) )
<a name="l01702"></a>01702       {
<a name="l01703"></a>01703             <span class="keywordflow">return</span>( TRUE );
<a name="l01704"></a>01704       }
<a name="l01705"></a>01705 
<a name="l01706"></a>01706       <span class="comment">// Compare flags....</span>
<a name="l01707"></a>01707       <span class="keywordflow">if</span> ( ( pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_OPEN &amp;&amp; pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_PERCEIVED_OPEN ) ||
<a name="l01708"></a>01708                    ( !( pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_OPEN ) &amp;&amp; !( pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_PERCEIVED_OPEN ) ) )
<a name="l01709"></a>01709       {
<a name="l01710"></a>01710             <span class="keywordflow">return</span>( FALSE );
<a name="l01711"></a>01711       }
<a name="l01712"></a>01712 
<a name="l01713"></a>01713       <span class="keywordflow">return</span>( TRUE );
<a name="l01714"></a>01714 }
<a name="l01715"></a>01715 
<a name="l01716"></a><a class="code" href="Keys_8cpp.html#45457afbca611277a89d4a6a60e43b2c">01716</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#45457afbca611277a89d4a6a60e43b2c">InternalUpdateDoorsPerceivedValue</a>( DOOR_STATUS *pDoorStatus )
<a name="l01717"></a>01717 {
<a name="l01718"></a>01718       <span class="comment">// OK, look at door, set perceived value the same as actual....</span>
<a name="l01719"></a>01719       <span class="keywordflow">if</span> ( pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_OPEN )
<a name="l01720"></a>01720       {
<a name="l01721"></a>01721             <a class="code" href="Keys_8cpp.html#db8b808b372b84d51abc27f557362ea2">InternalSetDoorPerceivedOpenStatus</a>( pDoorStatus, TRUE );
<a name="l01722"></a>01722       }
<a name="l01723"></a>01723       <span class="keywordflow">else</span>
<a name="l01724"></a>01724       {
<a name="l01725"></a>01725             <a class="code" href="Keys_8cpp.html#db8b808b372b84d51abc27f557362ea2">InternalSetDoorPerceivedOpenStatus</a>( pDoorStatus, FALSE );
<a name="l01726"></a>01726       }
<a name="l01727"></a>01727 }
<a name="l01728"></a>01728 
<a name="l01729"></a><a class="code" href="Keys_8h.html#185aced535189940b31c222d85aef36b">01729</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#185aced535189940b31c222d85aef36b">UpdateDoorStatusPerceivedValue</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo )
<a name="l01730"></a>01730 {
<a name="l01731"></a>01731       DOOR_STATUS *pDoorStatus = NULL;
<a name="l01732"></a>01732       
<a name="l01733"></a>01733       pDoorStatus = <a class="code" href="Keys_8cpp.html#baeda4a8cbd53f6a4a750a15101bdeb2">GetDoorStatus</a>( sGridNo );
<a name="l01734"></a>01734       CHECKF( pDoorStatus != NULL );
<a name="l01735"></a>01735 
<a name="l01736"></a>01736       <a class="code" href="Keys_8cpp.html#45457afbca611277a89d4a6a60e43b2c">InternalUpdateDoorsPerceivedValue</a>( pDoorStatus );
<a name="l01737"></a>01737 
<a name="l01738"></a>01738       <span class="keywordflow">return</span>( TRUE );
<a name="l01739"></a>01739 }
<a name="l01740"></a>01740 
<a name="l01741"></a>01741 
<a name="l01742"></a><a class="code" href="Keys_8h.html#39f96a65dd60a61889d28cbc674b5c06">01742</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>     <a class="code" href="Keys_8cpp.html#39f96a65dd60a61889d28cbc674b5c06">IsDoorPerceivedOpen</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo )
<a name="l01743"></a>01743 {
<a name="l01744"></a>01744       DOOR_STATUS * pDoorStatus;
<a name="l01745"></a>01745       
<a name="l01746"></a>01746       pDoorStatus = <a class="code" href="Keys_8cpp.html#baeda4a8cbd53f6a4a750a15101bdeb2">GetDoorStatus</a>( sGridNo );
<a name="l01747"></a>01747 
<a name="l01748"></a>01748       <span class="keywordflow">if</span> (pDoorStatus &amp;&amp; pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp; DOOR_PERCEIVED_OPEN)
<a name="l01749"></a>01749       {
<a name="l01750"></a>01750             <span class="keywordflow">return</span>( TRUE );
<a name="l01751"></a>01751       }
<a name="l01752"></a>01752       <span class="keywordflow">else</span>
<a name="l01753"></a>01753       {
<a name="l01754"></a>01754 <span class="preprocessor">            #ifdef JA2TESTVERSION</span>
<a name="l01755"></a>01755 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (!pDoorStatus)
<a name="l01756"></a>01756                   {
<a name="l01757"></a>01757                         <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( FONT_MCOLOR_LTYELLOW, MSG_TESTVERSION, L<span class="stringliteral">"WARNING! Failed to find the Perceived Open Door Status on Gridno %s"</span>, sGridNo );
<a name="l01758"></a>01758                   }
<a name="l01759"></a>01759 <span class="preprocessor">            #endif</span>
<a name="l01760"></a>01760 <span class="preprocessor"></span>
<a name="l01761"></a>01761             <span class="keywordflow">return</span>( FALSE );
<a name="l01762"></a>01762       }
<a name="l01763"></a>01763 }
<a name="l01764"></a>01764 
<a name="l01765"></a>01765 
<a name="l01766"></a><a class="code" href="Keys_8cpp.html#db8b808b372b84d51abc27f557362ea2">01766</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>     <a class="code" href="Keys_8cpp.html#db8b808b372b84d51abc27f557362ea2">InternalSetDoorPerceivedOpenStatus</a>( DOOR_STATUS *pDoorStatus, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fPerceivedOpen )
<a name="l01767"></a>01767 {
<a name="l01768"></a>01768       <span class="keywordflow">if</span>( fPerceivedOpen )
<a name="l01769"></a>01769             pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> |= DOOR_PERCEIVED_OPEN;
<a name="l01770"></a>01770       <span class="keywordflow">else</span>
<a name="l01771"></a>01771             pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp;= ~DOOR_PERCEIVED_OPEN;
<a name="l01772"></a>01772 
<a name="l01773"></a>01773       <span class="comment">// Turn off perceived not set flag....</span>
<a name="l01774"></a>01774       pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp;= ~DOOR_PERCEIVED_NOTSET;
<a name="l01775"></a>01775 
<a name="l01776"></a>01776       <span class="keywordflow">return</span>( TRUE );
<a name="l01777"></a>01777 }
<a name="l01778"></a>01778 
<a name="l01779"></a>01779 
<a name="l01780"></a><a class="code" href="Keys_8h.html#1c3724fc8c1d728107ea102598f8616f">01780</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>     <a class="code" href="Keys_8cpp.html#1c3724fc8c1d728107ea102598f8616f">SetDoorPerceivedOpenStatus</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fPerceivedOpen )
<a name="l01781"></a>01781 {
<a name="l01782"></a>01782       DOOR_STATUS *pDoorStatus = NULL;
<a name="l01783"></a>01783       
<a name="l01784"></a>01784       pDoorStatus = <a class="code" href="Keys_8cpp.html#baeda4a8cbd53f6a4a750a15101bdeb2">GetDoorStatus</a>( sGridNo );
<a name="l01785"></a>01785 
<a name="l01786"></a>01786       CHECKF( pDoorStatus != NULL );
<a name="l01787"></a>01787 
<a name="l01788"></a>01788       <span class="keywordflow">return</span>( <a class="code" href="Keys_8cpp.html#db8b808b372b84d51abc27f557362ea2">InternalSetDoorPerceivedOpenStatus</a>( pDoorStatus, fPerceivedOpen ) );
<a name="l01789"></a>01789 
<a name="l01790"></a>01790 }
<a name="l01791"></a>01791 
<a name="l01792"></a>01792 
<a name="l01793"></a><a class="code" href="Keys_8h.html#0888176ee32301d5103645289577311c">01793</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>     <a class="code" href="Keys_8cpp.html#0888176ee32301d5103645289577311c">SetDoorOpenStatus</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fOpen )
<a name="l01794"></a>01794 {
<a name="l01795"></a>01795       DOOR_STATUS * pDoorStatus;
<a name="l01796"></a>01796 
<a name="l01797"></a>01797       pDoorStatus = <a class="code" href="Keys_8cpp.html#baeda4a8cbd53f6a4a750a15101bdeb2">GetDoorStatus</a>( sGridNo );
<a name="l01798"></a>01798 
<a name="l01799"></a>01799       <span class="keywordflow">if</span> ( pDoorStatus ) 
<a name="l01800"></a>01800       {
<a name="l01801"></a>01801             <span class="keywordflow">if</span>( fOpen )
<a name="l01802"></a>01802             {
<a name="l01803"></a>01803                   pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> |= DOOR_OPEN;
<a name="l01804"></a>01804             }
<a name="l01805"></a>01805             <span class="keywordflow">else</span>
<a name="l01806"></a>01806             {
<a name="l01807"></a>01807                   pDoorStatus-&gt;<a class="code" href="structDOOR__STATUS.html#e09c612d4a9e5091a6649a1581012d3f">ubFlags</a> &amp;= ~DOOR_OPEN;
<a name="l01808"></a>01808             }
<a name="l01809"></a>01809             <span class="keywordflow">return</span>( TRUE );
<a name="l01810"></a>01810       }
<a name="l01811"></a>01811       <span class="keywordflow">else</span>
<a name="l01812"></a>01812       {
<a name="l01813"></a>01813             <span class="keywordflow">return</span>( FALSE );
<a name="l01814"></a>01814       }
<a name="l01815"></a>01815 
<a name="l01816"></a>01816 }
<a name="l01817"></a>01817 
<a name="l01818"></a>01818 
<a name="l01819"></a><a class="code" href="Keys_8h.html#4188580910540540fa99205b2d26da32">01819</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#4188580910540540fa99205b2d26da32">SaveDoorStatusArrayToDoorStatusTempFile</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorX, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorY, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bSectorZ )
<a name="l01820"></a>01820 {
<a name="l01821"></a>01821       <a class="code" href="Types_8h.html#2f68f0189367ead40015f7c0ec68eb9e">CHAR8</a>       zMapName[ 128 ];
<a name="l01822"></a>01822       <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a>      hFile;
<a name="l01823"></a>01823       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiNumBytesWritten;
<a name="l01824"></a>01824       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>       ubCnt;
<a name="l01825"></a>01825 
<a name="l01826"></a>01826       <span class="comment">// Turn off any DOOR BUSY flags....</span>
<a name="l01827"></a>01827       <span class="keywordflow">for</span>( ubCnt=0; ubCnt &lt; gubNumDoorStatus; ubCnt++)
<a name="l01828"></a>01828       {
<a name="l01829"></a>01829             gpDoorStatus[ ubCnt ].ubFlags &amp;= ( ~DOOR_BUSY );
<a name="l01830"></a>01830       }
<a name="l01831"></a>01831 
<a name="l01832"></a>01832 
<a name="l01833"></a>01833       <span class="comment">//Convert the current sector location into a file name</span>
<a name="l01834"></a>01834 <span class="comment">//    GetMapFileName( sSectorX, sSectorY, bSectorZ, zTempName, FALSE );</span>
<a name="l01835"></a>01835 
<a name="l01836"></a>01836       <span class="comment">//add the 'm' for 'Modifed Map' to the front of the map name</span>
<a name="l01837"></a>01837 <span class="comment">//    sprintf( zMapName, "%s\\ds_%s", MAPS_DIR, zTempName);</span>
<a name="l01838"></a>01838 
<a name="l01839"></a>01839       <a class="code" href="Tactical_01Save_8cpp.html#ac1ec82dd3bcbf09c20edda3ac4a1d75">GetMapTempFileName</a>( SF_DOOR_STATUS_TEMP_FILE_EXISTS, zMapName, sSectorX, sSectorY, bSectorZ );
<a name="l01840"></a>01840 
<a name="l01841"></a>01841 
<a name="l01842"></a>01842       <span class="comment">//Open the file for writing, Create it if it doesnt exist</span>
<a name="l01843"></a>01843       hFile = <a class="code" href="FileMan_8cpp.html#1e5007589e18cbc273b9677470215db4">FileOpen</a>( zMapName, FILE_ACCESS_WRITE | FILE_OPEN_ALWAYS, FALSE );
<a name="l01844"></a>01844       <span class="keywordflow">if</span>( hFile == 0 )
<a name="l01845"></a>01845       {
<a name="l01846"></a>01846             <span class="comment">//Error opening map modification file</span>
<a name="l01847"></a>01847             <span class="keywordflow">return</span>( FALSE );
<a name="l01848"></a>01848       }
<a name="l01849"></a>01849 
<a name="l01850"></a>01850 
<a name="l01851"></a>01851       <span class="comment">//Save the number of elements in the door array</span>
<a name="l01852"></a>01852       <a class="code" href="FileMan_8cpp.html#09ed41c07d607c8c64a7e2b9fb25660c">FileWrite</a>( hFile, &amp;gubNumDoorStatus, <span class="keyword">sizeof</span>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ), &amp;uiNumBytesWritten );
<a name="l01853"></a>01853       <span class="keywordflow">if</span>( uiNumBytesWritten != <span class="keyword">sizeof</span>( UINT8 ) )
<a name="l01854"></a>01854       {
<a name="l01855"></a>01855             <span class="comment">//Error Writing size of array to disk</span>
<a name="l01856"></a>01856             <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l01857"></a>01857             <span class="keywordflow">return</span>( FALSE );
<a name="l01858"></a>01858       }
<a name="l01859"></a>01859 
<a name="l01860"></a>01860       <span class="comment">//if there is some to save</span>
<a name="l01861"></a>01861       <span class="keywordflow">if</span>( gubNumDoorStatus != 0 )
<a name="l01862"></a>01862       {
<a name="l01863"></a>01863             <span class="comment">//Save the door array</span>
<a name="l01864"></a>01864             <a class="code" href="FileMan_8cpp.html#09ed41c07d607c8c64a7e2b9fb25660c">FileWrite</a>( hFile, gpDoorStatus, ( <span class="keyword">sizeof</span>( DOOR_STATUS ) * gubNumDoorStatus ), &amp;uiNumBytesWritten );
<a name="l01865"></a>01865             <span class="keywordflow">if</span>( uiNumBytesWritten != ( <span class="keyword">sizeof</span>( DOOR_STATUS ) * gubNumDoorStatus ) )
<a name="l01866"></a>01866             {
<a name="l01867"></a>01867                   <span class="comment">//Error Writing size of array to disk</span>
<a name="l01868"></a>01868                   <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l01869"></a>01869                   <span class="keywordflow">return</span>( FALSE );
<a name="l01870"></a>01870             }
<a name="l01871"></a>01871       }
<a name="l01872"></a>01872 
<a name="l01873"></a>01873       <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l01874"></a>01874 
<a name="l01875"></a>01875       <span class="comment">//Set the flag indicating that there is a door status array</span>
<a name="l01876"></a>01876       <a class="code" href="Tactical_01Save_8cpp.html#1d9e3649d7691d4447d80af4c235ad0a">SetSectorFlag</a>( sSectorX, sSectorY, bSectorZ, SF_DOOR_STATUS_TEMP_FILE_EXISTS );
<a name="l01877"></a>01877 
<a name="l01878"></a>01878       <span class="keywordflow">return</span>( TRUE );
<a name="l01879"></a>01879 }
<a name="l01880"></a>01880 
<a name="l01881"></a>01881 
<a name="l01882"></a><a class="code" href="Keys_8h.html#a6509aff3267c2b503607179b3fb9e25">01882</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#a6509aff3267c2b503607179b3fb9e25">LoadDoorStatusArrayFromDoorStatusTempFile</a>()
<a name="l01883"></a>01883 {
<a name="l01884"></a>01884       <a class="code" href="Types_8h.html#2f68f0189367ead40015f7c0ec68eb9e">CHAR8</a>       zMapName[ 128 ];
<a name="l01885"></a>01885       <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a>      hFile;
<a name="l01886"></a>01886       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiNumBytesRead;
<a name="l01887"></a>01887       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>       ubLoop;
<a name="l01888"></a>01888 
<a name="l01889"></a>01889       <span class="comment">//Convert the current sector location into a file name</span>
<a name="l01890"></a>01890 <span class="comment">//    GetMapFileName( gWorldSectorX, gWorldSectorY, gbWorldSectorZ, zTempName, FALSE );</span>
<a name="l01891"></a>01891 
<a name="l01892"></a>01892       <span class="comment">//add the 'm' for 'Modifed Map' to the front of the map name</span>
<a name="l01893"></a>01893 <span class="comment">//    sprintf( zMapName, "%s\\ds_%s", MAPS_DIR, zTempName);</span>
<a name="l01894"></a>01894 
<a name="l01895"></a>01895       <a class="code" href="Tactical_01Save_8cpp.html#ac1ec82dd3bcbf09c20edda3ac4a1d75">GetMapTempFileName</a>( SF_DOOR_STATUS_TEMP_FILE_EXISTS, zMapName, <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a>, <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a>, <a class="code" href="strategicmap_8cpp.html#da715721a8ceedd42acf6ddb33e63ce0">gbWorldSectorZ</a> );
<a name="l01896"></a>01896 
<a name="l01897"></a>01897       <span class="comment">//Get rid of the existing door array</span>
<a name="l01898"></a>01898       <a class="code" href="Keys_8cpp.html#6b9fb34a2b6a189d2b6c308f13b6f777">TrashDoorStatusArray</a>( );
<a name="l01899"></a>01899 
<a name="l01900"></a>01900       <span class="comment">//Open the file for reading</span>
<a name="l01901"></a>01901       hFile = <a class="code" href="FileMan_8cpp.html#1e5007589e18cbc273b9677470215db4">FileOpen</a>( zMapName, FILE_ACCESS_READ | FILE_OPEN_EXISTING, FALSE );
<a name="l01902"></a>01902       <span class="keywordflow">if</span>( hFile == 0 )
<a name="l01903"></a>01903       {
<a name="l01904"></a>01904             <span class="comment">//Error opening map modification file,</span>
<a name="l01905"></a>01905             <span class="keywordflow">return</span>( FALSE );
<a name="l01906"></a>01906       }
<a name="l01907"></a>01907 
<a name="l01908"></a>01908 
<a name="l01909"></a>01909       <span class="comment">// Load the number of elements in the door status array</span>
<a name="l01910"></a>01910       <a class="code" href="FileMan_8cpp.html#1b213074411fd4c1dc8fd345e787b17e">FileRead</a>( hFile, &amp;gubNumDoorStatus, <span class="keyword">sizeof</span>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ), &amp;uiNumBytesRead );
<a name="l01911"></a>01911       <span class="keywordflow">if</span>( uiNumBytesRead != <span class="keyword">sizeof</span>( UINT8 ) )
<a name="l01912"></a>01912       {
<a name="l01913"></a>01913             <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l01914"></a>01914             <span class="keywordflow">return</span>( FALSE );
<a name="l01915"></a>01915       }
<a name="l01916"></a>01916 
<a name="l01917"></a>01917       <span class="keywordflow">if</span>( gubNumDoorStatus == 0 )
<a name="l01918"></a>01918       {
<a name="l01919"></a>01919             <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l01920"></a>01920             <span class="keywordflow">return</span>( TRUE );
<a name="l01921"></a>01921       }
<a name="l01922"></a>01922 
<a name="l01923"></a>01923 
<a name="l01924"></a>01924       <span class="comment">//Allocate space for the door status array</span>
<a name="l01925"></a>01925       gpDoorStatus = (DOOR_STATUS *) MemAlloc( <span class="keyword">sizeof</span>( DOOR_STATUS ) * gubNumDoorStatus );
<a name="l01926"></a>01926       <span class="keywordflow">if</span>( gpDoorStatus == NULL )
<a name="l01927"></a>01927             AssertMsg( 0, <span class="stringliteral">"Error Allocating memory for the gpDoorStatus"</span> );
<a name="l01928"></a>01928       memset( gpDoorStatus, 0, <span class="keyword">sizeof</span>( DOOR_STATUS ) * gubNumDoorStatus );
<a name="l01929"></a>01929 
<a name="l01930"></a>01930 
<a name="l01931"></a>01931       <span class="comment">// Load the number of elements in the door status array</span>
<a name="l01932"></a>01932       <a class="code" href="FileMan_8cpp.html#1b213074411fd4c1dc8fd345e787b17e">FileRead</a>( hFile, gpDoorStatus, ( <span class="keyword">sizeof</span>( DOOR_STATUS ) * gubNumDoorStatus ), &amp;uiNumBytesRead );
<a name="l01933"></a>01933       <span class="keywordflow">if</span>( uiNumBytesRead != ( <span class="keyword">sizeof</span>( DOOR_STATUS ) * gubNumDoorStatus ) )
<a name="l01934"></a>01934       {
<a name="l01935"></a>01935             <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l01936"></a>01936             <span class="keywordflow">return</span>( FALSE );
<a name="l01937"></a>01937       }
<a name="l01938"></a>01938 
<a name="l01939"></a>01939       <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFile );
<a name="l01940"></a>01940 
<a name="l01941"></a>01941       <span class="comment">// the graphics will be updated later in the loading process.</span>
<a name="l01942"></a>01942 
<a name="l01943"></a>01943       <span class="comment">// set flags in map for containing a door status </span>
<a name="l01944"></a>01944       <span class="keywordflow">for</span> (ubLoop = 0; ubLoop &lt; gubNumDoorStatus; ubLoop++)
<a name="l01945"></a>01945       {
<a name="l01946"></a>01946             <a class="code" href="worlddef_8cpp.html#a1c640bcf89772795e6517da9963e0d7">gpWorldLevelData</a>[ gpDoorStatus[ ubLoop ].sGridNo ].ubExtFlags[0] |= MAPELEMENT_EXT_DOOR_STATUS_PRESENT;
<a name="l01947"></a>01947       }
<a name="l01948"></a>01948 
<a name="l01949"></a>01949       <a class="code" href="Keys_8cpp.html#e63d5e09f2250d49389d78115be6ba39">UpdateDoorGraphicsFromStatus</a>( TRUE, FALSE );
<a name="l01950"></a>01950 
<a name="l01951"></a>01951       <span class="keywordflow">return</span>( TRUE );
<a name="l01952"></a>01952 }
<a name="l01953"></a>01953 
<a name="l01954"></a>01954 
<a name="l01955"></a><a class="code" href="Keys_8h.html#402b5ac4d3c6c171f7d2c7ca3d42a07d">01955</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#402b5ac4d3c6c171f7d2c7ca3d42a07d">SaveKeyTableToSaveGameFile</a>( <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a> hFile )
<a name="l01956"></a>01956 {
<a name="l01957"></a>01957       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiNumBytesWritten=0;
<a name="l01958"></a>01958 
<a name="l01959"></a>01959 
<a name="l01960"></a>01960       <span class="comment">// Save the KeyTable</span>
<a name="l01961"></a>01961       <a class="code" href="FileMan_8cpp.html#09ed41c07d607c8c64a7e2b9fb25660c">FileWrite</a>( hFile, <a class="code" href="Keys_8cpp.html#ab8078c8cf4279fff5dff74c95741089">KeyTable</a>, <span class="keyword">sizeof</span>( <a class="code" href="structKEY.html">KEY</a> ) * NUM_KEYS, &amp;uiNumBytesWritten );
<a name="l01962"></a>01962       <span class="keywordflow">if</span>( uiNumBytesWritten != <span class="keyword">sizeof</span>( KEY ) * NUM_KEYS )
<a name="l01963"></a>01963       {
<a name="l01964"></a>01964             <span class="keywordflow">return</span>( FALSE );
<a name="l01965"></a>01965       }
<a name="l01966"></a>01966 
<a name="l01967"></a>01967       <span class="keywordflow">return</span>( TRUE );
<a name="l01968"></a>01968 }
<a name="l01969"></a>01969 
<a name="l01970"></a><a class="code" href="Keys_8h.html#a75c1c638b6060f2c69906208f8a87b0">01970</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Keys_8cpp.html#a75c1c638b6060f2c69906208f8a87b0">LoadKeyTableFromSaveedGameFile</a>( <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a> hFile )
<a name="l01971"></a>01971 {
<a name="l01972"></a>01972       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiNumBytesRead=0;
<a name="l01973"></a>01973 
<a name="l01974"></a>01974 
<a name="l01975"></a>01975       <span class="comment">// Load the KeyTable</span>
<a name="l01976"></a>01976       <a class="code" href="FileMan_8cpp.html#1b213074411fd4c1dc8fd345e787b17e">FileRead</a>( hFile, <a class="code" href="Keys_8cpp.html#ab8078c8cf4279fff5dff74c95741089">KeyTable</a>, <span class="keyword">sizeof</span>( <a class="code" href="structKEY.html">KEY</a> ) * NUM_KEYS, &amp;uiNumBytesRead );
<a name="l01977"></a>01977       <span class="keywordflow">if</span>( uiNumBytesRead != <span class="keyword">sizeof</span>( KEY ) * NUM_KEYS )
<a name="l01978"></a>01978       {
<a name="l01979"></a>01979             <span class="keywordflow">return</span>( FALSE );
<a name="l01980"></a>01980       }
<a name="l01981"></a>01981 
<a name="l01982"></a>01982       <span class="keywordflow">return</span>( TRUE );
<a name="l01983"></a>01983 }
<a name="l01984"></a>01984 
<a name="l01985"></a>01985 
<a name="l01986"></a>01986 
<a name="l01987"></a><a class="code" href="Keys_8h.html#6065e25766f654b608001ecf108a6c50">01987</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#6065e25766f654b608001ecf108a6c50">ExamineDoorsOnEnteringSector</a>( )
<a name="l01988"></a>01988 {
<a name="l01989"></a>01989       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                    cnt;
<a name="l01990"></a>01990       DOOR_STATUS                                      *pDoorStatus;
<a name="l01991"></a>01991       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a>              *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l01992"></a>01992       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                                                      fOK = FALSE;     
<a name="l01993"></a>01993       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                                                         bTownId;
<a name="l01994"></a>01994 
<a name="l01995"></a>01995       <span class="comment">// OK, only do this if conditions are met....</span>
<a name="l01996"></a>01996       <span class="comment">// If this is any omerta tow, don't do it...</span>
<a name="l01997"></a>01997       bTownId = <a class="code" href="strategicmap_8cpp.html#99dffd29ea4571bc0c833d45636f1403">GetTownIdForSector</a>( <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a>, <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a> );
<a name="l01998"></a>01998 
<a name="l01999"></a>01999       <span class="keywordflow">if</span> ( bTownId == <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105d4e8ff4822ac436590f6cfbf3b35764d">OMERTA</a> )
<a name="l02000"></a>02000       {
<a name="l02001"></a>02001             <span class="keywordflow">return</span>;
<a name="l02002"></a>02002       }
<a name="l02003"></a>02003 
<a name="l02004"></a>02004       <span class="comment">// Check time...</span>
<a name="l02005"></a>02005       <span class="keywordflow">if</span> ( ( <a class="code" href="Game_01Clock_8cpp.html#4d255e800fba4d64144a7639d5f3421d">GetWorldTotalMin</a>( ) - <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#37390c323ee29162a3cf12d1ce5a69dc">uiTimeSinceLastInTactical</a> ) &lt; 30 )
<a name="l02006"></a>02006       {
<a name="l02007"></a>02007             <span class="keywordflow">return</span>;
<a name="l02008"></a>02008       }
<a name="l02009"></a>02009 
<a name="l02010"></a>02010       <span class="comment">// there is at least one human being in that sector.</span>
<a name="l02011"></a>02011       <span class="comment">// check for civ</span>
<a name="l02012"></a>02012       cnt = <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ ENEMY_TEAM ].<a class="code" href="structTacticalTeamType.html#f8fe819ad07b242f5dbf97fd4c69b00d">bFirstID</a>;
<a name="l02013"></a>02013   <span class="comment">// look for all mercs on the same team, </span>
<a name="l02014"></a>02014   <span class="keywordflow">for</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ cnt ]; cnt &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ LAST_TEAM ].<a class="code" href="structTacticalTeamType.html#6a887279dad735dc302f21c1e559d5ce">bLastID</a>; cnt++ ,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>++ )
<a name="l02015"></a>02015       {       
<a name="l02016"></a>02016             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#653dad4e2520784e293eca9f948b8532">bActive</a> )
<a name="l02017"></a>02017             {
<a name="l02018"></a>02018                   <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b0096f321a0de4f0617283f7b3212aa0">bInSector</a> )
<a name="l02019"></a>02019                   {
<a name="l02020"></a>02020                         fOK = TRUE;
<a name="l02021"></a>02021                         <span class="keywordflow">break</span>;
<a name="l02022"></a>02022                   }
<a name="l02023"></a>02023             }
<a name="l02024"></a>02024       }
<a name="l02025"></a>02025 
<a name="l02026"></a>02026       <span class="comment">// Let's do it!</span>
<a name="l02027"></a>02027       <span class="keywordflow">if</span> ( fOK )
<a name="l02028"></a>02028       {
<a name="l02029"></a>02029             <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; gubNumDoorStatus; cnt++ )
<a name="l02030"></a>02030             {
<a name="l02031"></a>02031                   pDoorStatus = &amp;( gpDoorStatus[ cnt ] );
<a name="l02032"></a>02032 
<a name="l02033"></a>02033                   <span class="comment">// Get status of door....</span>
<a name="l02034"></a>02034                   <span class="keywordflow">if</span> ( pDoorStatus-&gt;ubFlags &amp; DOOR_OPEN )
<a name="l02035"></a>02035                   {
<a name="l02036"></a>02036                         <span class="comment">// If open, close!</span>
<a name="l02037"></a>02037                         <a class="code" href="Handle_01Doors_8cpp.html#3d76396114592e1fba74b96e491f66cb">HandleDoorChangeFromGridNo</a>( NULL, pDoorStatus-&gt;sGridNo, TRUE );
<a name="l02038"></a>02038                   }
<a name="l02039"></a>02039             }
<a name="l02040"></a>02040       }
<a name="l02041"></a>02041 }
<a name="l02042"></a>02042 
<a name="l02043"></a><a class="code" href="Keys_8h.html#5bc0f00ecf38bfac1985380a9c792684">02043</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#5bc0f00ecf38bfac1985380a9c792684">HandleDoorsChangeWhenEnteringSectorCurrentlyLoaded</a>( )
<a name="l02044"></a>02044 {
<a name="l02045"></a>02045       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                    cnt;
<a name="l02046"></a>02046       DOOR_STATUS                                      *pDoorStatus;
<a name="l02047"></a>02047       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a>              *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l02048"></a>02048       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a>                                                      fOK = FALSE;     
<a name="l02049"></a>02049       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a>                                                        iNumNewMercs = 0;
<a name="l02050"></a>02050       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>                                                         bTownId;
<a name="l02051"></a>02051 
<a name="l02052"></a>02052       <span class="comment">// OK, only do this if conditions are met....</span>
<a name="l02053"></a>02053 
<a name="l02054"></a>02054       <span class="comment">// If this is any omerta tow, don't do it...</span>
<a name="l02055"></a>02055       bTownId = <a class="code" href="strategicmap_8cpp.html#99dffd29ea4571bc0c833d45636f1403">GetTownIdForSector</a>( <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a>, <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a> );
<a name="l02056"></a>02056 
<a name="l02057"></a>02057       <span class="keywordflow">if</span> ( bTownId == <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105d4e8ff4822ac436590f6cfbf3b35764d">OMERTA</a> )
<a name="l02058"></a>02058       {
<a name="l02059"></a>02059             <span class="keywordflow">return</span>;
<a name="l02060"></a>02060       }
<a name="l02061"></a>02061 
<a name="l02062"></a>02062       <span class="comment">// 1 ) there is at least one human being in that sector.</span>
<a name="l02063"></a>02063       <span class="comment">// check for civ</span>
<a name="l02064"></a>02064       cnt = <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ ENEMY_TEAM ].<a class="code" href="structTacticalTeamType.html#f8fe819ad07b242f5dbf97fd4c69b00d">bFirstID</a>;
<a name="l02065"></a>02065 
<a name="l02066"></a>02066       <span class="comment">// Check time...</span>
<a name="l02067"></a>02067       <span class="keywordflow">if</span> ( ( <a class="code" href="Game_01Clock_8cpp.html#4d255e800fba4d64144a7639d5f3421d">GetWorldTotalMin</a>( ) - <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#37390c323ee29162a3cf12d1ce5a69dc">uiTimeSinceLastInTactical</a> ) &lt; 30 )
<a name="l02068"></a>02068       {
<a name="l02069"></a>02069             <span class="keywordflow">return</span>;
<a name="l02070"></a>02070       }
<a name="l02071"></a>02071 
<a name="l02072"></a>02072   <span class="comment">// look for all mercs on the same team, </span>
<a name="l02073"></a>02073   <span class="keywordflow">for</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ cnt ]; cnt &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ LAST_TEAM ].<a class="code" href="structTacticalTeamType.html#6a887279dad735dc302f21c1e559d5ce">bLastID</a>; cnt++ ,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>++ )
<a name="l02074"></a>02074       {       
<a name="l02075"></a>02075             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#653dad4e2520784e293eca9f948b8532">bActive</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b0096f321a0de4f0617283f7b3212aa0">bInSector</a> )
<a name="l02076"></a>02076             {
<a name="l02077"></a>02077                   fOK = TRUE;
<a name="l02078"></a>02078                   <span class="keywordflow">break</span>;
<a name="l02079"></a>02079             }
<a name="l02080"></a>02080       }
<a name="l02081"></a>02081 
<a name="l02082"></a>02082       <span class="comment">// Loop through our team now....</span>
<a name="l02083"></a>02083       cnt = <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> ].<a class="code" href="structTacticalTeamType.html#f8fe819ad07b242f5dbf97fd4c69b00d">bFirstID</a>;
<a name="l02084"></a>02084   <span class="keywordflow">for</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ cnt ]; cnt &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> ].<a class="code" href="structTacticalTeamType.html#6a887279dad735dc302f21c1e559d5ce">bLastID</a>; cnt++ ,<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>++ )
<a name="l02085"></a>02085       {       
<a name="l02086"></a>02086             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#653dad4e2520784e293eca9f948b8532">bActive</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b0096f321a0de4f0617283f7b3212aa0">bInSector</a> &amp;&amp; <a class="code" href="strategicmap_8cpp.html#01ca3b96c9be3396d25395a427b600b2">gbMercIsNewInThisSector</a>[ cnt ] )
<a name="l02087"></a>02087             {
<a name="l02088"></a>02088                   iNumNewMercs++;
<a name="l02089"></a>02089             }
<a name="l02090"></a>02090       }
<a name="l02091"></a>02091 
<a name="l02092"></a>02092       <span class="comment">// ATE: Only do for newly added mercs....</span>
<a name="l02093"></a>02093       <span class="keywordflow">if</span> ( iNumNewMercs == 0 )
<a name="l02094"></a>02094       {
<a name="l02095"></a>02095             <span class="keywordflow">return</span>;
<a name="l02096"></a>02096       }
<a name="l02097"></a>02097 
<a name="l02098"></a>02098       <span class="comment">// Let's do it!</span>
<a name="l02099"></a>02099       <span class="keywordflow">if</span> ( fOK )
<a name="l02100"></a>02100       {
<a name="l02101"></a>02101             <span class="keywordflow">for</span> ( cnt = 0; cnt &lt; gubNumDoorStatus; cnt++ )
<a name="l02102"></a>02102             {
<a name="l02103"></a>02103                   pDoorStatus = &amp;( gpDoorStatus[ cnt ] );
<a name="l02104"></a>02104 
<a name="l02105"></a>02105                   <span class="comment">// Get status of door....</span>
<a name="l02106"></a>02106                   <span class="keywordflow">if</span> ( pDoorStatus-&gt;ubFlags &amp; DOOR_OPEN )
<a name="l02107"></a>02107                   {
<a name="l02108"></a>02108                         <span class="comment">// If open, close!</span>
<a name="l02109"></a>02109                         <a class="code" href="Handle_01Doors_8cpp.html#c8ac61ac8c29302277c028f6784edfae">gfSetPerceivedDoorState</a> = TRUE;
<a name="l02110"></a>02110 
<a name="l02111"></a>02111                         <a class="code" href="Handle_01Doors_8cpp.html#3d76396114592e1fba74b96e491f66cb">HandleDoorChangeFromGridNo</a>( NULL, pDoorStatus-&gt;sGridNo, TRUE );
<a name="l02112"></a>02112 
<a name="l02113"></a>02113                         <a class="code" href="Handle_01Doors_8cpp.html#c8ac61ac8c29302277c028f6784edfae">gfSetPerceivedDoorState</a> = FALSE;
<a name="l02114"></a>02114                         
<a name="l02115"></a>02115                         <a class="code" href="Keys_8cpp.html#bc18aa8ab066ff5e5de6e206a4675154">AllMercsLookForDoor</a>( pDoorStatus-&gt;sGridNo, TRUE );
<a name="l02116"></a>02116 
<a name="l02117"></a>02117                         <a class="code" href="Keys_8cpp.html#145ac35032d0afbd82b707e11812739d">InternalUpdateDoorGraphicFromStatus</a>( pDoorStatus, TRUE, TRUE );
<a name="l02118"></a>02118 
<a name="l02119"></a>02119                   }
<a name="l02120"></a>02120             }
<a name="l02121"></a>02121       }
<a name="l02122"></a>02122 }
<a name="l02123"></a>02123 
<a name="l02124"></a>02124 
<a name="l02125"></a><a class="code" href="Keys_8h.html#6907736c49e71face380954127acc687">02125</a> <span class="keywordtype">void</span> <a class="code" href="Keys_8cpp.html#6907736c49e71face380954127acc687">DropKeysInKeyRing</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sGridNo, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bLevel, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bVisible, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fAddToDropList, <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iDropListSlot, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fUseUnLoaded )
<a name="l02126"></a>02126 {
<a name="l02127"></a>02127       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>           ubLoop;
<a name="l02128"></a>02128   <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>       ubItem;
<a name="l02129"></a>02129   <a class="code" href="structOBJECTTYPE.html">OBJECTTYPE</a>  Object;
<a name="l02130"></a>02130 
<a name="l02131"></a>02131       <span class="keywordflow">if</span> (!(<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5eb793cec0b17373b557d44083fa6dcb">pKeyRing</a>))
<a name="l02132"></a>02132       {
<a name="l02133"></a>02133             <span class="comment">// no key ring!</span>
<a name="l02134"></a>02134             <span class="keywordflow">return</span>;
<a name="l02135"></a>02135       }
<a name="l02136"></a>02136       <span class="keywordflow">for</span> (ubLoop = 0; ubLoop &lt; NUM_KEYS; ubLoop++)
<a name="l02137"></a>02137       {
<a name="l02138"></a>02138       ubItem = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5eb793cec0b17373b557d44083fa6dcb">pKeyRing</a>[ ubLoop ].<a class="code" href="structKEY__ON__RING.html#3ce49bfe5961be0d65ba15667e8cf633">ubKeyID</a>;
<a name="l02139"></a>02139 
<a name="l02140"></a>02140     <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5eb793cec0b17373b557d44083fa6dcb">pKeyRing</a>[ubLoop].<a class="code" href="structKEY__ON__RING.html#102d2f6c111966fefffe296bfbb1173e">ubNumber</a> &gt; 0 )
<a name="l02141"></a>02141     {
<a name="l02142"></a>02142         <a class="code" href="Items_8cpp.html#586cb2a6f62ea8b5967025cc3507c4e3">CreateKeyObject</a>( &amp;Object, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5eb793cec0b17373b557d44083fa6dcb">pKeyRing</a>[ubLoop].<a class="code" href="structKEY__ON__RING.html#102d2f6c111966fefffe296bfbb1173e">ubNumber</a>, ubItem );
<a name="l02143"></a>02143 
<a name="l02144"></a>02144       <span class="comment">// Zero out entry</span>
<a name="l02145"></a>02145               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5eb793cec0b17373b557d44083fa6dcb">pKeyRing</a>[ ubLoop ].<a class="code" href="structKEY__ON__RING.html#102d2f6c111966fefffe296bfbb1173e">ubNumber</a> = 0;
<a name="l02146"></a>02146               <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5eb793cec0b17373b557d44083fa6dcb">pKeyRing</a>[ ubLoop ].<a class="code" href="structKEY__ON__RING.html#3ce49bfe5961be0d65ba15667e8cf633">ubKeyID</a> = INVALID_KEY_NUMBER;
<a name="l02147"></a>02147 
<a name="l02148"></a>02148       <a class="code" href="Soldier_01Ani_8cpp.html#c294aa65f0375eb6343a2de2a25dafcc">if</a> ( fAddToDropList )
<a name="l02149"></a>02149       {
<a name="l02150"></a>02150         <a class="code" href="Map_01Screen_01Interface_8cpp.html#ab7deaae4a87b22a7808f04b74f02551">AddItemToLeaveIndex</a>( &amp;Object, iDropListSlot );
<a name="l02151"></a>02151       }
<a name="l02152"></a>02152       <span class="keywordflow">else</span>
<a name="l02153"></a>02153       {
<a name="l02154"></a>02154             <span class="keywordflow">if</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6784346500db10daed06c2db02b855c0">sSectorX</a> != <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6dd68e70c3000beb79e4ac45d28a0cbf">sSectorY</a> != <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a> || <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b70b761f0405cc179c1ffba84484df28">bSectorZ</a> != <a class="code" href="strategicmap_8cpp.html#da715721a8ceedd42acf6ddb33e63ce0">gbWorldSectorZ</a> || fUseUnLoaded )
<a name="l02155"></a>02155             {
<a name="l02156"></a>02156           <span class="comment">// Set flag for item...</span>
<a name="l02157"></a>02157                           <a class="code" href="Tactical_01Save_8cpp.html#adcc93e85d8b0ce0a47643071fe0f82d">AddItemsToUnLoadedSector</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6784346500db10daed06c2db02b855c0">sSectorX</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6dd68e70c3000beb79e4ac45d28a0cbf">sSectorY</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b70b761f0405cc179c1ffba84484df28">bSectorZ</a> , sGridNo, 1, &amp;Object , bLevel, WOLRD_ITEM_FIND_SWEETSPOT_FROM_GRIDNO | WORLD_ITEM_REACHABLE, 0, bVisible, FALSE );
<a name="l02158"></a>02158         }
<a name="l02159"></a>02159                     <span class="keywordflow">else</span>
<a name="l02160"></a>02160                     {
<a name="l02161"></a>02161           <span class="comment">// Add to pool</span>
<a name="l02162"></a>02162           <a class="code" href="Handle_01Items_8cpp.html#ca7f6f6da97e9a4c2b737296485f5c84">AddItemToPool</a>( sGridNo, &amp;Object, bVisible, bLevel, 0, 0 );
<a name="l02163"></a>02163                     }
<a name="l02164"></a>02164       }
<a name="l02165"></a>02165     }
<a name="l02166"></a>02166       }
<a name="l02167"></a>02167 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Sep 9 13:48:26 2006 for Build by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
