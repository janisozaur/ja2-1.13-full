<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Build: Strategic Town Loyalty.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_3179ea33d55a76dc38212d9eab798728.html">export</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e5664b4b56927c8728eb3192fa60e338.html">hdc2</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_1eb12a41a47efb9efcd82fa98f4f4dbd.html">FTP</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_80cc1f21a78ab7941088ea567f236150.html">ja2src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_994ab287602efefceafe55287a3657d6.html">Build</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_5aba590d477d4824a9090ab3f8850834.html">Strategic</a></div>
<h1>Strategic Town Loyalty.cpp</h1><a href="Strategic_01Town_01Loyalty_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifdef PRECOMPILEDHEADERS</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">      #include "<a class="code" href="Strategic_01All_8h.html">Strategic All.h</a>"</span>
<a name="l00003"></a>00003 <span class="preprocessor">#else</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor">      #include "<a class="code" href="Strategic_01Town_01Loyalty_8h.html">Strategic Town Loyalty.h</a>"</span>
<a name="l00005"></a>00005 <span class="preprocessor">      #include "<a class="code" href="strategicmap_8h.html">strategicmap.h</a>"</span>
<a name="l00006"></a>00006 <span class="preprocessor">      #include "<a class="code" href="Overhead_8h.html">Overhead.h</a>"</span>
<a name="l00007"></a>00007 <span class="preprocessor">      #include "<a class="code" href="Assignments_8h.html">Assignments.h</a>"</span>
<a name="l00008"></a>00008 <span class="preprocessor">      #include "<a class="code" href="strategic_8h.html">strategic.h</a>"</span>
<a name="l00009"></a>00009 <span class="preprocessor">      #include "<a class="code" href="Queen_01Command_8h.html">Queen Command.h</a>"</span>
<a name="l00010"></a>00010 <span class="preprocessor">      #include "<a class="code" href="Animation_01Data_8h.html">Animation Data.h</a>"</span>
<a name="l00011"></a>00011 <span class="preprocessor">      #include "<a class="code" href="Quests_8h.html">Quests.h</a>"</span>
<a name="l00012"></a>00012 <span class="preprocessor">      #include "<a class="code" href="Font_8h.html">Font.h</a>"</span>
<a name="l00013"></a>00013 <span class="preprocessor">      #include "Message.h"</span>
<a name="l00014"></a>00014 <span class="preprocessor">      #include "<a class="code" href="LOS_8h.html">LOS.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">      #include "<a class="code" href="World_01Items_8h.html">World Items.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">      #include "<a class="code" href="Tactical_01Save_8h.html">Tactical Save.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">      #include "<a class="code" href="Soldier_01Profile_8h.html">Soldier Profile.h</a>"</span>
<a name="l00018"></a>00018 <span class="preprocessor">      #include "<a class="code" href="Handle_01Items_8h.html">Handle Items.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">      #include "<a class="code" href="random_8h.html">random.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">      #include "strategic movement.h"</span>
<a name="l00021"></a>00021 <span class="preprocessor">      #include "<a class="code" href="Strategic_01Pathing_8h.html">Strategic Pathing.h</a>"</span>
<a name="l00022"></a>00022 <span class="preprocessor">      #include "vehicles.h"</span>
<a name="l00023"></a>00023 <span class="preprocessor">      #include "<a class="code" href="Game_01Clock_8h.html">Game Clock.h</a>"</span>
<a name="l00024"></a>00024 <span class="preprocessor">      #include "<a class="code" href="Game_01Event_01Hook_8h.html">Game Event Hook.h</a>"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#endif</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">// the max loyalty rating for any given town</span>
<a name="l00029"></a>00029 <span class="preprocessor">#define MAX_LOYALTY_VALUE 100</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>
<a name="l00031"></a>00031 <span class="comment">// loyalty Omerta drops to and maxes out at if the player betrays the rebels</span>
<a name="l00032"></a>00032 <span class="preprocessor">#define HOSTILE_OMERTA_LOYALTY_RATING           10</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a>00034 <span class="comment">// the loyalty threshold below which theft of unsupervised items in a town sector can occur</span>
<a name="l00035"></a>00035 <span class="preprocessor">#define THRESHOLD_FOR_TOWN_THEFT 50</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>
<a name="l00037"></a>00037 <span class="preprocessor">#define LOYALTY_EVENT_DISTANCE_THRESHOLD        3                 // in sectors</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="comment">// effect of unintentional killing /100 vs intentional murder</span>
<a name="l00041"></a>00041 <span class="preprocessor">#define REDUCTION_FOR_UNINTENTIONAL_KILLING 50</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="comment">// the effect of a murder by rebel / 100 vs player murdering a civ</span>
<a name="l00043"></a>00043 <span class="preprocessor">#define REDUCTION_FOR_MURDER_BY_REBEL 70</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="comment">// reduction % for being falsely blamed for a murder we didn't do, out of 100</span>
<a name="l00045"></a>00045 <span class="preprocessor">#define REDUCTION_FOR_MURDER_NOT_OUR_FAULT 50</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="comment">// reduction % if enemies kills civs in our sector / 100</span>
<a name="l00047"></a>00047 <span class="preprocessor">#define REDUCTION_FOR_MURDER_OF_INNOCENT_BY_ENEMY_IN_OUR_SECTOR 25</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="comment">// how much worse loyalty hit is for trauma of someone killed by a monster</span>
<a name="l00049"></a>00049 <span class="preprocessor">#define MULTIPLIER_FOR_MURDER_BY_MONSTER 2</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">// gain for hiring an NPC from a particular town (represents max. at 100% town attachment)</span>
<a name="l00054"></a>00054 <span class="preprocessor">#define MULTIPLIER_LOCAL_RPC_HIRED                                                              25          // 5%</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00056"></a>00056 <span class="comment">// multiplier for causing pts of damage directly done to a building</span>
<a name="l00057"></a>00057 <span class="preprocessor">#define MULTIPLIER_FOR_DAMAGING_A_BUILDING                                          10          // 50 pts = 1%</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="comment">// multiplier for not preventing pts of damage to a building</span>
<a name="l00059"></a>00059 <span class="preprocessor">#define MULTIPLIER_FOR_NOT_PREVENTING_BUILDING_DAMAGE       3                 // 167 pts = 1%</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span>
<a name="l00061"></a>00061 <span class="comment">// divisor for dmg to a building by allied rebel</span>
<a name="l00062"></a>00062 <span class="preprocessor">#define DIVISOR_FOR_REBEL_BUILDING_DMG                                                    2</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="comment">/*</span>
<a name="l00066"></a>00066 <span class="comment">// max number of soldiers counted towards town loyalty gain</span>
<a name="l00067"></a>00067 <span class="comment">#define MAX_SOLDIER_COUNT_FOR_IN_TOWN_LOYALTY_GAIN 6</span>
<a name="l00068"></a>00068 <span class="comment">// max levels of town militia civs counted towards town loyalty gain</span>
<a name="l00069"></a>00069 <span class="comment">#define MAX_MILITIA_VALUE_FOR_IN_TOWN_LOYALTY_GAIN    18</span>
<a name="l00070"></a>00070 <span class="comment">// max # occupying enemy ranks that count for loyalty penalty</span>
<a name="l00071"></a>00071 <span class="comment">#define MAX_ENEMY_SOLDIER_RANKS_FOR_IN_TOWN_LOYALTY_DROP 15</span>
<a name="l00072"></a>00072 <span class="comment">// number of ranks counted per regular</span>
<a name="l00073"></a>00073 <span class="comment">#define NUMBER_OF_RANKS_PER_REGULAR 2</span>
<a name="l00074"></a>00074 <span class="comment">// number of ranks counted per elite</span>
<a name="l00075"></a>00075 <span class="comment">#define NUMBER_OF_RANKS_PER_ELITE 4</span>
<a name="l00076"></a>00076 <span class="comment"></span>
<a name="l00077"></a>00077 <span class="comment">// THESE VALUES ARE ALL AFFECTED BY CHANGES to "GAIN_PTS_PER_LOYALTY_PT", SO BEWARE IF THAT SHOULD CHANGE</span>
<a name="l00078"></a>00078 <span class="comment">//</span>
<a name="l00079"></a>00079 <span class="comment">// max. rate of loyalty gain for local RPC being stationed in his home town</span>
<a name="l00080"></a>00080 <span class="comment">#define HOURLY_GAIN_FOR_LOCAL_NPC_IN_TOWN 20    // roughly 1.00% / day max.</span>
<a name="l00081"></a>00081 <span class="comment">// number of gain pts per merc in town</span>
<a name="l00082"></a>00082 <span class="comment">#define HOURLY_GAIN_PER_MERC_IN_TOWN 5                      // roughly 0.25% / day</span>
<a name="l00083"></a>00083 <span class="comment">// number of gain pts per friendly in town</span>
<a name="l00084"></a>00084 <span class="comment">#define HOURLY_GAIN_PER_MILITIA_IN_TOWN 1             // roughly 0.05% / day</span>
<a name="l00085"></a>00085 <span class="comment">// loyalty loss for enemies in town</span>
<a name="l00086"></a>00086 <span class="comment">#define HOURLY_DROP_PER_ENEMY_RANK_IN_TOWN 2    // roughly 0.10% / day</span>
<a name="l00087"></a>00087 <span class="comment">*/</span>
<a name="l00088"></a>00088 <span class="comment">//</span>
<a name="l00089"></a>00089 <span class="comment">// THESE VALUES ARE ALL AFFECTED BY CHANGES to "GAIN_PTS_PER_LOYALTY_PT", SO BEWARE IF THAT SHOULD CHANGE</span>
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="comment">/* Delayed loyalty effects elimininated.  Sep.12/98.  ARM</span>
<a name="l00093"></a>00093 <span class="comment"></span>
<a name="l00094"></a>00094 <span class="comment">// macros for delayed town loyalty events</span>
<a name="l00095"></a>00095 <span class="comment">// get increment</span>
<a name="l00096"></a>00096 <span class="comment">#define GET_TOWN_INCREMENT( iValue ) ( ( uiValue &lt;&lt; 31 ) &gt;&gt; 31 )</span>
<a name="l00097"></a>00097 <span class="comment">// town id</span>
<a name="l00098"></a>00098 <span class="comment">#define GET_TOWN_ID_FOR_LOYALTY( iValue ) ( uiValue &gt;&gt; 24 )</span>
<a name="l00099"></a>00099 <span class="comment">// the amount</span>
<a name="l00100"></a>00100 <span class="comment">#define GET_TOWN_LOYALTY_CHANGE( iValue ) ( ( uiValue &lt;&lt; 8 ) &gt;&gt; 9 )</span>
<a name="l00101"></a>00101 <span class="comment">*/</span>
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 <span class="comment">// town loyalty table</span>
<a name="l00105"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#53aef3e8e8681f01397608fbb9dcf56e">00105</a> <a class="code" href="structTOWN__LOYALTY.html">TOWN_LOYALTY</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ];
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="comment">// town name and locations arrays, for town theft and what not</span>
<a name="l00109"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#d40b2b2bafdd7138c146dbf5df81e3be">00109</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#1001d8cb48db71e9db760efbf4353e6a">pTownNamesList</a>[ 40 ];
<a name="l00110"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#aa40c37809e1e09a01cf6d71b27d5fe8">00110</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#c994e67a1f8511a80e6418dc483b0861">pTownLocationsList</a>[ 40 ]; 
<a name="l00111"></a>00111 
<a name="l00112"></a><a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#606e4e4ab2d0901b06efe273b841a0b8">00112</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#606e4e4ab2d0901b06efe273b841a0b8">iTownDistances</a>[ <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ][ <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ];
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="preprocessor">#define BASIC_COST_FOR_CIV_MURDER   (10 * GAIN_PTS_PER_LOYALTY_PT)</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>
<a name="l00117"></a><a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#76c184e9c218f1b075ed7bdcdd66a3d6">00117</a> <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#76c184e9c218f1b075ed7bdcdd66a3d6">uiPercentLoyaltyDecreaseForCivMurder</a>[]={
<a name="l00118"></a>00118       <span class="comment">// These get multiplied by GAIN_PTS_PER_LOYALTY_PT so they're in % of loyalty decrease (for an average town)</span>
<a name="l00119"></a>00119          (5 * GAIN_PTS_PER_LOYALTY_PT),   <span class="comment">// fat civ</span>
<a name="l00120"></a>00120          (7 * GAIN_PTS_PER_LOYALTY_PT),   <span class="comment">// man civ</span>
<a name="l00121"></a>00121          (8 * GAIN_PTS_PER_LOYALTY_PT),   <span class="comment">// min civ</span>
<a name="l00122"></a>00122     (10 * GAIN_PTS_PER_LOYALTY_PT), <span class="comment">// dress (woman)</span>
<a name="l00123"></a>00123     (20 * GAIN_PTS_PER_LOYALTY_PT), <span class="comment">// hat kid</span>
<a name="l00124"></a>00124     (20 * GAIN_PTS_PER_LOYALTY_PT), <span class="comment">// kid</span>
<a name="l00125"></a>00125         (20 * GAIN_PTS_PER_LOYALTY_PT),   <span class="comment">// cripple</span>
<a name="l00126"></a>00126      (1 * GAIN_PTS_PER_LOYALTY_PT), <span class="comment">// cow</span>
<a name="l00127"></a>00127 };
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="comment">// on a scale of 1-100, this is a measure of how much each town hates the Queen's opression &amp; is willing to stand against it</span>
<a name="l00131"></a>00131 <span class="comment">// it primarily controls the RATE of loyalty change in each town: the loyalty effect of the same events depends on it</span>
<a name="l00132"></a><a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#9867add2dc79f5c16824e7663cde8a17">00132</a> <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#9867add2dc79f5c16824e7663cde8a17">gubTownRebelSentiment</a>[ <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ] =
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134       0,    <span class="comment">// not a town - blank sector index</span>
<a name="l00135"></a>00135  90,  <span class="comment">// OMERTA,  - They ARE the rebels!!!</span>
<a name="l00136"></a>00136  30,  <span class="comment">// DRASSEN, - Rebel friendly, makes it pretty easy to get first mine's income going at the start</span>
<a name="l00137"></a>00137  12,  <span class="comment">// ALMA                 - Military town, high loyalty to Queen, need quests to get 100%</span>
<a name="l00138"></a>00138  15,  <span class="comment">// GRUMM,         - Close to Meduna, strong influence</span>
<a name="l00139"></a>00139  20,  <span class="comment">// TIXA,          - Not a real town</span>
<a name="l00140"></a>00140  15,  <span class="comment">// CAMBRIA, - Artificially much lower 'cause it's big and central and too easy to get loyalty up there</span>
<a name="l00141"></a>00141  20,  <span class="comment">// SAN_MONA,- Neutral ground, loyalty doesn't vary</span>
<a name="l00142"></a>00142  20,  <span class="comment">// ESTONI,  - Not a real town</span>
<a name="l00143"></a>00143  20,  <span class="comment">// ORTA,          - Not a real town</span>
<a name="l00144"></a>00144  12,  <span class="comment">// BALIME,  - Rich town, high loyalty to Queen</span>
<a name="l00145"></a>00145  10,  <span class="comment">// MEDUNA,  - Enemy HQ, for God's sake!</span>
<a name="l00146"></a>00146  35,  <span class="comment">// CHITZENA, - Artificially high 'cause there's not enough fights near it to get the loyalty up otherwise</span>
<a name="l00147"></a>00147 };
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#9b06c65f6833d5d0ed217d0c959d80dd">00149</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#9b06c65f6833d5d0ed217d0c959d80dd">gfTownUsesLoyalty</a>[ <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ] =
<a name="l00150"></a>00150 {
<a name="l00151"></a>00151       FALSE,            <span class="comment">// not a town - blank sector index</span>
<a name="l00152"></a>00152       TRUE  ,           <span class="comment">// OMERTA</span>
<a name="l00153"></a>00153       TRUE,             <span class="comment">// DRASSEN</span>
<a name="l00154"></a>00154       TRUE,             <span class="comment">// ALMA</span>
<a name="l00155"></a>00155       TRUE,             <span class="comment">// GRUMM</span>
<a name="l00156"></a>00156       FALSE,            <span class="comment">// TIXA</span>
<a name="l00157"></a>00157       TRUE,             <span class="comment">// CAMBRIA</span>
<a name="l00158"></a>00158       FALSE,            <span class="comment">// SAN_MONA</span>
<a name="l00159"></a>00159       FALSE,            <span class="comment">// ESTONI</span>
<a name="l00160"></a>00160       FALSE,            <span class="comment">// ORTA</span>
<a name="l00161"></a>00161       TRUE,             <span class="comment">// BALIME</span>
<a name="l00162"></a>00162       TRUE,             <span class="comment">// MEDUNA</span>
<a name="l00163"></a>00163       TRUE,             <span class="comment">// CHITZENA</span>
<a name="l00164"></a>00164 };
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 <span class="comment">// location of first enocunter with enemy</span>
<a name="l00167"></a><a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#b14c016f3d2b7115306c10ecd23f9d68">00167</a> <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> <a class="code" href="SaveLoadGame_8cpp.html#b14c016f3d2b7115306c10ecd23f9d68">sWorldSectorLocationOfFirstBattle</a> = 0;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <span class="comment">// number of items in currently loaded sector</span>
<a name="l00170"></a>00170 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>     <a class="code" href="Map_01Screen_01Interface_01Map_01Inventory_8cpp.html#28a0f1d5abf53af570a6a2a140617788">guiNumWorldItems</a>;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 <span class="comment">// preprocess sector for mercs in it</span>
<a name="l00173"></a>00173 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Assignments_8cpp.html#ed03090bb70e5967fde08bbb44920235">fSectorsWithSoldiers</a>[ MAP_WORLD_X * MAP_WORLD_X ][ 4 ];
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="keyword">extern</span> <a class="code" href="Types_8h.html#94ebfccc6e846c28751f8d616371f1e5">STR16</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#68933d9bb7d357af6609236e47fca927">pTownNames</a>[];
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 <span class="comment">// update the loyalty rating of the passed town id</span>
<a name="l00180"></a>00180 <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#e868f0a8f3e5591fdac692080d83f11d">UpdateTownLoyaltyRating</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId );
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="comment">// update town loyalty based on number of friendlies in this town</span>
<a name="l00187"></a>00187 <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0668bbabd7b0e251bfd8debcab5b8470">UpdateTownLoyaltyBasedOnFriendliesInTown</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId );
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="comment">// update town loyalty based on number of bad guys in this town</span>
<a name="l00190"></a>00190 <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#a1b49e2fabe6a9cdf045f2debdad93d3">UpdateTownLoyaltyBasedOnBadGuysInTown</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId );
<a name="l00191"></a>00191  
<a name="l00192"></a>00192 <span class="comment">/* ARM: Civilian theft of items was removed</span>
<a name="l00193"></a>00193 <span class="comment">// handle theft by civi in a town sector</span>
<a name="l00194"></a>00194 <span class="comment">void HandleTheftByCiviliansInSector( INT16 sX, INT16 sY, INT32 iLoyalty );</span>
<a name="l00195"></a>00195 <span class="comment"></span>
<a name="l00196"></a>00196 <span class="comment">// handle theft in all towns</span>
<a name="l00197"></a>00197 <span class="comment">void HandleTownTheft( void );</span>
<a name="l00198"></a>00198 <span class="comment">*/</span>
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="Map_01Screen_01Interface_8cpp.html#e13afb9c6e9e7881a3f76d3c073ec5fc">MapScreenDefaultOkBoxCallback</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> bExitValue );
<a name="l00201"></a>00201 
<a name="l00202"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#3080fcde36f05979c74567dcd5e5765b">00202</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#3080fcde36f05979c74567dcd5e5765b">InitTownLoyalty</a>( <span class="keywordtype">void</span> )
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubTown = 0;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206       <span class="comment">// set up town loyalty table</span>
<a name="l00207"></a>00207       <span class="keywordflow">for</span>( ubTown = FIRST_TOWN; ubTown &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>; ubTown++ )
<a name="l00208"></a>00208       {
<a name="l00209"></a>00209             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ ubTown ].ubRating = 0;
<a name="l00210"></a>00210             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ ubTown ].<a class="code" href="structTOWN__LOYALTY.html#0720401925087e7248e765e6b445473b">sChange</a> = 0;
<a name="l00211"></a>00211             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ ubTown ].<a class="code" href="structTOWN__LOYALTY.html#f44d01f1c8b5626fbd7119d2345f2ddc">fStarted</a> = FALSE;
<a name="l00212"></a>00212 <span class="comment">//          gTownLoyalty[ ubTown ].ubRebelSentiment = gubTownRebelSentiment[ ubTown ];</span>
<a name="l00213"></a>00213             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ ubTown ].<a class="code" href="structTOWN__LOYALTY.html#0fa23b7e6626c155c43e4b7590e09c6f">fLiberatedAlready</a> = FALSE;
<a name="l00214"></a>00214       }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216       <span class="keywordflow">return</span>;
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 
<a name="l00220"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#bc33c7e8a63034980e321214c15a7ea9">00220</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#bc33c7e8a63034980e321214c15a7ea9">StartTownLoyaltyIfFirstTime</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId )
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222       Assert( ( bTownId &gt;= FIRST_TOWN ) &amp;&amp; ( bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ) );
<a name="l00223"></a>00223 
<a name="l00224"></a>00224       <span class="comment">// if loyalty tracking hasn't yet been started for this town, and the town does use loyalty</span>
<a name="l00225"></a>00225       <span class="keywordflow">if</span> (!<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].fStarted &amp;&amp; <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#9b06c65f6833d5d0ed217d0c959d80dd">gfTownUsesLoyalty</a>[ bTownId ])
<a name="l00226"></a>00226       {
<a name="l00227"></a>00227             <span class="comment">// set starting town loyalty now, equally to that town's current rebel sentiment - not all towns begin equally loyal</span>
<a name="l00228"></a>00228             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#d2934532a9d306c7521908308ccb405f">ubRating</a> = <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#9867add2dc79f5c16824e7663cde8a17">gubTownRebelSentiment</a>[ bTownId ];
<a name="l00229"></a>00229 
<a name="l00230"></a>00230             <span class="comment">// if player hasn't made contact with Miguel yet, or the rebels hate the player</span>
<a name="l00231"></a>00231             <span class="keywordflow">if</span> (!<a class="code" href="Quests_8cpp.html#6744b59d27bf2791d0c2fefe18e548d3">CheckFact</a>(<a class="code" href="Quests_8h.html#aead3e57f613f07868a1b2afb6b943f1ab77c7d787cb80e3067b94bad756507e">FACT_MIGUEL_READ_LETTER</a>, 0) || <a class="code" href="Quests_8cpp.html#6744b59d27bf2791d0c2fefe18e548d3">CheckFact</a>( <a class="code" href="Quests_8h.html#aead3e57f613f07868a1b2afb6b943f1f21e923a59cb32420e4b0a76553b911d">FACT_REBELS_HATE_PLAYER</a>, 0 ))
<a name="l00232"></a>00232             {
<a name="l00233"></a>00233                   <span class="comment">// if town is Omerta</span>
<a name="l00234"></a>00234                   <span class="keywordflow">if</span> (bTownId == <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105d4e8ff4822ac436590f6cfbf3b35764d">OMERTA</a>)
<a name="l00235"></a>00235                   {
<a name="l00236"></a>00236                         <span class="comment">// start loyalty there at 0, since rebels distrust the player until Miguel receives the letter</span>
<a name="l00237"></a>00237                         <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#d2934532a9d306c7521908308ccb405f">ubRating</a>  = 0;
<a name="l00238"></a>00238                   }
<a name="l00239"></a>00239                   <span class="keywordflow">else</span>
<a name="l00240"></a>00240                   {
<a name="l00241"></a>00241                         <span class="comment">// starting loyalty is halved - locals not sure what to make of the player's presence</span>
<a name="l00242"></a>00242                         <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#d2934532a9d306c7521908308ccb405f">ubRating</a> /= 2;
<a name="l00243"></a>00243                   }
<a name="l00244"></a>00244             }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#0720401925087e7248e765e6b445473b">sChange</a> = 0;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248             <span class="comment">// remember we've started</span>
<a name="l00249"></a>00249             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#f44d01f1c8b5626fbd7119d2345f2ddc">fStarted</a> = TRUE;
<a name="l00250"></a>00250       }
<a name="l00251"></a>00251 }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 <span class="comment">// set a specified town's loyalty rating (ignores previous loyalty value - probably NOT what you want)</span>
<a name="l00255"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#13458151867f87f7880b09d3fb1a15cb">00255</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#83839067c20a0543b5657918655d3a4a">SetTownLoyalty</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubNewLoyaltyRating )
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257       Assert( ( bTownId &gt;= FIRST_TOWN ) &amp;&amp; ( bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ) );
<a name="l00258"></a>00258 
<a name="l00259"></a>00259       <span class="comment">// if the town does use loyalty</span>
<a name="l00260"></a>00260       <span class="keywordflow">if</span> (<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#9b06c65f6833d5d0ed217d0c959d80dd">gfTownUsesLoyalty</a>[ bTownId ])
<a name="l00261"></a>00261       {
<a name="l00262"></a>00262             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#d2934532a9d306c7521908308ccb405f">ubRating</a> = ubNewLoyaltyRating;
<a name="l00263"></a>00263             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#0720401925087e7248e765e6b445473b">sChange</a> = 0;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265             <span class="comment">// this is just like starting the loyalty if it happens first</span>
<a name="l00266"></a>00266             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#f44d01f1c8b5626fbd7119d2345f2ddc">fStarted</a> = TRUE;
<a name="l00267"></a>00267       }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269       <span class="keywordflow">return</span>;
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="comment">// increments the town's loyalty rating by that many HUNDREDTHS of loyalty pts</span>
<a name="l00274"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#0213c5a18d28686e5740e748d8e19754">00274</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId, <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiLoyaltyIncrease )
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiRemainingIncrement;
<a name="l00277"></a>00277       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sThisIncrement;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 
<a name="l00280"></a>00280       Assert( ( bTownId &gt;= FIRST_TOWN ) &amp;&amp; ( bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ) );
<a name="l00281"></a>00281 
<a name="l00282"></a>00282       <span class="comment">// doesn't affect towns where player hasn't established a "presence" yet</span>
<a name="l00283"></a>00283       <span class="keywordflow">if</span> (!<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].fStarted)
<a name="l00284"></a>00284       {
<a name="l00285"></a>00285             <span class="keywordflow">return</span>;
<a name="l00286"></a>00286       }
<a name="l00287"></a>00287 
<a name="l00288"></a>00288       <span class="comment">// modify loyalty change by town's individual attitude toward rebelling (20 is typical)</span>
<a name="l00289"></a>00289       uiLoyaltyIncrease *= (5 * <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#9867add2dc79f5c16824e7663cde8a17">gubTownRebelSentiment</a>[ bTownId ]);
<a name="l00290"></a>00290       uiLoyaltyIncrease /= 100;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 
<a name="l00293"></a>00293       <span class="comment">// this whole thing is a hack to avoid rolling over the -32 to 32k range on the sChange value</span>
<a name="l00294"></a>00294       <span class="comment">// only do a maximum of 10000 pts at a time...</span>
<a name="l00295"></a>00295       uiRemainingIncrement = uiLoyaltyIncrease;
<a name="l00296"></a>00296       <span class="keywordflow">while</span> ( uiRemainingIncrement )
<a name="l00297"></a>00297       {
<a name="l00298"></a>00298             sThisIncrement = ( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> ) min( uiRemainingIncrement, 10000 );
<a name="l00299"></a>00299 
<a name="l00300"></a>00300             <span class="comment">// up the gain value</span>
<a name="l00301"></a>00301             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#0720401925087e7248e765e6b445473b">sChange</a> += (<a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a>) sThisIncrement;
<a name="l00302"></a>00302             <span class="comment">// update town value now</span>
<a name="l00303"></a>00303             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#e868f0a8f3e5591fdac692080d83f11d">UpdateTownLoyaltyRating</a>( bTownId );
<a name="l00304"></a>00304 
<a name="l00305"></a>00305             uiRemainingIncrement -= sThisIncrement;
<a name="l00306"></a>00306       }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308       <span class="keywordflow">return</span>;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 <span class="comment">// decrements the town's loyalty rating by that many HUNDREDTHS of loyalty pts</span>
<a name="l00312"></a>00312 <span class="comment">//NOTE: This function expects a POSITIVE number for a decrease!!!</span>
<a name="l00313"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#8aaf32385bc65679319fc948f6b59d01">00313</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#8aaf32385bc65679319fc948f6b59d01">DecrementTownLoyalty</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId, <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiLoyaltyDecrease )
<a name="l00314"></a>00314 {
<a name="l00315"></a>00315       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiRemainingDecrement;
<a name="l00316"></a>00316       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sThisDecrement;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 
<a name="l00319"></a>00319       Assert( ( bTownId &gt;= FIRST_TOWN ) &amp;&amp; ( bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ) );
<a name="l00320"></a>00320 
<a name="l00321"></a>00321       <span class="comment">// doesn't affect towns where player hasn't established a "presence" yet</span>
<a name="l00322"></a>00322       <span class="keywordflow">if</span> (!<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].fStarted)
<a name="l00323"></a>00323       {
<a name="l00324"></a>00324             <span class="keywordflow">return</span>;
<a name="l00325"></a>00325       }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327       <span class="comment">// modify loyalty change by town's individual attitude toward rebelling (20 is typical)</span>
<a name="l00328"></a>00328       uiLoyaltyDecrease *= 100;
<a name="l00329"></a>00329       uiLoyaltyDecrease /= (5 * <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#9867add2dc79f5c16824e7663cde8a17">gubTownRebelSentiment</a>[ bTownId ]);
<a name="l00330"></a>00330 
<a name="l00331"></a>00331       <span class="comment">// this whole thing is a hack to avoid rolling over the -32 to 32k range on the sChange value</span>
<a name="l00332"></a>00332       <span class="comment">// only do a maximum of 10000 pts at a time...</span>
<a name="l00333"></a>00333       uiRemainingDecrement = uiLoyaltyDecrease;
<a name="l00334"></a>00334       <span class="keywordflow">while</span> ( uiRemainingDecrement )
<a name="l00335"></a>00335       {
<a name="l00336"></a>00336             sThisDecrement = ( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> ) min( uiRemainingDecrement, 10000 );
<a name="l00337"></a>00337 
<a name="l00338"></a>00338             <span class="comment">// down the gain value</span>
<a name="l00339"></a>00339             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#0720401925087e7248e765e6b445473b">sChange</a> -= sThisDecrement;
<a name="l00340"></a>00340             <span class="comment">// update town value now</span>
<a name="l00341"></a>00341             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#e868f0a8f3e5591fdac692080d83f11d">UpdateTownLoyaltyRating</a>( bTownId );
<a name="l00342"></a>00342 
<a name="l00343"></a>00343             uiRemainingDecrement -= sThisDecrement;
<a name="l00344"></a>00344       }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346       <span class="keywordflow">return</span>;
<a name="l00347"></a>00347 }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 
<a name="l00350"></a>00350 <span class="comment">// update town loyalty rating based on gain values</span>
<a name="l00351"></a><a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#e868f0a8f3e5591fdac692080d83f11d">00351</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#e868f0a8f3e5591fdac692080d83f11d">UpdateTownLoyaltyRating</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId )
<a name="l00352"></a>00352 {
<a name="l00353"></a>00353       <span class="comment">// check gain value and update loyaty</span>
<a name="l00354"></a>00354       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubOldLoyaltyRating = 0;
<a name="l00355"></a>00355       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sRatingChange = 0;
<a name="l00356"></a>00356       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubMaxLoyalty = 0;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 
<a name="l00359"></a>00359       Assert( ( bTownId &gt;= FIRST_TOWN ) &amp;&amp; ( bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ) );
<a name="l00360"></a>00360 
<a name="l00361"></a>00361       <span class="comment">// remember previous loyalty value</span>
<a name="l00362"></a>00362       ubOldLoyaltyRating = <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#d2934532a9d306c7521908308ccb405f">ubRating</a>;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364       sRatingChange = <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#0720401925087e7248e765e6b445473b">sChange</a> / GAIN_PTS_PER_LOYALTY_PT;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366       <span class="comment">// if loyalty is ready to increase</span>
<a name="l00367"></a>00367       <span class="keywordflow">if</span>( sRatingChange &gt; 0 )
<a name="l00368"></a>00368       {
<a name="l00369"></a>00369             <span class="comment">// if the town is Omerta, and the rebels are/will become hostile</span>
<a name="l00370"></a>00370             <span class="keywordflow">if</span> ((bTownId == <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105d4e8ff4822ac436590f6cfbf3b35764d">OMERTA</a>) &amp;&amp; (<a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#879449ac79e1f0135ef15c76469bc7a8">fCivGroupHostile</a>[ <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a0785241787570cc516fbde66bef1057d466c0e">REBEL_CIV_GROUP</a> ] != CIV_GROUP_NEUTRAL))
<a name="l00371"></a>00371             {
<a name="l00372"></a>00372                   <span class="comment">// maximum loyalty is much less than normal</span>
<a name="l00373"></a>00373                   ubMaxLoyalty = HOSTILE_OMERTA_LOYALTY_RATING;
<a name="l00374"></a>00374             }
<a name="l00375"></a>00375             <span class="keywordflow">else</span>
<a name="l00376"></a>00376             {
<a name="l00377"></a>00377                   ubMaxLoyalty = MAX_LOYALTY_VALUE;
<a name="l00378"></a>00378             }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380             <span class="comment">// check if we'd be going over the max</span>
<a name="l00381"></a>00381             <span class="keywordflow">if</span>( (<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].ubRating + sRatingChange ) &gt;= ubMaxLoyalty )
<a name="l00382"></a>00382             {
<a name="l00383"></a>00383                   <span class="comment">// set to max and null out gain pts</span>
<a name="l00384"></a>00384                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#d2934532a9d306c7521908308ccb405f">ubRating</a> = ubMaxLoyalty;
<a name="l00385"></a>00385                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#0720401925087e7248e765e6b445473b">sChange</a> = 0;
<a name="l00386"></a>00386             }
<a name="l00387"></a>00387             <span class="keywordflow">else</span>
<a name="l00388"></a>00388             {
<a name="l00389"></a>00389                   <span class="comment">// increment loyalty rating, reduce sChange</span>
<a name="l00390"></a>00390                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#d2934532a9d306c7521908308ccb405f">ubRating</a> += sRatingChange;
<a name="l00391"></a>00391                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#0720401925087e7248e765e6b445473b">sChange</a> %= GAIN_PTS_PER_LOYALTY_PT;
<a name="l00392"></a>00392             }
<a name="l00393"></a>00393       }
<a name="l00394"></a>00394       <span class="keywordflow">else</span>
<a name="l00395"></a>00395       <span class="comment">// if loyalty is ready to decrease</span>
<a name="l00396"></a>00396       <span class="keywordflow">if</span>( sRatingChange &lt; 0 )
<a name="l00397"></a>00397       {
<a name="l00398"></a>00398             <span class="comment">// check if we'd be going below zero</span>
<a name="l00399"></a>00399             <span class="keywordflow">if</span>( ( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].ubRating + sRatingChange ) &lt; 0 )
<a name="l00400"></a>00400             {
<a name="l00401"></a>00401                   <span class="comment">// set to zero and null out gain pts</span>
<a name="l00402"></a>00402                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#d2934532a9d306c7521908308ccb405f">ubRating</a> = 0;
<a name="l00403"></a>00403                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#0720401925087e7248e765e6b445473b">sChange</a> = 0;
<a name="l00404"></a>00404             }
<a name="l00405"></a>00405             <span class="keywordflow">else</span>
<a name="l00406"></a>00406             {
<a name="l00407"></a>00407                   <span class="comment">// decrement loyalty rating, reduce sChange</span>
<a name="l00408"></a>00408                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#d2934532a9d306c7521908308ccb405f">ubRating</a> += sRatingChange;
<a name="l00409"></a>00409                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#0720401925087e7248e765e6b445473b">sChange</a> %= GAIN_PTS_PER_LOYALTY_PT;
<a name="l00410"></a>00410             }
<a name="l00411"></a>00411       }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 
<a name="l00414"></a>00414       <span class="comment">// check old aginst new, if diff, dirty map panel</span>
<a name="l00415"></a>00415       <span class="keywordflow">if</span>( ubOldLoyaltyRating != <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].ubRating )
<a name="l00416"></a>00416       {
<a name="l00417"></a>00417             <a class="code" href="HelpScreen_8cpp.html#be83f0093f2fba05817df5b4592ab0f0">fMapPanelDirty</a> = TRUE;
<a name="l00418"></a>00418       }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420       <span class="keywordflow">return</span>;
<a name="l00421"></a>00421 }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423 
<a name="l00424"></a>00424 <span class="comment">// strategic handler, goes through and handles all strategic events for town loyalty updates...player controlled, monsters</span>
<a name="l00425"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#0ed7a998761d4c0b86a96476afc2cb1c">00425</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0ed7a998761d4c0b86a96476afc2cb1c">HandleTownLoyalty</a>( <span class="keywordtype">void</span> )
<a name="l00426"></a>00426 {
<a name="l00427"></a>00427       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId = 0;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 <span class="comment">/* ARM: removed to experiment with keeping loyalty from drifing without any direct causes from the player</span>
<a name="l00430"></a>00430 <span class="comment">      for( bTownId = FIRST_TOWN; bTownId &lt; NUM_TOWNS; bTownId++ )</span>
<a name="l00431"></a>00431 <span class="comment">      {</span>
<a name="l00432"></a>00432 <span class="comment">            // update loyalty of controlled/uncontrolled towns</span>
<a name="l00433"></a>00433 <span class="comment">            UpdateLoyaltyBasedOnControl( bTownId );</span>
<a name="l00434"></a>00434 <span class="comment"></span>
<a name="l00435"></a>00435 <span class="comment">            // update based on number of good guys in sector</span>
<a name="l00436"></a>00436 <span class="comment">            UpdateTownLoyaltyBasedOnFriendliesInTown( bTownId );</span>
<a name="l00437"></a>00437 <span class="comment"></span>
<a name="l00438"></a>00438 <span class="comment">            // update bad on number of badies in sector</span>
<a name="l00439"></a>00439 <span class="comment">            UpdateTownLoyaltyBasedOnBadGuysInTown( bTownId );</span>
<a name="l00440"></a>00440 <span class="comment"></span>
<a name="l00441"></a>00441 <span class="comment">            // finally update town loyalty</span>
<a name="l00442"></a>00442 <span class="comment">            UpdateTownLoyaltyRating( bTownId );</span>
<a name="l00443"></a>00443 <span class="comment">      }</span>
<a name="l00444"></a>00444 <span class="comment">*/</span>
<a name="l00445"></a>00445 
<a name="l00446"></a>00446       <span class="comment">// now all loyalty is done, handle other stuff</span>
<a name="l00447"></a>00447 
<a name="l00448"></a>00448 <span class="comment">/* ARM: Civilian theft of items was removed</span>
<a name="l00449"></a>00449 <span class="comment">      // only check for theft every 12 hours, otherwise it's way too slow</span>
<a name="l00450"></a>00450 <span class="comment">      if ( (GetWorldHour() % 12) == 0)</span>
<a name="l00451"></a>00451 <span class="comment">      {</span>
<a name="l00452"></a>00452 <span class="comment">            HandleTownTheft( );</span>
<a name="l00453"></a>00453 <span class="comment">      }</span>
<a name="l00454"></a>00454 <span class="comment">*/</span>
<a name="l00455"></a>00455 
<a name="l00456"></a>00456       <span class="keywordflow">return</span>;
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 
<a name="l00461"></a>00461 <span class="comment">/*</span>
<a name="l00462"></a>00462 <span class="comment">// update of town loyalty based on if the player controls the town's sectors</span>
<a name="l00463"></a>00463 <span class="comment">void UpdateLoyaltyBasedOnControl( INT8 bTownId )</span>
<a name="l00464"></a>00464 <span class="comment">{</span>
<a name="l00465"></a>00465 <span class="comment">      // compare current loyalty to percent of sectors controlled, adjust in that direction </span>
<a name="l00466"></a>00466 <span class="comment">      INT32 iUnderControl = 0;</span>
<a name="l00467"></a>00467 <span class="comment"></span>
<a name="l00468"></a>00468 <span class="comment">      Assert( ( bTownId &gt;= FIRST_TOWN ) &amp;&amp; ( bTownId &lt; NUM_TOWNS ) );</span>
<a name="l00469"></a>00469 <span class="comment"></span>
<a name="l00470"></a>00470 <span class="comment">      // find how much of town is under control</span>
<a name="l00471"></a>00471 <span class="comment">      iUnderControl = GetTownSectorsUnderControl( bTownId );</span>
<a name="l00472"></a>00472 <span class="comment">      iUnderControl *= 100;</span>
<a name="l00473"></a>00473 <span class="comment">      iUnderControl /= GetTownSectorSize( bTownId ); </span>
<a name="l00474"></a>00474 <span class="comment">      </span>
<a name="l00475"></a>00475 <span class="comment">      // the gain value will be the difference in iUnderControl and the current Loyalty rating / hours_per_day</span>
<a name="l00476"></a>00476 <span class="comment">      if( gTownLoyalty[ bTownId ].ubRating &lt; ( UINT8 ) iUnderControl )</span>
<a name="l00477"></a>00477 <span class="comment">      {</span>
<a name="l00478"></a>00478 <span class="comment">            // we control more of the town, start moving to more loyal</span>
<a name="l00479"></a>00479 <span class="comment">            IncrementTownLoyalty( bTownId, ( iUnderControl - gTownLoyalty[ bTownId ].ubRating) );</span>
<a name="l00480"></a>00480 <span class="comment">      }</span>
<a name="l00481"></a>00481 <span class="comment">      else</span>
<a name="l00482"></a>00482 <span class="comment">      {</span>
<a name="l00483"></a>00483 <span class="comment">            // mere lack of sector control never reduces loyalty below the town's current rebel sentiment</span>
<a name="l00484"></a>00484 <span class="comment">            if (gTownLoyalty[ bTownId ].ubRating &gt; gubTownRebelSentiment[ bTownId ])</span>
<a name="l00485"></a>00485 <span class="comment">            {</span>
<a name="l00486"></a>00486 <span class="comment">                  // we control less of the town, decrement gain</span>
<a name="l00487"></a>00487 <span class="comment">                  DecrementTownLoyalty( bTownId, gTownLoyalty[ bTownId ].ubRating - iUnderControl );</span>
<a name="l00488"></a>00488 <span class="comment">            }</span>
<a name="l00489"></a>00489 <span class="comment">      }     </span>
<a name="l00490"></a>00490 <span class="comment"></span>
<a name="l00491"></a>00491 <span class="comment">      return;</span>
<a name="l00492"></a>00492 <span class="comment">}</span>
<a name="l00493"></a>00493 <span class="comment"></span>
<a name="l00494"></a>00494 <span class="comment"></span>
<a name="l00495"></a>00495 <span class="comment">// updates the loyalty of the town in a sector based on number of friendly troops in that sector ...to a point, after max number to </span>
<a name="l00496"></a>00496 <span class="comment">void UpdateTownLoyaltyBasedOnFriendliesInTown( INT8 bTownId )</span>
<a name="l00497"></a>00497 <span class="comment">{</span>
<a name="l00498"></a>00498 <span class="comment">      // check if valid town</span>
<a name="l00499"></a>00499 <span class="comment">      INT32 iUnderControl = 0;</span>
<a name="l00500"></a>00500 <span class="comment">      SOLDIERTYPE *pSoldier;</span>
<a name="l00501"></a>00501 <span class="comment">      INT32 iCounter = 0;</span>
<a name="l00502"></a>00502 <span class="comment">      INT32 iSoldierCount = 0;</span>
<a name="l00503"></a>00503 <span class="comment">      INT32 iLocalNPCBonus = 0;</span>
<a name="l00504"></a>00504 <span class="comment">      INT32 iMilitiaValue = 0;</span>
<a name="l00505"></a>00505 <span class="comment">      UINT8 ubMilitiaLevel = 0;</span>
<a name="l00506"></a>00506 <span class="comment"></span>
<a name="l00507"></a>00507 <span class="comment"></span>
<a name="l00508"></a>00508 <span class="comment">      Assert( ( bTownId &gt;= FIRST_TOWN ) &amp;&amp; ( bTownId &lt; NUM_TOWNS ) );</span>
<a name="l00509"></a>00509 <span class="comment"></span>
<a name="l00510"></a>00510 <span class="comment">      // find how much of town is under control</span>
<a name="l00511"></a>00511 <span class="comment">      iUnderControl = GetTownSectorsUnderControl( bTownId );</span>
<a name="l00512"></a>00512 <span class="comment">      iUnderControl *= 100;</span>
<a name="l00513"></a>00513 <span class="comment">      iUnderControl /= GetTownSectorSize( bTownId ); </span>
<a name="l00514"></a>00514 <span class="comment"></span>
<a name="l00515"></a>00515 <span class="comment"></span>
<a name="l00516"></a>00516 <span class="comment">      // count how many of player's mercs are active in this town, then factor by number of sectors under control</span>
<a name="l00517"></a>00517 <span class="comment"></span>
<a name="l00518"></a>00518 <span class="comment">      // run through list of grunts on team</span>
<a name="l00519"></a>00519 <span class="comment">  for (iCounter = gTacticalStatus.Team[ OUR_TEAM ].bFirstID; iCounter &lt;= gTacticalStatus.Team[ OUR_TEAM ].bLastID; iCounter++ )</span>
<a name="l00520"></a>00520 <span class="comment">      {</span>
<a name="l00521"></a>00521 <span class="comment">            pSoldier = MercPtrs[ iCounter ];</span>
<a name="l00522"></a>00522 <span class="comment"></span>
<a name="l00523"></a>00523 <span class="comment">            if ( pSoldier-&gt;bLife &gt;= OKLIFE &amp;&amp; pSoldier-&gt;bActive )</span>
<a name="l00524"></a>00524 <span class="comment">            {</span>
<a name="l00525"></a>00525 <span class="comment">                  // if soldier is in this sector</span>
<a name="l00526"></a>00526 <span class="comment">                  if( SectorIsPartOfTown( bTownId, pSoldier-&gt;sSectorX, pSoldier-&gt;sSectorY ) == TRUE )</span>
<a name="l00527"></a>00527 <span class="comment">                  {</span>
<a name="l00528"></a>00528 <span class="comment">                        // if onduty or in a vehicle</span>
<a name="l00529"></a>00529 <span class="comment">                        if( ( pSoldier-&gt;bAssignment &lt; ON_DUTY ) || pSoldier-&gt;bAssignment == VEHICLE ) )</span>
<a name="l00530"></a>00530 <span class="comment">                        {</span>
<a name="l00531"></a>00531 <span class="comment">                              // increment soldier count</span>
<a name="l00532"></a>00532 <span class="comment">                              iSoldierCount++;</span>
<a name="l00533"></a>00533 <span class="comment">                        }</span>
<a name="l00534"></a>00534 <span class="comment">                        </span>
<a name="l00535"></a>00535 <span class="comment">                        // local influence: if the town is the character's home town</span>
<a name="l00536"></a>00536 <span class="comment">                        if( bTownId == gMercProfiles[ pSoldier-&gt;ubProfile ].bTown )</span>
<a name="l00537"></a>00537 <span class="comment">                        {</span>
<a name="l00538"></a>00538 <span class="comment">                              // he needn't be soldiering to have an impact...  presence is enough</span>
<a name="l00539"></a>00539 <span class="comment">                              if( pSoldier-&gt;bAssignment &lt; ASSIGNMENT_DEAD )</span>
<a name="l00540"></a>00540 <span class="comment">                              {</span>
<a name="l00541"></a>00541 <span class="comment">                                    iLocalNPCBonus = HOURLY_GAIN_FOR_LOCAL_NPC_IN_TOWN;</span>
<a name="l00542"></a>00542 <span class="comment">                                    iLocalNPCBonus *= gMercProfiles[ pSoldier-&gt;ubProfile ].bTownAttachment;</span>
<a name="l00543"></a>00543 <span class="comment">                                    iLocalNPCBonus /= 100;</span>
<a name="l00544"></a>00544 <span class="comment"></span>
<a name="l00545"></a>00545 <span class="comment">                                    // adjust for % town control</span>
<a name="l00546"></a>00546 <span class="comment">                                    iLocalNPCBonus *= iUnderControl;</span>
<a name="l00547"></a>00547 <span class="comment">                                    iLocalNPCBonus /= 100;</span>
<a name="l00548"></a>00548 <span class="comment"></span>
<a name="l00549"></a>00549 <span class="comment">                                    // do we actually gain from this?</span>
<a name="l00550"></a>00550 <span class="comment">                                    if( iLocalNPCBonus &gt; 0 )</span>
<a name="l00551"></a>00551 <span class="comment">                                    {</span>
<a name="l00552"></a>00552 <span class="comment">                                          // debug message</span>
<a name="l00553"></a>00553 <span class="comment">                                          ScreenMsg( MSG_FONT_RED, MSG_DEBUG, L"%s influences loyalty in home town of %s, worth %d", pSoldier-&gt;name, pTownNames[ bTownId ], iLocalNPCBonus);</span>
<a name="l00554"></a>00554 <span class="comment"></span>
<a name="l00555"></a>00555 <span class="comment">                                          // increment town loyalty</span>
<a name="l00556"></a>00556 <span class="comment">                                          IncrementTownLoyalty( bTownId, iLocalNPCBonus );</span>
<a name="l00557"></a>00557 <span class="comment">                                    }</span>
<a name="l00558"></a>00558 <span class="comment">                              }</span>
<a name="l00559"></a>00559 <span class="comment">                        }</span>
<a name="l00560"></a>00560 <span class="comment">                  }</span>
<a name="l00561"></a>00561 <span class="comment">            }</span>
<a name="l00562"></a>00562 <span class="comment">      }</span>
<a name="l00563"></a>00563 <span class="comment"></span>
<a name="l00564"></a>00564 <span class="comment"></span>
<a name="l00565"></a>00565 <span class="comment">      // soldier count is limited by a max number</span>
<a name="l00566"></a>00566 <span class="comment">      if( iSoldierCount &gt; MAX_SOLDIER_COUNT_FOR_IN_TOWN_LOYALTY_GAIN )</span>
<a name="l00567"></a>00567 <span class="comment">      {</span>
<a name="l00568"></a>00568 <span class="comment">            iSoldierCount = MAX_SOLDIER_COUNT_FOR_IN_TOWN_LOYALTY_GAIN;</span>
<a name="l00569"></a>00569 <span class="comment">      }</span>
<a name="l00570"></a>00570 <span class="comment"></span>
<a name="l00571"></a>00571 <span class="comment">      // adjust for % town control</span>
<a name="l00572"></a>00572 <span class="comment">      iSoldierCount *= iUnderControl;</span>
<a name="l00573"></a>00573 <span class="comment">      iSoldierCount /= 100;</span>
<a name="l00574"></a>00574 <span class="comment"></span>
<a name="l00575"></a>00575 <span class="comment">      // add loyalty gain due to mercs</span>
<a name="l00576"></a>00576 <span class="comment">      IncrementTownLoyalty( bTownId, iSoldierCount * HOURLY_GAIN_PER_MERC_IN_TOWN );</span>
<a name="l00577"></a>00577 <span class="comment"></span>
<a name="l00578"></a>00578 <span class="comment"></span>
<a name="l00579"></a>00579 <span class="comment">      // find out if there are any militia anywhere in this town</span>
<a name="l00580"></a>00580 <span class="comment">      iMilitiaValue = 0;</span>
<a name="l00581"></a>00581 <span class="comment">      for( ubMilitiaLevel = 0; ubMilitiaLevel &lt; MAX_MILITIA_LEVELS; ubMilitiaLevel++ )</span>
<a name="l00582"></a>00582 <span class="comment">      {</span>
<a name="l00583"></a>00583 <span class="comment">            // regulars/elites are worth double/triple normal</span>
<a name="l00584"></a>00584 <span class="comment">            iMilitiaValue += ((ubMilitiaLevel + 1) * GetMilitiaCountAtLevelAnywhereInTown( bTownId, ubMilitiaLevel ));</span>
<a name="l00585"></a>00585 <span class="comment">      }</span>
<a name="l00586"></a>00586 <span class="comment"></span>
<a name="l00587"></a>00587 <span class="comment">      // militia count is limited by a max number</span>
<a name="l00588"></a>00588 <span class="comment">      if( iMilitiaValue &gt; MAX_MILITIA_VALUE_FOR_IN_TOWN_LOYALTY_GAIN )</span>
<a name="l00589"></a>00589 <span class="comment">      {</span>
<a name="l00590"></a>00590 <span class="comment">            iMilitiaValue = MAX_MILITIA_VALUE_FOR_IN_TOWN_LOYALTY_GAIN;</span>
<a name="l00591"></a>00591 <span class="comment">      }</span>
<a name="l00592"></a>00592 <span class="comment"></span>
<a name="l00593"></a>00593 <span class="comment">      // adjust for % town control</span>
<a name="l00594"></a>00594 <span class="comment">      iMilitiaValue *= iUnderControl;</span>
<a name="l00595"></a>00595 <span class="comment">      iMilitiaValue /= 100;</span>
<a name="l00596"></a>00596 <span class="comment"></span>
<a name="l00597"></a>00597 <span class="comment">      // add loyalty gain due to militia</span>
<a name="l00598"></a>00598 <span class="comment">      IncrementTownLoyalty( bTownId, iMilitiaValue * HOURLY_GAIN_PER_MILITIA_IN_TOWN );</span>
<a name="l00599"></a>00599 <span class="comment"></span>
<a name="l00600"></a>00600 <span class="comment">      return;</span>
<a name="l00601"></a>00601 <span class="comment">}</span>
<a name="l00602"></a>00602 <span class="comment"></span>
<a name="l00603"></a>00603 <span class="comment"></span>
<a name="l00604"></a>00604 <span class="comment">void UpdateTownLoyaltyBasedOnBadGuysInTown( INT8 bTownId )</span>
<a name="l00605"></a>00605 <span class="comment">{</span>
<a name="l00606"></a>00606 <span class="comment">      // will update a town's loyalty based on number and type of bad guys in it</span>
<a name="l00607"></a>00607 <span class="comment">      INT32 iTotalEnemies = 0;</span>
<a name="l00608"></a>00608 <span class="comment">      INT16 sSectorX =0, sSectorY = 0;</span>
<a name="l00609"></a>00609 <span class="comment">      UINT8 ubAdmins, ubRegs, ubElites;</span>
<a name="l00610"></a>00610 <span class="comment">      INT32 iUnderControl;</span>
<a name="l00611"></a>00611 <span class="comment"></span>
<a name="l00612"></a>00612 <span class="comment">      // find which sectors are this town and look at bad guys in those sectors</span>
<a name="l00613"></a>00613 <span class="comment">      // adjust for number of sectors bad guys control...like the player</span>
<a name="l00614"></a>00614 <span class="comment">      for( sSectorX = 0; sSectorX &lt; MAP_WORLD_X; sSectorX++ )</span>
<a name="l00615"></a>00615 <span class="comment">      {</span>
<a name="l00616"></a>00616 <span class="comment">            for( sSectorY = 0; sSectorY &lt; MAP_WORLD_Y; sSectorY++ )</span>
<a name="l00617"></a>00617 <span class="comment">            {</span>
<a name="l00618"></a>00618 <span class="comment">                  // check if sector belongs to this town and is controlled by bad guys</span>
<a name="l00619"></a>00619 <span class="comment">                  if ( ( SectorIsPartOfTown( bTownId, sSectorX, sSectorY ) == TRUE ) &amp;&amp; ( StrategicMap[ sSectorX + sSectorY * MAP_WORLD_X ].fEnemyControlled == TRUE ) )</span>
<a name="l00620"></a>00620 <span class="comment">                  {</span>
<a name="l00621"></a>00621 <span class="comment">                        // controlled by bad guys..adjust numbers for type</span>
<a name="l00622"></a>00622 <span class="comment">                        GetNumberOfEnemiesInSector( sSectorX, sSectorY, &amp;ubAdmins, &amp;ubRegs, &amp;ubElites );</span>
<a name="l00623"></a>00623 <span class="comment"></span>
<a name="l00624"></a>00624 <span class="comment">                        // administrators</span>
<a name="l00625"></a>00625 <span class="comment">                        iTotalEnemies += ( INT32 ) ubAdmins;</span>
<a name="l00626"></a>00626 <span class="comment">                        // regulars</span>
<a name="l00627"></a>00627 <span class="comment">                        iTotalEnemies += ( INT32 ) ubRegs * NUMBER_OF_RANKS_PER_REGULAR;</span>
<a name="l00628"></a>00628 <span class="comment">                        // elites</span>
<a name="l00629"></a>00629 <span class="comment">                    iTotalEnemies += ( INT32 ) ubElites * NUMBER_OF_RANKS_PER_ELITE;</span>
<a name="l00630"></a>00630 <span class="comment">                  }</span>
<a name="l00631"></a>00631 <span class="comment">            }</span>
<a name="l00632"></a>00632 <span class="comment">      }</span>
<a name="l00633"></a>00633 <span class="comment"></span>
<a name="l00634"></a>00634 <span class="comment"></span>
<a name="l00635"></a>00635 <span class="comment">      // check vs. maximum influence possible</span>
<a name="l00636"></a>00636 <span class="comment">      if( iTotalEnemies &gt; MAX_ENEMY_SOLDIER_RANKS_FOR_IN_TOWN_LOYALTY_DROP )</span>
<a name="l00637"></a>00637 <span class="comment">      {</span>
<a name="l00638"></a>00638 <span class="comment">            // we have, adjust </span>
<a name="l00639"></a>00639 <span class="comment">            iTotalEnemies = MAX_ENEMY_SOLDIER_RANKS_FOR_IN_TOWN_LOYALTY_DROP;</span>
<a name="l00640"></a>00640 <span class="comment">      }</span>
<a name="l00641"></a>00641 <span class="comment"></span>
<a name="l00642"></a>00642 <span class="comment"></span>
<a name="l00643"></a>00643 <span class="comment">      // find how much of town is under enemy control</span>
<a name="l00644"></a>00644 <span class="comment">      iUnderControl = GetTownSectorSize( bTownId ) - GetTownSectorsUnderControl( bTownId );</span>
<a name="l00645"></a>00645 <span class="comment">      iUnderControl *= 100;</span>
<a name="l00646"></a>00646 <span class="comment">      iUnderControl /= GetTownSectorSize( bTownId ); </span>
<a name="l00647"></a>00647 <span class="comment"></span>
<a name="l00648"></a>00648 <span class="comment">      // adjust number of enemies for town control</span>
<a name="l00649"></a>00649 <span class="comment">      iTotalEnemies *= iUnderControl;</span>
<a name="l00650"></a>00650 <span class="comment">      iTotalEnemies /= 100;</span>
<a name="l00651"></a>00651 <span class="comment"></span>
<a name="l00652"></a>00652 <span class="comment">      // adjust loyalty downward for enemies</span>
<a name="l00653"></a>00653 <span class="comment">      DecrementTownLoyalty( bTownId, iTotalEnemies * HOURLY_DROP_PER_ENEMY_RANK_IN_TOWN );</span>
<a name="l00654"></a>00654 <span class="comment">}</span>
<a name="l00655"></a>00655 <span class="comment">*/</span>
<a name="l00656"></a>00656 
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 
<a name="l00659"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#ea9c0f8697bf92d232f2622903614a07">00659</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#ea9c0f8697bf92d232f2622903614a07">HandleMurderOfCivilian</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fIntentional )
<a name="l00660"></a>00660 {
<a name="l00661"></a>00661       <span class="comment">// handle the impact on loyalty of the murder of a civilian </span>
<a name="l00662"></a>00662       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId = 0;
<a name="l00663"></a>00663       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iLoyaltyChange = 0;
<a name="l00664"></a>00664       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bSeenState = 0;
<a name="l00665"></a>00665       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iCounter = 0;
<a name="l00666"></a>00666       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pCivSoldier = NULL;
<a name="l00667"></a>00667       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiChanceFalseAccusal = 0;
<a name="l00668"></a>00668       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bKillerTeam = 0;
<a name="l00669"></a>00669       <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> fIncrement = FALSE;
<a name="l00670"></a>00670       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiLoyaltyEffectDelay = 0;
<a name="l00671"></a>00671       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiValue = 0;
<a name="l00672"></a>00672 
<a name="l00673"></a>00673 
<a name="l00674"></a>00674       <span class="comment">// ubAttacker CAN be NOBODY...  Don't treat is as murder if NOBODY killed us...</span>
<a name="l00675"></a>00675       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d9c0383469bf58f73ba6bea3e8ebf22b">ubAttackerID</a> == NOBODY )
<a name="l00676"></a>00676       {
<a name="l00677"></a>00677             <span class="keywordflow">return</span>;
<a name="l00678"></a>00678       }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680       <span class="comment">// ignore murder of non-civilians!</span>
<a name="l00681"></a>00681       <span class="keywordflow">if</span> ( ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> != CIV_TEAM ) || ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> == <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a7143fbbb5aa867c244f7cf6a230545002">CROW</a> ) )
<a name="l00682"></a>00682       {
<a name="l00683"></a>00683             <span class="keywordflow">return</span>;
<a name="l00684"></a>00684       }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686       <span class="comment">// if this is a profiled civilian NPC</span>
<a name="l00687"></a>00687       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> != NO_PROFILE )
<a name="l00688"></a>00688       {
<a name="l00689"></a>00689             <span class="comment">// ignore murder of NPCs if they're not loyal to the rebel cause - they're really just enemies in civilian clothing</span>
<a name="l00690"></a>00690             <span class="keywordflow">if</span> ( <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].ubMiscFlags3 &amp; PROFILE_MISC_FLAG3_TOWN_DOESNT_CARE_ABOUT_DEATH )
<a name="l00691"></a>00691             {
<a name="l00692"></a>00692                   <span class="keywordflow">return</span>;
<a name="l00693"></a>00693             }
<a name="l00694"></a>00694       }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696       <span class="comment">// if civilian belongs to a civilian group</span>
<a name="l00697"></a>00697       <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> != <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a078524cb5f7573455bdacd2b87a051da610c97">NON_CIV_GROUP</a> )
<a name="l00698"></a>00698       {
<a name="l00699"></a>00699             <span class="comment">// and it's one that is hostile to the player's cause</span>
<a name="l00700"></a>00700             <span class="keywordflow">switch</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> )
<a name="l00701"></a>00701             {
<a name="l00702"></a>00702                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a0785249cebb97519ab2d7c94dabe2509bef978">KINGPIN_CIV_GROUP</a>:
<a name="l00703"></a>00703                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a078524af84ae4c1b4d7a915ba9c5f3e11d2282">ALMA_MILITARY_CIV_GROUP</a>:
<a name="l00704"></a>00704                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a0785248e818a9693e42cfdf988862de0f393aa">HICKS_CIV_GROUP</a>:
<a name="l00705"></a>00705                   <span class="keywordflow">case</span> <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a078524b818ec0f07bb6dc4aa010d3ede644ebc">WARDEN_CIV_GROUP</a>:
<a name="l00706"></a>00706                         <span class="keywordflow">return</span>;
<a name="l00707"></a>00707             }
<a name="l00708"></a>00708       }
<a name="l00709"></a>00709 
<a name="l00710"></a>00710       <span class="comment">// set killer team</span>
<a name="l00711"></a>00711       bKillerTeam = <a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d9c0383469bf58f73ba6bea3e8ebf22b">ubAttackerID</a> ].<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a>;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713 
<a name="l00714"></a>00714       <span class="comment">// if the player did the killing</span>
<a name="l00715"></a>00715       <span class="keywordflow">if</span>( bKillerTeam == OUR_TEAM )
<a name="l00716"></a>00716       {
<a name="l00717"></a>00717             <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *pKiller = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d9c0383469bf58f73ba6bea3e8ebf22b">ubAttackerID</a> ];
<a name="l00718"></a>00718 
<a name="l00719"></a>00719             <span class="comment">// apply morale penalty for killing a civilian!</span>
<a name="l00720"></a>00720             <a class="code" href="Morale_8cpp.html#83b28a6d9386bb3d8d581943fa7e9a28">HandleMoraleEvent</a>( pKiller, <a class="code" href="Morale_8h.html#67ab756e41250f85e7e729e45554f3c3deda62c4cff3ece7232cc17d660442e6">MORALE_KILLED_CIVILIAN</a>, pKiller-&gt;<a class="code" href="structSOLDIERTYPE.html#6784346500db10daed06c2db02b855c0">sSectorX</a>, pKiller-&gt;<a class="code" href="structSOLDIERTYPE.html#6dd68e70c3000beb79e4ac45d28a0cbf">sSectorY</a>, pKiller-&gt;<a class="code" href="structSOLDIERTYPE.html#b70b761f0405cc179c1ffba84484df28">bSectorZ</a> );
<a name="l00721"></a>00721       }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723 
<a name="l00724"></a>00724       <span class="comment">// get town id</span>
<a name="l00725"></a>00725       bTownId = <a class="code" href="strategicmap_8cpp.html#99dffd29ea4571bc0c833d45636f1403">GetTownIdForSector</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6784346500db10daed06c2db02b855c0">sSectorX</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6dd68e70c3000beb79e4ac45d28a0cbf">sSectorY</a> );
<a name="l00726"></a>00726 
<a name="l00727"></a>00727       <span class="comment">// if civilian is NOT in a town</span>
<a name="l00728"></a>00728       <span class="keywordflow">if</span>( bTownId == <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105d008cfe091b982e6d052565ed0b5acd8">BLANK_SECTOR</a> )
<a name="l00729"></a>00729       {
<a name="l00730"></a>00730             <span class="keywordflow">return</span>;
<a name="l00731"></a>00731       }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733       <span class="comment">// check if this town does use loyalty (to skip a lot of unnecessary computation)</span>
<a name="l00734"></a>00734       <span class="keywordflow">if</span> (!<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#9b06c65f6833d5d0ed217d0c959d80dd">gfTownUsesLoyalty</a>[ bTownId ])
<a name="l00735"></a>00735       {
<a name="l00736"></a>00736             <span class="keywordflow">return</span>;
<a name="l00737"></a>00737       }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739 
<a name="l00740"></a>00740       <span class="keywordflow">if</span>( ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> &gt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a72254b6f06629056dd86be50df5347676">FATCIV</a>) &amp;&amp; ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> &lt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a748505ba252c1ec37e34d882e6f4a3ecf">COW</a> ) )
<a name="l00741"></a>00741       {
<a name="l00742"></a>00742             <span class="comment">// adjust value for killer and type</span>
<a name="l00743"></a>00743             iLoyaltyChange = <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#76c184e9c218f1b075ed7bdcdd66a3d6">uiPercentLoyaltyDecreaseForCivMurder</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b082364eed3d7883662f69e1fd96be1a">ubBodyType</a> - <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a72254b6f06629056dd86be50df5347676">FATCIV</a> ];
<a name="l00744"></a>00744       }
<a name="l00745"></a>00745       <span class="keywordflow">else</span>
<a name="l00746"></a>00746       {
<a name="l00747"></a>00747             iLoyaltyChange = BASIC_COST_FOR_CIV_MURDER;
<a name="l00748"></a>00748       }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750       <span class="keywordflow">if</span>( !fIntentional )
<a name="l00751"></a>00751       {
<a name="l00752"></a>00752             <span class="comment">// accidental killing, reduce value</span>
<a name="l00753"></a>00753             iLoyaltyChange *= REDUCTION_FOR_UNINTENTIONAL_KILLING;
<a name="l00754"></a>00754             iLoyaltyChange /= 100;
<a name="l00755"></a>00755       }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757       <span class="comment">// check if LOS between any civ, killer and killed</span>
<a name="l00758"></a>00758       <span class="comment">// if so, then do not adjust</span>
<a name="l00759"></a>00759 
<a name="l00760"></a>00760       <span class="keywordflow">for</span>( iCounter = <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ CIV_TEAM ].<a class="code" href="structTacticalTeamType.html#f8fe819ad07b242f5dbf97fd4c69b00d">bFirstID</a>; iCounter &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ CIV_TEAM ].<a class="code" href="structTacticalTeamType.html#6a887279dad735dc302f21c1e559d5ce">bLastID</a>; iCounter++ )
<a name="l00761"></a>00761       {
<a name="l00762"></a>00762             <span class="comment">// set current civ soldier</span>
<a name="l00763"></a>00763             pCivSoldier = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ iCounter ];
<a name="l00764"></a>00764 
<a name="l00765"></a>00765             <span class="keywordflow">if</span> ( pCivSoldier == <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00766"></a>00766             {
<a name="l00767"></a>00767                   <span class="keywordflow">continue</span>;
<a name="l00768"></a>00768             }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770             <span class="comment">// killer seen by civ?</span>
<a name="l00771"></a>00771             <span class="keywordflow">if</span> ( <a class="code" href="LOS_8cpp.html#1687abe11a81ed4e42b9d83f7510304c">SoldierToSoldierLineOfSightTest</a>( pCivSoldier, <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d9c0383469bf58f73ba6bea3e8ebf22b">ubAttackerID</a> ], <a class="code" href="GameSettings_8cpp.html#5c32f930e2fef384505c4b91803a92c2">gGameExternalOptions</a>.<a class="code" href="structGAME__EXTERNAL__OPTIONS.html#9c9d8783526192712e6fd727861699b6">ubStraightSightRange</a>, TRUE ) != 0 )
<a name="l00772"></a>00772             {
<a name="l00773"></a>00773                   bSeenState |= 1;
<a name="l00774"></a>00774             }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776             <span class="comment">// victim seen by civ?</span>
<a name="l00777"></a>00777             <span class="keywordflow">if</span>( <a class="code" href="LOS_8cpp.html#1687abe11a81ed4e42b9d83f7510304c">SoldierToSoldierLineOfSightTest</a>( pCivSoldier, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="GameSettings_8cpp.html#5c32f930e2fef384505c4b91803a92c2">gGameExternalOptions</a>.<a class="code" href="structGAME__EXTERNAL__OPTIONS.html#9c9d8783526192712e6fd727861699b6">ubStraightSightRange</a>, TRUE ) != 0 )
<a name="l00778"></a>00778             {
<a name="l00779"></a>00779                   bSeenState |= 2;
<a name="l00780"></a>00780             }
<a name="l00781"></a>00781       }     
<a name="l00782"></a>00782 
<a name="l00783"></a>00783       <span class="comment">// if player didn't do it</span>
<a name="l00784"></a>00784       <span class="keywordflow">if</span>( bKillerTeam != OUR_TEAM )
<a name="l00785"></a>00785       {
<a name="l00786"></a>00786             <span class="comment">// If the murder is not fully witnessed, there's a chance of player being blamed for it even if it's not his fault</span>
<a name="l00787"></a>00787             <span class="keywordflow">switch</span> (bSeenState)
<a name="l00788"></a>00788             {
<a name="l00789"></a>00789                   <span class="keywordflow">case</span> 0:
<a name="l00790"></a>00790                         <span class="comment">// nobody saw anything.  When body is found, chance player is blamed depends on the town's loyalty at this time</span>
<a name="l00791"></a>00791                         uiChanceFalseAccusal = MAX_LOYALTY_VALUE - <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#d2934532a9d306c7521908308ccb405f">ubRating</a>;
<a name="l00792"></a>00792                         <span class="keywordflow">break</span>;
<a name="l00793"></a>00793                   <span class="keywordflow">case</span> 1:
<a name="l00794"></a>00794                         <span class="comment">// civilians saw the killer, but not the victim. 10 % chance of blaming player whether or not he did it</span>
<a name="l00795"></a>00795                         uiChanceFalseAccusal = 10;
<a name="l00796"></a>00796                         <span class="keywordflow">break</span>;
<a name="l00797"></a>00797                   <span class="keywordflow">case</span> 2:
<a name="l00798"></a>00798                         <span class="comment">// civilians only saw the victim.  50/50 chance...</span>
<a name="l00799"></a>00799                         uiChanceFalseAccusal = 50;
<a name="l00800"></a>00800                         <span class="keywordflow">break</span>;
<a name="l00801"></a>00801                   <span class="keywordflow">case</span> 3:
<a name="l00802"></a>00802                         <span class="comment">// civilians have seen it all, and in this case, they're always honest</span>
<a name="l00803"></a>00803                         uiChanceFalseAccusal = 0;
<a name="l00804"></a>00804                         <span class="keywordflow">break</span>;
<a name="l00805"></a>00805                   <span class="keywordflow">default</span>:
<a name="l00806"></a>00806                         Assert(FALSE);
<a name="l00807"></a>00807                         <span class="keywordflow">return</span>;
<a name="l00808"></a>00808             }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810             <span class="comment">// check whether player is falsely accused</span>
<a name="l00811"></a>00811             <span class="keywordflow">if</span>( <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>(100) &lt; uiChanceFalseAccusal )
<a name="l00812"></a>00812             {
<a name="l00813"></a>00813                   <span class="comment">// blame player whether or not he did it - set killer team as our team</span>
<a name="l00814"></a>00814                   bKillerTeam = OUR_TEAM;
<a name="l00815"></a>00815 
<a name="l00816"></a>00816                   <span class="comment">// not really player's fault, reduce penalty, because some will believe it to be a lie</span>
<a name="l00817"></a>00817                   iLoyaltyChange *= REDUCTION_FOR_MURDER_NOT_OUR_FAULT;
<a name="l00818"></a>00818                   iLoyaltyChange /= 100;
<a name="l00819"></a>00819 
<a name="l00820"></a>00820                   <span class="comment">// debug message</span>
<a name="l00821"></a>00821                   <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_RED, MSG_DEBUG, L<span class="stringliteral">"You're being blamed for a death you didn't cause!"</span>);
<a name="l00822"></a>00822             }
<a name="l00823"></a>00823       }
<a name="l00824"></a>00824 
<a name="l00825"></a>00825             
<a name="l00826"></a>00826       <span class="comment">// check who town thinks killed the civ</span>
<a name="l00827"></a>00827       <span class="keywordflow">switch</span> (bKillerTeam)
<a name="l00828"></a>00828       {
<a name="l00829"></a>00829             <span class="keywordflow">case</span> OUR_TEAM:
<a name="l00830"></a>00830                   <span class="comment">// town thinks player committed the murder, bad bad bad</span>
<a name="l00831"></a>00831                   fIncrement = FALSE;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833                   <span class="comment">// debug message</span>
<a name="l00834"></a>00834                   <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_RED, MSG_DEBUG, L<span class="stringliteral">"Civilian killed by friendly forces."</span>);
<a name="l00835"></a>00835                   <span class="keywordflow">break</span>;
<a name="l00836"></a>00836       
<a name="l00837"></a>00837             <span class="keywordflow">case</span> ENEMY_TEAM:
<a name="l00838"></a>00838                   <span class="comment">// check whose sector this is</span>
<a name="l00839"></a>00839                   <span class="keywordflow">if</span>( <a class="code" href="strategic_8cpp.html#6f48fb0ea28e3d4889423290f1a6ede8">StrategicMap</a>[( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> -&gt; sSectorX ) + ( MAP_WORLD_X * ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> -&gt; sSectorY ) )].fEnemyControlled == TRUE )
<a name="l00840"></a>00840                   {
<a name="l00841"></a>00841                         <span class="comment">// enemy soldiers... in enemy controlled sector.  Gain loyalty</span>
<a name="l00842"></a>00842                         fIncrement = TRUE;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844                         <span class="comment">// debug message</span>
<a name="l00845"></a>00845                         <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_RED, MSG_DEBUG, L<span class="stringliteral">"Enemy soldiers murdered a civilian. Town loyalty increases"</span>);
<a name="l00846"></a>00846                   }
<a name="l00847"></a>00847                   <span class="keywordflow">else</span>
<a name="l00848"></a>00848                   {
<a name="l00849"></a>00849                         <span class="comment">// reduce, we're expected to provide some protection, but not miracles</span>
<a name="l00850"></a>00850                         iLoyaltyChange *= REDUCTION_FOR_MURDER_OF_INNOCENT_BY_ENEMY_IN_OUR_SECTOR;
<a name="l00851"></a>00851                         iLoyaltyChange /= 100;
<a name="l00852"></a>00852 
<a name="l00853"></a>00853                         <span class="comment">// lose loyalty</span>
<a name="l00854"></a>00854                         fIncrement = FALSE;
<a name="l00855"></a>00855 
<a name="l00856"></a>00856                         <span class="comment">// debug message</span>
<a name="l00857"></a>00857                         <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_RED, MSG_DEBUG, L<span class="stringliteral">"Town holds you responsible for murder by enemy."</span>);
<a name="l00858"></a>00858                   }
<a name="l00859"></a>00859                   <span class="keywordflow">break</span>;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861             <span class="keywordflow">case</span> MILITIA_TEAM:
<a name="l00862"></a>00862                   <span class="comment">// the rebels did it... check if are they on our side</span>
<a name="l00863"></a>00863                   <span class="keywordflow">if</span>( <a class="code" href="Quests_8cpp.html#6744b59d27bf2791d0c2fefe18e548d3">CheckFact</a>( <a class="code" href="Quests_8h.html#aead3e57f613f07868a1b2afb6b943f1f21e923a59cb32420e4b0a76553b911d">FACT_REBELS_HATE_PLAYER</a>, 0 ) == FALSE )
<a name="l00864"></a>00864                   {
<a name="l00865"></a>00865                         <span class="comment">// on our side, penalty</span>
<a name="l00866"></a>00866                         iLoyaltyChange *= REDUCTION_FOR_MURDER_BY_REBEL;
<a name="l00867"></a>00867                         iLoyaltyChange /= 100;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869                         <span class="comment">// lose loyalty</span>
<a name="l00870"></a>00870                         fIncrement = FALSE;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872                         <span class="comment">// debug message</span>
<a name="l00873"></a>00873                         <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_RED, MSG_DEBUG, L<span class="stringliteral">"Town holds you responsible for murder by rebels."</span>);
<a name="l00874"></a>00874                   }
<a name="l00875"></a>00875                   <span class="keywordflow">break</span>;
<a name="l00876"></a>00876 
<a name="l00877"></a>00877       <span class="keywordflow">case</span> CREATURE_TEAM:
<a name="l00878"></a>00878                   <span class="comment">// killed by a monster - make sure it was one</span>
<a name="l00879"></a>00879                   <span class="keywordflow">if</span>( ( <a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d9c0383469bf58f73ba6bea3e8ebf22b">ubAttackerID</a> ].ubBodyType &gt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a78e8f2de8ab141e991ee2b34ebb1dfda1">ADULTFEMALEMONSTER</a> ) &amp;&amp; ( <a class="code" href="Overhead_8cpp.html#f1785e87ea281d015350ec85b9bd8508">Menptr</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d9c0383469bf58f73ba6bea3e8ebf22b">ubAttackerID</a> ].ubBodyType &lt;= <a class="code" href="Animation_01Data_8h.html#d295a916825180b548473dec560093a75f327a7c32f4f979f42e8d6f6adbf587">QUEENMONSTER</a> ) )
<a name="l00880"></a>00880                   {
<a name="l00881"></a>00881                         <span class="comment">// increase for the extreme horror of being killed by a monster</span>
<a name="l00882"></a>00882                         iLoyaltyChange *= MULTIPLIER_FOR_MURDER_BY_MONSTER;
<a name="l00883"></a>00883 
<a name="l00884"></a>00884                         <span class="comment">// check whose sector this is</span>
<a name="l00885"></a>00885                         <span class="keywordflow">if</span>( <a class="code" href="strategic_8cpp.html#6f48fb0ea28e3d4889423290f1a6ede8">StrategicMap</a>[( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> -&gt; sSectorX ) + ( MAP_WORLD_X * ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> -&gt; sSectorY ) )].fEnemyControlled == TRUE )
<a name="l00886"></a>00886                         {
<a name="l00887"></a>00887                               <span class="comment">// enemy controlled sector - gain loyalty</span>
<a name="l00888"></a>00888                               fIncrement = TRUE;
<a name="l00889"></a>00889                         }
<a name="l00890"></a>00890                         <span class="keywordflow">else</span>
<a name="l00891"></a>00891                         {
<a name="l00892"></a>00892                               <span class="comment">// our sector - lose loyalty</span>
<a name="l00893"></a>00893                               fIncrement = FALSE;
<a name="l00894"></a>00894                         }
<a name="l00895"></a>00895                   }
<a name="l00896"></a>00896                   <span class="keywordflow">break</span>;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898             <span class="keywordflow">default</span>:
<a name="l00899"></a>00899                   Assert(FALSE);
<a name="l00900"></a>00900                   <span class="keywordflow">return</span>;
<a name="l00901"></a>00901       }
<a name="l00902"></a>00902 
<a name="l00903"></a>00903 
<a name="l00904"></a>00904 <span class="comment">/* Delayed loyalty effects elimininated.  Sep.12/98.  ARM</span>
<a name="l00905"></a>00905 <span class="comment">      // figure out how long before the news of the murder spreads and lowers town loyalty</span>
<a name="l00906"></a>00906 <span class="comment">      if (bSeenState == 0)</span>
<a name="l00907"></a>00907 <span class="comment">      {</span>
<a name="l00908"></a>00908 <span class="comment">            // nobody saw nothing.  Will be some time before the grisly remains are discovered...</span>
<a name="l00909"></a>00909 <span class="comment">            uiLoyaltyEffectDelay = 60 * (1 + Random(12));   // 1-12 hrs in minutes</span>
<a name="l00910"></a>00910 <span class="comment">      }</span>
<a name="l00911"></a>00911 <span class="comment">      else</span>
<a name="l00912"></a>00912 <span class="comment">      {</span>
<a name="l00913"></a>00913 <span class="comment">            // there are witnesses, news reported &amp; spread very quickly</span>
<a name="l00914"></a>00914 <span class="comment">            uiLoyaltyEffectDelay = 30;</span>
<a name="l00915"></a>00915 <span class="comment">      }</span>
<a name="l00916"></a>00916 <span class="comment"></span>
<a name="l00917"></a>00917 <span class="comment"></span>
<a name="l00918"></a>00918 <span class="comment">      // create the event value, with bTownId &amp; for iLoyaltyChange as data</span>
<a name="l00919"></a>00919 <span class="comment">      uiValue = BuildLoyaltyEventValue( bTownId , iLoyaltyChange, fIncrement );</span>
<a name="l00920"></a>00920 <span class="comment">      // post the event</span>
<a name="l00921"></a>00921 <span class="comment">      AddStrategicEvent( EVENT_TOWN_LOYALTY_UPDATE, GetWorldTotalMin() + uiLoyaltyEffectDelay, uiValue );</span>
<a name="l00922"></a>00922 <span class="comment"></span>
<a name="l00923"></a>00923 <span class="comment">      // ideally, we'd like to also call AffectAllTownsLoyaltyByDistanceFrom() here to spread the news to all other towns,</span>
<a name="l00924"></a>00924 <span class="comment">      // but we don't have that available on a delay right now, and it would be a bit of a pain, since we only have 32 bits</span>
<a name="l00925"></a>00925 <span class="comment">      // of event data to pass in, and that would have to store iLoyaltyChange, sSectorX, and sSectorY (64 bits)</span>
<a name="l00926"></a>00926 <span class="comment">*/</span>
<a name="l00927"></a>00927 
<a name="l00928"></a>00928 
<a name="l00929"></a>00929       <span class="comment">// if it's a decrement, negate the value</span>
<a name="l00930"></a>00930       <span class="keywordflow">if</span> ( !fIncrement )
<a name="l00931"></a>00931       {
<a name="l00932"></a>00932             iLoyaltyChange *= -1;
<a name="l00933"></a>00933       }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935       <span class="comment">// this is a hack: to avoid having to adjust the values, divide by 1.75 to compensate for the distance 0</span>
<a name="l00936"></a>00936       iLoyaltyChange *= 100;
<a name="l00937"></a>00937       iLoyaltyChange /= (100 + ( 25 * LOYALTY_EVENT_DISTANCE_THRESHOLD ) );
<a name="l00938"></a>00938 
<a name="l00939"></a>00939       <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#488296b6c32853d27edccf40443c2738">AffectAllTownsLoyaltyByDistanceFrom</a>( iLoyaltyChange, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6784346500db10daed06c2db02b855c0">sSectorX</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6dd68e70c3000beb79e4ac45d28a0cbf">sSectorY</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b70b761f0405cc179c1ffba84484df28">bSectorZ</a> );
<a name="l00940"></a>00940 }
<a name="l00941"></a>00941 
<a name="l00942"></a>00942 
<a name="l00943"></a>00943 
<a name="l00944"></a>00944 <span class="comment">// check town and raise loyalty value for hiring a merc from a town...not a lot of a gain, but some</span>
<a name="l00945"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#5159f18f5e878c5a0050293243b54d64">00945</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#5159f18f5e878c5a0050293243b54d64">HandleTownLoyaltyForNPCRecruitment</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00946"></a>00946 {
<a name="l00947"></a>00947       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId = 0;
<a name="l00948"></a>00948       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiLoyaltyValue = 0;
<a name="l00949"></a>00949       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iRating = 0;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951       <span class="comment">// get town id civilian</span>
<a name="l00952"></a>00952       bTownId = <a class="code" href="strategicmap_8cpp.html#99dffd29ea4571bc0c833d45636f1403">GetTownIdForSector</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6784346500db10daed06c2db02b855c0">sSectorX</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6dd68e70c3000beb79e4ac45d28a0cbf">sSectorY</a> );
<a name="l00953"></a>00953 
<a name="l00954"></a>00954   <span class="comment">// is the merc currently in their home town?</span>
<a name="l00955"></a>00955       <span class="keywordflow">if</span>( bTownId == <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].bTown )
<a name="l00956"></a>00956       {
<a name="l00957"></a>00957             <span class="comment">// yep, value of loyalty bonus depends on his importance to this to town</span>
<a name="l00958"></a>00958             uiLoyaltyValue = MULTIPLIER_LOCAL_RPC_HIRED * <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#5a5648a1bb3507cc41f6be199c51a3f8">ubProfile</a> ].<a class="code" href="structMERCPROFILESTRUCT.html#215ef360da6ead4835b6fc152f70e179">bTownAttachment</a>;
<a name="l00959"></a>00959 
<a name="l00960"></a>00960             <span class="comment">// increment town loyalty gain</span>
<a name="l00961"></a>00961             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( bTownId, uiLoyaltyValue );
<a name="l00962"></a>00962 
<a name="l00963"></a>00963             <span class="comment">// DESIGN QUESTION: How easy is it to abuse this bonus by repeatedly hiring the guy over &amp; over</span>
<a name="l00964"></a>00964             <span class="comment">// (at worst daily? even more often if terminated &amp; rehired?)  (ARM)</span>
<a name="l00965"></a>00965       }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967       <span class="keywordflow">return</span>;
<a name="l00968"></a>00968 }
<a name="l00969"></a>00969 
<a name="l00970"></a>00970 
<a name="l00971"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#780a2b85acaee35abd833d6be61fb61a">00971</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#780a2b85acaee35abd833d6be61fb61a">HandleLoyaltyAdjustmentForRobbery</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> )
<a name="l00972"></a>00972 {
<a name="l00973"></a>00973       <span class="comment">// not to be implemented at this time</span>
<a name="l00974"></a>00974       <span class="keywordflow">return</span>( FALSE );
<a name="l00975"></a>00975 
<a name="l00976"></a>00976 <span class="comment">/*</span>
<a name="l00977"></a>00977 <span class="comment">      // this function will handle robbery by the passed soldiertype of an object from a town he/she is in</span>
<a name="l00978"></a>00978 <span class="comment">      // it will check LOS code for all civilians around the stealing soldier if any of them have LOS to the soldier</span>
<a name="l00979"></a>00979 <span class="comment">      // then roll against thief's dexterity, if fail then you were caught( adjust loyalty base on theft and value of the object and if the object is owned by one of the people with LOS) and return a TRUE</span>
<a name="l00980"></a>00980 <span class="comment">      // otherwise return false.</span>
<a name="l00981"></a>00981 <span class="comment"></span>
<a name="l00982"></a>00982 <span class="comment">      INT8 bTownId = 0;</span>
<a name="l00983"></a>00983 <span class="comment"></span>
<a name="l00984"></a>00984 <span class="comment">      // get town id </span>
<a name="l00985"></a>00985 <span class="comment">      bTownId = GetTownIdForSector( pSoldier-&gt;sSectorX, pSoldier-&gt;sSectorY );</span>
<a name="l00986"></a>00986 <span class="comment"></span>
<a name="l00987"></a>00987 <span class="comment"></span>
<a name="l00988"></a>00988 <span class="comment">      // debug message</span>
<a name="l00989"></a>00989 <span class="comment">  ScreenMsg( MSG_FONT_RED, MSG_DEBUG, L"Theft not yet implemented.");</span>
<a name="l00990"></a>00990 <span class="comment"></span>
<a name="l00991"></a>00991 <span class="comment">      return ( FALSE );</span>
<a name="l00992"></a>00992 <span class="comment">*/</span>
<a name="l00993"></a>00993 }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995 
<a name="l00996"></a>00996 <span class="comment">// handle loyalty adjustment for dmg inflicted on a building</span>
<a name="l00997"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#0efad34de1f3e8c81217d3ac6347c4e5">00997</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0efad34de1f3e8c81217d3ac6347c4e5">HandleLoyaltyForDemolitionOfBuilding</a>( <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sPointsDmg )
<a name="l00998"></a>00998 {
<a name="l00999"></a>00999       <span class="comment">// find this soldier's team and decrement the loyalty rating for them and for the people who police the sector</span>
<a name="l01000"></a>01000       <span class="comment">// more penalty for the people who did it, a lesser one for those who should have stopped it</span>
<a name="l01001"></a>01001       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sLoyaltyValue = 0;
<a name="l01002"></a>01002       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sPolicingLoyalty = 0;
<a name="l01003"></a>01003       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId = 0;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005 
<a name="l01006"></a>01006       <span class="comment">// hurt loyalty for damaging the building</span>
<a name="l01007"></a>01007       sLoyaltyValue = sPointsDmg * MULTIPLIER_FOR_DAMAGING_A_BUILDING;
<a name="l01008"></a>01008 
<a name="l01009"></a>01009       <span class="comment">// penalty for not preventing the action</span>
<a name="l01010"></a>01010       sPolicingLoyalty = sPointsDmg * MULTIPLIER_FOR_NOT_PREVENTING_BUILDING_DAMAGE;
<a name="l01011"></a>01011 
<a name="l01012"></a>01012       <span class="comment">// get town id </span>
<a name="l01013"></a>01013       bTownId = <a class="code" href="strategicmap_8cpp.html#99dffd29ea4571bc0c833d45636f1403">GetTownIdForSector</a>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6784346500db10daed06c2db02b855c0">sSectorX</a>, <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6dd68e70c3000beb79e4ac45d28a0cbf">sSectorY</a> );
<a name="l01014"></a>01014  
<a name="l01015"></a>01015       <span class="comment">// penalize the side that did it</span>
<a name="l01016"></a>01016       <span class="keywordflow">if</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == OUR_TEAM )
<a name="l01017"></a>01017       {
<a name="l01018"></a>01018             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#8aaf32385bc65679319fc948f6b59d01">DecrementTownLoyalty</a>( bTownId, sLoyaltyValue );
<a name="l01019"></a>01019       }
<a name="l01020"></a>01020       <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#74a40a8aaf3efe840cdaf6be62556d82">bTeam</a> == ENEMY_TEAM )
<a name="l01021"></a>01021       {
<a name="l01022"></a>01022             <span class="comment">// enemy damaged sector, it's their fault</span>
<a name="l01023"></a>01023             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( bTownId, sLoyaltyValue );
<a name="l01024"></a>01024       }
<a name="l01025"></a>01025       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#d250d43185690987945d6884efdf79fc">ubCivilianGroup</a> == <a class="code" href="Overhead_01Types_8h.html#e6cdb622357fec6e889e47579a0785241787570cc516fbde66bef1057d466c0e">REBEL_CIV_GROUP</a> )
<a name="l01026"></a>01026       {
<a name="l01027"></a>01027             <span class="comment">// the rebels did it...are they on our side</span>
<a name="l01028"></a>01028             <span class="keywordflow">if</span>( <a class="code" href="Quests_8cpp.html#6744b59d27bf2791d0c2fefe18e548d3">CheckFact</a>( <a class="code" href="Quests_8h.html#aead3e57f613f07868a1b2afb6b943f1f21e923a59cb32420e4b0a76553b911d">FACT_REBELS_HATE_PLAYER</a>, 0 ) == FALSE )
<a name="l01029"></a>01029             {
<a name="l01030"></a>01030                   sLoyaltyValue /= DIVISOR_FOR_REBEL_BUILDING_DMG;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032                   <span class="comment">// decrement loyalty value for rebels on our side dmging town</span>
<a name="l01033"></a>01033                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#8aaf32385bc65679319fc948f6b59d01">DecrementTownLoyalty</a>( bTownId, sLoyaltyValue );
<a name="l01034"></a>01034             }
<a name="l01035"></a>01035       }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037 
<a name="l01038"></a>01038       <span class="comment">// penalize the side that should have stopped it</span>
<a name="l01039"></a>01039       <span class="keywordflow">if</span>( <a class="code" href="strategic_8cpp.html#6f48fb0ea28e3d4889423290f1a6ede8">StrategicMap</a>[ <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6784346500db10daed06c2db02b855c0">sSectorX</a> + <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#6dd68e70c3000beb79e4ac45d28a0cbf">sSectorY</a> * MAP_WORLD_X ].fEnemyControlled == TRUE )
<a name="l01040"></a>01040       {
<a name="l01041"></a>01041             <span class="comment">// enemy should have prevented it, let them suffer a little</span>
<a name="l01042"></a>01042             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( bTownId, sPolicingLoyalty );
<a name="l01043"></a>01043       }
<a name="l01044"></a>01044       <span class="keywordflow">else</span>
<a name="l01045"></a>01045       {
<a name="l01046"></a>01046             <span class="comment">// we should have prevented it, we shall suffer</span>
<a name="l01047"></a>01047             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#8aaf32385bc65679319fc948f6b59d01">DecrementTownLoyalty</a>( bTownId, sPolicingLoyalty );
<a name="l01048"></a>01048       }
<a name="l01049"></a>01049 
<a name="l01050"></a>01050       <span class="keywordflow">return</span>;
<a name="l01051"></a>01051 }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053 
<a name="l01054"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#f790cfb7c012dfd7dfd633194558b405">01054</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#f790cfb7c012dfd7dfd633194558b405">RemoveRandomItemsInSector</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorX, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorY, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorZ, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubChance )
<a name="l01055"></a>01055 {
<a name="l01056"></a>01056       <span class="comment">// remove random items in sector</span>
<a name="l01057"></a>01057       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiNumberOfItems = 0, iCounter = 0;
<a name="l01058"></a>01058       <a class="code" href="structWORLDITEM.html">WORLDITEM</a> *pItemList;
<a name="l01059"></a>01059       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiNewTotal = 0;
<a name="l01060"></a>01060       <a class="code" href="Types_8h.html#fcdf88c1d4179fcd6d8a1fa9bbcb8a80">CHAR16</a> wSectorName[ 128 ];
<a name="l01061"></a>01061 
<a name="l01062"></a>01062 
<a name="l01063"></a>01063       <span class="comment">// stealing should fail anyway 'cause there shouldn't be a temp file for unvisited sectors, but let's check anyway</span>
<a name="l01064"></a>01064       Assert( <a class="code" href="Tactical_01Save_8cpp.html#3d497a7fd2468f74aec26360cb9018ea">GetSectorFlagStatus</a>( sSectorX, sSectorY, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ) sSectorZ, SF_ALREADY_VISITED ) == TRUE );
<a name="l01065"></a>01065 
<a name="l01066"></a>01066 
<a name="l01067"></a>01067       <span class="comment">// get sector name string</span>
<a name="l01068"></a>01068       <a class="code" href="strategicmap_8cpp.html#ffa2d45aafc21a44b8dc0177a8cddf96">GetSectorIDString</a>( sSectorX, sSectorY, ( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> ) sSectorZ, wSectorName, TRUE );
<a name="l01069"></a>01069 
<a name="l01070"></a>01070       <span class="comment">// go through list of items in sector and randomly remove them</span>
<a name="l01071"></a>01071 
<a name="l01072"></a>01072       <span class="comment">// if unloaded sector</span>
<a name="l01073"></a>01073       <span class="keywordflow">if</span>( <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a> != sSectorX || <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a> != sSectorY || <a class="code" href="strategicmap_8cpp.html#da715721a8ceedd42acf6ddb33e63ce0">gbWorldSectorZ</a> != sSectorZ )
<a name="l01074"></a>01074       {
<a name="l01075"></a>01075             <span class="comment">// if the player has never been there, there's no temp file, and 0 items will get returned, preventing any stealing</span>
<a name="l01076"></a>01076             <a class="code" href="Tactical_01Save_8cpp.html#2eec19d347694e8b5f024d9c6eff2981">GetNumberOfWorldItemsFromTempItemFile</a>( sSectorX, sSectorY, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )sSectorZ, &amp;uiNumberOfItems, FALSE );
<a name="l01077"></a>01077 
<a name="l01078"></a>01078             <span class="keywordflow">if</span>( uiNumberOfItems == 0 )
<a name="l01079"></a>01079             {
<a name="l01080"></a>01080                   <span class="keywordflow">return</span>;
<a name="l01081"></a>01081             }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083             pItemList = (<a class="code" href="structWORLDITEM.html">WORLDITEM</a> *) MemAlloc( <span class="keyword">sizeof</span>( <a class="code" href="structWORLDITEM.html">WORLDITEM</a> ) * uiNumberOfItems );
<a name="l01084"></a>01084 
<a name="l01085"></a>01085             <span class="comment">// now load items</span>
<a name="l01086"></a>01086             <a class="code" href="Tactical_01Save_8cpp.html#2412d6d05d48a7a3229faf49906f6f0d">LoadWorldItemsFromTempItemFile</a>( sSectorX, sSectorY, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )sSectorZ, pItemList );
<a name="l01087"></a>01087             uiNewTotal = uiNumberOfItems;
<a name="l01088"></a>01088             
<a name="l01089"></a>01089             <span class="comment">// set up item list ptrs</span>
<a name="l01090"></a>01090             <span class="keywordflow">for</span>( iCounter = 0; iCounter &lt; uiNumberOfItems ; iCounter++ )
<a name="l01091"></a>01091             {
<a name="l01092"></a>01092                   <span class="comment">//if the item exists, and is visible and reachable, see if it should be stolen</span>
<a name="l01093"></a>01093                   <span class="keywordflow">if</span> ( pItemList[ iCounter ].fExists &amp;&amp; pItemList[ iCounter ].bVisible == TRUE &amp;&amp; pItemList[ iCounter ].usFlags &amp; WORLD_ITEM_REACHABLE )
<a name="l01094"></a>01094                   {
<a name="l01095"></a>01095                         <span class="keywordflow">if</span>( <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 100 ) &lt; ubChance )
<a name="l01096"></a>01096                         {
<a name="l01097"></a>01097                               <span class="comment">// remove</span>
<a name="l01098"></a>01098                               uiNewTotal--;
<a name="l01099"></a>01099                               pItemList[ iCounter ].<a class="code" href="structWORLDITEM.html#7c56243fa499bb3d0bd5b905f74881ed">fExists</a> = FALSE;
<a name="l01100"></a>01100 
<a name="l01101"></a>01101                               <span class="comment">// debug message</span>
<a name="l01102"></a>01102                               <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_RED, MSG_DEBUG, L<span class="stringliteral">"%s stolen in %s!"</span>, <a class="code" href="__DutchText_8cpp.html#36672cba7b777cef11f5147ee70d3876">ItemNames</a>[ pItemList[ iCounter ].o.usItem ], wSectorName );
<a name="l01103"></a>01103                         }
<a name="l01104"></a>01104                   }
<a name="l01105"></a>01105             }
<a name="l01106"></a>01106 
<a name="l01107"></a>01107             <span class="comment">// only save if something was stolen</span>
<a name="l01108"></a>01108             <span class="keywordflow">if</span> (uiNewTotal &lt; uiNumberOfItems)
<a name="l01109"></a>01109             {
<a name="l01110"></a>01110                   <a class="code" href="Tactical_01Save_8cpp.html#bbf82e5569006b24e7825f0642f822d1">AddWorldItemsToUnLoadedSector</a>( sSectorX, sSectorY, ( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> )sSectorZ, 0, uiNumberOfItems, pItemList, TRUE );
<a name="l01111"></a>01111             }
<a name="l01112"></a>01112 
<a name="l01113"></a>01113             <span class="comment">// mem free</span>
<a name="l01114"></a>01114             MemFree( pItemList );
<a name="l01115"></a>01115       }
<a name="l01116"></a>01116       <span class="keywordflow">else</span>  <span class="comment">// handle a loaded sector</span>
<a name="l01117"></a>01117       {
<a name="l01118"></a>01118             <span class="keywordflow">for</span>( iCounter = 0; iCounter &lt; <a class="code" href="Map_01Screen_01Interface_01Map_01Inventory_8cpp.html#28a0f1d5abf53af570a6a2a140617788">guiNumWorldItems</a>; iCounter++ )
<a name="l01119"></a>01119             {
<a name="l01120"></a>01120                   <span class="comment">// note, can't do reachable test here because we'd have to do a path call...</span>
<a name="l01121"></a>01121                   <span class="keywordflow">if</span> ( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iCounter ].fExists &amp;&amp; <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iCounter ].bVisible == TRUE )
<a name="l01122"></a>01122                   {
<a name="l01123"></a>01123                         <span class="keywordflow">if</span>( <a class="code" href="Random_8cpp.html#49f938d1313ab6ef09ac6223a16ac334">Random</a>( 100 ) &lt; ubChance )
<a name="l01124"></a>01124                         {
<a name="l01125"></a>01125                               <a class="code" href="Handle_01Items_8cpp.html#e60fbe0d27199e2f0c08121214fd7306">RemoveItemFromPool</a>( <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iCounter ].sGridNo , iCounter, <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iCounter ].ubLevel );
<a name="l01126"></a>01126                               <span class="comment">// debug message</span>
<a name="l01127"></a>01127                               <a class="code" href="message_8cpp.html#818e47bc59bd5a5755f06ec51cd74928">ScreenMsg</a>( MSG_FONT_RED, MSG_DEBUG, L<span class="stringliteral">"%s stolen in %s!"</span>, <a class="code" href="__DutchText_8cpp.html#36672cba7b777cef11f5147ee70d3876">ItemNames</a>[ <a class="code" href="World_01Items_8cpp.html#3d02de7bbc850b7f4c6318b8d1125dee">gWorldItems</a>[ iCounter ].o.usItem ], wSectorName );
<a name="l01128"></a>01128                         }
<a name="l01129"></a>01129                   }
<a name="l01130"></a>01130             }
<a name="l01131"></a>01131       }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133       <span class="keywordflow">return</span>;
<a name="l01134"></a>01134 }
<a name="l01135"></a>01135 
<a name="l01136"></a>01136 
<a name="l01137"></a>01137 <span class="comment">/* ARM: Civilian theft of items was removed</span>
<a name="l01138"></a>01138 <span class="comment">void HandleTheftByCiviliansInSector( INT16 sX, INT16 sY, INT32 iLoyalty )</span>
<a name="l01139"></a>01139 <span class="comment">{</span>
<a name="l01140"></a>01140 <span class="comment">      UINT8 ubChance = 0;</span>
<a name="l01141"></a>01141 <span class="comment"></span>
<a name="l01142"></a>01142 <span class="comment">      // any loyalty under the theft threshhold is chance that thefts will occur</span>
<a name="l01143"></a>01143 <span class="comment">      if( iLoyalty &lt; THRESHOLD_FOR_TOWN_THEFT )</span>
<a name="l01144"></a>01144 <span class="comment">      {</span>
<a name="l01145"></a>01145 <span class="comment">            // sectors with mercs are immune</span>
<a name="l01146"></a>01146 <span class="comment">            if( fSectorsWithSoldiers[ sX + ( MAP_WORLD_X * sY ) ][ 0 ] == FALSE )</span>
<a name="l01147"></a>01147 <span class="comment">            {</span>
<a name="l01148"></a>01148 <span class="comment">                  // sectors not yet visited by player are also immune (other sectors in town could have been visited)</span>
<a name="l01149"></a>01149 <span class="comment">                  if ( GetSectorFlagStatus( sX, sY, 0, SF_ALREADY_VISITED ) == TRUE )</span>
<a name="l01150"></a>01150 <span class="comment">                  {</span>
<a name="l01151"></a>01151 <span class="comment">                        ubChance = 5 + ( THRESHOLD_FOR_TOWN_THEFT - iLoyalty ) / 2;</span>
<a name="l01152"></a>01152 <span class="comment"></span>
<a name="l01153"></a>01153 <span class="comment">                        // remove items from sector</span>
<a name="l01154"></a>01154 <span class="comment">                        RemoveRandomItemsInSector( sX, sY, 0, ubChance);</span>
<a name="l01155"></a>01155 <span class="comment">                  }</span>
<a name="l01156"></a>01156 <span class="comment">            }</span>
<a name="l01157"></a>01157 <span class="comment">      }</span>
<a name="l01158"></a>01158 <span class="comment"></span>
<a name="l01159"></a>01159 <span class="comment">      return;</span>
<a name="l01160"></a>01160 <span class="comment">}</span>
<a name="l01161"></a>01161 <span class="comment"></span>
<a name="l01162"></a>01162 <span class="comment">void HandleTownTheft( void )</span>
<a name="l01163"></a>01163 <span class="comment">{</span>
<a name="l01164"></a>01164 <span class="comment">      INT32 iCounter = 0;</span>
<a name="l01165"></a>01165 <span class="comment">      UINT8 ubTown;</span>
<a name="l01166"></a>01166 <span class="comment"></span>
<a name="l01167"></a>01167 <span class="comment">      // init sectors with soldiers list</span>
<a name="l01168"></a>01168 <span class="comment">      InitSectorsWithSoldiersList( );</span>
<a name="l01169"></a>01169 <span class="comment"></span>
<a name="l01170"></a>01170 <span class="comment">      // build list</span>
<a name="l01171"></a>01171 <span class="comment">      BuildSectorsWithSoldiersList(  );</span>
<a name="l01172"></a>01172 <span class="comment"></span>
<a name="l01173"></a>01173 <span class="comment">      while( pTownNamesList[ iCounter ] != 0 )</span>
<a name="l01174"></a>01174 <span class="comment">      {     </span>
<a name="l01175"></a>01175 <span class="comment">            ubTown = StrategicMap[ pTownLocationsList[ iCounter ] ].bNameId;</span>
<a name="l01176"></a>01176 <span class="comment"></span>
<a name="l01177"></a>01177 <span class="comment">            // if this town tracks loyalty, and tracking has started</span>
<a name="l01178"></a>01178 <span class="comment">            if ( ( ubTown != BLANK_SECTOR ) &amp;&amp; gfTownUsesLoyalty[ ubTown ] &amp;&amp; gTownLoyalty[ ubTown ].fStarted )</span>
<a name="l01179"></a>01179 <span class="comment">            {</span>
<a name="l01180"></a>01180 <span class="comment">                  // handle theft in this town sector</span>
<a name="l01181"></a>01181 <span class="comment">                  HandleTheftByCiviliansInSector( ( INT16 )( pTownLocationsList[ iCounter ] % MAP_WORLD_X ), ( INT16 )( pTownLocationsList[ iCounter ] / MAP_WORLD_X ), gTownLoyalty[ ubTown ].ubRating );</span>
<a name="l01182"></a>01182 <span class="comment">            }</span>
<a name="l01183"></a>01183 <span class="comment"></span>
<a name="l01184"></a>01184 <span class="comment">            iCounter++;</span>
<a name="l01185"></a>01185 <span class="comment">      }</span>
<a name="l01186"></a>01186 <span class="comment"></span>
<a name="l01187"></a>01187 <span class="comment">      return;</span>
<a name="l01188"></a>01188 <span class="comment">}</span>
<a name="l01189"></a>01189 <span class="comment">*/</span>
<a name="l01190"></a>01190 
<a name="l01191"></a>01191 
<a name="l01192"></a>01192 
<a name="l01193"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#497d7926851401e8d704d008cdb36b95">01193</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#497d7926851401e8d704d008cdb36b95">BuildListOfTownSectors</a>( <span class="keywordtype">void</span> )
<a name="l01194"></a>01194 {
<a name="l01195"></a>01195       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iCounterX = 0, iCounterY = 0, iCounter = 0;
<a name="l01196"></a>01196       <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> usSector;
<a name="l01197"></a>01197 
<a name="l01198"></a>01198       <span class="comment">// initialize</span>
<a name="l01199"></a>01199       memset( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#1001d8cb48db71e9db760efbf4353e6a">pTownNamesList</a>, <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105d008cfe091b982e6d052565ed0b5acd8">BLANK_SECTOR</a>, <span class="keyword">sizeof</span>( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#1001d8cb48db71e9db760efbf4353e6a">pTownNamesList</a> ) );
<a name="l01200"></a>01200       memset( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#c994e67a1f8511a80e6418dc483b0861">pTownLocationsList</a>, 0xFF, <span class="keyword">sizeof</span>( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#c994e67a1f8511a80e6418dc483b0861">pTownLocationsList</a> ) );
<a name="l01201"></a>01201 
<a name="l01202"></a>01202       <span class="comment">// run through list</span>
<a name="l01203"></a>01203       <span class="keywordflow">for</span>( iCounterX = 0; iCounterX &lt; MAP_WORLD_X; iCounterX++ )
<a name="l01204"></a>01204       {
<a name="l01205"></a>01205             <span class="keywordflow">for</span>( iCounterY = 0; iCounterY &lt; MAP_WORLD_Y; iCounterY++ )
<a name="l01206"></a>01206             {
<a name="l01207"></a>01207                   usSector = iCounterX + iCounterY * MAP_WORLD_X;
<a name="l01208"></a>01208 
<a name="l01209"></a>01209                   <span class="keywordflow">if</span>( ( <a class="code" href="strategic_8cpp.html#6f48fb0ea28e3d4889423290f1a6ede8">StrategicMap</a>[ usSector ].bNameId &gt;= FIRST_TOWN ) &amp;&amp; ( <a class="code" href="strategic_8cpp.html#6f48fb0ea28e3d4889423290f1a6ede8">StrategicMap</a>[ usSector ].bNameId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ) )
<a name="l01210"></a>01210                   {
<a name="l01211"></a>01211                         pTownNamesList[ iCounter] = <a class="code" href="strategic_8cpp.html#6f48fb0ea28e3d4889423290f1a6ede8">StrategicMap</a>[ usSector ].bNameId;
<a name="l01212"></a>01212                         pTownLocationsList[ iCounter ] = usSector;
<a name="l01213"></a>01213                         
<a name="l01214"></a>01214                         iCounter++;
<a name="l01215"></a>01215                   }
<a name="l01216"></a>01216             }
<a name="l01217"></a>01217       }
<a name="l01218"></a>01218 }
<a name="l01219"></a>01219 
<a name="l01220"></a>01220 <span class="comment">//#ifdef JA2TESTVERSION</span>
<a name="l01221"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#d83dd414c6e72b4f8d1a560a2908e676">01221</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#d83dd414c6e72b4f8d1a560a2908e676">CalcDistancesBetweenTowns</a>( <span class="keywordtype">void</span> )
<a name="l01222"></a>01222 {
<a name="l01223"></a>01223       <span class="comment">// run though each town sector and compare it to the next in terms of distance</span>
<a name="l01224"></a>01224       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubTownA, ubTownB;
<a name="l01225"></a>01225       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiCounterA, uiCounterB;
<a name="l01226"></a>01226       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubTempGroupId = 0;
<a name="l01227"></a>01227       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iDistance = 0;
<a name="l01228"></a>01228 
<a name="l01229"></a>01229 
<a name="l01230"></a>01230       <span class="comment">// this is a little bit tricky, since towns can have multiple sectors, we have to measure all possible combinations</span>
<a name="l01231"></a>01231 
<a name="l01232"></a>01232       <span class="comment">// preset all distances between towns to high values to prepare for search for the minimum distance</span>
<a name="l01233"></a>01233       <span class="keywordflow">for</span>( ubTownA = FIRST_TOWN; ubTownA &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>; ubTownA++ )
<a name="l01234"></a>01234       {
<a name="l01235"></a>01235             <span class="keywordflow">for</span>( ubTownB = FIRST_TOWN; ubTownB &lt; NUM_TOWNS; ubTownB++ )
<a name="l01236"></a>01236             {
<a name="l01237"></a>01237                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#606e4e4ab2d0901b06efe273b841a0b8">iTownDistances</a>[ ubTownA ][ ubTownB ] = 999999;
<a name="l01238"></a>01238             }
<a name="l01239"></a>01239       }
<a name="l01240"></a>01240 
<a name="l01241"></a>01241 
<a name="l01242"></a>01242       <span class="comment">// create a temporary group (needed to plot strategic paths)</span>
<a name="l01243"></a>01243       ubTempGroupId = <a class="code" href="Strategic_01Movement_8cpp.html#6d73ec9f19726e89c4aab2bee55eae87">CreateNewPlayerGroupDepartingFromSector</a>( 1, 1 );
<a name="l01244"></a>01244 
<a name="l01245"></a>01245 
<a name="l01246"></a>01246       <span class="comment">// now, measure distance from every town sector to every other town sector!</span>
<a name="l01247"></a>01247       <span class="comment">// The minimum distances between towns get stored.</span>
<a name="l01248"></a>01248       uiCounterA = 0;
<a name="l01249"></a>01249       uiCounterB = 0;
<a name="l01250"></a>01250 
<a name="l01251"></a>01251       <span class="keywordflow">while</span>( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#1001d8cb48db71e9db760efbf4353e6a">pTownNamesList</a>[ uiCounterA ] != 0 )
<a name="l01252"></a>01252       {
<a name="l01253"></a>01253             <span class="comment">// reset second counter</span>
<a name="l01254"></a>01254             uiCounterB = uiCounterA;
<a name="l01255"></a>01255 
<a name="l01256"></a>01256             <span class="keywordflow">while</span>( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#1001d8cb48db71e9db760efbf4353e6a">pTownNamesList</a>[ uiCounterB ] != 0)
<a name="l01257"></a>01257             {
<a name="l01258"></a>01258                   ubTownA = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#1001d8cb48db71e9db760efbf4353e6a">pTownNamesList</a>[ uiCounterA ];
<a name="l01259"></a>01259                   ubTownB = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#1001d8cb48db71e9db760efbf4353e6a">pTownNamesList</a>[ uiCounterB ];
<a name="l01260"></a>01260 
<a name="l01261"></a>01261                   <span class="comment">// if they're not in the same town</span>
<a name="l01262"></a>01262                   <span class="keywordflow">if</span> (ubTownA != ubTownB)
<a name="l01263"></a>01263                   {
<a name="l01264"></a>01264                         <span class="comment">// calculate fastest distance between them (in sectors) - not necessarily shortest distance, roads are faster!</span>
<a name="l01265"></a>01265                         iDistance = <a class="code" href="Strategic_01Pathing_8cpp.html#3eeafb5f4213a72f12c4937da53cf8b8">FindStratPath</a>( ( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> )<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#c994e67a1f8511a80e6418dc483b0861">pTownLocationsList</a>[uiCounterA ], ( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> )<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#c994e67a1f8511a80e6418dc483b0861">pTownLocationsList</a>[ uiCounterB ], ubTempGroupId, FALSE );
<a name="l01266"></a>01266                   }
<a name="l01267"></a>01267                   <span class="keywordflow">else</span>
<a name="l01268"></a>01268                   {
<a name="l01269"></a>01269                         <span class="comment">// same town, distance is 0 by definition</span>
<a name="l01270"></a>01270                         iDistance = 0;
<a name="l01271"></a>01271                   }
<a name="l01272"></a>01272                         
<a name="l01273"></a>01273                   <span class="comment">// if it's the fastest route so far, store its length</span>
<a name="l01274"></a>01274                   <span class="keywordflow">if</span>( iDistance &lt; <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#606e4e4ab2d0901b06efe273b841a0b8">iTownDistances</a>[ ubTownA ][ ubTownB ] )
<a name="l01275"></a>01275                   {
<a name="l01276"></a>01276                         <span class="comment">// store it going both ways!  The inner while loop is optimized to search each pair only once.</span>
<a name="l01277"></a>01277                         <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#606e4e4ab2d0901b06efe273b841a0b8">iTownDistances</a>[ ubTownA ][ ubTownB ] = iDistance;
<a name="l01278"></a>01278                         <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#606e4e4ab2d0901b06efe273b841a0b8">iTownDistances</a>[ ubTownB ][ ubTownA ] = iDistance;
<a name="l01279"></a>01279                   }
<a name="l01280"></a>01280 
<a name="l01281"></a>01281                   uiCounterB++;
<a name="l01282"></a>01282             }
<a name="l01283"></a>01283 
<a name="l01284"></a>01284             uiCounterA++;
<a name="l01285"></a>01285       }
<a name="l01286"></a>01286 
<a name="l01287"></a>01287 
<a name="l01288"></a>01288       <a class="code" href="Strategic_01Movement_8cpp.html#d7a021102c48beeca88623d6c6176481">RemoveGroup</a>( ubTempGroupId );
<a name="l01289"></a>01289 }
<a name="l01290"></a>01290 
<a name="l01291"></a>01291 
<a name="l01292"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#f5af3f0dbbf7ed77a6128117d87d7090">01292</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#f5af3f0dbbf7ed77a6128117d87d7090">WriteOutDistancesBetweenTowns</a>( <span class="keywordtype">void</span> )
<a name="l01293"></a>01293 {
<a name="l01294"></a>01294       <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a> hFileHandle;
<a name="l01295"></a>01295 
<a name="l01296"></a>01296       hFileHandle = <a class="code" href="FileMan_8cpp.html#1e5007589e18cbc273b9677470215db4">FileOpen</a>( <span class="stringliteral">"BinaryData\\TownDistances.dat"</span>, FILE_ACCESS_WRITE|FILE_OPEN_ALWAYS, FALSE );
<a name="l01297"></a>01297 
<a name="l01298"></a>01298       <a class="code" href="FileMan_8cpp.html#09ed41c07d607c8c64a7e2b9fb25660c">FileWrite</a>( hFileHandle, &amp;( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#606e4e4ab2d0901b06efe273b841a0b8">iTownDistances</a> ),  ( <span class="keyword">sizeof</span>( <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> ) * <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> * <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ), NULL );
<a name="l01299"></a>01299 
<a name="l01300"></a>01300       <span class="comment">// close file</span>
<a name="l01301"></a>01301   <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFileHandle );
<a name="l01302"></a>01302 
<a name="l01303"></a>01303       <span class="keywordflow">return</span>;
<a name="l01304"></a>01304 }
<a name="l01305"></a>01305 
<a name="l01306"></a>01306 
<a name="l01307"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#2ae1cb9a5e03b5e6a45d0b25822197d2">01307</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#2ae1cb9a5e03b5e6a45d0b25822197d2">DumpDistancesBetweenTowns</a>(<span class="keywordtype">void</span>)
<a name="l01308"></a>01308 {
<a name="l01309"></a>01309   <a class="code" href="Types_8h.html#2f68f0189367ead40015f7c0ec68eb9e">CHAR8</a> zPrintFileName[60];
<a name="l01310"></a>01310   FILE *FDump;
<a name="l01311"></a>01311       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubTownA, ubTownB;
<a name="l01312"></a>01312       <a class="code" href="Types_8h.html#fcdf88c1d4179fcd6d8a1fa9bbcb8a80">CHAR16</a> wHeading[4];
<a name="l01313"></a>01313 
<a name="l01314"></a>01314   <span class="comment">// open output file</span>
<a name="l01315"></a>01315       <a class="code" href="Sys_01Globals_8h.html#9e96e1edff6728e41ac635536c3d8304">strcpy</a>(zPrintFileName, <span class="stringliteral">"TownDistances.txt"</span>);
<a name="l01316"></a>01316   FDump = fopen(zPrintFileName, <span class="stringliteral">"wt"</span>);
<a name="l01317"></a>01317 
<a name="l01318"></a>01318   <span class="keywordflow">if</span> (FDump == NULL)
<a name="l01319"></a>01319   {
<a name="l01320"></a>01320     <span class="keywordflow">return</span>;
<a name="l01321"></a>01321   }
<a name="l01322"></a>01322 
<a name="l01323"></a>01323       <span class="comment">// print headings</span>
<a name="l01324"></a>01324       fprintf(FDump, <span class="stringliteral">"            "</span>);
<a name="l01325"></a>01325       <span class="keywordflow">for</span>( ubTownB = FIRST_TOWN; ubTownB &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>; ubTownB++ )
<a name="l01326"></a>01326       {
<a name="l01327"></a>01327             wcsncpy(wHeading, <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#68933d9bb7d357af6609236e47fca927">pTownNames</a>[ubTownB], 3);
<a name="l01328"></a>01328             wHeading[3] = <span class="charliteral">'\0'</span>;
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     fprintf(FDump, <span class="stringliteral">" %ls"</span>, wHeading);
<a name="l01331"></a>01331       }
<a name="l01332"></a>01332       fprintf(FDump, <span class="stringliteral">"\n"</span>);
<a name="l01333"></a>01333 
<a name="l01334"></a>01334       fprintf(FDump, <span class="stringliteral">"            "</span>);
<a name="l01335"></a>01335       <span class="keywordflow">for</span>( ubTownB = FIRST_TOWN; ubTownB &lt; NUM_TOWNS; ubTownB++ )
<a name="l01336"></a>01336       {
<a name="l01337"></a>01337     fprintf(FDump, <span class="stringliteral">" ---"</span>);
<a name="l01338"></a>01338       }
<a name="l01339"></a>01339       fprintf(FDump, <span class="stringliteral">"\n"</span>);
<a name="l01340"></a>01340 
<a name="l01341"></a>01341       <span class="keywordflow">for</span>( ubTownA = FIRST_TOWN; ubTownA &lt; NUM_TOWNS; ubTownA++ )
<a name="l01342"></a>01342       {
<a name="l01343"></a>01343             fprintf(FDump, <span class="stringliteral">"%12ls"</span>, <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#68933d9bb7d357af6609236e47fca927">pTownNames</a>[ubTownA]);
<a name="l01344"></a>01344 
<a name="l01345"></a>01345             <span class="keywordflow">for</span>( ubTownB = FIRST_TOWN; ubTownB &lt; NUM_TOWNS; ubTownB++ )
<a name="l01346"></a>01346             {
<a name="l01347"></a>01347                   fprintf(FDump, <span class="stringliteral">" %3d"</span>, <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#606e4e4ab2d0901b06efe273b841a0b8">iTownDistances</a>[ ubTownA ][ ubTownB ]);
<a name="l01348"></a>01348             }
<a name="l01349"></a>01349 
<a name="l01350"></a>01350             fprintf(FDump, <span class="stringliteral">"\n"</span>);
<a name="l01351"></a>01351       }
<a name="l01352"></a>01352 
<a name="l01353"></a>01353   fclose(FDump);
<a name="l01354"></a>01354 }
<a name="l01355"></a>01355 <span class="comment">//#endif</span>
<a name="l01356"></a>01356 
<a name="l01357"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#25f2c82da686de6331c28404a44aac5c">01357</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#25f2c82da686de6331c28404a44aac5c">ReadInDistancesBetweenTowns</a>( <span class="keywordtype">void</span> )
<a name="l01358"></a>01358 {
<a name="l01359"></a>01359       <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a> hFileHandle;
<a name="l01360"></a>01360 
<a name="l01361"></a>01361       hFileHandle = <a class="code" href="FileMan_8cpp.html#1e5007589e18cbc273b9677470215db4">FileOpen</a>( <span class="stringliteral">"BinaryData\\TownDistances.dat"</span>, FILE_ACCESS_READ, FALSE );
<a name="l01362"></a>01362 
<a name="l01363"></a>01363       <a class="code" href="FileMan_8cpp.html#1b213074411fd4c1dc8fd345e787b17e">FileRead</a>( hFileHandle, &amp;( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#606e4e4ab2d0901b06efe273b841a0b8">iTownDistances</a> ),  ( <span class="keyword">sizeof</span>( <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> ) * <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> * <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a> ), NULL );
<a name="l01364"></a>01364 
<a name="l01365"></a>01365       <span class="comment">// close file</span>
<a name="l01366"></a>01366   <a class="code" href="FileMan_8cpp.html#92ccf437cf31aac8a8356e1425f203cc">FileClose</a>( hFileHandle );
<a name="l01367"></a>01367 
<a name="l01368"></a>01368       <span class="keywordflow">return</span>;
<a name="l01369"></a>01369 }
<a name="l01370"></a>01370 
<a name="l01371"></a>01371 
<a name="l01372"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#d2ccb0135ede9f1936afdc5dba7caa3b">01372</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#d2ccb0135ede9f1936afdc5dba7caa3b">GetTownDistances</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubTown, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubTownA )
<a name="l01373"></a>01373 {
<a name="l01374"></a>01374       <span class="keywordflow">return</span>( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#606e4e4ab2d0901b06efe273b841a0b8">iTownDistances</a>[ ubTown ][ ubTownA ] );
<a name="l01375"></a>01375 }
<a name="l01376"></a>01376 
<a name="l01377"></a>01377 
<a name="l01378"></a>01378 <span class="comment">/* Delayed loyalty effects elimininated.  Sep.12/98.  ARM</span>
<a name="l01379"></a>01379 <span class="comment">void HandleDelayedTownLoyaltyEvent( UINT32 uiValue )</span>
<a name="l01380"></a>01380 <span class="comment">{</span>
<a name="l01381"></a>01381 <span class="comment">      INT8 bTownId = 0;</span>
<a name="l01382"></a>01382 <span class="comment">      UINT32 uiLoyaltyChange = 0;</span>
<a name="l01383"></a>01383 <span class="comment">      BOOLEAN fIncrement = FALSE;</span>
<a name="l01384"></a>01384 <span class="comment"></span>
<a name="l01385"></a>01385 <span class="comment">      // first 8 bits are town id, 23 are amount and last is increment or decrement</span>
<a name="l01386"></a>01386 <span class="comment"></span>
<a name="l01387"></a>01387 <span class="comment">      // get increment</span>
<a name="l01388"></a>01388 <span class="comment">      fIncrement = ( BOOLEAN )( GET_TOWN_INCREMENT( iValue ) ) ;</span>
<a name="l01389"></a>01389 <span class="comment"></span>
<a name="l01390"></a>01390 <span class="comment">      // town id</span>
<a name="l01391"></a>01391 <span class="comment">      bTownId = ( INT8 )( GET_TOWN_ID_FOR_LOYALTY( iValue ) );</span>
<a name="l01392"></a>01392 <span class="comment"></span>
<a name="l01393"></a>01393 <span class="comment">      // the amount</span>
<a name="l01394"></a>01394 <span class="comment">      uiLoyaltyChange = ( INT32 )( GET_TOWN_LOYALTY_CHANGE( iValue ) );</span>
<a name="l01395"></a>01395 <span class="comment"></span>
<a name="l01396"></a>01396 <span class="comment">      if (fIncrement)</span>
<a name="l01397"></a>01397 <span class="comment">      {</span>
<a name="l01398"></a>01398 <span class="comment">            IncrementTownLoyalty( bTownId, uiLoyaltyChange );</span>
<a name="l01399"></a>01399 <span class="comment">      }</span>
<a name="l01400"></a>01400 <span class="comment">      else</span>
<a name="l01401"></a>01401 <span class="comment">      {</span>
<a name="l01402"></a>01402 <span class="comment">            DecrementTownLoyalty( bTownId, uiLoyaltyChange );</span>
<a name="l01403"></a>01403 <span class="comment">      }</span>
<a name="l01404"></a>01404 <span class="comment">}</span>
<a name="l01405"></a>01405 <span class="comment"></span>
<a name="l01406"></a>01406 <span class="comment"></span>
<a name="l01407"></a>01407 <span class="comment">UINT32 BuildLoyaltyEventValue( INT8 bTownValue, UINT32 uiValue, BOOLEAN fIncrement )</span>
<a name="l01408"></a>01408 <span class="comment">{</span>
<a name="l01409"></a>01409 <span class="comment">      UINT32 uiReturnValue  = 0;</span>
<a name="l01410"></a>01410 <span class="comment">      UINT32 uiTempValue = 0;</span>
<a name="l01411"></a>01411 <span class="comment"></span>
<a name="l01412"></a>01412 <span class="comment">      // the town name in 8 most sig bits</span>
<a name="l01413"></a>01413 <span class="comment">      uiTempValue = ( UINT32 )( bTownValue );</span>
<a name="l01414"></a>01414 <span class="comment"></span>
<a name="l01415"></a>01415 <span class="comment">      uiReturnValue += ( uiTempValue &lt;&lt; 24 );</span>
<a name="l01416"></a>01416 <span class="comment"></span>
<a name="l01417"></a>01417 <span class="comment">      // the incrment decrement amount is </span>
<a name="l01418"></a>01418 <span class="comment">      uiTempValue = ( UINT32 )( uiValue );</span>
<a name="l01419"></a>01419 <span class="comment"></span>
<a name="l01420"></a>01420 <span class="comment">      uiTempValue = ( ( uiTempValue &lt;&lt; 8 ) &gt;&gt; 7 );</span>
<a name="l01421"></a>01421 <span class="comment">      uiReturnValue += uiTempValue;</span>
<a name="l01422"></a>01422 <span class="comment"></span>
<a name="l01423"></a>01423 <span class="comment">      uiReturnValue += ( fIncrement != 0 ? 1: 0 );</span>
<a name="l01424"></a>01424 <span class="comment">      </span>
<a name="l01425"></a>01425 <span class="comment">      return( uiReturnValue );</span>
<a name="l01426"></a>01426 <span class="comment">}</span>
<a name="l01427"></a>01427 <span class="comment">*/</span>
<a name="l01428"></a>01428 
<a name="l01429"></a>01429 
<a name="l01430"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#0055f455ad510556700d4a6015562c60">01430</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0055f455ad510556700d4a6015562c60">SaveStrategicTownLoyaltyToSaveGameFile</a>( <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a> hFile )
<a name="l01431"></a>01431 {
<a name="l01432"></a>01432       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiNumBytesWritten;
<a name="l01433"></a>01433 
<a name="l01434"></a>01434       <span class="comment">//Save the Town Loyalty</span>
<a name="l01435"></a>01435       <a class="code" href="FileMan_8cpp.html#09ed41c07d607c8c64a7e2b9fb25660c">FileWrite</a>( hFile, <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>, <span class="keyword">sizeof</span>( <a class="code" href="structTOWN__LOYALTY.html">TOWN_LOYALTY</a> ) * <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>, &amp;uiNumBytesWritten );
<a name="l01436"></a>01436       <span class="keywordflow">if</span>( uiNumBytesWritten != <span class="keyword">sizeof</span>( TOWN_LOYALTY ) * NUM_TOWNS )
<a name="l01437"></a>01437       {
<a name="l01438"></a>01438             <span class="keywordflow">return</span>( FALSE );
<a name="l01439"></a>01439       }
<a name="l01440"></a>01440 
<a name="l01441"></a>01441       <span class="keywordflow">return</span>( TRUE );
<a name="l01442"></a>01442 }
<a name="l01443"></a>01443 
<a name="l01444"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#32fcf6aaf8fcd3df09bc7f98a4681320">01444</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#32fcf6aaf8fcd3df09bc7f98a4681320">LoadStrategicTownLoyaltyFromSavedGameFile</a>( <a class="code" href="LibraryDataBase_8h.html#210e2fc1c18208cbf159ef9c087d6721">HWFILE</a> hFile )
<a name="l01445"></a>01445 {
<a name="l01446"></a>01446       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      uiNumBytesRead;
<a name="l01447"></a>01447 
<a name="l01448"></a>01448       <span class="comment">//Restore the Town Loyalty</span>
<a name="l01449"></a>01449       <a class="code" href="FileMan_8cpp.html#1b213074411fd4c1dc8fd345e787b17e">FileRead</a>( hFile, <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>, <span class="keyword">sizeof</span>( <a class="code" href="structTOWN__LOYALTY.html">TOWN_LOYALTY</a> ) * <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>, &amp;uiNumBytesRead );
<a name="l01450"></a>01450       <span class="keywordflow">if</span>( uiNumBytesRead != <span class="keyword">sizeof</span>( TOWN_LOYALTY ) * NUM_TOWNS )
<a name="l01451"></a>01451       {
<a name="l01452"></a>01452             <span class="keywordflow">return</span>( FALSE );
<a name="l01453"></a>01453       }
<a name="l01454"></a>01454 
<a name="l01455"></a>01455       <span class="keywordflow">return</span>( TRUE );
<a name="l01456"></a>01456 }
<a name="l01457"></a>01457 
<a name="l01458"></a>01458 
<a name="l01459"></a>01459 
<a name="l01460"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#4796174001d18d2fabd011cc74c8aff9">01460</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#4796174001d18d2fabd011cc74c8aff9">ReduceLoyaltyForRebelsBetrayed</a>(<span class="keywordtype">void</span>)
<a name="l01461"></a>01461 {
<a name="l01462"></a>01462       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId;
<a name="l01463"></a>01463 
<a name="l01464"></a>01464       <span class="comment">// reduce loyalty to player all across Arulco</span>
<a name="l01465"></a>01465       <span class="keywordflow">for</span>( bTownId = FIRST_TOWN; bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>; bTownId++ )
<a name="l01466"></a>01466       {
<a name="l01467"></a>01467             <span class="keywordflow">if</span> (bTownId == <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105d4e8ff4822ac436590f6cfbf3b35764d">OMERTA</a>)
<a name="l01468"></a>01468             {
<a name="l01469"></a>01469                   <span class="comment">// if not already really low</span>
<a name="l01470"></a>01470                   <span class="keywordflow">if</span> (<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].ubRating &gt; HOSTILE_OMERTA_LOYALTY_RATING)
<a name="l01471"></a>01471                   {
<a name="l01472"></a>01472                         <span class="comment">// loyalty in Omerta tanks big time, and will stay low permanently since this becomes its maximum</span>
<a name="l01473"></a>01473                         <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#83839067c20a0543b5657918655d3a4a">SetTownLoyalty</a>(bTownId, HOSTILE_OMERTA_LOYALTY_RATING);
<a name="l01474"></a>01474                         <span class="comment">// note that rebel sentiment isn't affected - they remain loyal to themselves, after all!</span>
<a name="l01475"></a>01475                   }
<a name="l01476"></a>01476             }
<a name="l01477"></a>01477             <span class="keywordflow">else</span>
<a name="l01478"></a>01478             {
<a name="l01479"></a>01479                   
<a name="l01480"></a>01480                   <span class="comment">// loyalty in other places is also strongly affected by this falling out with rebels, but this is not permanent</span>
<a name="l01481"></a>01481                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#83839067c20a0543b5657918655d3a4a">SetTownLoyalty</a>(bTownId, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) (<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].ubRating / 3));
<a name="l01482"></a>01482             }
<a name="l01483"></a>01483       }
<a name="l01484"></a>01484 }
<a name="l01485"></a>01485 
<a name="l01486"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#202f99e24aa89780121994b8af337063">01486</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#202f99e24aa89780121994b8af337063">GetNumberOfWholeTownsUnderControl</a>( <span class="keywordtype">void</span> )
<a name="l01487"></a>01487 {
<a name="l01488"></a>01488       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iNumber = 0;
<a name="l01489"></a>01489       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId = 0;
<a name="l01490"></a>01490       
<a name="l01491"></a>01491       <span class="comment">// run through the list of towns..if the entire town is under player control, then increment the number of towns under player control</span>
<a name="l01492"></a>01492 
<a name="l01493"></a>01493       <span class="comment">// make sure that each town is one for which loyalty matters</span>
<a name="l01494"></a>01494       <span class="keywordflow">for</span> ( bTownId = FIRST_TOWN; bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>; bTownId++ )
<a name="l01495"></a>01495       {
<a name="l01496"></a>01496             <span class="keywordflow">if</span> ( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#356a7b92cf18c56a14e554fa44a7d693">IsTownUnderCompleteControlByPlayer</a>( bTownId ) &amp;&amp; <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#9b06c65f6833d5d0ed217d0c959d80dd">gfTownUsesLoyalty</a>[ bTownId ] )
<a name="l01497"></a>01497             {
<a name="l01498"></a>01498                   iNumber++;
<a name="l01499"></a>01499             }
<a name="l01500"></a>01500       }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502       <span class="keywordflow">return</span>( iNumber );
<a name="l01503"></a>01503 }
<a name="l01504"></a>01504 
<a name="l01505"></a>01505 
<a name="l01506"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#cd5df27f29d4e017e6b052515ccfcc8d">01506</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#cd5df27f29d4e017e6b052515ccfcc8d">GetNumberOfWholeTownsUnderControlButExcludeCity</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bCityToExclude )
<a name="l01507"></a>01507 {
<a name="l01508"></a>01508       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iNumber = 0;
<a name="l01509"></a>01509       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId = 0;
<a name="l01510"></a>01510       
<a name="l01511"></a>01511       <span class="comment">// run through the list of towns..if the entire town is under player control, then increment the number of towns under player control</span>
<a name="l01512"></a>01512       <span class="keywordflow">for</span>( bTownId = FIRST_TOWN; bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>; bTownId++ )
<a name="l01513"></a>01513       {
<a name="l01514"></a>01514             <span class="keywordflow">if</span> ( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#356a7b92cf18c56a14e554fa44a7d693">IsTownUnderCompleteControlByPlayer</a>( bTownId ) &amp;&amp; ( bCityToExclude != bTownId ) &amp;&amp; <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#9b06c65f6833d5d0ed217d0c959d80dd">gfTownUsesLoyalty</a>[ bTownId ] )
<a name="l01515"></a>01515             {
<a name="l01516"></a>01516                   iNumber++;
<a name="l01517"></a>01517             }
<a name="l01518"></a>01518       }
<a name="l01519"></a>01519 
<a name="l01520"></a>01520       <span class="keywordflow">return</span>( iNumber );
<a name="l01521"></a>01521 }
<a name="l01522"></a>01522 
<a name="l01523"></a>01523 <span class="comment">// is the ENTIRE town under player control?</span>
<a name="l01524"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#356a7b92cf18c56a14e554fa44a7d693">01524</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#356a7b92cf18c56a14e554fa44a7d693">IsTownUnderCompleteControlByPlayer</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId )
<a name="l01525"></a>01525 {
<a name="l01526"></a>01526       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iNumber = 0;
<a name="l01527"></a>01527       
<a name="l01528"></a>01528       <span class="keywordflow">if</span>( <a class="code" href="strategicmap_8cpp.html#e08294f0e64d981fd2b47ceaec37a1c7">GetTownSectorSize</a>( bTownId ) == <a class="code" href="strategicmap_8cpp.html#1fab6a2009a1cd32ebff3e51921d830e">GetTownSectorsUnderControl</a>( bTownId ) )
<a name="l01529"></a>01529       {
<a name="l01530"></a>01530             <span class="keywordflow">return</span>( TRUE );
<a name="l01531"></a>01531       }
<a name="l01532"></a>01532 
<a name="l01533"></a>01533       <span class="keywordflow">return</span>( FALSE );
<a name="l01534"></a>01534 }
<a name="l01535"></a>01535 
<a name="l01536"></a>01536 <span class="comment">// is the ENTIRE town under enemy control?</span>
<a name="l01537"></a><a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#a95fb4b36e20eb59008ee62b6e5c82bb">01537</a> <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#a95fb4b36e20eb59008ee62b6e5c82bb">IsTownUnderCompleteControlByEnemy</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId )
<a name="l01538"></a>01538 {
<a name="l01539"></a>01539       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iNumber = 0;
<a name="l01540"></a>01540       
<a name="l01541"></a>01541       <span class="keywordflow">if</span> ( <a class="code" href="strategicmap_8cpp.html#1fab6a2009a1cd32ebff3e51921d830e">GetTownSectorsUnderControl</a>( bTownId ) == 0 )
<a name="l01542"></a>01542       {
<a name="l01543"></a>01543             <span class="keywordflow">return</span>( TRUE );
<a name="l01544"></a>01544       }
<a name="l01545"></a>01545 
<a name="l01546"></a>01546       <span class="keywordflow">return</span>( FALSE );
<a name="l01547"></a>01547 }
<a name="l01548"></a>01548 
<a name="l01549"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#2c12c95399514d0b3cc7f65e46369113">01549</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#2c12c95399514d0b3cc7f65e46369113">AdjustLoyaltyForCivsEatenByMonsters</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorX, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorY, <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubHowMany)
<a name="l01550"></a>01550 {
<a name="l01551"></a>01551       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId = 0;
<a name="l01552"></a>01552       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiLoyaltyChange = 0;
<a name="l01553"></a>01553       <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> <a class="code" href="Button_01System_8cpp.html#ac22642f3052cc77a6991a262ce4ad23">str</a>[256];
<a name="l01554"></a>01554       <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> pSectorString[128];
<a name="l01555"></a>01555 
<a name="l01556"></a>01556 
<a name="l01557"></a>01557       <span class="comment">// get town id</span>
<a name="l01558"></a>01558       bTownId = <a class="code" href="strategicmap_8cpp.html#99dffd29ea4571bc0c833d45636f1403">GetTownIdForSector</a>( sSectorX, sSectorY );
<a name="l01559"></a>01559 
<a name="l01560"></a>01560       <span class="comment">// if NOT in a town</span>
<a name="l01561"></a>01561       <span class="keywordflow">if</span>( bTownId == <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105d008cfe091b982e6d052565ed0b5acd8">BLANK_SECTOR</a> )
<a name="l01562"></a>01562       {
<a name="l01563"></a>01563             <span class="keywordflow">return</span>;
<a name="l01564"></a>01564       }
<a name="l01565"></a>01565 
<a name="l01566"></a>01566       <span class="comment">//Report this to player</span>
<a name="l01567"></a>01567       <a class="code" href="strategicmap_8cpp.html#ffa2d45aafc21a44b8dc0177a8cddf96">GetSectorIDString</a>( sSectorX, sSectorY, 0, pSectorString, TRUE );
<a name="l01568"></a>01568       swprintf( str, <a class="code" href="__DutchText_8cpp.html#1192c8131d7a4e7d7e7f104cfb037dd8">gpStrategicString</a>[ <a class="code" href="Text_8h.html#324626c8a5e99e28c43d895e854b36948df0f4ae796f2623238b45387beecea1">STR_DIALOG_CREATURES_KILL_CIVILIANS</a> ], ubHowMany, pSectorString );
<a name="l01569"></a>01569       <a class="code" href="MessageBoxScreen_8cpp.html#f480404e936544ddb29a371b785dc2f3">DoScreenIndependantMessageBox</a>( str, MSG_BOX_FLAG_OK, <a class="code" href="Map_01Screen_01Interface_8cpp.html#e13afb9c6e9e7881a3f76d3c073ec5fc">MapScreenDefaultOkBoxCallback</a> );
<a name="l01570"></a>01570 
<a name="l01571"></a>01571       <span class="comment">// use same formula as if it were a civilian "murder" in tactical!!!</span>
<a name="l01572"></a>01572       uiLoyaltyChange = ubHowMany * BASIC_COST_FOR_CIV_MURDER * MULTIPLIER_FOR_MURDER_BY_MONSTER;
<a name="l01573"></a>01573       <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#8aaf32385bc65679319fc948f6b59d01">DecrementTownLoyalty</a>( bTownId, uiLoyaltyChange );
<a name="l01574"></a>01574 }
<a name="l01575"></a>01575 
<a name="l01576"></a>01576 
<a name="l01577"></a>01577 <span class="comment">// this applies the SAME change to every town equally, regardless of distance from the event</span>
<a name="l01578"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#5735111a1928f04949dcf3dd0d63bc65">01578</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#5735111a1928f04949dcf3dd0d63bc65">IncrementTownLoyaltyEverywhere</a>( <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiLoyaltyIncrease )
<a name="l01579"></a>01579 {
<a name="l01580"></a>01580       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId;
<a name="l01581"></a>01581 
<a name="l01582"></a>01582       <span class="keywordflow">for</span>( bTownId = FIRST_TOWN; bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>; bTownId++ )
<a name="l01583"></a>01583       {
<a name="l01584"></a>01584             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( bTownId, uiLoyaltyIncrease );
<a name="l01585"></a>01585       }
<a name="l01586"></a>01586 }
<a name="l01587"></a>01587 
<a name="l01588"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#db183ada56e95199c90cadcd2924a67b">01588</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#db183ada56e95199c90cadcd2924a67b">DecrementTownLoyaltyEverywhere</a>( <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiLoyaltyDecrease )
<a name="l01589"></a>01589 {
<a name="l01590"></a>01590       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId;
<a name="l01591"></a>01591 
<a name="l01592"></a>01592       <span class="keywordflow">for</span>( bTownId = FIRST_TOWN; bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>; bTownId++ )
<a name="l01593"></a>01593       {
<a name="l01594"></a>01594             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#8aaf32385bc65679319fc948f6b59d01">DecrementTownLoyalty</a>( bTownId, uiLoyaltyDecrease );
<a name="l01595"></a>01595       }
<a name="l01596"></a>01596 }
<a name="l01597"></a>01597 <span class="comment">// this applies the change to every town differently, depending on the distance from the event</span>
<a name="l01598"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#c03d88b7111537efc64a9bd5e158d281">01598</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#c03d88b7111537efc64a9bd5e158d281">HandleGlobalLoyaltyEvent</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubEventType, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorX, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorY, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bSectorZ)
<a name="l01599"></a>01599 {
<a name="l01600"></a>01600       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iLoyaltyChange;
<a name="l01601"></a>01601       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId = 0;
<a name="l01602"></a>01602 
<a name="l01603"></a>01603       <span class="keywordflow">if</span>( bSectorZ == 0 )
<a name="l01604"></a>01604       {
<a name="l01605"></a>01605             <span class="comment">// grab town id, if this event occured within one</span>
<a name="l01606"></a>01606             bTownId = <a class="code" href="strategicmap_8cpp.html#99dffd29ea4571bc0c833d45636f1403">GetTownIdForSector</a>( sSectorX, sSectorY );
<a name="l01607"></a>01607       }
<a name="l01608"></a>01608 
<a name="l01609"></a>01609       <span class="comment">// should other towns ignore events occuring in this town?</span>
<a name="l01610"></a>01610       <span class="keywordflow">if</span>( bTownId == <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe10555d5a38897a02d66fd24bf2d6d92dee8">SAN_MONA</a> )
<a name="l01611"></a>01611       {
<a name="l01612"></a>01612             <span class="keywordflow">return</span>;
<a name="l01613"></a>01613       }
<a name="l01614"></a>01614 
<a name="l01615"></a>01615       <span class="comment">// determine what the base loyalty change of this event type is worth</span>
<a name="l01616"></a>01616       <span class="comment">// these are -&gt;hundredths&lt;- of loyalty points, so choose appropriate values accordingly!</span>
<a name="l01617"></a>01617       <span class="comment">// the closer a town is to the event, the more pronounced the effect upon that town is</span>
<a name="l01618"></a>01618       <span class="keywordflow">switch</span> (ubEventType)
<a name="l01619"></a>01619       {
<a name="l01620"></a>01620             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb7c8ca22b0c745a0b7abf77a49271e8ad1">GLOBAL_LOYALTY_BATTLE_WON</a>:
<a name="l01621"></a>01621                   <a class="code" href="Creature_01Spreading_8cpp.html#b0e2645075d94de60e291c6ff55b49b8">CheckConditionsForTriggeringCreatureQuest</a>( sSectorX, sSectorY, bSectorZ );
<a name="l01622"></a>01622                   iLoyaltyChange = 500;
<a name="l01623"></a>01623                   <span class="keywordflow">break</span>;
<a name="l01624"></a>01624             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb7af71f198be80ba50dcb07634a85a0c21">GLOBAL_LOYALTY_QUEEN_BATTLE_WON</a>:
<a name="l01625"></a>01625                   <a class="code" href="Creature_01Spreading_8cpp.html#b0e2645075d94de60e291c6ff55b49b8">CheckConditionsForTriggeringCreatureQuest</a>( sSectorX, sSectorY, bSectorZ );
<a name="l01626"></a>01626                   iLoyaltyChange = 1000;
<a name="l01627"></a>01627                   <span class="keywordflow">break</span>;
<a name="l01628"></a>01628             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb744bf1e360bb28c8b82747e47b30b55d5">GLOBAL_LOYALTY_BATTLE_LOST</a>:
<a name="l01629"></a>01629                   iLoyaltyChange = -750;
<a name="l01630"></a>01630                   <span class="keywordflow">break</span>;
<a name="l01631"></a>01631             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb73918c69337fa0cddc936abf7f4104da6">GLOBAL_LOYALTY_ENEMY_KILLED</a>:
<a name="l01632"></a>01632                   iLoyaltyChange = 50;
<a name="l01633"></a>01633                   <span class="keywordflow">break</span>;
<a name="l01634"></a>01634             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb744110e878e2d52eabba9ee41d43c60d6">GLOBAL_LOYALTY_NATIVE_KILLED</a>:
<a name="l01635"></a>01635                   <span class="comment">// note that there is special code (much more severe) for murdering civilians in the currently loaded sector.</span>
<a name="l01636"></a>01636                   <span class="comment">// this event is intended more for processing militia casualties, and the like</span>
<a name="l01637"></a>01637                   iLoyaltyChange = -50;
<a name="l01638"></a>01638                   <span class="keywordflow">break</span>;
<a name="l01639"></a>01639             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb7190158b92d4a7900a80ce152f6f08821">GLOBAL_LOYALTY_ABANDON_MILITIA</a>:
<a name="l01640"></a>01640                   <span class="comment">// it doesn't matter how many of them are being abandoned</span>
<a name="l01641"></a>01641                   iLoyaltyChange = -750;
<a name="l01642"></a>01642                   <span class="keywordflow">break</span>;
<a name="l01643"></a>01643             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb71837b9d8b204f2453e7b87eea8cc1ec0">GLOBAL_LOYALTY_GAIN_TOWN_SECTOR</a>:
<a name="l01644"></a>01644                   iLoyaltyChange = 500;
<a name="l01645"></a>01645                   <span class="keywordflow">break</span>;
<a name="l01646"></a>01646             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb73a545f3348a9682a77fea1d3e8dfbb83">GLOBAL_LOYALTY_LOSE_TOWN_SECTOR</a>:
<a name="l01647"></a>01647                   iLoyaltyChange = -1000;
<a name="l01648"></a>01648                   <span class="keywordflow">break</span>;
<a name="l01649"></a>01649             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb7a46ae2819fef1535ff6ab9858ee31a8b">GLOBAL_LOYALTY_LIBERATE_WHOLE_TOWN</a>:
<a name="l01650"></a>01650                   iLoyaltyChange = 1000;
<a name="l01651"></a>01651                   <span class="keywordflow">break</span>;
<a name="l01652"></a>01652             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb78d0aabff8beea3b97e5be638cfda8e6c">GLOBAL_LOYALTY_GAIN_MINE</a>:
<a name="l01653"></a>01653                   iLoyaltyChange = 1000;
<a name="l01654"></a>01654                   <span class="keywordflow">break</span>;
<a name="l01655"></a>01655             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb73f9d5864cb992545bddb9d7f3a3be097">GLOBAL_LOYALTY_LOSE_MINE</a>:
<a name="l01656"></a>01656                   iLoyaltyChange = -1500;
<a name="l01657"></a>01657                   <span class="keywordflow">break</span>;
<a name="l01658"></a>01658             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb7edeff8998a45381090ec95c5ca4e7121">GLOBAL_LOYALTY_GAIN_SAM</a>:
<a name="l01659"></a>01659                   iLoyaltyChange = 250;
<a name="l01660"></a>01660                   <span class="keywordflow">break</span>;
<a name="l01661"></a>01661             <span class="keywordflow">case</span> <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb789508e08362b9b2a9867e9c47d4d72ac">GLOBAL_LOYALTY_LOSE_SAM</a>:
<a name="l01662"></a>01662                   iLoyaltyChange = -250;
<a name="l01663"></a>01663                   <span class="keywordflow">break</span>;
<a name="l01664"></a>01664 
<a name="l01665"></a>01665             <span class="keywordflow">default</span>:
<a name="l01666"></a>01666                   Assert(FALSE);
<a name="l01667"></a>01667                   <span class="keywordflow">return</span>;
<a name="l01668"></a>01668       }
<a name="l01669"></a>01669 
<a name="l01670"></a>01670       <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#488296b6c32853d27edccf40443c2738">AffectAllTownsLoyaltyByDistanceFrom</a>( iLoyaltyChange, sSectorX, sSectorY, bSectorZ);
<a name="l01671"></a>01671 }
<a name="l01672"></a>01672 
<a name="l01673"></a>01673 
<a name="l01674"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#488296b6c32853d27edccf40443c2738">01674</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#488296b6c32853d27edccf40443c2738">AffectAllTownsLoyaltyByDistanceFrom</a>( <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iLoyaltyChange, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorX, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorY, <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bSectorZ)
<a name="l01675"></a>01675 {
<a name="l01676"></a>01676       <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sEventSector;
<a name="l01677"></a>01677       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubTempGroupId;
<a name="l01678"></a>01678       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId;
<a name="l01679"></a>01679       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> uiIndex;
<a name="l01680"></a>01680       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iThisDistance;
<a name="l01681"></a>01681       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iShortestDistance[<a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>];
<a name="l01682"></a>01682       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iPercentAdjustment;
<a name="l01683"></a>01683       <a class="code" href="Types_8h.html#1137216524060afd426c34677fed058b">INT32</a> iDistanceAdjustedLoyalty;
<a name="l01684"></a>01684 
<a name="l01685"></a>01685 
<a name="l01686"></a>01686       <span class="comment">// preset shortest distances to high values prior to searching for a minimum</span>
<a name="l01687"></a>01687       <span class="keywordflow">for</span>( bTownId = FIRST_TOWN; bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>; bTownId++ )
<a name="l01688"></a>01688       {
<a name="l01689"></a>01689             iShortestDistance[ bTownId ] = 999999;
<a name="l01690"></a>01690       }
<a name="l01691"></a>01691 
<a name="l01692"></a>01692       sEventSector = sSectorX + ( MAP_WORLD_X * sSectorY );
<a name="l01693"></a>01693 
<a name="l01694"></a>01694       <span class="comment">// need a temporary group create to use for laying down distance paths</span>
<a name="l01695"></a>01695       ubTempGroupId = <a class="code" href="Strategic_01Movement_8cpp.html#6d73ec9f19726e89c4aab2bee55eae87">CreateNewPlayerGroupDepartingFromSector</a>( (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) sSectorX, (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) sSectorY );
<a name="l01696"></a>01696 
<a name="l01697"></a>01697       <span class="comment">// calc distance to the event sector from EACH SECTOR of each town, keeping only the shortest one for every town</span>
<a name="l01698"></a>01698       uiIndex = 0;
<a name="l01699"></a>01699       <span class="keywordflow">while</span>( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#1001d8cb48db71e9db760efbf4353e6a">pTownNamesList</a>[ uiIndex ] != 0 )
<a name="l01700"></a>01700       {
<a name="l01701"></a>01701             bTownId = (<a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>) <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#1001d8cb48db71e9db760efbf4353e6a">pTownNamesList</a>[ uiIndex ];
<a name="l01702"></a>01702 
<a name="l01703"></a>01703             <span class="comment">// skip path test if distance is already known to be zero to speed this up a bit</span>
<a name="l01704"></a>01704             <span class="keywordflow">if</span> (iShortestDistance[ bTownId ] &gt; 0 )
<a name="l01705"></a>01705             {
<a name="l01706"></a>01706                   <span class="comment">// calculate across how many sectors the fastest travel path from event to this town sector </span>
<a name="l01707"></a>01707                   iThisDistance = <a class="code" href="Strategic_01Pathing_8cpp.html#3eeafb5f4213a72f12c4937da53cf8b8">FindStratPath</a>( sEventSector, ( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> )<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#c994e67a1f8511a80e6418dc483b0861">pTownLocationsList</a>[ uiIndex ], ubTempGroupId, FALSE );
<a name="l01708"></a>01708 
<a name="l01709"></a>01709                   <span class="keywordflow">if</span> (iThisDistance &lt; iShortestDistance[ bTownId ])
<a name="l01710"></a>01710                   {
<a name="l01711"></a>01711                         iShortestDistance[ bTownId ] = iThisDistance;
<a name="l01712"></a>01712                   }
<a name="l01713"></a>01713             }
<a name="l01714"></a>01714 
<a name="l01715"></a>01715             uiIndex++;
<a name="l01716"></a>01716       }
<a name="l01717"></a>01717 
<a name="l01718"></a>01718       <span class="comment">// must always remove that temporary group!</span>
<a name="l01719"></a>01719       <a class="code" href="Strategic_01Movement_8cpp.html#d7a021102c48beeca88623d6c6176481">RemoveGroup</a>( ubTempGroupId );
<a name="l01720"></a>01720 
<a name="l01721"></a>01721 
<a name="l01722"></a>01722       <span class="keywordflow">for</span>( bTownId = FIRST_TOWN; bTownId &lt; NUM_TOWNS; bTownId++ )
<a name="l01723"></a>01723       {
<a name="l01724"></a>01724             <span class="comment">// doesn't affect towns where player hasn't established a "presence" yet</span>
<a name="l01725"></a>01725             <span class="keywordflow">if</span> (!<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].fStarted)
<a name="l01726"></a>01726             {
<a name="l01727"></a>01727                   <span class="keywordflow">continue</span>;
<a name="l01728"></a>01728             }
<a name="l01729"></a>01729       
<a name="l01730"></a>01730             <span class="comment">// if event was underground, double effective distance</span>
<a name="l01731"></a>01731             <span class="keywordflow">if</span> (bSectorZ != 0)
<a name="l01732"></a>01732             {
<a name="l01733"></a>01733                   iShortestDistance[ bTownId ] *= 2;
<a name="l01734"></a>01734             }
<a name="l01735"></a>01735 
<a name="l01736"></a>01736             <span class="comment">// This number here controls how many sectors away is the "norm" for the unadjusted loyalty change value</span>
<a name="l01737"></a>01737             <span class="keywordflow">if</span> (iShortestDistance[ bTownId ] &lt; LOYALTY_EVENT_DISTANCE_THRESHOLD)
<a name="l01738"></a>01738             {
<a name="l01739"></a>01739                   <span class="comment">// add 25% per sector below the threshold</span>
<a name="l01740"></a>01740                   iPercentAdjustment = 25 * (LOYALTY_EVENT_DISTANCE_THRESHOLD - iShortestDistance[ bTownId ]);
<a name="l01741"></a>01741             }
<a name="l01742"></a>01742             <span class="keywordflow">else</span>
<a name="l01743"></a>01743             <span class="keywordflow">if</span> (iShortestDistance[ bTownId ] &gt; LOYALTY_EVENT_DISTANCE_THRESHOLD)
<a name="l01744"></a>01744             {
<a name="l01745"></a>01745                   <span class="comment">// subtract 10% per sector above the threshold</span>
<a name="l01746"></a>01746                   iPercentAdjustment = -10 * (iShortestDistance[ bTownId ] - LOYALTY_EVENT_DISTANCE_THRESHOLD);
<a name="l01747"></a>01747 
<a name="l01748"></a>01748                   <span class="comment">// don't allow it to go below -100, that would change the sign of the loyalty effect!</span>
<a name="l01749"></a>01749                   <span class="keywordflow">if</span> (iPercentAdjustment &lt; -100)
<a name="l01750"></a>01750                   {
<a name="l01751"></a>01751                         iPercentAdjustment = -100;
<a name="l01752"></a>01752                   }
<a name="l01753"></a>01753             }
<a name="l01754"></a>01754             <span class="keywordflow">else</span>
<a name="l01755"></a>01755             {
<a name="l01756"></a>01756                   <span class="comment">// no distance adjustment necessary</span>
<a name="l01757"></a>01757                   iPercentAdjustment = 0;
<a name="l01758"></a>01758             }
<a name="l01759"></a>01759 
<a name="l01760"></a>01760 
<a name="l01761"></a>01761             <span class="comment">// calculate loyalty affects as adjusted for distance to this town</span>
<a name="l01762"></a>01762             iDistanceAdjustedLoyalty = (iLoyaltyChange * (100 + iPercentAdjustment)) / 100;
<a name="l01763"></a>01763 
<a name="l01764"></a>01764             <span class="keywordflow">if</span> (iDistanceAdjustedLoyalty == 0)
<a name="l01765"></a>01765             {
<a name="l01766"></a>01766                   <span class="comment">// no measurable effect, skip this town</span>
<a name="l01767"></a>01767                   <span class="keywordflow">continue</span>;
<a name="l01768"></a>01768             }
<a name="l01769"></a>01769 
<a name="l01770"></a>01770             <span class="keywordflow">if</span> ( iDistanceAdjustedLoyalty &gt; 0)
<a name="l01771"></a>01771             {
<a name="l01772"></a>01772                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( bTownId, iDistanceAdjustedLoyalty );
<a name="l01773"></a>01773             }
<a name="l01774"></a>01774             <span class="keywordflow">else</span>
<a name="l01775"></a>01775             {
<a name="l01776"></a>01776                   <span class="comment">// the decrement amount MUST be positive</span>
<a name="l01777"></a>01777                   iDistanceAdjustedLoyalty *= -1;
<a name="l01778"></a>01778                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#8aaf32385bc65679319fc948f6b59d01">DecrementTownLoyalty</a>( bTownId, iDistanceAdjustedLoyalty );
<a name="l01779"></a>01779             }
<a name="l01780"></a>01780       }
<a name="l01781"></a>01781 
<a name="l01782"></a>01782 }
<a name="l01783"></a>01783 
<a name="l01784"></a>01784 
<a name="l01785"></a>01785 
<a name="l01786"></a>01786 <span class="comment">// to be called whenever player gains control of a sector in any way</span>
<a name="l01787"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#eacb23c1740971e1c6ad5b6ac8132f60">01787</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#eacb23c1740971e1c6ad5b6ac8132f60">CheckIfEntireTownHasBeenLiberated</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorX, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorY )
<a name="l01788"></a>01788 {
<a name="l01789"></a>01789       <span class="comment">// the whole town is under our control, check if we never libed this town before</span>
<a name="l01790"></a>01790       <span class="keywordflow">if</span> ( !<a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].fLiberatedAlready &amp;&amp; <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#356a7b92cf18c56a14e554fa44a7d693">IsTownUnderCompleteControlByPlayer</a> ( bTownId ) )
<a name="l01791"></a>01791       {
<a name="l01792"></a>01792             <span class="keywordflow">if</span> ( <a class="code" href="Town_01Militia_8cpp.html#e674aa192c58edfe28bc9ae3eb37dedf">MilitiaTrainingAllowedInSector</a>( sSectorX, sSectorY, 0 ) )
<a name="l01793"></a>01793             {
<a name="l01794"></a>01794                   <span class="comment">// give a loyalty bonus</span>
<a name="l01795"></a>01795                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#c03d88b7111537efc64a9bd5e158d281">HandleGlobalLoyaltyEvent</a>( <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb7a46ae2819fef1535ff6ab9858ee31a8b">GLOBAL_LOYALTY_LIBERATE_WHOLE_TOWN</a>, sSectorX, sSectorY, 0 );
<a name="l01796"></a>01796 
<a name="l01797"></a>01797                   <span class="comment">// set fact is has been lib'ed and set history event</span>
<a name="l01798"></a>01798                   <a class="code" href="history_8cpp.html#1c2cf05b6c7bafb693481f84d1fd80ae">AddHistoryToPlayersLog</a>( <a class="code" href="history_8h.html#70ad55be767ca0a42c9150d24618e4caecf40d7c8203b03300f9f48ad29b7bea">HISTORY_LIBERATED_TOWN</a>, bTownId, <a class="code" href="Game_01Clock_8cpp.html#4d255e800fba4d64144a7639d5f3421d">GetWorldTotalMin</a>(), sSectorX, sSectorY );
<a name="l01799"></a>01799 
<a name="l01800"></a>01800                   <a class="code" href="Meanwhile_8cpp.html#c18f665beffee0dc16b42dc13050e5b9">HandleMeanWhileEventPostingForTownLiberation</a>( bTownId );
<a name="l01801"></a>01801             }
<a name="l01802"></a>01802 
<a name="l01803"></a>01803             <span class="comment">// even taking over non-trainable "towns" like Orta/Tixa for the first time should count as "player activity"</span>
<a name="l01804"></a>01804             <span class="keywordflow">if</span> ( <a class="code" href="GameSettings_8cpp.html#f9f2d5fd368ccadcc26bebc202d52ae7">gGameOptions</a>.<a class="code" href="structGAME__OPTIONS.html#4fb44167906152722f6af5cc9f7c1a99">ubDifficultyLevel</a> &gt;= <a class="code" href="GameSettings_8h.html#c205be2172292384dd687b5471a87edd3d0b73026f1c7122798d578613aa4575">DIF_LEVEL_HARD</a> )
<a name="l01805"></a>01805             {
<a name="l01806"></a>01806                   <a class="code" href="Strategic_01Status_8cpp.html#25f19a321e5d48c2f1652dab96433ca2">UpdateLastDayOfPlayerActivity</a>( ( <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> ) ( <a class="code" href="Game_01Clock_8cpp.html#41db6fb136e18cfede5f7c1eea89d7fb">GetWorldDay</a>() + 4 ) );
<a name="l01807"></a>01807             }
<a name="l01808"></a>01808             <span class="keywordflow">else</span>
<a name="l01809"></a>01809             {
<a name="l01810"></a>01810                   <a class="code" href="Strategic_01Status_8cpp.html#25f19a321e5d48c2f1652dab96433ca2">UpdateLastDayOfPlayerActivity</a>( ( <a class="code" href="Types_8h.html#09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> ) ( <a class="code" href="Game_01Clock_8cpp.html#41db6fb136e18cfede5f7c1eea89d7fb">GetWorldDay</a>() + 2 ) );
<a name="l01811"></a>01811             }
<a name="l01812"></a>01812 
<a name="l01813"></a>01813             <span class="comment">// set flag even for towns where you can't train militia, useful for knowing Orta/Tixa were previously controlled</span>
<a name="l01814"></a>01814             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].<a class="code" href="structTOWN__LOYALTY.html#0fa23b7e6626c155c43e4b7590e09c6f">fLiberatedAlready</a> = TRUE;
<a name="l01815"></a>01815       }
<a name="l01816"></a>01816 }
<a name="l01817"></a>01817 
<a name="l01818"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#e9feb0978bf130730cb1bcd64707f8a2">01818</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#e9feb0978bf130730cb1bcd64707f8a2">CheckIfEntireTownHasBeenLost</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorX, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorY )
<a name="l01819"></a>01819 {
<a name="l01820"></a>01820       <span class="comment">// NOTE:  only towns which allow you to train militia are important enough to get</span>
<a name="l01821"></a>01821       <span class="comment">// reported here (and they're the only ones you can protect)</span>
<a name="l01822"></a>01822       <span class="keywordflow">if</span> ( <a class="code" href="Town_01Militia_8cpp.html#e674aa192c58edfe28bc9ae3eb37dedf">MilitiaTrainingAllowedInSector</a>( sSectorX, sSectorY, 0 ) &amp;&amp; <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#a95fb4b36e20eb59008ee62b6e5c82bb">IsTownUnderCompleteControlByEnemy</a>(bTownId) )
<a name="l01823"></a>01823       {
<a name="l01824"></a>01824             <span class="comment">// the whole town is under enemy control, check if we libed this town before</span>
<a name="l01825"></a>01825             <span class="keywordflow">if</span> ( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#53aef3e8e8681f01397608fbb9dcf56e">gTownLoyalty</a>[ bTownId ].fLiberatedAlready )
<a name="l01826"></a>01826             {
<a name="l01827"></a>01827                   <a class="code" href="Meanwhile_8cpp.html#6a483002df0798137c5792ac5d692db6">HandleMeanWhileEventPostingForTownLoss</a>( bTownId );
<a name="l01828"></a>01828             }
<a name="l01829"></a>01829       }
<a name="l01830"></a>01830 }
<a name="l01831"></a>01831 
<a name="l01832"></a>01832 
<a name="l01833"></a>01833 
<a name="l01834"></a>01834 
<a name="l01835"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#0acec65d0a6a0c48b34e013ca962dc0c">01835</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0acec65d0a6a0c48b34e013ca962dc0c">HandleLoyaltyChangeForNPCAction</a>( <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a> ubNPCProfileId )
<a name="l01836"></a>01836 {
<a name="l01837"></a>01837       <span class="keywordflow">switch</span> ( ubNPCProfileId )
<a name="l01838"></a>01838       {
<a name="l01839"></a>01839             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa19c84640c6fe72ee89933fce8b935331b">MIGUEL</a>:
<a name="l01840"></a>01840                   <span class="comment">// Omerta loyalty increases when Miguel receives letter from Enrico</span>
<a name="l01841"></a>01841                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105d4e8ff4822ac436590f6cfbf3b35764d">OMERTA</a>, LOYALTY_BONUS_MIGUEL_READS_LETTER );
<a name="l01842"></a>01842                   <span class="keywordflow">break</span>;
<a name="l01843"></a>01843 
<a name="l01844"></a>01844             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa11e00a2131ffcce8d7d675d79122b9764">DOREEN</a>:
<a name="l01845"></a>01845                   <span class="comment">// having freed the child labourers... she is releasing them herself!</span>
<a name="l01846"></a>01846                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1052d90315dc5189006a917572886dd5919">DRASSEN</a>, LOYALTY_BONUS_CHILDREN_FREED_DOREEN_SPARED );
<a name="l01847"></a>01847                   <span class="keywordflow">break</span>;
<a name="l01848"></a>01848 
<a name="l01849"></a>01849             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa149c3cd229422864cca57b34d666acc11">MARTHA</a>:
<a name="l01850"></a>01850                   <span class="comment">// if Joey is still alive</span>
<a name="l01851"></a>01851                   <span class="keywordflow">if</span> ( <a class="code" href="Soldier_01Profile_8cpp.html#1bcff2c50b375b1eb32800aa12000289">gMercProfiles</a>[ <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa150d65436faea8fa17961a3d6d8723fbb">JOEY</a> ].bMercStatus != MERC_IS_DEAD )
<a name="l01852"></a>01852                   {
<a name="l01853"></a>01853                         <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105457ae8d0acf7ebe5ad016ecdf6020b3e">CAMBRIA</a>, LOYALTY_BONUS_MARTHA_WHEN_JOEY_RESCUED );
<a name="l01854"></a>01854                   }
<a name="l01855"></a>01855                   <span class="keywordflow">break</span>;
<a name="l01856"></a>01856 
<a name="l01857"></a>01857             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa16e3d4638889291fbd253574d01f6baa2">KEITH</a>:
<a name="l01858"></a>01858                   <span class="comment">// Hillbilly problem solved</span>
<a name="l01859"></a>01859                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105457ae8d0acf7ebe5ad016ecdf6020b3e">CAMBRIA</a>, LOYALTY_BONUS_KEITH_WHEN_HILLBILLY_SOLVED );
<a name="l01860"></a>01860                   <span class="keywordflow">break</span>;
<a name="l01861"></a>01861 
<a name="l01862"></a>01862             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa197e08449e2efb567918d82d3c6f9e750">YANNI</a>:
<a name="l01863"></a>01863                   <span class="comment">// Chalice of Chance returned to Chitzena</span>
<a name="l01864"></a>01864                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe10577a4855ca65fb8eae6e8e89bef607477">CHITZENA</a>, LOYALTY_BONUS_YANNI_WHEN_CHALICE_RETURNED_LOCAL );
<a name="l01865"></a>01865                   <span class="comment">// NOTE: This affects Chitzena,too, a second time, so first value is discounted for it    </span>
<a name="l01866"></a>01866                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#5735111a1928f04949dcf3dd0d63bc65">IncrementTownLoyaltyEverywhere</a>( LOYALTY_BONUS_YANNI_WHEN_CHALICE_RETURNED_GLOBAL );
<a name="l01867"></a>01867                   <span class="keywordflow">break</span>;
<a name="l01868"></a>01868 
<a name="l01869"></a>01869             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa10cdf63b060a528cf7018a995d49bbf59">AUNTIE</a>:
<a name="l01870"></a>01870                   <span class="comment">// Bloodcats killed</span>
<a name="l01871"></a>01871                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105b27f427a025e60b9feb35edaa5556f63">ALMA</a>, LOYALTY_BONUS_AUNTIE_WHEN_BLOODCATS_KILLED );
<a name="l01872"></a>01872                   <span class="keywordflow">break</span>;
<a name="l01873"></a>01873 
<a name="l01874"></a>01874             <span class="keywordflow">case</span> <a class="code" href="Soldier_01Profile_8h.html#acaa92dcb344e96138c964deae3e2fa1c153f4c0b621424827368354e6612215">MATT</a>:
<a name="l01875"></a>01875                   <span class="comment">// Brother Dynamo freed</span>
<a name="l01876"></a>01876                   <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#0213c5a18d28686e5740e748d8e19754">IncrementTownLoyalty</a>( <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe105b27f427a025e60b9feb35edaa5556f63">ALMA</a>, LOYALTY_BONUS_MATT_WHEN_DYNAMO_FREED );
<a name="l01877"></a>01877                   <span class="keywordflow">break</span>;
<a name="l01878"></a>01878 
<a name="l01879"></a>01879       }
<a name="l01880"></a>01880 }
<a name="l01881"></a>01881 
<a name="l01882"></a>01882 
<a name="l01883"></a>01883 
<a name="l01884"></a>01884 <span class="comment">// set the location of the first encounter with enemy</span>
<a name="l01885"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#13c1932344eea9d378fc4b64fa1bed71">01885</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#13c1932344eea9d378fc4b64fa1bed71">SetTheFirstBattleSector</a>( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorValue )
<a name="l01886"></a>01886 {
<a name="l01887"></a>01887       <span class="keywordflow">if</span>( <a class="code" href="SaveLoadGame_8cpp.html#b14c016f3d2b7115306c10ecd23f9d68">sWorldSectorLocationOfFirstBattle</a> == 0 )
<a name="l01888"></a>01888       {
<a name="l01889"></a>01889             <a class="code" href="SaveLoadGame_8cpp.html#b14c016f3d2b7115306c10ecd23f9d68">sWorldSectorLocationOfFirstBattle</a> = sSectorValue;
<a name="l01890"></a>01890       }
<a name="l01891"></a>01891 
<a name="l01892"></a>01892       <span class="keywordflow">return</span>;
<a name="l01893"></a>01893 }
<a name="l01894"></a>01894 
<a name="l01895"></a>01895 <span class="comment">// did first battle take place here</span>
<a name="l01896"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#ade988a8364b20325c5fc0419e3ddcd0">01896</a> <a class="code" href="Types_8h.html#112e3146cb38b6ee95e64d85842e380a">BOOLEAN</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#ade988a8364b20325c5fc0419e3ddcd0">DidFirstBattleTakePlaceInThisTown</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId )
<a name="l01897"></a>01897 {
<a name="l01898"></a>01898       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownBattleId = 0;
<a name="l01899"></a>01899 
<a name="l01900"></a>01900       <span class="comment">// get town id for sector</span>
<a name="l01901"></a>01901       bTownBattleId = <a class="code" href="strategicmap_8cpp.html#99dffd29ea4571bc0c833d45636f1403">GetTownIdForSector</a>( ( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> ) ( <a class="code" href="SaveLoadGame_8cpp.html#b14c016f3d2b7115306c10ecd23f9d68">sWorldSectorLocationOfFirstBattle</a> % MAP_WORLD_X ), ( <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> ) ( <a class="code" href="SaveLoadGame_8cpp.html#b14c016f3d2b7115306c10ecd23f9d68">sWorldSectorLocationOfFirstBattle</a> / MAP_WORLD_X ) );
<a name="l01902"></a>01902       
<a name="l01903"></a>01903       <span class="keywordflow">return</span>( bTownId == bTownBattleId );
<a name="l01904"></a>01904 }
<a name="l01905"></a>01905 
<a name="l01906"></a><a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#e83ea7534ad2e545a0c0a505a88ab455">01906</a> <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#e83ea7534ad2e545a0c0a505a88ab455">PlayerStrength</a>( <span class="keywordtype">void</span> )
<a name="l01907"></a>01907 {
<a name="l01908"></a>01908       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                               ubLoop;
<a name="l01909"></a>01909       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l01910"></a>01910       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>                              uiStrength, uiTotal = 0;
<a name="l01911"></a>01911 
<a name="l01912"></a>01912       <span class="keywordflow">for</span> ( ubLoop = <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> ].bFirstID; ubLoop &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ <a class="code" href="Campaign_8cpp.html#47b2067ff75193e24776eda5297400ff">gbPlayerNum</a> ].bLastID; ubLoop++ )
<a name="l01913"></a>01913       {
<a name="l01914"></a>01914             <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubLoop ];
<a name="l01915"></a>01915             <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#653dad4e2520784e293eca9f948b8532">bActive</a> )
<a name="l01916"></a>01916             {
<a name="l01917"></a>01917                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b0096f321a0de4f0617283f7b3212aa0">bInSector</a> || ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#f66e3396115e7d6b63d661a57d3e6895">fBetweenSectors</a> &amp;&amp; ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2f3eaad74e1f28c654fa76976dea5c0a">ubPrevSectorID</a> % 16) + 1) == <a class="code" href="strategicmap_8cpp.html#49d9aed144a633fda4ba1990f002d703">gWorldSectorX</a> &amp;&amp; ((<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#2f3eaad74e1f28c654fa76976dea5c0a">ubPrevSectorID</a> / 16) + 1) == <a class="code" href="strategicmap_8cpp.html#ea322310ced0e35ee18a2ee7b32aac5b">gWorldSectorY</a> &amp;&amp; ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b70b761f0405cc179c1ffba84484df28">bSectorZ</a> == <a class="code" href="strategicmap_8cpp.html#da715721a8ceedd42acf6ddb33e63ce0">gbWorldSectorZ</a> ) ) )
<a name="l01918"></a>01918                   {
<a name="l01919"></a>01919                         <span class="comment">// count this person's strength (condition), calculated as life reduced up to half according to maxbreath</span>
<a name="l01920"></a>01920                         uiStrength = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a> * ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1bcf825e550d7b1f2db4cbfe7a6782d3">bBreathMax</a> + 100 ) / 200;
<a name="l01921"></a>01921                         uiTotal += uiStrength;
<a name="l01922"></a>01922                   }
<a name="l01923"></a>01923             }
<a name="l01924"></a>01924       }
<a name="l01925"></a>01925       <span class="keywordflow">return</span>( uiTotal );
<a name="l01926"></a>01926 }
<a name="l01927"></a>01927 
<a name="l01928"></a><a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#908c7c746b7e28758cd2d7d9ce936c0b">01928</a> <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#908c7c746b7e28758cd2d7d9ce936c0b">EnemyStrength</a>( <span class="keywordtype">void</span> )
<a name="l01929"></a>01929 {
<a name="l01930"></a>01930       <a class="code" href="Types_8h.html#b27e9918b538ce9d8ca692479b375b6a">UINT8</a>                               ubLoop;
<a name="l01931"></a>01931       <a class="code" href="structSOLDIERTYPE.html">SOLDIERTYPE</a> *           <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>;
<a name="l01932"></a>01932       <a class="code" href="Types_8h.html#e1e6edbbc26d6fbc71a90190d0266018">UINT32</a>                              uiStrength, uiTotal = 0;
<a name="l01933"></a>01933 
<a name="l01934"></a>01934             <span class="keywordflow">for</span> ( ubLoop = <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ ENEMY_TEAM ].<a class="code" href="structTacticalTeamType.html#f8fe819ad07b242f5dbf97fd4c69b00d">bFirstID</a>; ubLoop &lt;= <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#2ecddfe580bb019bc92cc4859eaf3edc">Team</a>[ CIV_TEAM ].<a class="code" href="structTacticalTeamType.html#6a887279dad735dc302f21c1e559d5ce">bLastID</a>; ubLoop++ )
<a name="l01935"></a>01935             {
<a name="l01936"></a>01936                   <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a> = <a class="code" href="Overhead_8cpp.html#2b9a828d7d92ec404b2f9a39fc001177">MercPtrs</a>[ ubLoop ];
<a name="l01937"></a>01937                   <span class="keywordflow">if</span> ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#653dad4e2520784e293eca9f948b8532">bActive</a> &amp;&amp; <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#b0096f321a0de4f0617283f7b3212aa0">bInSector</a> &amp;&amp; !<a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#165874ef5822faaf165da91996ad4a7b">bNeutral</a> )
<a name="l01938"></a>01938                   {
<a name="l01939"></a>01939                         <span class="comment">// count this person's strength (condition), calculated as life reduced up to half according to maxbreath</span>
<a name="l01940"></a>01940                         uiStrength = <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#e308dea18533bf5ab2bcee5bbe27391c">bLife</a> * ( <a class="code" href="aniviewscreen_8cpp.html#629cf92081f22af2ea4014413ff37801">pSoldier</a>-&gt;<a class="code" href="structSOLDIERTYPE.html#1bcf825e550d7b1f2db4cbfe7a6782d3">bBreathMax</a> + 100 ) / 200;
<a name="l01941"></a>01941                         uiTotal += uiStrength;
<a name="l01942"></a>01942                   }
<a name="l01943"></a>01943             }
<a name="l01944"></a>01944 
<a name="l01945"></a>01945       <span class="keywordflow">return</span>( uiTotal );
<a name="l01946"></a>01946 }
<a name="l01947"></a>01947 
<a name="l01948"></a>01948 <span class="comment">//Function assumes that mercs have retreated already.  Handles two cases, one for general merc retreat </span>
<a name="l01949"></a>01949 <span class="comment">//which slightly demoralizes the mercs, the other handles abandonment of militia forces which poses</span>
<a name="l01950"></a>01950 <span class="comment">//as a serious loyalty penalty.</span>
<a name="l01951"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#8c05446357334abd62b7ee20eb9875fa">01951</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#8c05446357334abd62b7ee20eb9875fa">HandleLoyaltyImplicationsOfMercRetreat</a>( <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bRetreatCode, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorX, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorY, <a class="code" href="Types_8h.html#30f500129d8c688af07726d5d34ce52d">INT16</a> sSectorZ )
<a name="l01952"></a>01952 {
<a name="l01953"></a>01953       <span class="keywordflow">if</span>( <a class="code" href="Town_01Militia_8cpp.html#d5f4d1a7e2d1489b786239270acbdda1">CountAllMilitiaInSector</a>( sSectorX, sSectorY ) )
<a name="l01954"></a>01954       { <span class="comment">//Big morale penalty!</span>
<a name="l01955"></a>01955             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#c03d88b7111537efc64a9bd5e158d281">HandleGlobalLoyaltyEvent</a>( <a class="code" href="Strategic_01Town_01Loyalty_8h.html#c87e57c62b9acde099ca97c24a49ddb7190158b92d4a7900a80ce152f6f08821">GLOBAL_LOYALTY_ABANDON_MILITIA</a>, sSectorX, sSectorY, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>)sSectorZ );
<a name="l01956"></a>01956       }
<a name="l01957"></a>01957 
<a name="l01958"></a>01958       <span class="comment">//Standard retreat penalty</span>
<a name="l01959"></a>01959       <span class="keywordflow">if</span> ( bRetreatCode == RETREAT_TACTICAL_TRAVERSAL )
<a name="l01960"></a>01960       {
<a name="l01961"></a>01961             <span class="comment">// if not worse than 2:1 odds, then penalize morale</span>
<a name="l01962"></a>01962             <span class="keywordflow">if</span> ( <a class="code" href="Overhead_8cpp.html#46bd754f8875c305ab18731ed10e3364">gTacticalStatus</a>.<a class="code" href="structTacticalStatusType.html#a921ee4fc79277889d9c1cec0985d3a3">fEnemyInSector</a> &amp;&amp; ( <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#e83ea7534ad2e545a0c0a505a88ab455">PlayerStrength</a>() * 2 &gt;= <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#908c7c746b7e28758cd2d7d9ce936c0b">EnemyStrength</a>() ) )
<a name="l01963"></a>01963             {
<a name="l01964"></a>01964                   <a class="code" href="Morale_8cpp.html#83b28a6d9386bb3d8d581943fa7e9a28">HandleMoraleEvent</a>( NULL, <a class="code" href="Morale_8h.html#67ab756e41250f85e7e729e45554f3c3f1113465ac460152f01dd42597294559">MORALE_RAN_AWAY</a>, sSectorX, sSectorY, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>)sSectorZ );
<a name="l01965"></a>01965             }
<a name="l01966"></a>01966       }
<a name="l01967"></a>01967       <span class="keywordflow">else</span> 
<a name="l01968"></a>01968       {
<a name="l01969"></a>01969             <a class="code" href="Morale_8cpp.html#83b28a6d9386bb3d8d581943fa7e9a28">HandleMoraleEvent</a>( NULL, <a class="code" href="Morale_8h.html#67ab756e41250f85e7e729e45554f3c3f1113465ac460152f01dd42597294559">MORALE_RAN_AWAY</a>, sSectorX, sSectorY, (<a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a>)sSectorZ );
<a name="l01970"></a>01970       }
<a name="l01971"></a>01971 }
<a name="l01972"></a>01972 
<a name="l01973"></a>01973 
<a name="l01974"></a><a class="code" href="Strategic_01Town_01Loyalty_8h.html#aa78ab6d50d09089770d78b0217f51f5">01974</a> <span class="keywordtype">void</span> <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#aa78ab6d50d09089770d78b0217f51f5">MaximizeLoyaltyForDeidrannaKilled</a>(<span class="keywordtype">void</span>)
<a name="l01975"></a>01975 {
<a name="l01976"></a>01976       <a class="code" href="Types_8h.html#7ebe70ceca856797319175e30bcf003d">INT8</a> bTownId;
<a name="l01977"></a>01977 
<a name="l01978"></a>01978       <span class="comment">// max out loyalty to player all across Arulco</span>
<a name="l01979"></a>01979       <span class="keywordflow">for</span>( bTownId = FIRST_TOWN; bTownId &lt; <a class="code" href="mapscreen_8h.html#4d1dc70bee62b945929c96dfafebe1051ba4a34e4cff74188ff8c80499572a88">NUM_TOWNS</a>; bTownId++ )
<a name="l01980"></a>01980       {
<a name="l01981"></a>01981             <span class="comment">// it's possible one of the towns still has creature problems, but it's too much of a pain to worry about it now</span>
<a name="l01982"></a>01982             <a class="code" href="Strategic_01Town_01Loyalty_8cpp.html#83839067c20a0543b5657918655d3a4a">SetTownLoyalty</a>(bTownId, 100);
<a name="l01983"></a>01983       }
<a name="l01984"></a>01984 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Sep 9 13:49:06 2006 for Build by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
